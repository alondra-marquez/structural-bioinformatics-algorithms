((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NGL={})})(this,function(Je){let S="158",Y=0,K=1,Z=2,P=1,C=2,I=3,Ve=0,Ge=1,He=2,ee=0,fe=1,te=2,re=3,ie=4,ne=5,ae=100,se=101,oe=102,le=103,he=104,de=200,me=201,ge=202,ve=203,_e=204,ye=205,be=206,xe=207,Se=208,we=209,Ae=210,Me=211,Ce=212,Te=213,Ee=214,Pe=0,Ie=1,Re=2,De=3,Le=4,Oe=5,ke=6,Ne=7,T=0,E=1,D=2,$e=0,L=1,O=2,N=3,F=4,B=5,U=301,z=302,w=303,A=304,Fe=306,$=1e3,j=1001,W=1002,q=1003,X=1004,Be=1005,je=1006,We=1007,qe=1008,Xe=1009,V=1010,G=1011,Ye=1012,Ke=1013,Ze=1014,Qe=1015,it=1016,nt=1017,at=1018,st=1020,H=1021,ot=1023,lt=1024,ht=1025,ct=1026,ut=1027,dt=1028,mt=1029,pt=1030,ft=1031,gt=1033,vt=33776,_t=33777,yt=33778,bt=33779,xt=35840,St=35841,wt=35842,At=35843,Mt=36196,Ct=37492,Tt=37496,Et=37808,Pt=37809,It=37810,Rt=37811,Dt=37812,Lt=37813,Ot=37814,kt=37815,Nt=37816,Ft=37817,Bt=37818,Ut=37819,zt=37820,Vt=37821,Gt=36492,Ht=36494,$t=36495,jt=36283,Wt=36284,qt=36285,Xt=36286,Yt=3001,Kt=3201,Zt=0,Qt=1,Jt="",er="srgb",tr="srgb-linear",rr="display-p3",ir="display-p3-linear",nr="linear",ar="srgb",sr="rec709",or="p3",lr=7680,hr=512,cr=513,ur=514,dr=515,mr=516,pr=517,fr=518,gr=519,vr=35044,_r=35048,yr="300 es",br=1035,xr=2e3;class Sr{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)}hasEventListener(e,t){var r;return void 0!==this._listeners&&void 0!==(r=this._listeners)[e]&&-1!==r[e].indexOf(t)}removeEventListener(e,t){var r;void 0!==this._listeners&&void 0!==(e=this._listeners[e])&&-1!==(r=e.indexOf(t))&&e.splice(r,1)}dispatchEvent(r){if(void 0!==this._listeners){var e=this._listeners[r.type];if(void 0!==e){r.target=this;var i=e.slice(0);for(let e=0,t=i.length;e<t;e++)i[e].call(this,r);r.target=null}}}}let wr=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],Ar=Math.PI/180,Mr=180/Math.PI;function Cr(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(wr[255&e]+wr[e>>8&255]+wr[e>>16&255]+wr[e>>24&255]+"-"+wr[255&t]+wr[t>>8&255]+"-"+wr[t>>16&15|64]+wr[t>>24&255]+"-"+wr[63&r|128]+wr[r>>8&255]+"-"+wr[r>>16&255]+wr[r>>24&255]+wr[255&i]+wr[i>>8&255]+wr[i>>16&255]+wr[i>>24&255]).toLowerCase()}function Tr(e,t,r){return Math.max(t,Math.min(r,e))}function Er(e,t,r){return(1-r)*e+r*t}function Pr(e){return 0==(e&e-1)&&0!==e}function Ir(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function Rr(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Dr(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}class Ue{constructor(e=0,t=0){Ue.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){var t=this.x,r=this.y,e=e.elements;return this.x=e[0]*t+e[3]*r+e[6],this.y=e[1]*t+e[4]*r+e[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){var t=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===t?Math.PI/2:(e=this.dot(e)/t,Math.acos(Tr(e,-1,1)))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){var t=this.x-e.x,e=this.y-e.y;return t*t+e*e}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){var r=Math.cos(t),t=Math.sin(t),i=this.x-e.x,n=this.y-e.y;return this.x=i*r-n*t+e.x,this.y=i*t+n*r+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class v{constructor(e,t,r,i,n,a,s,o,l){v.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,r,i,n,a,s,o,l)}set(e,t,r,i,n,a,s,o,l){var h=this.elements;return h[0]=e,h[1]=i,h[2]=s,h[3]=t,h[4]=n,h[5]=o,h[6]=r,h[7]=a,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){var t=this.elements,e=e.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}extractBasis(e,t,r){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(e){e=e.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){var e=e.elements,t=t.elements,r=this.elements,i=e[0],n=e[3],a=e[6],s=e[1],o=e[4],l=e[7],h=e[2],c=e[5],e=e[8],u=t[0],d=t[3],m=t[6],p=t[1],f=t[4],g=t[7],v=t[2],_=t[5],t=t[8];return r[0]=i*u+n*p+a*v,r[3]=i*d+n*f+a*_,r[6]=i*m+n*g+a*t,r[1]=s*u+o*p+l*v,r[4]=s*d+o*f+l*_,r[7]=s*m+o*g+l*t,r[2]=h*u+c*p+e*v,r[5]=h*d+c*f+e*_,r[8]=h*m+c*g+e*t,this}multiplyScalar(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],e=e[8];return t*a*e-t*s*l-r*n*e+r*s*o+i*n*l-i*a*o}invert(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8],c=h*a-s*l,u=s*o-h*n,d=l*n-a*o,m=t*c+r*u+i*d;return 0==m?this.set(0,0,0,0,0,0,0,0,0):(e[0]=c*(c=1/m),e[1]=(i*l-h*r)*c,e[2]=(s*r-i*a)*c,e[3]=u*c,e[4]=(h*t-i*o)*c,e[5]=(i*n-s*t)*c,e[6]=d*c,e[7]=(r*o-l*t)*c,e[8]=(a*t-r*n)*c,this)}transpose(){var e=this.elements,t=e[1];return e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,r,i,n,a,s){var o=Math.cos(n),n=Math.sin(n);return this.set(r*o,r*n,-r*(o*a+n*s)+a+e,-i*n,i*o,-i*(-n*a+o*s)+s+t,0,0,1),this}scale(e,t){return this.premultiply(Lr.makeScale(e,t)),this}rotate(e){return this.premultiply(Lr.makeRotation(-e)),this}translate(e,t){return this.premultiply(Lr.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){var t=Math.cos(e),e=Math.sin(e);return this.set(t,-e,0,e,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){var t=this.elements,r=e.elements;for(let e=0;e<9;e++)if(t[e]!==r[e])return!1;return!0}fromArray(t,r=0){for(let e=0;e<9;e++)this.elements[e]=t[e+r];return this}toArray(e=[],t=0){var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}let Lr=new v;function Or(t){for(let e=t.length-1;0<=e;--e)if(65535<=t[e])return 1}function kr(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}let Nr={};function Fr(e){e in Nr||(Nr[e]=!0,console.warn(e))}let Br=(new v).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Ur=(new v).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),zr={[tr]:{transfer:nr,primaries:sr,toReference:e=>e,fromReference:e=>e},[er]:{transfer:ar,primaries:sr,toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[ir]:{transfer:nr,primaries:or,toReference:e=>e.applyMatrix3(Ur),fromReference:e=>e.applyMatrix3(Br)},[rr]:{transfer:ar,primaries:or,toReference:e=>e.convertSRGBToLinear().applyMatrix3(Ur),fromReference:e=>e.applyMatrix3(Br).convertLinearToSRGB()}},Vr=new Set([tr,ir]),pe={enabled:!0,_workingColorSpace:tr,get legacyMode(){return console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),!this.enabled},set legacyMode(e){console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),this.enabled=!e},get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(e){if(!Vr.has(e))throw new Error(`Unsupported working color space, "${e}".`);this._workingColorSpace=e},convert:function(e,t,r){return!1!==this.enabled&&t!==r&&t&&r?(t=zr[t].toReference,(0,zr[r].fromReference)(t(e))):e},fromWorkingColorSpace:function(e,t){return this.convert(e,this._workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this._workingColorSpace)},getPrimaries:function(e){return zr[e].primaries},getTransfer:function(e){return e===Jt?nr:zr[e].transfer}};function Gr(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Hr(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let $r;class jr{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;var r;return 2048<(t=e instanceof HTMLCanvasElement?e:(($r=void 0===$r?kr("canvas"):$r).width=e.width,$r.height=e.height,r=$r.getContext("2d"),e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height),$r)).width||2048<t.height?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){var t=kr("canvas"),r=(t.width=e.width,t.height=e.height,t.getContext("2d")),i=(r.drawImage(e,0,0,e.width,e.height),r.getImageData(0,0,e.width,e.height)),n=i.data;for(let e=0;e<n.length;e++)n[e]=255*Gr(n[e]/255);return r.putImageData(i,0,0),t}if(e.data){var a=e.data.slice(0);for(let e=0;e<a.length;e++)a instanceof Uint8Array||a instanceof Uint8ClampedArray?a[e]=Math.floor(255*Gr(a[e]/255)):a[e]=Gr(a[e]);return{data:a,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let Wr=0;class qr{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Wr++}),this.uuid=Cr(),this.data=e,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){var t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];var i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let r;if(Array.isArray(n)){r=[];for(let e=0,t=n.length;e<t;e++)n[e].isDataTexture?r.push(Xr(n[e].image)):r.push(Xr(n[e]))}else r=Xr(n);i.url=r}return t||(e.images[this.uuid]=i),i}}function Xr(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?jr.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Yr=0;class Kr extends Sr{constructor(e=Kr.DEFAULT_IMAGE,t=Kr.DEFAULT_MAPPING,r=j,i=j,n=je,a=qe,s=ot,o=Xe,l=Kr.DEFAULT_ANISOTROPY,h=Jt){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Yr++}),this.uuid=Cr(),this.name="",this.source=new qr(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=r,this.wrapT=i,this.magFilter=n,this.minFilter=a,this.anisotropy=l,this.format=s,this.internalFormat=null,this.type=o,this.offset=new Ue(0,0),this.repeat=new Ue(1,1),this.center=new Ue(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new v,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,"string"==typeof h?this.colorSpace=h:(Fr("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=h===Yt?er:Jt),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){var t,r=void 0===e||"string"==typeof e;return r||void 0===e.textures[this.uuid]?(t={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment},0<Object.keys(this.userData).length&&(t.userData=this.userData),r||(e.textures[this.uuid]=t),t):e.textures[this.uuid]}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300===this.mapping){if(e.applyMatrix3(this.matrix),e.x<0||1<e.x)switch(this.wrapS){case $:e.x=e.x-Math.floor(e.x);break;case j:e.x=e.x<0?0:1;break;case W:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||1<e.y)switch(this.wrapT){case $:e.y=e.y-Math.floor(e.y);break;case j:e.y=e.y<0?0:1;break;case W:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}return e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return Fr("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===er?Yt:3e3}set encoding(e){Fr("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=e===Yt?er:Jt}}Kr.DEFAULT_IMAGE=null,Kr.DEFAULT_MAPPING=300,Kr.DEFAULT_ANISOTROPY=1;class Zr{constructor(e=0,t=0,r=0,i=1){Zr.prototype.isVector4=!0,this.x=e,this.y=t,this.z=r,this.w=i}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){var t=this.x,r=this.y,i=this.z,n=this.w,e=e.elements;return this.x=e[0]*t+e[4]*r+e[8]*i+e[12]*n,this.y=e[1]*t+e[5]*r+e[9]*i+e[13]*n,this.z=e[2]*t+e[6]*r+e[10]*i+e[14]*n,this.w=e[3]*t+e[7]*r+e[11]*i+e[15]*n,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(t){let e,r,i,n;var a,s,o,l,h,c,t=t.elements,u=t[0],d=t[4],m=t[8],p=t[1],f=t[5],g=t[9],v=t[2],_=t[6],t=t[10];if(Math.abs(d-p)<.01&&Math.abs(m-v)<.01&&Math.abs(g-_)<.01)Math.abs(d+p)<.1&&Math.abs(m+v)<.1&&Math.abs(g+_)<.1&&Math.abs(u+f+t-3)<.1?this.set(1,0,0,0):(e=Math.PI,o=(t+1)/2,l=(d+p)/4,h=(m+v)/4,c=(g+_)/4,(s=(f+1)/2)<(a=(u+1)/2)&&o<a?n=a<.01?(r=0,i=.707106781):(r=Math.sqrt(a),i=l/r,h/r):o<s?n=s<.01?(r=.707106781,i=0,.707106781):(i=Math.sqrt(s),r=l/i,c/i):o<.01?(r=.707106781,i=.707106781,n=0):(n=Math.sqrt(o),r=h/n,i=c/n),this.set(r,i,n,e));else{let e=Math.sqrt((_-g)*(_-g)+(m-v)*(m-v)+(p-d)*(p-d));Math.abs(e)<.001&&(e=1),this.x=(_-g)/e,this.y=(m-v)/e,this.z=(p-d)/e,this.w=Math.acos((u+f+t-1)/2)}return this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this.w=e.w+(t.w-e.w)*r,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Qr extends Sr{constructor(e=1,t=1,r={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new Zr(0,0,e,t),this.scissorTest=!1,this.viewport=new Zr(0,0,e,t);e={width:e,height:t,depth:1};void 0!==r.encoding&&(Fr("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),r.colorSpace=r.encoding===Yt?er:Jt),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:je,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},r),this.texture=new Kr(e,r.mapping,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=r.generateMipmaps,this.texture.internalFormat=r.internalFormat,this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.depthTexture=r.depthTexture,this.samples=r.samples}setSize(e,t,r=1){this.width===e&&this.height===t&&this.depth===r||(this.width=e,this.height=t,this.depth=r,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=r,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.isRenderTargetTexture=!0;var t=Object.assign({},e.texture.image);return this.texture.source=new qr(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Jr extends Qr{constructor(e=1,t=1,r={}){super(e,t,r),this.isWebGLRenderTarget=!0}}class ei extends Kr{constructor(e=null,t=1,r=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:r,depth:i},this.magFilter=q,this.minFilter=q,this.wrapR=j,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class ti extends Kr{constructor(e=null,t=1,r=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:r,depth:i},this.magFilter=q,this.minFilter=q,this.wrapR=j,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class ri{constructor(e=0,t=0,r=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=r,this._w=i}static slerpFlat(e,t,r,i,n,a,s){let o=r[i+0],l=r[i+1],h=r[i+2],c=r[i+3];var r=n[a+0],i=n[a+1],u=n[a+2],n=n[a+3];if(0===s)e[t+0]=o,e[t+1]=l,e[t+2]=h,e[t+3]=c;else if(1===s)e[t+0]=r,e[t+1]=i,e[t+2]=u,e[t+3]=n;else{if(c!==n||o!==r||l!==i||h!==u){let e=1-s;var a=o*r+l*i+h*u+c*n,d=0<=a?1:-1,m=1-a*a,a=(m>Number.EPSILON&&(m=Math.sqrt(m),a=Math.atan2(m,a*d),e=Math.sin(e*a)/m,s=Math.sin(s*a)/m),s*d);o=o*e+r*a,l=l*e+i*a,h=h*e+u*a,c=c*e+n*a,e===1-s&&(m=1/Math.sqrt(o*o+l*l+h*h+c*c),o*=m,l*=m,h*=m,c*=m)}e[t]=o,e[t+1]=l,e[t+2]=h,e[t+3]=c}}static multiplyQuaternionsFlat(e,t,r,i,n,a){var s=r[i],o=r[i+1],l=r[i+2],r=r[i+3],i=n[a],h=n[a+1],c=n[a+2],n=n[a+3];return e[t]=s*n+r*i+o*c-l*h,e[t+1]=o*n+r*h+l*i-s*c,e[t+2]=l*n+r*c+s*h-o*i,e[t+3]=r*n-s*i-o*h-l*c,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){var r=e._x,i=e._y,n=e._z,a=e._order,e=Math.cos,s=Math.sin,o=e(r/2),l=e(i/2),h=e(n/2),c=s(r/2),u=s(i/2),d=s(n/2);switch(a){case"XYZ":this._x=c*l*h+o*u*d,this._y=o*u*h-c*l*d,this._z=o*l*d+c*u*h,this._w=o*l*h-c*u*d;break;case"YXZ":this._x=c*l*h+o*u*d,this._y=o*u*h-c*l*d,this._z=o*l*d-c*u*h,this._w=o*l*h+c*u*d;break;case"ZXY":this._x=c*l*h-o*u*d,this._y=o*u*h+c*l*d,this._z=o*l*d+c*u*h,this._w=o*l*h-c*u*d;break;case"ZYX":this._x=c*l*h-o*u*d,this._y=o*u*h+c*l*d,this._z=o*l*d-c*u*h,this._w=o*l*h+c*u*d;break;case"YZX":this._x=c*l*h+o*u*d,this._y=o*u*h+c*l*d,this._z=o*l*d-c*u*h,this._w=o*l*h-c*u*d;break;case"XZY":this._x=c*l*h-o*u*d,this._y=o*u*h-c*l*d,this._z=o*l*d+c*u*h,this._w=o*l*h+c*u*d;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){var t=t/2,r=Math.sin(t);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(t),this._onChangeCallback(),this}setFromRotationMatrix(e){var e=e.elements,t=e[0],r=e[4],i=e[8],n=e[1],a=e[5],s=e[9],o=e[2],l=e[6],e=e[10],h=t+a+e;return 0<h?(h=.5/Math.sqrt(h+1),this._w=.25/h,this._x=(l-s)*h,this._y=(i-o)*h,this._z=(n-r)*h):a<t&&e<t?(h=2*Math.sqrt(1+t-a-e),this._w=(l-s)/h,this._x=.25*h,this._y=(r+n)/h,this._z=(i+o)/h):e<a?(h=2*Math.sqrt(1+a-t-e),this._w=(i-o)/h,this._x=(r+n)/h,this._y=.25*h,this._z=(s+l)/h):(h=2*Math.sqrt(1+e-t-a),this._w=(n-r)/h,this._x=(i+o)/h,this._y=(s+l)/h,this._z=.25*h),this._onChangeCallback(),this}setFromUnitVectors(e,t){let r=e.dot(t)+1;return r<Number.EPSILON?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0):(this._x=0,this._y=-e.z,this._z=e.y)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x),this._w=r,this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Tr(this.dot(e),-1,1)))}rotateTowards(e,t){var r=this.angleTo(e);return 0!==r&&(t=Math.min(1,t/r),this.slerp(e,t)),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(this._x=this._x*(e=1/e),this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){var r=e._x,i=e._y,n=e._z,e=e._w,a=t._x,s=t._y,o=t._z,t=t._w;return this._x=r*t+e*a+i*o-n*s,this._y=i*t+e*s+n*a-r*o,this._z=n*t+e*o+r*s-i*a,this._w=e*t-r*a-i*s-n*o,this._onChangeCallback(),this}slerp(t,r){if(0!==r){if(1===r)return this.copy(t);var i,n,a=this._x,s=this._y,o=this._z,l=this._w;let e=l*t._w+a*t._x+s*t._y+o*t._z;e<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,e=-e):this.copy(t),1<=e?(this._w=l,this._x=a,this._y=s,this._z=o):((t=1-e*e)<=Number.EPSILON?(this._w=(i=1-r)*l+r*this._w,this._x=i*a+r*this._x,this._y=i*s+r*this._y,this._z=i*o+r*this._z,this.normalize()):(i=Math.sqrt(t),t=Math.atan2(i,e),n=Math.sin((1-r)*t)/i,r=Math.sin(r*t)/i,this._w=l*n+this._w*r,this._x=a*n+this._x*r,this._y=s*n+this._y*r,this._z=o*n+this._z*r),this._onChangeCallback())}return this}slerpQuaternions(e,t,r){return this.copy(e).slerp(t,r)}random(){var e=Math.random(),t=Math.sqrt(1-e),e=Math.sqrt(e),r=2*Math.PI*Math.random(),i=2*Math.PI*Math.random();return this.set(t*Math.cos(r),e*Math.sin(i),e*Math.cos(i),t*Math.sin(r))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class et{constructor(e=0,t=0,r=0){et.prototype.isVector3=!0,this.x=e,this.y=t,this.z=r}set(e,t,r){return void 0===r&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(ni.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(ni.setFromAxisAngle(e,t))}applyMatrix3(e){var t=this.x,r=this.y,i=this.z,e=e.elements;return this.x=e[0]*t+e[3]*r+e[6]*i,this.y=e[1]*t+e[4]*r+e[7]*i,this.z=e[2]*t+e[5]*r+e[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){var t=this.x,r=this.y,i=this.z,e=e.elements,n=1/(e[3]*t+e[7]*r+e[11]*i+e[15]);return this.x=(e[0]*t+e[4]*r+e[8]*i+e[12])*n,this.y=(e[1]*t+e[5]*r+e[9]*i+e[13])*n,this.z=(e[2]*t+e[6]*r+e[10]*i+e[14])*n,this}applyQuaternion(e){var t=this.x,r=this.y,i=this.z,n=e.x,a=e.y,s=e.z,e=e.w,o=2*(a*i-s*r),l=2*(s*t-n*i),h=2*(n*r-a*t);return this.x=t+e*o+a*h-s*l,this.y=r+e*l+s*o-n*h,this.z=i+e*h+n*l-a*o,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){var t=this.x,r=this.y,i=this.z,e=e.elements;return this.x=e[0]*t+e[4]*r+e[8]*i,this.y=e[1]*t+e[5]*r+e[9]*i,this.z=e[2]*t+e[6]*r+e[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){var r=e.x,i=e.y,e=e.z,n=t.x,a=t.y,t=t.z;return this.x=i*t-e*a,this.y=e*n-r*t,this.z=r*a-i*n,this}projectOnVector(e){var t=e.lengthSq();return 0===t?this.set(0,0,0):(t=e.dot(this)/t,this.copy(e).multiplyScalar(t))}projectOnPlane(e){return ii.copy(this).projectOnVector(e),this.sub(ii)}reflect(e){return this.sub(ii.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===t?Math.PI/2:(e=this.dot(e)/t,Math.acos(Tr(e,-1,1)))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){var t=this.x-e.x,r=this.y-e.y,e=this.z-e.z;return t*t+r*r+e*e}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){var i=Math.sin(t)*e;return this.x=i*Math.sin(r),this.y=Math.cos(t)*e,this.z=i*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){e=e.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),e=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=e,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){var e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,r=Math.sqrt(1-e**2);return this.x=r*Math.cos(t),this.y=r*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}let ii=new et,ni=new ri;class ai{constructor(e=new et(1/0,1/0,1/0),t=new et(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(r){this.makeEmpty();for(let e=0,t=r.length;e<t;e+=3)this.expandByPoint(oi.fromArray(r,e));return this}setFromBufferAttribute(r){this.makeEmpty();for(let e=0,t=r.count;e<t;e++)this.expandByPoint(oi.fromBufferAttribute(r,e));return this}setFromPoints(r){this.makeEmpty();for(let e=0,t=r.length;e<t;e++)this.expandByPoint(r[e]);return this}setFromCenterAndSize(e,t){t=oi.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(t),this.max.copy(e).add(t),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(r,i=!1){r.updateWorldMatrix(!1,!1);var e=r.geometry;if(void 0!==e){var n=e.getAttribute("position");if(!0===i&&void 0!==n&&!0!==r.isInstancedMesh)for(let e=0,t=n.count;e<t;e++)!0===r.isMesh?r.getVertexPosition(e,oi):oi.fromBufferAttribute(n,e),oi.applyMatrix4(r.matrixWorld),this.expandByPoint(oi);else void 0!==r.boundingBox?(null===r.boundingBox&&r.computeBoundingBox(),li.copy(r.boundingBox)):(null===e.boundingBox&&e.computeBoundingBox(),li.copy(e.boundingBox)),li.applyMatrix4(r.matrixWorld),this.union(li)}var a=r.children;for(let e=0,t=a.length;e<t;e++)this.expandByObject(a[e],i);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,oi),oi.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,r;return r=0<e.normal.x?(t=e.normal.x*this.min.x,e.normal.x*this.max.x):(t=e.normal.x*this.max.x,e.normal.x*this.min.x),0<e.normal.y?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),0<e.normal.z?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=-e.constant&&r>=-e.constant}intersectsTriangle(e){return!this.isEmpty()&&(this.getCenter(fi),gi.subVectors(this.max,fi),hi.subVectors(e.a,fi),ci.subVectors(e.b,fi),ui.subVectors(e.c,fi),di.subVectors(ci,hi),mi.subVectors(ui,ci),pi.subVectors(hi,ui),!!yi([0,-di.z,di.y,0,-mi.z,mi.y,0,-pi.z,pi.y,di.z,0,-di.x,mi.z,0,-mi.x,pi.z,0,-pi.x,-di.y,di.x,0,-mi.y,mi.x,0,-pi.y,pi.x,0],hi,ci,ui,gi))&&!!yi([1,0,0,0,1,0,0,0,1],hi,ci,ui,gi)&&(vi.crossVectors(di,mi),yi([vi.x,vi.y,vi.z],hi,ci,ui,gi))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,oi).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(oi).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(si[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),si[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),si[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),si[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),si[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),si[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),si[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),si[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(si)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}let si=[new et,new et,new et,new et,new et,new et,new et,new et],oi=new et,li=new ai,hi=new et,ci=new et,ui=new et,di=new et,mi=new et,pi=new et,fi=new et,gi=new et,vi=new et,_i=new et;function yi(r,i,n,a,s){for(let e=0,t=r.length-3;e<=t;e+=3){_i.fromArray(r,e);var o=s.x*Math.abs(_i.x)+s.y*Math.abs(_i.y)+s.z*Math.abs(_i.z),l=i.dot(_i),h=n.dot(_i),c=a.dot(_i);if(Math.max(-Math.max(l,h,c),Math.min(l,h,c))>o)return!1}return!0}let bi=new ai,xi=new et,Si=new et;class wi{constructor(e=new et,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(r,e){var i=this.center;void 0!==e?i.copy(e):bi.setFromPoints(r).getCenter(i);let n=0;for(let e=0,t=r.length;e<t;e++)n=Math.max(n,i.distanceToSquared(r[e]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){var r=this.center.distanceToSquared(e);return t.copy(e),r>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?e.makeEmpty():(e.set(this.center,this.center),e.expandByScalar(this.radius)),e}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){var t;return this.isEmpty()?(this.center.copy(e),this.radius=0):(xi.subVectors(e,this.center),(e=xi.lengthSq())>this.radius*this.radius&&(t=.5*((e=Math.sqrt(e))-this.radius),this.center.addScaledVector(xi,t/e),this.radius+=t)),this}union(e){return e.isEmpty()||(this.isEmpty()?this.copy(e):!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Si.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(xi.copy(e.center).add(Si)),this.expandByPoint(xi.copy(e.center).sub(Si)))),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}let Ai=new et,Mi=new et,Ci=new et,Ti=new et,Ei=new et,Pi=new et,Ii=new et;class Ri{constructor(e=new et,t=new et(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Ai)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);e=t.dot(this.direction);return e<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,e)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){var t=Ai.subVectors(e,this.origin).dot(this.direction);return(t<0?this.origin:(Ai.copy(this.origin).addScaledVector(this.direction,t),Ai)).distanceToSquared(e)}distanceSqToSegment(e,t,r,i){Mi.copy(e).add(t).multiplyScalar(.5),Ci.copy(t).sub(e).normalize(),Ti.copy(this.origin).sub(Mi);var e=.5*e.distanceTo(t),t=-this.direction.dot(Ci),n=Ti.dot(this.direction),a=-Ti.dot(Ci),s=Ti.lengthSq(),o=Math.abs(1-t*t);let l,h,c,u;return c=0<o?(l=t*a-n,h=t*n-a,u=e*o,0<=l?h>=-u?h<=u?(o=1/o,l*=o,h*=o,l*(l+t*h+2*n)+h*(t*l+h+2*a)+s):(h=e,-(l=Math.max(0,-(t*h+n)))*l+h*(h+2*a)+s):(h=-e,-(l=Math.max(0,-(t*h+n)))*l+h*(h+2*a)+s):h<=-u?(l=Math.max(0,-(-t*e+n)),h=0<l?-e:Math.min(Math.max(-e,-a),e),-l*l+h*(h+2*a)+s):h<=u?(l=0,(h=Math.min(Math.max(-e,-a),e))*(h+2*a)+s):(l=Math.max(0,-(t*e+n)),h=0<l?e:Math.min(Math.max(-e,-a),e),-l*l+h*(h+2*a)+s)):(h=0<t?-e:e,-(l=Math.max(0,-(t*h+n)))*l+h*(h+2*a)+s),r&&r.copy(this.origin).addScaledVector(this.direction,l),i&&i.copy(Mi).addScaledVector(Ci,h),c}intersectSphere(e,t){Ai.subVectors(e.center,this.origin);var r=Ai.dot(this.direction),i=Ai.dot(Ai)-r*r,e=e.radius*e.radius;return e<i||(i=r-(e=Math.sqrt(e-i)),(r=r+e)<0)?null:i<0?this.at(r,t):this.at(i,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){var t=e.normal.dot(this.direction);return 0===t?0===e.distanceToPoint(this.origin)?0:null:0<=(e=-(this.origin.dot(e.normal)+e.constant)/t)?e:null}intersectPlane(e,t){e=this.distanceToPlane(e);return null===e?null:this.at(e,t)}intersectsPlane(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let r,i,n,a,s,o;var l=1/this.direction.x,h=1/this.direction.y,c=1/this.direction.z,u=this.origin;return i=0<=l?(r=(e.min.x-u.x)*l,(e.max.x-u.x)*l):(r=(e.max.x-u.x)*l,(e.min.x-u.x)*l),a=0<=h?(n=(e.min.y-u.y)*h,(e.max.y-u.y)*h):(n=(e.max.y-u.y)*h,(e.min.y-u.y)*h),r>a||n>i||((n>r||isNaN(r))&&(r=n),(a<i||isNaN(i))&&(i=a),o=0<=c?(s=(e.min.z-u.z)*c,(e.max.z-u.z)*c):(s=(e.max.z-u.z)*c,(e.min.z-u.z)*c),r>o)||s>i||((s>r||r!=r)&&(r=s),(i=o<i||i!=i?o:i)<0)?null:this.at(0<=r?r:i,t)}intersectsBox(e){return null!==this.intersectBox(e,Ai)}intersectTriangle(e,t,r,i,n){Ei.subVectors(t,e),Pi.subVectors(r,e),Ii.crossVectors(Ei,Pi);let a=this.direction.dot(Ii),s;if(0<a){if(i)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}Ti.subVectors(this.origin,e);t=s*this.direction.dot(Pi.crossVectors(Ti,Pi));return t<0||(r=s*this.direction.dot(Ei.cross(Ti)))<0||t+r>a||(i=-s*Ti.dot(Ii))<0?null:this.at(i/a,n)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class tt{constructor(e,t,r,i,n,a,s,o,l,h,c,u,d,m,p,f){tt.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,r,i,n,a,s,o,l,h,c,u,d,m,p,f)}set(e,t,r,i,n,a,s,o,l,h,c,u,d,m,p,f){var g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=i,g[1]=n,g[5]=a,g[9]=s,g[13]=o,g[2]=l,g[6]=h,g[10]=c,g[14]=u,g[3]=d,g[7]=m,g[11]=p,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new tt).fromArray(this.elements)}copy(e){var t=this.elements,e=e.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}copyPosition(e){var t=this.elements,e=e.elements;return t[12]=e[12],t[13]=e[13],t[14]=e[14],this}setFromMatrix3(e){e=e.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){var t=this.elements,r=e.elements,i=1/Di.setFromMatrixColumn(e,0).length(),n=1/Di.setFromMatrixColumn(e,1).length(),e=1/Di.setFromMatrixColumn(e,2).length();return t[0]=r[0]*i,t[1]=r[1]*i,t[2]=r[2]*i,t[3]=0,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[7]=0,t[8]=r[8]*e,t[9]=r[9]*e,t[10]=r[10]*e,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){var t,r,i,n,a=this.elements,s=e.x,o=e.y,l=e.z,h=Math.cos(s),s=Math.sin(s),c=Math.cos(o),o=Math.sin(o),u=Math.cos(l),l=Math.sin(l);return"XYZ"===e.order?(r=h*u,i=h*l,n=s*u,t=s*l,a[0]=c*u,a[4]=-c*l,a[8]=o,a[1]=i+n*o,a[5]=r-t*o,a[9]=-s*c,a[2]=t-r*o,a[6]=n+i*o,a[10]=h*c):"YXZ"===e.order?(t=c*l,r=o*u,a[0]=(n=c*u)+(i=o*l)*s,a[4]=r*s-t,a[8]=h*o,a[1]=h*l,a[5]=h*u,a[9]=-s,a[2]=t*s-r,a[6]=i+n*s,a[10]=h*c):"ZXY"===e.order?(t=c*l,r=o*u,a[0]=(i=c*u)-(n=o*l)*s,a[4]=-h*l,a[8]=r+t*s,a[1]=t+r*s,a[5]=h*u,a[9]=n-i*s,a[2]=-h*o,a[6]=s,a[10]=h*c):"ZYX"===e.order?(t=h*u,r=h*l,n=s*u,i=s*l,a[0]=c*u,a[4]=n*o-r,a[8]=t*o+i,a[1]=c*l,a[5]=i*o+t,a[9]=r*o-n,a[2]=-o,a[6]=s*c,a[10]=h*c):"YZX"===e.order?(i=h*c,t=h*o,r=s*c,n=s*o,a[0]=c*u,a[4]=n-i*l,a[8]=r*l+t,a[1]=l,a[5]=h*u,a[9]=-s*u,a[2]=-o*u,a[6]=t*l+r,a[10]=i-n*l):"XZY"===e.order&&(t=h*c,r=h*o,i=s*c,n=s*o,a[0]=c*u,a[4]=-l,a[8]=o*u,a[1]=t*l+n,a[5]=h*u,a[9]=r*l-i,a[2]=i*l-r,a[6]=s*u,a[10]=n*l+t),a[3]=0,a[7]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Oi,e,ki)}lookAt(e,t,r){var i=this.elements;return Bi.subVectors(e,t),0===Bi.lengthSq()&&(Bi.z=1),Bi.normalize(),Ni.crossVectors(r,Bi),0===Ni.lengthSq()&&(1===Math.abs(r.z)?Bi.x+=1e-4:Bi.z+=1e-4,Bi.normalize(),Ni.crossVectors(r,Bi)),Ni.normalize(),Fi.crossVectors(Bi,Ni),i[0]=Ni.x,i[4]=Fi.x,i[8]=Bi.x,i[1]=Ni.y,i[5]=Fi.y,i[9]=Bi.y,i[2]=Ni.z,i[6]=Fi.z,i[10]=Bi.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){var e=e.elements,t=t.elements,r=this.elements,i=e[0],n=e[4],a=e[8],s=e[12],o=e[1],l=e[5],h=e[9],c=e[13],u=e[2],d=e[6],m=e[10],p=e[14],f=e[3],g=e[7],v=e[11],e=e[15],_=t[0],y=t[4],b=t[8],x=t[12],S=t[1],w=t[5],A=t[9],M=t[13],C=t[2],T=t[6],E=t[10],P=t[14],I=t[3],R=t[7],D=t[11],t=t[15];return r[0]=i*_+n*S+a*C+s*I,r[4]=i*y+n*w+a*T+s*R,r[8]=i*b+n*A+a*E+s*D,r[12]=i*x+n*M+a*P+s*t,r[1]=o*_+l*S+h*C+c*I,r[5]=o*y+l*w+h*T+c*R,r[9]=o*b+l*A+h*E+c*D,r[13]=o*x+l*M+h*P+c*t,r[2]=u*_+d*S+m*C+p*I,r[6]=u*y+d*w+m*T+p*R,r[10]=u*b+d*A+m*E+p*D,r[14]=u*x+d*M+m*P+p*t,r[3]=f*_+g*S+v*C+e*I,r[7]=f*y+g*w+v*T+e*R,r[11]=f*b+g*A+v*E+e*D,r[15]=f*x+g*M+v*P+e*t,this}multiplyScalar(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){var e=this.elements,t=e[0],r=e[4],i=e[8],n=e[12],a=e[1],s=e[5],o=e[9],l=e[13],h=e[2],c=e[6],u=e[10],d=e[14];return e[3]*(+n*o*c-i*l*c-n*s*u+r*l*u+i*s*d-r*o*d)+e[7]*(+t*o*d-t*l*u+n*a*u-i*a*d+i*l*h-n*o*h)+e[11]*(+t*l*c-t*s*d-n*a*c+r*a*d+n*s*h-r*l*h)+e[15]*(-i*s*h-t*o*c+t*s*u+i*a*c-r*a*u+r*o*h)}transpose(){var e=this.elements,t=e[1];return e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,r){var i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=r),this}invert(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],m=e[12],p=e[13],f=e[14],g=e[15],v=c*f*l-p*u*l+p*o*d-s*f*d-c*o*g+s*u*g,_=m*u*l-h*f*l-m*o*d+a*f*d+h*o*g-a*u*g,y=h*p*l-m*c*l+m*s*d-a*p*d-h*s*g+a*c*g,b=m*c*o-h*p*o-m*s*u+a*p*u+h*s*f-a*c*f,x=t*v+r*_+i*y+n*b;return 0==x?this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0):(e[0]=v*(v=1/x),e[1]=(p*u*n-c*f*n-p*i*d+r*f*d+c*i*g-r*u*g)*v,e[2]=(s*f*n-p*o*n+p*i*l-r*f*l-s*i*g+r*o*g)*v,e[3]=(c*o*n-s*u*n-c*i*l+r*u*l+s*i*d-r*o*d)*v,e[4]=_*v,e[5]=(h*f*n-m*u*n+m*i*d-t*f*d-h*i*g+t*u*g)*v,e[6]=(m*o*n-a*f*n-m*i*l+t*f*l+a*i*g-t*o*g)*v,e[7]=(a*u*n-h*o*n+h*i*l-t*u*l-a*i*d+t*o*d)*v,e[8]=y*v,e[9]=(m*c*n-h*p*n-m*r*d+t*p*d+h*r*g-t*c*g)*v,e[10]=(a*p*n-m*s*n+m*r*l-t*p*l-a*r*g+t*s*g)*v,e[11]=(h*s*n-a*c*n-h*r*l+t*c*l+a*r*d-t*s*d)*v,e[12]=b*v,e[13]=(h*p*i-m*c*i+m*r*u-t*p*u-h*r*f+t*c*f)*v,e[14]=(m*s*i-a*p*i-m*r*o+t*p*o+a*r*f-t*s*f)*v,e[15]=(a*c*i-h*s*i+h*r*o-t*c*o-a*r*u+t*s*u)*v,this)}scale(e){var t=this.elements,r=e.x,i=e.y,e=e.z;return t[0]*=r,t[4]*=i,t[8]*=e,t[1]*=r,t[5]*=i,t[9]*=e,t[2]*=r,t[6]*=i,t[10]*=e,t[3]*=r,t[7]*=i,t[11]*=e,this}getMaxScaleOnAxis(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return Math.sqrt(Math.max(t,e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))}makeTranslation(e,t,r){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){var t=Math.cos(e),e=Math.sin(e);return this.set(1,0,0,0,0,t,-e,0,0,e,t,0,0,0,0,1),this}makeRotationY(e){var t=Math.cos(e),e=Math.sin(e);return this.set(t,0,e,0,0,1,0,0,-e,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=Math.cos(e),e=Math.sin(e);return this.set(t,-e,0,0,e,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var r=Math.cos(t),t=Math.sin(t),i=1-r,n=e.x,a=e.y,e=e.z,s=i*n,o=i*a;return this.set(s*n+r,s*a-t*e,s*e+t*a,0,s*a+t*e,o*a+r,o*e-t*n,0,s*e-t*a,o*e+t*n,i*e*e+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r,i,n,a){return this.set(1,r,n,0,e,1,a,0,t,i,1,0,0,0,0,1),this}compose(e,t,r){var i=this.elements,n=t._x,a=t._y,s=t._z,t=t._w,o=n+n,l=a+a,h=s+s,c=n*o,u=n*l,n=n*h,d=a*l,a=a*h,s=s*h,o=t*o,l=t*l,t=t*h,h=r.x,m=r.y,r=r.z;return i[0]=(1-(d+s))*h,i[1]=(u+t)*h,i[2]=(n-l)*h,i[3]=0,i[4]=(u-t)*m,i[5]=(1-(c+s))*m,i[6]=(a+o)*m,i[7]=0,i[8]=(n+l)*r,i[9]=(a-o)*r,i[10]=(1-(c+d))*r,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,r){var i=this.elements;let n=Di.set(i[0],i[1],i[2]).length();var a=Di.set(i[4],i[5],i[6]).length(),s=Di.set(i[8],i[9],i[10]).length(),e=(this.determinant()<0&&(n=-n),e.x=i[12],e.y=i[13],e.z=i[14],Li.copy(this),1/n),i=1/a,o=1/s;return Li.elements[0]*=e,Li.elements[1]*=e,Li.elements[2]*=e,Li.elements[4]*=i,Li.elements[5]*=i,Li.elements[6]*=i,Li.elements[8]*=o,Li.elements[9]*=o,Li.elements[10]*=o,t.setFromRotationMatrix(Li),r.x=n,r.y=a,r.z=s,this}makePerspective(e,t,r,i,n,a,s=xr){var o=this.elements,l=2*n/(t-e),h=2*n/(r-i),t=(t+e)/(t-e),e=(r+i)/(r-i);let c,u;if(s===xr)c=-(a+n)/(a-n),u=-2*a*n/(a-n);else{if(2001!==s)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+s);c=-a/(a-n),u=-a*n/(a-n)}return o[0]=l,o[4]=0,o[8]=t,o[12]=0,o[1]=0,o[5]=h,o[9]=e,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=u,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,r,i,n,a,s=xr){var o=this.elements,l=1/(t-e),h=1/(r-i),c=1/(a-n),t=(t+e)*l,e=(r+i)*h;let u,d;if(s===xr)u=(a+n)*c,d=-2*c;else{if(2001!==s)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+s);u=n*c,d=-1*c}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-t,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-e,o[2]=0,o[6]=0,o[10]=d,o[14]=-u,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){var t=this.elements,r=e.elements;for(let e=0;e<16;e++)if(t[e]!==r[e])return!1;return!0}fromArray(t,r=0){for(let e=0;e<16;e++)this.elements[e]=t[e+r];return this}toArray(e=[],t=0){var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}let Di=new et,Li=new tt,Oi=new et(0,0,0),ki=new et(1,1,1),Ni=new et,Fi=new et,Bi=new et,Ui=new tt,zi=new ri;class Vi{constructor(e=0,t=0,r=0,i=Vi.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=r,this._order=i}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,r,i=this._order){return this._x=e,this._y=t,this._z=r,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,r=!0){var e=e.elements,i=e[0],n=e[4],a=e[8],s=e[1],o=e[5],l=e[9],h=e[2],c=e[6],u=e[10];switch(t){case"XYZ":this._y=Math.asin(Tr(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,u),this._z=Math.atan2(-n,i)):(this._x=Math.atan2(c,o),this._z=0);break;case"YXZ":this._x=Math.asin(-Tr(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,u),this._z=Math.atan2(s,o)):(this._y=Math.atan2(-h,i),this._z=0);break;case"ZXY":this._x=Math.asin(Tr(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(-h,u),this._z=Math.atan2(-n,o)):(this._y=0,this._z=Math.atan2(s,i));break;case"ZYX":this._y=Math.asin(-Tr(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(c,u),this._z=Math.atan2(s,i)):(this._x=0,this._z=Math.atan2(-n,o));break;case"YZX":this._z=Math.asin(Tr(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-l,o),this._y=Math.atan2(-h,i)):(this._x=0,this._y=Math.atan2(a,u));break;case"XZY":this._z=Math.asin(-Tr(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(c,o),this._y=Math.atan2(a,i)):(this._x=Math.atan2(-l,u),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===r&&this._onChangeCallback(),this}setFromQuaternion(e,t,r){return Ui.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Ui,t,r)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return zi.setFromEuler(this),this.setFromQuaternion(zi,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Vi.DEFAULT_ORDER="XYZ";class Gi{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}isEnabled(e){return 0!=(this.mask&(1<<e|0))}}let Hi=0,$i=new et,ji=new ri,Wi=new tt,qi=new et,Xi=new et,Yi=new et,Ki=new ri,Zi=new et(1,0,0),Qi=new et(0,1,0),Ji=new et(0,0,1),en={type:"added"},tn={type:"removed"};class rn extends Sr{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Hi++}),this.uuid=Cr(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=rn.DEFAULT_UP.clone();var e=new et;let t=new Vi,r=new ri;var i=new et(1,1,1);t._onChange(function(){r.setFromEuler(t,!1)}),r._onChange(function(){t.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new tt},normalMatrix:{value:new v}}),this.matrix=new tt,this.matrixWorld=new tt,this.matrixAutoUpdate=rn.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.matrixWorldAutoUpdate=rn.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.layers=new Gi,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return ji.setFromAxisAngle(e,t),this.quaternion.multiply(ji),this}rotateOnWorldAxis(e,t){return ji.setFromAxisAngle(e,t),this.quaternion.premultiply(ji),this}rotateX(e){return this.rotateOnAxis(Zi,e)}rotateY(e){return this.rotateOnAxis(Qi,e)}rotateZ(e){return this.rotateOnAxis(Ji,e)}translateOnAxis(e,t){return $i.copy(e).applyQuaternion(this.quaternion),this.position.add($i.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Zi,e)}translateY(e){return this.translateOnAxis(Qi,e)}translateZ(e){return this.translateOnAxis(Ji,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Wi.copy(this.matrixWorld).invert())}lookAt(e,t,r){e.isVector3?qi.copy(e):qi.set(e,t,r);e=this.parent;this.updateWorldMatrix(!0,!1),Xi.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Wi.lookAt(Xi,qi,this.up):Wi.lookAt(qi,Xi,this.up),this.quaternion.setFromRotationMatrix(Wi),e&&(Wi.extractRotation(e.matrixWorld),ji.setFromRotationMatrix(Wi),this.quaternion.premultiply(ji.invert()))}add(e){if(1<arguments.length)for(let e=0;e<arguments.length;e++)this.add(arguments[e]);else e===this?console.error("THREE.Object3D.add: object can't be added as a child of itself.",e):e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),(e.parent=this).children.push(e),e.dispatchEvent(en)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e);return this}remove(e){if(1<arguments.length)for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);else{var t=this.children.indexOf(e);-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(tn))}return this}removeFromParent(){var e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Wi.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Wi.multiply(e.parent.matrixWorld)),e.applyMatrix4(Wi),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(r,i){if(this[r]===i)return this;for(let e=0,t=this.children.length;e<t;e++){var n=this.children[e].getObjectByProperty(r,i);if(void 0!==n)return n}}getObjectsByProperty(r,i){let n=[];this[r]===i&&n.push(this);for(let e=0,t=this.children.length;e<t;e++){var a=this.children[e].getObjectsByProperty(r,i);0<a.length&&(n=n.concat(a))}return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Xi,e,Yi),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Xi,Ki,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);var t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(r){r(this);var i=this.children;for(let e=0,t=i.length;e<t;e++)i[e].traverse(r)}traverseVisible(r){if(!1!==this.visible){r(this);var i=this.children;for(let e=0,t=i.length;e<t;e++)i[e].traverseVisible(r)}}traverseAncestors(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(r){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||r)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),r=!(this.matrixWorldNeedsUpdate=!1));var i=this.children;for(let e=0,t=i.length;e<t;e++){var n=i[e];!0!==n.matrixWorldAutoUpdate&&!0!==r||n.updateMatrixWorld(r)}}updateWorldMatrix(e,t){var r=this.parent;if(!0===e&&null!==r&&!0===r.matrixWorldAutoUpdate&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){var i=this.children;for(let e=0,t=i.length;e<t;e++){var n=i[e];!0===n.matrixWorldAutoUpdate&&n.updateWorldMatrix(!1,!0)}}}toJSON(r){var e,t,i,n,a,s,o=void 0===r||"string"==typeof r,l={},h=(o&&(r={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},l.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"}),{});function c(e,t){return void 0===e[t.uuid]&&(e[t.uuid]=t.toJSON(r)),t.uuid}if(h.uuid=this.uuid,h.type=this.type,""!==this.name&&(h.name=this.name),!0===this.castShadow&&(h.castShadow=!0),!0===this.receiveShadow&&(h.receiveShadow=!0),!1===this.visible&&(h.visible=!1),!1===this.frustumCulled&&(h.frustumCulled=!1),0!==this.renderOrder&&(h.renderOrder=this.renderOrder),0<Object.keys(this.userData).length&&(h.userData=this.userData),h.layers=this.layers.mask,h.matrix=this.matrix.toArray(),h.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(h.matrixAutoUpdate=!1),this.isInstancedMesh&&(h.type="InstancedMesh",h.count=this.count,h.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor)&&(h.instanceColor=this.instanceColor.toJSON()),this.isScene)this.background&&(this.background.isColor?h.background=this.background.toJSON():this.background.isTexture&&(h.background=this.background.toJSON(r).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(h.environment=this.environment.toJSON(r).uuid);else if(this.isMesh||this.isLine||this.isPoints){h.geometry=c(r.geometries,this.geometry);var u=this.geometry.parameters;if(void 0!==u&&void 0!==u.shapes){var d=u.shapes;if(Array.isArray(d))for(let e=0,t=d.length;e<t;e++){var m=d[e];c(r.shapes,m)}else c(r.shapes,d)}}if(this.isSkinnedMesh&&(h.bindMode=this.bindMode,h.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton)&&(c(r.skeletons,this.skeleton),h.skeleton=this.skeleton.uuid),void 0!==this.material)if(Array.isArray(this.material)){var p=[];for(let e=0,t=this.material.length;e<t;e++)p.push(c(r.materials,this.material[e]));h.material=p}else h.material=c(r.materials,this.material);if(0<this.children.length){h.children=[];for(let e=0;e<this.children.length;e++)h.children.push(this.children[e].toJSON(r).object)}if(0<this.animations.length){h.animations=[];for(let e=0;e<this.animations.length;e++){var f=this.animations[e];h.animations.push(c(r.animations,f))}}return o&&(u=g(r.geometries),o=g(r.materials),e=g(r.textures),t=g(r.images),i=g(r.shapes),n=g(r.skeletons),a=g(r.animations),s=g(r.nodes),0<u.length&&(l.geometries=u),0<o.length&&(l.materials=o),0<e.length&&(l.textures=e),0<t.length&&(l.images=t),0<i.length&&(l.shapes=i),0<n.length&&(l.skeletons=n),0<a.length&&(l.animations=a),0<s.length)&&(l.nodes=s),l.object=h,l;function g(e){var t,r=[];for(t in e){var i=e[t];delete i.metadata,r.push(i)}return r}}clone(e){return(new this.constructor).copy(this,e)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){var r=t.children[e];this.add(r.clone())}return this}}rn.DEFAULT_UP=new et(0,1,0),rn.DEFAULT_MATRIX_AUTO_UPDATE=!0,rn.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;let nn=new et,an=new et,sn=new et,on=new et,ln=new et,hn=new et,cn=new et,un=new et,dn=new et,mn=new et,pn=!1;class fn{constructor(e=new et,t=new et,r=new et){this.a=e,this.b=t,this.c=r}static getNormal(e,t,r,i){i.subVectors(r,t),nn.subVectors(e,t),i.cross(nn);r=i.lengthSq();return 0<r?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(e,t,r,i,n){nn.subVectors(i,t),an.subVectors(r,t),sn.subVectors(e,t);var i=nn.dot(nn),r=nn.dot(an),e=nn.dot(sn),t=an.dot(an),a=an.dot(sn),s=i*t-r*r;return 0==s?n.set(-2,-1,-1):n.set(1-(t=(t*e-r*a)*(n=1/s))-(s=(i*a-r*e)*n),s,t)}static containsPoint(e,t,r,i){return this.getBarycoord(e,t,r,i,on),0<=on.x&&0<=on.y&&on.x+on.y<=1}static getUV(e,t,r,i,n,a,s,o){return!1===pn&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),pn=!0),this.getInterpolation(e,t,r,i,n,a,s,o)}static getInterpolation(e,t,r,i,n,a,s,o){return this.getBarycoord(e,t,r,i,on),o.setScalar(0),o.addScaledVector(n,on.x),o.addScaledVector(a,on.y),o.addScaledVector(s,on.z),o}static isFrontFacing(e,t,r,i){return nn.subVectors(r,t),an.subVectors(e,t),nn.cross(an).dot(i)<0}set(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this}setFromPointsAndIndices(e,t,r,i){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,r,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,r),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return nn.subVectors(this.c,this.b),an.subVectors(this.a,this.b),.5*nn.cross(an).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return fn.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return fn.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,r,i,n){return!1===pn&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),pn=!0),fn.getInterpolation(e,this.a,this.b,this.c,t,r,i,n)}getInterpolation(e,t,r,i,n){return fn.getInterpolation(e,this.a,this.b,this.c,t,r,i,n)}containsPoint(e){return fn.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return fn.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){var r=this.a,i=this.b,n=this.c;let a,s;ln.subVectors(i,r),hn.subVectors(n,r),un.subVectors(e,r);var o=ln.dot(un),l=hn.dot(un);if(o<=0&&l<=0)return t.copy(r);dn.subVectors(e,i);var h=ln.dot(dn),c=hn.dot(dn);if(0<=h&&c<=h)return t.copy(i);var u=o*c-h*l;if(u<=0&&0<=o&&h<=0)return a=o/(o-h),t.copy(r).addScaledVector(ln,a);mn.subVectors(e,n);var e=ln.dot(mn),d=hn.dot(mn);return 0<=d&&e<=d?t.copy(n):(o=e*l-o*d)<=0&&0<=l&&d<=0?(s=l/(l-d),t.copy(r).addScaledVector(hn,s)):(l=h*d-e*c)<=0&&0<=c-h&&0<=e-d?(cn.subVectors(n,i),s=(c-h)/(c-h+(e-d)),t.copy(i).addScaledVector(cn,s)):(n=1/(l+o+u),a=o*n,s=u*n,t.copy(r).addScaledVector(ln,a).addScaledVector(hn,s))}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let gn={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},vn={h:0,s:0,l:0},_n={h:0,s:0,l:0};function yn(e,t,r){return r<0&&(r+=1),1<r&&--r,r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}class ze{constructor(e,t,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,r)}set(e,t,r){var i;return void 0===t&&void 0===r?(i=e)&&i.isColor?this.copy(i):"number"==typeof i?this.setHex(i):"string"==typeof i&&this.setStyle(i):this.setRGB(e,t,r),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=er){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,pe.toWorkingColorSpace(this,t),this}setRGB(e,t,r,i=pe.workingColorSpace){return this.r=e,this.g=t,this.b=r,pe.toWorkingColorSpace(this,i),this}setHSL(e,t,r,i=pe.workingColorSpace){var n;return e=(e%(n=1)+n)%n,t=Tr(t,0,1),r=Tr(r,0,1),0===t?this.r=this.g=this.b=r:(this.r=yn(r=2*r-(n=r<=.5?r*(1+t):r+t-r*t),n,e+1/3),this.g=yn(r,n,e),this.b=yn(r,n,e-1/3)),pe.toWorkingColorSpace(this,i),this}setStyle(t,r=er){function i(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}if(s=/^(\w+)\(([^\)]*)\)/.exec(t)){let e;var n=s[1],a=s[2];switch(n){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(e[4]),this.setRGB(Math.min(255,parseInt(e[1],10))/255,Math.min(255,parseInt(e[2],10))/255,Math.min(255,parseInt(e[3],10))/255,r);if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(e[4]),this.setRGB(Math.min(100,parseInt(e[1],10))/100,Math.min(100,parseInt(e[2],10))/100,Math.min(100,parseInt(e[3],10))/100,r);break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(e[4]),this.setHSL(parseFloat(e[1])/360,parseFloat(e[2])/100,parseFloat(e[3])/100,r);break;default:console.warn("THREE.Color: Unknown color model "+t)}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(t)){var n=s[1],s=n.length;if(3===s)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,r);if(6===s)return this.setHex(parseInt(n,16),r);console.warn("THREE.Color: Invalid hex color "+t)}else if(t&&0<t.length)return this.setColorName(t,r);return this}setColorName(e,t=er){var r=gn[e.toLowerCase()];return void 0!==r?this.setHex(r,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Gr(e.r),this.g=Gr(e.g),this.b=Gr(e.b),this}copyLinearToSRGB(e){return this.r=Hr(e.r),this.g=Hr(e.g),this.b=Hr(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=er){return pe.fromWorkingColorSpace(bn.copy(this),e),65536*Math.round(Tr(255*bn.r,0,255))+256*Math.round(Tr(255*bn.g,0,255))+Math.round(Tr(255*bn.b,0,255))}getHexString(e=er){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=pe.workingColorSpace){pe.fromWorkingColorSpace(bn.copy(this),t);var r=bn.r,i=bn.g,n=bn.b,t=Math.max(r,i,n),a=Math.min(r,i,n);let s,o;var l=(a+t)/2;if(a===t)s=0,o=0;else{var h=t-a;switch(o=l<=.5?h/(t+a):h/(2-t-a),t){case r:s=(i-n)/h+(i<n?6:0);break;case i:s=(n-r)/h+2;break;case n:s=(r-i)/h+4}s/=6}return e.h=s,e.s=o,e.l=l,e}getRGB(e,t=pe.workingColorSpace){return pe.fromWorkingColorSpace(bn.copy(this),t),e.r=bn.r,e.g=bn.g,e.b=bn.b,e}getStyle(e=er){pe.fromWorkingColorSpace(bn.copy(this),e);var t=bn.r,r=bn.g,i=bn.b;return e!==er?`color(${e} ${t.toFixed(3)} ${r.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*r)},${Math.round(255*i)})`}offsetHSL(e,t,r){return this.getHSL(vn),this.setHSL(vn.h+e,vn.s+t,vn.l+r)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,r){return this.r=e.r+(t.r-e.r)*r,this.g=e.g+(t.g-e.g)*r,this.b=e.b+(t.b-e.b)*r,this}lerpHSL(e,t){this.getHSL(vn),e.getHSL(_n);var e=Er(vn.h,_n.h,t),r=Er(vn.s,_n.s,t),t=Er(vn.l,_n.l,t);return this.setHSL(e,r,t),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){var t=this.r,r=this.g,i=this.b,e=e.elements;return this.r=e[0]*t+e[3]*r+e[6]*i,this.g=e[1]*t+e[4]*r+e[7]*i,this.b=e[2]*t+e[5]*r+e[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let bn=new ze,xn=(ze.NAMES=gn,0);class Sn extends Sr{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:xn++}),this.uuid=Cr(),this.name="",this.type="Material",this.blending=fe,this.side=Ve,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=_e,this.blendDst=ye,this.blendEquation=ae,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new ze(0,0,0),this.blendAlpha=0,this.depthFunc=De,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=lr,this.stencilZFail=lr,this.stencilZPass=lr,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){0<this._alphaTest!=0<e&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(var t in e){var r,i=e[t];void 0===i?console.warn(`THREE.Material: parameter '${t}' has value of undefined.`):void 0===(r=this[t])?console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`):r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]=i}}toJSON(e){var t=void 0===e||"string"==typeof e,r=(t&&(e={textures:{},images:{}}),{metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}});function i(e){var t,r=[];for(t in e){var i=e[t];delete i.metadata,r.push(i)}return r}return r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),void 0!==this.sheen&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearcoat&&(r.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(r.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(r.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(r.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine)&&(r.combine=this.combine),void 0!==this.envMapIntensity&&(r.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(r.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(r.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(r.size=this.size),null!==this.shadowSide&&(r.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==fe&&(r.blending=this.blending),this.side!==Ve&&(r.side=this.side),!0===this.vertexColors&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=!0),this.blendSrc!==_e&&(r.blendSrc=this.blendSrc),this.blendDst!==ye&&(r.blendDst=this.blendDst),this.blendEquation!==ae&&(r.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(r.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(r.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==De&&(r.depthFunc=this.depthFunc),!1===this.depthTest&&(r.depthTest=this.depthTest),!1===this.depthWrite&&(r.depthWrite=this.depthWrite),!1===this.colorWrite&&(r.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(r.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(r.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(r.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(r.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==lr&&(r.stencilFail=this.stencilFail),this.stencilZFail!==lr&&(r.stencilZFail=this.stencilZFail),this.stencilZPass!==lr&&(r.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(r.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(r.rotation=this.rotation),!0===this.polygonOffset&&(r.polygonOffset=!0),0!==this.polygonOffsetFactor&&(r.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(r.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),0<this.alphaTest&&(r.alphaTest=this.alphaTest),!0===this.alphaHash&&(r.alphaHash=!0),!0===this.alphaToCoverage&&(r.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=!0),!0===this.forceSinglePass&&(r.forceSinglePass=!0),!0===this.wireframe&&(r.wireframe=!0),1<this.wireframeLinewidth&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(r.flatShading=!0),!1===this.visible&&(r.visible=!1),!1===this.toneMapped&&(r.toneMapped=!1),!1===this.fog&&(r.fog=!1),0<Object.keys(this.userData).length&&(r.userData=this.userData),t&&(t=i(e.textures),e=i(e.images),0<t.length&&(r.textures=t),0<e.length)&&(r.images=e),r}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;var t=e.clippingPlanes;let r=null;if(null!==t){var i=t.length;r=new Array(i);for(let e=0;e!==i;++e)r[e]=t[e].clone()}return this.clippingPlanes=r,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class wn extends Sn{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new ze(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=T,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}let An=new et,Mn=new Ue;class Cn{constructor(e,t,r=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=r,this.usage=vr,this.updateRange={offset:0,count:-1},this.gpuType=Qe,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(r,i,n){r*=this.itemSize,n*=i.itemSize;for(let e=0,t=this.itemSize;e<t;e++)this.array[r+e]=i.array[n+e];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(r){if(2===this.itemSize)for(let e=0,t=this.count;e<t;e++)Mn.fromBufferAttribute(this,e),Mn.applyMatrix3(r),this.setXY(e,Mn.x,Mn.y);else if(3===this.itemSize)for(let e=0,t=this.count;e<t;e++)An.fromBufferAttribute(this,e),An.applyMatrix3(r),this.setXYZ(e,An.x,An.y,An.z);return this}applyMatrix4(r){for(let e=0,t=this.count;e<t;e++)An.fromBufferAttribute(this,e),An.applyMatrix4(r),this.setXYZ(e,An.x,An.y,An.z);return this}applyNormalMatrix(r){for(let e=0,t=this.count;e<t;e++)An.fromBufferAttribute(this,e),An.applyNormalMatrix(r),this.setXYZ(e,An.x,An.y,An.z);return this}transformDirection(r){for(let e=0,t=this.count;e<t;e++)An.fromBufferAttribute(this,e),An.transformDirection(r),this.setXYZ(e,An.x,An.y,An.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let r=this.array[e*this.itemSize+t];return r=this.normalized?Rr(r,this.array):r}setComponent(e,t,r){return this.normalized&&(r=Dr(r,this.array)),this.array[e*this.itemSize+t]=r,this}getX(e){let t=this.array[e*this.itemSize];return t=this.normalized?Rr(t,this.array):t}setX(e,t){return this.normalized&&(t=Dr(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return t=this.normalized?Rr(t,this.array):t}setY(e,t){return this.normalized&&(t=Dr(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return t=this.normalized?Rr(t,this.array):t}setZ(e,t){return this.normalized&&(t=Dr(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return t=this.normalized?Rr(t,this.array):t}setW(e,t){return this.normalized&&(t=Dr(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,r){return e*=this.itemSize,this.normalized&&(t=Dr(t,this.array),r=Dr(r,this.array)),this.array[e+0]=t,this.array[e+1]=r,this}setXYZ(e,t,r,i){return e*=this.itemSize,this.normalized&&(t=Dr(t,this.array),r=Dr(r,this.array),i=Dr(i,this.array)),this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this}setXYZW(e,t,r,i,n){return e*=this.itemSize,this.normalized&&(t=Dr(t,this.array),r=Dr(r,this.array),i=Dr(i,this.array),n=Dr(n,this.array)),this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this.array[e+3]=n,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){var e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==vr&&(e.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(e.updateRange=this.updateRange),e}}class Tn extends Cn{constructor(e,t,r){super(new Uint16Array(e),t,r)}}class En extends Cn{constructor(e,t,r){super(new Uint32Array(e),t,r)}}class Pn extends Cn{constructor(e,t,r){super(new Float32Array(e),t,r)}}let In=0,Rn=new tt,Dn=new rn,Ln=new et,On=new ai,kn=new ai,Nn=new et;class Fn extends Sr{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:In++}),this.uuid=Cr(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Or(e)?En:Tn)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,r=0){this.groups.push({start:e,count:t,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){var t=this.attributes.position,t=(void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0),this.attributes.normal),r=(void 0!==t&&(r=(new v).getNormalMatrix(e),t.applyNormalMatrix(r),t.needsUpdate=!0),this.attributes.tangent);return void 0!==r&&(r.transformDirection(e),r.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Rn.makeRotationFromQuaternion(e),this.applyMatrix4(Rn),this}rotateX(e){return Rn.makeRotationX(e),this.applyMatrix4(Rn),this}rotateY(e){return Rn.makeRotationY(e),this.applyMatrix4(Rn),this}rotateZ(e){return Rn.makeRotationZ(e),this.applyMatrix4(Rn),this}translate(e,t,r){return Rn.makeTranslation(e,t,r),this.applyMatrix4(Rn),this}scale(e,t,r){return Rn.makeScale(e,t,r),this.applyMatrix4(Rn),this}lookAt(e){return Dn.lookAt(e),Dn.updateMatrix(),this.applyMatrix4(Dn.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ln).negate(),this.translate(Ln.x,Ln.y,Ln.z),this}setFromPoints(r){var i=[];for(let e=0,t=r.length;e<t;e++){var n=r[e];i.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new Pn(i,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new ai);var e=this.attributes.position,r=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingBox.set(new et(-1/0,-1/0,-1/0),new et(1/0,1/0,1/0));else{if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),r)for(let e=0,t=r.length;e<t;e++){var i=r[e];On.setFromBufferAttribute(i),this.morphTargetsRelative?(Nn.addVectors(this.boundingBox.min,On.min),this.boundingBox.expandByPoint(Nn),Nn.addVectors(this.boundingBox.max,On.max),this.boundingBox.expandByPoint(Nn)):(this.boundingBox.expandByPoint(On.min),this.boundingBox.expandByPoint(On.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new wi);var i=this.attributes.position,n=this.morphAttributes.position;if(i&&i.isGLBufferAttribute)console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingSphere.set(new et,1/0);else if(i){var a=this.boundingSphere.center;if(On.setFromBufferAttribute(i),n)for(let e=0,t=n.length;e<t;e++){var s=n[e];kn.setFromBufferAttribute(s),this.morphTargetsRelative?(Nn.addVectors(On.min,kn.min),On.expandByPoint(Nn),Nn.addVectors(On.max,kn.max),On.expandByPoint(Nn)):(On.expandByPoint(kn.min),On.expandByPoint(kn.max))}On.getCenter(a);let r=0;for(let e=0,t=i.count;e<t;e++)Nn.fromBufferAttribute(i,e),r=Math.max(r,a.distanceToSquared(Nn));if(n)for(let e=0,t=n.length;e<t;e++){var o=n[e],l=this.morphTargetsRelative;for(let e=0,t=o.count;e<t;e++)Nn.fromBufferAttribute(o,e),l&&(Ln.fromBufferAttribute(i,e),Nn.add(Ln)),r=Math.max(r,a.distanceToSquared(Nn))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){var e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");else{var x=e.array;let r=t.position.array,i=t.normal.array,n=t.uv.array;var S,w,A,M,C=r.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Cn(new Float32Array(4*C),4));let a=this.getAttribute("tangent").array,s=[],o=[];for(let e=0;e<C;e++)s[e]=new et,o[e]=new et;let l=new et,h=new et,c=new et,u=new Ue,d=new Ue,m=new Ue,p=new et,f=new et,g=this.groups;for(let e=0,t=(g=0===g.length?[{start:0,count:x.length}]:g).length;e<t;++e){var T=g[e],E=T.start;for(let e=E,t=E+T.count;e<t;e+=3)S=x[e+0],w=x[e+1],A=x[e+2],M=void 0,l.fromArray(r,3*S),h.fromArray(r,3*w),c.fromArray(r,3*A),u.fromArray(n,2*S),d.fromArray(n,2*w),m.fromArray(n,2*A),h.sub(l),c.sub(l),d.sub(u),m.sub(u),M=1/(d.x*m.y-m.x*d.y),isFinite(M)&&(p.copy(h).multiplyScalar(m.y).addScaledVector(c,-d.y).multiplyScalar(M),f.copy(c).multiplyScalar(d.x).addScaledVector(h,-m.x).multiplyScalar(M),s[S].add(p),s[w].add(p),s[A].add(p),o[S].add(f),o[w].add(f),o[A].add(f))}let v=new et,_=new et,y=new et,b=new et;for(let e=0,t=g.length;e<t;++e){var P=g[e],I=P.start;for(let e=I,t=I+P.count;e<t;e+=3)R(x[e+0]),R(x[e+1]),R(x[e+2])}function R(e){y.fromArray(i,3*e),b.copy(y);var t=s[e],t=(v.copy(t),v.sub(y.multiplyScalar(y.dot(t))).normalize(),_.crossVectors(b,t),_.dot(o[e])),t=t<0?-1:1;a[4*e]=v.x,a[4*e+1]=v.y,a[4*e+2]=v.z,a[4*e+3]=t}}}computeVertexNormals(){var i=this.index,n=this.getAttribute("position");if(void 0!==n){let r=this.getAttribute("normal");if(void 0===r)r=new Cn(new Float32Array(3*n.count),3),this.setAttribute("normal",r);else for(let e=0,t=r.count;e<t;e++)r.setXYZ(e,0,0,0);var a=new et,s=new et,o=new et,l=new et,h=new et,c=new et,u=new et,d=new et;if(i)for(let e=0,t=i.count;e<t;e+=3){var m=i.getX(e+0),p=i.getX(e+1),f=i.getX(e+2);a.fromBufferAttribute(n,m),s.fromBufferAttribute(n,p),o.fromBufferAttribute(n,f),u.subVectors(o,s),d.subVectors(a,s),u.cross(d),l.fromBufferAttribute(r,m),h.fromBufferAttribute(r,p),c.fromBufferAttribute(r,f),l.add(u),h.add(u),c.add(u),r.setXYZ(m,l.x,l.y,l.z),r.setXYZ(p,h.x,h.y,h.z),r.setXYZ(f,c.x,c.y,c.z)}else for(let e=0,t=n.count;e<t;e+=3)a.fromBufferAttribute(n,e+0),s.fromBufferAttribute(n,e+1),o.fromBufferAttribute(n,e+2),u.subVectors(o,s),d.subVectors(a,s),u.cross(d),r.setXYZ(e+0,u.x,u.y,u.z),r.setXYZ(e+1,u.x,u.y,u.z),r.setXYZ(e+2,u.x,u.y,u.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){var r=this.attributes.normal;for(let e=0,t=r.count;e<t;e++)Nn.fromBufferAttribute(r,e),Nn.normalize(),r.setXYZ(e,Nn.x,Nn.y,Nn.z)}toNonIndexed(){function r(r,i){var n=r.array,a=r.itemSize,e=r.normalized,s=new n.constructor(i.length*a);let o=0,l=0;for(let e=0,t=i.length;e<t;e++){o=r.isInterleavedBufferAttribute?i[e]*r.data.stride+r.offset:i[e]*a;for(let e=0;e<a;e++)s[l++]=n[o++]}return new Cn(s,a,e)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;var e,i=new Fn,n=this.index.array,t=this.attributes;for(e in t){var a=r(t[e],n);i.setAttribute(e,a)}var s,o=this.morphAttributes;for(s in o){var l=[],h=o[s];for(let e=0,t=h.length;e<t;e++){var c=r(h[e],n);l.push(c)}i.morphAttributes[s]=l}i.morphTargetsRelative=this.morphTargetsRelative;var u=this.groups;for(let e=0,t=u.length;e<t;e++){var d=u[e];i.addGroup(d.start,d.count,d.materialIndex)}return i}toJSON(){var r={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),0<Object.keys(this.userData).length&&(r.userData=this.userData),void 0!==this.parameters){var e,t=this.parameters;for(e in t)void 0!==t[e]&&(r[e]=t[e])}else{r.data={attributes:{}};var i,n=this.index,a=(null!==n&&(r.data.index={type:n.array.constructor.name,array:Array.prototype.slice.call(n.array)}),this.attributes);for(i in a){var s=a[i];r.data.attributes[i]=s.toJSON(r.data)}var o,l={};let e=!1;for(o in this.morphAttributes){var h=this.morphAttributes[o],c=[];for(let e=0,t=h.length;e<t;e++){var u=h[e];c.push(u.toJSON(r.data))}0<c.length&&(l[o]=c,e=!0)}e&&(r.data.morphAttributes=l,r.data.morphTargetsRelative=this.morphTargetsRelative);n=this.groups,n=(0<n.length&&(r.data.groups=JSON.parse(JSON.stringify(n))),this.boundingSphere);null!==n&&(r.data.boundingSphere={center:n.center.toArray(),radius:n.radius})}return r}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;var t,r={},i=(this.name=e.name,e.index),n=(null!==i&&this.setIndex(i.clone(r)),e.attributes);for(t in n){var a=n[t];this.setAttribute(t,a.clone(r))}var s,o=e.morphAttributes;for(s in o){var l=[],h=o[s];for(let e=0,t=h.length;e<t;e++)l.push(h[e].clone(r));this.morphAttributes[s]=l}this.morphTargetsRelative=e.morphTargetsRelative;var c=e.groups;for(let e=0,t=c.length;e<t;e++){var u=c[e];this.addGroup(u.start,u.count,u.materialIndex)}i=e.boundingBox,null!==i&&(this.boundingBox=i.clone()),i=e.boundingSphere;return null!==i&&(this.boundingSphere=i.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}let Bn=new tt,Un=new Ri,zn=new wi,Vn=new et,Gn=new et,Hn=new et,$n=new et,jn=new et,Wn=new et,qn=new Ue,Xn=new Ue,Yn=new Ue,Kn=new et,Zn=new et,Qn=new et,Jn=new et,ea=new et;class ta extends rn{constructor(e=new Fn,t=new wn){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){var e=this.geometry.morphAttributes,t=Object.keys(e);if(0<t.length){var r=e[t[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=r.length;e<t;e++){var i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}getVertexPosition(r,i){var e=this.geometry,t=e.attributes.position,n=e.morphAttributes.position,a=e.morphTargetsRelative,s=(i.fromBufferAttribute(t,r),this.morphTargetInfluences);if(n&&s){Wn.set(0,0,0);for(let e=0,t=n.length;e<t;e++){var o=s[e],l=n[e];0!==o&&(jn.fromBufferAttribute(l,r),a?Wn.addScaledVector(jn,o):Wn.addScaledVector(jn.sub(i),o))}i.add(Wn)}return i}raycast(e,t){var r=this.geometry,i=this.material,n=this.matrixWorld;if(void 0!==i){if(null===r.boundingSphere&&r.computeBoundingSphere(),zn.copy(r.boundingSphere),zn.applyMatrix4(n),Un.copy(e.ray).recast(e.near),!1===zn.containsPoint(Un.origin)){if(null===Un.intersectSphere(zn,Vn))return;if(Un.origin.distanceToSquared(Vn)>(e.far-e.near)**2)return}Bn.copy(n).invert(),Un.copy(e.ray).applyMatrix4(Bn),null!==r.boundingBox&&!1===Un.intersectsBox(r.boundingBox)||this._computeIntersections(e,t,Un)}}_computeIntersections(r,i,n){let a;var e=this.geometry,s=this.material,o=e.index,l=e.attributes.position,h=e.attributes.uv,c=e.attributes.uv1,u=e.attributes.normal,d=e.groups,m=e.drawRange;if(null!==o)if(Array.isArray(s))for(let e=0,t=d.length;e<t;e++){var p=d[e],f=s[p.materialIndex];for(let e=Math.max(p.start,m.start),t=Math.min(o.count,Math.min(p.start+p.count,m.start+m.count));e<t;e+=3){var g=o.getX(e),v=o.getX(e+1),_=o.getX(e+2);(a=ra(this,f,r,n,h,c,u,g,v,_))&&(a.faceIndex=Math.floor(e/3),a.face.materialIndex=p.materialIndex,i.push(a))}}else for(let e=Math.max(0,m.start),t=Math.min(o.count,m.start+m.count);e<t;e+=3){var y=o.getX(e),b=o.getX(e+1),x=o.getX(e+2);(a=ra(this,s,r,n,h,c,u,y,b,x))&&(a.faceIndex=Math.floor(e/3),i.push(a))}else if(void 0!==l)if(Array.isArray(s))for(let e=0,t=d.length;e<t;e++){var S=d[e],w=s[S.materialIndex];for(let e=Math.max(S.start,m.start),t=Math.min(l.count,Math.min(S.start+S.count,m.start+m.count));e<t;e+=3){var A=e,M=e+1,C=e+2;(a=ra(this,w,r,n,h,c,u,A,M,C))&&(a.faceIndex=Math.floor(e/3),a.face.materialIndex=S.materialIndex,i.push(a))}}else for(let e=Math.max(0,m.start),t=Math.min(l.count,m.start+m.count);e<t;e+=3){var T=e,E=e+1,P=e+2;(a=ra(this,s,r,n,h,c,u,T,E,P))&&(a.faceIndex=Math.floor(e/3),i.push(a))}}}function ra(e,t,r,i,n,a,s,o,l,h){e.getVertexPosition(o,Gn),e.getVertexPosition(l,Hn),e.getVertexPosition(h,$n);e=((e,t,r,i,n,a,s,o)=>{let l;return null===(l=t.side===Ge?i.intersectTriangle(s,a,n,!0,o):i.intersectTriangle(n,a,s,t.side===Ve,o))||(ea.copy(o),ea.applyMatrix4(e.matrixWorld),(i=r.ray.origin.distanceTo(ea))<r.near)||i>r.far?null:{distance:i,point:ea.clone(),object:e}})(e,t,r,i,Gn,Hn,$n,Jn);return e&&(n&&(qn.fromBufferAttribute(n,o),Xn.fromBufferAttribute(n,l),Yn.fromBufferAttribute(n,h),e.uv=fn.getInterpolation(Jn,Gn,Hn,$n,qn,Xn,Yn,new Ue)),a&&(qn.fromBufferAttribute(a,o),Xn.fromBufferAttribute(a,l),Yn.fromBufferAttribute(a,h),e.uv1=fn.getInterpolation(Jn,Gn,Hn,$n,qn,Xn,Yn,new Ue),e.uv2=e.uv1),s&&(Kn.fromBufferAttribute(s,o),Zn.fromBufferAttribute(s,l),Qn.fromBufferAttribute(s,h),e.normal=fn.getInterpolation(Jn,Gn,Hn,$n,Kn,Zn,Qn,new et),0<e.normal.dot(i.direction))&&e.normal.multiplyScalar(-1),t={a:o,b:l,c:h,normal:new et,materialIndex:0},fn.getNormal(Gn,Hn,$n,t.normal),e.face=t),e}class ia extends Fn{constructor(e=1,t=1,r=1,i=1,n=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:i,heightSegments:n,depthSegments:a};let T=this,E=(i=Math.floor(i),n=Math.floor(n),a=Math.floor(a),[]),P=[],I=[],R=[],D=0,L=0;function s(r,i,n,a,s,e,t,o,l,h,c){var u=e/l,d=t/h,m=e/2,p=t/2,f=o/2,g=l+1,v=h+1;let _=0,y=0;var b=new et;for(let t=0;t<v;t++){var x=t*d-p;for(let e=0;e<g;e++){var S=e*u-m;b[r]=S*a,b[i]=x*s,b[n]=f,P.push(b.x,b.y,b.z),b[r]=0,b[i]=0,b[n]=0<o?1:-1,I.push(b.x,b.y,b.z),R.push(e/l),R.push(1-t/h),_+=1}}for(let t=0;t<h;t++)for(let e=0;e<l;e++){var w=D+e+g*t,A=D+e+g*(t+1),M=D+(e+1)+g*(t+1),C=D+(e+1)+g*t;E.push(w,A,C),E.push(A,M,C),y+=6}T.addGroup(L,y,c),L+=y,D+=_}s("z","y","x",-1,-1,r,t,e,a,n,0),s("z","y","x",1,-1,r,t,-e,a,n,1),s("x","z","y",1,1,e,r,t,i,a,2),s("x","z","y",1,-1,e,r,-t,i,a,3),s("x","y","z",1,-1,e,t,r,i,n,4),s("x","y","z",-1,-1,e,t,-r,i,n,5),this.setIndex(E),this.setAttribute("position",new Pn(P,3)),this.setAttribute("normal",new Pn(I,3)),this.setAttribute("uv",new Pn(R,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ia(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function na(e){var t,r={};for(t in e)for(var i in r[t]={},e[t]){var n=e[t][i];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture||n.isQuaternion)?n.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),r[t][i]=null):r[t][i]=n.clone():Array.isArray(n)?r[t][i]=n.slice():r[t][i]=n}return r}function aa(t){var r={};for(let e=0;e<t.length;e++){var i,n=na(t[e]);for(i in n)r[i]=n[i]}return r}function sa(e){return null===e.getRenderTarget()?e.outputColorSpace:pe.workingColorSpace}let oa={clone:na,merge:aa};class la extends Sn{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=na(e.uniforms),this.uniformsGroups=(t=>{var r=[];for(let e=0;e<t.length;e++)r.push(t[e].clone());return r})(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){var t,r=super.toJSON(e);for(t in r.glslVersion=this.glslVersion,r.uniforms={},this.uniforms){var i=this.uniforms[t].value;i&&i.isTexture?r.uniforms[t]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?r.uniforms[t]={type:"c",value:i.getHex()}:i&&i.isVector2?r.uniforms[t]={type:"v2",value:i.toArray()}:i&&i.isVector3?r.uniforms[t]={type:"v3",value:i.toArray()}:i&&i.isVector4?r.uniforms[t]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?r.uniforms[t]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?r.uniforms[t]={type:"m4",value:i.toArray()}:r.uniforms[t]={value:i}}0<Object.keys(this.defines).length&&(r.defines=this.defines),r.vertexShader=this.vertexShader,r.fragmentShader=this.fragmentShader,r.lights=this.lights,r.clipping=this.clipping;var n,a={};for(n in this.extensions)!0===this.extensions[n]&&(a[n]=!0);return 0<Object.keys(a).length&&(r.extensions=a),r}}class ha extends rn{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new tt,this.projectionMatrix=new tt,this.projectionMatrixInverse=new tt,this.coordinateSystem=xr}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class ca extends ha{constructor(e=50,t=1,r=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=r,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){e=.5*this.getFilmHeight()/e;this.fov=2*Mr*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){var e=Math.tan(.5*Ar*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*Mr*Math.atan(Math.tan(.5*Ar*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,r,i,n,a){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){var e=this.near;let t=e*Math.tan(.5*Ar*this.fov)/this.zoom,r=2*t,i=this.aspect*r,n=-.5*i;var a,s=this.view,o=(null!==this.view&&this.view.enabled&&(o=s.fullWidth,a=s.fullHeight,n+=s.offsetX*i/o,t-=s.offsetY*r/a,i*=s.width/o,r*=s.height/a),this.filmOffset);0!==o&&(n+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+i,t,t-r,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){e=super.toJSON(e);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}class ua extends rn{constructor(e,t,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;r=new ca(-90,1,e,t),r.layers=this.layers,this.add(r),r=new ca(-90,1,e,t),r.layers=this.layers,this.add(r),r=new ca(-90,1,e,t),r.layers=this.layers,this.add(r),r=new ca(-90,1,e,t),r.layers=this.layers,this.add(r),r=new ca(-90,1,e,t),r.layers=this.layers,this.add(r),r=new ca(-90,1,e,t);r.layers=this.layers,this.add(r)}updateCoordinateSystem(){var e,t,r=this.coordinateSystem,i=this.children.concat(),[n,a,s,o,l,h]=i;for(e of i)this.remove(e);if(r===xr)n.up.set(0,1,0),n.lookAt(1,0,0),a.up.set(0,1,0),a.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),o.up.set(0,0,1),o.lookAt(0,-1,0),l.up.set(0,1,0),l.lookAt(0,0,1),h.up.set(0,1,0);else{if(2001!==r)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+r);n.up.set(0,-1,0),n.lookAt(-1,0,0),a.up.set(0,-1,0),a.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),o.up.set(0,0,-1),o.lookAt(0,-1,0),l.up.set(0,-1,0),l.lookAt(0,0,1),h.up.set(0,-1,0)}h.lookAt(0,0,-1);for(t of i)this.add(t),t.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();var{renderTarget:r,activeMipmapLevel:i}=this,[n,a,s,o,l,h]=(this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem()),this.children),c=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),m=e.xr.enabled,p=(e.xr.enabled=!1,r.texture.generateMipmaps);r.texture.generateMipmaps=!1,e.setRenderTarget(r,0,i),e.render(t,n),e.setRenderTarget(r,1,i),e.render(t,a),e.setRenderTarget(r,2,i),e.render(t,s),e.setRenderTarget(r,3,i),e.render(t,o),e.setRenderTarget(r,4,i),e.render(t,l),r.texture.generateMipmaps=p,e.setRenderTarget(r,5,i),e.render(t,h),e.setRenderTarget(c,u,d),e.xr.enabled=m,r.texture.needsPMREMUpdate=!0}}class da extends Kr{constructor(e,t,r,i,n,a,s,o,l,h){super(e=void 0!==e?e:[],t=void 0!==t?t:U,r,i,n,a,s,o,l,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class ma extends Jr{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;e={width:e,height:e,depth:1},e=[e,e,e,e,e,e];void 0!==t.encoding&&(Fr("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),t.colorSpace=t.encoding===Yt?er:Jt),this.texture=new da(e,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:je}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;var r={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},i=new ia(5,5,5),r=new la({name:"CubemapFromEquirect",uniforms:na(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:Ge,blending:ee}),i=(r.uniforms.tEquirect.value=t,new ta(i,r)),r=t.minFilter;return t.minFilter===qe&&(t.minFilter=je),new ua(1,10,this).update(e,i),t.minFilter=r,i.geometry.dispose(),i.material.dispose(),this}clear(t,r,i,n){var e=t.getRenderTarget();for(let e=0;e<6;e++)t.setRenderTarget(this,e),t.clear(r,i,n);t.setRenderTarget(e)}}let pa=new et,fa=new et,ga=new v;class va{constructor(e=new et(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,r,i){return this.normal.set(e,t,r),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,r){r=pa.subVectors(r,t).cross(fa.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){var r=e.delta(pa),i=this.normal.dot(r);return 0===i?0===this.distanceToPoint(e.start)?t.copy(e.start):null:(i=-(e.start.dot(this.normal)+this.constant)/i)<0||1<i?null:t.copy(e.start).addScaledVector(r,i)}intersectsLine(e){var t=this.distanceToPoint(e.start),e=this.distanceToPoint(e.end);return t<0&&0<e||e<0&&0<t}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){t=t||ga.getNormalMatrix(e),e=this.coplanarPoint(pa).applyMatrix4(e),t=this.normal.applyMatrix3(t).normalize();return this.constant=-e.dot(t),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}let _a=new wi,ya=new et;class ba{constructor(e=new va,t=new va,r=new va,i=new va,n=new va,a=new va){this.planes=[e,t,r,i,n,a]}set(e,t,r,i,n,a){var s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(r),s[3].copy(i),s[4].copy(n),s[5].copy(a),this}copy(t){var r=this.planes;for(let e=0;e<6;e++)r[e].copy(t.planes[e]);return this}setFromProjectionMatrix(e,t=xr){var r=this.planes,e=e.elements,i=e[0],n=e[1],a=e[2],s=e[3],o=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],m=e[10],p=e[11],f=e[12],g=e[13],v=e[14],e=e[15];if(r[0].setComponents(s-i,c-o,p-u,e-f).normalize(),r[1].setComponents(s+i,c+o,p+u,e+f).normalize(),r[2].setComponents(s+n,c+l,p+d,e+g).normalize(),r[3].setComponents(s-n,c-l,p-d,e-g).normalize(),r[4].setComponents(s-a,c-h,p-m,e-v).normalize(),t===xr)r[5].setComponents(s+a,c+h,p+m,e+v).normalize();else{if(2001!==t)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);r[5].setComponents(a,h,m,v).normalize()}return this}intersectsObject(e){var t;return(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),_a.copy(e.boundingSphere)):(null===(t=e.geometry).boundingSphere&&t.computeBoundingSphere(),_a.copy(t.boundingSphere))).applyMatrix4(e.matrixWorld),this.intersectsSphere(_a)}intersectsSprite(e){return _a.center.set(0,0,0),_a.radius=.7071067811865476,_a.applyMatrix4(e.matrixWorld),this.intersectsSphere(_a)}intersectsSphere(e){var t=this.planes,r=e.center,i=-e.radius;for(let e=0;e<6;e++)if(t[e].distanceToPoint(r)<i)return!1;return!0}intersectsBox(t){var r=this.planes;for(let e=0;e<6;e++){var i=r[e];if(ya.x=(0<i.normal.x?t.max:t.min).x,ya.y=(0<i.normal.y?t.max:t.min).y,ya.z=(0<i.normal.z?t.max:t.min).z,i.distanceToPoint(ya)<0)return!1}return!0}containsPoint(t){var r=this.planes;for(let e=0;e<6;e++)if(r[e].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function xa(){let r=null,e=!1,i=null,n=null;function a(e,t){i(e,t),n=r.requestAnimationFrame(a)}return{start:function(){!0!==e&&null!==i&&(n=r.requestAnimationFrame(a),e=!0)},stop:function(){r.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(e){i=e},setContext:function(e){r=e}}}function Sa(o,e){let l=e.isWebGL2,h=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),h.get(e)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);var t=h.get(e);t&&(o.deleteBuffer(t.buffer),h.delete(e))},update:function(e,t){var r,i,n,a,s;e.isGLBufferAttribute?(!(r=h.get(e))||r.version<e.version)&&h.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}):(e.isInterleavedBufferAttribute&&(e=e.data),void 0===(r=h.get(e))?h.set(e,((e,t)=>{var r=e.array,i=e.usage,n=o.createBuffer();o.bindBuffer(t,n),o.bufferData(t,r,i),e.onUploadCallback();let a;if(r instanceof Float32Array)a=o.FLOAT;else if(r instanceof Uint16Array)if(e.isFloat16BufferAttribute){if(!l)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");a=o.HALF_FLOAT}else a=o.UNSIGNED_SHORT;else if(r instanceof Int16Array)a=o.SHORT;else if(r instanceof Uint32Array)a=o.UNSIGNED_INT;else if(r instanceof Int32Array)a=o.INT;else if(r instanceof Int8Array)a=o.BYTE;else{if(!(r instanceof Uint8Array||r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);a=o.UNSIGNED_BYTE}return{buffer:n,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}})(e,t)):r.version<e.version&&(i=r.buffer,t=t,a=(n=e).array,s=n.updateRange,o.bindBuffer(t,i),-1===s.count?o.bufferSubData(t,0,a):(l?o.bufferSubData(t,s.offset*a.BYTES_PER_ELEMENT,a,s.offset,s.count):o.bufferSubData(t,s.offset*a.BYTES_PER_ELEMENT,a.subarray(s.offset,s.offset+s.count)),s.count=-1),n.onUploadCallback(),r.version=e.version))}}}class wa extends Fn{constructor(e=1,t=1,r=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:i};var n=e/2,a=t/2,s=Math.floor(r),o=Math.floor(i),l=s+1,h=o+1,c=e/s,u=t/o,d=[],m=[],p=[],f=[];for(let t=0;t<h;t++){var g=t*u-a;for(let e=0;e<l;e++){var v=e*c-n;m.push(v,-g,0),p.push(0,0,1),f.push(e/s),f.push(1-t/o)}}for(let t=0;t<o;t++)for(let e=0;e<s;e++){var _=e+l*t,y=e+l*(t+1),b=e+1+l*(t+1),x=e+1+l*t;d.push(_,y,x),d.push(y,b,x)}this.setIndex(d),this.setAttribute("position",new Pn(m,3)),this.setAttribute("normal",new Pn(p,3)),this.setAttribute("uv",new Pn(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new wa(e.width,e.height,e.widthSegments,e.heightSegments)}}let M={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\tif ( diffuseColor.a < alphaTest ) discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_v0 0.339\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_v1 0.276\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_v4 0.046\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_v5 0.016\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_v6 0.0038\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tanisotropyV /= material.anisotropy;\n\tmaterial.anisotropy = saturate( material.anisotropy );\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x - tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x + tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tuniform int boneTextureSize;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tfloat j = i * 4.0;\n\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\ty = dy * ( y + 0.5 );\n\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\treturn bone;\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},R={common:{diffuse:{value:new ze(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new v},alphaMap:{value:null},alphaMapTransform:{value:new v},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new v}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new v}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new v}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new v},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new v},normalScale:{value:new Ue(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new v},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new v}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new v}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new v}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ze(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new ze(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new v},alphaTest:{value:0},uvTransform:{value:new v}},sprite:{diffuse:{value:new ze(16777215)},opacity:{value:1},center:{value:new Ue(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new v},alphaMap:{value:null},alphaMapTransform:{value:new v},alphaTest:{value:0}}},Aa={basic:{uniforms:aa([R.common,R.specularmap,R.envmap,R.aomap,R.lightmap,R.fog]),vertexShader:M.meshbasic_vert,fragmentShader:M.meshbasic_frag},lambert:{uniforms:aa([R.common,R.specularmap,R.envmap,R.aomap,R.lightmap,R.emissivemap,R.bumpmap,R.normalmap,R.displacementmap,R.fog,R.lights,{emissive:{value:new ze(0)}}]),vertexShader:M.meshlambert_vert,fragmentShader:M.meshlambert_frag},phong:{uniforms:aa([R.common,R.specularmap,R.envmap,R.aomap,R.lightmap,R.emissivemap,R.bumpmap,R.normalmap,R.displacementmap,R.fog,R.lights,{emissive:{value:new ze(0)},specular:{value:new ze(1118481)},shininess:{value:30}}]),vertexShader:M.meshphong_vert,fragmentShader:M.meshphong_frag},standard:{uniforms:aa([R.common,R.envmap,R.aomap,R.lightmap,R.emissivemap,R.bumpmap,R.normalmap,R.displacementmap,R.roughnessmap,R.metalnessmap,R.fog,R.lights,{emissive:{value:new ze(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:M.meshphysical_vert,fragmentShader:M.meshphysical_frag},toon:{uniforms:aa([R.common,R.aomap,R.lightmap,R.emissivemap,R.bumpmap,R.normalmap,R.displacementmap,R.gradientmap,R.fog,R.lights,{emissive:{value:new ze(0)}}]),vertexShader:M.meshtoon_vert,fragmentShader:M.meshtoon_frag},matcap:{uniforms:aa([R.common,R.bumpmap,R.normalmap,R.displacementmap,R.fog,{matcap:{value:null}}]),vertexShader:M.meshmatcap_vert,fragmentShader:M.meshmatcap_frag},points:{uniforms:aa([R.points,R.fog]),vertexShader:M.points_vert,fragmentShader:M.points_frag},dashed:{uniforms:aa([R.common,R.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:M.linedashed_vert,fragmentShader:M.linedashed_frag},depth:{uniforms:aa([R.common,R.displacementmap]),vertexShader:M.depth_vert,fragmentShader:M.depth_frag},normal:{uniforms:aa([R.common,R.bumpmap,R.normalmap,R.displacementmap,{opacity:{value:1}}]),vertexShader:M.meshnormal_vert,fragmentShader:M.meshnormal_frag},sprite:{uniforms:aa([R.sprite,R.fog]),vertexShader:M.sprite_vert,fragmentShader:M.sprite_frag},background:{uniforms:{uvTransform:{value:new v},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:M.background_vert,fragmentShader:M.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:M.backgroundCube_vert,fragmentShader:M.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:M.cube_vert,fragmentShader:M.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:M.equirect_vert,fragmentShader:M.equirect_frag},distanceRGBA:{uniforms:aa([R.common,R.displacementmap,{referencePosition:{value:new et},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:M.distanceRGBA_vert,fragmentShader:M.distanceRGBA_frag},shadow:{uniforms:aa([R.lights,R.fog,{color:{value:new ze(0)},opacity:{value:1}}]),vertexShader:M.shadow_vert,fragmentShader:M.shadow_frag}},Ma=(Aa.physical={uniforms:aa([Aa.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new v},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new v},clearcoatNormalScale:{value:new Ue(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new v},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new v},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new v},sheen:{value:0},sheenColor:{value:new ze(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new v},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new v},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new v},transmissionSamplerSize:{value:new Ue},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new v},attenuationDistance:{value:0},attenuationColor:{value:new ze(0)},specularColor:{value:new ze(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new v},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new v},anisotropyVector:{value:new Ue},anisotropyMap:{value:null},anisotropyMapTransform:{value:new v}}]),vertexShader:M.meshphysical_vert,fragmentShader:M.meshphysical_frag},{r:0,b:0,g:0});function Ca(a,s,o,l,h,e,c){let u=new ze(0),d=!0===e?0:1,m,p,f=null,g=0,v=null;function _(e,t){e.getRGB(Ma,sa(a)),l.buffers.color.setClear(Ma.r,Ma.g,Ma.b,t,c)}return{getClearColor:function(){return u},setClearColor:function(e,t=1){u.set(e),d=t,_(u,d)},getClearAlpha:function(){return d},setClearAlpha:function(e){d=e,_(u,d)},render:function(e,t){let r=!1,i=!0===t.isScene?t.background:null;i&&i.isTexture&&(n=0<t.backgroundBlurriness,i=(n?o:s).get(i)),null===i?_(u,d):i&&i.isColor&&(_(i,1),r=!0);var n=a.xr.getEnvironmentBlendMode();"additive"===n?l.buffers.color.setClear(0,0,0,1,c):"alpha-blend"===n&&l.buffers.color.setClear(0,0,0,0,c),(a.autoClear||r)&&a.clear(a.autoClearColor,a.autoClearDepth,a.autoClearStencil),i&&(i.isCubeTexture||i.mapping===Fe)?(void 0===p&&((p=new ta(new ia(1,1,1),new la({name:"BackgroundCubeMaterial",uniforms:na(Aa.backgroundCube.uniforms),vertexShader:Aa.backgroundCube.vertexShader,fragmentShader:Aa.backgroundCube.fragmentShader,side:Ge,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.deleteAttribute("normal"),p.geometry.deleteAttribute("uv"),p.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},Object.defineProperty(p.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),h.update(p)),p.material.uniforms.envMap.value=i,p.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,p.material.uniforms.backgroundBlurriness.value=t.backgroundBlurriness,p.material.uniforms.backgroundIntensity.value=t.backgroundIntensity,p.material.toneMapped=pe.getTransfer(i.colorSpace)!==ar,f===i&&g===i.version&&v===a.toneMapping||(p.material.needsUpdate=!0,f=i,g=i.version,v=a.toneMapping),p.layers.enableAll(),e.unshift(p,p.geometry,p.material,0,0,null)):i&&i.isTexture&&(void 0===m&&((m=new ta(new wa(2,2),new la({name:"BackgroundMaterial",uniforms:na(Aa.background.uniforms),vertexShader:Aa.background.vertexShader,fragmentShader:Aa.background.fragmentShader,side:Ve,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.deleteAttribute("normal"),Object.defineProperty(m.material,"map",{get:function(){return this.uniforms.t2D.value}}),h.update(m)),m.material.uniforms.t2D.value=i,m.material.uniforms.backgroundIntensity.value=t.backgroundIntensity,m.material.toneMapped=pe.getTransfer(i.colorSpace)!==ar,!0===i.matrixAutoUpdate&&i.updateMatrix(),m.material.uniforms.uvTransform.value.copy(i.matrix),f===i&&g===i.version&&v===a.toneMapping||(m.material.needsUpdate=!0,f=i,g=i.version,v=a.toneMapping),m.layers.enableAll(),e.unshift(m,m.geometry,m.material,0,0,null))}}}function Ta(P,I,R,D){let n=P.getParameter(P.MAX_VERTEX_ATTRIBS),L=D.isWebGL2?null:I.get("OES_vertex_array_object"),O=D.isWebGL2||null!==L,k={},e=U(null),N=e,F=!1;function B(e){if(D.isWebGL2)return P.bindVertexArray(e);L.bindVertexArrayOES(e)}function a(e){if(D.isWebGL2)return P.deleteVertexArray(e);L.deleteVertexArrayOES(e)}function U(e){var t=[],r=[],i=[];for(let e=0;e<n;e++)t[e]=0,r[e]=0,i[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:r,attributeDivisors:i,object:e,attributes:{},index:null}}function z(){var r=N.newAttributes;for(let e=0,t=r.length;e<t;e++)r[e]=0}function V(e){G(e,0)}function G(e,t){var r=N.newAttributes,i=N.enabledAttributes,n=N.attributeDivisors;r[e]=1,0===i[e]&&(P.enableVertexAttribArray(e),i[e]=1),n[e]!==t&&((D.isWebGL2?P:I.get("ANGLE_instanced_arrays"))[D.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](e,t),n[e]=t)}function H(){var r=N.newAttributes,i=N.enabledAttributes;for(let e=0,t=i.length;e<t;e++)i[e]!==r[e]&&(P.disableVertexAttribArray(e),i[e]=0)}function $(e,t,r,i,n,a,s){!0===s?P.vertexAttribIPointer(e,t,r,n,a):P.vertexAttribPointer(e,t,r,i,n,a)}function s(){t(),F=!0,N!==e&&B((N=e).object)}function t(){e.geometry=null,e.program=null,e.wireframe=!1}return{setup:function(n,e,a,s,o){let t=!1;if(O){var l=((e,t,r)=>{let i=!0===r.wireframe,n=k[e.id],a=(void 0===n&&(n={},k[e.id]=n),n[t.id]),s=(void 0===a&&(a={},n[t.id]=a),a[i]);return void 0===s&&(s=U(D.isWebGL2?P.createVertexArray():L.createVertexArrayOES()),a[i]=s),s})(s,a,e);if(N!==l&&B((N=l).object),t=((t,e,r,i)=>{let n=N.attributes,a=e.attributes,s=0,o=r.getAttributes();for(var l in o)if(0<=o[l].location){var h=n[l];let e=a[l];if(void 0===e&&("instanceMatrix"===l&&t.instanceMatrix&&(e=t.instanceMatrix),"instanceColor"===l)&&t.instanceColor&&(e=t.instanceColor),void 0===h)return!0;if(h.attribute!==e)return!0;if(e&&h.data!==e.data)return!0;s++}return N.attributesNum!==s||N.index!==i})(n,s,a,o)){var h,c=n,l=a,u=o;let t={},r=s.attributes,i=0,e=l.getAttributes();for(h in e)if(0<=e[h].location){let e=r[h];void 0===e&&("instanceMatrix"===h&&c.instanceMatrix&&(e=c.instanceMatrix),"instanceColor"===h)&&c.instanceColor&&(e=c.instanceColor);var d={};(d.attribute=e)&&e.data&&(d.data=e.data),t[h]=d,i++}N.attributes=t,N.attributesNum=i,N.index=u}}else{l=!0===e.wireframe;N.geometry===s.id&&N.program===a.id&&N.wireframe===l||(N.geometry=s.id,N.program=a.id,N.wireframe=l,t=!0)}if(null!==o&&R.update(o,P.ELEMENT_ARRAY_BUFFER),t||F){F=!1;var r=n,u=e,n=a,i=s;if(!1!==D.isWebGL2||!r.isInstancedMesh&&!i.isInstancedBufferGeometry||null!==I.get("ANGLE_instanced_arrays")){z();var m,p=i.attributes,f=n.getAttributes(),g=u.defaultAttributeValues;for(m in f){var v=f[m];if(0<=v.location){let t=p[m];if(void 0!==(t=void 0===t&&("instanceMatrix"===m&&r.instanceMatrix&&(t=r.instanceMatrix),"instanceColor"===m)&&r.instanceColor?r.instanceColor:t)){var _=t.normalized,y=t.itemSize,b=R.get(t);if(void 0!==b){var x=b.buffer,S=b.type,w=b.bytesPerElement,A=!0===D.isWebGL2&&(S===P.INT||S===P.UNSIGNED_INT||t.gpuType===Ke);if(t.isInterleavedBufferAttribute){var M=t.data,C=M.stride,T=t.offset;if(M.isInstancedInterleavedBuffer){for(let e=0;e<v.locationSize;e++)G(v.location+e,M.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===i._maxInstanceCount&&(i._maxInstanceCount=M.meshPerAttribute*M.count)}else for(let e=0;e<v.locationSize;e++)V(v.location+e);P.bindBuffer(P.ARRAY_BUFFER,x);for(let e=0;e<v.locationSize;e++)$(v.location+e,y/v.locationSize,S,_,C*w,(T+y/v.locationSize*e)*w,A)}else{if(t.isInstancedBufferAttribute){for(let e=0;e<v.locationSize;e++)G(v.location+e,t.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===i._maxInstanceCount&&(i._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<v.locationSize;e++)V(v.location+e);P.bindBuffer(P.ARRAY_BUFFER,x);for(let e=0;e<v.locationSize;e++)$(v.location+e,y/v.locationSize,S,_,y*w,y/v.locationSize*e*w,A)}}}else if(void 0!==g){var E=g[m];if(void 0!==E)switch(E.length){case 2:P.vertexAttrib2fv(v.location,E);break;case 3:P.vertexAttrib3fv(v.location,E);break;case 4:P.vertexAttrib4fv(v.location,E);break;default:P.vertexAttrib1fv(v.location,E)}}}}H()}null!==o&&P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,R.get(o).buffer)}},reset:s,resetDefaultState:t,dispose:function(){for(var e in s(),k){var t,r=k[e];for(t in r){var i,n=r[t];for(i in n)a(n[i].object),delete n[i];delete r[t]}delete k[e]}},releaseStatesOfGeometry:function(e){if(void 0!==k[e.id]){var t,r=k[e.id];for(t in r){var i,n=r[t];for(i in n)a(n[i].object),delete n[i];delete r[t]}delete k[e.id]}},releaseStatesOfProgram:function(e){for(var t in k){t=k[t];if(void 0!==t[e.id]){var r,i=t[e.id];for(r in i)a(i[r].object),delete i[r];delete t[e.id]}}},initAttributes:z,enableAttribute:V,disableUnusedAttributes:H}}function Ea(a,s,o,e){let l=e.isWebGL2,h;this.setMode=function(e){h=e},this.render=function(e,t){a.drawArrays(h,e,t),o.update(t,h,1)},this.renderInstances=function(r,i,n){if(0!==n){let e,t;if(l)e=a,t="drawArraysInstanced";else if(e=s.get("ANGLE_instanced_arrays"),t="drawArraysInstancedANGLE",null===e)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");e[t](h,r,i,n),o.update(i,h,n)}}}function Pa(t,r,e){let i;function n(e){if("highp"===e){if(0<t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision&&0<t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision)return"highp";e="mediump"}return"mediump"===e&&0<t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision&&0<t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision?"mediump":"lowp"}var a="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===t.constructor.name;let s=void 0!==e.precision?e.precision:"highp";var o=n(s),o=(o!==s&&(console.warn("THREE.WebGLRenderer:",s,"not supported, using",o,"instead."),s=o),a||r.has("WEBGL_draw_buffers")),e=!0===e.logarithmicDepthBuffer,l=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),h=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),c=t.getParameter(t.MAX_TEXTURE_SIZE),u=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),d=t.getParameter(t.MAX_VERTEX_ATTRIBS),m=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),p=t.getParameter(t.MAX_VARYING_VECTORS),f=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),g=0<h,v=a||r.has("OES_texture_float"),_=g&&v,y=a?t.getParameter(t.MAX_SAMPLES):0;return{isWebGL2:a,drawBuffers:o,getMaxAnisotropy:function(){var e;return i=void 0===i?!0===r.has("EXT_texture_filter_anisotropic")?(e=r.get("EXT_texture_filter_anisotropic"),t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT)):0:i},getMaxPrecision:n,precision:s,logarithmicDepthBuffer:e,maxTextures:l,maxVertexTextures:h,maxTextureSize:c,maxCubemapSize:u,maxAttributes:d,maxVertexUniforms:m,maxVaryings:p,maxFragmentUniforms:f,vertexTextures:g,floatFragmentTextures:v,floatVertexTextures:_,maxSamples:y}}function Ia(l){let h=this,c=null,u=0,d=!1,m=!1,o=new va,p=new v,f={value:null,needsUpdate:!1};function g(r,e,i,t){var n=null!==r?r.length:0;let a=null;if(0!==n){if(a=f.value,!0!==t||null===a){var t=i+4*n,s=e.matrixWorldInverse;p.getNormalMatrix(s),(null===a||a.length<t)&&(a=new Float32Array(t));for(let e=0,t=i;e!==n;++e,t+=4)o.copy(r[e]).applyMatrix4(s,p),o.normal.toArray(a,t),a[t+3]=o.constant}f.value=a,f.needsUpdate=!0}return h.numPlanes=n,h.numIntersection=0,a}this.uniform=f,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){var r=0!==e.length||t||0!==u||d;return d=t,u=e.length,r},this.beginShadows=function(){m=!0,g(null)},this.endShadows=function(){m=!1},this.setGlobalState=function(e,t){c=g(e,t,0)},this.setState=function(e,t,r){var i=e.clippingPlanes,n=e.clipIntersection,a=e.clipShadows,e=l.get(e);if(!d||null===i||0===i.length||m&&!a)m?g(null):(f.value!==c&&(f.value=c,f.needsUpdate=0<u),h.numPlanes=u,h.numIntersection=0);else{var a=m?0:u,s=4*a,o=e.clippingState||null;f.value=o,o=g(i,t,s,r);for(let e=0;e!==s;++e)o[e]=c[e];e.clippingState=o,this.numIntersection=n?this.numPlanes:0,this.numPlanes+=a}}}function Ra(r){let i=new WeakMap;function n(e,t){return t===w?e.mapping=U:t===A&&(e.mapping=z),e}function a(e){var e=e.target,t=(e.removeEventListener("dispose",a),i.get(e));void 0!==t&&(i.delete(e),t.dispose())}return{get:function(e){if(e&&e.isTexture&&!1===e.isRenderTargetTexture){var t=e.mapping;if(t===w||t===A)return i.has(e)?n(i.get(e).texture,e.mapping):(t=e.image)&&0<t.height?((t=new ma(t.height/2)).fromEquirectangularTexture(r,e),i.set(e,t),e.addEventListener("dispose",a),n(t.texture,e.mapping)):null}return e},dispose:function(){i=new WeakMap}}}class Da extends ha{constructor(e=-1,t=1,r=1,i=-1,n=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=i,this.near=n,this.far=a,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,r,i,n,a){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let n=r-e,a=r+e,s=i+t,o=i-t;null!==this.view&&this.view.enabled&&(r=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom,n+=r*this.view.offsetX,a=n+r*this.view.width,s-=e*this.view.offsetY,o=s-e*this.view.height),this.projectionMatrix.makeOrthographic(n,a,s,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){e=super.toJSON(e);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}let La=[.125,.215,.35,.446,.526,.582],Oa=new Da,ka=new ze,Na=null,Fa=0,Ba=0;var e=(1+Math.sqrt(5))/2,t=1/e;let Ua=[new et(1,1,1),new et(-1,1,1),new et(1,1,-1),new et(-1,1,-1),new et(0,e,t),new et(0,e,-t),new et(t,0,e),new et(-t,0,e),new et(e,t,0),new et(-e,t,0)];class za{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,r=.1,i=100){Na=this._renderer.getRenderTarget(),Fa=this._renderer.getActiveCubeFace(),Ba=this._renderer.getActiveMipmapLevel(),this._setSize(256);var n=this._allocateTargets();return n.depthBuffer=!0,this._sceneToCubeUV(e,r,i,n),0<t&&this._blur(n,0,0,t),this._applyPMREM(n),this._cleanup(n),n}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=$a(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Ha(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(Na,Fa,Ba),e.scissorTest=!1,Ga(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===U||e.mapping===z?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Na=this._renderer.getRenderTarget(),Fa=this._renderer.getActiveCubeFace(),Ba=this._renderer.getActiveMipmapLevel();t=t||this._allocateTargets();return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(){var e,t,r=3*Math.max(this._cubeSize,112),i=4*this._cubeSize,n={magFilter:je,minFilter:je,generateMipmaps:!1,type:it,format:ot,colorSpace:tr,depthBuffer:!1},a=Va(r,i,n);return null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.width===r&&this._pingPongRenderTarget.height===i||(null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=Va(r,i,n),n=this._lodMax,{sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=(r=>{let i=[],n=[],a=[],s=r,e=r-4+1+La.length;for(let t=0;t<e;t++){var o=Math.pow(2,s);n.push(o);let e=1/o;t>r-4?e=La[t-r+4-1]:0===t&&(e=0),a.push(e);var o=1/(o-2),l=-o,o=1+o,h=[l,l,o,l,o,o,l,l,o,o,l,o],c=new Float32Array(108),u=new Float32Array(72),d=new Float32Array(36);for(let e=0;e<6;e++){var m=e%3*2/3-1,p=2<e?0:-1,m=(c.set([m,p,0,m+2/3,p,0,m+2/3,1+p,0,m,p,0,m+2/3,1+p,0,m,1+p,0],18*e),u.set(h,12*e),[e,e,e,e,e,e]);d.set(m,6*e)}l=new Fn;l.setAttribute("position",new Cn(c,3)),l.setAttribute("uv",new Cn(u,2)),l.setAttribute("faceIndex",new Cn(d,1)),i.push(l),4<s&&s--}return{lodPlanes:i,sizeLods:n,sigmas:a}})(n),this._blurMaterial=(n=n,r=r,i=i,e=new Float32Array(20),t=new et(0,1,0),r=new la({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/r,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:n+".0"},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:t}},vertexShader:ja(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:ee,depthTest:!1,depthWrite:!1}))),a}_compileMaterial(e){e=new ta(this._lodPlanes[0],e);this._renderer.compile(e,Oa)}_sceneToCubeUV(t,e,r,i){var n=new ca(90,1,e,r),a=[1,-1,1,1,1,1],s=[1,1,1,-1,-1,-1],o=this._renderer,e=o.autoClear,r=o.toneMapping,l=(o.getClearColor(ka),o.toneMapping=$e,o.autoClear=!1,new wn({name:"PMREM.Background",side:Ge,depthWrite:!1,depthTest:!1})),h=new ta(new ia,l);let c=!1;var u=t.background;u?u.isColor&&(l.color.copy(u),t.background=null,c=!0):(l.color.copy(ka),c=!0);for(let e=0;e<6;e++){var d=e%3,m=(0==d?(n.up.set(0,a[e],0),n.lookAt(s[e],0,0)):1==d?(n.up.set(0,0,a[e]),n.lookAt(0,s[e],0)):(n.up.set(0,a[e],0),n.lookAt(0,0,s[e])),this._cubeSize);Ga(i,d*m,2<e?m:0,m,m),o.setRenderTarget(i),c&&o.render(h,n),o.render(t,n)}h.geometry.dispose(),h.material.dispose(),o.toneMapping=r,o.autoClear=e,t.background=u}_textureToCubeUV(e,t){var r=this._renderer,i=e.mapping===U||e.mapping===z,i=(i?(null===this._cubemapMaterial&&(this._cubemapMaterial=$a()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Ha()),i?this._cubemapMaterial:this._equirectMaterial),n=new ta(this._lodPlanes[0],i),i=(i.uniforms.envMap.value=e,this._cubeSize);Ga(t,0,0,3*i,2*i),r.setRenderTarget(t),r.render(n,Oa)}_applyPMREM(t){var e=this._renderer,r=e.autoClear;e.autoClear=!1;for(let e=1;e<this._lodPlanes.length;e++){var i=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]),n=Ua[(e-1)%Ua.length];this._blur(t,e-1,e,i,n)}e.autoClear=r}_blur(e,t,r,i,n){var a=this._pingPongRenderTarget;this._halfBlur(e,a,t,r,i,"latitudinal",n),this._halfBlur(a,e,r,r,i,"longitudinal",n)}_halfBlur(e,t,r,i,n,a,s){var o=this._renderer,l=this._blurMaterial,h=("latitudinal"!==a&&"longitudinal"!==a&&console.error("blur direction must be either latitudinal or longitudinal!"),new ta(this._lodPlanes[i],l)),l=l.uniforms,c=this._sizeLods[r]-1,c=isFinite(n)?Math.PI/(2*c):2*Math.PI/39,u=n/c,d=isFinite(n)?1+Math.floor(3*u):20,m=(20<d&&console.warn(`sigmaRadians, ${n}, is too large and will clip, as it requested ${d} samples when the maximum is set to 20`),[]);let p=0;for(let t=0;t<20;++t){let e=t/u;var f=Math.exp(-e*e/2);m.push(f),0===t?p+=f:t<d&&(p+=2*f)}for(let e=0;e<m.length;e++)m[e]=m[e]/p;l.envMap.value=e.texture,l.samples.value=d,l.weights.value=m,l.latitudinal.value="latitudinal"===a,s&&(l.poleAxis.value=s);n=this._lodMax,l.dTheta.value=c,l.mipInt.value=n-r,e=this._sizeLods[i];let g=3*e*(n-4<i?i-n+4:0);a=4*(this._cubeSize-e);Ga(t,g,a,3*e,2*e),o.setRenderTarget(t),o.render(h,Oa)}}function Va(e,t,r){e=new Jr(e,t,r);return e.texture.mapping=Fe,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function Ga(e,t,r,i,n){e.viewport.set(t,r,i,n),e.scissor.set(t,r,i,n)}function Ha(){return new la({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:ja(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:ee,depthTest:!1,depthWrite:!1})}function $a(){return new la({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:ja(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:ee,depthTest:!1,depthWrite:!1})}function ja(){return`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function Wa(n){let a=new WeakMap,s=null;function o(e){var e=e.target,t=(e.removeEventListener("dispose",o),a.get(e));void 0!==t&&(a.delete(e),t.dispose())}return{get:function(e){if(e&&e.isTexture){var t,r=e.mapping,i=r===w||r===A,r=r===U||r===z;if(i||r)return e.isRenderTargetTexture&&!0===e.needsPMREMUpdate?(e.needsPMREMUpdate=!1,t=a.get(e),null===s&&(s=new za(n)),t=i?s.fromEquirectangular(e,t):s.fromCubemap(e,t),a.set(e,t),t.texture):a.has(e)?a.get(e).texture:(t=e.image,i&&t&&0<t.height||r&&t&&(t=>{let r=0;for(let e=0;e<6;e++)void 0!==t[e]&&r++;return 6===r})(t)?(null===s&&(s=new za(n)),r=i?s.fromEquirectangular(e):s.fromCubemap(e),a.set(e,r),e.addEventListener("dispose",o),r.texture):null)}return e},dispose:function(){a=new WeakMap,null!==s&&(s.dispose(),s=null)}}}function qa(r){let i={};function n(e){if(void 0!==i[e])return i[e];let t;switch(e){case"WEBGL_depth_texture":t=r.getExtension("WEBGL_depth_texture")||r.getExtension("MOZ_WEBGL_depth_texture")||r.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:t=r.getExtension(e)}return i[e]=t}return{has:function(e){return null!==n(e)},init:function(e){e.isWebGL2?n("EXT_color_buffer_float"):(n("WEBGL_depth_texture"),n("OES_texture_float"),n("OES_texture_half_float"),n("OES_texture_half_float_linear"),n("OES_standard_derivatives"),n("OES_element_index_uint"),n("OES_vertex_array_object"),n("ANGLE_instanced_arrays")),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture")},get:function(e){var t=n(e);return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function Xa(s,d,a,o){let l={},m=new WeakMap;function h(e){var t,r,i=e.target;for(t in null!==i.index&&d.remove(i.index),i.attributes)d.remove(i.attributes[t]);for(r in i.morphAttributes){var n=i.morphAttributes[r];for(let e=0,t=n.length;e<t;e++)d.remove(n[e])}i.removeEventListener("dispose",h),delete l[i.id];e=m.get(i);e&&(d.remove(e),m.delete(i)),o.releaseStatesOfGeometry(i),!0===i.isInstancedBufferGeometry&&delete i._maxInstanceCount,a.memory.geometries--}function i(e){var r=[],i=e.index,t=e.attributes.position;let n=0;if(null!==i){var a=i.array;n=i.version;for(let e=0,t=a.length;e<t;e+=3){var s=a[e+0],o=a[e+1],l=a[e+2];r.push(s,o,o,l,l,s)}}else{if(void 0===t)return;i=t.array;n=t.version;for(let e=0,t=i.length/3-1;e<t;e+=3){var h=e+0,c=e+1,u=e+2;r.push(h,c,c,u,u,h)}}t=new(Or(r)?En:Tn)(r,1),t.version=n,i=m.get(e);i&&d.remove(i),m.set(e,t)}return{get:function(e,t){return!0!==l[t.id]&&(t.addEventListener("dispose",h),l[t.id]=!0,a.memory.geometries++),t},update:function(e){var t,r=e.attributes;for(t in r)d.update(r[t],s.ARRAY_BUFFER);var i,n=e.morphAttributes;for(i in n){var a=n[i];for(let e=0,t=a.length;e<t;e++)d.update(a[e],s.ARRAY_BUFFER)}},getWireframeAttribute:function(e){var t,r=m.get(e);return(!r||null!==(t=e.index)&&r.version<t.version)&&i(e),m.get(e)}}}function Ya(a,s,o,e){let l=e.isWebGL2,h;let c,u;this.setMode=function(e){h=e},this.setIndex=function(e){c=e.type,u=e.bytesPerElement},this.render=function(e,t){a.drawElements(h,t,c,e*u),o.update(t,h,1)},this.renderInstances=function(r,i,n){if(0!==n){let e,t;if(l)e=a,t="drawElementsInstanced";else if(e=s.get("ANGLE_instanced_arrays"),t="drawElementsInstancedANGLE",null===e)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");e[t](h,i,c,r*u,n),o.update(i,h,n)}}}function Ka(i){let n={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:n,programs:null,autoReset:!0,reset:function(){n.calls=0,n.triangles=0,n.points=0,n.lines=0},update:function(e,t,r){switch(n.calls++,t){case i.TRIANGLES:n.triangles+=r*(e/3);break;case i.LINES:n.lines+=r*(e/2);break;case i.LINE_STRIP:n.lines+=r*(e-1);break;case i.LINE_LOOP:n.lines+=r*e;break;case i.POINTS:n.points+=r*e;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",t)}}}}function Za(e,t){return e[0]-t[0]}function Qa(e,t){return Math.abs(t[1])-Math.abs(e[1])}function Ja(C,T,r){let E={},P=new Float32Array(8),I=new WeakMap,R=new Zr,D=[];for(let e=0;e<8;e++)D[e]=[e,0];return{update:function(e,a,i){var s=e.morphTargetInfluences;if(!0===T.isWebGL2){var e=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,o=void 0!==e?e.length:0;let n=I.get(a);if(void 0===n||n.count!==o){void 0!==n&&n.texture.dispose();var l=void 0!==a.morphAttributes.position,h=void 0!==a.morphAttributes.normal,c=void 0!==a.morphAttributes.color,u=a.morphAttributes.position||[],d=a.morphAttributes.normal||[],m=a.morphAttributes.color||[];let e=!0==c?3:!0==h?2:!0==l?1:0,t=a.attributes.position.count*e,r=1;t>T.maxTextureSize&&(r=Math.ceil(t/T.maxTextureSize),t=T.maxTextureSize);var p=new Float32Array(t*r*4*o);let i=new ei(p,t,r,o);i.type=Qe,i.needsUpdate=!0;var f=4*e;for(let e=0;e<o;e++){var g=u[e],v=d[e],_=m[e],y=t*r*4*e;for(let e=0;e<g.count;e++){var b=e*f;!0==l&&(R.fromBufferAttribute(g,e),p[y+b]=R.x,p[y+b+1]=R.y,p[y+b+2]=R.z,p[y+b+3]=0),!0==h&&(R.fromBufferAttribute(v,e),p[y+b+4]=R.x,p[y+b+5]=R.y,p[y+b+6]=R.z,p[y+b+7]=0),!0==c&&(R.fromBufferAttribute(_,e),p[y+b+8]=R.x,p[y+b+9]=R.y,p[y+b+10]=R.z,p[y+b+11]=4===_.itemSize?R.w:1)}}n={count:o,texture:i,size:new Ue(t,r)},I.set(a,n),a.addEventListener("dispose",function e(){i.dispose(),I.delete(a),a.removeEventListener("dispose",e)})}let t=0;for(let e=0;e<s.length;e++)t+=s[e];e=a.morphTargetsRelative?1:1-t;i.getUniforms().setValue(C,"morphTargetBaseInfluence",e),i.getUniforms().setValue(C,"morphTargetInfluences",s),i.getUniforms().setValue(C,"morphTargetsTexture",n.texture,r),i.getUniforms().setValue(C,"morphTargetsTextureSize",n.size)}else{var n=void 0===s?0:s.length;let t=E[a.id];if(void 0===t||t.length!==n){t=[];for(let e=0;e<n;e++)t[e]=[e,0];E[a.id]=t}for(let e=0;e<n;e++){var x=t[e];x[0]=e,x[1]=s[e]}t.sort(Qa);for(let e=0;e<8;e++)e<n&&t[e][1]?(D[e][0]=t[e][0],D[e][1]=t[e][1]):(D[e][0]=Number.MAX_SAFE_INTEGER,D[e][1]=0);D.sort(Za);var S=a.morphAttributes.position,w=a.morphAttributes.normal;let r=0;for(let e=0;e<8;e++){var A=D[e],M=A[0],A=A[1];M!==Number.MAX_SAFE_INTEGER&&A?(S&&a.getAttribute("morphTarget"+e)!==S[M]&&a.setAttribute("morphTarget"+e,S[M]),w&&a.getAttribute("morphNormal"+e)!==w[M]&&a.setAttribute("morphNormal"+e,w[M]),P[e]=A,r+=A):(S&&!0===a.hasAttribute("morphTarget"+e)&&a.deleteAttribute("morphTarget"+e),w&&!0===a.hasAttribute("morphNormal"+e)&&a.deleteAttribute("morphNormal"+e),P[e]=0)}e=a.morphTargetsRelative?1:1-r;i.getUniforms().setValue(C,"morphTargetBaseInfluence",e),i.getUniforms().setValue(C,"morphTargetInfluences",P)}}}}function es(i,n,a,s){let o=new WeakMap;function l(e){e=e.target;e.removeEventListener("dispose",l),a.remove(e.instanceMatrix),null!==e.instanceColor&&a.remove(e.instanceColor)}return{update:function(e){var t=s.render.frame,r=e.geometry,r=n.get(e,r);return o.get(r)!==t&&(n.update(r),o.set(r,t)),e.isInstancedMesh&&(!1===e.hasEventListener("dispose",l)&&e.addEventListener("dispose",l),o.get(e)!==t)&&(a.update(e.instanceMatrix,i.ARRAY_BUFFER),null!==e.instanceColor&&a.update(e.instanceColor,i.ARRAY_BUFFER),o.set(e,t)),e.isSkinnedMesh&&(e=e.skeleton,o.get(e)!==t)&&(e.update(),o.set(e,t)),r},dispose:function(){o=new WeakMap}}}let ts=new Kr,rs=new ei,is=new ti,ns=new da,as=[],ss=[],os=new Float32Array(16),ls=new Float32Array(9),hs=new Float32Array(4);function cs(r,i,n){var e=r[0];if(e<=0||0<e)return r;var t=i*n;let a=as[t];if(void 0===a&&(a=new Float32Array(t),as[t]=a),0!==i){e.toArray(a,0);for(let e=1,t=0;e!==i;++e)t+=n,r[e].toArray(a,t)}return a}function us(r,i){if(r.length===i.length){for(let e=0,t=r.length;e<t;e++)if(r[e]!==i[e])return;return 1}}function ds(r,i){for(let e=0,t=i.length;e<t;e++)r[e]=i[e]}function ms(t,r){let i=ss[r];void 0===i&&(i=new Int32Array(r),ss[r]=i);for(let e=0;e!==r;++e)i[e]=t.allocateTextureUnit();return i}function ps(e,t){var r=this.cache;r[0]!==t&&(e.uniform1f(this.addr,t),r[0]=t)}function fs(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y):us(r,t)||(e.uniform2fv(this.addr,t),ds(r,t))}function gs(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z):void 0!==t.r?r[0]===t.r&&r[1]===t.g&&r[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),r[0]=t.r,r[1]=t.g,r[2]=t.b):us(r,t)||(e.uniform3fv(this.addr,t),ds(r,t))}function vs(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z&&r[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w):us(r,t)||(e.uniform4fv(this.addr,t),ds(r,t))}function _s(e,t){var r=this.cache,i=t.elements;void 0===i?us(r,t)||(e.uniformMatrix2fv(this.addr,!1,t),ds(r,t)):us(r,i)||(hs.set(i),e.uniformMatrix2fv(this.addr,!1,hs),ds(r,i))}function ys(e,t){var r=this.cache,i=t.elements;void 0===i?us(r,t)||(e.uniformMatrix3fv(this.addr,!1,t),ds(r,t)):us(r,i)||(ls.set(i),e.uniformMatrix3fv(this.addr,!1,ls),ds(r,i))}function bs(e,t){var r=this.cache,i=t.elements;void 0===i?us(r,t)||(e.uniformMatrix4fv(this.addr,!1,t),ds(r,t)):us(r,i)||(os.set(i),e.uniformMatrix4fv(this.addr,!1,os),ds(r,i))}function xs(e,t){var r=this.cache;r[0]!==t&&(e.uniform1i(this.addr,t),r[0]=t)}function Ss(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y):us(r,t)||(e.uniform2iv(this.addr,t),ds(r,t))}function ws(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z):us(r,t)||(e.uniform3iv(this.addr,t),ds(r,t))}function As(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z&&r[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w):us(r,t)||(e.uniform4iv(this.addr,t),ds(r,t))}function Ms(e,t){var r=this.cache;r[0]!==t&&(e.uniform1ui(this.addr,t),r[0]=t)}function Cs(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y):us(r,t)||(e.uniform2uiv(this.addr,t),ds(r,t))}function Ts(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z):us(r,t)||(e.uniform3uiv(this.addr,t),ds(r,t))}function Es(e,t){var r=this.cache;void 0!==t.x?r[0]===t.x&&r[1]===t.y&&r[2]===t.z&&r[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w):us(r,t)||(e.uniform4uiv(this.addr,t),ds(r,t))}function Ps(e,t,r){var i=this.cache,n=r.allocateTextureUnit();i[0]!==n&&(e.uniform1i(this.addr,n),i[0]=n),r.setTexture2D(t||ts,n)}function Is(e,t,r){var i=this.cache,n=r.allocateTextureUnit();i[0]!==n&&(e.uniform1i(this.addr,n),i[0]=n),r.setTexture3D(t||is,n)}function Rs(e,t,r){var i=this.cache,n=r.allocateTextureUnit();i[0]!==n&&(e.uniform1i(this.addr,n),i[0]=n),r.setTextureCube(t||ns,n)}function Ds(e,t,r){var i=this.cache,n=r.allocateTextureUnit();i[0]!==n&&(e.uniform1i(this.addr,n),i[0]=n),r.setTexture2DArray(t||rs,n)}function Ls(e,t){e.uniform1fv(this.addr,t)}function Os(e,t){t=cs(t,this.size,2);e.uniform2fv(this.addr,t)}function ks(e,t){t=cs(t,this.size,3);e.uniform3fv(this.addr,t)}function Ns(e,t){t=cs(t,this.size,4);e.uniform4fv(this.addr,t)}function Fs(e,t){t=cs(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,t)}function Bs(e,t){t=cs(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,t)}function Us(e,t){t=cs(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,t)}function zs(e,t){e.uniform1iv(this.addr,t)}function Vs(e,t){e.uniform2iv(this.addr,t)}function Gs(e,t){e.uniform3iv(this.addr,t)}function Hs(e,t){e.uniform4iv(this.addr,t)}function $s(e,t){e.uniform1uiv(this.addr,t)}function js(e,t){e.uniform2uiv(this.addr,t)}function Ws(e,t){e.uniform3uiv(this.addr,t)}function qs(e,t){e.uniform4uiv(this.addr,t)}function Xs(e,t,r){var i=this.cache,n=t.length,a=ms(r,n);us(i,a)||(e.uniform1iv(this.addr,a),ds(i,a));for(let e=0;e!==n;++e)r.setTexture2D(t[e]||ts,a[e])}function Ys(e,t,r){var i=this.cache,n=t.length,a=ms(r,n);us(i,a)||(e.uniform1iv(this.addr,a),ds(i,a));for(let e=0;e!==n;++e)r.setTexture3D(t[e]||is,a[e])}function Ks(e,t,r){var i=this.cache,n=t.length,a=ms(r,n);us(i,a)||(e.uniform1iv(this.addr,a),ds(i,a));for(let e=0;e!==n;++e)r.setTextureCube(t[e]||ns,a[e])}function Zs(e,t,r){var i=this.cache,n=t.length,a=ms(r,n);us(i,a)||(e.uniform1iv(this.addr,a),ds(i,a));for(let e=0;e!==n;++e)r.setTexture2DArray(t[e]||rs,a[e])}class Qs{constructor(e,t,r){this.id=e,this.addr=r,this.cache=[],this.setValue=(e=>{switch(e){case 5126:return ps;case 35664:return fs;case 35665:return gs;case 35666:return vs;case 35674:return _s;case 35675:return ys;case 35676:return bs;case 5124:case 35670:return xs;case 35667:case 35671:return Ss;case 35668:case 35672:return ws;case 35669:case 35673:return As;case 5125:return Ms;case 36294:return Cs;case 36295:return Ts;case 36296:return Es;case 35678:case 36198:case 36298:case 36306:case 35682:return Ps;case 35679:case 36299:case 36307:return Is;case 35680:case 36300:case 36308:case 36293:return Rs;case 36289:case 36303:case 36311:case 36292:return Ds}})(t.type)}}class Js{constructor(e,t,r){this.id=e,this.addr=r,this.cache=[],this.size=t.size,this.setValue=(e=>{switch(e){case 5126:return Ls;case 35664:return Os;case 35665:return ks;case 35666:return Ns;case 35674:return Fs;case 35675:return Bs;case 35676:return Us;case 5124:case 35670:return zs;case 35667:case 35671:return Vs;case 35668:case 35672:return Gs;case 35669:case 35673:return Hs;case 5125:return $s;case 36294:return js;case 36295:return Ws;case 36296:return qs;case 35678:case 36198:case 36298:case 36306:case 35682:return Xs;case 35679:case 36299:case 36307:return Ys;case 35680:case 36300:case 36308:case 36293:return Ks;case 36289:case 36303:case 36311:case 36292:return Zs}})(t.type)}}class eo{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(r,i,n){var a=this.seq;for(let e=0,t=a.length;e!==t;++e){var s=a[e];s.setValue(r,i[s.id],n)}}}let to=/(\w+)(\])?(\[|\.)?/g;function ro(e,t){e.seq.push(t),e.map[t.id]=t}class io{constructor(t,r){this.seq=[],this.map={};var i=t.getProgramParameter(r,t.ACTIVE_UNIFORMS);for(let e=0;e<i;++e){var n=t.getActiveUniform(r,e),a=t.getUniformLocation(r,n.name),s=(m=d=u=c=h=l=o=s=void 0,n),o=a,l=this,h=s.name,c=h.length;for(to.lastIndex=0;;){var u=to.exec(h),d=to.lastIndex;let t=u[1];var m=u[3];if("]"===u[2]&&(t|=0),void 0===m||"["===m&&d+2===c){ro(l,new(void 0===m?Qs:Js)(t,s,o));break}{let e=l.map[t];void 0===e&&ro(l,e=new eo(t)),l=e}}}}setValue(e,t,r,i){t=this.map[t];void 0!==t&&t.setValue(e,r,i)}setOptional(e,t,r){t=t[r];void 0!==t&&this.setValue(e,r,t)}static upload(r,i,n,a){for(let e=0,t=i.length;e!==t;++e){var s=i[e],o=n[s.id];!1!==o.needsUpdate&&s.setValue(r,o.value,a)}}static seqWithValue(r,i){var n=[];for(let e=0,t=r.length;e!==t;++e){var a=r[e];a.id in i&&n.push(a)}return n}}function no(e,t,r){t=e.createShader(t);return e.shaderSource(t,r),e.compileShader(t),t}let ao=37297,so=0;function oo(e,t,r){var i=e.getShaderParameter(t,e.COMPILE_STATUS),n=e.getShaderInfoLog(t).trim();return i&&""===n?"":(i=/ERROR: 0:(\d+)/.exec(n))?(i=parseInt(i[1]),r.toUpperCase()+"\n\n"+n+"\n\n"+((t,r)=>{var i=t.split("\n"),n=[],t=Math.max(r-6,0),a=Math.min(r+6,i.length);for(let e=t;e<a;e++){var s=e+1;n.push(`${s===r?">":" "} ${s}: `+i[e])}return n.join("\n")})(e.getShaderSource(t),i)):n}function lo(e,t){t=(e=>{var t=pe.getPrimaries(pe.workingColorSpace),r=pe.getPrimaries(e);let i;switch(t===r?i="":t===or&&r===sr?i="LinearDisplayP3ToLinearSRGB":t===sr&&r===or&&(i="LinearSRGBToLinearDisplayP3"),e){case tr:case ir:return[i,"LinearTransferOETF"];case er:case rr:return[i,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",e),[i,"LinearTransferOETF"]}})(t);return`vec4 ${e}( vec4 value ) { return ${t[0]}( ${t[1]}( value ) ); }`}function ho(e){return""!==e}function co(e,t){var r=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,r).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function uo(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}let mo=/^[ \t]*#include +<([\w\d./]+)>/gm;function po(e){return e.replace(mo,go)}let fo=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function go(e,t){let r=M[t];if(void 0===r){var i=fo.get(t);if(void 0===i)throw new Error("Can not resolve #include <"+t+">");r=M[i],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,i)}return po(r)}let vo=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function _o(e){return e.replace(vo,yo)}function yo(e,t,r,i){let n="";for(let e=parseInt(t);e<parseInt(r);e++)n+=i.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return n}function bo(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function xo(l,e,t,r){let h=l.getContext();var i,n=t.defines,a=t.vertexShader,s=t.fragmentShader,o=(e=>{let t="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===P?t="SHADOWMAP_TYPE_PCF":e.shadowMapType===C?t="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===I&&(t="SHADOWMAP_TYPE_VSM"),t})(t),c=(e=>{let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case U:case z:t="ENVMAP_TYPE_CUBE";break;case Fe:t="ENVMAP_TYPE_CUBE_UV"}return t})(t),u=(e=>{let t="ENVMAP_MODE_REFLECTION";return t=e.envMap&&e.envMapMode===z?"ENVMAP_MODE_REFRACTION":t})(t),d=(e=>{let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case T:t="ENVMAP_BLENDING_MULTIPLY";break;case E:t="ENVMAP_BLENDING_MIX";break;case D:t="ENVMAP_BLENDING_ADD"}return t})(t),m=null===(m=(m=t).envMapCubeUVHeight)?null:(i=Math.log2(m)-2,m=1/m,{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:m,maxMip:i}),p=t.isWebGL2?"":[(i=t).extensionDerivatives||i.envMapCubeUVHeight||i.bumpMap||i.normalMapTangentSpace||i.clearcoatNormalMap||i.flatShading||"physical"===i.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(i.extensionFragDepth||i.logarithmicDepthBuffer)&&i.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",i.extensionDrawBuffers&&i.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(i.extensionShaderTextureLOD||i.envMap||i.transmission)&&i.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(ho).join("\n"),n=(e=>{var t,r=[];for(t in e){var i=e[t];!1!==i&&r.push("#define "+t+" "+i)}return r.join("\n")})(n);let f=h.createProgram(),g,v,_=t.glslVersion?"#version "+t.glslVersion+"\n":"";t.isRawShaderMaterial?(0<(g=["#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,n].filter(ho).join("\n")).length&&(g+="\n"),0<(v=[p,"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,n].filter(ho).join("\n")).length&&(v+="\n")):(g=[bo(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,n,t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+u:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.mapUv?"#define MAP_UV "+t.mapUv:"",t.alphaMapUv?"#define ALPHAMAP_UV "+t.alphaMapUv:"",t.lightMapUv?"#define LIGHTMAP_UV "+t.lightMapUv:"",t.aoMapUv?"#define AOMAP_UV "+t.aoMapUv:"",t.emissiveMapUv?"#define EMISSIVEMAP_UV "+t.emissiveMapUv:"",t.bumpMapUv?"#define BUMPMAP_UV "+t.bumpMapUv:"",t.normalMapUv?"#define NORMALMAP_UV "+t.normalMapUv:"",t.displacementMapUv?"#define DISPLACEMENTMAP_UV "+t.displacementMapUv:"",t.metalnessMapUv?"#define METALNESSMAP_UV "+t.metalnessMapUv:"",t.roughnessMapUv?"#define ROUGHNESSMAP_UV "+t.roughnessMapUv:"",t.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+t.anisotropyMapUv:"",t.clearcoatMapUv?"#define CLEARCOATMAP_UV "+t.clearcoatMapUv:"",t.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+t.clearcoatNormalMapUv:"",t.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+t.clearcoatRoughnessMapUv:"",t.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+t.iridescenceMapUv:"",t.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+t.iridescenceThicknessMapUv:"",t.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+t.sheenColorMapUv:"",t.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+t.sheenRoughnessMapUv:"",t.specularMapUv?"#define SPECULARMAP_UV "+t.specularMapUv:"",t.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+t.specularColorMapUv:"",t.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+t.specularIntensityMapUv:"",t.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+t.transmissionMapUv:"",t.thicknessMapUv?"#define THICKNESSMAP_UV "+t.thicknessMapUv:"",t.vertexTangents&&!1===t.flatShading?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&!1===t.flatShading?"#define USE_MORPHNORMALS":"",t.morphColors&&t.isWebGL2?"#define USE_MORPHCOLORS":"",0<t.morphTargetsCount&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",0<t.morphTargetsCount&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+t.morphTextureStride:"",0<t.morphTargetsCount&&t.isWebGL2?"#define MORPHTARGETS_COUNT "+t.morphTargetsCount:"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+o:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",0<t.numLightProbes?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(ho).join("\n"),v=[p,bo(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,n,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+c:"",t.envMap?"#define "+u:"",t.envMap?"#define "+d:"",m?"#define CUBEUV_TEXEL_WIDTH "+m.texelWidth:"",m?"#define CUBEUV_TEXEL_HEIGHT "+m.texelHeight:"",m?"#define CUBEUV_MAX_MIP "+m.maxMip+".0":"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoat?"#define USE_CLEARCOAT":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaTest?"#define USE_ALPHATEST":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.sheen?"#define USE_SHEEN":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents&&!1===t.flatShading?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+o:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",0<t.numLightProbes?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==$e?"#define TONE_MAPPING":"",t.toneMapping!==$e?M.tonemapping_pars_fragment:"",t.toneMapping!==$e?((e,t)=>{let r;switch(t){case L:r="Linear";break;case O:r="Reinhard";break;case N:r="OptimizedCineon";break;case F:r="ACESFilmic";break;case B:r="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),r="Linear"}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"})("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",t.opaque?"#define OPAQUE":"",M.colorspace_pars_fragment,lo("linearToOutputTexel",t.outputColorSpace),t.useDepthPacking?"#define DEPTH_PACKING "+t.depthPacking:"","\n"].filter(ho).join("\n")),a=uo(co(po(a),t),t),s=uo(co(po(s),t),t),a=_o(a),s=_o(s),t.isWebGL2&&!0!==t.isRawShaderMaterial&&(_="#version 300 es\n",g=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["precision mediump sampler2DArray;","#define varying in",t.glslVersion===yr?"":"layout(location = 0) out highp vec4 pc_fragColor;",t.glslVersion===yr?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);p=_+g+a,n=_+v+s;let y=no(h,h.VERTEX_SHADER,p),b=no(h,h.FRAGMENT_SHADER,n);function x(r){if(l.debug.checkShaderErrors){var i,n,a=h.getProgramInfoLog(f).trim(),s=h.getShaderInfoLog(y).trim(),o=h.getShaderInfoLog(b).trim();let e=!0,t=!0;!1===h.getProgramParameter(f,h.LINK_STATUS)?(e=!1,"function"==typeof l.debug.onShaderError?l.debug.onShaderError(h,f,y,b):(i=oo(h,y,"vertex"),n=oo(h,b,"fragment"),console.error("THREE.WebGLProgram: Shader Error "+h.getError()+" - VALIDATE_STATUS "+h.getProgramParameter(f,h.VALIDATE_STATUS)+"\n\nProgram Info Log: "+a+"\n"+i+"\n"+n))):""!==a?console.warn("THREE.WebGLProgram: Program Info Log:",a):""!==s&&""!==o||(t=!1),t&&(r.diagnostics={runnable:e,programLog:a,vertexShader:{log:s,prefix:g},fragmentShader:{log:o,prefix:v}})}h.deleteShader(y),h.deleteShader(b),S=new io(h,f),w=((r,i)=>{var n={},e=r.getProgramParameter(i,r.ACTIVE_ATTRIBUTES);for(let t=0;t<e;t++){var a=r.getActiveAttrib(i,t),s=a.name;let e=1;a.type===r.FLOAT_MAT2&&(e=2),a.type===r.FLOAT_MAT3&&(e=3),a.type===r.FLOAT_MAT4&&(e=4),n[s]={type:a.type,location:r.getAttribLocation(i,s),locationSize:e}}return n})(h,f)}h.attachShader(f,y),h.attachShader(f,b),void 0!==t.index0AttributeName?h.bindAttribLocation(f,0,t.index0AttributeName):!0===t.morphTargets&&h.bindAttribLocation(f,0,"position"),h.linkProgram(f);let S;this.getUniforms=function(){return void 0===S&&x(this),S};let w,A=!(this.getAttributes=function(){return void 0===w&&x(this),w})===t.rendererExtensionParallelShaderCompile;return this.isReady=function(){return A=!1===A?h.getProgramParameter(f,ao):A},this.destroy=function(){r.releaseStatesOfProgram(this),h.deleteProgram(f),this.program=void 0},this.type=t.shaderType,this.name=t.shaderName,this.id=so++,this.cacheKey=e,this.usedTimes=1,this.program=f,this.vertexShader=y,this.fragmentShader=b,this}let So=0;class wo{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){var t=e.vertexShader,r=e.fragmentShader,t=this._getShaderStage(t),r=this._getShaderStage(r),e=this._getShaderCacheForMaterial(e);return!1===e.has(t)&&(e.add(t),t.usedTimes++),!1===e.has(r)&&(e.add(r),r.usedTimes++),this}remove(e){var t;for(t of this.materialCache.get(e))t.usedTimes--,0===t.usedTimes&&this.shaderCache.delete(t.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){var t=this.materialCache;let r=t.get(e);return void 0===r&&(r=new Set,t.set(e,r)),r}_getShaderStage(e){var t=this.shaderCache;let r=t.get(e);return void 0===r&&(r=new Ao(e),t.set(e,r)),r}}class Ao{constructor(e){this.id=So++,this.code=e,this.usedTimes=0}}function Mo(te,re,ie,ne,ae,t,se){let a=new Gi,oe=new wo,s=[],le=ae.isWebGL2,he=ae.logarithmicDepthBuffer,ce=ae.vertexTextures,ue=ae.precision,de={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function me(e){return 0===e?"uv":"uv"+e}return{getParameters:function(e,t,N,r,i){var n=r.fog,a=i.geometry,r=e.isMeshStandardMaterial?r.environment:null,F=(r=(e.isMeshStandardMaterial?ie:re).get(e.envMap||r))&&r.mapping===Fe?r.image.height:null,s=de[e.type];null!==e.precision&&(ue=ae.getMaxPrecision(e.precision))!==e.precision&&console.warn("THREE.WebGLProgram.getParameters:",e.precision,"not supported, using",ue,"instead.");var o=void 0!==(o=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color)?o.length:0;let l=0;void 0!==a.morphAttributes.position&&(l=1),void 0!==a.morphAttributes.normal&&(l=2),void 0!==a.morphAttributes.color&&(l=3);let h,c,u,d;s?(m=Aa[s],h=m.vertexShader,c=m.fragmentShader):(h=e.vertexShader,c=e.fragmentShader,oe.update(e),u=oe.getVertexShaderID(e),d=oe.getFragmentShaderID(e));var m=te.getRenderTarget(),p=!0===i.isInstancedMesh,f=!!e.map,B=!!e.matcap,g=!!r,v=!!e.aoMap,_=!!e.lightMap,y=!!e.bumpMap,b=!!e.normalMap,x=!!e.displacementMap,S=!!e.emissiveMap,w=!!e.metalnessMap,A=!!e.roughnessMap,M=0<e.anisotropy,C=0<e.clearcoat,T=0<e.iridescence,E=0<e.sheen,P=0<e.transmission,I=M&&!!e.anisotropyMap,R=C&&!!e.clearcoatMap,D=C&&!!e.clearcoatNormalMap,L=C&&!!e.clearcoatRoughnessMap,U=T&&!!e.iridescenceMap,z=T&&!!e.iridescenceThicknessMap,V=E&&!!e.sheenColorMap,G=E&&!!e.sheenRoughnessMap,H=!!e.specularMap,$=!!e.specularColorMap,j=!!e.specularIntensityMap,W=P&&!!e.transmissionMap,q=P&&!!e.thicknessMap,X=!!e.gradientMap,O=!!e.alphaMap,Y=0<e.alphaTest,K=!!e.alphaHash,k=!!e.extensions,Z=!!a.attributes.uv1,Q=!!a.attributes.uv2,J=!!a.attributes.uv3;let ee=$e;return!e.toneMapped||null!==m&&!0!==m.isXRRenderTarget||(ee=te.toneMapping),{isWebGL2:le,shaderID:s,shaderType:e.type,shaderName:e.name,vertexShader:h,fragmentShader:c,defines:e.defines,customVertexShaderID:u,customFragmentShaderID:d,isRawShaderMaterial:!0===e.isRawShaderMaterial,glslVersion:e.glslVersion,precision:ue,instancing:p,instancingColor:p&&null!==i.instanceColor,supportsVertexTextures:ce,outputColorSpace:null===m?te.outputColorSpace:!0===m.isXRRenderTarget?m.texture.colorSpace:tr,map:f,matcap:B,envMap:g,envMapMode:g&&r.mapping,envMapCubeUVHeight:F,aoMap:v,lightMap:_,bumpMap:y,normalMap:b,displacementMap:ce&&x,emissiveMap:S,normalMapObjectSpace:b&&e.normalMapType===Qt,normalMapTangentSpace:b&&e.normalMapType===Zt,metalnessMap:w,roughnessMap:A,anisotropy:M,anisotropyMap:I,clearcoat:C,clearcoatMap:R,clearcoatNormalMap:D,clearcoatRoughnessMap:L,iridescence:T,iridescenceMap:U,iridescenceThicknessMap:z,sheen:E,sheenColorMap:V,sheenRoughnessMap:G,specularMap:H,specularColorMap:$,specularIntensityMap:j,transmission:P,transmissionMap:W,thicknessMap:q,gradientMap:X,opaque:!1===e.transparent&&e.blending===fe,alphaMap:O,alphaTest:Y,alphaHash:K,combine:e.combine,mapUv:f&&me(e.map.channel),aoMapUv:v&&me(e.aoMap.channel),lightMapUv:_&&me(e.lightMap.channel),bumpMapUv:y&&me(e.bumpMap.channel),normalMapUv:b&&me(e.normalMap.channel),displacementMapUv:x&&me(e.displacementMap.channel),emissiveMapUv:S&&me(e.emissiveMap.channel),metalnessMapUv:w&&me(e.metalnessMap.channel),roughnessMapUv:A&&me(e.roughnessMap.channel),anisotropyMapUv:I&&me(e.anisotropyMap.channel),clearcoatMapUv:R&&me(e.clearcoatMap.channel),clearcoatNormalMapUv:D&&me(e.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:L&&me(e.clearcoatRoughnessMap.channel),iridescenceMapUv:U&&me(e.iridescenceMap.channel),iridescenceThicknessMapUv:z&&me(e.iridescenceThicknessMap.channel),sheenColorMapUv:V&&me(e.sheenColorMap.channel),sheenRoughnessMapUv:G&&me(e.sheenRoughnessMap.channel),specularMapUv:H&&me(e.specularMap.channel),specularColorMapUv:$&&me(e.specularColorMap.channel),specularIntensityMapUv:j&&me(e.specularIntensityMap.channel),transmissionMapUv:W&&me(e.transmissionMap.channel),thicknessMapUv:q&&me(e.thicknessMap.channel),alphaMapUv:O&&me(e.alphaMap.channel),vertexTangents:!!a.attributes.tangent&&(b||M),vertexColors:e.vertexColors,vertexAlphas:!0===e.vertexColors&&!!a.attributes.color&&4===a.attributes.color.itemSize,vertexUv1s:Z,vertexUv2s:Q,vertexUv3s:J,pointsUvs:!0===i.isPoints&&!!a.attributes.uv&&(f||O),fog:!!n,useFog:!0===e.fog,fogExp2:n&&n.isFogExp2,flatShading:!0===e.flatShading,sizeAttenuation:!0===e.sizeAttenuation,logarithmicDepthBuffer:he,skinning:!0===i.isSkinnedMesh,morphTargets:void 0!==a.morphAttributes.position,morphNormals:void 0!==a.morphAttributes.normal,morphColors:void 0!==a.morphAttributes.color,morphTargetsCount:o,morphTextureStride:l,numDirLights:t.directional.length,numPointLights:t.point.length,numSpotLights:t.spot.length,numSpotLightMaps:t.spotLightMap.length,numRectAreaLights:t.rectArea.length,numHemiLights:t.hemi.length,numDirLightShadows:t.directionalShadowMap.length,numPointLightShadows:t.pointShadowMap.length,numSpotLightShadows:t.spotShadowMap.length,numSpotLightShadowsWithMaps:t.numSpotLightShadowsWithMaps,numLightProbes:t.numLightProbes,numClippingPlanes:se.numPlanes,numClipIntersection:se.numIntersection,dithering:e.dithering,shadowMapEnabled:te.shadowMap.enabled&&0<N.length,shadowMapType:te.shadowMap.type,toneMapping:ee,useLegacyLights:te._useLegacyLights,decodeVideoTexture:f&&!0===e.map.isVideoTexture&&pe.getTransfer(e.map.colorSpace)===ar,premultipliedAlpha:e.premultipliedAlpha,doubleSided:e.side===He,flipSided:e.side===Ge,useDepthPacking:0<=e.depthPacking,depthPacking:e.depthPacking||0,index0AttributeName:e.index0AttributeName,extensionDerivatives:k&&!0===e.extensions.derivatives,extensionFragDepth:k&&!0===e.extensions.fragDepth,extensionDrawBuffers:k&&!0===e.extensions.drawBuffers,extensionShaderTextureLOD:k&&!0===e.extensions.shaderTextureLOD,rendererExtensionFragDepth:le||ne.has("EXT_frag_depth"),rendererExtensionDrawBuffers:le||ne.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:le||ne.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:ne.has("KHR_parallel_shader_compile"),customProgramCacheKey:e.customProgramCacheKey()}},getProgramCacheKey:function(e){var t,r,i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.customVertexShaderID),i.push(e.customFragmentShaderID)),void 0!==e.defines)for(var n in e.defines)i.push(n),i.push(e.defines[n]);return!1===e.isRawShaderMaterial&&((t=i).push((r=e).precision),t.push(r.outputColorSpace),t.push(r.envMapMode),t.push(r.envMapCubeUVHeight),t.push(r.mapUv),t.push(r.alphaMapUv),t.push(r.lightMapUv),t.push(r.aoMapUv),t.push(r.bumpMapUv),t.push(r.normalMapUv),t.push(r.displacementMapUv),t.push(r.emissiveMapUv),t.push(r.metalnessMapUv),t.push(r.roughnessMapUv),t.push(r.anisotropyMapUv),t.push(r.clearcoatMapUv),t.push(r.clearcoatNormalMapUv),t.push(r.clearcoatRoughnessMapUv),t.push(r.iridescenceMapUv),t.push(r.iridescenceThicknessMapUv),t.push(r.sheenColorMapUv),t.push(r.sheenRoughnessMapUv),t.push(r.specularMapUv),t.push(r.specularColorMapUv),t.push(r.specularIntensityMapUv),t.push(r.transmissionMapUv),t.push(r.thicknessMapUv),t.push(r.combine),t.push(r.fogExp2),t.push(r.sizeAttenuation),t.push(r.morphTargetsCount),t.push(r.morphAttributeCount),t.push(r.numDirLights),t.push(r.numPointLights),t.push(r.numSpotLights),t.push(r.numSpotLightMaps),t.push(r.numHemiLights),t.push(r.numRectAreaLights),t.push(r.numDirLightShadows),t.push(r.numPointLightShadows),t.push(r.numSpotLightShadows),t.push(r.numSpotLightShadowsWithMaps),t.push(r.numLightProbes),t.push(r.shadowMapType),t.push(r.toneMapping),t.push(r.numClippingPlanes),t.push(r.numClipIntersection),t.push(r.depthPacking),t=i,r=e,a.disableAll(),r.isWebGL2&&a.enable(0),r.supportsVertexTextures&&a.enable(1),r.instancing&&a.enable(2),r.instancingColor&&a.enable(3),r.matcap&&a.enable(4),r.envMap&&a.enable(5),r.normalMapObjectSpace&&a.enable(6),r.normalMapTangentSpace&&a.enable(7),r.clearcoat&&a.enable(8),r.iridescence&&a.enable(9),r.alphaTest&&a.enable(10),r.vertexColors&&a.enable(11),r.vertexAlphas&&a.enable(12),r.vertexUv1s&&a.enable(13),r.vertexUv2s&&a.enable(14),r.vertexUv3s&&a.enable(15),r.vertexTangents&&a.enable(16),r.anisotropy&&a.enable(17),r.alphaHash&&a.enable(18),t.push(a.mask),a.disableAll(),r.fog&&a.enable(0),r.useFog&&a.enable(1),r.flatShading&&a.enable(2),r.logarithmicDepthBuffer&&a.enable(3),r.skinning&&a.enable(4),r.morphTargets&&a.enable(5),r.morphNormals&&a.enable(6),r.morphColors&&a.enable(7),r.premultipliedAlpha&&a.enable(8),r.shadowMapEnabled&&a.enable(9),r.useLegacyLights&&a.enable(10),r.doubleSided&&a.enable(11),r.flipSided&&a.enable(12),r.useDepthPacking&&a.enable(13),r.dithering&&a.enable(14),r.transmission&&a.enable(15),r.sheen&&a.enable(16),r.opaque&&a.enable(17),r.pointsUvs&&a.enable(18),r.decodeVideoTexture&&a.enable(19),t.push(a.mask),i.push(te.outputColorSpace)),i.push(e.customProgramCacheKey),i.join()},getUniforms:function(e){var t=de[e.type];let r;return r=t?(t=Aa[t],oa.clone(t.uniforms)):e.uniforms},acquireProgram:function(e,r){let i;for(let e=0,t=s.length;e<t;e++){var n=s[e];if(n.cacheKey===r){++(i=n).usedTimes;break}}return void 0===i&&(i=new xo(te,r,e,t),s.push(i)),i},releaseProgram:function(e){var t;0==--e.usedTimes&&(t=s.indexOf(e),s[t]=s[s.length-1],s.pop(),e.destroy())},releaseShaderCache:function(e){oe.remove(e)},programs:s,dispose:function(){oe.dispose()}}}function Co(){let i=new WeakMap;return{get:function(e){let t=i.get(e);return void 0===t&&(t={},i.set(e,t)),t},remove:function(e){i.delete(e)},update:function(e,t,r){i.get(e)[t]=r},dispose:function(){i=new WeakMap}}}function To(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Eo(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Po(){let o=[],l=0,s=[],h=[],c=[];function u(e,t,r,i,n,a){let s=o[l];return void 0===s?(s={id:e.id,object:e,geometry:t,material:r,groupOrder:i,renderOrder:e.renderOrder,z:n,group:a},o[l]=s):(s.id=e.id,s.object=e,s.geometry=t,s.material=r,s.groupOrder=i,s.renderOrder=e.renderOrder,s.z=n,s.group=a),l++,s}return{opaque:s,transmissive:h,transparent:c,init:function(){l=0,s.length=0,h.length=0,c.length=0},push:function(e,t,r,i,n,a){e=u(e,t,r,i,n,a),(0<r.transmission?h:!0===r.transparent?c:s).push(e)},unshift:function(e,t,r,i,n,a){e=u(e,t,r,i,n,a),(0<r.transmission?h:!0===r.transparent?c:s).unshift(e)},finish:function(){for(let e=l,t=o.length;e<t;e++){var r=o[e];if(null===r.id)break;r.id=null,r.object=null,r.geometry=null,r.material=null,r.group=null}},sort:function(e,t){1<s.length&&s.sort(e||To),1<h.length&&h.sort(t||Eo),1<c.length&&c.sort(t||Eo)}}}function Io(){let n=new WeakMap;return{get:function(e,t){var r=n.get(e);let i;return void 0===r?(i=new Po,n.set(e,[i])):t>=r.length?(i=new Po,r.push(i)):i=r[t],i},dispose:function(){n=new WeakMap}}}function Ro(){let r={};return{get:function(e){if(void 0!==r[e.id])return r[e.id];let t;switch(e.type){case"DirectionalLight":t={direction:new et,color:new ze};break;case"SpotLight":t={position:new et,direction:new et,color:new ze,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new et,color:new ze,distance:0,decay:0};break;case"HemisphereLight":t={direction:new et,skyColor:new ze,groundColor:new ze};break;case"RectAreaLight":t={color:new ze,position:new et,halfWidth:new et,halfHeight:new et}}return r[e.id]=t}}}let Do=0;function Lo(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Oo(t,T){let E=new Ro,P=(()=>{let r={};return{get:function(e){if(void 0!==r[e.id])return r[e.id];let t;switch(e.type){case"DirectionalLight":case"SpotLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ue};break;case"PointLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ue,shadowCameraNear:1,shadowCameraFar:1e3}}return r[e.id]=t}}})(),I={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)I.probe.push(new et);let m=new et,p=new tt,f=new tt;return{setup:function(r,e){let i=0,n=0,a=0;for(let e=0;e<9;e++)I.probe[e].set(0,0,0);let s=0,o=0,l=0,h=0,c=0,u=0,d=0,m=0,p=0,f=0,g=0;r.sort(Lo);var v=!0===e?Math.PI:1;for(let e=0,t=r.length;e<t;e++){var _,y,b,x,S=r[e],w=S.color,A=S.intensity,M=S.distance,C=S.shadow&&S.shadow.map?S.shadow.map.texture:null;if(S.isAmbientLight)i+=w.r*A*v,n+=w.g*A*v,a+=w.b*A*v;else if(S.isLightProbe){for(let e=0;e<9;e++)I.probe[e].addScaledVector(S.sh.coefficients[e],A);g++}else S.isDirectionalLight?((b=E.get(S)).color.copy(S.color).multiplyScalar(S.intensity*v),S.castShadow&&(_=S.shadow,(y=P.get(S)).shadowBias=_.bias,y.shadowNormalBias=_.normalBias,y.shadowRadius=_.radius,y.shadowMapSize=_.mapSize,I.directionalShadow[s]=y,I.directionalShadowMap[s]=C,I.directionalShadowMatrix[s]=S.shadow.matrix,u++),I.directional[s]=b,s++):S.isSpotLight?((_=E.get(S)).position.setFromMatrixPosition(S.matrixWorld),_.color.copy(w).multiplyScalar(A*v),_.distance=M,_.coneCos=Math.cos(S.angle),_.penumbraCos=Math.cos(S.angle*(1-S.penumbra)),_.decay=S.decay,I.spot[l]=_,y=S.shadow,S.map&&(I.spotLightMap[p]=S.map,p++,y.updateMatrices(S),S.castShadow)&&f++,I.spotLightMatrix[l]=y.matrix,S.castShadow&&((b=P.get(S)).shadowBias=y.bias,b.shadowNormalBias=y.normalBias,b.shadowRadius=y.radius,b.shadowMapSize=y.mapSize,I.spotShadow[l]=b,I.spotShadowMap[l]=C,m++),l++):S.isRectAreaLight?((M=E.get(S)).color.copy(w).multiplyScalar(A),M.halfWidth.set(.5*S.width,0,0),M.halfHeight.set(0,.5*S.height,0),I.rectArea[h]=M,h++):S.isPointLight?((w=E.get(S)).color.copy(S.color).multiplyScalar(S.intensity*v),w.distance=S.distance,w.decay=S.decay,S.castShadow&&(M=S.shadow,(x=P.get(S)).shadowBias=M.bias,x.shadowNormalBias=M.normalBias,x.shadowRadius=M.radius,x.shadowMapSize=M.mapSize,x.shadowCameraNear=M.camera.near,x.shadowCameraFar=M.camera.far,I.pointShadow[o]=x,I.pointShadowMap[o]=C,I.pointShadowMatrix[o]=S.shadow.matrix,d++),I.point[o]=w,o++):S.isHemisphereLight&&((M=E.get(S)).skyColor.copy(S.color).multiplyScalar(A*v),M.groundColor.copy(S.groundColor).multiplyScalar(A*v),I.hemi[c]=M,c++)}0<h&&(T.isWebGL2||!0===t.has("OES_texture_float_linear")?(I.rectAreaLTC1=R.LTC_FLOAT_1,I.rectAreaLTC2=R.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(I.rectAreaLTC1=R.LTC_HALF_1,I.rectAreaLTC2=R.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),I.ambient[0]=i,I.ambient[1]=n,I.ambient[2]=a,(e=I.hash).directionalLength===s&&e.pointLength===o&&e.spotLength===l&&e.rectAreaLength===h&&e.hemiLength===c&&e.numDirectionalShadows===u&&e.numPointShadows===d&&e.numSpotShadows===m&&e.numSpotMaps===p&&e.numLightProbes===g||(I.directional.length=s,I.spot.length=l,I.rectArea.length=h,I.point.length=o,I.hemi.length=c,I.directionalShadow.length=u,I.directionalShadowMap.length=u,I.pointShadow.length=d,I.pointShadowMap.length=d,I.spotShadow.length=m,I.spotShadowMap.length=m,I.directionalShadowMatrix.length=u,I.pointShadowMatrix.length=d,I.spotLightMatrix.length=m+p-f,I.spotLightMap.length=p,I.numSpotLightShadowsWithMaps=f,I.numLightProbes=g,e.directionalLength=s,e.pointLength=o,e.spotLength=l,e.rectAreaLength=h,e.hemiLength=c,e.numDirectionalShadows=u,e.numPointShadows=d,e.numSpotShadows=m,e.numSpotMaps=p,e.numLightProbes=g,I.version=Do++)},setupView:function(r,e){let i=0,n=0,a=0,s=0,o=0;var l=e.matrixWorldInverse;for(let e=0,t=r.length;e<t;e++){var h,c,u,d=r[e];d.isDirectionalLight?((h=I.directional[i]).direction.setFromMatrixPosition(d.matrixWorld),m.setFromMatrixPosition(d.target.matrixWorld),h.direction.sub(m),h.direction.transformDirection(l),i++):d.isSpotLight?((h=I.spot[a]).position.setFromMatrixPosition(d.matrixWorld),h.position.applyMatrix4(l),h.direction.setFromMatrixPosition(d.matrixWorld),m.setFromMatrixPosition(d.target.matrixWorld),h.direction.sub(m),h.direction.transformDirection(l),a++):d.isRectAreaLight?((c=I.rectArea[s]).position.setFromMatrixPosition(d.matrixWorld),c.position.applyMatrix4(l),f.identity(),p.copy(d.matrixWorld),p.premultiply(l),f.extractRotation(p),c.halfWidth.set(.5*d.width,0,0),c.halfHeight.set(0,.5*d.height,0),c.halfWidth.applyMatrix4(f),c.halfHeight.applyMatrix4(f),s++):d.isPointLight?((c=I.point[n]).position.setFromMatrixPosition(d.matrixWorld),c.position.applyMatrix4(l),n++):d.isHemisphereLight&&((u=I.hemi[o]).direction.setFromMatrixPosition(d.matrixWorld),u.direction.transformDirection(l),o++)}},state:I}}function ko(e,t){let r=new Oo(e,t),i=[],n=[];return{init:function(){i.length=0,n.length=0},state:{lightsArray:i,shadowsArray:n,lights:r},setupLights:function(e){r.setup(i,e)},setupLightsView:function(e){r.setupView(i,e)},pushLight:function(e){i.push(e)},pushShadow:function(e){n.push(e)}}}function No(n,a){let s=new WeakMap;return{get:function(e,t=0){var r=s.get(e);let i;return void 0===r?(i=new ko(n,a),s.set(e,[i])):t>=r.length?(i=new ko(n,a),r.push(i)):i=r[t],i},dispose:function(){s=new WeakMap}}}class Fo extends Sn{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class Bo extends Sn{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}let Uo="void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",zo="uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}";function Vo(g,v,e){let _=new ba,y=new Ue,b=new Ue,x=new Zr,s=new Fo({depthPacking:Kt}),o=new Bo,l={},S=e.maxTextureSize,h={[Ve]:Ge,[Ge]:Ve,[He]:He},w=new la({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Ue},radius:{value:4}},vertexShader:Uo,fragmentShader:zo}),A=w.clone();A.defines.HORIZONTAL_PASS=1;e=new Fn;e.setAttribute("position",new Cn(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));let M=new ta(e,w),C=this,T=(this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=P,this.type);function E(r,i,e,t){let n=null;r=!0===e.isPointLight?r.customDistanceMaterial:r.customDepthMaterial;if(void 0!==r)n=r;else if(n=!0===e.isPointLight?o:s,g.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&0<i.alphaTest||i.map&&0<i.alphaTest){var r=n.uuid,a=i.uuid;let e=l[r],t=(void 0===e&&(e={},l[r]=e),e[a]);void 0===t&&(t=n.clone(),e[a]=t),n=t}return n.visible=i.visible,n.wireframe=i.wireframe,t===I?n.side=null!==i.shadowSide?i.shadowSide:i.side:n.side=null!==i.shadowSide?i.shadowSide:h[i.side],n.alphaMap=i.alphaMap,n.alphaTest=i.alphaTest,n.map=i.map,n.clipShadows=i.clipShadows,n.clippingPlanes=i.clippingPlanes,n.clipIntersection=i.clipIntersection,n.displacementMap=i.displacementMap,n.displacementScale=i.displacementScale,n.displacementBias=i.displacementBias,n.wireframeLinewidth=i.wireframeLinewidth,n.linewidth=i.linewidth,!0===e.isPointLight&&!0===n.isMeshDistanceMaterial&&(g.properties.get(n).light=e),n}this.render=function(r,i,n){if(!1!==C.enabled&&(!1!==C.autoUpdate||!1!==C.needsUpdate)&&0!==r.length){var e=g.getRenderTarget(),t=g.getActiveCubeFace(),a=g.getActiveMipmapLevel(),s=g.state,o=(s.setBlending(ee),s.buffers.color.setClear(1,1,1,1),s.buffers.depth.setTest(!0),s.setScissorTest(!1),T!==I&&this.type===I),l=T===I&&this.type!==I;for(let e=0,t=r.length;e<t;e++){var h=r[e],c=h.shadow;if(void 0===c)console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");else if(!1!==c.autoUpdate||!1!==c.needsUpdate){y.copy(c.mapSize);var u,d,m=c.getFrameExtents(),p=(y.multiply(m),b.copy(c.mapSize),(y.x>S||y.y>S)&&(y.x>S&&(b.x=Math.floor(S/m.x),y.x=b.x*m.x,c.mapSize.x=b.x),y.y>S)&&(b.y=Math.floor(S/m.y),y.y=b.y*m.y,c.mapSize.y=b.y),null!==c.map&&!0!=o&&!0!=l||(m=this.type!==I?{minFilter:q,magFilter:q}:{},null!==c.map&&c.map.dispose(),c.map=new Jr(y.x,y.y,m),c.map.texture.name=h.name+".shadowMap",c.camera.updateProjectionMatrix()),g.setRenderTarget(c.map),g.clear(),c.getViewportCount());for(let e=0;e<p;e++){var f=c.getViewport(e);x.set(b.x*f.x,b.y*f.y,b.x*f.z,b.y*f.w),s.viewport(x),c.updateMatrices(h,e),_=c.getFrustum(),!function r(s,i,o,l,h){if(!1===s.visible)return;let e=s.layers.test(i.layers);if(e&&(s.isMesh||s.isLine||s.isPoints)&&(s.castShadow||s.receiveShadow&&h===I)&&(!s.frustumCulled||_.intersectsObject(s))){s.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,s.matrixWorld);let n=v.update(s),a=s.material;if(Array.isArray(a)){let i=n.groups;for(let e=0,t=i.length;e<t;e++){let t=i[e],r=a[t.materialIndex];if(r&&r.visible){let e=E(s,r,l,h);g.renderBufferDirect(o,null,n,e,s,t)}}}else if(a.visible){let e=E(s,a,l,h);g.renderBufferDirect(o,null,n,e,s,null)}}let n=s.children;for(let e=0,t=n.length;e<t;e++)r(n[e],i,o,l,h)}(i,n,c.camera,h,this.type)}!0!==c.isPointLightShadow&&this.type===I&&(d=u=m=void 0,m=c,u=n,d=v.update(M),w.defines.VSM_SAMPLES!==m.blurSamples&&(w.defines.VSM_SAMPLES=m.blurSamples,A.defines.VSM_SAMPLES=m.blurSamples,w.needsUpdate=!0,A.needsUpdate=!0),null===m.mapPass&&(m.mapPass=new Jr(y.x,y.y)),w.uniforms.shadow_pass.value=m.map.texture,w.uniforms.resolution.value=m.mapSize,w.uniforms.radius.value=m.radius,g.setRenderTarget(m.mapPass),g.clear(),g.renderBufferDirect(u,null,d,w,M,null),A.uniforms.shadow_pass.value=m.mapPass.texture,A.uniforms.resolution.value=m.mapSize,A.uniforms.radius.value=m.radius,g.setRenderTarget(m.map),g.clear(),g.renderBufferDirect(u,null,d,A,M,null)),c.needsUpdate=!1}}T=this.type,C.needsUpdate=!1,g.setRenderTarget(e,t,a)}}}function Go(c,N,F){let s=F.isWebGL2;let i=new function(){let t=!1,a=new Zr,r=null,s=new Zr(0,0,0,0);return{setMask:function(e){r===e||t||(c.colorMask(e,e,e,e),r=e)},setLocked:function(e){t=e},setClear:function(e,t,r,i,n){!0===n&&(e*=i,t*=i,r*=i),a.set(e,t,r,i),!1===s.equals(a)&&(c.clearColor(e,t,r,i),s.copy(a))},reset:function(){t=!1,r=null,s.set(-1,0,0,0)}}},n=new function(){let t=!1,r=null,i=null,n=null;return{setTest:function(e){(e?R:D)(c.DEPTH_TEST)},setMask:function(e){r===e||t||(c.depthMask(e),r=e)},setFunc:function(e){if(i!==e){switch(e){case Pe:c.depthFunc(c.NEVER);break;case Ie:c.depthFunc(c.ALWAYS);break;case Re:c.depthFunc(c.LESS);break;case De:c.depthFunc(c.LEQUAL);break;case Le:c.depthFunc(c.EQUAL);break;case Oe:c.depthFunc(c.GEQUAL);break;case ke:c.depthFunc(c.GREATER);break;case Ne:c.depthFunc(c.NOTEQUAL);break;default:c.depthFunc(c.LEQUAL)}i=e}},setLocked:function(e){t=e},setClear:function(e){n!==e&&(c.clearDepth(e),n=e)},reset:function(){t=!1,r=null,i=null,n=null}}},a=new function(){let t=!1,r=null,i=null,n=null,a=null,s=null,o=null,l=null,h=null;return{setTest:function(e){t||(e?R:D)(c.STENCIL_TEST)},setMask:function(e){r===e||t||(c.stencilMask(e),r=e)},setFunc:function(e,t,r){i===e&&n===t&&a===r||(c.stencilFunc(e,t,r),i=e,n=t,a=r)},setOp:function(e,t,r){s===e&&o===t&&l===r||(c.stencilOp(e,t,r),s=e,o=t,l=r)},setLocked:function(e){t=e},setClear:function(e){h!==e&&(c.clearStencil(e),h=e)},reset:function(){t=!1,r=null,i=null,n=null,a=null,s=null,o=null,l=null,h=null}}},B=new WeakMap,o=new WeakMap,t={},r={},l=new WeakMap,U=[],h=null,u=!1,d=null,m=null,p=null,f=null,g=null,v=null,_=null,y=new ze(0,0,0),b=0,x=!1,S=null,w=null,A=null,M=null,z=null,V=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),G=!1,e=0;var C=c.getParameter(c.VERSION);-1!==C.indexOf("WebGL")?(e=parseFloat(/^WebGL (\d)/.exec(C)[1]),G=1<=e):-1!==C.indexOf("OpenGL ES")&&(e=parseFloat(/^OpenGL ES (\d)/.exec(C)[1]),G=2<=e);let T=null,E={};var C=c.getParameter(c.SCISSOR_BOX),H=c.getParameter(c.VIEWPORT);let $=(new Zr).fromArray(C),j=(new Zr).fromArray(H);function P(t,r,i,n){var a=new Uint8Array(4),e=c.createTexture();c.bindTexture(t,e),c.texParameteri(t,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(t,c.TEXTURE_MAG_FILTER,c.NEAREST);for(let e=0;e<i;e++)!s||t!==c.TEXTURE_3D&&t!==c.TEXTURE_2D_ARRAY?c.texImage2D(r+e,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a):c.texImage3D(r,0,c.RGBA,1,1,n,0,c.RGBA,c.UNSIGNED_BYTE,a);return e}let I={};function R(e){!0!==t[e]&&(c.enable(e),t[e]=!0)}function D(e){!1!==t[e]&&(c.disable(e),t[e]=!1)}I[c.TEXTURE_2D]=P(c.TEXTURE_2D,c.TEXTURE_2D,1),I[c.TEXTURE_CUBE_MAP]=P(c.TEXTURE_CUBE_MAP,c.TEXTURE_CUBE_MAP_POSITIVE_X,6),s&&(I[c.TEXTURE_2D_ARRAY]=P(c.TEXTURE_2D_ARRAY,c.TEXTURE_2D_ARRAY,1,1),I[c.TEXTURE_3D]=P(c.TEXTURE_3D,c.TEXTURE_3D,1,1)),i.setClear(0,0,0,1),n.setClear(1),a.setClear(0),R(c.DEPTH_TEST),n.setFunc(De),W(!1),q(K),R(c.CULL_FACE),k(ee);let L={[ae]:c.FUNC_ADD,[se]:c.FUNC_SUBTRACT,[oe]:c.FUNC_REVERSE_SUBTRACT},O=(s?(L[le]=c.MIN,L[he]=c.MAX):null!==(C=N.get("EXT_blend_minmax"))&&(L[le]=C.MIN_EXT,L[he]=C.MAX_EXT),{[de]:c.ZERO,[me]:c.ONE,[ge]:c.SRC_COLOR,[_e]:c.SRC_ALPHA,[Ae]:c.SRC_ALPHA_SATURATE,[Se]:c.DST_COLOR,[be]:c.DST_ALPHA,[ve]:c.ONE_MINUS_SRC_COLOR,[ye]:c.ONE_MINUS_SRC_ALPHA,[we]:c.ONE_MINUS_DST_COLOR,[xe]:c.ONE_MINUS_DST_ALPHA,[Me]:c.CONSTANT_COLOR,[Ce]:c.ONE_MINUS_CONSTANT_COLOR,[Te]:c.CONSTANT_ALPHA,[Ee]:c.ONE_MINUS_CONSTANT_ALPHA});function k(e,t,r,i,n,a,s,o,l,h){if(e===ee)!0===u&&(D(c.BLEND),u=!1);else if(!1===u&&(R(c.BLEND),u=!0),e!==ne){if(e!==d||h!==x){if(m===ae&&g===ae||(c.blendEquation(c.FUNC_ADD),m=ae,g=ae),h)switch(e){case fe:c.blendFuncSeparate(c.ONE,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA);break;case te:c.blendFunc(c.ONE,c.ONE);break;case re:c.blendFuncSeparate(c.ZERO,c.ONE_MINUS_SRC_COLOR,c.ZERO,c.ONE);break;case ie:c.blendFuncSeparate(c.ZERO,c.SRC_COLOR,c.ZERO,c.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case fe:c.blendFuncSeparate(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA);break;case te:c.blendFunc(c.SRC_ALPHA,c.ONE);break;case re:c.blendFuncSeparate(c.ZERO,c.ONE_MINUS_SRC_COLOR,c.ZERO,c.ONE);break;case ie:c.blendFunc(c.ZERO,c.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}p=null,f=null,v=null,_=null,y.set(0,0,0),b=0,d=e,x=h}}else n=n||t,a=a||r,s=s||i,t===m&&n===g||(c.blendEquationSeparate(L[t],L[n]),m=t,g=n),r===p&&i===f&&a===v&&s===_||(c.blendFuncSeparate(O[r],O[i],O[a],O[s]),p=r,f=i,v=a,_=s),!1!==o.equals(y)&&l===b||(c.blendColor(o.r,o.g,o.b,l),y.copy(o),b=l),d=e,x=!1}function W(e){S!==e&&(e?c.frontFace(c.CW):c.frontFace(c.CCW),S=e)}function q(e){e!==Y?(R(c.CULL_FACE),e!==w&&(e===K?c.cullFace(c.BACK):e===Z?c.cullFace(c.FRONT):c.cullFace(c.FRONT_AND_BACK))):D(c.CULL_FACE),w=e}function X(e,t,r){e?(R(c.POLYGON_OFFSET_FILL),M===t&&z===r||(c.polygonOffset(t,r),M=t,z=r)):D(c.POLYGON_OFFSET_FILL)}return{buffers:{color:i,depth:n,stencil:a},enable:R,disable:D,bindFramebuffer:function(e,t){return r[e]!==t&&(c.bindFramebuffer(e,t),r[e]=t,s&&(e===c.DRAW_FRAMEBUFFER&&(r[c.FRAMEBUFFER]=t),e===c.FRAMEBUFFER)&&(r[c.DRAW_FRAMEBUFFER]=t),!0)},drawBuffers:function(e,r){let i=U,t=!1;if(e)if(void 0===(i=l.get(r))&&(i=[],l.set(r,i)),e.isWebGLMultipleRenderTargets){r=e.texture;if(i.length!==r.length||i[0]!==c.COLOR_ATTACHMENT0){for(let e=0,t=r.length;e<t;e++)i[e]=c.COLOR_ATTACHMENT0+e;i.length=r.length,t=!0}}else i[0]!==c.COLOR_ATTACHMENT0&&(i[0]=c.COLOR_ATTACHMENT0,t=!0);else i[0]!==c.BACK&&(i[0]=c.BACK,t=!0);t&&(F.isWebGL2?c.drawBuffers(i):N.get("WEBGL_draw_buffers").drawBuffersWEBGL(i))},useProgram:function(e){return h!==e&&(c.useProgram(e),h=e,!0)},setBlending:k,setMaterial:function(e,t){(e.side===He?D:R)(c.CULL_FACE);let r=e.side===Ge;W(r=t?!r:r),e.blending===fe&&!1===e.transparent?k(ee):k(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.blendColor,e.blendAlpha,e.premultipliedAlpha),n.setFunc(e.depthFunc),n.setTest(e.depthTest),n.setMask(e.depthWrite),i.setMask(e.colorWrite),t=e.stencilWrite,a.setTest(t),t&&(a.setMask(e.stencilWriteMask),a.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),a.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),X(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),(!0===e.alphaToCoverage?R:D)(c.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:W,setCullFace:q,setLineWidth:function(e){e!==A&&(G&&c.lineWidth(e),A=e)},setPolygonOffset:X,setScissorTest:function(e){(e?R:D)(c.SCISSOR_TEST)},activeTexture:function(e){void 0===e&&(e=c.TEXTURE0+V-1),T!==e&&(c.activeTexture(e),T=e)},bindTexture:function(e,t,r){void 0===r&&(r=null===T?c.TEXTURE0+V-1:T);let i=E[r];void 0===i&&(i={type:void 0,texture:void 0},E[r]=i),i.type===e&&i.texture===t||(T!==r&&(c.activeTexture(r),T=r),c.bindTexture(e,t||I[e]),i.type=e,i.texture=t)},unbindTexture:function(){var e=E[T];void 0!==e&&void 0!==e.type&&(c.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{c.compressedTexImage2D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{c.compressedTexImage3D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{c.texImage2D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{c.texImage3D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(e,t){let r=o.get(t);void 0===r&&(r=new WeakMap,o.set(t,r)),void 0===r.get(e)&&(t=c.getUniformBlockIndex(t,e.name),r.set(e,t))},uniformBlockBinding:function(e,t){var r=o.get(t).get(e);B.get(t)!==r&&(c.uniformBlockBinding(t,r,e.__bindingPointIndex),B.set(t,r))},texStorage2D:function(){try{c.texStorage2D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{c.texStorage3D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{c.texSubImage2D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{c.texSubImage3D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{c.compressedTexSubImage2D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{c.compressedTexSubImage3D.apply(c,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(e){!1===$.equals(e)&&(c.scissor(e.x,e.y,e.z,e.w),$.copy(e))},viewport:function(e){!1===j.equals(e)&&(c.viewport(e.x,e.y,e.z,e.w),j.copy(e))},reset:function(){c.disable(c.BLEND),c.disable(c.CULL_FACE),c.disable(c.DEPTH_TEST),c.disable(c.POLYGON_OFFSET_FILL),c.disable(c.SCISSOR_TEST),c.disable(c.STENCIL_TEST),c.disable(c.SAMPLE_ALPHA_TO_COVERAGE),c.blendEquation(c.FUNC_ADD),c.blendFunc(c.ONE,c.ZERO),c.blendFuncSeparate(c.ONE,c.ZERO,c.ONE,c.ZERO),c.blendColor(0,0,0,0),c.colorMask(!0,!0,!0,!0),c.clearColor(0,0,0,0),c.depthMask(!0),c.depthFunc(c.LESS),c.clearDepth(1),c.stencilMask(4294967295),c.stencilFunc(c.ALWAYS,0,4294967295),c.stencilOp(c.KEEP,c.KEEP,c.KEEP),c.clearStencil(0),c.cullFace(c.BACK),c.frontFace(c.CCW),c.polygonOffset(0,0),c.activeTexture(c.TEXTURE0),c.bindFramebuffer(c.FRAMEBUFFER,null),!0===s&&(c.bindFramebuffer(c.DRAW_FRAMEBUFFER,null),c.bindFramebuffer(c.READ_FRAMEBUFFER,null)),c.useProgram(null),c.lineWidth(1),c.scissor(0,0,c.canvas.width,c.canvas.height),c.viewport(0,0,c.canvas.width,c.canvas.height),t={},T=null,E={},r={},l=new WeakMap,U=[],h=null,u=!1,d=null,m=null,p=null,f=null,g=null,v=null,_=null,y=new ze(0,0,0),b=0,x=!1,S=null,w=null,A=null,M=null,z=null,$.set(0,0,c.canvas.width,c.canvas.height),j.set(0,0,c.canvas.width,c.canvas.height),i.reset(),n.reset(),a.reset()}}}function Ho(y,s,b,x,f,S,g){let w=f.isWebGL2,t=f.maxTextures,F=f.maxCubemapSize,B=f.maxTextureSize,U=f.maxSamples,u=s.has("WEBGL_multisampled_render_to_texture")?s.get("WEBGL_multisampled_render_to_texture"):null,z="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),a=new WeakMap,o,l=new WeakMap,r=!1;try{r="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function h(e,t){return r?new OffscreenCanvas(e,t):kr("canvas")}function A(e,t,r,i){let n=1;return(n=e.width>i||e.height>i?i/Math.max(e.width,e.height):n)<1||!0===t?"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?(t=(i=t?Ir:Math.floor)(n*e.width),i=i(n*e.height),void 0===o&&(o=h(t,i)),(r=r?h(t,i):o).width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,t,i),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+t+"x"+i+")."),r):("data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e):e}function M(e){return Pr(e.width)&&Pr(e.height)}function C(e,t){return e.generateMipmaps&&t&&e.minFilter!==q&&e.minFilter!==je}function T(e){y.generateMipmap(e)}function E(e,t,r,i,n=!1){if(!1===w)return t;if(null!==e){if(void 0!==y[e])return y[e];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+e+"'")}let a=t;return t===y.RED&&(r===y.FLOAT&&(a=y.R32F),r===y.HALF_FLOAT&&(a=y.R16F),r===y.UNSIGNED_BYTE)&&(a=y.R8),t===y.RED_INTEGER&&(r===y.UNSIGNED_BYTE&&(a=y.R8UI),r===y.UNSIGNED_SHORT&&(a=y.R16UI),r===y.UNSIGNED_INT&&(a=y.R32UI),r===y.BYTE&&(a=y.R8I),r===y.SHORT&&(a=y.R16I),r===y.INT)&&(a=y.R32I),t===y.RG&&(r===y.FLOAT&&(a=y.RG32F),r===y.HALF_FLOAT&&(a=y.RG16F),r===y.UNSIGNED_BYTE)&&(a=y.RG8),(a=t===y.RGBA&&(e=n?nr:pe.getTransfer(i),r===y.FLOAT&&(a=y.RGBA32F),r===y.HALF_FLOAT&&(a=y.RGBA16F),r===y.UNSIGNED_BYTE&&(a=e===ar?y.SRGB8_ALPHA8:y.RGBA8),r===y.UNSIGNED_SHORT_4_4_4_4&&(a=y.RGBA4),r===y.UNSIGNED_SHORT_5_5_5_1)?y.RGB5_A1:a)!==y.R16F&&a!==y.R32F&&a!==y.RG16F&&a!==y.RG32F&&a!==y.RGBA16F&&a!==y.RGBA32F||s.get("EXT_color_buffer_float"),a}function P(e,t,r){return!0===C(e,r)||e.isFramebufferTexture&&e.minFilter!==q&&e.minFilter!==je?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&0<e.mipmaps.length?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function i(e){return e===q||e===X||e===Be?y.NEAREST:y.LINEAR}function c(e){var t,r,i,n,e=e.target;e.removeEventListener("dispose",c),t=e,void 0!==(r=x.get(t)).__webglInit&&(i=t.source,(n=l.get(i))&&((r=n[r.__cacheKey]).usedTimes--,0===r.usedTimes&&d(t),0===Object.keys(n).length)&&l.delete(i),x.remove(t)),e.isVideoTexture&&a.delete(e)}function v(e){var e=e.target,r=(e.removeEventListener("dispose",v),e.texture),i=x.get(e),t=x.get(r);if(void 0!==t.__webglTexture&&(y.deleteTexture(t.__webglTexture),g.memory.textures--),e.depthTexture&&e.depthTexture.dispose(),e.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(i.__webglFramebuffer[t]))for(let e=0;e<i.__webglFramebuffer[t].length;e++)y.deleteFramebuffer(i.__webglFramebuffer[t][e]);else y.deleteFramebuffer(i.__webglFramebuffer[t]);i.__webglDepthbuffer&&y.deleteRenderbuffer(i.__webglDepthbuffer[t])}else{if(Array.isArray(i.__webglFramebuffer))for(let e=0;e<i.__webglFramebuffer.length;e++)y.deleteFramebuffer(i.__webglFramebuffer[e]);else y.deleteFramebuffer(i.__webglFramebuffer);if(i.__webglDepthbuffer&&y.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&y.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer)for(let e=0;e<i.__webglColorRenderbuffer.length;e++)i.__webglColorRenderbuffer[e]&&y.deleteRenderbuffer(i.__webglColorRenderbuffer[e]);i.__webglDepthRenderbuffer&&y.deleteRenderbuffer(i.__webglDepthRenderbuffer)}if(e.isWebGLMultipleRenderTargets)for(let e=0,t=r.length;e<t;e++){var n=x.get(r[e]);n.__webglTexture&&(y.deleteTexture(n.__webglTexture),g.memory.textures--),x.remove(r[e])}x.remove(r),x.remove(e)}function d(e){var t=x.get(e),e=(y.deleteTexture(t.__webglTexture),e.source);delete l.get(e)[t.__cacheKey],g.memory.textures--}let n=0;function m(e,t){var r,i=x.get(e);if(e.isVideoTexture&&(r=e,n=g.render.frame,a.get(r)!==n)&&(a.set(r,n),r.update()),!1===e.isRenderTargetTexture&&0<e.version&&i.__version!==e.version){var n=e.image;if(null===n)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==n.complete)return void R(i,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}b.bindTexture(y.TEXTURE_2D,i.__webglTexture,y.TEXTURE0+t)}let p={[$]:y.REPEAT,[j]:y.CLAMP_TO_EDGE,[W]:y.MIRRORED_REPEAT},_={[q]:y.NEAREST,[X]:y.NEAREST_MIPMAP_NEAREST,[Be]:y.NEAREST_MIPMAP_LINEAR,[je]:y.LINEAR,[We]:y.LINEAR_MIPMAP_NEAREST,[qe]:y.LINEAR_MIPMAP_LINEAR},V={[hr]:y.NEVER,[gr]:y.ALWAYS,[cr]:y.LESS,[dr]:y.LEQUAL,[ur]:y.EQUAL,[fr]:y.GEQUAL,[mr]:y.GREATER,[pr]:y.NOTEQUAL};function I(e,t,r){r?(y.texParameteri(e,y.TEXTURE_WRAP_S,p[t.wrapS]),y.texParameteri(e,y.TEXTURE_WRAP_T,p[t.wrapT]),e!==y.TEXTURE_3D&&e!==y.TEXTURE_2D_ARRAY||y.texParameteri(e,y.TEXTURE_WRAP_R,p[t.wrapR]),y.texParameteri(e,y.TEXTURE_MAG_FILTER,_[t.magFilter]),y.texParameteri(e,y.TEXTURE_MIN_FILTER,_[t.minFilter])):(y.texParameteri(e,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(e,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),e!==y.TEXTURE_3D&&e!==y.TEXTURE_2D_ARRAY||y.texParameteri(e,y.TEXTURE_WRAP_R,y.CLAMP_TO_EDGE),t.wrapS===j&&t.wrapT===j||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),y.texParameteri(e,y.TEXTURE_MAG_FILTER,i(t.magFilter)),y.texParameteri(e,y.TEXTURE_MIN_FILTER,i(t.minFilter)),t.minFilter!==q&&t.minFilter!==je&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),t.compareFunction&&(y.texParameteri(e,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(e,y.TEXTURE_COMPARE_FUNC,V[t.compareFunction])),!0===s.has("EXT_texture_filter_anisotropic")&&(r=s.get("EXT_texture_filter_anisotropic"),t.magFilter===q||t.minFilter!==Be&&t.minFilter!==qe||t.type===Qe&&!1===s.has("OES_texture_float_linear")||!1===w&&t.type===it&&!1===s.has("OES_texture_half_float_linear")||(1<t.anisotropy||x.get(t).__currentAnisotropy)&&(y.texParameterf(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,f.getMaxAnisotropy())),x.get(t).__currentAnisotropy=t.anisotropy))}function G(e,t){let r=!1;void 0===e.__webglInit&&(e.__webglInit=!0,t.addEventListener("dispose",c));var i=t.source;let n=l.get(i);void 0===n&&(n={},l.set(i,n));(i=[]).push((a=t).wrapS),i.push(a.wrapT),i.push(a.wrapR||0),i.push(a.magFilter),i.push(a.minFilter),i.push(a.anisotropy),i.push(a.internalFormat),i.push(a.format),i.push(a.type),i.push(a.generateMipmaps),i.push(a.premultiplyAlpha),i.push(a.flipY),i.push(a.unpackAlignment),i.push(a.colorSpace);var a=i.join();return a!==e.__cacheKey&&(void 0===n[a]&&(n[a]={texture:y.createTexture(),usedTimes:0},g.memory.textures++,r=!0),n[a].usedTimes++,void 0!==(i=n[e.__cacheKey])&&(n[e.__cacheKey].usedTimes--,0===i.usedTimes)&&d(t),e.__cacheKey=a,e.__webglTexture=n[a].texture),r}function R(e,a,t){let s=y.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(s=y.TEXTURE_2D_ARRAY),a.isData3DTexture&&(s=y.TEXTURE_3D);var o=G(e,a),l=a.source,h=(b.bindTexture(s,e.__webglTexture,y.TEXTURE0+t),x.get(l));if(l.version!==h.__version||!0===o){b.activeTexture(y.TEXTURE0+t);var c,t=pe.getPrimaries(pe.workingColorSpace),u=a.colorSpace===Jt?null:pe.getPrimaries(a.colorSpace),t=a.colorSpace===Jt||t===u?y.NONE:y.BROWSER_DEFAULT_WEBGL,t=(y.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,a.flipY),y.pixelStorei(y.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),y.pixelStorei(y.UNPACK_ALIGNMENT,a.unpackAlignment),y.pixelStorei(y.UNPACK_COLORSPACE_CONVERSION_WEBGL,t),u=a,!w&&(u.wrapS!==j||u.wrapT!==j||u.minFilter!==q&&u.minFilter!==je)&&!1===M(a.image)),u=M(c=H(a,A(a.image,t,!1,B)))||w,d=S.convert(a.format,a.colorSpace);let i=S.convert(a.type),n=E(a.internalFormat,d,i,a.colorSpace,a.isVideoTexture);I(s,a,u);let r;var m=a.mipmaps,p=w&&!0!==a.isVideoTexture,t=void 0===h.__version||!0===o,f=P(a,c,u);if(a.isDepthTexture)n=y.DEPTH_COMPONENT,w?n=a.type===Qe?y.DEPTH_COMPONENT32F:a.type===Ze?y.DEPTH_COMPONENT24:a.type===st?y.DEPTH24_STENCIL8:y.DEPTH_COMPONENT16:a.type===Qe&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),a.format===ct&&n===y.DEPTH_COMPONENT&&a.type!==Ye&&a.type!==Ze&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),a.type=Ze,i=S.convert(a.type)),a.format===ut&&n===y.DEPTH_COMPONENT&&(n=y.DEPTH_STENCIL,a.type!==st)&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),a.type=st,i=S.convert(a.type)),t&&(p?b.texStorage2D(y.TEXTURE_2D,1,n,c.width,c.height):b.texImage2D(y.TEXTURE_2D,0,n,c.width,c.height,0,d,i,null));else if(a.isDataTexture)if(0<m.length&&u){p&&t&&b.texStorage2D(y.TEXTURE_2D,f,n,m[0].width,m[0].height);for(let e=0,t=m.length;e<t;e++)r=m[e],p?b.texSubImage2D(y.TEXTURE_2D,e,0,0,r.width,r.height,d,i,r.data):b.texImage2D(y.TEXTURE_2D,e,n,r.width,r.height,0,d,i,r.data);a.generateMipmaps=!1}else p?(t&&b.texStorage2D(y.TEXTURE_2D,f,n,c.width,c.height),b.texSubImage2D(y.TEXTURE_2D,0,0,0,c.width,c.height,d,i,c.data)):b.texImage2D(y.TEXTURE_2D,0,n,c.width,c.height,0,d,i,c.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){p&&t&&b.texStorage3D(y.TEXTURE_2D_ARRAY,f,n,m[0].width,m[0].height,c.depth);for(let e=0,t=m.length;e<t;e++)r=m[e],a.format!==ot?null!==d?p?b.compressedTexSubImage3D(y.TEXTURE_2D_ARRAY,e,0,0,0,r.width,r.height,c.depth,d,r.data,0,0):b.compressedTexImage3D(y.TEXTURE_2D_ARRAY,e,n,r.width,r.height,c.depth,0,r.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):p?b.texSubImage3D(y.TEXTURE_2D_ARRAY,e,0,0,0,r.width,r.height,c.depth,d,i,r.data):b.texImage3D(y.TEXTURE_2D_ARRAY,e,n,r.width,r.height,c.depth,0,d,i,r.data)}else{p&&t&&b.texStorage2D(y.TEXTURE_2D,f,n,m[0].width,m[0].height);for(let e=0,t=m.length;e<t;e++)r=m[e],a.format!==ot?null!==d?p?b.compressedTexSubImage2D(y.TEXTURE_2D,e,0,0,r.width,r.height,d,r.data):b.compressedTexImage2D(y.TEXTURE_2D,e,n,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):p?b.texSubImage2D(y.TEXTURE_2D,e,0,0,r.width,r.height,d,i,r.data):b.texImage2D(y.TEXTURE_2D,e,n,r.width,r.height,0,d,i,r.data)}else if(a.isDataArrayTexture)p?(t&&b.texStorage3D(y.TEXTURE_2D_ARRAY,f,n,c.width,c.height,c.depth),b.texSubImage3D(y.TEXTURE_2D_ARRAY,0,0,0,0,c.width,c.height,c.depth,d,i,c.data)):b.texImage3D(y.TEXTURE_2D_ARRAY,0,n,c.width,c.height,c.depth,0,d,i,c.data);else if(a.isData3DTexture)p?(t&&b.texStorage3D(y.TEXTURE_3D,f,n,c.width,c.height,c.depth),b.texSubImage3D(y.TEXTURE_3D,0,0,0,0,c.width,c.height,c.depth,d,i,c.data)):b.texImage3D(y.TEXTURE_3D,0,n,c.width,c.height,c.depth,0,d,i,c.data);else if(a.isFramebufferTexture){if(t)if(p)b.texStorage2D(y.TEXTURE_2D,f,n,c.width,c.height);else{let t=c.width,r=c.height;for(let e=0;e<f;e++)b.texImage2D(y.TEXTURE_2D,e,n,t,r,0,d,i,null),t>>=1,r>>=1}}else if(0<m.length&&u){p&&t&&b.texStorage2D(y.TEXTURE_2D,f,n,m[0].width,m[0].height);for(let e=0,t=m.length;e<t;e++)r=m[e],p?b.texSubImage2D(y.TEXTURE_2D,e,0,0,d,i,r):b.texImage2D(y.TEXTURE_2D,e,n,d,i,r);a.generateMipmaps=!1}else p?(t&&b.texStorage2D(y.TEXTURE_2D,f,n,c.width,c.height),b.texSubImage2D(y.TEXTURE_2D,0,0,0,d,i,c)):b.texImage2D(y.TEXTURE_2D,0,n,d,i,c);C(a,u)&&T(s),h.__version=l.version,a.onUpdate&&a.onUpdate(a)}e.__version=a.version}function D(e,t,r,i,n,a){var s,o,l=S.convert(r.format,r.colorSpace),h=S.convert(r.type),c=E(r.internalFormat,l,h,r.colorSpace);x.get(t).__hasExternalTextures||(s=Math.max(1,t.width>>a),o=Math.max(1,t.height>>a),n===y.TEXTURE_3D||n===y.TEXTURE_2D_ARRAY?b.texImage3D(n,a,c,s,o,t.depth,0,l,h,null):b.texImage2D(n,a,c,s,o,0,l,h,null)),b.bindFramebuffer(y.FRAMEBUFFER,e),N(t)?u.framebufferTexture2DMultisampleEXT(y.FRAMEBUFFER,i,n,x.get(r).__webglTexture,0,k(t)):(n===y.TEXTURE_2D||n>=y.TEXTURE_CUBE_MAP_POSITIVE_X&&n<=y.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&y.framebufferTexture2D(y.FRAMEBUFFER,i,n,x.get(r).__webglTexture,a),b.bindFramebuffer(y.FRAMEBUFFER,null)}function L(t,r,i){if(y.bindRenderbuffer(y.RENDERBUFFER,t),r.depthBuffer&&!r.stencilBuffer){let e=!0===w?y.DEPTH_COMPONENT24:y.DEPTH_COMPONENT16;i||N(r)?((n=r.depthTexture)&&n.isDepthTexture&&(n.type===Qe?e=y.DEPTH_COMPONENT32F:n.type===Ze&&(e=y.DEPTH_COMPONENT24)),n=k(r),N(r)?u.renderbufferStorageMultisampleEXT(y.RENDERBUFFER,n,e,r.width,r.height):y.renderbufferStorageMultisample(y.RENDERBUFFER,n,e,r.width,r.height)):y.renderbufferStorage(y.RENDERBUFFER,e,r.width,r.height),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.RENDERBUFFER,t)}else if(r.depthBuffer&&r.stencilBuffer){var n=k(r);i&&!1===N(r)?y.renderbufferStorageMultisample(y.RENDERBUFFER,n,y.DEPTH24_STENCIL8,r.width,r.height):N(r)?u.renderbufferStorageMultisampleEXT(y.RENDERBUFFER,n,y.DEPTH24_STENCIL8,r.width,r.height):y.renderbufferStorage(y.RENDERBUFFER,y.DEPTH_STENCIL,r.width,r.height),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_STENCIL_ATTACHMENT,y.RENDERBUFFER,t)}else{var a=!0===r.isWebGLMultipleRenderTargets?r.texture:[r.texture];for(let e=0;e<a.length;e++){var s=a[e],o=S.convert(s.format,s.colorSpace),l=S.convert(s.type),o=E(s.internalFormat,o,l,s.colorSpace),l=k(r);i&&!1===N(r)?y.renderbufferStorageMultisample(y.RENDERBUFFER,l,o,r.width,r.height):N(r)?u.renderbufferStorageMultisampleEXT(y.RENDERBUFFER,l,o,r.width,r.height):y.renderbufferStorage(y.RENDERBUFFER,o,r.width,r.height)}}y.bindRenderbuffer(y.RENDERBUFFER,null)}function O(t){var r=x.get(t),e=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture&&!r.__autoAllocateDepthBuffer){if(e)throw new Error("target.depthTexture not supported in Cube render targets");var i=r.__webglFramebuffer,n=t;if(n&&n.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(b.bindFramebuffer(y.FRAMEBUFFER,i),!n.depthTexture||!n.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");x.get(n.depthTexture).__webglTexture&&n.depthTexture.image.width===n.width&&n.depthTexture.image.height===n.height||(n.depthTexture.image.width=n.width,n.depthTexture.image.height=n.height,n.depthTexture.needsUpdate=!0),m(n.depthTexture,0);var i=x.get(n.depthTexture).__webglTexture,a=k(n);if(n.depthTexture.format===ct)N(n)?u.framebufferTexture2DMultisampleEXT(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.TEXTURE_2D,i,0,a):y.framebufferTexture2D(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.TEXTURE_2D,i,0);else{if(n.depthTexture.format!==ut)throw new Error("Unknown depthTexture format");N(n)?u.framebufferTexture2DMultisampleEXT(y.FRAMEBUFFER,y.DEPTH_STENCIL_ATTACHMENT,y.TEXTURE_2D,i,0,a):y.framebufferTexture2D(y.FRAMEBUFFER,y.DEPTH_STENCIL_ATTACHMENT,y.TEXTURE_2D,i,0)}}else if(e){r.__webglDepthbuffer=[];for(let e=0;e<6;e++)b.bindFramebuffer(y.FRAMEBUFFER,r.__webglFramebuffer[e]),r.__webglDepthbuffer[e]=y.createRenderbuffer(),L(r.__webglDepthbuffer[e],t,!1)}else b.bindFramebuffer(y.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=y.createRenderbuffer(),L(r.__webglDepthbuffer,t,!1);b.bindFramebuffer(y.FRAMEBUFFER,null)}function k(e){return Math.min(U,e.samples)}function N(e){var t=x.get(e);return w&&0<e.samples&&!0===s.has("WEBGL_multisampled_render_to_texture")&&!1!==t.__useRenderToTexture}function H(e,t){var r=e.colorSpace,i=e.format,n=e.type;return!0!==e.isCompressedTexture&&!0!==e.isVideoTexture&&e.format!==br&&r!==tr&&r!==Jt&&(pe.getTransfer(r)===ar?!1===w?!0===s.has("EXT_sRGB")&&i===ot?(e.format=br,e.minFilter=je,e.generateMipmaps=!1):t=jr.sRGBToLinear(t):i===ot&&n===Xe||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",r)),t}this.allocateTextureUnit=function(){var e=n;return e>=t&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+t),n+=1,e},this.resetTextureUnits=function(){n=0},this.setTexture2D=m,this.setTexture2DArray=function(e,t){var r=x.get(e);0<e.version&&r.__version!==e.version?R(r,e,t):b.bindTexture(y.TEXTURE_2D_ARRAY,r.__webglTexture,y.TEXTURE0+t)},this.setTexture3D=function(e,t){var r=x.get(e);0<e.version&&r.__version!==e.version?R(r,e,t):b.bindTexture(y.TEXTURE_3D,r.__webglTexture,y.TEXTURE0+t)},this.setTextureCube=function(t,e){var r=x.get(t);if(0<t.version&&r.__version!==t.version){var i=r,n=t,t=e;if(6===n.image.length){var a=G(i,n),s=n.source,o=(b.bindTexture(y.TEXTURE_CUBE_MAP,i.__webglTexture,y.TEXTURE0+t),x.get(s));if(s.version!==o.__version||!0===a){b.activeTexture(y.TEXTURE0+t);var t=pe.getPrimaries(pe.workingColorSpace),l=n.colorSpace===Jt?null:pe.getPrimaries(n.colorSpace),t=n.colorSpace===Jt||t===l?y.NONE:y.BROWSER_DEFAULT_WEBGL,h=(y.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,n.flipY),y.pixelStorei(y.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),y.pixelStorei(y.UNPACK_ALIGNMENT,n.unpackAlignment),y.pixelStorei(y.UNPACK_COLORSPACE_CONVERSION_WEBGL,t),n.isCompressedTexture||n.image[0].isCompressedTexture),c=n.image[0]&&n.image[0].isDataTexture,u=[];for(let e=0;e<6;e++)u[e]=h||c?c?n.image[e].image:n.image[e]:A(n.image[e],!1,!0,F),u[e]=H(n,u[e]);var l=u[0],t=M(l)||w,d=S.convert(n.format,n.colorSpace),m=S.convert(n.type),p=E(n.internalFormat,d,m,n.colorSpace),f=w&&!0!==n.isVideoTexture,a=void 0===o.__version||!0===a;let e=P(n,l,t);I(y.TEXTURE_CUBE_MAP,n,t);let r;if(h){f&&a&&b.texStorage2D(y.TEXTURE_CUBE_MAP,e,p,l.width,l.height);for(let t=0;t<6;t++){r=u[t].mipmaps;for(let e=0;e<r.length;e++){var g=r[e];n.format!==ot?null!==d?f?b.compressedTexSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e,0,0,g.width,g.height,d,g.data):b.compressedTexImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e,p,g.width,g.height,0,g.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):f?b.texSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e,0,0,g.width,g.height,d,m,g.data):b.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e,p,g.width,g.height,0,d,m,g.data)}}}else{r=n.mipmaps,f&&a&&(0<r.length&&e++,b.texStorage2D(y.TEXTURE_CUBE_MAP,e,p,u[0].width,u[0].height));for(let t=0;t<6;t++)if(c){f?b.texSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,u[t].width,u[t].height,d,m,u[t].data):b.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,p,u[t].width,u[t].height,0,d,m,u[t].data);for(let e=0;e<r.length;e++){var v=r[e].image[t].image;f?b.texSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e+1,0,0,v.width,v.height,d,m,v.data):b.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e+1,p,v.width,v.height,0,d,m,v.data)}}else{f?b.texSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,d,m,u[t]):b.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,p,d,m,u[t]);for(let e=0;e<r.length;e++){var _=r[e];f?b.texSubImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e+1,0,0,d,m,_.image[t]):b.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e+1,p,d,m,_.image[t])}}}C(n,t)&&T(y.TEXTURE_CUBE_MAP),o.__version=s.version,n.onUpdate&&n.onUpdate(n)}i.__version=n.version}}else b.bindTexture(y.TEXTURE_CUBE_MAP,r.__webglTexture,y.TEXTURE0+e)},this.rebindTextures=function(e,t,r){var i=x.get(e);void 0!==t&&D(i.__webglFramebuffer,e,e.texture,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,0),void 0!==r&&O(e)},this.setupRenderTarget=function(r){let i=r.texture;var n=x.get(r),e=x.get(i),t=(r.addEventListener("dispose",v),!0!==r.isWebGLMultipleRenderTargets&&(void 0===e.__webglTexture&&(e.__webglTexture=y.createTexture()),e.__version=i.version,g.memory.textures++),!0===r.isWebGLCubeRenderTarget),a=!0===r.isWebGLMultipleRenderTargets,s=M(r)||w;if(t){n.__webglFramebuffer=[];for(let t=0;t<6;t++)if(w&&i.mipmaps&&0<i.mipmaps.length){n.__webglFramebuffer[t]=[];for(let e=0;e<i.mipmaps.length;e++)n.__webglFramebuffer[t][e]=y.createFramebuffer()}else n.__webglFramebuffer[t]=y.createFramebuffer()}else{if(w&&i.mipmaps&&0<i.mipmaps.length){n.__webglFramebuffer=[];for(let e=0;e<i.mipmaps.length;e++)n.__webglFramebuffer[e]=y.createFramebuffer()}else n.__webglFramebuffer=y.createFramebuffer();if(a)if(f.drawBuffers){var o=r.texture;for(let e=0,t=o.length;e<t;e++){var l=x.get(o[e]);void 0===l.__webglTexture&&(l.__webglTexture=y.createTexture(),g.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(w&&0<r.samples&&!1===N(r)){var h=a?i:[i];n.__webglMultisampledFramebuffer=y.createFramebuffer(),n.__webglColorRenderbuffer=[],b.bindFramebuffer(y.FRAMEBUFFER,n.__webglMultisampledFramebuffer);for(let t=0;t<h.length;t++){let e=h[t];n.__webglColorRenderbuffer[t]=y.createRenderbuffer(),y.bindRenderbuffer(y.RENDERBUFFER,n.__webglColorRenderbuffer[t]);var c=S.convert(e.format,e.colorSpace),u=S.convert(e.type),c=E(e.internalFormat,c,u,e.colorSpace,!0===r.isXRRenderTarget),u=k(r);y.renderbufferStorageMultisample(y.RENDERBUFFER,u,c,r.width,r.height),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0+t,y.RENDERBUFFER,n.__webglColorRenderbuffer[t])}y.bindRenderbuffer(y.RENDERBUFFER,null),r.depthBuffer&&(n.__webglDepthRenderbuffer=y.createRenderbuffer(),L(n.__webglDepthRenderbuffer,r,!0)),b.bindFramebuffer(y.FRAMEBUFFER,null)}}if(t){b.bindTexture(y.TEXTURE_CUBE_MAP,e.__webglTexture),I(y.TEXTURE_CUBE_MAP,i,s);for(let t=0;t<6;t++)if(w&&i.mipmaps&&0<i.mipmaps.length)for(let e=0;e<i.mipmaps.length;e++)D(n.__webglFramebuffer[t][e],r,i,y.COLOR_ATTACHMENT0,y.TEXTURE_CUBE_MAP_POSITIVE_X+t,e);else D(n.__webglFramebuffer[t],r,i,y.COLOR_ATTACHMENT0,y.TEXTURE_CUBE_MAP_POSITIVE_X+t,0);C(i,s)&&T(y.TEXTURE_CUBE_MAP)}else if(a){var d=r.texture;for(let e=0,t=d.length;e<t;e++){var m=d[e],p=x.get(m);b.bindTexture(y.TEXTURE_2D,p.__webglTexture),I(y.TEXTURE_2D,m,s),D(n.__webglFramebuffer,r,m,y.COLOR_ATTACHMENT0+e,y.TEXTURE_2D,0),C(m,s)&&T(y.TEXTURE_2D)}}else{let t=y.TEXTURE_2D;if((r.isWebGL3DRenderTarget||r.isWebGLArrayRenderTarget)&&(w?t=r.isWebGL3DRenderTarget?y.TEXTURE_3D:y.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),b.bindTexture(t,e.__webglTexture),I(t,i,s),w&&i.mipmaps&&0<i.mipmaps.length)for(let e=0;e<i.mipmaps.length;e++)D(n.__webglFramebuffer[e],r,i,y.COLOR_ATTACHMENT0,t,e);else D(n.__webglFramebuffer,r,i,y.COLOR_ATTACHMENT0,t,0);C(i,s)&&T(t)}b.unbindTexture(),r.depthBuffer&&O(r)},this.updateRenderTargetMipmap=function(r){var i=M(r)||w,n=!0===r.isWebGLMultipleRenderTargets?r.texture:[r.texture];for(let e=0,t=n.length;e<t;e++){var a,s=n[e];C(s,i)&&(a=r.isWebGLCubeRenderTarget?y.TEXTURE_CUBE_MAP:y.TEXTURE_2D,s=x.get(s).__webglTexture,b.bindTexture(a,s),T(a),b.unbindTexture())}},this.updateMultisampleRenderTarget=function(r){if(w&&0<r.samples&&!1===N(r)){var i=r.isWebGLMultipleRenderTargets?r.texture:[r.texture],n=r.width,a=r.height;let t=y.COLOR_BUFFER_BIT;var s=[],o=r.stencilBuffer?y.DEPTH_STENCIL_ATTACHMENT:y.DEPTH_ATTACHMENT,l=x.get(r),h=!0===r.isWebGLMultipleRenderTargets;if(h)for(let e=0;e<i.length;e++)b.bindFramebuffer(y.FRAMEBUFFER,l.__webglMultisampledFramebuffer),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0+e,y.RENDERBUFFER,null),b.bindFramebuffer(y.FRAMEBUFFER,l.__webglFramebuffer),y.framebufferTexture2D(y.DRAW_FRAMEBUFFER,y.COLOR_ATTACHMENT0+e,y.TEXTURE_2D,null,0);b.bindFramebuffer(y.READ_FRAMEBUFFER,l.__webglMultisampledFramebuffer),b.bindFramebuffer(y.DRAW_FRAMEBUFFER,l.__webglFramebuffer);for(let e=0;e<i.length;e++){s.push(y.COLOR_ATTACHMENT0+e),r.depthBuffer&&s.push(o);var c=void 0!==l.__ignoreDepthValues&&l.__ignoreDepthValues;!1===c&&(r.depthBuffer&&(t|=y.DEPTH_BUFFER_BIT),r.stencilBuffer)&&(t|=y.STENCIL_BUFFER_BIT),h&&y.framebufferRenderbuffer(y.READ_FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.RENDERBUFFER,l.__webglColorRenderbuffer[e]),!0===c&&(y.invalidateFramebuffer(y.READ_FRAMEBUFFER,[o]),y.invalidateFramebuffer(y.DRAW_FRAMEBUFFER,[o])),h&&(c=x.get(i[e]).__webglTexture,y.framebufferTexture2D(y.DRAW_FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,c,0)),y.blitFramebuffer(0,0,n,a,0,0,n,a,t,y.NEAREST),z&&y.invalidateFramebuffer(y.READ_FRAMEBUFFER,s)}if(b.bindFramebuffer(y.READ_FRAMEBUFFER,null),b.bindFramebuffer(y.DRAW_FRAMEBUFFER,null),h)for(let e=0;e<i.length;e++){b.bindFramebuffer(y.FRAMEBUFFER,l.__webglMultisampledFramebuffer),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0+e,y.RENDERBUFFER,l.__webglColorRenderbuffer[e]);var u=x.get(i[e]).__webglTexture;b.bindFramebuffer(y.FRAMEBUFFER,l.__webglFramebuffer),y.framebufferTexture2D(y.DRAW_FRAMEBUFFER,y.COLOR_ATTACHMENT0+e,y.TEXTURE_2D,u,0)}b.bindFramebuffer(y.DRAW_FRAMEBUFFER,l.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=O,this.setupFrameBufferTexture=D,this.useMultisampledRTT=N}function $o(i,n,e){let a=e.isWebGL2;return{convert:function(e,t=Jt){let r;if(t=pe.getTransfer(t),e===Xe)return i.UNSIGNED_BYTE;if(e===nt)return i.UNSIGNED_SHORT_4_4_4_4;if(e===at)return i.UNSIGNED_SHORT_5_5_5_1;if(e===V)return i.BYTE;if(e===G)return i.SHORT;if(e===Ye)return i.UNSIGNED_SHORT;if(e===Ke)return i.INT;if(e===Ze)return i.UNSIGNED_INT;if(e===Qe)return i.FLOAT;if(e===it)return a?i.HALF_FLOAT:null!==(r=n.get("OES_texture_half_float"))?r.HALF_FLOAT_OES:null;if(e===H)return i.ALPHA;if(e===ot)return i.RGBA;if(e===lt)return i.LUMINANCE;if(e===ht)return i.LUMINANCE_ALPHA;if(e===ct)return i.DEPTH_COMPONENT;if(e===ut)return i.DEPTH_STENCIL;if(e===br)return null!==(r=n.get("EXT_sRGB"))?r.SRGB_ALPHA_EXT:null;if(e===dt)return i.RED;if(e===mt)return i.RED_INTEGER;if(e===pt)return i.RG;if(e===ft)return i.RG_INTEGER;if(e===gt)return i.RGBA_INTEGER;if(e===vt||e===_t||e===yt||e===bt)if(t===ar){if(null===(r=n.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(e===vt)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===_t)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===yt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===bt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(r=n.get("WEBGL_compressed_texture_s3tc")))return null;if(e===vt)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===_t)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===yt)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===bt)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===xt||e===St||e===wt||e===At){if(null===(r=n.get("WEBGL_compressed_texture_pvrtc")))return null;if(e===xt)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===St)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===wt)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===At)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Mt)return null!==(r=n.get("WEBGL_compressed_texture_etc1"))?r.COMPRESSED_RGB_ETC1_WEBGL:null;if(e===Ct||e===Tt){if(null===(r=n.get("WEBGL_compressed_texture_etc")))return null;if(e===Ct)return t===ar?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(e===Tt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(e===Et||e===Pt||e===It||e===Rt||e===Dt||e===Lt||e===Ot||e===kt||e===Nt||e===Ft||e===Bt||e===Ut||e===zt||e===Vt){if(null===(r=n.get("WEBGL_compressed_texture_astc")))return null;if(e===Et)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===Pt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===It)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===Rt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===Dt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===Lt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===Ot)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===kt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===Nt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===Ft)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===Bt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===Ut)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===zt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===Vt)return t===ar?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===Gt||e===Ht||e===$t){if(null===(r=n.get("EXT_texture_compression_bptc")))return null;if(e===Gt)return t===ar?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(e===Ht)return r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(e===$t)return r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(e===jt||e===Wt||e===qt||e===Xt){if(null===(r=n.get("EXT_texture_compression_rgtc")))return null;if(e===Gt)return r.COMPRESSED_RED_RGTC1_EXT;if(e===Wt)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===qt)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===Xt)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===st?a?i.UNSIGNED_INT_24_8:null!==(r=n.get("WEBGL_depth_texture"))?r.UNSIGNED_INT_24_8_WEBGL:null:void 0!==i[e]?i[e]:null}}}class jo extends ca{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class Wo extends rn{constructor(){super(),this.isGroup=!0,this.type="Group"}}let qo={type:"move"};class Xo{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Wo,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Wo,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new et,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new et),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Wo,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new et,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new et),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){var t=this._hand;if(t)for(var r of e.hand.values())this._getHandJoint(t,r)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,r){let i=null,n=null,a=null;var s=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){a=!0;for(var h of e.hand.values()){var c=t.getJointPose(h,r),h=this._getHandJoint(l,h);null!==c&&(h.matrix.fromArray(c.transform.matrix),h.matrix.decompose(h.position,h.rotation,h.scale),h.matrixWorldNeedsUpdate=!0,h.jointRadius=c.radius),h.visible=null!==c}var u=l.joints["index-finger-tip"],d=l.joints["thumb-tip"],u=u.position.distanceTo(d.position);l.inputState.pinching&&.025<u?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&u<=.015&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&null!==(n=t.getPose(e.gripSpace,r))&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1);null!==s&&null!==(i=null===(i=t.getPose(e.targetRaySpace,r))&&null!==n?n:i)&&(s.matrix.fromArray(i.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.matrixWorldNeedsUpdate=!0,i.linearVelocity?(s.hasLinearVelocity=!0,s.linearVelocity.copy(i.linearVelocity)):s.hasLinearVelocity=!1,i.angularVelocity?(s.hasAngularVelocity=!0,s.angularVelocity.copy(i.angularVelocity)):s.hasAngularVelocity=!1,this.dispatchEvent(qo))}return null!==s&&(s.visible=null!==i),null!==o&&(o.visible=null!==n),null!==l&&(l.visible=null!==a),this}_getHandJoint(e,t){var r;return void 0===e.joints[t.jointName]&&((r=new Wo).matrixAutoUpdate=!1,r.visible=!1,e.joints[t.jointName]=r,e.add(r)),e.joints[t.jointName]}}class Yo extends Kr{constructor(e,t,r,i,n,a,s,o,l,h){if((h=void 0!==h?h:ct)!==ct&&h!==ut)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super(null,i,n,a,s,o,h,r=void 0===(r=void 0===r&&h===ct?Ze:r)&&h===ut?st:r,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==s?s:q,this.minFilter=void 0!==o?o:q,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){e=super.toJSON(e);return null!==this.compareFunction&&(e.compareFunction=this.compareFunction),e}}class Ko extends Sr{constructor(o,n){super();let l=this,p=null,a=1,h=null,t="local-floor",r=1,c=null,u=null,d=null,m=null,f=null,g=null,s=n.getContextAttributes(),e=null,v=null,_=[],y=[],b=new ca,x=(b.layers.enable(1),b.viewport=new Zr,new ca),S=(x.layers.enable(2),x.viewport=new Zr,[b,x]),w=new jo,A=(w.layers.enable(1),w.layers.enable(2),null),M=null;function C(e){var t=y.indexOf(e.inputSource);-1!==t&&void 0!==(t=_[t])&&(t.update(e.inputSource,e.frame,c||h),t.dispatchEvent({type:e.type,data:e.inputSource}))}function T(){p.removeEventListener("select",C),p.removeEventListener("selectstart",C),p.removeEventListener("selectend",C),p.removeEventListener("squeeze",C),p.removeEventListener("squeezestart",C),p.removeEventListener("squeezeend",C),p.removeEventListener("end",T),p.removeEventListener("inputsourceschange",E);for(let e=0;e<_.length;e++){var t=y[e];null!==t&&(y[e]=null,_[e].disconnect(t))}A=null,M=null,o.setRenderTarget(e),f=null,m=null,d=null,p=null,v=null,L.stop(),l.isPresenting=!1,l.dispatchEvent({type:"sessionend"})}function E(r){for(let e=0;e<r.removed.length;e++){var t=r.removed[e],i=y.indexOf(t);0<=i&&(y[i]=null,_[i].disconnect(t))}for(let e=0;e<r.added.length;e++){var n=r.added[e];let t=y.indexOf(n);if(-1===t){for(let e=0;e<_.length;e++){if(e>=y.length){y.push(n),t=e;break}if(null===y[e]){y[e]=n,t=e;break}}if(-1===t)break}var a=_[t];a&&a.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=_[e];return void 0===t&&(t=new Xo,_[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=_[e];return void 0===t&&(t=new Xo,_[e]=t),t.getGripSpace()},this.getHand=function(e){let t=_[e];return void 0===t&&(t=new Xo,_[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){a=e,!0===l.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){t=e,!0===l.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return c||h},this.setReferenceSpace=function(e){c=e},this.getBaseLayer=function(){return null!==m?m:f},this.getBinding=function(){return d},this.getFrame=function(){return g},this.getSession=function(){return p},this.setSession=async function(i){if(null!==(p=i)){if(e=o.getRenderTarget(),p.addEventListener("select",C),p.addEventListener("selectstart",C),p.addEventListener("selectend",C),p.addEventListener("squeeze",C),p.addEventListener("squeezestart",C),p.addEventListener("squeezeend",C),p.addEventListener("end",T),p.addEventListener("inputsourceschange",E),!0!==s.xrCompatible&&await n.makeXRCompatible(),void 0===p.renderState.layers||!1===o.capabilities.isWebGL2){i={antialias:void 0!==p.renderState.layers||s.antialias,alpha:!0,depth:s.depth,stencil:s.stencil,framebufferScaleFactor:a};f=new XRWebGLLayer(p,n,i),p.updateRenderState({baseLayer:f}),v=new Jr(f.framebufferWidth,f.framebufferHeight,{format:ot,type:Xe,colorSpace:o.outputColorSpace,stencilBuffer:s.stencil})}else{let e=null,t=null,r=null;s.depth&&(r=s.stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT24,e=s.stencil?ut:ct,t=s.stencil?st:Ze);i={colorFormat:n.RGBA8,depthFormat:r,scaleFactor:a};d=new XRWebGLBinding(p,n),m=d.createProjectionLayer(i),p.updateRenderState({layers:[m]}),v=new Jr(m.textureWidth,m.textureHeight,{format:ot,type:Xe,depthTexture:new Yo(m.textureWidth,m.textureHeight,t,void 0,void 0,void 0,void 0,void 0,void 0,e),stencilBuffer:s.stencil,colorSpace:o.outputColorSpace,samples:s.antialias?4:0}),o.properties.get(v).__ignoreDepthValues=m.ignoreDepthValues}v.isXRRenderTarget=!0,this.setFoveation(r),c=null,h=await p.requestReferenceSpace(t),L.setContext(p),L.start(),l.isPresenting=!0,l.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==p)return p.environmentBlendMode};let P=new et,I=new et;function R(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null!==p){w.near=x.near=b.near=e.near,w.far=x.far=b.far=e.far,A===w.near&&M===w.far||(p.updateRenderState({depthNear:w.near,depthFar:w.far}),A=w.near,M=w.far);var t,r,i,n,a,s,o,l,h=e.parent,c=w.cameras;R(w,h);for(let e=0;e<c.length;e++)R(c[e],h);2===c.length?(t=w,r=b,u=x,P.setFromMatrixPosition(r.matrixWorld),I.setFromMatrixPosition(u.matrixWorld),m=P.distanceTo(I),i=r.projectionMatrix.elements,u=u.projectionMatrix.elements,n=i[14]/(i[10]-1),a=i[14]/(i[10]+1),s=(i[9]+1)/i[5],o=(i[9]-1)/i[5],i=(i[8]-1)/i[0],u=(u[8]+1)/u[0],d=n*i,l=n*u,i=(u=m/(u-i))*-i,r.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(i),t.translateZ(u),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert(),r=n+u,n=a+u,t.projectionMatrix.makePerspective(d-i,m-i+l,s*a/n*r,o*a/n*r,r,n),t.projectionMatrixInverse.copy(t.projectionMatrix).invert()):w.projectionMatrix.copy(b.projectionMatrix);var u=e,d=w,m=h;null===m?u.matrix.copy(d.matrixWorld):(u.matrix.copy(m.matrixWorld),u.matrix.invert(),u.matrix.multiply(d.matrixWorld)),u.matrix.decompose(u.position,u.quaternion,u.scale),u.updateMatrixWorld(!0),u.projectionMatrix.copy(d.projectionMatrix),u.projectionMatrixInverse.copy(d.projectionMatrixInverse),u.isPerspectiveCamera&&(u.fov=2*Mr*Math.atan(1/u.projectionMatrix.elements[5]),u.zoom=1)}},this.getCamera=function(){return w},this.getFoveation=function(){if(null!==m||null!==f)return r},this.setFoveation=function(e){r=e,null!==m&&(m.fixedFoveation=e),null!==f&&void 0!==f.fixedFoveation&&(f.fixedFoveation=e)};let D=null;let L=new xa;L.setAnimationLoop(function(e,t){if(u=t.getViewerPose(c||h),g=t,null!==u){var n=u.views;null!==f&&(o.setRenderTargetFramebuffer(v,f.framebuffer),o.setRenderTarget(v));let i=!1;n.length!==w.cameras.length&&(w.cameras.length=0,i=!0);for(let r=0;r<n.length;r++){var a,s=n[r];let e=null,t=(null!==f?e=f.getViewport(s):(a=d.getViewSubImage(m,s),e=a.viewport,0===r&&(o.setRenderTargetTextures(v,a.colorTexture,m.ignoreDepthValues?void 0:a.depthStencilTexture),o.setRenderTarget(v))),S[r]);void 0===t&&((t=new ca).layers.enable(r),t.viewport=new Zr,S[r]=t),t.matrix.fromArray(s.transform.matrix),t.matrix.decompose(t.position,t.quaternion,t.scale),t.projectionMatrix.fromArray(s.projectionMatrix),t.projectionMatrixInverse.copy(t.projectionMatrix).invert(),t.viewport.set(e.x,e.y,e.width,e.height),0===r&&(w.matrix.copy(t.matrix),w.matrix.decompose(w.position,w.quaternion,w.scale)),!0===i&&w.cameras.push(t)}}for(let e=0;e<_.length;e++){var r=y[e],i=_[e];null!==r&&void 0!==i&&i.update(r,t,c||h)}D&&D(e,t),t.detectedPlanes&&l.dispatchEvent({type:"planesdetected",data:t}),g=null}),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}function Zo(i,u){function d(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function m(e,t){e.opacity.value=t.opacity,t.color&&e.diffuse.value.copy(t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map,d(t.map,e.mapTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,d(t.alphaMap,e.alphaMapTransform)),t.bumpMap&&(e.bumpMap.value=t.bumpMap,d(t.bumpMap,e.bumpMapTransform),e.bumpScale.value=t.bumpScale,t.side===Ge)&&(e.bumpScale.value*=-1),t.normalMap&&(e.normalMap.value=t.normalMap,d(t.normalMap,e.normalMapTransform),e.normalScale.value.copy(t.normalScale),t.side===Ge)&&e.normalScale.value.negate(),t.displacementMap&&(e.displacementMap.value=t.displacementMap,d(t.displacementMap,e.displacementMapTransform),e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap,d(t.emissiveMap,e.emissiveMapTransform)),t.specularMap&&(e.specularMap.value=t.specularMap,d(t.specularMap,e.specularMapTransform)),0<t.alphaTest&&(e.alphaTest.value=t.alphaTest);var r=u.get(t).envMap;r&&(e.envMap.value=r,e.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,e.reflectivity.value=t.reflectivity,e.ior.value=t.ior,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,r=!0===i._useLegacyLights?Math.PI:1,e.lightMapIntensity.value=t.lightMapIntensity*r,d(t.lightMap,e.lightMapTransform)),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity,d(t.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(e,t){t.color.getRGB(e.fogColor.value,sa(i)),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,t,r,i,n){var a,s,o,l,h,c;t.isMeshBasicMaterial||t.isMeshLambertMaterial?m(e,t):t.isMeshToonMaterial?(m(e,t),h=e,(c=t).gradientMap&&(h.gradientMap.value=c.gradientMap)):t.isMeshPhongMaterial?(m(e,t),h=t,(c=e).specular.value.copy(h.specular),c.shininess.value=Math.max(h.shininess,1e-4)):t.isMeshStandardMaterial?(m(e,t),o=t,(l=e).metalness.value=o.metalness,o.metalnessMap&&(l.metalnessMap.value=o.metalnessMap,d(o.metalnessMap,l.metalnessMapTransform)),l.roughness.value=o.roughness,o.roughnessMap&&(l.roughnessMap.value=o.roughnessMap,d(o.roughnessMap,l.roughnessMapTransform)),u.get(o).envMap&&(l.envMapIntensity.value=o.envMapIntensity),t.isMeshPhysicalMaterial&&(l=t,o=n,(n=e).ior.value=l.ior,0<l.sheen&&(n.sheenColor.value.copy(l.sheenColor).multiplyScalar(l.sheen),n.sheenRoughness.value=l.sheenRoughness,l.sheenColorMap&&(n.sheenColorMap.value=l.sheenColorMap,d(l.sheenColorMap,n.sheenColorMapTransform)),l.sheenRoughnessMap)&&(n.sheenRoughnessMap.value=l.sheenRoughnessMap,d(l.sheenRoughnessMap,n.sheenRoughnessMapTransform)),0<l.clearcoat&&(n.clearcoat.value=l.clearcoat,n.clearcoatRoughness.value=l.clearcoatRoughness,l.clearcoatMap&&(n.clearcoatMap.value=l.clearcoatMap,d(l.clearcoatMap,n.clearcoatMapTransform)),l.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap.value=l.clearcoatRoughnessMap,d(l.clearcoatRoughnessMap,n.clearcoatRoughnessMapTransform)),l.clearcoatNormalMap)&&(n.clearcoatNormalMap.value=l.clearcoatNormalMap,d(l.clearcoatNormalMap,n.clearcoatNormalMapTransform),n.clearcoatNormalScale.value.copy(l.clearcoatNormalScale),l.side===Ge)&&n.clearcoatNormalScale.value.negate(),0<l.iridescence&&(n.iridescence.value=l.iridescence,n.iridescenceIOR.value=l.iridescenceIOR,n.iridescenceThicknessMinimum.value=l.iridescenceThicknessRange[0],n.iridescenceThicknessMaximum.value=l.iridescenceThicknessRange[1],l.iridescenceMap&&(n.iridescenceMap.value=l.iridescenceMap,d(l.iridescenceMap,n.iridescenceMapTransform)),l.iridescenceThicknessMap)&&(n.iridescenceThicknessMap.value=l.iridescenceThicknessMap,d(l.iridescenceThicknessMap,n.iridescenceThicknessMapTransform)),0<l.transmission&&(n.transmission.value=l.transmission,n.transmissionSamplerMap.value=o.texture,n.transmissionSamplerSize.value.set(o.width,o.height),l.transmissionMap&&(n.transmissionMap.value=l.transmissionMap,d(l.transmissionMap,n.transmissionMapTransform)),n.thickness.value=l.thickness,l.thicknessMap&&(n.thicknessMap.value=l.thicknessMap,d(l.thicknessMap,n.thicknessMapTransform)),n.attenuationDistance.value=l.attenuationDistance,n.attenuationColor.value.copy(l.attenuationColor)),0<l.anisotropy&&(n.anisotropyVector.value.set(l.anisotropy*Math.cos(l.anisotropyRotation),l.anisotropy*Math.sin(l.anisotropyRotation)),l.anisotropyMap)&&(n.anisotropyMap.value=l.anisotropyMap,d(l.anisotropyMap,n.anisotropyMapTransform)),n.specularIntensity.value=l.specularIntensity,n.specularColor.value.copy(l.specularColor),l.specularColorMap&&(n.specularColorMap.value=l.specularColorMap,d(l.specularColorMap,n.specularColorMapTransform)),l.specularIntensityMap)&&(n.specularIntensityMap.value=l.specularIntensityMap,d(l.specularIntensityMap,n.specularIntensityMapTransform))):t.isMeshMatcapMaterial?(m(e,t),o=e,(l=t).matcap&&(o.matcap.value=l.matcap)):t.isMeshDepthMaterial?m(e,t):t.isMeshDistanceMaterial?(m(e,t),n=e,s=t,s=u.get(s).light,n.referencePosition.value.setFromMatrixPosition(s.matrixWorld),n.nearDistance.value=s.shadow.camera.near,n.farDistance.value=s.shadow.camera.far):t.isMeshNormalMaterial?m(e,t):t.isLineBasicMaterial?(n=t,(s=e).diffuse.value.copy(n.color),s.opacity.value=n.opacity,n.map&&(s.map.value=n.map,d(n.map,s.mapTransform)),t.isLineDashedMaterial&&(n=t,(a=e).dashSize.value=n.dashSize,a.totalSize.value=n.dashSize+n.gapSize,a.scale.value=n.scale)):t.isPointsMaterial?(a=t,n=r,r=i,(i=e).diffuse.value.copy(a.color),i.opacity.value=a.opacity,i.size.value=a.size*n,i.scale.value=.5*r,a.map&&(i.map.value=a.map,d(a.map,i.uvTransform)),a.alphaMap&&(i.alphaMap.value=a.alphaMap,d(a.alphaMap,i.alphaMapTransform)),0<a.alphaTest&&(i.alphaTest.value=a.alphaTest)):t.isSpriteMaterial?(n=t,(r=e).diffuse.value.copy(n.color),r.opacity.value=n.opacity,r.rotation.value=n.rotation,n.map&&(r.map.value=n.map,d(n.map,r.mapTransform)),n.alphaMap&&(r.alphaMap.value=n.alphaMap,d(n.alphaMap,r.alphaMapTransform)),0<n.alphaTest&&(r.alphaTest.value=n.alphaTest)):t.isShadowMaterial?(e.color.value.copy(t.color),e.opacity.value=t.opacity):t.isShaderMaterial&&(t.uniformsNeedUpdate=!1)}}}function Qo(y,b,e,x){let S={},w={},A=[],M=e.isWebGL2?y.getParameter(y.MAX_UNIFORM_BUFFER_BINDINGS):0;function C(e){var t={boundary:0,storage:0};return"number"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function T(e){var e=e.target,t=(e.removeEventListener("dispose",T),A.indexOf(e.__bindingPointIndex));A.splice(t,1),y.deleteBuffer(S[e.id]),delete S[e.id],delete w[e.id]}return{bind:function(e,t){t=t.program,x.uniformBlockBinding(e,t)},update:function(e,t){var r;if(void 0===(r=S[e.id])){{var a=e;let r=a.uniforms,i=0,n=0;for(let e=0,t=r.length;e<t;e++){var s,o=r[e],l={boundary:0,storage:0},h=Array.isArray(o.value)?o.value:[o.value];for(let e=0,t=h.length;e<t;e++){var c=C(h[e]);l.boundary+=c.boundary,l.storage+=c.storage}o.__data=new Float32Array(l.storage/Float32Array.BYTES_PER_ELEMENT),o.__offset=i,0<e&&(s=16-(n=i%16),0!==n)&&s-l.boundary<0&&(i+=16-n,o.__offset=i),i+=l.storage}0<(n=i%16)&&(i+=16-n),a.__size=i,a.__cache={}}a=e,n=(()=>{for(let e=0;e<M;e++)if(-1===A.indexOf(e))return A.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0})(),a.__bindingPointIndex=n,u=y.createBuffer(),i=a.__size,a=a.usage,y.bindBuffer(y.UNIFORM_BUFFER,u),y.bufferData(y.UNIFORM_BUFFER,i,a),y.bindBuffer(y.UNIFORM_BUFFER,null),y.bindBufferBase(y.UNIFORM_BUFFER,n,u),r=u,S[e.id]=r,e.addEventListener("dispose",T)}var i=t.program,a=(x.updateUBOMapping(e,i),b.render.frame);if(w[e.id]!==a){var n=e,u=S[n.id],d=n.uniforms,m=n.__cache;y.bindBuffer(y.UNIFORM_BUFFER,u);for(let e=0,t=d.length;e<t;e++){var p=d[e];if(!0===((e,t,r)=>{if(e=e.value,void 0===r[t]){if("number"==typeof e)r[t]=e;else{var i=Array.isArray(e)?e:[e],n=[];for(let e=0;e<i.length;e++)n.push(i[e].clone());r[t]=n}return!0}if("number"==typeof e){if(r[t]!==e)return r[t]=e,!0}else{var a=Array.isArray(r[t])?r[t]:[r[t]],s=Array.isArray(e)?e:[e];for(let e=0;e<a.length;e++){var o=a[e];if(!1===o.equals(s[e]))return o.copy(s[e]),!0}}return!1})(p,e,m)){var f=p.__offset,g=Array.isArray(p.value)?p.value:[p.value];let t=0;for(let e=0;e<g.length;e++){var v=g[e],_=C(v);"number"==typeof v?(p.__data[0]=v,y.bufferSubData(y.UNIFORM_BUFFER,f+t,p.__data)):v.isMatrix3?(p.__data[0]=v.elements[0],p.__data[1]=v.elements[1],p.__data[2]=v.elements[2],p.__data[3]=v.elements[0],p.__data[4]=v.elements[3],p.__data[5]=v.elements[4],p.__data[6]=v.elements[5],p.__data[7]=v.elements[0],p.__data[8]=v.elements[6],p.__data[9]=v.elements[7],p.__data[10]=v.elements[8],p.__data[11]=v.elements[0]):(v.toArray(p.__data,t),t+=_.storage/Float32Array.BYTES_PER_ELEMENT)}y.bufferSubData(y.UNIFORM_BUFFER,f,p.__data)}}y.bindBuffer(y.UNIFORM_BUFFER,null),w[e.id]=a}},dispose:function(){for(var e in S)y.deleteBuffer(S[e]);A=[],S={},w={}}}}class Jo{constructor(e={}){let{canvas:n=(W=kr("canvas"),W.style.display="block",W),context:r=null,depth:x=!0,stencil:S=!0,alpha:w=!1,antialias:A=!1,premultipliedAlpha:M=!0,preserveDrawingBuffer:C=!1,powerPreference:T="default",failIfMajorPerformanceCaveat:j=!1}=e;var W;this.isWebGLRenderer=!0;let q,l=(q=null!==r?r.getContextAttributes().alpha:w,new Uint32Array(4)),h=new Int32Array(4),c=null,E=null,a=[],s=[],P=(this.domElement=n,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=er,this._useLegacyLights=!1,this.toneMapping=$e,this.toneMappingExposure=1,this),X=!1,Y=0,K=0,I=null,R=-1,D=null,v=new Zr,Z=new Zr,Q=null,J=new ze(0),ee=0,i=n.width,L=n.height,O=1,te=null,re=null,u=new Zr(0,0,i,L),ie=new Zr(0,0,i,L),ne=!1,ae=new ba,se=!1,oe=!1,k=null,le=new tt,he=new Ue,N=new et,ce={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function ue(){return null===I?O:1}let F=r;function de(t,r){for(let e=0;e<t.length;e++){var i=t[e],i=n.getContext(i,r);if(null!==i)return i}return null}try{var me={alpha:!0,depth:x,stencil:S,antialias:A,premultipliedAlpha:M,preserveDrawingBuffer:C,powerPreference:T,failIfMajorPerformanceCaveat:j};if("setAttribute"in n&&n.setAttribute("data-engine","three.js r158"),n.addEventListener("webglcontextlost",Me,!1),n.addEventListener("webglcontextrestored",Ce,!1),n.addEventListener("webglcontextcreationerror",Te,!1),null===F){var pe=["webgl2","webgl","experimental-webgl"];if(!0===P.isWebGL1Renderer&&pe.shift(),null===(F=de(pe,me)))throw de(pe)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&F instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),void 0===F.getShaderPrecisionFormat&&(F.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}let _,B,U,o,z,V,G,H,fe,ge,d,m,ve,_e,ye,$,p,f,be,xe,Se,y,g,we;function Ae(){_=new qa(F),B=new Pa(F,_,e),_.init(B),y=new $o(F,_,B),U=new Go(F,_,B),o=new Ka(F),z=new Co,V=new Ho(F,_,U,z,B,y,o),G=new Ra(P),H=new Wa(P),fe=new Sa(F,B),g=new Ta(F,_,fe,B),ge=new Xa(F,fe,o,g),d=new es(F,ge,fe,o),be=new Ja(F,B,V),$=new Ia(z),m=new Mo(P,G,H,_,B,g,$),ve=new Zo(P,z),_e=new Io,ye=new No(_,B),f=new Ca(P,G,H,U,d,q,M),p=new Vo(P,d,B),we=new Qo(F,o,B,U),xe=new Ea(F,_,o,B),Se=new Ya(F,_,o,B),o.programs=m.programs,P.capabilities=B,P.extensions=_,P.properties=z,P.renderLists=_e,P.shadowMap=p,P.state=U,P.info=o}Ae();let b=new Ko(P,F);function Me(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),X=!0}function Ce(){console.log("THREE.WebGLRenderer: Context Restored."),X=!1;var e=o.autoReset,t=p.enabled,r=p.autoUpdate,i=p.needsUpdate,n=p.type;Ae(),o.autoReset=e,p.enabled=t,p.autoUpdate=r,p.needsUpdate=i,p.type=n}function Te(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ee(e){var e=e.target,t=(e.removeEventListener("dispose",Ee),e=e),r=z.get(t).programs;void 0!==r&&(r.forEach(function(e){m.releaseProgram(e)}),t.isShaderMaterial)&&m.releaseShaderCache(t),z.remove(e)}function Pe(e,t,r){!0===e.transparent&&e.side===He&&!1===e.forceSinglePass?(e.side=Ge,e.needsUpdate=!0,Ne(e,t,r),e.side=Ve,e.needsUpdate=!0,Ne(e,t,r),e.side=He):Ne(e,t,r)}this.xr=b,this.getContext=function(){return F},this.getContextAttributes=function(){return F.getContextAttributes()},this.forceContextLoss=function(){var e=_.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=_.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return O},this.setPixelRatio=function(e){void 0!==e&&(O=e,this.setSize(i,L,!1))},this.getSize=function(e){return e.set(i,L)},this.setSize=function(e,t,r=!0){b.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(i=e,L=t,n.width=Math.floor(e*O),n.height=Math.floor(t*O),!0===r&&(n.style.width=e+"px",n.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(e){return e.set(i*O,L*O).floor()},this.setDrawingBufferSize=function(e,t,r){i=e,L=t,O=r,n.width=Math.floor(e*r),n.height=Math.floor(t*r),this.setViewport(0,0,e,t)},this.getCurrentViewport=function(e){return e.copy(v)},this.getViewport=function(e){return e.copy(u)},this.setViewport=function(e,t,r,i){e.isVector4?u.set(e.x,e.y,e.z,e.w):u.set(e,t,r,i),U.viewport(v.copy(u).multiplyScalar(O).floor())},this.getScissor=function(e){return e.copy(ie)},this.setScissor=function(e,t,r,i){e.isVector4?ie.set(e.x,e.y,e.z,e.w):ie.set(e,t,r,i),U.scissor(Z.copy(ie).multiplyScalar(O).floor())},this.getScissorTest=function(){return ne},this.setScissorTest=function(e){U.setScissorTest(ne=e)},this.setOpaqueSort=function(e){te=e},this.setTransparentSort=function(e){re=e},this.getClearColor=function(e){return e.copy(f.getClearColor())},this.setClearColor=function(){f.setClearColor.apply(f,arguments)},this.getClearAlpha=function(){return f.getClearAlpha()},this.setClearAlpha=function(){f.setClearAlpha.apply(f,arguments)},this.clear=function(t=!0,e=!0,r=!0){let i=0;if(t){let e=!1;var n,a,s,o;null!==I&&(t=I.texture.format,e=t===gt||t===ft||t===mt),e?(t=(t=I.texture.type)===Xe||t===Ze||t===Ye||t===st||t===nt||t===at,o=f.getClearColor(),n=f.getClearAlpha(),a=o.r,s=o.g,o=o.b,t?(l[0]=a,l[1]=s,l[2]=o,l[3]=n,F.clearBufferuiv(F.COLOR,0,l)):(h[0]=a,h[1]=s,h[2]=o,h[3]=n,F.clearBufferiv(F.COLOR,0,h))):i|=F.COLOR_BUFFER_BIT}e&&(i|=F.DEPTH_BUFFER_BIT),r&&(i|=F.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),F.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){n.removeEventListener("webglcontextlost",Me,!1),n.removeEventListener("webglcontextrestored",Ce,!1),n.removeEventListener("webglcontextcreationerror",Te,!1),_e.dispose(),ye.dispose(),z.dispose(),G.dispose(),H.dispose(),d.dispose(),g.dispose(),we.dispose(),m.dispose(),b.dispose(),b.removeEventListener("sessionstart",Re),b.removeEventListener("sessionend",De),k&&(k.dispose(),k=null),t.stop()},this.renderBufferDirect=function(e,r,i,n,a,s){null===r&&(r=ce);var o=a.isMesh&&a.matrixWorld.determinant()<0,e=((e,t,r,i,n)=>{!0!==t.isScene&&(t=ce),V.resetTextureUnits();let a=t.fog,s=i.isMeshStandardMaterial?t.environment:null,o=null===I?P.outputColorSpace:!0===I.isXRRenderTarget?I.texture.colorSpace:tr,l=(i.isMeshStandardMaterial?H:G).get(i.envMap||s),h=!0===i.vertexColors&&!!r.attributes.color&&4===r.attributes.color.itemSize,c=!!r.attributes.tangent&&(!!i.normalMap||0<i.anisotropy),u=!!r.morphAttributes.position,d=!!r.morphAttributes.normal,m=!!r.morphAttributes.color,p=$e;!i.toneMapped||null!==I&&!0!==I.isXRRenderTarget||(p=P.toneMapping);var f,g=void 0!==(g=r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color)?g.length:0,v=z.get(i),_=E.state.lights;!0!==se||!0!==oe&&e===D||(f=e===D&&i.id===R,$.setState(i,e,f));let y=!1,b=(i.version===v.__version?(v.needsLights&&v.lightsStateVersion!==_.state.version||v.outputColorSpace!==o||n.isInstancedMesh&&!1===v.instancing||!n.isInstancedMesh&&!0===v.instancing||n.isSkinnedMesh&&!1===v.skinning||!n.isSkinnedMesh&&!0===v.skinning||n.isInstancedMesh&&!0===v.instancingColor&&null===n.instanceColor||n.isInstancedMesh&&!1===v.instancingColor&&null!==n.instanceColor||v.envMap!==l||!0===i.fog&&v.fog!==a||void 0!==v.numClippingPlanes&&(v.numClippingPlanes!==$.numPlanes||v.numIntersection!==$.numIntersection)||v.vertexAlphas!==h||v.vertexTangents!==c||v.morphTargets!==u||v.morphNormals!==d||v.morphColors!==m||v.toneMapping!==p||!0===B.isWebGL2&&v.morphTargetsCount!==g)&&(y=!0):(y=!0,v.__version=i.version),v.currentProgram),x=(!0===y&&(b=Ne(i,t,n)),!1),S=!1,w=!1,A=b.getUniforms(),M=v.uniforms;U.useProgram(b.program)&&(x=!0,S=!0,w=!0),i.id!==R&&(R=i.id,S=!0),!x&&D===e||(A.setValue(F,"projectionMatrix",e.projectionMatrix),A.setValue(F,"viewMatrix",e.matrixWorldInverse),void 0!==(f=A.map.cameraPosition)&&f.setValue(F,N.setFromMatrixPosition(e.matrixWorld)),B.logarithmicDepthBuffer&&A.setValue(F,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&A.setValue(F,"isOrthographic",!0===e.isOrthographicCamera),D===e)||(D=e,S=!0,w=!0),n.isSkinnedMesh&&(A.setOptional(F,n,"bindMatrix"),A.setOptional(F,n,"bindMatrixInverse"),_=n.skeleton)&&(B.floatVertexTextures?(null===_.boneTexture&&_.computeBoneTexture(),A.setValue(F,"boneTexture",_.boneTexture,V),A.setValue(F,"boneTextureSize",_.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required.")),(void 0!==(g=r.morphAttributes).position||void 0!==g.normal||void 0!==g.color&&!0===B.isWebGL2)&&be.update(n,r,b),!S&&v.receiveShadow===n.receiveShadow||(v.receiveShadow=n.receiveShadow,A.setValue(F,"receiveShadow",n.receiveShadow)),i.isMeshGouraudMaterial&&null!==i.envMap&&(M.envMap.value=l,M.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1),S&&(A.setValue(F,"toneMappingExposure",P.toneMappingExposure),v.needsLights&&(t=M,e=w,t.ambientLightColor.needsUpdate=e,t.lightProbe.needsUpdate=e,t.directionalLights.needsUpdate=e,t.directionalLightShadows.needsUpdate=e,t.pointLights.needsUpdate=e,t.pointLightShadows.needsUpdate=e,t.spotLights.needsUpdate=e,t.spotLightShadows.needsUpdate=e,t.rectAreaLights.needsUpdate=e,t.hemisphereLights.needsUpdate=e),a&&!0===i.fog&&ve.refreshFogUniforms(M,a),ve.refreshMaterialUniforms(M,i,O,L,k),io.upload(F,Fe(v),M,V));if(i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(io.upload(F,Fe(v),M,V),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&A.setValue(F,"center",n.center),A.setValue(F,"modelViewMatrix",n.modelViewMatrix),A.setValue(F,"normalMatrix",n.normalMatrix),A.setValue(F,"modelMatrix",n.matrixWorld),i.isShaderMaterial||i.isRawShaderMaterial){var C,T=i.uniformsGroups;for(let e=0,t=T.length;e<t;e++)B.isWebGL2?(C=T[e],we.update(C,b),we.bind(C,b)):console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return b})(e,r,i,n,a);U.setMaterial(n,o);let l=i.index,t=1;if(!0===n.wireframe){if(void 0===(l=ge.getWireframeAttribute(i)))return;t=2}r=i.drawRange,o=i.attributes.position;let h=r.start*t,c=(r.start+r.count)*t;null!==s&&(h=Math.max(h,s.start*t),c=Math.min(c,(s.start+s.count)*t)),null!==l?(h=Math.max(h,0),c=Math.min(c,l.count)):null!=o&&(h=Math.max(h,0),c=Math.min(c,o.count));r=c-h;if(!(r<0||r==1/0)){g.setup(a,n,e,i,l);let t=xe;if(null!==l&&(s=fe.get(l),(t=Se).setIndex(s)),a.isMesh)!0===n.wireframe?(U.setLineWidth(n.wireframeLinewidth*ue()),t.setMode(F.LINES)):t.setMode(F.TRIANGLES);else if(a.isLine){let e=n.linewidth;void 0===e&&(e=1),U.setLineWidth(e*ue()),a.isLineSegments?t.setMode(F.LINES):a.isLineLoop?t.setMode(F.LINE_LOOP):t.setMode(F.LINE_STRIP)}else a.isPoints?t.setMode(F.POINTS):a.isSprite&&t.setMode(F.TRIANGLES);a.isInstancedMesh?t.renderInstances(h,r,a.count):i.isInstancedBufferGeometry?(o=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,e=Math.min(i.instanceCount,o),t.renderInstances(h,r,e)):t.render(h,r)}},this.compile=function(e,t,n=null){null===n&&(n=e),(E=ye.get(n)).init(),s.push(E),n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(E.pushLight(e),e.castShadow)&&E.pushShadow(e)}),e!==n&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(E.pushLight(e),e.castShadow)&&E.pushShadow(e)}),E.setupLights(P._useLegacyLights);let a=new Set;return e.traverse(function(t){var r=t.material;if(r)if(Array.isArray(r))for(let e=0;e<r.length;e++){var i=r[e];Pe(i,n,t),a.add(i)}else Pe(r,n,t),a.add(r)}),s.pop(),E=null,a},this.compileAsync=function(r,e,t=null){let i=this.compile(r,e,t);return new Promise(e=>{function t(){i.forEach(function(e){z.get(e).currentProgram.isReady()&&i.delete(e)}),0===i.size?e(r):setTimeout(t,10)}null!==_.get("KHR_parallel_shader_compile")?t():setTimeout(t,10)})};let Ie=null;function Re(){t.stop()}function De(){t.start()}let t=new xa;function Le(e,t,r,i){var n=e.opaque,a=e.transmissive,e=e.transparent;if(E.setupLightsView(r),!0===se&&$.setGlobalState(P.clippingPlanes,r),0<a.length){var s=n,o=a,l=t,h=r,c=!0===l.isScene?l.overrideMaterial:null;if(null===c){var c=B.isWebGL2,c=(null===k&&(k=new Jr(1,1,{generateMipmaps:!0,type:_.has("EXT_color_buffer_half_float")?it:Xe,minFilter:qe,samples:c?4:0})),P.getDrawingBufferSize(he),c?k.setSize(he.x,he.y):k.setSize(Ir(he.x),Ir(he.y)),P.getRenderTarget()),u=(P.setRenderTarget(k),P.getClearColor(J),(ee=P.getClearAlpha())<1&&P.setClearColor(16777215,.5),P.clear(),P.toneMapping);P.toneMapping=$e,Oe(s,l,h),V.updateMultisampleRenderTarget(k),V.updateRenderTargetMipmap(k);let r=!1;for(let e=0,t=o.length;e<t;e++){var d,m=o[e],p=m.object,f=m.geometry,g=m.material,m=m.group;g.side===He&&p.layers.test(h.layers)&&(d=g.side,g.side=Ge,g.needsUpdate=!0,ke(p,l,h,f,g,m),g.side=d,g.needsUpdate=!0,r=!0)}!0===r&&(V.updateMultisampleRenderTarget(k),V.updateRenderTargetMipmap(k)),P.setRenderTarget(c),P.setClearColor(J,ee),P.toneMapping=u}}i&&U.viewport(v.copy(i)),0<n.length&&Oe(n,t,r),0<a.length&&Oe(a,t,r),0<e.length&&Oe(e,t,r),U.buffers.depth.setTest(!0),U.buffers.depth.setMask(!0),U.buffers.color.setMask(!0),U.setPolygonOffset(!1)}function Oe(r,i,n){var a=!0===i.isScene?i.overrideMaterial:null;for(let e=0,t=r.length;e<t;e++){var s=r[e],o=s.object,l=s.geometry,h=null===a?s.material:a,s=s.group;o.layers.test(n.layers)&&ke(o,i,n,l,h,s)}}function ke(e,t,r,i,n,a){e.onBeforeRender(P,t,r,i,n,a),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),n.onBeforeRender(P,t,r,i,e,a),!0===n.transparent&&n.side===He&&!1===n.forceSinglePass?(n.side=Ge,n.needsUpdate=!0,P.renderBufferDirect(r,t,i,n,e,a),n.side=Ve,n.needsUpdate=!0,P.renderBufferDirect(r,t,i,n,e,a),n.side=He):P.renderBufferDirect(r,t,i,n,e,a),e.onAfterRender(P,t,r,i,n,a)}function Ne(e,t,r){!0!==t.isScene&&(t=ce);var i=z.get(e),n=E.state.lights,a=E.state.shadowsArray,s=n.state.version,a=m.getParameters(e,n.state,a,t,r),o=m.getProgramCacheKey(a);let l=i.programs,h=(i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?H:G).get(e.envMap||i.environment),void 0===l&&(e.addEventListener("dispose",Ee),l=new Map,i.programs=l),l.get(o));if(void 0!==h){if(i.currentProgram===h&&i.lightsStateVersion===s)return Be(e,a),h}else a.uniforms=m.getUniforms(e),e.onBuild(r,a,P),e.onBeforeCompile(a,P),h=m.acquireProgram(a,o),l.set(o,h),i.uniforms=a.uniforms;t=i.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(t.clippingPlanes=$.uniform),Be(e,a),i.needsLights=(r=e).isMeshLambertMaterial||r.isMeshToonMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.isShadowMaterial||r.isShaderMaterial&&!0===r.lights,i.lightsStateVersion=s,i.needsLights&&(t.ambientLightColor.value=n.state.ambient,t.lightProbe.value=n.state.probe,t.directionalLights.value=n.state.directional,t.directionalLightShadows.value=n.state.directionalShadow,t.spotLights.value=n.state.spot,t.spotLightShadows.value=n.state.spotShadow,t.rectAreaLights.value=n.state.rectArea,t.ltc_1.value=n.state.rectAreaLTC1,t.ltc_2.value=n.state.rectAreaLTC2,t.pointLights.value=n.state.point,t.pointLightShadows.value=n.state.pointShadow,t.hemisphereLights.value=n.state.hemi,t.directionalShadowMap.value=n.state.directionalShadowMap,t.directionalShadowMatrix.value=n.state.directionalShadowMatrix,t.spotShadowMap.value=n.state.spotShadowMap,t.spotLightMatrix.value=n.state.spotLightMatrix,t.spotLightMap.value=n.state.spotLightMap,t.pointShadowMap.value=n.state.pointShadowMap,t.pointShadowMatrix.value=n.state.pointShadowMatrix),i.currentProgram=h,i.uniformsList=null,h}function Fe(e){var t;return null===e.uniformsList&&(t=e.currentProgram.getUniforms(),e.uniformsList=io.seqWithValue(t.seq,e.uniforms)),e.uniformsList}function Be(e,t){e=z.get(e);e.outputColorSpace=t.outputColorSpace,e.instancing=t.instancing,e.instancingColor=t.instancingColor,e.skinning=t.skinning,e.morphTargets=t.morphTargets,e.morphNormals=t.morphNormals,e.morphColors=t.morphColors,e.morphTargetsCount=t.morphTargetsCount,e.numClippingPlanes=t.numClippingPlanes,e.numIntersection=t.numClipIntersection,e.vertexAlphas=t.vertexAlphas,e.vertexTangents=t.vertexTangents,e.toneMapping=t.toneMapping}t.setAnimationLoop(function(e){Ie&&Ie(e)}),"undefined"!=typeof self&&t.setContext(self),this.setAnimationLoop=function(e){Ie=e,b.setAnimationLoop(e),null===e?t.stop():t.start()},b.addEventListener("sessionstart",Re),b.addEventListener("sessionend",De),this.render=function(r,e){if(void 0!==e&&!0!==e.isCamera)console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");else if(!0!==X){!0===r.matrixWorldAutoUpdate&&r.updateMatrixWorld(),null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),!0===b.enabled&&!0===b.isPresenting&&(!0===b.cameraAutoUpdate&&b.updateCamera(e),e=b.getCamera()),!0===r.isScene&&r.onBeforeRender(P,r,e,I),(E=ye.get(r,s.length)).init(),s.push(E),le.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),ae.setFromProjectionMatrix(le),oe=this.localClippingEnabled,se=$.init(this.clippingPlanes,oe),(c=_e.get(r,a.length)).init(),a.push(c),!function r(s,i,o,l){if(!1===s.visible)return;let e=s.layers.test(i.layers);if(e)if(s.isGroup)o=s.renderOrder;else if(s.isLOD)!0===s.autoUpdate&&s.update(i);else if(s.isLight)E.pushLight(s),s.castShadow&&E.pushShadow(s);else if(s.isSprite){if(!s.frustumCulled||ae.intersectsSprite(s)){l&&N.setFromMatrixPosition(s.matrixWorld).applyMatrix4(le);let e=d.update(s),t=s.material;t.visible&&c.push(s,e,t,o,N.z,null)}}else if((s.isMesh||s.isLine||s.isPoints)&&(!s.frustumCulled||ae.intersectsObject(s))){let n=d.update(s),a=s.material;if(l&&(void 0!==s.boundingSphere?(null===s.boundingSphere&&s.computeBoundingSphere(),N.copy(s.boundingSphere.center)):(null===n.boundingSphere&&n.computeBoundingSphere(),N.copy(n.boundingSphere.center)),N.applyMatrix4(s.matrixWorld).applyMatrix4(le)),Array.isArray(a)){let i=n.groups;for(let r=0,e=i.length;r<e;r++){let e=i[r],t=a[e.materialIndex];t&&t.visible&&c.push(s,n,t,o,N.z,e)}}else a.visible&&c.push(s,n,a,o,N.z,null)}let n=s.children;for(let e=0,t=n.length;e<t;e++)r(n[e],i,o,l)}(r,e,0,P.sortObjects),c.finish(),!0===P.sortObjects&&c.sort(te,re),this.info.render.frame++,!0===se&&$.beginShadows();var t=E.state.shadowsArray;if(p.render(t,r,e),!0===se&&$.endShadows(),!0===this.info.autoReset&&this.info.reset(),f.render(c,r),E.setupLights(P._useLegacyLights),e.isArrayCamera){var i=e.cameras;for(let e=0,t=i.length;e<t;e++){var n=i[e];Le(c,r,n,n.viewport)}}else Le(c,r,e);null!==I&&(V.updateMultisampleRenderTarget(I),V.updateRenderTargetMipmap(I)),!0===r.isScene&&r.onAfterRender(P,r,e),g.resetDefaultState(),R=-1,D=null,s.pop(),E=0<s.length?s[s.length-1]:null,a.pop(),c=0<a.length?a[a.length-1]:null}},this.getActiveCubeFace=function(){return Y},this.getActiveMipmapLevel=function(){return K},this.getRenderTarget=function(){return I},this.setRenderTargetTextures=function(e,t,r){z.get(e.texture).__webglTexture=t,z.get(e.depthTexture).__webglTexture=r;t=z.get(e);t.__hasExternalTextures=!0,t.__hasExternalTextures&&(t.__autoAllocateDepthBuffer=void 0===r,t.__autoAllocateDepthBuffer||!0===_.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),t.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(e,t){e=z.get(e);e.__webglFramebuffer=t,e.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t=0,r=0){I=e,Y=t,K=r;let i=!0,n=null,a=!1,s=!1;Q=e?(void 0!==(o=z.get(e)).__useDefaultFramebuffer?(U.bindFramebuffer(F.FRAMEBUFFER,null),i=!1):void 0===o.__webglFramebuffer?V.setupRenderTarget(e):o.__hasExternalTextures&&V.rebindTextures(e,z.get(e.texture).__webglTexture,z.get(e.depthTexture).__webglTexture),((o=e.texture).isData3DTexture||o.isDataArrayTexture||o.isCompressedArrayTexture)&&(s=!0),o=z.get(e).__webglFramebuffer,e.isWebGLCubeRenderTarget?(n=Array.isArray(o[t])?o[t][r]:o[t],a=!0):n=B.isWebGL2&&0<e.samples&&!1===V.useMultisampledRTT(e)?z.get(e).__webglMultisampledFramebuffer:Array.isArray(o)?o[r]:o,v.copy(e.viewport),Z.copy(e.scissor),e.scissorTest):(v.copy(u).multiplyScalar(O).floor(),Z.copy(ie).multiplyScalar(O).floor(),ne);var o=U.bindFramebuffer(F.FRAMEBUFFER,n);o&&B.drawBuffers&&i&&U.drawBuffers(e,n),U.viewport(v),U.scissor(Z),U.setScissorTest(Q),a?(o=z.get(e.texture),F.framebufferTexture2D(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,F.TEXTURE_CUBE_MAP_POSITIVE_X+t,o.__webglTexture,r)):s&&(o=z.get(e.texture),e=t||0,F.framebufferTextureLayer(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,o.__webglTexture,r||0,e)),R=-1},this.readRenderTargetPixels=function(t,r,i,n,a,s,o){if(t&&t.isWebGLRenderTarget){let e=z.get(t).__webglFramebuffer;if(e=t.isWebGLCubeRenderTarget&&void 0!==o?e[o]:e){U.bindFramebuffer(F.FRAMEBUFFER,e);try{var l,h=t.texture,c=h.format,u=h.type;c!==ot&&y.convert(c)!==F.getParameter(F.IMPLEMENTATION_COLOR_READ_FORMAT)?console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format."):(l=u===it&&(_.has("EXT_color_buffer_half_float")||B.isWebGL2&&_.has("EXT_color_buffer_float")),u===Xe||y.convert(u)===F.getParameter(F.IMPLEMENTATION_COLOR_READ_TYPE)||u===Qe&&(B.isWebGL2||_.has("OES_texture_float")||_.has("WEBGL_color_buffer_float"))||l?0<=r&&r<=t.width-n&&0<=i&&i<=t.height-a&&F.readPixels(r,i,n,a,y.convert(c),y.convert(u),s):console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type."))}finally{let e=null!==I?z.get(I).__webglFramebuffer:null;U.bindFramebuffer(F.FRAMEBUFFER,e)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")},this.copyFramebufferToTexture=function(e,t,r=0){var i=Math.pow(2,-r),n=Math.floor(t.image.width*i),i=Math.floor(t.image.height*i);V.setTexture2D(t,0),F.copyTexSubImage2D(F.TEXTURE_2D,r,0,0,e.x,e.y,n,i),U.unbindTexture()},this.copyTextureToTexture=function(e,t,r,i=0){var n=t.image.width,a=t.image.height,s=y.convert(r.format),o=y.convert(r.type);V.setTexture2D(r,0),F.pixelStorei(F.UNPACK_FLIP_Y_WEBGL,r.flipY),F.pixelStorei(F.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),F.pixelStorei(F.UNPACK_ALIGNMENT,r.unpackAlignment),t.isDataTexture?F.texSubImage2D(F.TEXTURE_2D,i,e.x,e.y,n,a,s,o,t.image.data):t.isCompressedTexture?F.compressedTexSubImage2D(F.TEXTURE_2D,i,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,s,t.mipmaps[0].data):F.texSubImage2D(F.TEXTURE_2D,i,e.x,e.y,s,o,t.image),0===i&&r.generateMipmaps&&F.generateMipmap(F.TEXTURE_2D),U.unbindTexture()},this.copyTextureToTexture3D=function(t,r,i,n,a=0){if(P.isWebGL1Renderer)console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");else{var s=t.max.x-t.min.x+1,o=t.max.y-t.min.y+1,l=t.max.z-t.min.z+1,h=y.convert(n.format),c=y.convert(n.type);let e;if(n.isData3DTexture)V.setTexture3D(n,0),e=F.TEXTURE_3D;else{if(!n.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");V.setTexture2DArray(n,0),e=F.TEXTURE_2D_ARRAY}F.pixelStorei(F.UNPACK_FLIP_Y_WEBGL,n.flipY),F.pixelStorei(F.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),F.pixelStorei(F.UNPACK_ALIGNMENT,n.unpackAlignment);var u=F.getParameter(F.UNPACK_ROW_LENGTH),d=F.getParameter(F.UNPACK_IMAGE_HEIGHT),m=F.getParameter(F.UNPACK_SKIP_PIXELS),p=F.getParameter(F.UNPACK_SKIP_ROWS),f=F.getParameter(F.UNPACK_SKIP_IMAGES),g=i.isCompressedTexture?i.mipmaps[0]:i.image;F.pixelStorei(F.UNPACK_ROW_LENGTH,g.width),F.pixelStorei(F.UNPACK_IMAGE_HEIGHT,g.height),F.pixelStorei(F.UNPACK_SKIP_PIXELS,t.min.x),F.pixelStorei(F.UNPACK_SKIP_ROWS,t.min.y),F.pixelStorei(F.UNPACK_SKIP_IMAGES,t.min.z),i.isDataTexture||i.isData3DTexture?F.texSubImage3D(e,a,r.x,r.y,r.z,s,o,l,h,c,g.data):i.isCompressedArrayTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),F.compressedTexSubImage3D(e,a,r.x,r.y,r.z,s,o,l,h,g.data)):F.texSubImage3D(e,a,r.x,r.y,r.z,s,o,l,h,c,g),F.pixelStorei(F.UNPACK_ROW_LENGTH,u),F.pixelStorei(F.UNPACK_IMAGE_HEIGHT,d),F.pixelStorei(F.UNPACK_SKIP_PIXELS,m),F.pixelStorei(F.UNPACK_SKIP_ROWS,p),F.pixelStorei(F.UNPACK_SKIP_IMAGES,f),0===a&&n.generateMipmaps&&F.generateMipmap(e),U.unbindTexture()}},this.initTexture=function(e){e.isCubeTexture?V.setTextureCube(e,0):e.isData3DTexture?V.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?V.setTexture2DArray(e,0):V.setTexture2D(e,0),U.unbindTexture()},this.resetState=function(){Y=0,K=0,I=null,U.reset(),g.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return xr}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;var t=this.getContext();t.drawingBufferColorSpace=e===rr?"display-p3":"srgb",t.unpackColorSpace=pe.workingColorSpace===ir?"display-p3":"srgb"}get physicallyCorrectLights(){return console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),!this.useLegacyLights}set physicallyCorrectLights(e){console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),this.useLegacyLights=!e}get outputEncoding(){return console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace===er?Yt:3e3}set outputEncoding(e){console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace=e===Yt?er:tr}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(e){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=e}}Jo;class el{constructor(e,t=1,r=1e3){this.isFog=!0,this.name="",this.color=new ze(e),this.near=t,this.far=r}clone(){return new el(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class tl extends rn{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){e=super.toJSON(e);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),0<this.backgroundBlurriness&&(e.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(e.object.backgroundIntensity=this.backgroundIntensity),e}}class rl extends Kr{constructor(e=null,t=1,r=1,i,n,a,s,o,l=q,h=q,c,u){super(null,a,s,o,l,h,i,n,c,u),this.isDataTexture=!0,this.image={data:e,width:t,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class il extends Sn{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new ze(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}let nl=new et,al=new et,sl=new tt,ol=new Ri,ll=new wi;class hl extends rn{constructor(e=new Fn,t=new il){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){var e=this.geometry;if(null===e.index){var r=e.attributes.position,i=[0];for(let e=1,t=r.count;e<t;e++)nl.fromBufferAttribute(r,e-1),al.fromBufferAttribute(r,e),i[e]=i[e-1],i[e]+=nl.distanceTo(al);e.setAttribute("lineDistance",new Pn(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(r,i){var e=this.geometry,t=this.matrixWorld,n=r.params.Line.threshold,a=e.drawRange;if(null===e.boundingSphere&&e.computeBoundingSphere(),ll.copy(e.boundingSphere),ll.applyMatrix4(t),ll.radius+=n,!1!==r.ray.intersectsSphere(ll)){sl.copy(t).invert(),ol.copy(r.ray).applyMatrix4(sl);var s,t=n/((this.scale.x+this.scale.y+this.scale.z)/3),o=t*t,l=new et,h=new et,c=new et,u=new et,d=this.isLineSegments?2:1,m=e.index,p=e.attributes.position;if(null!==m)for(let e=Math.max(0,a.start),t=Math.min(m.count,a.start+a.count)-1;e<t;e+=d){var f=m.getX(e),g=m.getX(e+1),f=(l.fromBufferAttribute(p,f),h.fromBufferAttribute(p,g),ol.distanceSqToSegment(l,h,u,c));o<f||(u.applyMatrix4(this.matrixWorld),(g=r.ray.origin.distanceTo(u))<r.near)||g>r.far||i.push({distance:g,point:c.clone().applyMatrix4(this.matrixWorld),index:e,face:null,faceIndex:null,object:this})}else for(let e=Math.max(0,a.start),t=Math.min(p.count,a.start+a.count)-1;e<t;e+=d)l.fromBufferAttribute(p,e),h.fromBufferAttribute(p,e+1),o<ol.distanceSqToSegment(l,h,u,c)||(u.applyMatrix4(this.matrixWorld),(s=r.ray.origin.distanceTo(u))<r.near)||s>r.far||i.push({distance:s,point:c.clone().applyMatrix4(this.matrixWorld),index:e,face:null,faceIndex:null,object:this})}}updateMorphTargets(){var e=this.geometry.morphAttributes,t=Object.keys(e);if(0<t.length){var r=e[t[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=r.length;e<t;e++){var i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}let cl=new et,ul=new et;class dl extends hl{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){var e=this.geometry;if(null===e.index){var r=e.attributes.position,i=[];for(let e=0,t=r.count;e<t;e+=2)cl.fromBufferAttribute(r,e),ul.fromBufferAttribute(r,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+cl.distanceTo(ul);e.setAttribute("lineDistance",new Pn(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class ml extends Sn{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new ze(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let pl=new tt,fl=new Ri,gl=new wi,vl=new et;class _l extends rn{constructor(e=new Fn,t=new ml){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(r,i){var e=this.geometry,n=this.matrixWorld,t=r.params.Points.threshold,a=e.drawRange;if(null===e.boundingSphere&&e.computeBoundingSphere(),gl.copy(e.boundingSphere),gl.applyMatrix4(n),gl.radius+=t,!1!==r.ray.intersectsSphere(gl)){pl.copy(n).invert(),fl.copy(r.ray).applyMatrix4(pl);var t=t/((this.scale.x+this.scale.y+this.scale.z)/3),s=t*t,o=e.index,l=e.attributes.position;if(null!==o)for(let e=Math.max(0,a.start),t=Math.min(o.count,a.start+a.count);e<t;e++){var h=o.getX(e);vl.fromBufferAttribute(l,h),yl(vl,h,s,n,r,i,this)}else for(let e=Math.max(0,a.start),t=Math.min(l.count,a.start+a.count);e<t;e++)vl.fromBufferAttribute(l,e),yl(vl,e,s,n,r,i,this)}}updateMorphTargets(){var e=this.geometry.morphAttributes,t=Object.keys(e);if(0<t.length){var r=e[t[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=r.length;e<t;e++){var i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}function yl(e,t,r,i,n,a,s){var o=fl.distanceSqToPoint(e);o<r&&(r=new et,fl.closestPointToPoint(e,r),r.applyMatrix4(i),(e=n.ray.origin.distanceTo(r))<n.near||e>n.far||a.push({distance:e,distanceToRay:Math.sqrt(o),point:r,index:t,face:null,object:s}))}class bl extends Kr{constructor(e,t,r,i,n,a,s,o,l){super(e,t,r,i,n,a,s,o,l),this.isCanvasTexture=!0,this.needsUpdate=!0}}class xl extends Fn{constructor(m=1,p=1,a=1,f=32,s=1,e=!1,g=0,v=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:m,radiusBottom:p,height:a,radialSegments:f,heightSegments:s,openEnded:e,thetaStart:g,thetaLength:v};let _=this,y=(f=Math.floor(f),s=Math.floor(s),[]),b=[],x=[],S=[],w=0,o=[],A=a/2,M=0;{let t=new et,r=new et,i=0,n=(p-m)/a;for(let e=0;e<=s;e++){var l=[],h=e/s,c=h*(p-m)+m;for(let e=0;e<=f;e++){var u=e/f,d=u*v+g,C=Math.sin(d),d=Math.cos(d);r.x=c*C,r.y=-h*a+A,r.z=c*d,b.push(r.x,r.y,r.z),t.set(C,n,d).normalize(),x.push(t.x,t.y,t.z),S.push(u,1-h),l.push(w++)}o.push(l)}for(let t=0;t<f;t++)for(let e=0;e<s;e++){var T=o[e][t],E=o[e+1][t],P=o[e+1][t+1],I=o[e][t+1];y.push(T,E,I),y.push(E,P,I),i+=6}_.addGroup(M,i,0),M+=i}function t(t){var r=w,i=new Ue,n=new et;let a=0;var s=!0===t?m:p,o=!0===t?1:-1;for(let e=1;e<=f;e++)b.push(0,A*o,0),x.push(0,o,0),S.push(.5,.5),w++;var l=w;for(let e=0;e<=f;e++){var h=e/f*v+g,c=Math.cos(h),h=Math.sin(h);n.x=s*h,n.y=A*o,n.z=s*c,b.push(n.x,n.y,n.z),x.push(0,o,0),i.x=.5*c+.5,i.y=.5*h*o+.5,S.push(i.x,i.y),w++}for(let e=0;e<f;e++){var u=r+e,d=l+e;!0===t?y.push(d,d+1,u):y.push(d+1,d,u),a+=3}_.addGroup(M,a,!0===t?1:2),M+=a}!1===e&&(0<m&&t(!0),0<p)&&t(!1),this.setIndex(y),this.setAttribute("position",new Pn(b,3)),this.setAttribute("normal",new Pn(x,3)),this.setAttribute("uv",new Pn(S,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new xl(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Sl extends xl{constructor(e=1,t=1,r=32,i=1,n=!1,a=0,s=2*Math.PI){super(0,e,t,r,i,n,a,s),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:i,openEnded:n,thetaStart:a,thetaLength:s}}static fromJSON(e){return new Sl(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class wl extends Fn{constructor(r=[],t=[],e=1,i=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:r,indices:t,radius:e,detail:i};let n=[],a=[];var N=i,s=new et,o=new et,l=new et;for(let e=0;e<t.length;e+=3){L(t[e+0],s),L(t[e+1],o),L(t[e+2],l);{h=void 0;c=void 0;u=void 0;d=void 0;m=void 0;p=void 0;f=void 0;g=void 0;v=void 0;_=void 0;var h=s;var c=o;var u=l;var d=N;var m=d+1,p=[];for(let t=0;t<=m;t++){p[t]=[];var f=h.clone().lerp(u,t/m),g=c.clone().lerp(u,t/m),v=m-t;for(let e=0;e<=v;e++)0===e&&t===m?p[t][e]=f:p[t][e]=f.clone().lerp(g,e/v)}for(let t=0;t<m;t++)for(let e=0;e<2*(m-t)-1;e++){var _=Math.floor(e/2);e%2==0?(D(p[t][_+1]),D(p[t+1][_]),D(p[t][_])):(D(p[t][_+1]),D(p[t+1][_+1]),D(p[t+1][_]))}}}var F=e,y=new et;for(let e=0;e<n.length;e+=3)y.x=n[e+0],y.y=n[e+1],y.z=n[e+2],y.normalize().multiplyScalar(F),n[e+0]=y.x,n[e+1]=y.y,n[e+2]=y.z;var b=new et;for(let e=0;e<n.length;e+=3){b.x=n[e+0],b.y=n[e+1],b.z=n[e+2];var B=k(b)/2/Math.PI+.5,U=(e=>Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z)))(b)/Math.PI+.5;a.push(B,1-U)}var x=new et,S=new et,w=new et,A=new et,M=new Ue,C=new Ue,T=new Ue;for(let e=0,t=0;e<n.length;e+=9,t+=6){x.set(n[e+0],n[e+1],n[e+2]),S.set(n[e+3],n[e+4],n[e+5]),w.set(n[e+6],n[e+7],n[e+8]),M.set(a[t+0],a[t+1]),C.set(a[t+2],a[t+3]),T.set(a[t+4],a[t+5]),A.copy(x).add(S).add(w).divideScalar(3);var E=k(A);O(M,t+0,x,E),O(C,t+2,S,E),O(T,t+4,w,E)}for(let e=0;e<a.length;e+=6){var P=a[e+0],I=a[e+2],R=a[e+4],z=Math.max(P,I,R),V=Math.min(P,I,R);.9<z&&V<.1&&(P<.2&&(a[e+0]+=1),I<.2&&(a[e+2]+=1),R<.2)&&(a[e+4]+=1)}function D(e){n.push(e.x,e.y,e.z)}function L(e,t){e*=3;t.x=r[0+e],t.y=r[1+e],t.z=r[2+e]}function O(e,t,r,i){i<0&&1===e.x&&(a[t]=e.x-1),0===r.x&&0===r.z&&(a[t]=i/2/Math.PI+.5)}function k(e){return Math.atan2(e.z,-e.x)}this.setAttribute("position",new Pn(n,3)),this.setAttribute("normal",new Pn(n.slice(),3)),this.setAttribute("uv",new Pn(a,2)),0===i?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new wl(e.vertices,e.indices,e.radius,e.details)}}class Al extends wl{constructor(e=1,t=0){var r=(1+Math.sqrt(5))/2;super([-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Al(e.radius,e.detail)}}class Ml extends wl{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Ml(e.radius,e.detail)}}class Cl extends wl{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Cl(e.radius,e.detail)}}class Tl extends Fn{constructor(r=1,i=.4,n=12,a=48,s=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:r,tube:i,radialSegments:n,tubularSegments:a,arc:s},n=Math.floor(n),a=Math.floor(a);var o=[],l=[],h=[],c=[],u=new et,d=new et,m=new et;for(let t=0;t<=n;t++)for(let e=0;e<=a;e++){var p=e/a*s,f=t/n*Math.PI*2;d.x=(r+i*Math.cos(f))*Math.cos(p),d.y=(r+i*Math.cos(f))*Math.sin(p),d.z=i*Math.sin(f),l.push(d.x,d.y,d.z),u.x=r*Math.cos(p),u.y=r*Math.sin(p),m.subVectors(d,u).normalize(),h.push(m.x,m.y,m.z),c.push(e/a),c.push(t/n)}for(let t=1;t<=n;t++)for(let e=1;e<=a;e++){var g=(a+1)*t+e-1,v=(a+1)*(t-1)+e-1,_=(a+1)*(t-1)+e,y=(a+1)*t+e;o.push(g,v,y),o.push(v,_,y)}this.setIndex(o),this.setAttribute("position",new Pn(l,3)),this.setAttribute("normal",new Pn(h,3)),this.setAttribute("uv",new Pn(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Tl(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class El extends rn{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new ze(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){e=super.toJSON(e);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}let Pl=new tt,Il=new et,Rl=new et;class Dl extends class{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Ue(512,512),this.map=null,this.mapPass=null,this.matrix=new tt,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new ba,this._frameExtents=new Ue(1,1),this._viewportCount=1,this._viewports=[new Zr(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){var t=this.camera,r=this.matrix;Il.setFromMatrixPosition(e.matrixWorld),t.position.copy(Il),Rl.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Rl),t.updateMatrixWorld(),Pl.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Pl),r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(Pl)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){var e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}{constructor(){super(new Da(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Ll extends El{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(rn.DEFAULT_UP),this.updateMatrix(),this.target=new rn,this.shadow=new Dl}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class Ol extends El{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}let kl=new tt,Nl=new tt,Fl=new tt;class Bl{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new ca,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new ca,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){var t,r,i,n,a=this._cache;a.focus===e.focus&&a.fov===e.fov&&a.aspect===e.aspect*this.aspect&&a.near===e.near&&a.far===e.far&&a.zoom===e.zoom&&a.eyeSep===this.eyeSep||(a.focus=e.focus,a.fov=e.fov,a.aspect=e.aspect*this.aspect,a.near=e.near,a.far=e.far,a.zoom=e.zoom,a.eyeSep=this.eyeSep,Fl.copy(e.projectionMatrix),t=(i=a.eyeSep/2)*a.near/a.focus,r=a.near*Math.tan(Ar*a.fov*.5)/a.zoom,Nl.elements[12]=-i,kl.elements[12]=i,i=-r*a.aspect+t,n=r*a.aspect+t,Fl.elements[0]=2*a.near/(n-i),Fl.elements[8]=(n+i)/(n-i),this.cameraL.projectionMatrix.copy(Fl),i=-r*a.aspect-t,n=r*a.aspect-t,Fl.elements[0]=2*a.near/(n-i),Fl.elements[8]=(n+i)/(n-i),this.cameraR.projectionMatrix.copy(Fl)),this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(Nl),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(kl)}}class Ul{constructor(e){this.value=e}clone(){return new Ul(void 0===this.value.clone?this.value:this.value.clone())}}function zl(e){return"undefined"!=typeof window&&(e=new RegExp(e+"=([^&#=]*)").exec(window.location.search))?decodeURIComponent(e[1]):void 0}function ce(e,t){return void 0!==e?e:t}function Vl(e,t){var r,i=Object.assign({},e);for(r in t)void 0===e[r]&&(i[r]=t[r]);return i}function Gl(e,t){for(var r in t){var i=t[r];void 0!==i&&(e[r]=i)}}function Hl(){var e;return"undefined"!=typeof window&&(e=window.navigator.userAgent,/Opera|OPR/.test(e)?"Opera":/Chrome/i.test(e)?"Chrome":/Firefox/i.test(e)?"Firefox":/Mobile(\/.*)? Safari/i.test(e)?"Mobile Safari":/MSIE/i.test(e)?"Internet Explorer":!!/Safari/i.test(e)&&"Safari")}function $l(e){window.open(e,"_blank")||(window.location.href=e)}function jl(r,i="download"){if(r){var e="Safari"===Hl();let t=/CriOS\/[\d]+/.test(window.navigator.userAgent);var n,a=document.createElement("a");if("undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(r,i);else if((e||t)&&FileReader)r instanceof Blob?((n=new FileReader).onloadend=function(){s(n.result)},n.readAsDataURL(r)):s(r);else{let e=!1;r instanceof Blob&&(r=URL.createObjectURL(r),e=!0),"download"in a?(a.style.display="hidden",document.body.appendChild(a),a.href=r,a.download=i,a.target="_blank",a.click(),document.body.removeChild(a)):$l(r),e&&window.URL.revokeObjectURL(r)}function s(e){$l(t?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"))}}}function Wl(e,t,r=function(e,t){return e<t?-1:t<e?1:0}){let i=0,n=e.length-1;for(;i<=n;){var a=i+n>>1,s=r(t,e[a]);if(0<s)i=1+a;else{if(!(s<0))return a;n=a-1}}return-i-1}function ql(e,t,r){t=((e,t)=>{let r=e.length-1;if(e[r]<t)return-1;let i=0;for(;i<=r;){var n=i+r>>1;e[n]>=t?r=n-1:i=1+n}return r+1})(e,t),e=((e,t)=>{if(e[0]>t)return-1;let r=0,i=e.length-1;for(;r<=i;){var n=r+i>>1;e[n]>t?i=n-1:r=1+n}return r-1})(e,r);return-1===t||-1===e||e<t?0:e-t+1}function Xl(e){return e.sort().filter(function(e,t,r){return 0===t||e!==r[t-1]})}function Yl(t){if(28672<t.length){var r=[];for(let e=0;e<t.length;e+=28672)r.push(String.fromCharCode.apply(null,t.subarray(e,e+28672)));return r.join("")}return String.fromCharCode.apply(null,t)}function Kl(e,t){switch(e){case"int8":return new Int8Array(t);case"int16":return new Int16Array(t);case"int32":return new Int32Array(t);case"uint8":return new Uint8Array(t);case"uint16":return new Uint16Array(t);case"uint32":return new Uint32Array(t);case"float32":return new Float32Array(t);default:throw new Error("arrayType unknown: "+e)}}function Zl(e,t){return new(65535<t?Uint32Array:Uint16Array)(e)}function Ql(e){return e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e}function Jl(e,t){return void 0===e?e=new t:Array.isArray(e)&&(e=(new t).fromArray(e)),e}function eh(e){return Jl(e,et)}function th(e){return Jl(e,tt)}function rh(e){return Jl(e,ri)}function ih(e){return e=e,t=Float32Array,e instanceof t?e:new t(e);var t}function nh(e){return ce(e,"").toString().toLowerCase()}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:S}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=S);class ah{constructor(e){this.name=e,this._dict={}}add(e,t){this._dict[nh(e)]=t}get(e){return this._dict[nh(e)]}get names(){return Object.keys(this._dict)}}function sh(e){return.01745*e}let oh="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),lh=new Array(36);function hh(){let t=0;var r;for(let e=0;e<36;e++)8===e||13===e||18===e||23===e?lh[e]="-":14===e?lh[e]="4":(r=15&(t=t<=2?33554432+16777216*Math.random()|0:t),t>>=4,lh[e]=oh[19===e?3&r|8:r]);return lh.join("")}function ch(e,t,r){return Math.max(t,Math.min(r,e))}function uh(e,t,r){return e+(t-e)*r}function dh(e,t,r,i,n,a){e=(r-e)*a,i=(i-t)*a,a=n*n;return(2*t-2*r+e+i)*(n*a)+(-3*t+3*r-2*e-i)*a+e*n+t}function mh(e,t,r){return(r=ch((r-e)/(t-e),0,1))*r*(3-2*r)}var ph="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function fh(e){var t={exports:{}};return e(t,t.exports),t.exports}var gh=fh(function(be,xe){!function(){var f,P,n,g,o,I,u,R,l,D,h,c,ie,v,d,i,e,t,L,ne,m,O,_,k,N,r,ae,p,F,y,B,U,z,V,a,G,H,$,b,se,s,oe,x,j,le,W,q,X,Y,K,Z,Q,J,ee,te,re,ce,ue,S,de,w,me,A,M,pe,he,C,T,fe,ge,E=[].slice;function ve(){for(var e,t,r,i,n,a=[],s=0,o=arguments.length;s<o;s++)null!=(e=arguments[s])&&a.push(e);if(null!=h[i=1<a.length?a[a.length-1]:i])this._rgb=m(h[i](C(a.slice(0,-1))));else{for(D||(l=l.sort(function(e,t){return t.p-e.p}),D=!0),n=0,r=l.length;n<r&&!(i=(t=l[n]).test.apply(t,a));n++);i&&(this._rgb=m(h[i].apply(h,a)))}null==this._rgb&&console.warn("unknown format: "+a),null==this._rgb&&(this._rgb=[0,0,0]),3===this._rgb.length&&this._rgb.push(1)}he=(()=>{for(var e,t={},r="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),i=0,n=r.length;i<n;i++)e=r[i],t["[object "+e+"]"]=e.toLowerCase();return function(e){e=Object.prototype.toString.call(e);return t[e]||"object"}})(),b=function(e,t,r){return e=(r=null==r?1:r)<(e=e<(t=null==t?0:t)?t:e)?r:e},C=function(e){return 3<=e.length?Array.prototype.slice.call(e):e[0]},m=function(e){var t,r;for(e._clipped=!1,e._unclipped=e.slice(0),t=r=0;r<3;t=++r)t<3?((e[t]<0||255<e[t])&&(e._clipped=!0),e[t]<0&&(e[t]=0),255<e[t]&&(e[t]=255)):3===t&&(e[t]<0&&(e[t]=0),1<e[t])&&(e[t]=1);return e._clipped||delete e._unclipped,e},g=Math.PI,w=Math.round,_=Math.cos,ae=Math.floor,le=Math.pow,se=Math.log,A=Math.sin,M=Math.sqrt,v=Math.atan2,oe=Math.max,ie=Math.abs,u=2*g,o=g/3,P=g/180,I=180/g,(ne=function(){var e,t,r;return arguments[0]instanceof f?arguments[0]:(e=f,t=arguments,(r=function(){}).prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r)}).default=ne,c=[],null!==be&&null!=be.exports&&(be.exports=ne),((null!==xe?xe:this).chroma=ne).version="1.4.1",h={},D=!(l=[]),ve.prototype.toString=function(){return this.hex()},f=ve,ne._input=h,ne.brewer=t={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Viridis:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]};var _e,ye=[];for(_e in t)ye.push(t[_e.toLowerCase()]=t[_e]);ne.colors=T={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflower:"#6495ed",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",laserlemon:"#ffff54",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrod:"#fafad2",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",maroon2:"#7f0000",maroon3:"#b03060",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",purple2:"#7f007f",purple3:"#a020f0",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},V=function(){var e=C(arguments),t=e[0],r=e[1],i=e[2],t=(t+16)/116,r=isNaN(r)?t:t+r/500,i=isNaN(i)?t:t-i/200;return t=n.Yn*a(t),r=n.Xn*a(r),i=n.Zn*a(i),[ge(3.2404542*r-1.5371385*t-.4985314*i),ge(-.969266*r+1.8760108*t+.041556*i),ge(.0556434*r-.2040259*t+1.0572252*i),3<e.length?e[3]:1]},ge=function(e){return 255*(e<=.00304?12.92*e:1.055*le(e,1/2.4)-.055)},a=function(e){return e>n.t1?e*e*e:n.t2*(e-n.t0)},n={Kn:18,Xn:.95047,Yn:1,Zn:1.08883,t0:.137931034,t1:.206896552,t2:.12841855,t3:.008856452},J=function(){var e=C(arguments),t=e[0],t=ue(t,e[1],e[2]),e=t[0],r=t[1];return[116*r-16,500*(e-r),200*(r-t[2])]},S=function(e){return(e/=255)<=.04045?e/12.92:le((e+.055)/1.055,2.4)},fe=function(e){return e>n.t3?le(e,1/3):e/n.t2+n.t0},ue=function(){var e=C(arguments),t=e[0],r=e[1],e=e[2];return t=S(t),r=S(r),e=S(e),[fe((.4124564*t+.3575761*r+.1804375*e)/n.Xn),fe((.2126729*t+.7151522*r+.072175*e)/n.Yn),fe((.0193339*t+.119192*r+.9503041*e)/n.Zn)]},ne.lab=function(){var e=f,t=E.call(arguments).concat(["lab"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.lab=V,f.prototype.lab=function(){return J(this._rgb)},d=function(i){var t,r,n,a,s,o,l,e,h;return 2===(i=(()=>{for(var e=[],t=0,r=i.length;t<r;t++)n=i[t],e.push(ne(n));return e})()).length?(e=(()=>{for(var e=[],t=0,r=i.length;t<r;t++)n=i[t],e.push(n.lab());return e})(),a=e[0],s=e[1],e=function(r){var i,e=(()=>{var e,t=[];for(i=e=0;e<=2;i=++e)t.push(a[i]+r*(s[i]-a[i]));return t})();return ne.lab.apply(ne,e)}):3===i.length?(h=(()=>{for(var e=[],t=0,r=i.length;t<r;t++)n=i[t],e.push(n.lab());return e})(),a=h[0],s=h[1],o=h[2],e=function(r){var i,e=(()=>{var e,t=[];for(i=e=0;e<=2;i=++e)t.push((1-r)*(1-r)*a[i]+2*(1-r)*r*s[i]+r*r*o[i]);return t})();return ne.lab.apply(ne,e)}):4===i.length?(h=(()=>{for(var e=[],t=0,r=i.length;t<r;t++)n=i[t],e.push(n.lab());return e})(),a=h[0],s=h[1],o=h[2],l=h[3],e=function(r){var i,e=(()=>{var e,t=[];for(i=e=0;e<=2;i=++e)t.push((1-r)*(1-r)*(1-r)*a[i]+3*(1-r)*(1-r)*r*s[i]+3*(1-r)*r*r*o[i]+r*r*r*l[i]);return t})();return ne.lab.apply(ne,e)}):5===i.length&&(t=d(i.slice(0,3)),r=d(i.slice(2,5)),e=function(e){return e<.5?t(2*e):r(2*(e-.5))}),e},ne.bezier=function(e){var t=d(e);return t.scale=function(){return ne.scale(t)},t},ne.cubehelix=function(n,a,s,o,l){var h,c,t;return null==n&&(n=300),null==a&&(a=-1.5),null==s&&(s=1),null==o&&(o=1),h=0,"array"===he(l=null==l?[0,1]:l)?c=l[1]-l[0]:(c=0,l=[l,l]),(t=function(e){var t=u*((n+120)/360+a*e),r=le(l[0]+c*e,o),e=(0!==h?s[0]+e*h:s)*r*(1-r)/2,i=_(t),t=A(t);return ne(m([255*(r+e*(-.14861*i+1.78277*t)),255*(r+e*(-.29227*i-.90649*t)),255*(r+1.97294*i*e),1]))}).start=function(e){return null==e?n:(n=e,t)},t.rotations=function(e){return null==e?a:(a=e,t)},t.gamma=function(e){return null==e?o:(o=e,t)},t.hue=function(e){return null==e?s:("array"===he(s=e)?0===(h=s[1]-s[0])&&(s=s[1]):h=0,t)},t.lightness=function(e){return null==e?l:(c="array"===he(e)?(l=e)[1]-e[0]:(l=[e,e],0),t)},t.scale=function(){return ne.scale(t)},t.hue(s),t},ne.random=function(){for(var e="#",t=0;t<6;++t)e+="0123456789abcdef".charAt(ae(16*Math.random()));return new f(e)},c=[],ne.interpolate=B=function(e,t,r,i){var n,a,s,o;for(null==r&&(r=.5),null==i&&(i="rgb"),"object"!==he(e)&&(e=ne(e)),"object"!==he(t)&&(t=ne(t)),s=0,a=c.length;s<a;s++)if(i===(n=c[s])[0]){o=n[1](e,t,r,i);break}if(null==o)throw"color mode "+i+" is not supported";return o.alpha(e.alpha()+r*(t.alpha()-e.alpha()))},f.prototype.interpolate=function(e,t,r){return B(this,e,t,r)},ne.mix=B,f.prototype.mix=f.prototype.interpolate,h.rgb=function(){var e,t,r=C(arguments),i=[];for(e in r)t=r[e],i.push(t);return i},ne.rgb=function(){var e=f,t=E.call(arguments).concat(["rgb"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},f.prototype.rgb=function(e){return((e=null==e?!0:e)?this._rgb.map(Math.round):this._rgb).slice(0,3)},f.prototype.rgba=function(e){return(e=null==e||e)?[Math.round(this._rgb[0]),Math.round(this._rgb[1]),Math.round(this._rgb[2]),this._rgb[3]]:this._rgb.slice(0)},l.push({p:3,test:function(e){var t=C(arguments);return"array"===he(t)&&3===t.length||4===t.length&&"number"===he(t[3])&&0<=t[3]&&t[3]<=1?"rgb":void 0}}),h.lrgb=h.rgb,R=function(e){for(var t,r=1/e.length,i=[0,0,0,0],n=0,a=e.length;n<a;n++)t=e[n]._rgb,i[0]+=le(t[0],2)*r,i[1]+=le(t[1],2)*r,i[2]+=le(t[2],2)*r,i[3]+=t[3]*r;return i[0]=M(i[0]),i[1]=M(i[1]),i[2]=M(i[2]),1<i[3]&&(i[3]=1),new f(m(i))},c.push(["lrgb",function(e,t,r,i){e=e._rgb,t=t._rgb;return new f(M(le(e[0],2)*(1-r)+le(t[0],2)*r),M(le(e[1],2)*(1-r)+le(t[1],2)*r),M(le(e[2],2)*(1-r)+le(t[2],2)*r),i)}]),ne.average=function(e,t){var r,i,n,a,s,o,l,h,c,u,d,m,p;if(null==t&&(t="rgb"),c=e.length,l=(e=e.map(function(e){return ne(e)})).splice(0,1)[0],"lrgb"===t)return R(e);for(h in a=[],o=s=0,m=l.get(t))m[h]=m[h]||0,a.push(isNaN(m[h])?0:1),"h"!==t.charAt(h)||isNaN(m[h])||(r=m[h]/180*g,s+=_(r),o+=A(r));for(i=l.alpha(),d=0,u=e.length;d<u;d++)for(h in p=(n=e[d]).get(t),i+=n.alpha(),m)isNaN(p[h])||(a[h]+=1,"h"===t.charAt(h)?(r=p[h]/180*g,s+=_(r),o+=A(r)):m[h]+=p[h]);for(h in m)if("h"===t.charAt(h)){for(r=v(o/a[h],s/a[h])/g*180;r<0;)r+=360;for(;360<=r;)r-=360;m[h]=r}else m[h]=m[h]/a[h];return ne(m,t).alpha(i/c)},p=function(e){var t;if(e.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return 3===(e=4!==e.length&&7!==e.length?e:e.substr(1)).length&&(e=(e=e.split(""))[0]+e[0]+e[1]+e[1]+e[2]+e[2]),[(t=parseInt(e,16))>>16,t>>8&255,255&t,1];if(e.match(/^#?([A-Fa-f0-9]{8})$/))return 9===e.length&&(e=e.substr(1)),[(t=parseInt(e,16))>>24&255,t>>16&255,t>>8&255,w((255&t)/255*100)/100];if(null!=h.css&&(t=h.css(e)))return t;throw"unknown color: "+e},Y=function(e,t){var r,i,n,a,s;return null==t&&(t="auto"),a=e[0],i=e[1],r=e[2],e=e[3],"auto"===t&&(t=e<1?"rgba":"rgb"),a=Math.round(a),i=Math.round(i),r=Math.round(r),s=(s="000000"+(a<<16|i<<8|r).toString(16)).substr(s.length-6),n=(n="0"+w(255*e).toString(16)).substr(n.length-2),"#"+(()=>{switch(t.toLowerCase()){case"rgba":return s+n;case"argb":return n+s;default:return s}})()},h.hex=function(e){return p(e)},ne.hex=function(){var e=f,t=E.call(arguments).concat(["hex"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},f.prototype.hex=function(e){return Y(this._rgb,e=null==e?"auto":e)},l.push({p:4,test:function(e){if(1===arguments.length&&"string"===he(e))return"hex"}}),y=function(){var e,t,r,i,n,a,s,o,l,h=C(arguments),c=h[0],u=h[1],d=h[2];if(0===u)a=r=e=255*d;else{for(t=[0,0,0],s=2*d-(o=d<.5?d*(1+u):d+u-d*u),(l=[0,0,0])[0]=(c/=360)+1/3,l[1]=c,l[2]=c-1/3,i=n=0;n<=2;i=++n)l[i]<0&&(l[i]+=1),1<l[i]&&--l[i],t[i]=6*l[i]<1?s+6*(o-s)*l[i]:2*l[i]<1?o:3*l[i]<2?s+(o-s)*(2/3-l[i])*6:s;a=(d=[w(255*t[0]),w(255*t[1]),w(255*t[2])])[0],r=d[1],e=d[2]}return 3<h.length?[a,r,e,h[3]]:[a,r,e]},Z=function(e,t,r){var i,n,a,s;return void 0!==e&&3<=e.length&&(e=(a=e)[0],t=a[1],r=a[2]),e/=255,t/=255,r/=255,a=Math.min(e,t,r),n=((oe=Math.max(e,t,r))+a)/2,oe===a?(s=0,i=Number.NaN):s=n<.5?(oe-a)/(oe+a):(oe-a)/(2-oe-a),e===oe?i=(t-r)/(oe-a):t===oe?i=2+(r-e)/(oe-a):r===oe&&(i=4+(e-t)/(oe-a)),(i*=60)<0&&(i+=360),[i,s,n]},ne.hsl=function(){var e=f,t=E.call(arguments).concat(["hsl"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.hsl=y,f.prototype.hsl=function(){return Z(this._rgb)},x=function(){var e,t,r,i,n,a,s,o,l=C(arguments),h=l[0],c=l[1],u=l[2];if(u*=255,0===c)a=r=e=u;else switch(360<(h=360===h?0:h)&&(h-=360),h<0&&(h+=360),i=u*(1-c),n=u*(1-c*(t=(h/=60)-(h=ae(h)))),o=u*(1-c*(1-t)),h){case 0:a=(s=[u,o,i])[0],r=s[1],e=s[2];break;case 1:a=(s=[n,u,i])[0],r=s[1],e=s[2];break;case 2:a=(s=[i,u,o])[0],r=s[1],e=s[2];break;case 3:a=(s=[i,n,u])[0],r=s[1],e=s[2];break;case 4:a=(s=[o,i,u])[0],r=s[1],e=s[2];break;case 5:a=(s=[u,i,n])[0],r=s[1],e=s[2]}return[a,r,e,3<l.length?l[3]:1]},Q=function(){var e,t,r=C(arguments),i=r[0],n=r[1],r=r[2],a=Math.min(i,n,r),a=(oe=Math.max(i,n,r))-a,s=oe/255;return 0===oe?(e=Number.NaN,t=0):(t=a/oe,i===oe&&(e=(n-r)/a),n===oe&&(e=2+(r-i)/a),r===oe&&(e=4+(i-n)/a),(e*=60)<0&&(e+=360)),[e,t,s]},ne.hsv=function(){var e=f,t=E.call(arguments).concat(["hsv"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.hsv=x,f.prototype.hsv=function(){return Q(this._rgb)},x=function(e){return"number"===he(e)&&0<=e&&e<=16777215?[e>>16,e>>8&255,255&e,1]:(console.warn("unknown num color: "+e),[0,0,0,1])},re=function(){var e=C(arguments);return(e[0]<<16)+(e[1]<<8)+e[2]},ne.num=function(e){return new f(e,"num")},f.prototype.num=function(e){return re(this._rgb,e=null==e?"rgb":e)},h.num=x,l.push({p:1,test:function(e){if(1===arguments.length&&"number"===he(e)&&0<=e&&e<=16777215)return"num"}}),x=function(){var e,t,r,i,n,a,s,o=C(arguments),l=o[0],h=o[1],c=o[2],u=u/100*255,d=255*(h/=100);if(0==h)i=u=e=c;else switch(360<(l=360===l?0:l)&&(l-=360),l<0&&(l+=360),r=(t=c*(1-h))+d*(1-(h=(l/=60)-(c=ae(l)))),a=t+d*h,s=t+d,c){case 0:i=(n=[s,a,t])[0],u=n[1],e=n[2];break;case 1:i=(n=[r,s,t])[0],u=n[1],e=n[2];break;case 2:i=(n=[t,s,a])[0],u=n[1],e=n[2];break;case 3:i=(n=[t,r,s])[0],u=n[1],e=n[2];break;case 4:i=(n=[a,t,s])[0],u=n[1],e=n[2];break;case 5:i=(n=[s,t,r])[0],u=n[1],e=n[2]}return[i,u,e,3<o.length?o[3]:1]},X=function(){var e,t,r=C(arguments),i=r[0],n=r[1],r=r[2],a=Math.min(i,n,r);return 0==(e=(oe=Math.max(i,n,r))-a)?t=Number.NaN:(i===oe&&(t=(n-r)/e),n===oe&&(t=2+(r-i)/e),r===oe&&(t=4+(i-n)/e),(t*=60)<0&&(t+=360)),[t,100*e/255,a/(255-e)*100]},ne.hcg=function(){var e=f,t=E.call(arguments).concat(["hcg"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.hcg=x,f.prototype.hcg=function(){return X(this._rgb)},q=function(e){var t=e[3]<1?"rgba":"rgb";return"rgb"==t?t+"("+e.slice(0,3).map(w).join(",")+")":"rgba"==t?t+"("+e.slice(0,3).map(w).join(",")+","+e[3]+")":void 0},de=function(e){return w(100*e)/100},F=function(e,t){var r=t<1?"hsla":"hsl";return e[0]=de(e[0]||0),e[1]=de(100*e[1])+"%",e[2]=de(100*e[2])+"%","hsla"==r&&(e[3]=t),r+"("+e.join(",")+")"},h.css=function(e){var t,r,i,n,a,s,o,l;if(e=e.toLowerCase(),null!=ne.colors&&ne.colors[e])return p(ne.colors[e]);if(a=e.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(o=a.slice(1,4),n=s=0;s<=2;n=++s)o[n]=+o[n];o[3]=1}else if(a=e.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(o=a.slice(1,5),n=l=0;l<=3;n=++l)o[n]=+o[n];else if(a=e.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(o=a.slice(1,4),n=t=0;t<=2;n=++t)o[n]=w(2.55*o[n]);o[3]=1}else if(a=e.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(o=a.slice(1,5),n=r=0;r<=2;n=++r)o[n]=w(2.55*o[n]);o[3]=+o[3]}else(a=e.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?((i=a.slice(1,4))[1]*=.01,i[2]*=.01,(o=y(i))[3]=1):(a=e.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&((i=a.slice(1,4))[1]*=.01,i[2]*=.01,(o=y(i))[3]=+a[4]);return o},ne.css=function(){var e=f,t=E.call(arguments).concat(["css"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},f.prototype.css=function(e){return"rgb"===(e=null==e?"rgb":e).slice(0,3)?q(this._rgb):"hsl"===e.slice(0,3)?F(this.hsl(),this.alpha()):void 0},h.named=function(e){return p(T[e])},l.push({p:5,test:function(e){if(1===arguments.length&&null!=T[e])return"named"}}),f.prototype.name=function(e){var t,r;for(r in arguments.length&&(T[e]&&(this._rgb=p(T[e])),this._rgb[3]=1),t=this.hex("rgb"),T)if(t===T[r])return r;return t},G=function(){var e=C(arguments),t=e[0],r=e[1],e=e[2];return[t,_(e*=P)*r,A(e)*r]},H=function(){var e=C(arguments),t=e[0],t=G(t,e[1],e[2]),r=t[0],i=t[2],r=V(r,t[1],i);return[r[0],r[1],r[2],3<e.length?e[3]:1]},z=function(){var e=C(arguments),t=e[0],r=e[1],e=e[2],i=M(r*r+e*e),e=(v(e,r)*I+360)%360;return[t,i,e=0===w(1e4*i)?Number.NaN:e]},ee=function(){var e=C(arguments),t=e[0],r=e[2],t=J(t,e[1],r),e=t[0];return z(e,t[1],t[2])},ne.lch=function(){var e=C(arguments);return new f(e,"lch")},ne.hcl=function(){var e=C(arguments);return new f(e,"hcl")},h.lch=H,h.hcl=function(){var e=C(arguments),t=e[0];return H([e[2],e[1],t])},f.prototype.lch=function(){return ee(this._rgb)},f.prototype.hcl=function(){return ee(this._rgb).reverse()},W=function(e){var t,r,i;return null==e&&(e="rgb"),i=(e=C(arguments))[0],r=e[1],e=e[2],r/=255,e/=255,[(1-(i/=255)-(i=1-Math.max(i,Math.max(r,e))))*(t=i<1?1/(1-i):0),(1-r-i)*t,(1-e-i)*t,i]},O=function(){var e=C(arguments),t=e[0],r=e[1],i=e[2],n=e[3],e=4<e.length?e[4]:1;return 1===n?[0,0,0,e]:[1<=t?0:255*(1-t)*(1-n),1<=r?0:255*(1-r)*(1-n),1<=i?0:255*(1-i)*(1-n),e]},h.cmyk=function(){return O(C(arguments))},ne.cmyk=function(){var e=f,t=E.call(arguments).concat(["cmyk"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},f.prototype.cmyk=function(){return W(this._rgb)},h.gl=function(){for(var r,e,i,t=function(){var e=C(arguments),t=[];for(r in e)i=e[r],t.push(i);return t}.apply(this,arguments),n=e=0;e<=2;n=++e)t[n]*=255;return t},ne.gl=function(){var e=f,t=E.call(arguments).concat(["gl"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},f.prototype.gl=function(){var e=this._rgb;return[e[0]/255,e[1]/255,e[2]/255,e[3]]},te=function(e,t,r){var i=C(arguments);return e=i[0],t=i[1],r=i[2],.2126*s(e)+.7152*s(t)+.0722*s(r)},s=function(e){return(e/=255)<=.03928?e/12.92:le((e+.055)/1.055,2.4)},c.push(["rgb",function(e,t,r,i){e=e._rgb,t=t._rgb;return new f(e[0]+r*(t[0]-e[0]),e[1]+r*(t[1]-e[1]),e[2]+r*(t[2]-e[2]),i)}]),f.prototype.luminance=function(n,a){var e,s,t,o;return null==a&&(a="rgb"),arguments.length?(t=this._rgb,t=0===n?[0,0,0,this._rgb[3]]:1===n?[255,255,255,this[3]]:(e=te(this._rgb),s=20,o=function(e,t){var r=e.interpolate(t,.5,a),i=r.luminance();return Math.abs(n-i)<1e-7||!s--?r:n<i?o(e,r):o(r,t)},(n<e?o(ne("black"),this):o(this,ne("white"))).rgba()),ne(t).alpha(this.alpha())):te(this._rgb)},pe=function(e){var t,r,e=e/100,i=e<66?(r=255,t=-155.25485562709179-.44596950469579133*(t=e-2)+104.49216199393888*se(t),e<20?0:.8274096064007395*(i=e-10)-254.76935184120902+115.67994401066147*se(i)):(r=351.97690566805693+.114206453784165*(r=e-55)-40.25366309332127*se(r),t=325.4494125711974+.07943456536662342*(t=e-50)-28.0852963507957*se(t),255);return[r,t,i]},ce=function(){for(var e,t,r=C(arguments),i=r[0],n=r[2],a=1e3,s=4e4;.4<s-a;)(e=pe(t=.5*(s+a)))[2]/e[0]>=n/i?s=t:a=t;return w(t)},ne.temperature=ne.kelvin=function(){var e=f,t=E.call(arguments).concat(["temperature"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.temperature=h.kelvin=h.K=pe,f.prototype.temperature=function(){return ce(this._rgb)},f.prototype.kelvin=f.prototype.temperature,ne.contrast=function(e,t){var r;return"string"!==(r=he(e))&&"number"!==r||(e=new f(e)),"string"!==(r=he(t))&&"number"!==r||(t=new f(t)),r=e.luminance(),(e=t.luminance())<r?(r+.05)/(e+.05):(e+.05)/(r+.05)},ne.distance=function(e,t,r){var i,n,a,s,o,l;for(n in null==r&&(r="lab"),"string"!==(o=he(e))&&"number"!==o||(e=new f(e)),"string"!==(o=he(t))&&"number"!==o||(t=new f(t)),a=e.get(r),s=t.get(r),l=0,a)l+=(i=(a[n]||0)-(s[n]||0))*i;return Math.sqrt(l)},ne.deltaE=function(e,t,r,i){var n,a,s,o,l,h,c,u,d,m,p;for(null==r&&(r=1),null==i&&(i=1),"string"!==(c=he(e))&&"number"!==c||(e=new f(e)),"string"!==(c=he(t))&&"number"!==c||(t=new f(t)),e=(c=e.lab())[0],n=c[1],c=c[2],o=(t=t.lab())[0],a=t[1],t=t[2],d=M(n*n+c*c),s=M(a*a+t*t),m=e<16?.511:.040975*e/(1+.01765*e),u=.0638*d/(1+.0131*d)+.638,h=d<1e-6?0:180*v(c,n)/g;h<0;)h+=360;for(;360<=h;)h-=360;return p=164<=h&&h<=345?.56+ie(.2*_(g*(h+168)/180)):.36+ie(.4*_(g*(h+35)/180)),l=M((l=d*d*d*d)/(1900+l)),M((e=(e-o)/(r*m))*e+(r=(o=d-s)/(i*u))*r+((m=n-a)*m+(e=c-t)*e-o*o)/((d=u*(l*p+1-l))*d))},f.prototype.get=function(e){var t,e=e.split("."),r=e[0],e=e[1],i=this[r]();return e?-1<(t=r.indexOf(e))?i[t]:console.warn("unknown channel "+e+" in mode "+r):i},f.prototype.set=function(e,t){var r,i,e=e.split("."),n=e[0],e=e[1];if(e)if(i=this[n](),-1<(r=n.indexOf(e)))if("string"===he(t))switch(t.charAt(0)){case"+":case"-":i[r]+=+t;break;case"*":i[r]*=+t.substr(1);break;case"/":i[r]/=+t.substr(1);break;default:i[r]=+t}else i[r]=t;else console.warn("unknown channel "+e+" in mode "+n);else i=t;return ne(i,n).alpha(this.alpha())},f.prototype.clipped=function(){return this._rgb._clipped||!1},f.prototype.alpha=function(e){return arguments.length?ne.rgb([this._rgb[0],this._rgb[1],this._rgb[2],e]):this._rgb[3]},f.prototype.darken=function(e){var t;return null==e&&(e=1),(t=this.lab())[0]-=n.Kn*e,ne.lab(t).alpha(this.alpha())},f.prototype.brighten=function(e){return this.darken(-(e=null==e?1:e))},f.prototype.darker=f.prototype.darken,f.prototype.brighter=f.prototype.brighten,f.prototype.saturate=function(e){var t;return null==e&&(e=1),(t=this.lch())[1]+=e*n.Kn,t[1]<0&&(t[1]=0),ne.lch(t).alpha(this.alpha())},f.prototype.desaturate=function(e){return this.saturate(-(e=null==e?1:e))},f.prototype.premultiply=function(){var e=this.rgb(),t=this.alpha();return ne(e[0]*t,e[1]*t,e[2]*t,t)},x=function(e,t){return e*t/255},k=function(e,t){return t<e?t:e},$=function(e,t){return t<e?e:t},me=function(e,t){return 255*(1-(1-e/255)*(1-t/255))},j=function(e,t){return t<128?2*e*t/255:255*(1-2*(1-e/255)*(1-t/255))},L=function(e,t){return 255*(1-(1-t/255)/(e/255))},N=function(e,t){return 255===e||255<(e=t/255*255/(1-e/255))?255:e},(i=function(e,t,r){if(i[r])return i[r](e,t);throw"unknown blend mode "+r}).normal=(e=function(r){return function(e,t){t=ne(t).rgb(),e=ne(e).rgb();return ne(r(t,e),"rgb")}})((r=function(a){return function(e,t){for(var r,i=[],n=r=0;r<=3;n=++r)i[n]=a(e[n],t[n]);return i}})(function(e,t){return e})),i.multiply=e(r(x)),i.screen=e(r(me)),i.overlay=e(r(j)),i.darken=e(r(k)),i.lighten=e(r($)),i.dodge=e(r(N)),i.burn=e(r(L)),ne.blend=i,ne.analyze=function(e){for(var t,r={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},i=0,n=e.length;i<n;i++)null==(t=e[i])||isNaN(t)||(r.values.push(t),r.sum+=t,t<r.min&&(r.min=t),r.max<t&&(r.max=t),r.count+=1);return r.domain=[r.min,r.max],r.limits=function(e,t){return ne.limits(r,e,t)},r},ne.scale=function(c,e){var u,t,l="rgb",h=ne("#ccc"),r=0,d=[0,1],m=[],p=[0,0],f=!1,g=[],i=!1,v=0,_=1,y={},b=!0,x=1,n=function(e){var t,r,i,n,a,s;if(null!=(e=null==e?["#fff","#000"]:e)&&"string"===he(e)&&null!=ne.brewer&&(e=ne.brewer[e]||ne.brewer[e.toLowerCase()]||e),"array"===he(e)){for(t=i=0,n=(e=(e=1===e.length?[e[0],e[0]]:e).slice(0)).length-1;0<=n?i<=n:n<=i;t=0<=n?++i:--i)r=e[t],"string"===he(r)&&(e[t]=ne(r));for(t=s=m.length=0,a=e.length-1;0<=a?s<=a:a<=s;t=0<=a?++s:--s)m.push(t/(e.length-1))}return o(),g=e},S=function(e){var t,r;if(null==f)return 0;for(r=f.length-1,t=0;t<r&&e>=f[t];)t++;return t-1},w=function(e){return e},A=function(e,t){var r,i,n,a,s,o;if(null==t&&(t=!1),isNaN(e)||null===e)return h;if(o=t?e:f&&2<f.length?S(e)/(f.length-2):_!==v?(e-v)/(_-v):1,t||(o=w(o)),1!==x&&(o=le(o,x)),o=p[0]+o*(1-p[0]-p[1]),o=Math.min(1,Math.max(0,o)),e=Math.floor(1e4*o),b&&y[e])r=y[e];else{if("array"===he(g))for(i=n=0,s=m.length-1;0<=s?n<=s:s<=n;i=0<=s?++n:--n){if(o<=(a=m[i])){r=g[i];break}if(a<=o&&i===m.length-1){r=g[i];break}if(a<o&&o<m[i+1]){o=(o-a)/(m[i+1]-a),r=ne.interpolate(g[i],g[i+1],o,l);break}}else"function"===he(g)&&(r=g(o));b&&(y[e]=r)}return r},o=function(){return y={}};return n(c),(u=function(e){e=ne(A(e));return i&&e[i]?e[i]():e}).classes=function(e){var t;return null!=e?("array"===he(e)?d=[(f=e)[0],e[e.length-1]]:(t=ne.analyze(d),f=0===e?[t.min,t.max]:ne.limits(t,"e",e)),u):f},u.domain=function(e){var t,r,i,n,a,s,o;if(!arguments.length)return d;if(v=e[0],_=e[e.length-1],m=[],i=g.length,e.length===i&&v!==_)for(a=0,n=e.length;a<n;a++)r=e[a],m.push((r-v)/(_-v));else for(t=o=0,s=i-1;0<=s?o<=s:s<=o;t=0<=s?++o:--o)m.push(t/(i-1));return d=[v,_],u},u.mode=function(e){return arguments.length?(l=e,o(),u):l},u.range=function(e,t){return n(e),u},u.out=function(e){return i=e,u},u.spread=function(e){return arguments.length?(r=e,u):r},u.correctLightness=function(e){return t=e=null==e?!0:e,o(),w=t?function(e){for(var t=A(0,!0).lab()[0],r=A(1,!0).lab()[0],i=r<t,n=A(e,!0).lab()[0],a=t+(r-t)*e,s=n-a,o=0,l=1,h=20;.01<Math.abs(s)&&0<h--;)i&&(s*=-1),e+=s<0?.5*(l-(o=e)):.5*(o-(l=e)),n=A(e,!0).lab()[0],s=n-a;return e}:function(e){return e},u},u.padding=function(e){return null!=e?("number"===he(e)&&(e=[e,e]),p=e,u):p},u.colors=function(t,r){var i,n,e,a,s,o,l,h;if(arguments.length<2&&(r="hex"),s=[],0===arguments.length)s=g.slice(0);else if(1===t)s=[u(.5)];else if(1<t)n=d[0],i=d[1]-n,s=function(){o=[];for(var e=0;0<=t?e<t:t<e;0<=t?e++:e--)o.push(e);return o}.apply(this).map(function(e){return u(n+e/(t-1)*i)});else{if(c=[],l=[],f&&2<f.length)for(e=h=1,a=f.length;1<=a?h<a:a<h;e=1<=a?++h:--h)l.push(.5*(f[e-1]+f[e]));else l=d;s=l.map(u)}return s=ne[r]?s.map(function(e){return e[r]()}):s},u.cache=function(e){return null!=e?(b=e,u):b},u.gamma=function(e){return null!=e?(x=e,u):x},u.nodata=function(e){return null!=e?(h=ne(e),u):h},u},null==ne.scales&&(ne.scales={}),ne.scales.cool=function(){return ne.scale([ne.hsl(180,1,.9),ne.hsl(250,.7,.4)])},ne.scales.hot=function(){return ne.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},ne.analyze=function(e,r,i){var n,t,a,s,o,l={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0};if(null==i&&(i=function(){return!0}),n=function(e){null==e||isNaN(e)||(l.values.push(e),l.sum+=e,e<l.min&&(l.min=e),l.max<e&&(l.max=e),l.count+=1)},o=function(e,t){if(i(e,t))return null!=r&&"function"===he(r)?n(r(e)):null!=r&&"string"===he(r)||"number"===he(r)?n(e[r]):n(e)},"array"===he(e))for(s=0,a=e.length;s<a;s++)o(e[s]);else for(t in e)o(e[t],t);return l.domain=[l.min,l.max],l.limits=function(e,t){return ne.limits(l,e,t)},l},ne.limits=function(e,t,r){var i,n,a,s,o,l,h,c,u,d,m,p,N,F,B,f,U,z,V,g,v,_,y,G,b,H,$,x,j,S,w,A,M,C,T,E,P,I,R,W,D,L,q,X,Y,K,Z,Q,J,O,ee,te,k,re;if(null==t&&(t="equal"),null==r&&(r=7),b=(e="array"===he(e)?ne.analyze(e):e).min,oe=e.max,e.sum,k=e.values.sort(function(e,t){return e-t}),1===r)return[b,oe];if(y=[],"c"===t.substr(0,1)&&(y.push(b),y.push(oe)),"e"===t.substr(0,1)){for(y.push(b),C=r-(g=w=1);1<=C?w<=C:C<=w;g=1<=C?++w:--w)y.push(b+g/r*(oe-b));y.push(oe)}else if("l"===t.substr(0,1)){if(b<=0)throw"Logarithmic scales are only possible for values > 0";for(H=Math.LOG10E*se(b),G=Math.LOG10E*se(oe),y.push(b),T=r-(g=re=1);1<=T?re<=T:T<=re;g=1<=T?++re:--re)y.push(le(10,H+g/r*(G-H)));y.push(oe)}else if("q"===t.substr(0,1)){for(y.push(b),D=r-(g=i=1);1<=D?i<=D:D<=i;g=1<=D?++i:--i)M=(k.length-1)*g/r,A=ae(M),y.push(A===M?k[A]:k[A]*(1-(M=M-A))+k[A+1]*M);y.push(oe)}else if("k"===t.substr(0,1)){for(x=k.length,F=new Array(x),z=new Array(r),J=!0,j=0,f=null,(f=[]).push(b),L=r-(g=n=1);1<=L?n<=L:L<=n;g=1<=L?++n:--n)f.push(b+g/r*(oe-b));for(f.push(oe);J;){for(v=a=0,q=r-1;0<=q?a<=q:q<=a;v=0<=q?++a:--a)z[v]=0;for(g=s=0,X=x-1;0<=X?s<=X:X<=s;g=0<=X?++s:--s){for(te=k[g],$=Number.MAX_VALUE,v=o=0,Y=r-1;0<=Y?o<=Y:Y<=o;v=0<=Y?++o:--o)(V=ie(f[v]-te))<$&&($=V,B=v);z[B]++,F[g]=B}for(S=new Array(r),v=l=0,K=r-1;0<=K?l<=K:K<=l;v=0<=K?++l:--l)S[v]=null;for(g=h=0,Z=x-1;0<=Z?h<=Z:Z<=h;g=0<=Z?++h:--h)null===S[U=F[g]]?S[U]=k[g]:S[U]+=k[g];for(v=c=0,Q=r-1;0<=Q?c<=Q:Q<=c;v=0<=Q?++c:--c)S[v]*=1/z[v];for(J=!1,v=u=0,E=r-1;0<=E?u<=E:E<=u;v=0<=E?++u:--u)if(S[v]!==f[g]){J=!0;break}f=S,200<++j&&(J=!1)}for(_={},v=d=0,P=r-1;0<=P?d<=P:P<=d;v=0<=P?++d:--d)_[v]=[];for(g=m=0,I=x-1;0<=I?m<=I:I<=m;g=0<=I?++m:--m)_[U=F[g]].push(k[g]);for(O=[],v=p=0,R=r-1;0<=R?p<=R:R<=p;v=0<=R?++p:--p)O.push(_[v][0]),O.push(_[v][_[v].length-1]);for(O=O.sort(function(e,t){return e-t}),y.push(O[0]),g=N=1,W=O.length-1;N<=W;g=N+=2)ee=O[g],isNaN(ee)||-1!==y.indexOf(ee)||y.push(ee)}return y},x=function(e,t,r){var i,n,a,s=C(arguments);return e=s[0],t=s[1],r=s[2],isNaN(e)&&(e=0),(e/=360)<1/3?n=1-((i=(1-t)/3)+(a=(1+t*_(u*e)/_(o-u*e))/3)):e<2/3?i=1-((a=(1-t)/3)+(n=(1+t*_(u*(e-=1/3))/_(o-u*e))/3)):a=1-((n=(1-t)/3)+(i=(1+t*_(u*(e-=2/3))/_(o-u*e))/3)),[255*(a=b(r*a*3)),255*(n=b(r*n*3)),255*(i=b(r*i*3)),3<s.length?s[3]:1]},K=function(){var e,t,r,i=C(arguments),n=i[0],a=i[1],i=i[2];return u=2*Math.PI,n/=255,a/=255,i/=255,0==(r=1-Math.min(n,a,i)/(t=(n+a+i)/3))?e=0:(e=(n-a+(n-i))/2,e/=Math.sqrt((n-a)*(n-a)+(n-i)*(a-i)),e=Math.acos(e),a<i&&(e=u-e),e/=u),[360*e,r,t]},ne.hsi=function(){var e=f,t=E.call(arguments).concat(["hsi"]),r=function(){};return r.prototype=e.prototype,r=new r,e=e.apply(r,t),Object(e)===e?e:r},h.hsi=x,f.prototype.hsi=function(){return K(this._rgb)},U=function(e,t,r,i){var n,a,s,o,l,h,c,u,d,m;return"hsl"===i?(d=e.hsl(),m=t.hsl()):"hsv"===i?(d=e.hsv(),m=t.hsv()):"hcg"===i?(d=e.hcg(),m=t.hcg()):"hsi"===i?(d=e.hsi(),m=t.hsi()):"lch"!==i&&"hcl"!==i||(i="hcl",d=e.hcl(),m=t.hcl()),"h"===i.substr(0,1)&&(a=d[0],c=d[1],o=d[2],s=m[0],u=m[1],l=m[2]),isNaN(a)||isNaN(s)?isNaN(a)?isNaN(s)?n=Number.NaN:(n=s,1!==o&&0!==o||"hsv"===i||(h=u)):(n=a,1!==l&&0!==l||"hsv"===i||(h=c)):n=a+r*(a<s&&180<s-a?s-(a+360):s<a&&180<a-s?s+360-a:s-a),ne[i](n,h=null==h?c+r*(u-c):h,o+r*(l-o))},(c=c.concat((()=>{for(var e=["hsv","hsl","hsi","hcl","lch","hcg"],t=[],r=0,i=e.length;r<i;r++)t.push([e[r],U]);return t})())).push(["num",function(e,t,r,i){e=e.num(),t=t.num();return ne.num(e+(t-e)*r,"num")}]),c.push(["lab",function(e,t,r,i){e=e.lab(),t=t.lab();return new f(e[0]+r*(t[0]-e[0]),e[1]+r*(t[1]-e[1]),e[2]+r*(t[2]-e[2]),i)}])}.call(ph)}),vh="sRGB";let _h={scale:"uniform",mode:"hcl",domain:[0,1],value:16777215,reverse:!1},yh=new ze;function r(e,t,r){let i=r.value;return r.value=function(e,t){e=i.bind(this,e,t)();return"linear"==vh?(yh.set(e),yh.convertSRGBToLinear(),yh.getHex()):e},r}class i{constructor(e={}){this.parameters=Vl(e,_h),"string"==typeof this.parameters.value&&(this.parameters.value=yh.set(this.parameters.value).getHex()),this.parameters.structure&&(this.atomProxy=this.parameters.structure.getAtomProxy())}getScale(e={}){e=Vl(e,this.parameters);return"rainbow"===e.scale?e.scale=["red","orange","yellow","green","blue"]:"rwb"===e.scale&&(e.scale=["red","white","blue"]),e.reverse&&(e.domain=e.domain.slice().reverse()),gh.scale(e.scale).mode(e.mode).domain(e.domain).out("num")}colorToArray(e,t=[],r=0){return t[r]=(e>>16&255)/255,t[r+1]=(e>>8&255)/255,t[r+2]=(255&e)/255,t}atomColorToArray(e,t,r){return this.colorToArray(this.atomColor?this.atomColor(e):0,t,r)}bondColor(e,t){return this.atomProxy&&this.atomColor?(this.atomProxy.index=t?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):0}bondColorToArray(e,t,r,i){return this.colorToArray(this.bondColor(e,t),r,i)}volumeColorToArray(e,t,r){return this.colorToArray(this.volumeColor?this.volumeColor(e):0,t,r)}positionColorToArray(e,t,r){return this.colorToArray(this.positionColor?this.positionColor(e):0,t,r)}}var g,n=fh(function(e){function s(e,t,r,i,n){this._listener=t,this._isOnce=r,this.context=i,this._signal=e,this._priority=n||0}function i(e,t){if("function"!=typeof e)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}function t(){this._bindings=[],this._prevParams=null;var e=this;this.dispatch=function(){t.prototype.dispatch.apply(e,arguments)}}var r,n;r=ph,t.prototype={VERSION:"1.0.0",memorize:!(s.prototype={active:!0,params:null,execute:function(e){var t;return this.active&&this._listener&&(e=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,e),this._isOnce)&&this.detach(),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}}),_shouldPropagate:!0,active:!0,_registerListener:function(e,t,r,i){var n,a=this._indexOfListener(e,r);if(-1!==a){if((n=this._bindings[a]).isOnce()!==t)throw new Error("You cannot add"+(t?"":"Once")+"() then add"+(t?"Once":"")+"() the same listener without removing the relationship first.")}else n=new s(this,e,t,r,i),this._addBinding(n);return this.memorize&&this._prevParams&&n.execute(this._prevParams),n},_addBinding:function(e){for(var t=this._bindings.length;this._bindings[--t]&&e._priority<=this._bindings[t]._priority;);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){for(var r,i=this._bindings.length;i--;)if((r=this._bindings[i])._listener===e&&r.context===t)return i;return-1},has:function(e,t){return-1!==this._indexOfListener(e,t)},add:function(e,t,r){return i(e,"add"),this._registerListener(e,!1,t,r)},addOnce:function(e,t,r){return i(e,"addOnce"),this._registerListener(e,!0,t,r)},remove:function(e,t){i(e,"remove");t=this._indexOfListener(e,t);return-1!==t&&(this._bindings[t]._destroy(),this._bindings.splice(t,1)),e},removeAll:function(){for(var e=this._bindings.length;e--;)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(this.active){var t,r=Array.prototype.slice.call(arguments),i=this._bindings.length;if(this.memorize&&(this._prevParams=r),i)for(t=this._bindings.slice(),this._shouldPropagate=!0;t[--i]&&this._shouldPropagate&&!1!==t[i].execute(r););}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},(n=t).Signal=t,e.exports?e.exports=n:r.signals=n});(e=g=g||{})[e.PROTEIN=1]="PROTEIN",e[e.NUCLEIC=2]="NUCLEIC",e[e.RNA=3]="RNA",e[e.DNA=4]="DNA",e[e.POLYMER=5]="POLYMER",e[e.WATER=6]="WATER",e[e.HELIX=7]="HELIX",e[e.SHEET=8]="SHEET",e[e.TURN=9]="TURN",e[e.BACKBONE=10]="BACKBONE",e[e.SIDECHAIN=11]="SIDECHAIN",e[e.ALL=12]="ALL",e[e.HETERO=13]="HETERO",e[e.ION=14]="ION",e[e.SACCHARIDE=15]="SACCHARIDE",e[e.SUGAR=15]="SUGAR",e[e.BONDED=16]="BONDED",e[e.RING=17]="RING",e[e.AROMATICRING=18]="AROMATICRING",e[e.METAL=19]="METAL",e[e.POLARH=20]="POLARH",e[e.NONE=21]="NONE";let bh=["*","","ALL"],xh=["NONE"],Sh=[g.BACKBONE,g.SIDECHAIN,g.BONDED,g.RING,g.AROMATICRING,g.METAL,g.POLARH],wh=[g.POLYMER,g.WATER],Ah=["ALA","GLY","SER"],Mh=["CYS","SER","THR"],Ch=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],Th=["PHE","TRP","TYR","HIS"],Eh=["ASN","GLN"],Ph=["ASP","GLU"],Ih=["ARG","HIS","LYS"],Rh=["ARG","ASP","GLU","HIS","LYS"],Dh=["ASN","ARG","ASP","CYS","GLY","GLN","GLU","HIS","LYS","SER","THR","TYR"],Lh=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],Oh=["HIS","PHE","PRO","TRP","TYR"],kh=["ALA","GLY","ILE","LEU","VAL"];function Nh(e){let t={operator:void 0,rules:[]};if(!e)return t;let r=t,i,n,a=[];var s=(e="("===(e=e.replace(/\(/g," ( ").replace(/\)/g," ) ").trim()).charAt(0)&&")"===e.substr(-1)?e.slice(1,-1).trim():e).split(/\s+/);let o=e=>{i={operator:e,rules:[]},void 0===r?(r=i,t=i):(r.rules.push(i),a.push(r),r=i)};function l(e){n=r,void 0===(r=a.pop())&&(o(e),h(n))}function h(e){r.rules.push(e)}let c=!1;for(let e=0;e<s.length;++e){var u=s[e],d=u.toUpperCase();if("("===u)c=!1,o();else if(")"===u)l(),r.negate&&l();else{if(0<c)if("NOT"===d)c=1;else if(1===c)c=2;else{if(2!==c)throw new Error("something went wrong with 'not'");c=!1,l()}if("AND"===d)"OR"===r.operator?(m=r.rules.pop(),o("AND"),h(m)):r.operator="AND";else if("OR"===d)"AND"===r.operator?l("OR"):r.operator="OR";else if("NOT"===u.toUpperCase())c=1,o(),r.negate=!0;else{if(+d!=+d){var m=g[d];if(void 0!==m){h({keyword:m});continue}}if("HYDROGEN"===d)h({operator:"OR",rules:[{element:"H"},{element:"D"}]});else if("SMALL"===d)h({resname:Ah});else if("NUCLEOPHILIC"===d)h({resname:Mh});else if("HYDROPHOBIC"===d)h({resname:Ch});else if("AROMATIC"===d)h({resname:Th});else if("AMIDE"===d)h({resname:Eh});else if("ACIDIC"===d)h({resname:Ph});else if("BASIC"===d)h({resname:Ih});else if("CHARGED"===d)h({resname:Rh});else if("POLAR"===d)h({resname:Dh});else if("NONPOLAR"===d)h({resname:Lh});else if("CYCLIC"===d)h({resname:Oh});else if("ALIPHATIC"===d)h({resname:kh});else if("SIDECHAINATTACHED"===d)h({operator:"OR",rules:[{keyword:g.SIDECHAIN},{operator:"AND",negate:!1,rules:[{keyword:g.PROTEIN},{operator:"OR",negate:!1,rules:[{atomname:"CA"},{atomname:"BB"}]}]},{operator:"AND",negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{operator:"AND",negate:!1,rules:[{keyword:g.NUCLEIC},{operator:"OR",negate:!0,rules:[{atomname:"P"},{atomname:"OP1"},{atomname:"OP2"},{atomname:"O3'"},{atomname:"O3*"},{atomname:"HO3'"},{atomname:"O5'"},{atomname:"O5*"},{atomname:"HO5'"},{atomname:"C5'"},{atomname:"C5*"},{atomname:"H5'"},{atomname:"H5''"}]}]}]});else if("APOLARH"===d)h({operator:"AND",negate:!1,rules:[{element:"H"},{negate:!0,operator:void 0,rules:[{keyword:g.POLARH}]}]});else if("LIGAND"===d)h({operator:"AND",rules:[{operator:"OR",rules:[{operator:"AND",rules:[{keyword:g.HETERO},{negate:!0,operator:void 0,rules:[{keyword:g.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{keyword:g.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{operator:"OR",rules:[{keyword:g.WATER},{keyword:g.ION}]}]}]});else if(-1!==bh.indexOf(d))h({keyword:g.ALL});else if("@"===u.charAt(0)){var p=u.substr(1).split(",").map(e=>parseInt(e));p.sort(function(e,t){return e-t}),h({atomindex:p})}else if("#"===u.charAt(0))console.error("# for element selection deprecated, use _"),h({element:d.substr(1)});else if("_"===u.charAt(0))h({element:d.substr(1)});else if("["===u[0]&&"]"===u[u.length-1]){var p=d.substr(1,u.length-2).split(","),f=1<p.length?p:p[0];h({resname:f})}else if(1<=u.length&&u.length<=4&&"^"!==u[0]&&":"!==u[0]&&"."!==u[0]&&"%"!==u[0]&&"/"!==u[0]&&isNaN(parseInt(u)))h({resname:d});else{f={operator:"AND",rules:[]},d=u.split("/");if(1<d.length&&d[1]){if(isNaN(parseInt(d[1])))throw new Error("model must be an integer");f.rules.push({model:parseInt(d[1])})}u=d[0].split("%"),d=(1<u.length&&f.rules.push({altloc:u[1]}),u[0].split("."));if(1<d.length&&d[1]){if(4<d[1].length)throw new Error("atomname must be one to four characters");f.rules.push({atomname:d[1].substring(0,4).toUpperCase()})}u=d[0].split(":"),d=(1<u.length&&u[1]&&f.rules.push({chainname:u[1]}),u[0].split("^"));if(1<d.length&&f.rules.push({inscode:d[1]}),d[0]){let t,e;"-"===d[0][0]&&(d[0]=d[0].substr(1),t=!0),d[0].includes("--")&&(d[0]=d[0].replace("--","-"),e=!0);u=d[0].split("-");if(1===u.length){let e=parseInt(u[0]);if(isNaN(e))throw new Error("resi must be an integer");t&&(e*=-1),f.rules.push({resno:e})}else{if(2!==u.length)throw new Error("resi range must contain one '-'");d=u.map(e=>parseInt(e));t&&(d[0]*=-1),e&&(d[1]*=-1),f.rules.push({resno:[d[0],d[1]]})}}if(1===f.rules.length)h(f.rules[0]);else{if(!(1<f.rules.length))throw new Error("empty selection chunk");h(f)}}}}}return t=void 0===t.operator&&1===t.rules.length&&t.rules[0].hasOwnProperty("operator")?t.rules[0]:t}function Fh(e,t){if(void 0===t.atomname&&void 0===t.element&&void 0===t.altloc&&void 0===t.atomindex&&void 0===t.keyword&&void 0===t.inscode&&void 0===t.resname&&void 0===t.sstruc&&void 0===t.resno&&void 0===t.chainname&&void 0===t.model)return-1;if(void 0!==t.keyword){if(t.keyword===g.BACKBONE&&!e.isBackbone())return!1;if(t.keyword===g.SIDECHAIN&&!e.isSidechain())return!1;if(t.keyword===g.BONDED&&!e.isBonded())return!1;if(t.keyword===g.RING&&!e.isRing())return!1;if(t.keyword===g.AROMATICRING&&!e.isAromatic())return!1;if(t.keyword===g.HETERO&&!e.isHetero())return!1;if(t.keyword===g.PROTEIN&&!e.isProtein())return!1;if(t.keyword===g.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===g.RNA&&!e.isRna())return!1;if(t.keyword===g.DNA&&!e.isDna())return!1;if(t.keyword===g.POLYMER&&!e.isPolymer())return!1;if(t.keyword===g.WATER&&!e.isWater())return!1;if(t.keyword===g.HELIX&&!e.isHelix())return!1;if(t.keyword===g.SHEET&&!e.isSheet())return!1;if(t.keyword===g.TURN&&!e.isTurn())return!1;if(t.keyword===g.ION&&!e.isIon())return!1;if(t.keyword===g.SACCHARIDE&&!e.isSaccharide())return!1;if(t.keyword===g.METAL&&!e.isMetal())return!1;if(t.keyword===g.POLARH&&!e.isPolarHydrogen())return!1}if(void 0!==t.atomname&&t.atomname!==e.atomname)return!1;if(void 0!==t.element&&t.element!==e.element)return!1;if(void 0!==t.altloc&&t.altloc!==e.altloc)return!1;if(void 0!==t.atomindex&&Wl(t.atomindex,e.index)<0)return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&!(void 0!==t.chainname&&t.chainname!==e.chainname||void 0!==t.model&&t.model!==e.modelIndex)}function Bh(e,t){if(void 0===t.resname&&void 0===t.resno&&void 0===t.inscode&&void 0===t.sstruc&&void 0===t.model&&void 0===t.chainname&&void 0===t.atomindex&&(void 0===t.keyword||Sh.includes(t.keyword)))return-1;if(void 0!==t.keyword){if(t.keyword===g.HETERO&&!e.isHetero())return!1;if(t.keyword===g.PROTEIN&&!e.isProtein())return!1;if(t.keyword===g.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===g.RNA&&!e.isRna())return!1;if(t.keyword===g.DNA&&!e.isDna())return!1;if(t.keyword===g.POLYMER&&!e.isPolymer())return!1;if(t.keyword===g.WATER&&!e.isWater())return!1;if(t.keyword===g.HELIX&&!e.isHelix())return!1;if(t.keyword===g.SHEET&&!e.isSheet())return!1;if(t.keyword===g.TURN&&!e.isTurn())return!1;if(t.keyword===g.ION&&!e.isIon())return!1;if(t.keyword===g.SACCHARIDE&&!e.isSaccharide())return!1}if(void 0!==t.atomindex&&0===ql(t.atomindex,e.atomOffset,e.atomEnd))return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&!(void 0!==t.chainname&&t.chainname!==e.chainname||void 0!==t.model&&t.model!==e.modelIndex)}function Uh(e,t){if(!(void 0!==t.chainname||void 0!==t.model||void 0!==t.atomindex||void 0!==t.keyword&&wh.includes(t.keyword)&&e.entity))return-1;if(void 0!==t.keyword){if(t.keyword===g.POLYMER&&!e.entity.isPolymer())return!1;if(t.keyword===g.WATER&&!e.entity.isWater())return!1}return(void 0===t.atomindex||0!==ql(t.atomindex,e.atomOffset,e.atomEnd))&&!(void 0!==t.chainname&&t.chainname!==e.chainname||void 0!==t.model&&t.model!==e.modelIndex)}function zh(e,t){return void 0===t.model&&void 0===t.atomindex?-1:!(void 0!==t.atomindex&&0===ql(t.atomindex,e.atomOffset,e.atomEnd)||void 0!==t.model&&t.model!==e.index)}function Vh(s,o){if(null===s)return!1;if(s.error)return!1;if(!s.rules||0===s.rules.length)return!1;let t=s.rules.length,l=!s.negate,h=!!s.negate,c=[];for(let e=0;e<t;++e){var r=s.rules[e];r.hasOwnProperty("operator")&&(c[e]=Vh(r,o))}return function(i){var n="AND"===s.operator;let a=!1;for(let r=0;r<t;++r){var e=s.rules[r];let t;if(e.hasOwnProperty("operator")){let e=c[r];if(-1===(t=!1!==e?e(i):-1))a=!0;else if(!0!==t){if(n)return h}else if(!n)return l}else{if(e.keyword===g.ALL){if(n)continue;return l}if(e.keyword===g.NONE){if(n)continue;return h}if(-1===(t=o(i,e)))a=!0;else if(!0!==t){if(n)return h}else if(!n)return l}}return a?-1:n?l:h}}function Gh(t,r){if(t.error)return t;if(!t.rules||0===t.rules.length)return t;var i=t.rules.length,n={operator:t.operator,rules:[]};t.hasOwnProperty("negate")&&(n.negate=t.negate);for(let e=0;e<i;++e){var a,s=t.rules[e];s.hasOwnProperty("operator")?null!==(a=Gh(s,r))&&n.rules.push(a):r(s)||n.rules.push(s)}return 0<n.rules.length?t:null}function Hh(e,t=!1){let r=e;return Vh(r=t?Gh(e,function(e){return void 0!==e.keyword&&!Sh.includes(e.keyword)||void 0!==e.model||void 0!==e.chainname||void 0!==e.resname||void 0!==e.resno||void 0!==e.sstruc}):r,Fh)}function $h(e,t=!1){let r=e;return Vh(r=t?Gh(e,function(e){return!(void 0===e.keyword||!Sh.includes(e.keyword))||void 0!==e.model||void 0!==e.chainname||void 0!==e.atomname||void 0!==e.element||void 0!==e.altloc}):r,Bh)}function jh(e,t=!1){let r=e;return Vh(r=t?Gh(e,function(e){return void 0!==e.keyword&&!wh.includes(e.keyword)||void 0!==e.resname||void 0!==e.resno||void 0!==e.atomname||void 0!==e.element||void 0!==e.altloc||void 0!==e.sstruc||void 0!==e.inscode}):r,Uh)}function Wh(e,t=!1){let r=e;return Vh(r=t?Gh(e,function(e){return void 0!==e.keyword||void 0!==e.chainname||void 0!==e.resname||void 0!==e.resno||void 0!==e.atomname||void 0!==e.element||void 0!==e.altloc||void 0!==e.sstruc||void 0!==e.inscode}):r,zh)}class qh{constructor(e){this.signals={stringChanged:new n.Signal},this.setString(e)}get type(){return"selection"}setString(e,t){if((e=void 0===e?this.string||"":e)!==this.string){try{this.selection=Nh(e)}catch(e){this.selection={error:e.message}}var r=this.selection;this.string=e,this.test=Hh(r),this.residueTest=$h(r),this.chainTest=jh(r),this.modelTest=Wh(r),this.atomOnlyTest=Hh(r,!0),this.residueOnlyTest=$h(r,!0),this.chainOnlyTest=jh(r,!0),this.modelOnlyTest=Wh(r,!0),t||this.signals.stringChanged.dispatch(this.string)}}isAllSelection(){return bh.includes(this.string.toUpperCase())}isNoneSelection(){return xh.includes(this.string.toUpperCase())}}class Xh extends i{constructor(e){super(e),this.colormakerList=[],this.selectionList=[],(e.dataList||[]).forEach(e=>{var[e,t,r={}]=e;k.hasScheme(e)?Object.assign(r,{scheme:e,structure:this.parameters.structure}):Object.assign(r,{scheme:"uniform",value:new ze(e).getHex()}),this.colormakerList.push(k.getScheme(r)),this.selectionList.push(new qh(t))})}atomColor(r){for(let e=0,t=this.selectionList.length;e<t;++e){var i=this.selectionList[e].test;if(i&&i(r))return this.colormakerList[e].atomColor(r)}return 16777215}}let Yh={"":"",OrRd:"[S] Orange-Red",PuBu:"[S] Purple-Blue",BuPu:"[S] Blue-Purple",Oranges:"[S] Oranges",BuGn:"[S] Blue-Green",YlOrBr:"[S] Yellow-Orange-Brown",YlGn:"[S] Yellow-Green",Reds:"[S] Reds",RdPu:"[S] Red-Purple",Greens:"[S] Greens",YlGnBu:"[S] Yellow-Green-Blue",Purples:"[S] Purples",GnBu:"[S] Green-Blue",Greys:"[S] Greys",YlOrRd:"[S] Yellow-Orange-Red",PuRd:"[S] Purple-Red",Blues:"[S] Blues",PuBuGn:"[S] Purple-Blue-Green",Viridis:"[D] Viridis",Spectral:"[D] Spectral",RdYlGn:"[D] Red-Yellow-Green",RdBu:"[D] Red-Blue",PiYG:"[D] Pink-Yellowgreen",PRGn:"[D] Purplered-Green",RdYlBu:"[D] Red-Yellow-Blue",BrBG:"[D] Brown-Bluegreen",RdGy:"[D] Red-Grey",PuOr:"[D] Purple-Orange",Set1:"[Q] Set1",Set2:"[Q] Set2",Set3:"[Q] Set3",Dark2:"[Q] Dark2",Paired:"[Q] Paired",Pastel1:"[Q] Pastel1",Pastel2:"[Q] Pastel2",Accent:"[Q] Accent",rainbow:"[?] Rainbow",rwb:"[?] Red-White-Blue"},Kh={"":"",rgb:"Red Green Blue",hsv:"Hue Saturation Value",hsl:"Hue Saturation Lightness",hsi:"Hue Saturation Intensity",lab:"CIE L*a*b*",hcl:"Hue Chroma Lightness"};class Zh{constructor(){this.schemes={},this.userSchemes={}}getScheme(e){var t=((e||{}).scheme||"").toLowerCase();let r;return new(r=t in this.schemes?this.schemes[t]:t in this.userSchemes?this.userSchemes[t]:i)(e)}getSchemes(){let t={};return Object.keys(this.schemes).forEach(function(e){t[e]=e}),Object.keys(this.userSchemes).forEach(function(e){t[e]=e.split("|")[1]}),t}getScales(){return Yh}getModes(){return Kh}add(e,t){e=e.toLowerCase(),this.schemes[e]=t}addScheme(e,t){return e instanceof i||(e=this._createScheme(e)),this._addUserScheme(e,t)}_addUserScheme(e,t){t=t||"";t=(hh()+"|"+t).toLowerCase();return this.userSchemes[t]=e,t}removeScheme(e){e=e.toLowerCase(),delete this.userSchemes[e]}_createScheme(t){class e extends i{constructor(e){super(e),t.call(this,e)}}return e}addSelectionScheme(t,e){class r extends Xh{constructor(e){super(Object.assign({dataList:t},e))}}return this._addUserScheme(r,e)}hasScheme(e){return(e=e.toLowerCase())in this.schemes||e in this.userSchemes}}class Qh extends ah{constructor(){super("parser")}__hasObjName(e,t){e=this.get(e);return e&&e.prototype.__objName===t}isTrajectory(e){return this.__hasObjName(e,"frames")}isStructure(e){return this.__hasObjName(e,"structure")}isVolume(e){return this.__hasObjName(e,"volume")}isSurface(e){return this.__hasObjName(e,"surface")}isBinary(e){e=this.get(e);return e&&e.prototype.isBinary}isXml(e){e=this.get(e);return e&&e.prototype.isXml}isJson(e){e=this.get(e);return e&&e.prototype.isJson}getTrajectoryExtensions(){return this.names.filter(e=>this.isTrajectory(e))}getStructureExtensions(){return this.names.filter(e=>this.isStructure(e))}getVolumeExtensions(){return this.names.filter(e=>this.isVolume(e))}getSurfaceExtensions(){return this.names.filter(e=>this.isSurface(e))}}function Jh(e){return Xl(function t(e){let r=e;return e.forEach(function(e){e.__deps&&Array.prototype.push.apply(r,t(e.__deps))}),r}(e)).map(function(e){return e.toString()}).join("\n\n\n")}function ec(e,t){t="'use strict';\n\n"+Jh(t),t=(t+="\n\n\nself.func = "+e.toString()+";")+"\n\n\nself.onmessage = "+function(e){var t=e.data.__name;let r=e.data.__postId;void 0===t?console.error("message __name undefined"):void 0===self.func?console.error("worker func undefined",t):self.func(e,function(t,e){t=t||{},void 0!==r&&(t.__postId=r);try{self.postMessage(t,e)}catch(e){console.error("self.postMessage:",e),self.postMessage(t)}})}.toString()+";";return new Blob([t],{type:"application/javascript"})}let tc=Hl(),rc=!1;try{var ic=Object.defineProperty({},"passive",{get:function(){rc=!0}});window.addEventListener("test",e=>{},ic)}catch(e){}let nc="undefined"!=typeof window&&void 0!==window.orientation,ac=!1;function sc(e){ac=e}let oc=!1;function lc(e){oc=e}let rt={log:Function.prototype.bind.call(console.log,console),info:Function.prototype.bind.call(console.info,console),warn:Function.prototype.bind.call(console.warn,console),error:Function.prototype.bind.call(console.error,console),time:Function.prototype.bind.call(console.time,console),timeEnd:Function.prototype.bind.call(console.timeEnd,console)},hc={color:"green",labelColor:8421504,labelAttachment:"bottom-center",labelSize:.7,labelZOffset:.5,labelYOffset:.1,labelBorder:!0,labelBorderColor:13882323,labelBorderWidth:.25,lineOpacity:.8,linewidth:5,opacity:.6,labelUnit:"angstrom",arcVisible:!0,planeVisible:!1};Je.Debug=!!(t=zl("debug"))&&("string"!=typeof t||/^1|true|t|yes|y$/i.test(t));let cc=["ngl","js"],uc=new class{constructor(){this.activeWorkerCount=0,this._funcDict={},this._depsDict={},this._blobDict={}}add(e,t,r){this._funcDict[e]=t,this._depsDict[e]=r}get(e){return this._blobDict[e]||(this._blobDict[e]=ec(this._funcDict[e],this._depsDict[e])),this._blobDict[e]}},k=new Zh,dc=new ah("datasource"),mc=new ah("representatation"),a=new Qh,s=new ah("shader"),pc=new ah("decompressor"),fc=new ah("component"),gc=new ah("buffer"),vc=new ah("picker");Je.ListingDatasource=void 0,Je.TrajectoryDatasource=void 0;class _c{constructor(e,t={}){this.chunkSize=10485760,this.newline="\n",this.__pointer=0,this.__partialLine="",this.compressed=ce(t.compressed,!1),this.binary=ce(t.binary,!1),this.json=ce(t.json,!1),this.xml=ce(t.xml,!1),this.src=e}isBinary(){return this.binary||this.compressed}read(){return this._read().then(e=>{var t=this.compressed?pc.get(this.compressed):void 0;return this.compressed&&t?this.data=t(e):((this.binary||this.compressed)&&e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.data=e),this.data})}_chunk(e,t){return t=Math.min(this.data.length,t),0===e&&this.data.length===t?this.data:this.isBinary()?this.data.subarray(e,t):this.data.substring(e,t)}chunk(e){var t=e+this.chunkSize;return this._chunk(e,t)}peekLines(e){var t=this.data,r=t.length,i=this.isBinary()?this.newline.charCodeAt(0):this.newline;let n,a=0;for(n=0;n<r&&(t[n]===i&&++a,a!==e);++n);var s=this._chunk(0,n+1);return this.chunkToLines(s,"",n>r).lines}chunkCount(){return Math.floor(this.data.length/this.chunkSize)+1}asText(){return this.isBinary()?Yl(this.data):this.data}chunkToLines(e,t,r){var i=this.newline;if(!this.isBinary()&&e.length===this.data.length)return{lines:e.split(i),partialLine:""};let n=[];var a,e=this.isBinary()?Yl(e):e,s=e.lastIndexOf(i);return-1===s?t+=e:(a=t+e.substr(0,s),n=n.concat(a.split(i)),t=s===e.length-i.length?"":e.substr(s+i.length)),r&&""!==t&&n.push(t),{lines:n,partialLine:t}}nextChunk(){var e=this.__pointer;if(!(e>this.data.length))return this.__pointer+=this.chunkSize,this.chunk(e)}nextChunkOfLines(){var e,t=this.nextChunk();if(void 0!==t)return e=this.__pointer>this.data.length,t=this.chunkToLines(t,this.__partialLine,e),this.__partialLine=t.partialLine,t.lines}eachChunk(t){var r=this.chunkSize,i=this.data.length,n=this.chunkCount();for(let e=0;e<i;e+=r)t(this.chunk(e),Math.round(e/r),n)}eachChunkOfLines(i){this.eachChunk((e,t,r)=>{e=this.chunkToLines(e,this.__partialLine,t===r+1);this.__partialLine=e.partialLine,i(e.lines,t,r)})}dispose(){delete this.src}}class yc extends _c{_read(){return new Promise((t,r)=>{var e=this.src,i=new FileReader;i.onload=e=>{e.target&&t(e.target.result)},i.onerror=e=>r(e),this.binary||this.compressed?i.readAsArrayBuffer(e):i.readAsText(e)})}}class bc extends _c{_read(){return new Promise((e,t)=>{var r=this.src;let i=new XMLHttpRequest;i.open("GET",r,!0),i.addEventListener("load",()=>{if(200===i.status||304===i.status||0===i.status)try{e(i.response)}catch(e){t(e)}else t(i.statusText)},!1),i.addEventListener("error",e=>t("network error"),!1),this.isBinary()?i.responseType="arraybuffer":this.json?i.responseType="json":this.xml?i.responseType="document":i.responseType="text",i.send()})}}class xc{constructor(e,t={}){this.parameters=Vl(t,{ext:"",compressed:!1,binary:a.isBinary(t.ext||""),name:"",dir:"",path:"",protocol:""});t={compressed:this.parameters.compressed,binary:this.parameters.binary,json:a.isJson(this.parameters.ext),xml:a.isXml(this.parameters.ext)};"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob?this.streamer=new yc(e,t):this.streamer=new bc(e,t)}}class Sc extends xc{constructor(e,t={}){super(e,t),this.parserParams={voxelSize:t.voxelSize,firstModelOnly:t.firstModelOnly,asTrajectory:t.asTrajectory,cAlphaOnly:t.cAlphaOnly,delimiter:t.delimiter,comment:t.comment,columnNames:t.columnNames,inferBonds:t.inferBonds,name:this.parameters.name,path:this.parameters.path}}load(){return new(a.get(this.parameters.ext))(this.streamer,this.parserParams).parse()}}class wc{constructor(e,t,r){this.name=t,this.path=r,this.signals={elementAdded:new n.Signal,elementRemoved:new n.Signal,nameChanged:new n.Signal},this.type="Script",this.dir=r.substring(0,r.lastIndexOf("/")+1);try{this.fn=new Function("stage","__name","__path","__dir",e)}catch(e){rt.error("Script compilation failed",e),this.fn=function(){}}}run(r){return new Promise((e,t)=>{try{this.fn.apply(null,[r,this.name,this.path,this.dir]),e()}catch(e){rt.error("Script.fn",e),t(e)}})}}class Ac extends xc{load(){return this.streamer.read().then(()=>new wc(this.streamer.asText(),this.parameters.name,this.parameters.path))}}function Mc(e){var t=pc.names;let r,i,n="";var a=(r=e instanceof File?e.name:e instanceof Blob?"":e).lastIndexOf("?"),s=-1!==a?r.substring(a):"",a=(r=r.substring(0,-1===a?r.length:a)).replace(/^.*[\\/]/,"");let o=a.substring(0,a.lastIndexOf("."));var l=a.split(".");let h=1<l.length?(l.pop()||"").toLowerCase():"";l=r.match(/^(.+):\/\/(.+)$/),l&&(n=l[1].toLowerCase(),r=l[2]||""),l=r.substring(0,r.lastIndexOf("/")+1);return t.includes(h)?(i=h,t=r.length-h.length-1,h=(r.substr(0,t).split(".").pop()||"").toLowerCase(),t=o.length-h.length-1,o=o.substr(0,t)):i=!1,{path:r,name:a,ext:h,base:o,dir:l,compressed:i,protocol:n,query:s,src:e}}function Cc(e){let t=Mc(e);var r=dc.get(t.protocol);return r&&!(t=Mc(r.getUrl(t.src))).ext&&r.getExt&&(t.ext=r.getExt(e)),t}function Tc(e,t={}){e=Object.assign(Cc(e),t);let r;return a.names.includes(e.ext)?r=new Sc(e.src,e):cc.includes(e.ext)&&(r=new Ac(e.src,e)),r?r.load():Promise.reject(new Error(`autoLoad: ext '${e.ext}' unknown`))}var Ec=fh(function(e,t){function p(e){var t,r,i,n,a,s,o,l,h=(e=>{if(g[e])return g[e];for(var t,r=e,i=[],n=0;r;){if(null!==(t=f.text.exec(r)))i.push(t[0]);else if(null!==(t=f.modulo.exec(r)))i.push("%");else{if(null===(t=f.placeholder.exec(r)))throw new SyntaxError("[sprintf] unexpected placeholder");if(t[2]){n|=1;var a=[],s=t[2],o=[];if(null===(o=f.key.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(a.push(o[1]);""!==(s=s.substring(o[0].length));){if(null===(o=f.key_access.exec(s))&&null===(o=f.index_access.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");a.push(o[1])}t[2]=a}else n|=2;if(3===n)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");i.push({placeholder:t[0],param_no:t[1],keys:t[2],sign:t[3],pad_char:t[4],align:t[5],width:t[6],precision:t[7],type:t[8]})}r=r.substring(t[0].length)}return g[e]=i})(e),c=arguments,u=1,d=h.length,m="";for(r=0;r<d;r++)if("string"==typeof h[r])m+=h[r];else if("object"==typeof h[r]){if((n=h[r]).keys)for(t=c[u],i=0;i<n.keys.length;i++){if(null==t)throw new Error(p('[sprintf] Cannot access property "%s" of undefined value "%s"',n.keys[i],n.keys[i-1]));t=t[n.keys[i]]}else t=n.param_no?c[n.param_no]:c[u++];if(f.not_type.test(n.type)&&f.not_primitive.test(n.type)&&t instanceof Function&&(t=t()),f.numeric_arg.test(n.type)&&"number"!=typeof t&&isNaN(t))throw new TypeError(p("[sprintf] expecting number but found %T",t));switch(f.number.test(n.type)&&(o=0<=t),n.type){case"b":t=parseInt(t,10).toString(2);break;case"c":t=String.fromCharCode(parseInt(t,10));break;case"d":case"i":t=parseInt(t,10);break;case"j":t=JSON.stringify(t,null,n.width?parseInt(n.width):0);break;case"e":t=n.precision?parseFloat(t).toExponential(n.precision):parseFloat(t).toExponential();break;case"f":t=n.precision?parseFloat(t).toFixed(n.precision):parseFloat(t);break;case"g":t=n.precision?String(Number(t.toPrecision(n.precision))):parseFloat(t);break;case"o":t=(parseInt(t,10)>>>0).toString(8);break;case"s":t=String(t),t=n.precision?t.substring(0,n.precision):t;break;case"t":t=String(!!t),t=n.precision?t.substring(0,n.precision):t;break;case"T":t=Object.prototype.toString.call(t).slice(8,-1).toLowerCase(),t=n.precision?t.substring(0,n.precision):t;break;case"u":t=parseInt(t,10)>>>0;break;case"v":t=t.valueOf(),t=n.precision?t.substring(0,n.precision):t;break;case"x":t=(parseInt(t,10)>>>0).toString(16);break;case"X":t=(parseInt(t,10)>>>0).toString(16).toUpperCase()}f.json.test(n.type)?m+=t:(!f.number.test(n.type)||o&&!n.sign?l="":(l=o?"+":"-",t=t.toString().replace(f.sign,"")),a=n.pad_char?"0"===n.pad_char?"0":n.pad_char.charAt(1):" ",s=n.width-(l+t).length,s=n.width&&0<s?a.repeat(s):"",m+=n.align?l+t+s:"0"===a?l+s+t:s+l+t)}return m}function r(e,t){return p.apply(null,[e].concat(t||[]))}var f,g;f={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/},g=Object.create(null),t.sprintf=p,t.vsprintf=r,"undefined"!=typeof window&&(window.sprintf=p,window.vsprintf=r)});class Pc{getBlob(){return new Blob([this.getData()],{type:this.mimeType})}download(e,t){e=ce(e,this.defaultName),t=ce(t,this.defaultExt),jl(this.getBlob(),e+"."+t)}}class Ic extends Pc{constructor(e,t){super(),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="pdb";var t=Object.assign({},t);this.renumberSerial=ce(t.renumberSerial,!0),this.remarks=(t=ce(t.remarks,[]),Array.isArray(t)?t:[t]),this.structure=e,this._records=[]}_writeRecords(){this._records.length=0,this._writeTitle(),this._writeRemarks(),this._writeAtoms()}_writeTitle(){this._records.push(Ec.sprintf("TITLE %-74s",this.structure.name))}_writeRemarks(){this.remarks.forEach(e=>{this._records.push(Ec.sprintf("REMARK %-73s",e))}),this.structure.trajectory&&(this._records.push(Ec.sprintf("REMARK %-73s","Trajectory '"+this.structure.trajectory.name+"'")),this._records.push(Ec.sprintf("REMARK %-73s","Frame "+this.structure.trajectory.frame)))}_writeAtoms(){let n=1,t=1,a=" ",s=" ",r=1<this.structure.modelStore.count;this.structure.eachModel(e=>{r&&this._records.push(Ec.sprintf("MODEL     %4d%-66s",t++,"")),e.eachAtom(e=>{var t=e.hetero?"HETATM%5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s%1s%1s":"ATOM  %5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s%1s%1s",r=this.renumberSerial?n:e.serial;let i=e.atomname;(1===i.length||i.length<4&&1===e.element.length&&i[0]===e.element)&&(i=" "+i),s=e.formalCharge?(a=Math.abs(e.formalCharge).toPrecision(1),0<e.formalCharge?"+":"-"):a=" ",this._records.push(Ec.sprintf(t,r,i,e.resname,ce(e.chainname," "),e.resno,e.x,e.y,e.z,ce(e.occupancy,1),ce(e.bfactor,0),"",ce(e.element,""),a,s)),n+=1},this.structure.getSelection()),r&&this._records.push(Ec.sprintf("%-80s","ENDMDL"))}),this._records.push(Ec.sprintf("%-80s","END"))}getString(){return console.warn("PdbWriter.getString() is deprecated, use .getData instead"),this.getData()}getData(){return this._writeRecords(),this._records.join("\n")}}class Rc extends Pc{constructor(e){super(),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="sdf",this.structure=e,this._records=[]}get idString(){return this.structure.id}get titleString(){return"  "+this.structure.title}get countsString(){return Ec.sprintf("%3i%3i  0  0  0  0  0  0  0  0999 V2000",this.structure.atomCount,this.structure.bondCount)}get chargeLines(){let i=[];this.structure.eachAtom(e=>{null!=e.formalCharge&&0!==e.formalCharge&&i.push([e.index,e.formalCharge])});var e=[];for(let r=0;r<i.length;r+=8){var n=Math.min(8,i.length-r);let t=Ec.sprintf("M  CHG%3i",n);for(let e=r;e<r+n;e++)t+=Ec.sprintf(" %3i %3i",i[e][0]+1,i[e][1]);e.push(t)}return e}formatAtom(e){let t=0;null!=e.formalCharge&&0!==e.formalCharge&&(t=4-e.formalCharge);e=Ec.sprintf("%10.4f%10.4f%10.4f %-3s 0%3i  0  0  0",e.x,e.y,e.z,e.element,t);if(48!==e.length)throw new Error("Incompatible atom for sdf format");return e}formatBond(e){return Ec.sprintf("%3i%3i%3i  0  0  0",e.atomIndex1+1,e.atomIndex2+1,e.bondOrder)}_writeRecords(){this._records.length=0,this._writeHeader(),this._writeCTab(),this._writeFooter()}_writeHeader(){this._records.push(this.idString,this.titleString,"")}_writeCTab(){this._records.push(this.countsString),this.structure.eachAtom(e=>{this._records.push(this.formatAtom(e))}),this.structure.eachBond(e=>{this._records.push(this.formatBond(e))}),this.chargeLines.forEach(e=>{this._records.push(e)}),this._records.push("M  END")}_writeFooter(){this._records.push("$$$$")}getData(){return this._writeRecords(),this._records.join("\n")}}let Dc=[];class Lc{constructor(e,t={}){this._mark=0,this._marks=[],this.offset=0;let r=!(this.littleEndian=!0);"number"==typeof(e=void 0===e?8192:e)?e=new ArrayBuffer(e):r=!0;var t=t.offset?t.offset>>>0:0,i=e.byteLength-t;let n=t;e instanceof ArrayBuffer||(e.byteLength!==e.buffer.byteLength&&(n=e.byteOffset+t),e=e.buffer),r?this._lastWrittenByte=i:this._lastWrittenByte=0,this.buffer=e,this.length=i,this.byteLength=i,this.byteOffset=n,this._data=new DataView(this.buffer,n,i)}available(e){return this.offset+(e=void 0===e?1:e)<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e){return this.offset+=e=void 0===e?1:e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){var e=this._marks.pop();if(void 0===e)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e){var t;return this.available(e=void 0===e?1:e)||(e=2*(this.offset+e),(t=new Uint8Array(e)).set(new Uint8Array(this.buffer)),this.buffer=t.buffer,this.length=this.byteLength=e,this._data=new DataView(this.buffer)),this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){void 0===e&&(e=1);for(var t=new Uint8Array(e),r=0;r<e;r++)t[r]=this.readByte();return t}readInt16(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return String.fromCharCode(this.readInt8())}readChars(e=1){Dc.length=e;for(var t=0;t<e;t++)Dc[t]=this.readChar();return Dc.join("")}writeBoolean(e=!1){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(var t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(var t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));return this}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}class Oc extends Pc{constructor(e){super(),this.mimeType="application/vnd.ms-pki.stl",this.defaultName="surface",this.defaultExt="stl",this.surface=e}getData(){var t=this.surface.index.length/3,e=2*t+3*t*4*4+80+4,r=new Lc(e),i=(r.skip(80),r.writeUint32(t),new et),n=new et,a=new et,s=new et;for(let e=0;e<t;e++){var o=[this.surface.index[3*e],this.surface.index[3*e+1],this.surface.index[3*e+2]];n.fromArray(this.surface.normal,3*o[0]),a.fromArray(this.surface.normal,3*o[1]),s.fromArray(this.surface.normal,3*o[2]),i.addVectors(n,a).add(s).normalize(),r.writeFloat32(i.x),r.writeFloat32(i.y),r.writeFloat32(i.z);for(let e=0;e<3;e++)i.fromArray(this.surface.position,3*o[e]),r.writeFloat32(i.x),r.writeFloat32(i.y),r.writeFloat32(i.z);r.writeUint16(0)}return new DataView(r.buffer)}}class kc{constructor(){this.count=0,this.signals={countChanged:new n.Signal}}clear(){this.change(-this.count)}change(e){this.count+=e,this.signals.countChanged.dispatch(e,this.count),this.count<0&&rt.warn("Counter.count below zero",this.count)}increment(){this.change(1)}decrement(){this.change(-1)}listen(e){this.change(e.count),e.signals.countChanged.add(this.change,this)}unlisten(e){e=e.signals.countChanged;e.has(this.change,this)&&e.remove(this.change,this)}onZeroOnce(t,r){if(0===this.count)t.call(r);else{let e=()=>{0===this.count&&(this.signals.countChanged.remove(e,this),t.call(r))};this.signals.countChanged.add(e,this)}}dispose(){this.clear(),this.signals.countChanged.dispose()}}s.add("shader/BasicLine.vert","void main(){\r\n\r\n#include begin_vertex\r\n#include project_vertex\r\n\r\n}"),s.add("shader/BasicLine.frag","uniform vec3 uColor;\n#include common\n#include fog_pars_fragment\nvoid main(){\ngl_FragColor = vec4( uColor, 1.0 );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n}"),s.add("shader/Quad.vert","varying vec2 vUv;\r\n\r\nvoid main() {\r\n\r\nvUv = uv;\r\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n\r\n}"),s.add("shader/Quad.frag","varying vec2 vUv;\r\n\r\nuniform sampler2D tForeground;\r\nuniform float scale;\r\n\r\nvoid main() {\r\n\r\nvec4 foreground = texture2D( tForeground, vUv );\r\ngl_FragColor = foreground * scale;\r\n\r\n}");class Nc{constructor(){this.signals={updated:new n.Signal},this.maxDuration=-1/0,this.minDuration=1/0,this.avgDuration=14,this.lastDuration=1/0,this.prevFpsTime=0,this.lastFps=1/0,this.lastFrames=1,this.frames=0,this.count=0,this.begin()}update(){this.startTime=this.end(),this.currentTime=this.startTime,this.signals.updated.dispatch()}begin(){this.startTime=window.performance.now(),this.lastFrames=this.frames}end(){var e=window.performance.now();return this.count+=1,this.frames+=1,this.lastDuration=e-this.startTime,this.minDuration=Math.min(this.minDuration,this.lastDuration),this.maxDuration=Math.max(this.maxDuration,this.lastDuration),this.avgDuration-=this.avgDuration/30,this.avgDuration+=this.lastDuration/30,e>this.prevFpsTime+1e3&&(this.lastFps=this.frames,this.prevFpsTime=e,this.frames=0),e}}s.add("shader/chunk/fog_fragment.glsl","#ifdef USE_FOG\r\n\r\n// #if defined( USE_LOGDEPTHBUF_EXT ) || defined( IMPOSTOR )\r\n//\r\n// float depth = gl_FragDepthEXT / gl_FragCoord.w;\r\n//\r\n// #else\r\n//\r\n// float depth = gl_FragCoord.z / gl_FragCoord.w;\r\n//\r\n// #endif\r\n\r\nfloat depth = length( vViewPosition );\r\n\r\n#ifdef FOG_EXP2\r\n\r\nfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\r\n\r\n#else\r\n\r\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\r\n\r\n#endif\r\n\r\ngl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\r\n\r\n#endif"),s.add("shader/chunk/interior_fragment.glsl","if( gl_FrontFacing == false ){\r\n#ifdef USE_INTERIOR_COLOR\r\noutgoingLight.xyz = interiorColor;\r\n#else\r\n#ifdef DIFFUSE_INTERIOR\r\noutgoingLight.xyz = vColor;\r\n#endif\r\n#endif\r\noutgoingLight.xyz *= 1.0 - interiorDarkening;\r\n}"),s.add("shader/chunk/matrix_scale.glsl","float matrixScale( in mat4 m ){\r\nvec4 r = m[ 0 ];\r\nreturn sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );\r\n}"),s.add("shader/chunk/nearclip_vertex.glsl","#ifdef NEAR_CLIP\r\nif( vViewPosition.z < clipNear - 5.0 )\r\n// move out of [ -w, +w ]\r\ngl_Position.z = 2.0 * gl_Position.w;\r\n#endif"),s.add("shader/chunk/nearclip_fragment.glsl","#ifdef NEAR_CLIP\r\nif( vViewPosition.z < clipNear )\r\ndiscard;\r\n#endif"),s.add("shader/chunk/opaque_back_fragment.glsl","#ifdef OPAQUE_BACK\r\n#ifdef FLIP_SIDED\r\nif( gl_FrontFacing == true ){\r\ngl_FragColor.a = 1.0;\r\n}\r\n#else\r\nif( gl_FrontFacing == false ){\r\ngl_FragColor.a = 1.0;\r\n}\r\n#endif\r\n#endif"),s.add("shader/chunk/radiusclip_vertex.glsl","#ifdef RADIUS_CLIP\r\nif( distance( vViewPosition, vClipCenter ) > clipRadius + 5.0 )\r\n// move out of [ -w, +w ]\r\ngl_Position.z = 2.0 * gl_Position.w;\r\n#endif"),s.add("shader/chunk/radiusclip_fragment.glsl","#ifdef RADIUS_CLIP\r\nif( distance( vViewPosition, vClipCenter ) > clipRadius )\r\ndiscard;\r\n#endif"),s.add("shader/chunk/unpack_color.glsl","vec3 unpackColor(float f) {\r\nvec3 color;\r\ncolor.r = floor(f / 256.0 / 256.0);\r\ncolor.g = floor((f - color.r * 256.0 * 256.0) / 256.0);\r\ncolor.b = floor(f - color.r * 256.0 * 256.0 - color.g * 256.0);\r\nreturn color / 255.0;\r\n}");let Fc=/^(?!\/\/)\s*#include\s+(\S+)/gim,Bc={};function Uc(t,r={}){let i=t+"|";for(var e in r)i+=e+":"+r[e];if(!Bc[i]){var n=(e=>{if(void 0===e)return"";var t,r=[];for(t in e){var i=e[t];i&&r.push(`#define ${t} `+i)}return r.join("\n")+"\n"})(r);let e=s.get("shader/"+t);if(!e)throw new Error(`empty shader, '${t}'`);e=e.replace(Fc,function(e,t){var r=`shader/chunk/${t}.glsl`,r=s.get(r)||M[t];if(r)return r;throw new Error(`empty chunk, '${t}'`)}),Bc[i]=n+e}return Bc[i]}if("undefined"!=typeof WebGLRenderingContext){let r=WebGLRenderingContext.prototype,e=r.getShaderParameter,t=(r.getShaderParameter=function(){return!Je.Debug||e.apply(this,arguments)},r.getShaderInfoLog),i=(r.getShaderInfoLog=function(){return Je.Debug?t.apply(this,arguments):""},r.getProgramParameter),n=(r.getProgramParameter=function(e,t){return!Je.Debug&&t===r.LINK_STATUS||i.apply(this,arguments)},r.getProgramInfoLog);r.getProgramInfoLog=function(){return Je.Debug?n.apply(this,arguments):""}}let zc=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];zc.forEach(e=>{e.forEach(e=>{e[0]*=.0625,e[1]*=.0625})});class Vc{constructor(e,t,r,i){this.canvas=document.createElement("canvas"),this._viewer=r,this._factor=ce(i.factor,2),this._antialias=ce(i.antialias,!1),this._onProgress=i.onProgress,this._onFinish=i.onFinish,this._antialias&&(this._factor*=2),this._n=this._factor*this._factor,this._width=this._viewer.width,this._height=this._viewer.height,this._antialias?(this.canvas.width=this._width*this._factor/2,this.canvas.height=this._height*this._factor/2):(this.canvas.width=this._width*this._factor,this.canvas.height=this._height*this._factor),this._ctx=this.canvas.getContext("2d"),this._viewerSampleLevel=r.sampleLevel,this._viewer.setSampling(-1)}_renderTile(e){var t,r=this._viewer,i=this._width,n=this._height,a=this._factor,s=e%a*i,o=Math.floor(e/a)*n;r.camera.setViewOffset(i*a,n*a,s,o,i,n),r.render(),this._antialias?(a=Math.round((s+i)/2)-Math.round(s/2),t=Math.round((o+n)/2)-Math.round(o/2),this._ctx.drawImage(r.renderer.domElement,Math.round(s/2),Math.round(o/2),a,t)):this._ctx.drawImage(r.renderer.domElement,Math.floor(s),Math.floor(o),Math.ceil(i),Math.ceil(n)),"function"==typeof this._onProgress&&this._onProgress(e+1,this._n,!1)}_finalize(){this._viewer.setSampling(this._viewerSampleLevel),this._viewer.camera.view=null,"function"==typeof this._onFinish&&this._onFinish(this._n+1,this._n,!1)}render(){for(let e=0;e<=this._n;++e)e===this._n?this._finalize():this._renderTile(e)}renderAsync(){let e=0,t=this._n;var r=()=>{e===t?this._finalize():this._renderTile(e),e+=1};for(let e=0;e<=t;++e)setTimeout(r,0)}}let Gc=2*Math.PI,Hc=180/Math.PI;function $c(t,r,i=1,n=0,a){var s=a?a.length:t.length/i;let o=0,l=0;if(a)for(let e=0;e<s;++e){var h=(t[a[e]*i+n]+r)%r/r*Gc-Math.PI;o+=Math.cos(h),l+=Math.sin(h)}else for(let e=n;e<s;e+=i){var c=(t[e]+r)%r/r*Gc-Math.PI;o+=Math.cos(c),l+=Math.sin(c)}return o/=s,l/=s,(Math.atan2(l,o)+Math.PI)/Gc*r}function jc(t,r,e,i=0){var n=t.length,a=e||new Float32Array(n);for(let e=0;e<n;e+=3)a[i+e+0]=(t[e+0]+r[e+0])/2,a[i+e+1]=(t[e+1]+r[e+1])/2,a[i+e+2]=(t[e+2]+r[e+2])/2;return a}function Wc(t,r){var i=t.length,n=new Float32Array(i);for(let e=0;e<i;e+=3)n[e+0]=r[e+0]-t[e+0],n[e+1]=r[e+1]-t[e+1],n[e+2]=r[e+2]-t[e+2];return n}function qc(t,r,e){var i=e||new Float32Array(t);for(let e=0;e<t;++e)i[e]=r;return i}function _(t,r,i,n,e){var a=e||new Float32Array(3*t);for(let e=0;e<t;++e){var s=3*e;a[0+s]=r,a[1+s]=i,a[2+s]=n}return a}function Xc(t){var r=new Float32Array(t);for(let e=0;e<t;++e)r[e]=e;return r}function Yc(e,r,i=0,t){var n=t||new Float32Array(e*r);for(let t=0;t<e;++t){var a=i+t*r;for(let e=0;e<r;++e)n[a+e]=t}return n}function Kc(t,r){var i=t.length,n=new Float32Array(i*r);for(let e=0;e<i;++e){var a=e*r,s=t[e];for(let e=0;e<r;++e)n[a+e]=s}return n}function Zc(t,r,i,n,a){for(let e=0;e<a;++e)r[n+e]=t[i+e]}function Qc(e,t,r,i){Zc(e,e,t,r,i)}function Jc(r){let i=-1/0;for(let e=0,t=r.length;e<t;++e)r[e]>i&&(i=r[e]);return i}function eu(r){let i=1/0;for(let e=0,t=r.length;e<t;++e)r[e]<i&&(i=r[e]);return i}function tu(t,r=1,i=0){var n=t.length;let a=0;for(let e=i;e<n;e+=r)a+=t[e];return a}function ru(e,t=1,r=0){return tu(e,t,r)/(e.length/t)}let iu={trim:!1,factor:1,antialias:!1,transparent:!1,onProgress:void 0};function nu(s,i={}){let{trim:e,factor:r,antialias:o,transparent:t}=Vl(i,iu),l=s.renderer,h=s.camera,c=l.getClearAlpha(),_=l.getClearColor(new ze);function u(e=!1){let t=r;o&&(t*=2),e&&(t=1/t),s.scene.traverse(function(e){e=e.material;e&&e.linewidth&&(e.linewidth*=t),e&&e.uniforms&&e.uniforms.size&&void 0===e.uniforms.size.__seen&&(e.uniforms.size.value*=t,e.uniforms.size.__seen=!0),e&&e.uniforms&&e.uniforms.linewidth&&void 0===e.uniforms.linewidth.__seen&&(e.uniforms.linewidth.value*=t,e.uniforms.linewidth.__seen=!0)}),s.scene.traverse(function(e){e=e.material;e&&e.uniforms&&e.uniforms.size&&delete e.uniforms.size.__seen,e&&e.uniforms&&e.uniforms.linewidth&&delete e.uniforms.linewidth.__seen})}function d(n){if(e){var a=_,s=t?0:255*a.r,o=t?0:255*a.g,a=t?0:255*a.b,l=t?0:255;{var h=n,c=s,u=o,d=a,m=l,p=h.height,f=h.width,g=h.getContext("2d").getImageData(0,0,f,p).data;let e,t,r,i;for(r=!1,t=0;t<p;t++){for(e=0;e<f;e++)if(g[i=4*(t*f+e)]!==c||g[i+1]!==u||g[i+2]!==d||g[i+3]!==m){r=!0;break}if(r)break}s=t;for(r=!1,e=0;e<f;e++){for(t=0;t<p;t++)if(g[i=4*(t*f+e)]!==c||g[i+1]!==u||g[i+2]!==d||g[i+3]!==m){r=!0;break}if(r)break}o=e;for(r=!1,t=p-1;0<=t;t--){for(e=f-1;0<=e;e--)if(g[i=4*(t*f+e)]!==c||g[i+1]!==u||g[i+2]!==d||g[i+3]!==m){r=!0;break}if(r)break}a=t;for(r=!1,e=f-1;0<=e;e--){for(t=p-1;0<=t;t--)if(g[i=4*(t*f+e)]!==c||g[i+1]!==u||g[i+2]!==d||g[i+3]!==m){r=!0;break}if(r)break}var l=e,v=document.createElement("canvas");return v.width=l-o,v.height=a-s,v.getContext("2d").drawImage(h,o,s,v.width,v.height,0,0,v.width,v.height),v}}return n}function m(e,t,r){"function"==typeof i.onProgress&&i.onProgress(e,t,r)}return new Promise(function(i,n){let a=new Vc(l,h,s,{factor:r,antialias:o,onProgress:m,onFinish:function(e,t){var r=d(a.canvas);r.toBlob(function(e){l.setClearAlpha(c),u(!0),s.requestRender(),m(t,t,!0),e?i(e):n("error creating image")},"image/png")}});l.setClearAlpha(t?0:1),u(),a.renderAsync()})}let au=new et,su=new tt,ou=new tt;function lu(e,b){e.traverseVisible(function(l){if(l instanceof _l&&l.userData.buffer.parameters.sortParticles){var i,n,a,t,h=l.geometry.attributes,c=h.position.count;if(0!==c){su.multiplyMatrices(b.matrixWorldInverse,l.matrixWorld),ou.multiplyMatrices(b.projectionMatrix,su);let e,s,r,o;l.userData.sortData?(e=l.userData.sortData,r=e.__zArray,s=e.__sortArray,o=e.__cmpFn):(r=new Float32Array(c),s=new Uint32Array(c),o=function(e,t){e=r[e],t=r[t];return t<e?1:e<t?-1:0},e={__zArray:r,__sortArray:s,__cmpFn:o},l.userData.sortData=e);for(let e=0;e<c;++e)au.fromArray(h.position.array,3*e),au.applyMatrix4(ou),r[e]=-au.z,s[e]=e;{var[u,d,l=0,m]=[s,o];d=d||function(e,t){return t<e?1:e<t?-1:0};var p=[];let e=-1,t=l,r=m=(m||u.length)-1,i;function f(e,t){var r=u[e];u[e]=u[t],u[t]=r}let n,a;for(;;)if(r-t<=25){for(let e=t+1;e<=r;++e){for(i=u[e],n=e-1;n>=t&&0<d(u[n],i);)u[n+1]=u[n],--n;u[n+1]=i}if(-1===e)break;r=p[e--],t=p[e--]}else{var g=t+r>>1;for(n=t+1,a=r,f(g,n),0<d(u[t],u[r])&&f(t,r),0<d(u[n],u[r])&&f(n,r),0<d(u[t],u[n])&&f(t,n),i=u[n];;){for(;n++,d(u[n],i)<0;);for(;a--,0<d(u[a],i););if(a<n)break;f(n,a)}u[t+1]=u[a],u[a]=i,r-n+1>=a-t?(p[++e]=n,p[++e]=r,r=a-1):(p[++e]=t,p[++e]=a-1,t=n)}}for(t in h){var v=h[t],_=v.array,y=v.itemSize;e[t]||(e[t]=new Float32Array(y*c)),a=e[t],e[t]=_;for(let t=0;t<c;++t){i=s[t];for(let e=0;e<y;++e)n=i*y+e,a[t*y+e]=_[n]}h[t].array=a,h[t].needsUpdate=!0}}}})}let hu=new Ue,cu=new tt,uu=new tt;function du(e,t){cu.copy(t.projectionMatrix).invert(),uu.copy(t.projectionMatrix).transpose(),e.traverse(function(e){var e=e.material;e&&(e=e.uniforms)&&(e.projectionMatrixInverse&&e.projectionMatrixInverse.value.copy(cu),e.projectionMatrixTranspose)&&e.projectionMatrixTranspose.value.copy(uu)})}function mu(e,t,r){var i=e.createShader(r);if(i)return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(console.log(`error compiling shader ${i}: `+e.getShaderInfoLog(i)),e.deleteShader(i),null);console.log("error creating WebGL shader "+r)}function pu(e,t){e=e.getExtension(t);e||console.log(`extension '${t}' not available`)}let fu=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function gu(e){var t=document.createElement("canvas"),t=(t.width=16,t.height=16,t.style.width="16px",t.style.height="16px",t.getContext("webgl")||t.getContext("experimental-webgl"));if(!t)return console.log("error creating webgl context for "+e),!1;if(!(t instanceof WebGLRenderingContext))return console.log("Got unexpected type for WebGL rendering context"),!1;pu(t,"OES_texture_float"),pu(t,"OES_texture_half_float"),pu(t,"WEBGL_color_buffer_float");var r=mu(t,`
attribute vec4 a_position;

void main() {
  gl_Position = a_position;
}`,t.VERTEX_SHADER),i=mu(t,`
precision mediump float;
uniform vec4 u_color;
uniform sampler2D u_texture;

void main() {
  gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;
}`,t.FRAGMENT_SHADER);if(!r||!i)return!1;r=((r,e,t,i)=>{let n=r.createProgram();if(n)return e.forEach(e=>r.attachShader(n,e)),t&&t.forEach((e,t)=>{r.bindAttribLocation(n,i?i[t]:t,e)}),r.linkProgram(n),r.getProgramParameter(n,r.LINK_STATUS)?n:(console.log("error linking program: "+r.getProgramInfoLog(n)),r.deleteProgram(n),null);console.log("error creating WebGL program")})(t,[r,i]);if(!r)return console.log("error creating WebGL program"),!1;t.useProgram(r);i=t.getAttribLocation(r,"a_position"),r=t.getUniformLocation(r,"u_color");if(!r)return console.log("error getting 'u_color' uniform location"),!1;var n=t.createBuffer(),n=(t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,fu,t.STATIC_DRAW),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.createTexture()),i=new Uint8Array([255,255,255,255]),i=(t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,i),t.createTexture()),a=(t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,e,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.createFramebuffer()),s=(t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.checkFramebufferStatus(t.FRAMEBUFFER));if(s!==t.FRAMEBUFFER_COMPLETE)return console.log("error creating framebuffer for "+e),!1;t.bindTexture(t.TEXTURE_2D,n),t.uniform4fv(r,[0,10,20,1]),t.drawArrays(t.TRIANGLES,0,6),t.bindTexture(t.TEXTURE_2D,i),t.bindFramebuffer(t.FRAMEBUFFER,null),t.clearColor(1,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.uniform4fv(r,[0,.1,.05,1]),t.drawArrays(t.TRIANGLES,0,6);s=new Uint8Array(4);if(t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,s),0!==s[0]||s[1]<248||s[2]<248||s[3]<254)return console.log(`not able to actually render to ${e} texture`),!1;if(e===t.FLOAT){t.bindFramebuffer(t.FRAMEBUFFER,a);n=new Float32Array(4),i=(t.readPixels(0,0,1,1,t.RGBA,t.FLOAT,n),t.getError());if(i)return console.log(`error reading pixels as float: '${((e,t)=>{switch(t){case e.NO_ERROR:return"no error";case e.INVALID_ENUM:return"invalid enum";case e.INVALID_VALUE:return"invalid value";case e.INVALID_OPERATION:return"invalid operation";case e.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case e.OUT_OF_MEMORY:return"out of memory";case e.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"})(t,i)}'`),!1}return!0}let vu=new Float32Array(100),_u=new Uint8Array(100),yu=[12,7,13,17,11,6,8,18,16,2,14,22,10,1,3,9,19,23,21,15,5,0,4,24,20],bu=new tt;function xu(e,t,i,r,n){let a=n.uniforms;var s=[];if(a&&(a.objectId&&(a.objectId.value=ac?this.id:this.id/255,s.push("objectId")),(a.modelViewMatrixInverse||a.modelViewMatrixInverseTranspose||a.modelViewProjectionMatrix||a.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,this.matrixWorld),a.modelViewMatrixInverse&&(a.modelViewMatrixInverse.value.copy(this.modelViewMatrix).invert(),s.push("modelViewMatrixInverse")),a.modelViewMatrixInverseTranspose&&((a.modelViewMatrixInverse?a.modelViewMatrixInverseTranspose.value.copy(a.modelViewMatrixInverse.value):a.modelViewMatrixInverseTranspose.value.copy(this.modelViewMatrix).invert()).transpose(),s.push("modelViewMatrixInverseTranspose")),a.modelViewProjectionMatrix&&(a.modelViewProjectionMatrix.value.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),s.push("modelViewProjectionMatrix")),a.modelViewProjectionMatrixInverse&&(a.modelViewProjectionMatrix?bu.copy(a.modelViewProjectionMatrix.value):bu.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),a.modelViewProjectionMatrixInverse.value.copy(bu.invert()),s.push("modelViewProjectionMatrixInverse")),s.length)){i=e.properties.get(n);if(i.program){let t=e.getContext();n=i.program;t.useProgram(n.program);let r=n.getUniforms();s.forEach(function(e){r.setValue(t,e,a[e].value)})}}}class Su{constructor(e){var t;this.boundingBox=new ai,this.boundingBoxSize=new et,this.boundingBoxLength=0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}},this.distVector=new et,this.signals={ticked:new n.Signal,rendered:new n.Signal},"string"==typeof e?(t=document.getElementById(e),this.container=null===t?document.createElement("div"):t):e instanceof HTMLElement?this.container=e:this.container=document.createElement("div"),this.container===document.body?(this.width=window.innerWidth||1,this.height=window.innerHeight||1):(t=this.container.getBoundingClientRect(),this.width=t.width||1,this.height=t.height||1,this.container.style.overflow="hidden"),this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.container.appendChild(this.wrapper),this._initParams(),this._initStats(),this._initCamera(),this._initScene(),!1===this._initRenderer()?rt.error("Viewer: could not initialize renderer"):(this._initHelper(),this.setBackground(),this.setFog(),this.animate=this.animate.bind(this))}_initParams(){this.parameters={fogColor:new ze(0),fogNear:50,fogFar:100,backgroundColor:new ze(0),cameraType:"perspective",cameraFov:40,cameraEyeSep:.3,cameraZ:-80,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",lightColor:new ze(14540253),lightIntensity:1.2,ambientColor:new ze(14540253),ambientIntensity:.3,sampleLevel:0,outputColorSpace:"srgb-linear"}}_initCamera(){var e=new et(0,0,0),{width:t,height:r}=this,t=(this.perspectiveCamera=new ca(this.parameters.cameraFov,t/r),this.perspectiveCamera.position.z=this.parameters.cameraZ,this.perspectiveCamera.lookAt(e),this.orthographicCamera=new Da(t/-2,t/2,r/2,r/-2),this.orthographicCamera.position.z=this.parameters.cameraZ,this.orthographicCamera.lookAt(e),this.stereoCamera=new Bl,this.stereoCamera.aspect=.5,this.stereoCamera.eyeSep=this.parameters.cameraEyeSep,this.parameters.cameraType);if("orthographic"===t)this.camera=this.orthographicCamera;else{if("perspective"!==t&&"stereo"!==t)throw new Error(`Unknown cameraType '${t}'`);this.camera=this.perspectiveCamera}this.camera.updateProjectionMatrix()}_initStats(){this.stats=new Nc}_initScene(){this.scene||(this.scene=new tl,this.scene.name="scene"),this.rotationGroup=new Wo,this.rotationGroup.name="rotationGroup",this.scene.add(this.rotationGroup),this.translationGroup=new Wo,this.translationGroup.name="translationGroup",this.rotationGroup.add(this.translationGroup),this.modelGroup=new Wo,this.modelGroup.name="modelGroup",this.translationGroup.add(this.modelGroup),this.pickingGroup=new Wo,this.pickingGroup.name="pickingGroup",this.translationGroup.add(this.pickingGroup),this.backgroundGroup=new Wo,this.backgroundGroup.name="backgroundGroup",this.translationGroup.add(this.backgroundGroup),this.helperGroup=new Wo,this.helperGroup.name="helperGroup",this.translationGroup.add(this.helperGroup),this.scene.fog=new el(this.parameters.fogColor.getHex()),this.directionalLight=new Ll(this.parameters.lightColor.getHex(),this.parameters.lightIntensity),this.scene.add(this.directionalLight),this.ambientLight=new Ol(this.parameters.ambientColor.getHex(),this.parameters.ambientIntensity),this.scene.add(this.ambientLight)}_initRenderer(){var e=window.devicePixelRatio,{width:t,height:r}=this;try{this.renderer=new Jo({preserveDrawingBuffer:!0,alpha:!0,antialias:!0})}catch(e){return!(this.wrapper.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;"><p style="padding:15px;text-align:center;">Your browser/graphics card does not seem to support <a target="_blank" href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>.<br/><br/>Find out how to get it <a target="_blank" href="http://get.webgl.org/">here</a>.</p></div>')}this.renderer.setPixelRatio(e),this.renderer.setSize(t,r),this.renderer.autoClear=!1,this.renderer.sortObjects=!0,this.renderer.outputColorSpace=this.parameters.outputColorSpace,this.renderer.useLegacyLights=!0;var i=this.renderer.getContext(),t=(this.renderer.capabilities.isWebGL2?(lc(!0),sc(this.renderer.extensions.get("EXT_color_buffer_float")),this.supportsHalfFloat=!0):(lc(this.renderer.extensions.get("EXT_frag_depth")),this.renderer.extensions.get("OES_element_index_uint"),sc(this.renderer.extensions.get("OES_texture_float")&&this.renderer.extensions.get("WEBGL_color_buffer_float")||this.renderer.extensions.get("OES_texture_float")&&gu(i.FLOAT)),this.renderer.extensions.get("OES_texture_float"),this.supportsHalfFloat=this.renderer.extensions.get("OES_texture_half_float")&&gu(36193)),this.wrapper.appendChild(this.renderer.domElement),t*e),r=r*e;Je.Debug&&console.log(JSON.stringify({Browser:tc,OES_texture_float:!!this.renderer.extensions.get("OES_texture_float"),OES_texture_half_float:!!this.renderer.extensions.get("OES_texture_half_float"),WEBGL_color_buffer_float:!!this.renderer.extensions.get("WEBGL_color_buffer_float"),"testTextureSupport Float":gu(i.FLOAT),"testTextureSupport HalfFloat":gu(36193),"this.supportsHalfFloat":this.supportsHalfFloat,SupportsReadPixelsFloat:ac},null,2)),this.pickingTarget=new Jr(t,r,{minFilter:q,magFilter:q,stencilBuffer:!1,format:ot,type:ac?Qe:Xe}),this.pickingTarget.texture.generateMipmaps=!1,this.pickingTarget.texture.colorSpace=this.parameters.outputColorSpace,this.renderer.setRenderTarget(this.pickingTarget),this.renderer.clear(),this.renderer.setRenderTarget(null),this.sampleTarget=new Jr(t,r,{minFilter:je,magFilter:je,format:ot,type:this.supportsHalfFloat?it:ac?Qe:Xe}),this.sampleTarget.texture.colorSpace=this.parameters.outputColorSpace,this.holdTarget=new Jr(t,r,{minFilter:q,magFilter:q,format:ot,type:this.supportsHalfFloat?it:ac?Qe:Xe}),this.holdTarget.texture.colorSpace=this.parameters.outputColorSpace,this.compositeUniforms={tForeground:new Ul(this.sampleTarget.texture),scale:new Ul(1)},this.compositeMaterial=new la({uniforms:this.compositeUniforms,vertexShader:Uc("Quad.vert"),fragmentShader:Uc("Quad.frag"),premultipliedAlpha:!0,transparent:!0,blending:te,depthTest:!1,depthWrite:!1}),this.compositeCamera=new Da(-1,1,1,-1,0,1),this.compositeScene=new tl,this.compositeScene.name="compositeScene",this.compositeScene.add(new ta(new wa(2,2),this.compositeMaterial))}_initHelper(){var e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),t=new Float32Array(24),r=new Fn,e=(r.setIndex(new Cn(e,1)),r.setAttribute("position",new Cn(t,3)),new la({uniforms:{uColor:{value:new ze("skyblue")}},vertexShader:Uc("BasicLine.vert"),fragmentShader:Uc("BasicLine.frag")}));this.boundingBoxMesh=new dl(r,e),this.helperGroup.add(this.boundingBoxMesh)}updateHelper(){var e=this.boundingBoxMesh.geometry.attributes.position,t=e.array,{min:r,max:i}=this.boundingBox;t[0]=i.x,t[1]=i.y,t[2]=i.z,t[3]=r.x,t[4]=i.y,t[5]=i.z,t[6]=r.x,t[7]=r.y,t[8]=i.z,t[9]=i.x,t[10]=r.y,t[11]=i.z,t[12]=i.x,t[13]=i.y,t[14]=r.z,t[15]=r.x,t[16]=i.y,t[17]=r.z,t[18]=r.x,t[19]=r.y,t[20]=r.z,t[21]=i.x,t[22]=r.y,t[23]=r.z,e.needsUpdate=!0,this.boundingBox.isEmpty()||this.boundingBoxMesh.geometry.computeBoundingSphere()}get cameraDistance(){return Math.abs(this.camera.position.z)}set cameraDistance(e){this.camera.position.z=-e}add(t,e){e?e.forEach(e=>this.addBuffer(t,e)):this.addBuffer(t),t.group.name="meshGroup",t.wireframeGroup.name="wireframeGroup",(t.parameters.background?(this.backgroundGroup.add(t.group),this.backgroundGroup):(this.modelGroup.add(t.group),this.modelGroup)).add(t.wireframeGroup),t.pickable&&this.pickingGroup.add(t.pickingGroup),Je.Debug&&this.updateHelper()}addBuffer(t,r){function i(e){e instanceof Wo?e.children.forEach(i):(e.userData.buffer=t,e.userData.instance=r,e.onBeforeRender=xu)}var e=t.getMesh(),n=(r&&e.applyMatrix4(r.matrix),i(e),t.group.add(e),t.getWireframeMesh());r&&(n.matrix.copy(e.matrix),n.position.copy(e.position),n.quaternion.copy(e.quaternion),n.scale.copy(e.scale)),i(n),t.wireframeGroup.add(n),t.pickable&&(n=t.getPickingMesh(),r&&(n.matrix.copy(e.matrix),n.position.copy(e.position),n.quaternion.copy(e.quaternion),n.scale.copy(e.scale)),i(n),t.pickingGroup.add(n)),r?this._updateBoundingBox(t.geometry,t.matrix,r.matrix):this._updateBoundingBox(t.geometry,t.matrix)}remove(t){this.translationGroup.children.forEach(function(e){e.remove(t.group),e.remove(t.wireframeGroup)}),t.pickable&&this.pickingGroup.remove(t.pickingGroup),this.updateBoundingBox(),Je.Debug&&this.updateHelper()}_updateBoundingBox(e,t,r){let i=this.boundingBox;function n(e,t,r){null==e.boundingBox&&e.computeBoundingBox();e=e.boundingBox.clone();t&&e.applyMatrix4(t),r&&e.applyMatrix4(r),e.min.equals(e.max)&&e.expandByScalar(5),i.union(e)}function a(r){if(void 0!==r.geometry){let e,t;r.userData.buffer&&(e=r.userData.buffer.matrix),r.userData.instance&&(t=r.userData.instance.matrix),n(r.geometry,e,t)}}e?n(e,t,r):(i.makeEmpty(),this.modelGroup.traverse(a),this.backgroundGroup.traverse(a)),i.getSize(this.boundingBoxSize),this.boundingBoxLength=this.boundingBoxSize.length()}updateBoundingBox(){this._updateBoundingBox(),Je.Debug&&this.updateHelper()}getPickingPixels(){var{width:e,height:t}=this,r=e*t*4,r=new(ac?Float32Array:Uint8Array)(r);return this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,0,0,e,t,r),r}getImage(t){return new Promise(e=>{if(t){var{width:r,height:i}=this,n=r*i*4;let t=this.getPickingPixels();if(ac){var a=new Uint8Array(n);for(let e=0;e<n;++e)a[e]=Math.round(255*t[e]);t=a}var s=document.createElement("canvas"),o=(s.width=r,s.height=i,s.getContext("2d")),r=o.getImageData(0,0,r,i);r.data.set(t),o.putImageData(r,0,0),s.toBlob(e,"image/png")}else this.renderer.domElement.toBlob(e,"image/png")})}makeImage(e={}){return nu(this,e)}setLight(e,t,r,i){var n=this.parameters;void 0!==e&&n.lightColor.set(e),void 0!==t&&(n.lightIntensity=t),void 0!==r&&n.ambientColor.set(r),void 0!==i&&(n.ambientIntensity=i),this.requestRender()}setFog(e,t,r){var i=this.parameters;void 0!==e&&i.fogColor.set(e),void 0!==t&&(i.fogNear=t),void 0!==r&&(i.fogFar=r),this.requestRender()}setBackground(e){var t=this.parameters;e&&t.backgroundColor.set(e),this.setFog(t.backgroundColor),this.renderer.setClearColor(t.backgroundColor,0),this.renderer.domElement.style.backgroundColor=t.backgroundColor.getStyle(),this.requestRender()}setSampling(e){void 0!==e&&(this.parameters.sampleLevel=e,this.sampleLevel=e),this.requestRender()}setOutputEncoding(e){this.parameters.outputColorSpace=e,this.renderer.outputColorSpace=e,this.pickingTarget.texture.colorSpace=e,this.sampleTarget.texture.colorSpace=e,this.holdTarget.texture.colorSpace=e}setColorWorkflow(e){if("srgb-linear"!=e&&"srgb"!=e)throw new Error("setColorWorkflow: invalid color workflow "+e);vh="srgb-linear"==e?"linear":"sRGB",this.setOutputEncoding("srgb-linear"==e?"srgb":"srgb-linear"),this.requestRender()}setCamera(e,t,r){var i=this.parameters;if(e&&(i.cameraType=e),t&&(i.cameraFov=t),r&&(i.cameraEyeSep=r),"orthographic"===i.cameraType)this.camera!==this.orthographicCamera&&(this.camera=this.orthographicCamera,this.camera.position.copy(this.perspectiveCamera.position),this.camera.up.copy(this.perspectiveCamera.up),this.updateZoom());else{if("perspective"!==i.cameraType&&"stereo"!==i.cameraType)throw new Error(`Unknown cameraType '${i.cameraType}'`);this.camera!==this.perspectiveCamera&&(this.camera=this.perspectiveCamera,this.camera.position.copy(this.orthographicCamera.position),this.camera.up.copy(this.orthographicCamera.up))}this.perspectiveCamera.fov=i.cameraFov,this.stereoCamera.eyeSep=i.cameraEyeSep,this.camera.updateProjectionMatrix(),this.requestRender()}setClip(e,t,r,i,n){var a=this.parameters;void 0!==e&&(a.clipNear=e),void 0!==t&&(a.clipFar=t),void 0!==r&&(a.clipDist=r),void 0!==i&&(a.clipMode=i),void 0!==n&&(a.clipScale=n),this.requestRender()}setSize(e,t){this.width=e||1,this.height=t||1,this.perspectiveCamera.aspect=this.width/this.height,this.orthographicCamera.left=-this.width/2,this.orthographicCamera.right=this.width/2,this.orthographicCamera.top=this.height/2,this.orthographicCamera.bottom=-this.height/2,this.camera.updateProjectionMatrix();var r=window.devicePixelRatio,e=(this.renderer.setPixelRatio(r),this.renderer.setSize(e,t),this.width*r),t=this.height*r;this.pickingTarget.setSize(e,t),this.sampleTarget.setSize(e,t),this.holdTarget.setSize(e,t),this.requestRender()}handleResize(){var e;this.container===document.body?this.setSize(window.innerWidth,window.innerHeight):(e=this.container.getBoundingClientRect(),this.setSize(e.width,e.height))}updateInfo(e){var t,{memory:r,render:i}=this.info;e?(r.programs=0,r.geometries=0,r.textures=0,i.calls=0,i.vertices=0,i.points=0):(t=(e=this.renderer.info).memory,e=e.render,r.geometries=t.geometries,r.textures=t.textures,i.calls+=e.calls,i.faces+=e.triangles,i.points+=e.points)}animate(){var e;this.signals.ticked.dispatch(this.stats),500<window.performance.now()-this.stats.startTime&&!this.isStill&&this.sampleLevel<3&&-1!==this.sampleLevel&&(e=this.sampleLevel,this.sampleLevel=3,this.renderPending=!0,this.render(),this.isStill=!0,this.sampleLevel=e,Je.Debug)&&rt.log("rendered still frame"),this.frameRequest=window.requestAnimationFrame(this.animate)}pick(e,t){if("stereo"===this.parameters.cameraType)return{pid:0,instance:void 0,picker:void 0};e*=window.devicePixelRatio,t*=window.devicePixelRatio,e=Math.max(e-2,0),t=Math.max(t-2,0);let r=0,i,n;var a=ac?vu:_u;this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,e,t,5,5,a);for(let e=0;e<yu.length;e++){var s=4*yu[e],o=Math.round(a[3+s]),o=this.pickingGroup.getObjectById(o);o&&(i=o.userData.instance,n=o.userData.buffer.picking,r=ac?Math.round(255*a[s])<<16&16711680|Math.round(255*a[1+s])<<8&65280|255&Math.round(255*a[2+s]):a[s]<<16|a[1+s]<<8|a[2+s])}return{pid:r,instance:i,picker:n}}requestRender(){this.renderPending||(22<window.performance.now()-this.stats.startTime&&(this.stats.begin(),this.isStill=!1),this.renderPending=!0,window.requestAnimationFrame(()=>{this.render(),this.stats.update()}))}updateZoom(){var e=sh(this.perspectiveCamera.fov),e=2*Math.tan(e/2)*this.cameraDistance;this.orthographicCamera.zoom=this.height/e}absoluteToRelative(e){return 50*(1-e/this.bRadius)}relativeToAbsolute(e){return this.bRadius*(1-e/50)}__updateClipping(){var e,t,r=this.parameters,i=(this.bRadius=Math.max(10,.5*this.boundingBoxLength),isFinite(this.bRadius)||(this.bRadius=50),this.camera.getWorldPosition(this.distVector),this.cDist=this.distVector.length(),this.cDist||(this.cameraDistance=Math.abs(r.cameraZ),this.cDist=Math.abs(r.cameraZ)),this.scene.fog);i.color.set(r.fogColor),"camera"===r.clipMode?(this.camera.near=r.clipNear,this.camera.far=r.clipFar,i.near=r.fogNear,i.far=r.fogFar):"absolute"===r.clipScale?(this.camera.near=this.cDist-r.clipNear,this.camera.far=this.cDist+r.clipFar,i.near=this.cDist-r.fogNear,i.far=this.cDist+r.fogFar):(e=(50-r.clipNear)/50,t=-(50-r.clipFar)/50,this.camera.near=this.cDist-this.bRadius*e,this.camera.far=this.cDist+this.bRadius*t,e=(50-r.fogNear)/50,t=-(50-r.fogFar)/50,i.near=this.cDist-this.bRadius*e,i.far=this.cDist+this.bRadius*t),"camera"!==r.clipMode&&("PerspectiveCamera"===this.camera.type?(this.camera.near=Math.max(.1,r.clipDist,this.camera.near),this.camera.far=Math.max(1,this.camera.far),i.near=Math.max(.1,i.near),i.far=Math.max(1,i.far)):"OrthographicCamera"===this.camera.type&&0<r.clipDist&&(this.camera.near=Math.max(r.clipDist,this.camera.near)))}__updateCamera(){var e=this.camera;e.updateMatrix(),e.updateMatrixWorld(!0),e.updateProjectionMatrix();{var t=this.scene,a=e,s=this.renderer,o=this.cDist,l=this.bRadius,h=new Ue;s.getSize(h);let r=h.height,i=s.getPixelRatio(),n="OrthographicCamera"===a.type;hu.set(h.width,h.height),cu.copy(a.projectionMatrix).invert(),uu.copy(a.projectionMatrix).transpose(),t.traverse(function(e){var t,e=e.material;e&&(t=e.uniforms)&&(e.clipNear&&(e=(50-e.clipNear)/50,t.clipNear.value=o-l*e),t.canvasHeight&&(t.canvasHeight.value=r),t.resolution&&t.resolution.value.copy(hu),t.pixelRatio&&(t.pixelRatio.value=i),t.projectionMatrixInverse&&t.projectionMatrixInverse.value.copy(cu),t.projectionMatrixTranspose&&t.projectionMatrixTranspose.value.copy(uu),t.ortho)&&(t.ortho.value=n)})}lu(this.scene,e)}__setVisibility(e,t,r,i){this.modelGroup.visible=e,this.pickingGroup.visible=t,this.backgroundGroup.visible=r,this.helperGroup.visible=i}__updateLights(){this.directionalLight.color.set(this.parameters.lightColor),this.directionalLight.intensity=this.parameters.lightIntensity,this.distVector.copy(this.camera.position).setLength(100*this.boundingBoxLength),this.directionalLight.position.copy(this.camera.position).add(this.distVector),this.ambientLight.color.set(this.parameters.ambientColor),this.ambientLight.intensity=this.parameters.ambientIntensity}__renderPickingGroup(e){this.renderer.setRenderTarget(this.pickingTarget||null),this.renderer.clear(),this.__setVisibility(!1,!0,!1,!1),this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.updateInfo()}__renderModelGroup(e,t){this.renderer.setRenderTarget(t||null),this.renderer.clear(),this.__setVisibility(!1,!1,!0,!1),this.renderer.render(this.scene,e),this.renderer.clear(!1,!0,!0),this.updateInfo(),this.__setVisibility(!0,!1,!1,Je.Debug),this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.updateInfo()}__renderSuperSample(t,e){var r=zc[Math.max(0,Math.min(this.sampleLevel,5))],i=1/r.length;this.compositeUniforms.tForeground.value=this.sampleTarget.texture;let n=this.sampleTarget.width;var a=this.sampleTarget.height;"stereo"===this.parameters.cameraType&&(n/=2);for(let e=0;e<r.length;++e){var s=r[e],s=(t.setViewOffset(n,a,s[0],s[1],n,a),t.updateProjectionMatrix(),du(this.scene,t),i);s+=1/32*((e+.5)/r.length-.5),this.compositeUniforms.scale.value=s,this.__renderModelGroup(t,this.sampleTarget),this.renderer.setRenderTarget(this.holdTarget),0===e&&this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}this.compositeUniforms.scale.value=1,this.compositeUniforms.tForeground.value=this.holdTarget.texture,t.clearViewOffset(),this.renderer.setRenderTarget(e||null),this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}__renderStereo(e=!1,t){var r=this.stereoCamera,i=(r.update(this.perspectiveCamera),this.renderer),n=new Ue;i.getSize(n),i.setScissorTest(!0),i.setScissor(0,0,n.width/2,n.height),i.setViewport(0,0,n.width/2,n.height),du(this.scene,r.cameraL),this.__render(e,r.cameraL),i.setScissor(n.width/2,0,n.width/2,n.height),i.setViewport(n.width/2,0,n.width/2,n.height),du(this.scene,r.cameraR),this.__render(e,r.cameraR),i.setScissorTest(!1),i.setViewport(0,0,n.width,n.height)}__render(e=!1,t,r){e?this.lastRenderedPicking||this.__renderPickingGroup(t):0<this.sampleLevel&&"stereo"!==this.parameters.cameraType?this.__renderSuperSample(t,r):this.__renderModelGroup(t,r)}render(e=!1,t){if(this.rendering)rt.warn("'tried to call 'render' from within 'render'");else{this.rendering=!0;try{this.__updateClipping(),this.__updateCamera(),this.__updateLights(),this.updateInfo(!0),"stereo"===this.parameters.cameraType?this.__renderStereo(e,t):this.__render(e,this.camera,t),this.lastRenderedPicking=e}finally{this.rendering=!1,this.renderPending=!1}this.signals.rendered.dispatch()}}clear(){rt.log("scene cleared"),this.scene.remove(this.rotationGroup),this._initScene(),this.renderer.clear()}dispose(){this.renderer.dispose(),window.cancelAnimationFrame(this.frameRequest)}}function wu(e){var t=e.touches[0].pageX-e.touches[1].pageX,e=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(t*t+e*e)}class Au{constructor(e,t={}){this.domElement=e,this.signals={moved:new n.Signal,scrolled:new n.Signal,dragged:new n.Signal,dropped:new n.Signal,clicked:new n.Signal,hovered:new n.Signal,doubleClicked:new n.Signal},this.position=new Ue,this.prevPosition=new Ue,this.down=new Ue,this.canvasPosition=new Ue,this.prevClickCP=new Ue,this.moving=!1,this.hovering=!0,this.scrolled=!1,this.lastMoved=1/0,this.which=0,this.buttons=0,this.pressed=!1,this.altKey=!1,this.ctrlKey=!1,this.metaKey=!1,this.shiftKey=!1,this.domElement.style.touchAction="none",this.hoverTimeout=ce(t.hoverTimeout,50),this.handleScroll=ce(t.handleScroll,!0),this.doubleClickSpeed=ce(t.doubleClickSpeed,500),this._listen=this._listen.bind(this),this._onMousewheel=this._onMousewheel.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onContextmenu=this._onContextmenu.bind(this),this._onTouchstart=this._onTouchstart.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._listen();e={passive:!1};document.addEventListener("mousewheel",this._onMousewheel,e),document.addEventListener("wheel",this._onMousewheel,e),document.addEventListener("MozMousePixelScroll",this._onMousewheel,e),document.addEventListener("mousemove",this._onMousemove,e),document.addEventListener("mousedown",this._onMousedown,e),document.addEventListener("mouseup",this._onMouseup,e),document.addEventListener("contextmenu",this._onContextmenu,e),document.addEventListener("touchstart",this._onTouchstart,e),document.addEventListener("touchend",this._onTouchend,e),document.addEventListener("touchmove",this._onTouchmove,e)}get key(){let e=0;return this.altKey&&(e+=1),this.ctrlKey&&(e+=2),this.metaKey&&(e+=4),this.shiftKey&&(e+=8),e}setParameters(e={}){this.hoverTimeout=ce(e.hoverTimeout,this.hoverTimeout)}_listen(){var e=window.performance.now(),t=this.canvasPosition;this.doubleClickPending&&e-this.lastClicked>this.doubleClickSpeed&&(this.doubleClickPending=!1),e-this.lastMoved>this.hoverTimeout&&(this.moving=!1),(this.scrolled||!this.moving&&!this.hovering)&&(this.scrolled=!1,-1!==this.hoverTimeout)&&this.overElement&&(this.hovering=!0,this.signals.hovered.dispatch(t.x,t.y)),this.frameRequest=window.requestAnimationFrame(this._listen)}_onMousewheel(t){if(t.target===this.domElement&&this.handleScroll){t.preventDefault(),this._setKeys(t);let e=0;"deltaY"in t&&"deltaMode"in t&&void 0!==t.deltaY&&void 0!==t.deltaMode?e=t.deltaMode===WheelEvent.DOM_DELTA_PIXEL?.025*-t.deltaY:t.deltaMode===WheelEvent.DOM_DELTA_LINE?-t.deltaY*(2.5/3):2.5*-t.deltaY:"deltaY"in t&&!("detail"in t)?e=.025*-t.deltaY:void 0!==t.wheelDelta?e=.025*-t.wheelDelta:void 0!==t.wheelDeltaY?e=.025*-t.wheelDeltaY:void 0!==t.detail&&(e=-t.detail/3),this.signals.scrolled.dispatch(e),setTimeout(()=>{this.scrolled=!0},this.hoverTimeout)}}_onMousemove(e){e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,this._setKeys(e),this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.clientX,e.clientY),this._setCanvasPosition(e);var e=this.prevPosition.x-this.position.x,t=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(e,t),this.pressed&&this.signals.dragged.dispatch(e,t)}_onMousedown(e){e.target===this.domElement&&(e.preventDefault(),this._setKeys(e),this.moving=!1,this.hovering=!1,this.down.set(e.clientX,e.clientY),this.position.set(e.clientX,e.clientY),this.which=e.which,this.buttons=(e=>{if("object"==typeof e){if("buttons"in e)return e.buttons;if("which"in e){var t=e.which;if(2===t)return 4;if(3===t)return 2;if(0<t)return 1<<t-1}else if("button"in e){t=e.button;if(1===t)return 4;if(2===t)return 2;if(0<=t)return 1<<t}}return 0})(e),this.pressed=!0,this._setCanvasPosition(e))}_onMouseup(e){e.target===this.domElement&&e.preventDefault(),this._setKeys(e);e=this.canvasPosition;this._distance()<4&&(this.lastClicked=window.performance.now(),this.doubleClickPending&&this.prevClickCP.distanceTo(e)<4&&(this.signals.doubleClicked.dispatch(e.x,e.y),this.doubleClickPending=!1),this.signals.clicked.dispatch(e.x,e.y),this.doubleClickPending=!0,this.prevClickCP.copy(e)),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onContextmenu(e){e.target===this.domElement&&e.preventDefault()}_onTouchstart(e){if(e.target===this.domElement)switch(e.preventDefault(),this.pressed=!0,e.touches.length){case 1:this.moving=!1,this.hovering=!1,this.down.set(e.touches[0].pageX,e.touches[0].pageY),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);break;case 2:this.down.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.lastTouchDistance=wu(e)}}_onTouchend(e){e.target===this.domElement&&e.preventDefault(),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onTouchmove(e){switch(e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,e.touches.length){case 1:this._setKeys(e),this.which=1,this.buttons=1,this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);var t=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(t,r),this.pressed&&this.signals.dragged.dispatch(t,r);break;case 2:var t=wu(e),r=t-this.lastTouchDistance;this.lastTouchDistance=t,this.prevPosition.copy(this.position),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),2<Math.abs(r)&&this.handleScroll&&this.position.distanceTo(this.prevPosition)<2?(this.which=0,this.buttons=0,this.signals.scrolled.dispatch(r/2)):(this.which=3,this.buttons=2,t=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y,this.signals.moved.dispatch(t,r),this.pressed&&this.signals.dragged.dispatch(t,r))}}_distance(){return this.position.distanceTo(this.down)}_setCanvasPosition(e){var t=this.domElement.getBoundingClientRect();let r,i;i="clientX"in e&&"clientY"in e?(r=e.clientX-t.left,e.clientY-t.top):(r=e.offsetX,e.offsetY),this.canvasPosition.set(r,t.height-i)}_setKeys(e){this.altKey=e.altKey,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}dispose(){document.removeEventListener("mousewheel",this._onMousewheel),document.removeEventListener("wheel",this._onMousewheel),document.removeEventListener("MozMousePixelScroll",this._onMousewheel),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mousedown",this._onMousedown),document.removeEventListener("mouseup",this._onMouseup),document.removeEventListener("contextmenu",this._onContextmenu),document.removeEventListener("touchstart",this._onTouchstart),document.removeEventListener("touchend",this._onTouchend),document.removeEventListener("touchmove",this._onTouchmove),window.cancelAnimationFrame(this.frameRequest)}}let Mu=new tt,Cu=new tt,Tu=new tt,Eu=new tt,Pu=new tt,Iu=new et,Ru=new ri,Du=new ri,Lu=new tt,Ou=new et,ku=new et;class Nu{constructor(e,t={}){this.stage=e,this.rotateSpeed=ce(t.rotateSpeed,2),this.zoomSpeed=ce(t.zoomSpeed,1.2),this.panSpeed=ce(t.panSpeed,1),this.viewer=e.viewer,this.mouse=e.mouseObserver,this.controls=e.viewerControls}get component(){return this.stage.transformComponent}get atom(){return this.stage.transformAtom}_setPanVector(e,t,r=0){r=this.controls.getCanvasScaleFactor(r);Ou.set(e,t,0),Ou.multiplyScalar(this.panSpeed*r)}_getRotateXY(e,t){return[this.rotateSpeed*-e*.01,this.rotateSpeed*t*.01]}_getCameraRotation(e){return e.extractRotation(this.viewer.camera.matrixWorld),e.multiply(Cu.makeRotationY(Math.PI)),e}_transformPanVector(){this.component&&(Lu.extractRotation(this.component.transform),Lu.premultiply(this.viewer.rotationGroup.matrix),Lu.invert(),Lu.multiply(this._getCameraRotation(Eu)),Ou.applyMatrix4(Lu))}zoom(e){this.controls.zoom(this.zoomSpeed*e*.02)}pan(e,t){this._setPanVector(e,t),Lu.copy(this.viewer.rotationGroup.matrix).invert(),Lu.multiply(this._getCameraRotation(Eu)),Ou.applyMatrix4(Lu),this.controls.translate(Ou)}panComponent(e,t){this.component&&(this._setPanVector(e,t),this._transformPanVector(),this.component.position.add(Ou),this.component.updateMatrix())}panAtom(e,t){this.atom&&this.component&&(this.atom.positionToVector3(ku),ku.add(this.viewer.translationGroup.position),ku.applyMatrix4(this.viewer.rotationGroup.matrix),this._setPanVector(e,t,ku.z),this._transformPanVector(),this.atom.positionAdd(Ou),this.component.updateRepresentations({position:!0}))}rotate(e,t){var[e,t]=this._getRotateXY(e,t);this._getCameraRotation(Eu),Iu.set(1,0,0),Iu.applyMatrix4(Eu),Ru.setFromAxisAngle(Iu,t),Iu.set(0,1,0),Iu.applyMatrix4(Eu),Du.setFromAxisAngle(Iu,e),Ru.multiply(Du),Eu.makeRotationFromQuaternion(Ru),this.controls.applyMatrix(Eu)}zRotate(e,t){e=this.rotateSpeed*((-e+t)/-2)*.01;Tu.makeRotationZ(e),this.controls.applyMatrix(Tu)}rotateComponent(e,t){this.component&&([e,t]=this._getRotateXY(e,t),this._getCameraRotation(Pu),Eu.extractRotation(this.component.transform),Eu.premultiply(this.viewer.rotationGroup.matrix),Eu.invert(),Eu.premultiply(Pu),Iu.set(1,0,0),Iu.applyMatrix4(Eu),Mu.makeRotationAxis(Iu,t),Iu.set(0,1,0),Iu.applyMatrix4(Eu),Cu.makeRotationAxis(Iu,e),Mu.multiply(Cu),Ru.setFromRotationMatrix(Mu),this.component.quaternion.premultiply(Ru),this.component.quaternion.normalize(),this.component.updateMatrix())}}let Fu=new et;class Bu{constructor(e,t){this.stage=t,this.pid=e.pid,this.picker=e.picker,this.instance=e.instance,this.stage=t,this.controls=t.viewerControls,this.mouse=t.mouseObserver}get type(){return this.picker.type}get altKey(){return this.mouse.altKey}get ctrlKey(){return this.mouse.ctrlKey}get metaKey(){return this.mouse.metaKey}get shiftKey(){return this.mouse.shiftKey}get canvasPosition(){return this.mouse.canvasPosition}get component(){return this.stage.getComponentsByObject(this.picker.data).list[0]}get object(){return this.picker.getObject(this.pid)}get position(){return this.picker.getPosition(this.pid,this.instance,this.component)}get closestBondAtom(){var e,t,r,i,n;if("bond"===this.type&&this.bond)return e=this.bond,i=this.controls,t=this.canvasPosition,r=e.atom1.positionToVector3(),n=e.atom2.positionToVector3(),r.applyMatrix4(this.component.matrix),n.applyMatrix4(this.component.matrix),r=i.getPositionOnCanvas(r),i=i.getPositionOnCanvas(n),n=i,(i=t).distanceTo(r)<i.distanceTo(n)?e.atom1:e.atom2}get closeAtom(){var e,t,r,i=this.canvasPosition,n=this.closestBondAtom;if(n)return e=n.positionToVector3().applyMatrix4(this.component.matrix),e=this.controls.getPositionOnCanvas(e),n.positionToVector3(Fu),this.instance&&Fu.applyMatrix4(this.instance.matrix),Fu.applyMatrix4(this.component.matrix),t=this.controls.viewer,Fu.add(t.translationGroup.position),Fu.applyMatrix4(t.rotationGroup.matrix),t=this.controls.getCanvasScaleFactor(Fu.z),r=this.component.getMaxRepresentationRadius(n.index),i.distanceTo(e)<=r/t?n:void 0}get arrow(){return this._objectIfType("arrow")}get atom(){return this._objectIfType("atom")}get axes(){return this._objectIfType("axes")}get bond(){return this._objectIfType("bond")}get box(){return this._objectIfType("box")}get cone(){return this._objectIfType("cone")}get clash(){return this._objectIfType("clash")}get contact(){return this._objectIfType("contact")}get cylinder(){return this._objectIfType("cylinder")}get distance(){return this._objectIfType("distance")}get ellipsoid(){return this._objectIfType("ellipsoid")}get octahedron(){return this._objectIfType("octahedron")}get point(){return this._objectIfType("point")}get mesh(){return this._objectIfType("mesh")}get slice(){return this._objectIfType("slice")}get sphere(){return this._objectIfType("sphere")}get tetrahedron(){return this._objectIfType("tetrahedron")}get torus(){return this._objectIfType("torus")}get surface(){return this._objectIfType("surface")}get unitcell(){return this._objectIfType("unitcell")}get unknown(){return this._objectIfType("unknown")}get volume(){return this._objectIfType("volume")}get wideline(){return this._objectIfType("wideline")}_objectIfType(e){return this.type===e?this.object:void 0}getLabel(){var e=this.atom||this.closeAtom;let t="nothing";return this.arrow?t=this.arrow.name:e?t=`atom: ${e.qualifiedName()} (${e.structure.name})`:this.axes?t="axes":this.bond?t=`bond: ${this.bond.atom1.qualifiedName()} - ${this.bond.atom2.qualifiedName()} (${this.bond.structure.name})`:this.box?t=this.box.name:this.cone?t=this.cone.name:this.clash?t=`clash: ${this.clash.clash.sele1} - `+this.clash.clash.sele2:this.contact?t=`${this.contact.type}: ${this.contact.atom1.qualifiedName()} - ${this.contact.atom2.qualifiedName()} (${this.contact.atom1.structure.name})`:this.cylinder?t=this.cylinder.name:this.distance?t=`distance: ${this.distance.atom1.qualifiedName()} - ${this.distance.atom2.qualifiedName()} (${this.distance.structure.name})`:this.ellipsoid?t=this.ellipsoid.name:this.octahedron?t=this.octahedron.name:this.point?t=this.point.name:this.mesh?t=`mesh: ${this.mesh.name||this.mesh.serial} (${this.mesh.shape.name})`:this.slice?t=`slice: ${this.slice.value.toPrecision(3)} (${this.slice.volume.name})`:this.sphere?t=this.sphere.name:this.surface?t="surface: "+this.surface.surface.name:this.tetrahedron?t=this.tetrahedron.name:this.torus?t=this.torus.name:this.unitcell?t=`unitcell: ${this.unitcell.unitcell.spacegroup} (${this.unitcell.structure.name})`:this.unknown?t="unknown":this.volume?t=`volume: ${this.volume.value.toPrecision(3)} (${this.volume.volume.name})`:this.wideline&&(t=this.wideline.name),t}}class Uu{constructor(e){this.stage=e,this.viewer=e.viewer}pick(e,t){e=this.viewer.pick(e,t);if(e.picker&&"ignore"!==e.picker.type&&void 0!==e.pid){t=e.picker.array;if(!(t&&e.pid>=t.length))return new Bu(e,this.stage);console.error("pid >= picker.array.length")}}}let zu=new ri,Vu=new et,Gu=new et,Hu=new et,$u=new et,ju=new tt,Wu=new et,qu=new tt;class Xu{constructor(e){this.stage=e,this.signals={changed:new n.Signal},this.viewer=e.viewer}get position(){return this.viewer.translationGroup.position}get rotation(){return this.viewer.rotationGroup.quaternion}changed(){this.viewer.requestRender(),this.signals.changed.dispatch()}getPositionOnCanvas(e,t){var t=Jl(t,Ue),r=this.viewer;return Hu.copy(e).add(r.translationGroup.position).applyMatrix4(r.rotationGroup.matrix).project(r.camera),t.set((Hu.x+1)*r.width/2,(Hu.y+1)*r.height/2)}getCanvasScaleFactor(e=0){var t=this.viewer.camera;return t instanceof Da?1/t.zoom:(e=Math.abs(e),e+=this.getCameraDistance(),t=sh(t.fov),2*e*Math.tan(t/2)/this.viewer.height)}getOrientation(e){var e=th(e),t=(e.copy(this.viewer.rotationGroup.matrix),this.getCameraDistance());return e.scale($u.set(t,t,t)),e.setPosition(this.viewer.translationGroup.position),e}orient(e){th(e).decompose(Vu,zu,Gu);e=this.viewer;e.rotationGroup.setRotationFromQuaternion(zu),e.translationGroup.position.copy(Vu),e.cameraDistance=Gu.z,e.updateZoom(),this.changed()}translate(e){this.viewer.translationGroup.position.add(eh(e)),this.changed()}center(e){this.viewer.translationGroup.position.copy(eh(e)).negate(),this.changed()}zoom(e){this.distance(this.getCameraDistance()*(1-e))}getCameraDistance(){return this.viewer.cameraDistance}distance(e){this.viewer.cameraDistance=Math.max(Math.abs(e),.2),this.viewer.updateZoom(),this.changed()}spin(e,t){ju.copy(this.viewer.rotationGroup.matrix).invert(),Wu.copy(eh(e)).applyMatrix4(ju),this.viewer.rotationGroup.rotateOnAxis(Wu,t),this.changed()}rotate(e){this.viewer.rotationGroup.setRotationFromQuaternion(rh(e)),this.changed()}align(e){qu.copy(th(e)).invert(),this.viewer.rotationGroup.setRotationFromMatrix(qu),this.changed()}applyMatrix(e){this.viewer.rotationGroup.applyMatrix4(th(e)),this.changed()}}class Yu{constructor(e,t,...r){this.pausedTime=-1,this.elapsedDuration=0,this.pausedDuration=0,this.ignoreGlobalToggle=!1,this._paused=!1,this._resolveList=[],this.duration=ce(e,1e3),this.controls=t,this.startTime=window.performance.now(),this._init(...r)}get done(){return 1===this.alpha}get paused(){return this._paused}tick(e){if(!this._paused)return this.elapsedDuration=e.currentTime-this.startTime-this.pausedDuration,0===this.duration?this.alpha=1:this.alpha=mh(0,1,this.elapsedDuration/this.duration),this._tick(e),this.done&&this._resolveList.forEach(e=>e()),this.done}pause(e){e&&(this._hold=!0),-1===this.pausedTime&&(this.pausedTime=window.performance.now()),this._paused=!0}resume(e){!e&&this._hold||(this.pausedDuration+=window.performance.now()-this.pausedTime,this._paused=!1,this._hold=!1,this.pausedTime=-1)}toggle(){this._paused?this.resume():this.pause()}then(e){let t;return(t=this.done?Promise.resolve():new Promise(e=>this._resolveList.push(e))).then(e)}}class Ku extends Yu{constructor(e,t,...r){super(ce(e,1/0),t,...r)}_init(e,t){Array.isArray(e)?this.axis=(new et).fromArray(e):this.axis=ce(e,new et(0,1,0)),this.angle=ce(t,.01)}_tick(e){this.axis&&this.angle&&this.controls.spin(this.axis,this.angle*e.lastDuration/16)}}class Zu extends Yu{constructor(e,t,...r){super(ce(e,1/0),t,...r),this.angleSum=0,this.direction=1}_init(e,t,r){Array.isArray(e)?this.axis=(new et).fromArray(e):this.axis=ce(e,new et(0,1,0)),this.angleStep=ce(t,.01),this.angleEnd=ce(r,.2)}_tick(e){var t;this.axis&&this.angleStep&&this.angleEnd&&(t=mh(0,1,Math.abs(this.angleSum)/this.angleEnd),t=this.angleStep*this.direction*(1.1-t),this.controls.spin(this.axis,t*e.lastDuration/16),this.angleSum+=this.angleStep,this.angleSum>=this.angleEnd)&&(this.direction*=-1,this.angleSum=-this.angleEnd)}}class Qu extends Yu{_init(e,t){this.moveFrom=eh(ce(e,new et)),this.moveTo=eh(ce(t,new et))}_tick(){this.controls.position.lerpVectors(this.moveFrom,this.moveTo,this.alpha).negate(),this.controls.changed()}}class Ju extends Yu{_init(e,t){this.zoomFrom=e,this.zoomTo=t}_tick(){this.controls.distance(uh(this.zoomFrom,this.zoomTo,this.alpha))}}class ed extends Yu{constructor(){super(...arguments),this._currentRotation=new ri}_init(e,t){this.rotateFrom=rh(e),this.rotateTo=rh(t),this._currentRotation=new ri}_tick(){this._currentRotation.copy(this.rotateFrom).slerp(this.rotateTo,this.alpha),this.controls.rotate(this._currentRotation)}}class td extends Yu{_init(e,t,r){this.valueFrom=e,this.valueTo=t,this.callback=r}_tick(){this.callback(uh(this.valueFrom,this.valueTo,this.alpha))}}class rd extends Yu{_init(e){this.callback=e}_tick(){1===this.alpha&&this.callback()}}class id{constructor(e=[]){this._resolveList=[],this._list=e}get done(){return this._list.every(e=>e.done)}then(e){let t;return(t=this.done?Promise.resolve():new Promise(e=>{this._resolveList.push(e),this._list.forEach(e=>{e.then(()=>{this._resolveList.forEach(e=>{e()}),this._resolveList.length=0})})})).then(e)}}class nd{constructor(e){this.stage=e,this.animationList=[],this.finishedList=[],this.viewer=e.viewer,this.controls=e.viewerControls}get paused(){return this.animationList.every(e=>e.paused)}add(e){return 0===e.duration?e.tick(this.viewer.stats):this.animationList.push(e),e}remove(e){var t=this.animationList,e=t.indexOf(e);-1<e&&t.splice(e,1)}run(t){var r=this.finishedList,i=this.animationList,n=i.length;for(let e=0;e<n;++e){var a=i[e];a.tick(t)&&r.push(a)}var s=r.length;if(s){for(let e=0;e<s;++e)this.remove(r[e]);r.length=0}}spin(e,t,r){return this.add(new Ku(r,this.controls,e,t))}rock(e,t,r,i){return this.add(new Zu(i,this.controls,e,t,r))}rotate(e,t){var r=this.viewer.rotationGroup.quaternion.clone();return this.add(new ed(t,this.controls,r,e))}move(e,t){var r=this.controls.position.clone().negate();return this.add(new Qu(t,this.controls,r,e))}zoom(e,t){var r=this.viewer.camera.position.z;return this.add(new Ju(t,this.controls,r,e))}zoomMove(e,t,r){return new id([this.move(e,r),this.zoom(t,r)])}orient(e,t){var r=new et,i=new ri,n=new et;return th(e).decompose(r,i,n),new id([this.move(r.negate(),t),this.rotate(i,t),this.zoom(-n.x,t)])}value(e,t,r,i){return this.add(new td(i,this.controls,e,t,r))}timeout(e,t){return this.add(new rd(t,this.controls,e))}spinComponent(e,t,r,i){return this.add(new Ku(i,e.controls,t,r))}rockComponent(e,t,r,i,n){return this.add(new Zu(n,e.controls,t,r,i))}moveComponent(e,t,r){var i=e.controls.position.clone().negate();return this.add(new Qu(r,e.controls,i,t))}pause(){this.animationList.forEach(e=>e.pause())}resume(){this.animationList.forEach(e=>e.resume())}toggle(){this.paused?this.resume():this.pause()}clear(){this.animationList.length=0}dispose(){this.clear()}}class ad{constructor(e,r){if(this.fn=e,this.queue=[],this.pending=!1,this.next=this.next.bind(this),r){for(let e=0,t=r.length;e<t;++e)this.queue.push(r[e]);this.next()}}run(e){this.fn(e,this.next)}next(){let e=this.queue.shift();void 0!==e?(this.pending=!0,setTimeout(()=>this.run(e))):this.pending=!1}push(e){this.queue.push(e),this.pending||this.next()}kill(){this.queue.length=0}length(){return this.queue.length}}class sd{constructor(e,t,r){this.type="",this.parameters={lazy:{type:"boolean"},clipNear:{type:"range",step:1,max:100,min:0,buffer:!0},clipRadius:{type:"number",precision:1,max:1e3,min:0,buffer:!0},clipCenter:{type:"vector3",precision:1,buffer:!0},flatShaded:{type:"boolean",buffer:!0},opacity:{type:"range",step:.01,max:1,min:0,buffer:!0},depthWrite:{type:"boolean",buffer:!0},side:{type:"select",buffer:!0,options:{front:"front",back:"back",double:"double"}},wireframe:{type:"boolean",buffer:!0},colorData:{type:"hidden",update:"color"},colorScheme:{type:"select",update:"color",options:{}},colorScale:{type:"select",update:"color",options:k.getScales()},colorReverse:{type:"boolean",update:"color"},colorValue:{type:"color",update:"color"},colorDomain:{type:"hidden",update:"color"},colorMode:{type:"select",update:"color",options:k.getModes()},roughness:{type:"range",step:.01,max:1,min:0,buffer:!0},metalness:{type:"range",step:.01,max:1,min:0,buffer:!0},diffuse:{type:"color",buffer:!0},diffuseInterior:{type:"boolean",buffer:!0},useInteriorColor:{type:"boolean",buffer:!0},interiorColor:{type:"color",buffer:!0},interiorDarkening:{type:"range",step:.01,max:1,min:0,buffer:!0},matrix:{type:"hidden",buffer:!0},disablePicking:{type:"boolean",rebuild:!0}},this.viewer=t,this.tasks=new kc,this.queue=new ad(this.make.bind(this)),this.bufferList=[],this.parameters.colorScheme&&(this.parameters.colorScheme.options=k.getSchemes()),this.toBePrepared=!1}init(e){var e=e||{},t=(this.clipNear=ce(e.clipNear,0),this.clipRadius=ce(e.clipRadius,0),this.clipCenter=ce(e.clipCenter,new et),this.flatShaded=ce(e.flatShaded,!1),this.side=ce(e.side,"double"),this.opacity=ce(e.opacity,1),this.depthWrite=ce(e.depthWrite,!0),this.wireframe=ce(e.wireframe,!1),this.setColor(e.color,e),this.colorData=ce(e.colorData,void 0),this.colorScheme=ce(e.colorScheme,"uniform"),this.colorScale=ce(e.colorScale,""),this.colorReverse=ce(e.colorReverse,!1),this.colorValue=ce(e.colorValue,9474192),this.colorDomain=ce(e.colorDomain,void 0),this.colorMode=ce(e.colorMode,"hcl"),this.visible=ce(e.visible,!0),this.quality=ce(e.quality,void 0),this.roughness=ce(e.roughness,.4),this.metalness=ce(e.metalness,0),this.diffuse=ce(e.diffuse,16777215),this.diffuseInterior=ce(e.diffuseInterior,!1),this.useInteriorColor=ce(e.useInteriorColor,!1),this.interiorColor=ce(e.interiorColor,2236962),this.interiorDarkening=ce(e.interiorDarkening,0),this.lazy=ce(e.lazy,!1),this.lazyProps={build:!1,bufferParams:{},what:{}},this.matrix=ce(e.matrix,new tt),this.disablePicking=ce(e.disablePicking,!1),this.parameters);!0===t.sphereDetail&&(t.sphereDetail={type:"integer",max:3,min:0,rebuild:"impostor"}),!0===t.radialSegments&&(t.radialSegments={type:"integer",max:25,min:5,rebuild:"impostor"}),!0===t.openEnded&&(t.openEnded={type:"boolean",rebuild:"impostor",buffer:!0}),!0===t.disableImpostor&&(t.disableImpostor={type:"boolean",rebuild:!0}),"low"===e.quality?(t.sphereDetail&&(this.sphereDetail=0),t.radialSegments&&(this.radialSegments=5)):"medium"===e.quality?(t.sphereDetail&&(this.sphereDetail=1),t.radialSegments&&(this.radialSegments=10)):"high"===e.quality?(t.sphereDetail&&(this.sphereDetail=2),t.radialSegments&&(this.radialSegments=20)):(t.sphereDetail&&(this.sphereDetail=ce(e.sphereDetail,1)),t.radialSegments&&(this.radialSegments=ce(e.radialSegments,10))),t.openEnded&&(this.openEnded=ce(e.openEnded,!0)),t.disableImpostor&&(this.disableImpostor=ce(e.disableImpostor,!1))}getColorParams(e){return Object.assign({data:this.colorData,scheme:this.colorScheme,scale:this.colorScale,reverse:this.colorReverse,value:this.colorValue,domain:this.colorDomain,mode:this.colorMode,colorSpace:this.colorSpace},e)}getBufferParams(e={}){return Object.assign({clipNear:this.clipNear,clipRadius:this.clipRadius,clipCenter:this.clipCenter,flatShaded:this.flatShaded,opacity:this.opacity,depthWrite:this.depthWrite,side:this.side,wireframe:this.wireframe,roughness:this.roughness,metalness:this.metalness,diffuse:this.diffuse,diffuseInterior:this.diffuseInterior,useInteriorColor:this.useInteriorColor,interiorColor:this.interiorColor,interiorDarkening:this.interiorDarkening,matrix:this.matrix,disablePicking:this.disablePicking},e)}setColor(e,t){var r=Object.keys(k.getSchemes());return"string"==typeof e&&r.includes(e.toLowerCase())?t?t.colorScheme=e:this.setParameters({colorScheme:e}):void 0!==e&&(r=new ze(e).getHex(),t?(t.colorScheme="uniform",t.colorValue=r):this.setParameters({colorScheme:"uniform",colorValue:r})),this}prepare(e){}create(){}update(e){this.build()}build(e){!this.lazy||this.visible&&this.opacity?this.toBePrepared?(0<this.queue.length()?(this.tasks.change(1-this.queue.length()),this.queue.kill()):this.tasks.increment(),this.queue.push(e||!1)):(this.tasks.increment(),this.make()):this.lazyProps.build=!0}make(e,t){Je.Debug&&rt.time("Representation.make "+this.type);var r=()=>{e?(this.update(e),this.viewer.requestRender(),this.tasks.decrement(),t&&t()):(this.clear(),this.create(),this.manualAttach||this.disposed||(Je.Debug&&rt.time("Representation.attach "+this.type),this.attach(()=>{Je.Debug&&rt.timeEnd("Representation.attach "+this.type),this.tasks.decrement(),t&&t()}))),Je.Debug&&rt.timeEnd("Representation.make "+this.type)};this.toBePrepared?this.prepare(r):r()}attach(e){this.setVisibility(this.visible),e()}setVisibility(t,e){if(this.visible=t,this.visible&&this.opacity){var r=this.lazyProps,i=r.bufferParams,n=r.what;if(r.build)return r.build=!1,this.build(),this;(Object.keys(i).length||Object.keys(n).length)&&(r.bufferParams={},r.what={},this.updateParameters(i,n))}return this.bufferList.forEach(function(e){e.setVisibility(t)}),e||this.viewer.requestRender(),this}setParameters(e,t={},r=!1){var i,n=e||{},a=this.parameters,s={};for(i in this.opacity||void 0===n.opacity||(this.lazyProps.build?r=!(this.lazyProps.build=!1):(Object.assign(s,this.lazyProps.bufferParams),Object.assign(t,this.lazyProps.what),this.lazyProps.bufferParams={},this.lazyProps.what={})),this.setColor(n.color,n),n)void 0!==n[i]&&null!=a[i]&&(a[i].int&&(n[i]=parseInt(n[i])),a[i].float&&(n[i]=parseFloat(n[i])),n[i]!==this[i]||n[i].equals&&!n[i].equals(this[i]))&&(this[i]&&this[i].copy&&n[i].copy?this[i].copy(n[i]):this[i]&&this[i].set?this[i].set(n[i]):this[i]=n[i],a[i].buffer&&(!0===a[i].buffer?s[i]=n[i]:s[a[i].buffer]=n[i]),a[i].update&&(t[a[i].update]=!0),!a[i].rebuild||"impostor"===a[i].rebuild&&oc&&!this.disableImpostor||(r=!0));return r?this.build():this.updateParameters(s,t),this}updateParameters(t={},e){!this.lazy||this.visible&&this.opacity||!1!==t.hasOwnProperty("opacity")?(this.bufferList.forEach(function(e){e.setParameters(t)}),Object.keys(e).length&&this.update(e),this.viewer.requestRender()):(Object.assign(this.lazyProps.bufferParams,t),Object.assign(this.lazyProps.what,e))}getParameters(){let t={lazy:this.lazy,visible:this.visible,quality:this.quality};return Object.keys(this.parameters).forEach(e=>{null!==this.parameters[e]&&(t[e]=this[e])}),t}clear(){this.bufferList.forEach(e=>{this.viewer.remove(e),e.dispose()}),this.bufferList.length=0,this.viewer.requestRender()}dispose(){this.disposed=!0,this.queue.kill(),this.tasks.dispose(),this.clear()}}class od{constructor(i){this.pending=0,this.postCount=0,this.onmessageDict={},this.onerrorDict={},this.name=i,this.blobUrl=window.URL.createObjectURL(uc.get(i)),this.worker=new Worker(this.blobUrl),uc.activeWorkerCount+=1,this.worker.onmessage=e=>{--this.pending;var t=e.data.__postId,r=(Je.Debug&&rt.timeEnd("Worker.postMessage "+i+" #"+t),this.onmessageDict[t]);r&&r.call(this.worker,e),delete this.onmessageDict[t],delete this.onerrorDict[t]},this.worker.onerror=e=>{var t,r;--this.pending,e.data?(t=e.data.__postId,(r=this.onerrorDict[t])?r.call(this.worker,e):rt.error("Worker.onerror",t,i,e),delete this.onmessageDict[t],delete this.onerrorDict[t]):rt.error("Worker.onerror",i,e)}}post(t={},e,r,i){this.onmessageDict[this.postCount]=r,this.onerrorDict[this.postCount]=i,t.__name=this.name,t.__postId=this.postCount,t.__debug=Je.Debug,Je.Debug&&rt.time(`Worker.postMessage ${this.name} #`+this.postCount);try{this.worker.postMessage(t,e)}catch(e){rt.error("worker.post:",e),this.worker.postMessage(t)}return this.pending+=1,this.postCount+=1,this}terminate(){this.worker?(this.worker.terminate(),window.URL.revokeObjectURL(this.blobUrl),--uc.activeWorkerCount):rt.log("no worker to terminate")}}class ld{constructor(e,t=2){this.pool=[],this.count=0,this.maxCount=Math.min(8,t),this.name=e}post(e={},t,r,i){var n=this.getNextWorker();return n?n.post(e,t,r,i):console.error("unable to get worker from pool"),this}terminate(){this.pool.forEach(function(e){e.terminate()})}getNextWorker(){let t,r=1/0;for(let e=0;e<this.maxCount;++e){if(e>=this.count){t=new od(this.name),this.pool.push(t),this.count+=1;break}var i=this.pool[e];if(0===i.pending){t=i;break}i.pending<r&&(r=i.pending,t=i)}return t}}function hd(t){var r=t.length,e=r/3;let i=0,n=0,a=0;for(let e=0;e<r;e+=3)i+=t[e+0],n+=t[e+1],a+=t[e+2];return new et(i/e,n/e,a/e)}function cd(e,t,r){r?e.sub(r).projectOnVector(t).add(r):e.projectOnVector(t)}function ud(r){let i=1/0,n=1/0,a=1/0,s=-1/0,o=-1/0,l=-1/0;for(let e=0,t=r.length;e<t;e+=3){var h=r[e],c=r[e+1],u=r[e+2];h<i&&(i=h),c<n&&(n=c),u<a&&(a=u),h>s&&(s=h),c>o&&(o=c),u>l&&(l=u)}return[Q([i,n,a]),Q([s,o,l])]}function dd(r,i){for(let e=0,t=i.length;e<t;e+=3){var n=i[e],a=i[e+1],s=i[e+2];i[e]=r[0]*n+r[4]*a+r[8]*s+r[12],i[e+1]=r[1]*n+r[5]*a+r[9]*s+r[13],i[e+2]=r[2]*n+r[6]*a+r[10]*s+r[14]}}function md(r,i){for(let e=0,t=i.length;e<t;e+=3){var n=i[e],a=i[e+1],s=i[e+2];i[e]=r[0]*n+r[3]*a+r[6]*s,i[e+1]=r[1]*n+r[4]*a+r[7]*s,i[e+2]=r[2]*n+r[5]*a+r[8]*s}}function pd(r){for(let e=0,t=r.length;e<t;e+=3){var i=r[e],n=r[e+1],a=r[e+2],s=i*i+n*n+a*a;0<s&&(s=1/Math.sqrt(s),r[e]=i*s,r[e+1]=n*s,r[e+2]=a*s)}}function Q(e){return new Float32Array(e||3)}function fd(e,t,r){var i=t[0],n=t[1],t=t[2],a=r[0],s=r[1],r=r[2];e[0]=n*r-t*s,e[1]=t*a-i*r,e[2]=i*s-n*a}function gd(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function vd(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}function _d(e,t,r){e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2]}function yd(e,t,r=0){e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}function J(e,t,r=0){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2]}function bd(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function xd(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function Sd(e,t,r){ue(e,t,1/r)}function ue(e,t,r){e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}function wd(e,t){var r=bd(t);0==r?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):ue(e,t,1/Math.sqrt(r))}function Ad(e,t,r){e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r}function Md(e,t,r){e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r}function Cd(e,t){e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2])}function Td(e,t){e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2])}function Ed(e,t){e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]}function Pd(t,e=9){var r=Math.floor(e/2),i=t.position1.length/3,n=3*(r*i),a=1/e,s=Wc(t.position1,t.position2),o=new Float32Array(n),l=new Float32Array(n),h=new et;for(let e=0;e<i;++e){var c=3*e,u=(h.set(s[c],s[1+c],s[2+c]),t.position1[c]),d=t.position1[1+c],m=t.position1[2+c];for(let e=0;e<r;++e){var p=r*c+3*e,f=a*(2*e+1),g=a*(2*e+2);o[p]=u+h.x*f,o[1+p]=d+h.y*f,o[2+p]=m+h.z*f,l[p]=u+h.x*g,l[1+p]=d+h.y*g,l[2+p]=m+h.z*g}}e=jc(o,l),n=((t,r)=>{var i=t.length/3,n=new Float32Array(i*r*3);for(let e=0;e<i;++e){var a=3*e,s=e*r*3,o=t[0+a],l=t[1+a],h=t[2+a];for(let e=0;e<r;++e){var c=s+3*e;n[c]=o,n[1+c]=l,n[2+c]=h}}return n})(t.color,r),e={position:e,position1:o,position2:l,color:n,color2:n};return t.radius&&(e.radius=Kc(t.radius,r)),t.picking&&t.picking.array&&(t.picking.array=Kc(t.picking.array,r),e.picking=t.picking),t.primitiveId&&(e.primitiveId=Kc(t.primitiveId,r)),e}function Id(r,e=.1){var i=Wc(r.position1,r.position2),n=[],a=[],s=[],o=r.radius?[]:void 0,l=r.picking?[]:void 0,h=r.primitiveId?[]:void 0,c=new et,u=r.position1.length/3;let d=0;for(let t=0;t<u;++t){var m=3*t,p=(c.set(i[m],i[1+m],i[2+m]),c.length()),p=p/e,f=Math.floor(p/2),g=1/p,v=r.position1[m],_=r.position1[1+m],y=r.position1[2+m];for(let e=0;e<f;++e){var b=3*d+3*e,x=g*(2*e+1),S=g*(2*e+2);n[b]=v+c.x*x,n[1+b]=_+c.y*x,n[2+b]=y+c.z*x,a[b]=v+c.x*S,a[1+b]=_+c.y*S,a[2+b]=y+c.z*S,r.color&&(s[b]=r.color[m],s[1+b]=r.color[1+m],s[2+b]=r.color[2+m]),o&&(o[d+e]=r.radius[t]),l&&(r.picking.array?l[d+e]=r.picking.array[t]:l[d+e]=t),h&&(h[d+e]=r.primitiveId[t])}d+=f}var t=new Float32Array(n),w=new Float32Array(a),A=jc(t,w),M=new Float32Array(s),A={position:A,position1:t,position2:w,color:M,color2:M};return o&&(A.radius=new Float32Array(o)),l&&r.picking&&(r.picking.array=new Float32Array(l),A.picking=r.picking),h&&(A.primitiveId=new Float32Array(h)),A}function Rd(r,i=.1){var n=Wc(r.position1,r.position2),a=[],s=[],o=[],l=r.radius?[]:void 0,h=r.picking?[]:void 0,c=r.primitiveId?[]:void 0,u=new et,d=r.position1.length/3;let m=i,p=!0,f=0,g=0,v=0;for(let t=0;t<d;++t){var _=3*t,y=r.position1[_],b=r.position1[1+_],x=r.position1[2+_],S=(u.set(n[_],n[1+_],n[2+_]),u.length());p&&(a[g]=y,a[g+1]=b,a[g+2]=x);let e=m;for(var w,A=1/S;e<S;){var M=p?s:a;M[g]=y+u.x*e*A,M[g+1]=b+u.y*e*A,M[g+2]=x+u.z*e*A,p&&(f++,g=3*f),p=!p,m=i,e+=i}p&&(s[g]=r.position2[_],s[g+1]=r.position2[1+_],s[g+2]=r.position2[2+_],f++,g=3*f),m=e-S;for(let e=v;e<f;e++)r.color&&(o[w=3*e]=r.color[_],o[1+w]=r.color[1+_],o[2+w]=r.color[2+_]),l&&(l[e]=r.radius[t]),h&&(r.picking.array?h[e]=r.picking.array[t]:h[e]=t),c&&(c[e]=r.primitiveId[t]);v=f}if(!p&&0<d){let e=3*f;s[e]=r.position2[3*d-3],s[1+e]=r.position2[3*d-2],s[1+e]=r.position2[3*d-1]}var e=new Float32Array(a),t=new Float32Array(s),C=jc(e,t),T=new Float32Array(o),C={position:C,position1:e,position2:t,color:T,color2:T};return l&&(C.radius=new Float32Array(l)),h&&r.picking&&(r.picking.array=new Float32Array(h),C.picking=r.picking),c&&(C.primitiveId=new Float32Array(c)),C}ld.prototype.constructor=ld,ud.__deps=[Q],Sd.__deps=[ue],wd.__deps=[ue,bd];let Dd=new et;class Ld{static get Picker(){return vc.get(this.type)}static get Buffer(){return gc.get(this.type)}static getShapeKey(e){return this.type+e[0].toUpperCase()+e.substr(1)}static expandBoundingBox(e,t){}static valueToShape(e,t,r){var i,n,a=e._primitiveData[this.getShapeKey(t)];switch(this.fields[t]){case"v3":case"c":n=a,void 0!==(i=r).toArray?i=i.toArray():void 0!==i.x?i=[i.x,i.y,i.z]:void 0!==i.r&&(i=[i.r,i.g,i.b]),n.push.apply(n,i);break;default:a.push(r)}}static objectToShape(t,r){Object.keys(this.fields).forEach(e=>{this.valueToShape(t,e,r[e])}),this.valueToShape(t,"name",r.name),this.expandBoundingBox(t.boundingBox,r)}static valueFromShape(e,t,r){var i=e._primitiveData[this.getShapeKey(r)];switch(this.fields[r]){case"v3":return(new et).fromArray(i,3*t);case"c":return(new ze).fromArray(i,3*t);default:return i[t]}}static objectFromShape(t,r){let e=this.valueFromShape(t,r,"name"),i=(void 0===e&&(e=`${this.type}: ${r} (${t.name})`),{shape:t,name:e});return Object.keys(this.fields).forEach(e=>{i[e]=this.valueFromShape(t,r,e)}),i}static arrayFromShape(e,t){e=e._primitiveData[this.getShapeKey(t)];return"s"!==this.fields[t]?new Float32Array(e):e}static dataFromShape(t){let r={};return this.Picker&&(r.picking=new this.Picker(t)),Object.keys(this.fields).forEach(e=>{r[e]=this.arrayFromShape(t,e)}),r}static bufferFromShape(e,t){return new this.Buffer(this.dataFromShape(e),t)}}Ld.type="",Ld.fields={};class Od extends Ld{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position))}}Od.type="sphere",Od.fields={position:"v3",color:"c",radius:"f"};class kd extends Ld{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position))}}kd.type="box",kd.fields={position:"v3",color:"c",size:"f",heightAxis:"v3",depthAxis:"v3"};class Nd extends kd{}Nd.type="octahedron";class Fd extends kd{}Fd.type="tetrahedron";class Bd extends Ld{static positionFromShape(e,t){var r=this.valueFromShape(e,t,"position1"),e=this.valueFromShape(e,t,"position2");return r.add(e).multiplyScalar(.5)}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position1)),e.expandByPoint(Dd.fromArray(t.position2))}static bufferFromShape(e,t={}){let r=this.dataFromShape(e);return"cylinder"===this.type&&t.dashedCylinder&&(r=Id(r)),new this.Buffer(r,t)}}Bd.type="cylinder",Bd.fields={position1:"v3",position2:"v3",color:"c",radius:"f"};class Ud extends Bd{}Ud.type="arrow";class zd extends Bd{}zd.type="cone";class Vd extends Od{}Vd.type="ellipsoid",Vd.fields={position:"v3",color:"c",radius:"f",majorAxis:"v3",minorAxis:"v3"};class Gd extends Vd{}Gd.type="torus";class Hd extends Ld{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position))}}Hd.type="text",Hd.fields={position:"v3",color:"c",size:"f",text:"s"};class $d extends Ld{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position))}}$d.type="point",$d.fields={position:"v3",color:"c"};class jd extends Ld{static positionFromShape(e,t){var r=this.valueFromShape(e,t,"position1"),e=this.valueFromShape(e,t,"position2");return r.add(e).multiplyScalar(.5)}static expandBoundingBox(e,t){e.expandByPoint(Dd.fromArray(t.position1)),e.expandByPoint(Dd.fromArray(t.position2))}}jd.type="wideline",jd.fields={position1:"v3",position2:"v3",color:"c"};class Wd{constructor(e,t){this.exp=3;var t=t||(e=>{var{x:t,y:r,z:i}=e,e=new ai,n=t.length,{min:a,max:s}=e;for(let e=0;e<n;e++)a.x=Math.min(t[e],a.x),a.y=Math.min(r[e],a.y),a.z=Math.min(i[e],a.z),s.x=Math.max(t[e],s.x),s.y=Math.max(r[e],s.y),s.z=Math.max(i[e],s.z);return e})(e),r=(this.minX=t.min.x,this.minY=t.min.y,this.minZ=t.min.z,this.boundX=1+(t.max.x-this.minX>>this.exp),this.boundY=1+(t.max.y-this.minY>>this.exp),this.boundZ=1+(t.max.z-this.minZ>>this.exp),this.boundX*this.boundY*this.boundZ),i=void 0!==e.count?e.count:e.x.length,n=e.x,a=e.y,s=e.z;let o=0;var l=new Uint32Array(r),h=new Int32Array(i);for(let e=0;e<i;++e){var c=n[e]-this.minX>>this.exp,u=a[e]-this.minY>>this.exp,d=s[e]-this.minZ>>this.exp,c=(c*this.boundY+u)*this.boundZ+d;1===(l[c]+=1)&&(o+=1),h[e]=c}var m=new Uint16Array(o);for(let e=0,t=0;e<r;++e){var p=l[e];0<p&&(l[e]=t+1,m[t]=p,t+=1)}var f=new Uint32Array(o);for(let e=1;e<o;++e)f[e]+=f[e-1]+m[e-1];var g=new Uint16Array(o),v=new Int32Array(i);for(let e=0;e<i;++e){var _=l[h[e]];0<_&&(v[f[_=_-1]+g[_]]=e,g[_]+=1)}this.grid=l,this.bucketCount=m,this.bucketOffset=f,this.bucketArray=v,this.xArray=n,this.yArray=a,this.zArray=s}within(e,t,r,i){let n=[];return this.eachWithin(e,t,r,i,e=>n.push(e)),n}eachWithin(i,n,a,e,s){var o=e*e,t=Math.max(0,i-e-this.minX>>this.exp),l=Math.max(0,n-e-this.minY>>this.exp),h=Math.max(0,a-e-this.minZ>>this.exp),c=Math.min(this.boundX,1+(i+e-this.minX>>this.exp)),u=Math.min(this.boundY,1+(n+e-this.minY>>this.exp)),d=Math.min(this.boundZ,1+(a+e-this.minZ>>this.exp));for(let r=t;r<c;++r)for(let t=l;t<u;++t)for(let e=h;e<d;++e){var m=(r*this.boundY+t)*this.boundZ+e,m=this.grid[m];if(0<m){var m=m-1,p=this.bucketOffset[m],f=p+this.bucketCount[m];for(let e=p;e<f;++e){var g=this.bucketArray[e],v=this.xArray[g]-i,_=this.yArray[g]-n,y=this.zArray[g]-a,v=v*v+_*_+y*y;v<=o&&s(g,v)}}}}}class qd{constructor(e=0){this._fields=this._defaultFields,this._init(0)}get _defaultFields(){return[]}_init(e){this.length=e;for(let i=this.count=0,e=this._fields.length;i<e;++i){let[e,t,r]=this._fields[i];this._initField(e,t,r)}}_initField(e,t,r){this[e]=Kl(r,this.length*t)}addField(e,t,r){this._fields.push([e,t,r]),this._initField(e,t,r)}resize(e){this.length=Math.round(e||0),this.count=Math.min(this.count,this.length);for(let e=0,t=this._fields.length;e<t;++e){var r=this._fields[e][0],i=this._fields[e][1],i=this.length*i,n=new this[r].constructor(i);this[r].length>i?n.set(this[r].subarray(0,i)):n.set(this[r]),this[r]=n}}growIfFull(){var e;this.count>=this.length&&(e=Math.round(1.5*this.length),this.resize(Math.max(256,e)))}copyFrom(r,i,n,a){for(let e=0,t=this._fields.length;e<t;++e){var s=this._fields[e][0],o=this._fields[e][1],l=this[s],h=r[s];for(let e=0;e<a;++e){var c=o*(i+e),u=o*(n+e);for(let e=0;e<o;++e)l[c+e]=h[u+e]}}}copyWithin(r,i,n){for(let e=0,t=this._fields.length;e<t;++e){var a=this._fields[e][0],s=this._fields[e][1],o=this[a];for(let e=0;e<n;++e){var l=s*(r+e),h=s*(i+e);for(let e=0;e<s;++e)o[l+e]=o[h+e]}}}sort(l){rt.time("Store.sort");let h=this,c=new this.constructor(1);!function i(n,a){if(n<a){let e=Math.floor((n+a)/2),t=n,r=a;do{for(;l(t,e)<0;)t+=1;for(;0<l(r,e);)--r;t<=r&&(t===e?e=r:r===e&&(e=t),s=t,o=r,s!==o&&(c.copyFrom(h,0,s,1),h.copyWithin(s,o,1),h.copyFrom(c,o,0,1)),t+=1,--r)}while(t<=r);i(n,r),i(t,a)}var s,o}(0,this.count-1),rt.timeEnd("Store.sort")}clear(){this.count=0}dispose(){for(let e=0,t=this._fields.length;e<t;++e)delete this[this._fields[e][0]]}}class Xd extends qd{get _defaultFields(){return[["index1",1,"int32"],["index2",1,"int32"],["type",1,"int8"]]}addContact(e,t,r){this.growIfFull();var i=this.count;e<t?(this.index1[i]=e,this.index2[i]=t):(this.index2[i]=e,this.index1[i]=t),r&&(this.type[i]=r),this.count+=1}}function Yd(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}class Kd{constructor(e,t){this.length=e,this._words=new Uint32Array(e+32>>>5),!0===t&&this.setAll()}get(e){return 0!=(this._words[e>>>5]&1<<e)}set(e){this._words[e>>>5]|=1<<e}clear(e){this._words[e>>>5]&=~(1<<e)}flip(e){this._words[e>>>5]^=1<<e}_assignRange(r,i,e){if(!(i<r)){var n=this._words,t=!0===e?4294967295:0,a=r>>>5,s=i>>>5;for(let e=1+a;e<s;++e)n[e]=t;var a=a<<5,o=s<<5;if(!0===e)if(i-r<32)for(let e=r,t=i+1;e<t;++e)n[e>>>5]|=1<<e;else{for(let e=r,t=32+a;e<t;++e)n[e>>>5]|=1<<e;for(let e=o,t=i+1;e<t;++e)n[e>>>5]|=1<<e}else if(i-r<32)for(let e=r,t=i+1;e<t;++e)n[e>>>5]&=~(1<<e);else{for(let e=r,t=32+a;e<t;++e)n[e>>>5]&=~(1<<e);for(let e=o,t=i+1;e<t;++e)n[e>>>5]&=~(1<<e)}return this}}setRange(e,t){return this._assignRange(e,t,!0)}clearRange(e,t){return this._assignRange(e,t,!1)}setBits(...t){var r=this._words,i=t.length;for(let e=0;e<i;++e){var n=t[e];r[n>>>5]|=1<<n}return this}clearBits(...t){var r=this._words,i=t.length;for(let e=0;e<i;++e){var n=t[e];r[n>>>5]&=~(1<<n)}return this}setAll(){return this._assignRange(0,this.length-1,!0)}clearAll(){return this._assignRange(0,this.length-1,!1)}flipAll(){var t=this._words.length,r=this._words,e=32-this.length%32;for(let e=0;e<t-1;++e)r[e]=~r[e];return r[t-1]=~(r[t-1]<<e)>>>e,this}_isRangeValue(r,i,n){if(!(i<r)){var a=this._words,t=!0===n?4294967295:0,s=r>>>5,o=i>>>5;for(let e=1+s;e<o;++e)if(a[e]!==t)return!1;if(i-r<32){for(let e=r,t=i+1;e<t;++e)if(!!(a[e>>>5]&1<<e)!==n)return!1}else{var l=o<<5;for(let e=r,t=32+(s<<5);e<t;++e)if(!!(a[e>>>5]&1<<e)!==n)return!1;for(let e=l,t=i+1;e<t;++e)if(!!(a[e>>>5]&1<<e)!==n)return!1}return!0}}isRangeSet(e,t){return this._isRangeValue(e,t,!0)}isRangeClear(e,t){return this._isRangeValue(e,t,!1)}isAllSet(){return this._isRangeValue(0,this.length-1,!0)}isAllClear(){return this._isRangeValue(0,this.length-1,!1)}isSet(...t){var r=this._words,i=t.length;for(let e=0;e<i;++e){var n=t[e];if(0==(r[n>>>5]&1<<n))return!1}return!0}isClear(...t){var r=this._words,i=t.length;for(let e=0;e<i;++e){var n=t[e];if(0!=(r[n>>>5]&1<<n))return!1}return!0}isEqualTo(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);for(let e=0;e<i;++e)if(t[e]!==r[e])return!1;return!0}getSize(){var t=this._words.length,r=this._words;let i=0;for(let e=0;e<t;++e)i+=Yd(r[e]);return i}difference(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);for(let e=0;e<i;++e)t[e]=t[e]&~r[e];for(let e=t.length;e<i;++e)t[e]=0;return this}union(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);for(let e=0;e<i;++e)t[e]|=r[e];for(let e=t.length;e<i;++e)t[e]=0;return this}intersection(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);for(let e=0;e<i;++e)t[e]&=r[e];for(let e=t.length;e<i;++e)t[e]=0;return this}intersects(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);for(let e=0;e<i;++e)if(0!=(t[e]&r[e]))return!0;return!1}getIntersectionSize(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length);let n=0;for(let e=0;e<i;++e)n+=Yd(t[e]&r[e]);return n}makeIntersection(e){var t=this._words,r=e._words,i=Math.min(t.length,r.length),n=new Uint32Array(i),a=Object.create(Kd.prototype);a._words=n,a.length=Math.min(this.length,e.length);for(let e=0;e<i;++e)n[e]=t[e]&r[e];return a}forEach(r){var e=this._words.length,i=this._words;let n=0;for(let t=0;t<e;++t){let e=i[t];for(;0!==e;){var a=e&-e;r((t<<5)+Yd(a-1),n),e^=a,++n}}}toArray(){var r=this._words,i=new Array(this.getSize()),e=this._words.length;let n=0;for(let t=0;t<e;++t){let e=r[t];for(;0!==e;){var a=e&-e;i[n++]=(t<<5)+Yd(a-1),e^=a}}return i}toString(){return"{"+this.toArray().join(",")+"}"}toSeleString(){var e=this.toArray().join(",");return e?"@"+e:"NONE"}clone(){var e=Object.create(Kd.prototype);return e.length=this.length,e._words=new Uint32Array(this._words),e}}function Zd(e){var{edgeCount:t,nodeCount:r,nodeArray1:i,nodeArray2:n}=e,a=new Uint8Array(r),s=new Int32Array(r);for(let e=0;e<t;++e)a[i[e]]+=1,a[n[e]]+=1;for(let e=1;e<r;++e)s[e]+=s[e-1]+a[e-1];var o=2*t,l=new Int32Array(o);for(let e=0;e<o;++e)l[e]=-1;for(let r=0;r<t;++r){var h=i[r],c=n[r];let e=s[h];for(;-1!==l[e]&&e<o;)e+=1;l[e]=r;let t=s[c];for(;-1!==l[t]&&t<o;)t+=1;l[t]=r}return{countArray:a,offsetArray:s,indexArray:l}}function Qd(e=0,t=0){return{type:e,group:t,x:0,y:0,z:0,atomSet:[]}}function Jd(e,t){e.x+=t.x,e.y+=t.y,e.z+=t.z,e.atomSet.push(t.index)}function em(e,t){var r,i,n,a=t.atomSet.length;0<a&&({types:e,groups:r,centers:i,atomSets:n}=e,e.push(t.type),r.push(t.group),i.x.push(t.x/a),i.y.push(t.y/a),i.z.push(t.z/a),n.push(t.atomSet))}let tm=0,rm=["D-BETA-PEPTIDE, C-GAMMA LINKING","D-GAMMA-PEPTIDE, C-DELTA LINKING","D-PEPTIDE COOH CARBOXY TERMINUS","D-PEPTIDE NH3 AMINO TERMINUS","D-PEPTIDE LINKING","L-BETA-PEPTIDE, C-GAMMA LINKING","L-GAMMA-PEPTIDE, C-DELTA LINKING","L-PEPTIDE COOH CARBOXY TERMINUS","L-PEPTIDE NH3 AMINO TERMINUS","L-PEPTIDE LINKING","PEPTIDE LINKING","PEPTIDE-LIKE"],im=["RNA OH 3 PRIME TERMINUS","RNA OH 5 PRIME TERMINUS","RNA LINKING"],nm=["DNA OH 3 PRIME TERMINUS","DNA OH 5 PRIME TERMINUS","DNA LINKING","L-DNA LINKING","L-RNA LINKING"],am=["D-SACCHARIDE","D-SACCHARIDE 1,4 AND 1,4 LINKING","D-SACCHARIDE 1,4 AND 1,6 LINKING","L-SACCHARIDE","L-SACCHARIDE 1,4 AND 1,4 LINKING","L-SACCHARIDE 1,4 AND 1,6 LINKING","SACCHARIDE"];let sm=["NON-POLYMER"].concat(["OTHER"],am),om=["h","g","i"],lm=["e","b"],hm=["s","t","l",""],cm={H:1,D:1,T:1,HE:2,LI:3,BE:4,B:5,C:6,N:7,O:8,F:9,NE:10,NA:11,MG:12,AL:13,SI:14,P:15,S:16,CL:17,AR:18,K:19,CA:20,SC:21,TI:22,V:23,CR:24,MN:25,FE:26,CO:27,NI:28,CU:29,ZN:30,GA:31,GE:32,AS:33,SE:34,BR:35,KR:36,RB:37,SR:38,Y:39,ZR:40,NB:41,MO:42,TC:43,RU:44,RH:45,PD:46,AG:47,CD:48,IN:49,SN:50,SB:51,TE:52,I:53,XE:54,CS:55,BA:56,LA:57,CE:58,PR:59,ND:60,PM:61,SM:62,EU:63,GD:64,TB:65,DY:66,HO:67,ER:68,TM:69,YB:70,LU:71,HF:72,TA:73,W:74,RE:75,OS:76,IR:77,PT:78,AU:79,HG:80,TL:81,PB:82,BI:83,PO:84,AT:85,RN:86,FR:87,RA:88,AC:89,TH:90,PA:91,U:92,NP:93,PU:94,AM:95,CM:96,BK:97,CF:98,ES:99,FM:100,MD:101,NO:102,LR:103,RF:104,DB:105,SG:106,BH:107,HS:108,MT:109,DS:110,RG:111,CN:112,NH:113,FL:114,MC:115,LV:116,TS:117,OG:118},um={1:1.1,2:1.4,3:1.81,4:1.53,5:1.92,6:1.7,7:1.55,8:1.52,9:1.47,10:1.54,11:2.27,12:1.73,13:1.84,14:2.1,15:1.8,16:1.8,17:1.75,18:1.88,19:2.75,20:2.31,21:2.3,22:2.15,23:2.05,24:2.05,25:2.05,26:2.05,27:2,28:2,29:2,30:2.1,31:1.87,32:2.11,33:1.85,34:1.9,35:1.83,36:2.02,37:3.03,38:2.49,39:2.4,40:2.3,41:2.15,42:2.1,43:2.05,44:2.05,45:2,46:2.05,47:2.1,48:2.2,49:2.2,50:1.93,51:2.17,52:2.06,53:1.98,54:2.16,55:3.43,56:2.68,57:2.5,58:2.48,59:2.47,60:2.45,61:2.43,62:2.42,63:2.4,64:2.38,65:2.37,66:2.35,67:2.33,68:2.32,69:2.3,70:2.28,71:2.27,72:2.25,73:2.2,74:2.1,75:2.05,76:2,77:2,78:2.05,79:2.1,80:2.05,81:1.96,82:2.02,83:2.07,84:1.97,85:2.02,86:2.2,87:3.48,88:2.83,89:2,90:2.4,91:2,92:2.3,93:2,94:2,95:2,96:2,97:2,98:2,99:2,100:2,101:2,102:2,103:2,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:2,114:2,115:2,116:2,117:2,118:2},dm={1:.31,2:.28,3:1.28,4:.96,5:.84,6:.76,7:.71,8:.66,9:.57,10:.58,11:1.66,12:1.41,13:1.21,14:1.11,15:1.07,16:1.05,17:1.02,18:1.06,19:2.03,20:1.76,21:1.7,22:1.6,23:1.53,24:1.39,25:1.39,26:1.32,27:1.26,28:1.24,29:1.32,30:1.22,31:1.22,32:1.2,33:1.19,34:1.2,35:1.2,36:1.16,37:2.2,38:1.95,39:1.9,40:1.75,41:1.64,42:1.54,43:1.47,44:1.46,45:1.42,46:1.39,47:1.45,48:1.44,49:1.42,50:1.39,51:1.39,52:1.38,53:1.39,54:1.4,55:2.44,56:2.15,57:2.07,58:2.04,59:2.03,60:2.01,61:1.99,62:1.98,63:1.98,64:1.96,65:1.94,66:1.92,67:1.92,68:1.89,69:1.9,70:1.87,71:1.87,72:1.75,73:1.7,74:1.62,75:1.51,76:1.44,77:1.41,78:1.36,79:1.36,80:1.32,81:1.45,82:1.46,83:1.48,84:1.4,85:1.5,86:1.5,87:2.6,88:2.21,89:2.15,90:2.06,91:2,92:1.96,93:1.9,94:1.87,95:1.8,96:1.69,97:1.6,98:1.6,99:1.6,100:1.6,101:1.6,102:1.6,103:1.6,104:1.6,105:1.6,106:1.6,107:1.6,108:1.6,109:1.6,110:1.6,111:1.6,112:1.6,113:1.6,114:1.6,115:1.6,116:1.6,117:1.6,118:1.6},mm={1:[1],2:[0],3:[1],4:[2],5:[3],6:[4],7:[3],8:[2],9:[1],10:[0],11:[1],12:[2],13:[6],14:[6],15:[3,5,7],16:[2,4,6],17:[1],18:[0],19:[1],20:[2],31:[3],32:[4],33:[3,5],34:[2,4,6],35:[1],36:[0],37:[1],38:[2],49:[3],50:[4],51:[3,5],52:[2],53:[1,2,5],54:[0,2],55:[1],56:[2],81:[3],82:[4],83:[3],84:[2],85:[1],86:[0],87:[1],88:[2]},pm={1:1,2:2,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:1,12:2,13:3,14:4,15:5,16:6,17:7,18:8,19:1,20:2,21:3,22:4,23:5,24:6,25:7,26:8,27:9,28:10,29:11,30:2,31:3,32:4,33:5,34:6,35:7,36:8,37:1,38:2,39:3,40:4,41:5,42:6,43:7,44:8,45:9,46:10,47:11,48:2,49:3,50:4,51:5,52:6,53:7,54:8,55:1,56:2,57:3,58:4,59:3,60:4,61:5,62:6,63:7,64:8,65:9,66:10,67:11,68:12,69:13,70:14,71:15,72:4,73:5,74:6,75:7,76:8,77:9,78:10,79:11,80:2,81:3,82:4,83:5,84:6,85:7,86:8,87:1,88:2,89:3,90:4,91:3,92:4,93:5,94:6,95:7,96:8,97:9,98:10,99:11,100:12,101:13,102:14,103:15,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:3,114:4,115:5,116:6,117:7,118:8},fm={ALA:[.17,.5,.33],ARG:[.81,1.81,1],ASN:[.42,.85,.43],ASP:[1.23,3.64,2.41],ASH:[-.07,.43,.5],CYS:[-.24,-.02,.22],GLN:[.58,.77,.19],GLU:[2.02,3.63,1.61],GLH:[-.01,.11,.12],GLY:[.01,1.15,1.14],HIS:[.17,.11,-.06],ILE:[-.31,-1.12,-.81],LEU:[-.56,-1.25,-.69],LYS:[.99,2.8,1.81],MET:[-.23,-.67,-.44],PHE:[-1.13,-1.71,-.58],PRO:[.45,.14,-.31],SER:[.13,.46,.33],THR:[.14,.25,.11],TRP:[-1.85,-2.09,-.24],TYR:[-.94,-.71,.23],VAL:[.07,-.46,-.53]},gm=[0,0,0],vm={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",SEC:"U",PYL:"O"},_m=Object.keys(vm),ym=["A","C","T","G","U","I"],bm=["DA","DC","DT","DG","DU","DI"],xm=["A","G","I","DA","DG","DI"],Sm=ym.concat(bm),wm=["SOL","WAT","HOH","H2O","W","DOD","D3O","TIP3","TIP4","SPC"],Am=["118","119","1AL","1CU","2FK","2HP","2OF","3CO","3MT","3NI","3OF","3P8","4MO","4PU","543","6MO","ACT","AG","AL","ALF","AM","ATH","AU","AU3","AUC","AZI","BA","BCT","BEF","BF4","BO4","BR","BS3","BSY","CA","CAC","CD","CD1","CD3","CD5","CE","CHT","CL","CO","CO3","CO5","CON","CR","CS","CSB","CU","CU1","CU3","CUA","CUZ","CYN","DME","DMI","DSC","DTI","DY","E4N","EDR","EMC","ER3","EU","EU3","F","FE","FE2","FPO","GA","GD3","GEP","HAI","HG","HGC","IN","IOD","IR","IR3","IRI","IUM","K","KO4","LA","LCO","LCP","LI","LU","MAC","MG","MH2","MH3","MLI","MLT","MMC","MN","MN3","MN5","MN6","MO1","MO2","MO3","MO4","MO5","MO6","MOO","MOS","MOW","MW1","MW2","MW3","NA","NA2","NA5","NA6","NAO","NAW","NCO","NET","NH4","NI","NI1","NI2","NI3","NO2","NO3","NRU","O4M","OAA","OC1","OC2","OC3","OC4","OC5","OC6","OC7","OC8","OCL","OCM","OCN","OCO","OF1","OF2","OF3","OH","OS","OS4","OXL","PB","PBM","PD","PDV","PER","PI","PO3","PO4","PR","PT","PT4","PTN","RB","RH3","RHD","RU","SB","SCN","SE4","SEK","SM","SMO","SO3","SO4","SR","T1A","TB","TBA","TCN","TEA","TH","THE","TL","TMA","TRA","UNX","V","VN3","VO4","W","WO5","Y1","YB","YB2","YH","YT3","ZCM","ZN","ZN2","ZN3","ZNO","ZO3","OHX"],Mm=["045","0AT","0BD","0MK","0NZ","0TS","0V4","0XY","0YT","10M","147","149","14T","15L","16G","18T","18Y","1AR","1BW","1GL","1GN","1JB","1LL","1NA","1S3","26M","26Q","26R","26V","26W","26Y","27C","289","291","293","2DG","2F8","2FG","2FL","2FP","2GL","2M4","2M5","32O","34V","3CM","3DO","3DY","3FM","3LR","3MF","3MG","3SA","3ZW","46D","46M","46Z","48Z","4CQ","4GC","4NN","50A","5DI","5GF","5MM","5RP","5SA","5SP","64K","6PG","6SA","7JZ","7SA","A1Q","A2G","AAB","AAL","AAO","ABC","ABD","ABE","ABF","ABL","ACG","ACI","ACR","ACX","ADA","ADG","ADR","AF1","AFD","AFL","AFO","AFP","AFR","AGC","AGH","AGL","AHR","AIG","ALL","ALX","AMU","AOG","AOS","ARA","ARB","ARE","ARI","ASG","ASO","AXP","AXR","B0D","B16","B2G","B4G","B6D","B8D","B9D","BBK","BCD","BDG","BDP","BDR","BEM","BFP","BGC","BGL","BGP","BGS","BHG","BMA","BMX","BNG","BNX","BOG","BRI","BXF","BXP","BXX","BXY","C3X","C4X","C5X","CAP","CBI","CBK","CBS","CDR","CEG","CGF","CHO","CR1","CR6","CRA","CT3","CTO","CTR","CTT","D6G","DAF","DAG","DDA","DDB","DDL","DEL","DFR","DFX","DG0","DGC","DGD","DGM","DGS","DIG","DLF","DLG","DMU","DNO","DOM","DP5","DQQ","DQR","DR2","DR3","DR4","DRI","DSR","DT6","DVC","E4P","E5G","EAG","EBG","EBQ","EGA","EJT","EPG","ERE","ERI","F1P","F1X","F6P","FBP","FCA","FCB","FCT","FDP","FDQ","FFC","FIX","FMO","FRU","FSI","FU4","FUB","FUC","FUD","FUL","FXP","G16","G1P","G2F","G3I","G4D","G4S","G6D","G6P","G6S","GAC","GAD","GAL","GC1","GC4","GCD","GCN","GCO","GCS","GCT","GCU","GCV","GCW","GCX","GE1","GFG","GFP","GIV","GL0","GL2","GL5","GL6","GL7","GL9","GLA","GLB","GLC","GLD","GLF","GLG","GLO","GLP","GLS","GLT","GLW","GMH","GN1","GNX","GP1","GP4","GPH","GPM","GQ1","GQ2","GQ4","GS1","GS4","GSA","GSD","GTE","GTH","GTK","GTR","GTZ","GU0","GU1","GU2","GU3","GU4","GU5","GU6","GU8","GU9","GUF","GUP","GUZ","GYP","GYV","H2P","HDL","HMS","HS2","HSD","HSG","HSH","HSJ","HSQ","HSR","HSU","HSX","HSY","HSZ","IAB","IDG","IDR","IDS","IDT","IDU","IDX","IDY","IMK","IN1","IPT","ISL","KBG","KD2","KDA","KDM","KDO","KFN","KO1","KO2","KTU","L6S","LAG","LAI","LAK","LAO","LAT","LB2","LBT","LCN","LDY","LGC","LGU","LM2","LMT","LMU","LOG","LOX","LPK","LSM","LTM","LVZ","LXB","LXZ","M1F","M3M","M6P","M8C","MA1","MA2","MA3","MAB","MAG","MAL","MAN","MAT","MAV","MAW","MBG","MCU","MDA","MDM","MDP","MFA","MFB","MFU","MG5","MGA","MGL","MLB","MMA","MMN","MN0","MRP","MTT","MUG","MVP","MXY","N1L","N9S","NAA","NAG","NBG","NDG","NED","NG1","NG6","NGA","NGB","NGC","NGE","NGF","NGL","NGS","NGY","NHF","NM6","NM9","NTF","NTO","NTP","NXD","NYT","OPG","OPM","ORP","OX2","P3M","P53","P6P","PA5","PNA","PNG","PNW","PRP","PSJ","PSV","PTQ","QDK","QPS","QV4","R1P","R1X","R2B","R5P","RAA","RAE","RAF","RAM","RAO","RAT","RB5","RBL","RCD","RDP","REL","RER","RF5","RG1","RGG","RHA","RIB","RIP","RNS","RNT","ROB","ROR","RPA","RST","RUB","RUU","RZM","S6P","S7P","SA0","SCR","SDD","SF6","SF9","SG4","SG5","SG6","SG7","SGA","SGC","SGD","SGN","SGS","SHB","SHG","SI3","SIO","SOE","SOL","SSG","SUC","SUP","SUS","T6P","T6T","TAG","TCB","TDG","TGK","TGY","TH1","TIA","TM5","TM6","TM9","TMR","TMX","TOA","TOC","TRE","TYV","UCD","UDC","VG1","X0X","X1X","X2F","X4S","X5S","X6X","XBP","XDN","XDP","XIF","XIM","XLF","XLS","XMM","XUL","XXR","XYP","XYS","YO5","Z3Q","Z6J","Z9M","ZDC","ZDM"],Cm=["CA","C","N","O","O1","O2","OC1","OC2","OX1","OXT","OT1","OT2","H","H1","H2","H3","HA","HN","BB"],Tm=["P","OP1","OP2","HOP2","HOP3","O2'","O3'","O4'","O5'","C1'","C2'","C3'","C4'","C5'","H1'","H2'","H2''","HO2'","H3'","H4'","H5'","H5''","HO3'","HO5'","O2*","O3*","O4*","O5*","C1*","C2*","C3*","C4*","C5*"],Em={1:{trace:"CA",direction1:"C",direction2:["O","OC1","O1","OX1","OXT","OT1","OT2"],backboneStart:"N",backboneEnd:"C"},2:{trace:["C4'","C4*"],direction1:["C1'","C1*"],direction2:["C3'","C3*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},3:{trace:["C3'","C3*"],direction1:["C2'","C2*"],direction2:["O4'","O4*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},4:{trace:["CA","BB"],backboneStart:["CA","BB"],backboneEnd:["CA","BB"]},5:{trace:["C4'","C4*","P"],backboneStart:["C4'","C4*","P"],backboneEnd:["C4'","C4*","P"]},6:{trace:["C3'","C3*","C2'","P"],backboneStart:["C3'","C3*","C2'","P"],backboneEnd:["C3'","C3*","C2'","P"]}},Pm=(Em[tm]={},{HD:"H",HS:"H",A:"C",NA:"N",NS:"N",OA:"O",OS:"O",SA:"S",G0:"C",G1:"C",G2:"C",G3:"C",CG0:"C",CG1:"C",CG2:"C",CG3:"C",W:"O"});function Im(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;default:return 8}}let Rm=new Map([[2,3.141],[3,2.094],[4,1.910288145],[6,1.5705]]);function Dm(t,e){let r=[],i=new et,n=new et;return i.subVectors(e,t),t.eachBondedAtom(e=>{1!==e.number&&(n.subVectors(e,t),r.push(i.angleTo(n)))}),r}function Lm(t,e){let r=t.clone();var i=new et;i.subVectors(e,t);let n=[new et,new et],a=0;if(t.eachBondedAtom(e=>{1<a||1!==e.number&&(r.index=e.index,n[a++].subVectors(e,t))}),1===a&&r.eachBondedAtom(e=>{1<a||1!==e.number&&e.index!==t.index&&n[a++].subVectors(e,t)}),2===a)return e=n[0].cross(n[1]),Math.abs(Math.PI/2-e.angleTo(i))}function Om(i,e){var t=i.bondToElementCount(1);let n=i.formalCharge||0;var r="always"===e.assignCharge||"auto"===e.assignCharge&&0===n,a="always"===e.assignH||"auto"===e.assignH&&0===t,s=i.bondCount,o=(e=>{let t=0;return e.eachBond(e=>t+=e.bondOrder),t})(i),l=(t=>{let i=t.structure.getBondProxy();var e=t.number;let r=8===e||7===e;if(r&&4===t.bondCount)return!1;let n=!1;return t.eachBond(e=>{if(1<e.bondOrder)n=!0;else if(r){let r=e.getOtherAtom(t);r.eachBond(e=>{var t;1<e.bondOrder&&(15!==(t=r.number)&&16!==t||8!==e.getOtherAtom(r).number)&&(n=!0)},i)}}),n})(i),h=0<o-s;let c=0,u=8;switch(i.number){case 1:r&&(0===s?(n=1,u=0):1===s&&(n=0,u=1));break;case 6:r&&(n=0),a&&(c=Math.max(0,4-o-Math.abs(n))),u=Im(s+c+Math.max(0,-n));break;case 7:if(r)if(a)if(l&&o<4)n=s-t==1&&o-t==2?1:0;else{let t=!1;i.eachBondedAtom(e=>{16!==e.number&&!e.isMetal()||(t=!0)}),n=t?0:1}else n=o-3;a&&(c=Math.max(0,3-o+n)),u=Im(l&&!h?s+c-n:s+c+1-n);break;case 8:r&&(a||(n=o-2),1===o)&&i.eachBondedAtom(r=>{r.eachBond(e=>{var t=e.getOtherAtom(r);t.index!==i.index&&8===t.number&&2===e.bondOrder&&(n=-1)})}),a&&(c=Math.max(0,2-o+n)),u=Im(l&&!h?s+c-n+1:s+c-n+2);break;case 16:!r||a||(n=o<=3&&!i.bondToElementCount(8)?o-2:0),a&&o<2&&(c=Math.max(0,2-o+n)),o<=3&&(u=Im(s+c-n+2));break;case 9:case 17:case 35:case 53:case 85:r&&(n=o-1);break;case 3:case 11:case 19:case 37:case 55:case 87:r&&(n=1-o);break;case 4:case 12:case 20:case 38:case 56:case 88:r&&(n=2-o);break;default:console.warn("Requested charge, protonation for an unhandled element",i.element)}return[n,c,c+t,u]}function km(e){var t;return e["@valenceModel"]||(t=((e,a)=>{var t=(e=e.structure).atomCount;let s=new Int8Array(t),o=new Int8Array(t),l=new Int8Array(t),h=new Int8Array(t);return e.eachAtom(e=>{var t=e.index,[e,r,i,n]=Om(e,a);s[t]=e,o[t]=r,l[t]=i,h[t]=n}),{charge:s,implicitH:o,totalH:l,idealGeometry:h}})(e,{assignCharge:"auto",assignH:"auto"}),e["@valenceModel"]=t)}function Nm(e){return 15===e.number&&e.bondToElementCount(8)===e.bondCount}let Fm=["ARG","HIS","LYS"],Bm=["GLU","ASP"];function Um(e,i){let r=km(e.data).charge,n={};e.eachResidue(e=>{if(Fm.includes(e.resname)){let t=Qd(1);e.eachAtom(e=>{7===e.number&&e.isSidechain()&&Jd(t,e)}),em(i,t)}else _m.includes(e.resname)||e.isNucleic()||(e.eachAtom(e=>{let t=!1,r=Qd(1);(e=>{let t=0;return 6===e.number&&3===e.bondCount&&3===e.bondToElementCount(7)&&e.eachBondedAtom(e=>{e.bondCount-e.bondToElementCount(1)==1&&++t}),2===t})(e)?(r.group=8,t=!0):(e=>{let t=0;return 6===e.number&&3===e.bondCount&&2===e.bondToElementCount(7)&&1===e.bondToElementCount(6)&&e.eachBondedAtom(e=>{e.bondCount-e.bondToElementCount(1)==1&&++t}),2===t})(e)&&(r.group=9,t=!0),t&&(e.eachBondedAtom(e=>{7===e.number&&(n[e.index]=!0,Jd(r,e))}),em(i,r))}),e.eachAtom(e=>{var t=Qd(1);0<r[e.index]&&(n[e.index]||(Jd(t,e),em(i,t)))}))})}function zm(e,n){let r=km(e.data).charge,a={};e.eachResidue(e=>{if(Bm.includes(e.resname)){let t=Qd(2);e.eachAtom(e=>{8===e.number&&e.isSidechain()&&Jd(t,e)}),em(n,t)}else if(Sm.includes(e.resname)){let t=Qd(2);e.eachAtom(e=>{Nm(e)&&(t.group=6,e.eachBondedAtom(e=>{8===e.number&&Jd(t,e)}),em(n,t))})}else _m.includes(e.resname)||Sm.includes(e.resname)||(e.eachAtom(e=>{let t=!1,r=Qd(2);var i;16===(i=e).number&&3===i.bondToElementCount(8)?(r.group=4,t=!0):Nm(e)?(r.group=6,t=!0):16===(i=e).number&&4===i.bondToElementCount(8)?(r.group=5,t=!0):(e=>{let t=0;return 6===e.number&&2===e.bondToElementCount(8)&&1===e.bondToElementCount(6)&&e.eachBondedAtom(e=>{8===e.number&&e.bondCount-e.bondToElementCount(1)==1&&++t}),2===t})(e)&&(r.group=10,t=!0),t&&(e.eachBondedAtom(e=>{8===e.number&&(a[e.index]=!0,Jd(r,e))}),em(n,r))}),e.eachAtom(e=>{var t=Qd(2);r[e.index]<0&&(a[e.index]||(Jd(t,e),em(n,t)))}))})}function Vm(e,t,r={}){let o=ce(r.maxIonicDist,np.maxIonicDist);var i=ce(r.maxPiStackingDist,np.maxPiStackingDist);let l=ce(r.maxPiStackingOffset,np.maxPiStackingOffset),h=ce(r.maxPiStackingAngle,np.maxPiStackingAngle);var n=ce(r.maxCationPiDist,np.maxCationPiDist);let c=ce(r.maxCationPiOffset,np.maxCationPiOffset),u=ce(r.masterModelIndex,np.masterModelIndex);var a=Math.max(o+2,i,n);let d=i*i,m=n*n,{features:s,spatialHash:p,contactStore:f,featureSet:N}=t,{types:g,centers:F,atomSets:v}=s,{x:_,y,z:b}=F;var B=g.length;function x(e,t){P.set(A[e[0]],M[e[0]],C[e[0]]),I.set(A[e[1]],M[e[1]],C[e[1]]),R.set(A[e[2]],M[e[2]],C[e[2]]),D.subVectors(P,I),L.subVectors(P,R),t.crossVectors(D,L)}function S(e,t,r){return P.set(_[e],y[e],b[e]),I.set(_[t],y[t],b[t]),P.sub(I).projectOnPlane(r).add(I).distanceTo(I)}function w(e,t,r){N.setBits(e,t),f.addContact(e,t,r)}let A=e.atomStore.x,M=e.atomStore.y,C=e.atomStore.z,T=e.getAtomProxy(),E=e.getAtomProxy(),P=new et,I=new et,R=new et,D=new et,L=new et,O=new et,k=new et;for(let s=0;s<B;++s)p.eachWithin(_[s],y[s],b[s],a,(e,t)=>{var r,i,n,a;e<=s||(T.index=v[s][0],E.index=v[e][0],sp(T,E,u))||(r=g[s],i=g[e],a=i,2===(n=r)&&1===a||1===n&&2===a?((t,r,i)=>{var n=t.length,a=r.length;for(let e=0;e<n;++e){T.index=t[e];for(let e=0;e<a;++e)if(E.index=r[e],T.distanceTo(E)<=i)return!0}return!1})(v[s],v[e],o)&&w(s,e,1):3===r&&3===i?t<=d&&(x(v[s],O),x(v[e],k),n=57.29578*O.angleTo(k),Math.min(S(s,e,k),S(e,s,O))<=l)&&(n<=h||n>=180-h||n<=h+90&&n>=90-h)&&w(s,e,3):(a=i,(3===(n=r)&&1===a||1===n&&3===a)&&t<=m&&([i,n]=3===r?[s,e]:[e,s],x(v[i],O),S(n,i,O)<=c)&&w(i,n,2)))})}function Gm(e,r){let i=km(e.data).totalH;e.eachAtom(e=>{var t;6===e.number&&0<i[e.index]&&(0<e.bondToElementCount(7)||0<e.bondToElementCount(8)||(r=>{if(r.isAromatic()){var i=r.residueType.getRings();if(i){let t=!1,e=i.rings;return e.forEach(e=>{t||e.some(e=>r.index-r.residueAtomOffset===e)&&(t=e.some(e=>{e=r.residueType.atomTypeIdList[e],e=r.atomMap.get(e).number;return 7===e||8===e}))}),t}}})(e))&&(Jd(t=Qd(9),e),em(r,t))})}function Hm(e){return"HIS"===e.resname&&7==e.number&&e.isRing()}function $m(e,t,r={}){var i=ce(r.maxHbondDist,np.maxHbondDist),n=ce(r.maxHbondSulfurDist,np.maxHbondSulfurDist);let o=sh(ce(r.maxHbondAccAngle,np.maxHbondAccAngle)),l=sh(ce(r.maxHbondDonAngle,np.maxHbondDonAngle)),h=sh(ce(r.maxHbondAccPlaneAngle,np.maxHbondAccPlaneAngle)),c=sh(ce(r.maxHbondDonPlaneAngle,np.maxHbondDonPlaneAngle)),u=ce(r.masterModelIndex,np.masterModelIndex);var a=Math.max(i,n);let d=i*i,{features:s,spatialHash:m,contactStore:p,featureSet:f}=t,{types:g,centers:v,atomSets:_}=s;var{x:y,y:b,z:x}=v,S=g.length;let w=km(e.data).idealGeometry,A=e.getAtomProxy(),M=e.getAtomProxy();for(let t=0;t<S;++t)m.eachWithin(y[t],b[t],x[t],a,(e,r)=>{if(!(e<=t)){var i=g[t],n=g[e],a=(s=n,9===(a=i)&&5===s||5===a&&9===s);if(a||(s=n,5===(i=i)&&4===s)||4===i&&5===s){var[i,s]=5===n?[t,e]:[e,t];if(A.index=_[i][0],M.index=_[s][0],M.index!==A.index&&!sp(A,M,u)&&!(16!==A.number&&16!==M.number&&r>d||A.connectedTo(M))){n=Dm(A,M);let t=Rm.get(w[A.index])||2.094;if(!n.some(e=>Math.abs(t-e)>l)){if(3===w[A.index]){e=Lm(A,M);if(void 0!==e&&e>c)return}r=Dm(M,A);let t=Rm.get(w[M.index])||2.094;if(!r.some(e=>t-e>o)){if(3===w[M.index]){n=Lm(M,A);if(void 0!==n&&n>h)return}f.setBits(i,s);a=a?8:(e=A,r=M,n=r,e.isWater()&&n.isWater()?9:(n=r,e.isBackbone()&&n.isBackbone()?10:4));p.addContact(i,s,a)}}}}}})}let jm=[3,11,19,37,55,12,20,38,56,13,31,49,81,21,50,82,83,51,80];function Wm(e,t,r={}){var i=ce(r.maxHydrophobicDist,np.maxHydrophobicDist);let a=ce(r.masterModelIndex,np.masterModelIndex),{features:n,spatialHash:s,contactStore:o,featureSet:l}=t,{types:h,centers:c,atomSets:u}=n;var{x:d,y:m,z:p}=c,f=h.length;let g=e.getAtomProxy(),v=e.getAtomProxy();for(let n=0;n<f;++n)s.eachWithin(d[n],m[n],p[n],i,(e,t)=>{var r,i;e<=n||(g.index=u[n][0],v.index=u[e][0],sp(g,v,a))||9===g.number&&9===v.number||g.connectedTo(v)||(r=h[n],i=h[e],8===r&&8===i&&(l.setBits(n,e),o.addContact(n,e,6)))})}let qm=[17,35,53,85];let Xm=[7,8,16],Ym=[6,7,15,16];let Km=3.141,Zm=2.094;function Qm(e,t,r={}){var i=ce(r.maxHalogenBondDist,np.maxHalogenBondDist);let s=sh(ce(r.maxHalogenBondAngle,np.maxHalogenBondAngle)),o=ce(r.masterModelIndex,np.masterModelIndex),{features:n,spatialHash:l,contactStore:h,featureSet:c}=t,{types:u,centers:a,atomSets:d}=n;var{x:m,y:p,z:f}=a,g=u.length;let v=e.getAtomProxy(),_=e.getAtomProxy();for(let a=0;a<g;++a)l.eachWithin(m[a],p[a],f[a],i,(e,t)=>{var r,i,n;e<=a||(v.index=d[a][0],_.index=d[e][0],!sp(v,_,o)&&(r=u[a],i=u[e],7===r&&6===i||6===r&&7===i)&&([r,i]=6===u[a]?[v,_]:[_,v],1!==(n=Dm(r,i)).length||Km-n[0]>s||0===(n=Dm(i,r)).length||n.some(e=>Zm-e>s)||(c.setBits(a,e),h.addContact(a,e,5))))})}function Jm(e,t,r){return!ap(e,t,r)&&(e.modelIndex!==t.modelIndex||e.altloc&&t.altloc&&e.altloc!==t.altloc)}function ep(e,t){function r(e,t,r){var[i,n]=d[r]||[1/0,-1];e<i?(-1!==n&&a.clear(n),d[r]=[e,t]):a.clear(t)}let{contactSet:a,contactStore:i,features:n}=t,{type:s,index1:o,index2:l}=i,h=n.atomSets,c=e.getAtomProxy(),u=e.getAtomProxy(),d={};a.forEach(e=>{var t;6===s[e]&&(c.index=h[o[e]][0],u.index=h[l[e]][0],t=c.distanceTo(u),r(t,e,c.index+"|"+u.residueIndex),r(t,e,u.index+"|"+c.residueIndex))})}function tp(e,t){function r(e,t){c[e]||(c[e]=[]),c[e].push(t)}let{contactSet:a,contactStore:i,features:n}=t,{type:s,index1:o,index2:l}=i,h=n.atomSets,c={};a.forEach(t=>{1===s[t]&&(h[o[t]].forEach(e=>r(e,t)),h[l[t]].forEach(e=>r(e,t)))}),a.forEach(t=>{if(4===(e=s[t])||9===e||10===e){var e,r=c[h[o[t]][0]],i=c[h[l[t]][0]];if(r&&i){var n=r.length;for(let e=0;e<n;++e)if(i.includes(r[e]))return void a.clear(t)}}})}function rp(e,t){function r(e,t){c[e]||(c[e]=[]),c[e].push(t)}let{contactSet:a,contactStore:i,features:n}=t,{type:s,index1:o,index2:l}=i,h=n.atomSets,c={};a.forEach(t=>{3===s[t]&&(h[o[t]].forEach(e=>r(e,t)),h[l[t]].forEach(e=>r(e,t)))}),a.forEach(t=>{if(6===s[t]||2===s[t]){var r=c[h[o[t]][0]],i=c[h[l[t]][0]];if(r&&i){var n=r.length;for(let e=0;e<n;++e)if(i.includes(r[e]))return void a.clear(t)}}})}function ip(e,t){function r(e,t){c[e]||(c[e]=[]),c[e].push(t)}let{contactSet:n,contactStore:i,features:a}=t,{type:s,index1:o,index2:l}=i,h=a.atomSets,c={};n.forEach(t=>{1===s[t]&&(h[o[t]].forEach(e=>r(e,t)),h[l[t]].forEach(e=>r(e,t)))}),n.forEach(e=>{if(7===s[e]){var t=c[h[o[e]][0]],r=c[h[l[e]][0]];if(t&&r){var i=t.length;for(let e=0;e<i;++e)if(r.includes(t[e]))return void n.clear(t[e])}}})}let np={maxHydrophobicDist:4,maxHbondDist:3.5,maxHbondSulfurDist:4.1,maxHbondAccAngle:45,maxHbondDonAngle:45,maxHbondAccPlaneAngle:90,maxHbondDonPlaneAngle:30,maxPiStackingDist:5.5,maxPiStackingOffset:2,maxPiStackingAngle:30,maxCationPiDist:6,maxCationPiOffset:2,maxIonicDist:5,maxHalogenBondDist:4,maxHalogenBondAngle:30,maxMetalDist:3,refineSaltBridges:!0,masterModelIndex:-1,lineOfSightDistFactor:1};function ap(e,t,r){return e.modelIndex===r&&t.modelIndex!==r||t.modelIndex===r&&e.modelIndex!==r}function sp(e,t,r){return!ap(e,t,r)&&(e.modelIndex!==t.modelIndex||e.residueIndex===t.residueIndex||e.altloc&&t.altloc&&e.altloc!==t.altloc)}function op(e){var a,r,i,n,s,t={types:[],groups:[],centers:{x:[],y:[],z:[]},atomSets:[]};Je.Debug&&rt.time("calculateFeatures"),Um(e,t),zm(e,t);{var l=e,o=t;let i=l.getAtomProxy();l.eachResidue(e=>{var t=e.getAromaticRings();if(t){let r=e.atomOffset;t.forEach(e=>{let t=Qd(3);e.forEach(e=>{i.index=e+r,Jd(t,i)}),em(o,t)})}})}{var h=t;let{charge:a,implicitH:s,idealGeometry:o}=km((l=e).data);l.eachAtom(e=>{var t,r,i=Qd(5),n=e.number;8===n?(Jd(i,e),em(h,i)):7===n?(Hm(e)||a[e.index]<1&&(t=e.bondCount+s[e.index],4===(r=o[e.index])&&t<4||3===r&&t<3||2===r&&t<2))&&(Jd(i,e),em(h,i)):16!==n||"CYS"!==e.resname&&"MET"!==e.resname&&-1!==e.formalCharge||(Jd(i,e),em(h,i))})}{var c=t;let i=km((l=e).data).totalH;l.eachAtom(e=>{var t=Qd(4),r=e.number;(Hm(e)||0<i[e.index]&&(7===r||8===r||16===r))&&(Jd(t,e),em(c,t))})}return Gm(e,t),a=t,e.eachAtom(e=>{let t=!1,r=!1;var i=_m.includes(e.resname),n=Sm.includes(e.resname);i||n?i?8===e.number?(["ASP","GLU","SER","THR","TYR","ASN","GLN"].includes(e.resname)&&e.isSidechain()||e.isBackbone())&&(t=!0,r=!0):16===e.number&&"CYS"===e.resname?(t=!0,r=!0):7===e.number&&"HIS"===e.resname&&e.isSidechain()&&(t=!0):n&&(8===e.number&&e.isBackbone()?(t=!0,r=!0):["N3","N4","N7"].includes(e.atomname)?t=!0:["O2","O4","O6"].includes(e.atomname)&&(t=!0,r=!0)):e.isHalogen()||8===e.number||16===e.number?(t=!0,r=!0):7===e.number&&(t=!0),t&&(Jd(i=Qd(11),e),em(a,i)),r&&(Jd(n=Qd(10),e),em(a,n))}),r=t,e.eachAtom(e=>{var t;e.isTransitionMetal()||30===e.number||48===e.number?(Jd(t=Qd(12),e),em(r,t)):jm.includes(e.number)&&(Jd(t=Qd(13),e),em(r,t))}),i=t,e.eachAtom(e=>{var t=Qd(8);let r=!1;6===e.number?(r=!0,e.eachBondedAtom(e=>{e=e.number;6!==e&&1!==e&&(r=!1)})):9===e.number&&(r=!0),r&&(Jd(t,e),em(i,t))}),n=t,e.eachAtom(e=>{if(Xm.includes(e.number)){let t=!1;var r;e.eachBondedAtom(e=>{Ym.includes(e.number)&&(t=!0)}),t&&(Jd(r=Qd(7),e),em(n,r))}}),s=t,e.eachAtom(e=>{var t;qm.includes(e.number)&&1===e.bondToElementCount(6)&&(Jd(t=Qd(6),e),em(s,t))}),Je.Debug&&rt.timeEnd("calculateFeatures"),t}function lp(i,n=np){var S=(e=>{var{types:t,centers:r}=e;return{features:e,spatialHash:new Wd(r),contactStore:new Xd,featureSet:new Kd(t.length,!1)}})(op(i));Je.Debug&&rt.time("calculateContacts"),Vm(i,S,n),$m(i,S,n);{var[w,A,M={}]=[i,S,n],d=ce(M.maxMetalDist,np.maxMetalDist);let a=ce(M.masterModelIndex,np.masterModelIndex),{features:e,spatialHash:t,contactStore:s,featureSet:o}=A,{types:l,centers:r,atomSets:h}=e;var{x:m,y:p,z:f}=r,g=l.length;let c=w.getAtomProxy(),u=w.getAtomProxy();for(let n=0;n<g;++n)t.eachWithin(m[n],p[n],f[n],d,(e,t)=>{var r,i;e<=n||(c.index=h[n][0],u.index=h[e][0],sp(c,u,a))||(i=c.isMetal(),r=u.isMetal(),(i||r)&&([r,i]=i?[l[n],l[e]]:[l[e],l[n]],i=i,12===(r=r)?11===i||12===i:13===r&&10===i)&&(o.setBits(n,e),s.addContact(n,e,7)))})}Wm(i,S,n),Qm(i,S,n);M=(e=>{var{index1:t,index2:r,count:i}=e.contactStore,t=Zd({nodeArray1:t,nodeArray2:r,edgeCount:i,nodeCount:e.featureSet.length}),r=new Kd(e.contactStore.count,!0);return Object.assign({adjacencyList:t,contactSet:r},e)})(S);{var[A,w,S={}]=[i,M,n],a=(Je.Debug&&rt.time("refineLineOfSight"),ce(S.lineOfSightDistFactor,np.lineOfSightDistFactor));let s=ce(S.masterModelIndex,np.masterModelIndex),o=A.spatialHash,{contactSet:l,contactStore:e,features:t}=w,{index1:h,index2:c}=e,{centers:r,atomSets:u}=t,{x:d,y:m,z:p}=r,f=A.getAtomProxy(),g=A.getAtomProxy(),v=A.getAtomProxy(),_=new et,y=new et,b=3*a,x=a*a;l.forEach(r=>{_.set(d[h[r]],m[h[r]],p[h[r]]),y.set(d[c[r]],m[c[r]],p[c[r]]);var e=(_.x+y.x)/2,t=(_.y+y.y)/2,i=(_.z+y.z)/2;let n=u[h[r]],a=u[c[r]];f.index=n[0],g.index=a[0],o.eachWithin(e,t,i,b,(e,t)=>{v.index=e,1!==v.number&&v.vdw*v.vdw*x>t&&!Jm(f,v,s)&&!Jm(g,v,s)&&!n.includes(e)&&!a.includes(e)&&1<_.distanceToSquared(v)&&1<y.distanceToSquared(v)&&(l.clear(r),Je.Debug)&&rt.log("removing",f.qualifiedName(),g.qualifiedName(),"because",v.qualifiedName())})}),Je.Debug&&rt.timeEnd("refineLineOfSight")}return ep(i,M),n.refineSaltBridges&&tp(0,M),rp(0,M),ip(0,M),Je.Debug&&rt.timeEnd("calculateContacts"),M}let hp={hydrogenBond:!0,hydrophobic:!0,halogenBond:!0,ionicInteraction:!0,metalCoordination:!0,cationPi:!0,piStacking:!0,weakHydrogenBond:!0,waterHydrogenBond:!0,backboneHydrogenBond:!0,radius:1,filterSele:""},cp=new ze;function up(e,t,r){let n=Vl(r,hp),a=[];n.hydrogenBond&&a.push(4),n.hydrophobic&&a.push(6),n.halogenBond&&a.push(5),n.ionicInteraction&&a.push(1),n.metalCoordination&&a.push(7),n.cationPi&&a.push(2),n.piStacking&&a.push(3),n.weakHydrogenBond&&a.push(8),n.waterHydrogenBond&&a.push(9),n.backboneHydrogenBond&&a.push(10);var{features:r,contactSet:i,contactStore:s}=e;let{centers:o,atomSets:l}=r,{x:h,y:c,z:u}=o,{index1:d,index2:m,type:p}=s,f=[],g=[],v=[],_=[],y=[],b;return n.filterSele&&(b=Array.isArray(n.filterSele)?n.filterSele.map(e=>t.getAtomSet(new qh(e))):t.getAtomSet(new qh(n.filterSele))),i.forEach(e=>{var t=p[e];if(a.includes(t)){if(b){var r=l[d[e]][0],i=l[m[e]][0];if(Array.isArray(b)){if(!(b[0].isSet(r)&&b[1].isSet(i)||b[1].isSet(r)&&b[0].isSet(i)))return}else if(!b.isSet(r)&&!b.isSet(i))return}r=d[e],i=m[e];f.push(h[r],c[r],u[r]),g.push(h[i],c[i],u[i]),v.push(...(e=>{switch(e){case 4:case 9:case 10:return cp.setHex(2851770).toArray();case 6:return cp.setHex(8421504).toArray();case 5:return cp.setHex(4259775).toArray();case 1:return cp.setHex(15779860).toArray();case 7:return cp.setHex(9191577).toArray();case 2:return cp.setHex(16744448).toArray();case 3:return cp.setHex(9220966).toArray();case 8:return cp.setHex(12967404).toArray();default:return cp.setHex(13421772).toArray()}})(t)),_.push(n.radius),y.push(e)}}),{position1:new Float32Array(f),position2:new Float32Array(g),color:new Float32Array(v),color2:new Float32Array(v),radius:new Float32Array(_),picking:new yp(y,e,t)}}class dp{constructor(e){this.array=e}get type(){return""}get data(){return{}}getIndex(e){return this.array?this.array[e]:e}getObject(e){return{}}_applyTransformations(e,t,r){return t&&e.applyMatrix4(t.matrix),r&&e.applyMatrix4(r.matrix),e}_getPosition(e){return new et}getPosition(e,t,r){return this._applyTransformations(this._getPosition(e),t,r)}}class mp extends dp{constructor(e){super(),this.shape=e}get primitive(){}get data(){return this.shape}get type(){return this.primitive.type}getObject(e){return this.primitive.objectFromShape(this.shape,this.getIndex(e))}_getPosition(e){return this.primitive.positionFromShape(this.shape,this.getIndex(e))}}class pp extends mp{get primitive(){return Bd}}class fp extends mp{get primitive(){return Ud}}class gp extends dp{constructor(e,t){super(e),this.structure=t}get type(){return"atom"}get data(){return this.structure}getObject(e){return this.structure.getAtomProxy(this.getIndex(e))}_getPosition(e){return(new et).copy(this.getObject(e))}}class vp extends dp{constructor(e){super(),this.axes=e}get type(){return"axes"}get data(){return this.axes}getObject(){return{axes:this.axes}}_getPosition(){return this.axes.center.clone()}}class _p extends dp{constructor(e,t,r){super(e),this.structure=t,this.bondStore=r||t.bondStore}get type(){return"bond"}get data(){return this.structure}getObject(e){e=this.structure.getBondProxy(this.getIndex(e));return e.bondStore=this.bondStore,e}_getPosition(e){e=this.getObject(e);return(new et).copy(e.atom1).add(e.atom2).multiplyScalar(.5)}}class yp extends dp{constructor(e,t,r){super(e),this.contacts=t,this.structure=r}get type(){return"contact"}get data(){return this.contacts}getObject(e){var e=this.getIndex(e),{features:t,contactStore:r}=this.contacts,{centers:t,atomSets:i}=t,{x:t,y:n,z:a}=t,{index1:r,index2:s,type:o}=r,r=r[e],s=s[e];return{center1:new et(t[r],n[r],a[r]),center2:new et(t[s],n[s],a[s]),atom1:this.structure.getAtomProxy(i[r][0]),atom2:this.structure.getAtomProxy(i[s][0]),type:(e=>{switch(e){case 4:case 9:case 10:return"hydrogen bond";case 6:return"hydrophobic contact";case 5:return"halogen bond";case 1:return"ionic interaction";case 7:return"metal coordination";case 2:return"cation-pi interaction";case 3:return"pi-pi stacking";case 8:return"weak hydrogen bond";default:return"unknown contact"}})(o[e])}}_getPosition(e){var{center1:e,center2:t}=this.getObject(e);return(new et).addVectors(e,t).multiplyScalar(.5)}}class bp extends mp{get primitive(){return zd}}class xp extends dp{constructor(e,t,r){super(e),this.validation=t,this.structure=r}get type(){return"clash"}get data(){return this.validation}getObject(e){var t=this.validation,e=this.getIndex(e);return{validation:t,index:e,clash:t.clashArray[e]}}_getAtomProxyFromSele(e){e=new qh(e),e=this.structure.getAtomIndices(e)[0];return this.structure.getAtomProxy(e)}_getPosition(e){var e=this.getObject(e).clash,t=this._getAtomProxyFromSele(e.sele1),e=this._getAtomProxyFromSele(e.sele2);return(new et).copy(t).add(e).multiplyScalar(.5)}}class Sp extends _p{get type(){return"distance"}}class wp extends mp{get primitive(){return Vd}}class Ap extends mp{get primitive(){return Nd}}class Mp extends mp{get primitive(){return kd}}class Cp extends dp{get type(){return"ignore"}}class Tp extends mp{constructor(e,t){super(e),this.mesh=t}get type(){return"mesh"}getObject(){var e=this.mesh;return{shape:this.shape,name:e.name,serial:e.serial}}_getPosition(){return this.__position||(this.__position=hd(this.mesh.position)),this.__position}}class Ep extends mp{get primitive(){return Od}}class Pp extends dp{constructor(e,t){super(e),this.surface=t}get type(){return"surface"}get data(){return this.surface}getObject(e){return{surface:this.surface,index:this.getIndex(e)}}_getPosition(){return this.surface.center.clone()}}class Ip extends mp{get primitive(){return Fd}}class Rp extends mp{get primitive(){return Gd}}class Dp extends dp{constructor(e,t){super(),this.unitcell=e,this.structure=t}get type(){return"unitcell"}get data(){return this.unitcell}getObject(){return{unitcell:this.unitcell,structure:this.structure}}_getPosition(){return this.unitcell.getCenter(this.structure)}}class Lp extends dp{constructor(e,t){super(e),this.volume=t}get type(){return"volume"}get data(){return this.volume}getObject(e){var t=this.volume,e=this.getIndex(e);return{volume:t,index:e,value:t.data[e]}}_getPosition(e){var t=this.volume.position,e=this.getIndex(e);return new et(t[3*e],t[3*e+1],t[3*e+2])}}class Op extends Lp{get type(){return"slice"}}class kp extends mp{get primitive(){return $d}}class Np extends mp{get primitive(){return jd}}function Fp(){return new Uint32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0])}function Bp(){return new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1])}function Up(ie,ne,ae,se,h){var c,oe,u,le,a,s,o,he=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]],ce=0,ue=!1,de=!1,me=!1,pe=!1,d=-1,l=ne*ae*se,fe=ne,ge=ne*ae,ve=new Int32Array(12),m=[],p=[],_e=[],f=[],ye=Fp(),be=Bp();function g(e,t,r){return e+(t-e)*r}function xe(e,t,r){return ge*(r=(r+o)%se)+fe*(t=(t+s)%ae)+(e=(e+a)%ne)}function Se(e,t,r,i,n,a,s){var o,l=3*e;oe[l]<0?(s=(ce-a)/(s-a),a=c,m[o=3*u]=r+s,m[1+o]=i,m[2+o]=n,ue||(p[o]=d*g(a[r=3*e],a[3+r],s),p[1+o]=d*g(a[1+r],a[4+r],s),p[2+o]=d*g(a[2+r],a[5+r],s)),h&&(f[u]=h[e+Math.round(s)]),oe[l]=u,ve[t]=u,u+=1):ve[t]=oe[l]}function we(e,t,r,i,n,a,s){var o,l=3*e+1;oe[l]<0?(s=(ce-a)/(s-a),a=c,m[o=3*u]=r,m[1+o]=i+s,m[2+o]=n,ue||(p[o]=d*g(a[r=3*e],a[i=r+3*fe],s),p[1+o]=d*g(a[1+r],a[1+i],s),p[2+o]=d*g(a[2+r],a[2+i],s)),h&&(f[u]=h[e+Math.round(s)*fe]),oe[l]=u,ve[t]=u,u+=1):ve[t]=oe[l]}function Ae(e,t,r,i,n,a,s){var o,l=3*e+2;oe[l]<0?(s=(ce-a)/(s-a),a=c,m[o=3*u]=r,m[1+o]=i,m[2+o]=n+s,ue||(p[o]=d*g(a[r=3*e],a[i=r+3*ge],s),p[1+o]=d*g(a[1+r],a[1+i],s),p[2+o]=d*g(a[2+r],a[2+i],s)),h&&(f[u]=h[e+Math.round(s)*ge]),oe[l]=u,ve[t]=u,u+=1):ve[t]=oe[l]}function Me(e){var t=3*e;0===c[t]&&(c[t]=ie[(e-1+l)%l]-ie[(e+1)%l],c[1+t]=ie[(e-fe+l)%l]-ie[(e+fe)%l],c[2+t]=ie[(e-ge+l)%l]-ie[(e+ge)%l])}function v(e,t,r,i,n,a){let s;var N;let o,l,h,F,B;e=void 0!==e?e:0,t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:ne-1,n=void 0!==n?n:ae-1,a=void 0!==a?a:se-1,me||(a=ue?(e=Math.max(0,e),t=Math.max(0,t),r=Math.max(0,r),i=Math.min(ne-1,i),n=Math.min(ae-1,n),Math.min(se-1,a)):(e=Math.max(1,e),t=Math.max(1,t),r=Math.max(1,r),i=Math.min(ne-2,i),n=Math.min(ae-2,n),Math.min(se-2,a)));let U,z,V,G,H,$;if(me)for(U=e-2,z=t-2,V=r-2,G=i+2,H=n+2,$=a+2,h=V;h<$;++h)for(l=z;l<H;++l)for(o=U;o<G;++o)N=3*xe(o,l,h),oe[N]=-1,oe[1+N]=-1,oe[2+N]=-1;else for(U=Math.max(0,e-2),z=Math.max(0,t-2),V=Math.max(0,r-2),G=Math.min(ne,i+2),H=Math.min(ae,n+2),$=Math.min(se,a+2),h=V;h<$;++h)for(B=ge*h,l=z;l<H;++l)for(F=B+fe*l,o=U;o<G;++o)s=3*(F+o),oe[s]=-1,oe[s+1]=-1,oe[s+2]=-1;if(!me){var j=e,W=t,c=r,q=i,X=n,u=a,d=!1;for(h=r;h<a;++h){for(l=t;l<n;++l){for(o=e;o<i;++o)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){c=h,d=!0;break}if(d)break}if(d)break}for(d=!1,l=t;l<n;++l){for(h=c;h<a;++h){for(o=e;o<i;++o)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){W=l,d=!0;break}if(d)break}if(d)break}for(d=!1,o=e;o<i;++o){for(l=W;l<n;++l){for(h=c;h<a;++h)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){j=o,d=!0;break}if(d)break}if(d)break}for(d=!1,h=a;h>=r;--h){for(l=n;l>=t;--l){for(o=i;o>=e;--o)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){u=h,d=!0;break}if(d)break}if(d)break}for(d=!1,l=n;l>=t;--l){for(h=u;h>=r;--h){for(o=i;o>=e;--o)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){X=l,d=!0;break}if(d)break}if(d)break}for(d=!1,o=i;o>=e;--o){for(l=X;l>=t;--l){for(h=u;h>=r;--h)if(s=ne*ae*h+ne*l+o,ie[s]>=ce){q=o,d=!0;break}if(d)break}if(d)break}a=ue?(e=Math.max(0,j-1),t=Math.max(0,W-1),r=Math.max(0,c-1),i=Math.min(ne-1,q+1),n=Math.min(ae-1,X+1),Math.min(se-1,u+1)):(e=Math.max(1,j-1),t=Math.max(1,W-1),r=Math.max(1,c-1),i=Math.min(ne-2,q+1),n=Math.min(ae-2,X+1),Math.min(se-2,u+1))}var m=15;for(h=r;h<a;++h,m&=-5)for(B=ge*h,m|=2,l=t;l<n;++l,m&=-3)for(F=B+fe*l,m|=1,o=e;o<i;++o,m&=-2){s=F+o,k=O=L=D=re=te=ee=J=R=Q=Z=K=I=P=E=T=C=M=A=y=_=v=g=f=p=Y=w=S=x=b=void 0;var p,f,g,v,_,y,b=o,x=l,S=h,w=s,Y=m,A=me?(w=xe(b,x,S),p=xe(b+1,x,S),f=xe(b,x+1,S),g=xe(b,x,S+1),v=xe(b+1,x+1,S),_=xe(b+1,x,S+1),y=xe(b,x+1,S+1),xe(b+1,x+1,S+1)):(p=w+1,v=(f=w+fe)+1,_=(g=w+ge)+1,(y=f+ge)+1),M=0,C=ie[w],T=ie[p],E=ie[f],P=ie[v],I=ie[g],K=ie[_],Z=ie[y],Q=ie[A],R=(C<ce&&(M|=1),T<ce&&(M|=2),E<ce&&(M|=8),P<ce&&(M|=4),I<ce&&(M|=16),K<ce&&(M|=32),Z<ce&&(M|=128),Q<ce&&(M|=64),ye[M]);if(0!==R)for(var D,L,O,J=b+1,ee=x+1,te=S+1,re=(1&R&&(ue||(Me(w),Me(p)),Se(w,0,b,x,S,C,T)),2&R&&(ue||(Me(p),Me(v)),we(p,1,J,x,S,T,P)),4&R&&(ue||(Me(f),Me(v)),Se(f,2,b,ee,S,E,P)),8&R&&(ue||(Me(w),Me(f)),we(w,3,b,x,S,C,E)),16&R&&(ue||(Me(g),Me(_)),Se(g,4,b,x,te,I,K)),32&R&&(ue||(Me(_),Me(A)),we(_,5,J,x,te,K,Q)),64&R&&(ue||(Me(y),Me(A)),Se(y,6,b,ee,te,Z,Q)),128&R&&(ue||(Me(g),Me(y)),we(g,7,b,x,te,I,Z)),256&R&&(ue||(Me(w),Me(g)),Ae(w,8,b,x,S,C,I)),512&R&&(ue||(Me(p),Me(_)),Ae(p,9,J,x,S,T,K)),1024&R&&(ue||(Me(v),Me(A)),Ae(v,10,J,ee,S,P,Q)),2048&R&&(ue||(Me(f),Me(y)),Ae(f,11,b,ee,S,E,Z)),M<<4),k=0;-1!==be[re+k];)D=be[re+k],L=be[re+k+1],O=be[re+k+2],de?(he[D][L]&Y&&(_e[le++]=ve[D],_e[le++]=ve[L]),he[L][O]&Y&&(_e[le++]=ve[L],_e[le++]=ve[O]),he[D][O]&Y&&(_e[le++]=ve[D],_e[le++]=ve[O])):(_e[le++]=ve[pe?D:L],_e[le++]=ve[pe?L:D],_e[le++]=ve[O]),k+=3}}this.triangulate=function(e,t,r,i,n){pe=(ce=e)<0,de=i,me=n,(ue=t||de)||(d=0<ce?-1:1,c=c||new Float32Array(3*l));e=3*l;return oe&&oe.length===e||(oe=new Int32Array(e)),void(le=u=0)!==r?(i=r[0].map(Math.round),n=r[1].map(Math.round),a=ne*Math.ceil(Math.abs(i[0])/ne),s=ae*Math.ceil(Math.abs(i[1])/ae),o=se*Math.ceil(Math.abs(i[2])/se),v(i[0],i[1],i[2],n[0],n[1],n[2])):(a=s=o=0,v()),m.length=3*u,ue||(p.length=3*u),_e.length=le,h&&(f.length=u),{position:new Float32Array(m),normal:ue?void 0:new Float32Array(p),index:Zl(_e,m.length/3),atomindex:h?new Int32Array(f):void 0,contour:de}}}vc.add("arrow",fp),vc.add("box",Mp),vc.add("cone",bp),vc.add("cylinder",pp),vc.add("ellipsoid",wp),vc.add("octahedron",Ap),vc.add("sphere",Ep),vc.add("tetrahedron",Ip),vc.add("torus",Rp),vc.add("point",kp),vc.add("wideline",Np),Object.assign(Up,{__deps:[Fp,Bp,Zl]});class y{constructor(e,t){this.cols=e,this.rows=t,this.size=this.cols*this.rows,this.data=new Float32Array(this.size)}copyTo(e){e.data.set(this.data)}}function zp(e,t){let r=0,i=0;var n=t.rows,a=t.cols;let s=0,o=0,l=0;for(var h=t.data,c=e.data;r<n;o+=1,s+=a,r++)for(l=o,i=0;i<a;l+=n,i++)c[l]=h[s+i]}function Vp(e,t,r){let i=0,n=0,a=0,s=0,o=0,l=0,h=0;var c=t.cols,u=t.rows,d=r.rows,m=t.data,p=r.data,f=e.data;let g=0;for(;i<u;s+=c,i++)for(l=0,n=0;n<d;h++,n++){for(o=s,g=0,a=0;a<c;o++,l++,a++)g+=m[o]*p[l];f[h]=g}}function Gp(e,t,r){var e=e.data,t=t.data,r=r.data,i=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],c=t[7],t=t[8],u=r[0],d=r[1],m=r[2],p=r[3],f=r[4],g=r[5],v=r[6],_=r[7],r=r[8];e[0]=i*u+n*p+a*v,e[1]=i*d+n*f+a*_,e[2]=i*m+n*g+a*r,e[3]=s*u+o*p+l*v,e[4]=s*d+o*f+l*_,e[5]=s*m+o*g+l*r,e[6]=h*u+c*p+t*v,e[7]=h*d+c*f+t*_,e[8]=h*m+c*g+t*r}function Hp(e){var r=e.rows,i=e.cols,n=e.data,a=new Array(i);for(let e=0;e<i;++e)a[e]=0;for(let e=0,t=0;e<r;++e)for(let e=0;e<i;++e,++t)a[e]+=n[t];for(let e=0;e<i;++e)a[e]/=r;return a}function $p(e,r){var i=e.rows,n=e.cols,a=e.data;for(let e=0,t=0;e<i;++e)for(let e=0;e<n;++e,++t)a[t]-=r[e]}function jp(e,t,r,i){i=e[t],e[t]=e[r],e[r]=i}let Wp=1.192092896e-7,qp=1e-37;function Xp(e,t,r,i,n,a,s,o){var l=2*Wp,N=qp;let h=0,c=0,u=0,d=0;var m,p,f,g,F=Math.max(a,30);let v=0,_=0,y=0,b=0,x=0,S=0,w=0;var A,M=0;let C=0,T=0,E=0,P=4660;var I,R;let D=0;for(var L,O,k=new Float64Array(s<<3);h<s;h++){for(u=0,w=0;u<a;u++)b=e[h*t+u],w+=b*b;if(k[h]=w,i){for(u=0;u<s;u++)i[h*n+u]=0;i[h*n+h]=1}}for(;d<F;d++){for(v=0,h=0;h<s-1;h++)for(c=h+1;c<s;c++){for(m=h*t|0,p=c*t|0,C=k[h],T=0,E=k[c],u=2,T=(T+=e[m]*e[p])+e[1+m]*e[1+p];u<a;u++)T+=e[m+u]*e[p+u];if(!(Math.abs(T)<=l*Math.sqrt(C*E))){for(T*=2,A=C-E,L=T,O=A,L=Math.abs(L),M=(O=Math.abs(O))<L?(O/=L,L*Math.sqrt(1+O*O)):0<O?(L/=O,O*Math.sqrt(1+L*L)):0,A<0?(y=Math.sqrt(.5*(M-A)/M),_=T/(M*y*2)):(_=Math.sqrt((M+A)/(2*M)),y=T/(M*_*2)),C=0,E=0,u=2,x=_*e[m]+y*e[p],S=-y*e[m]+_*e[p],e[m]=x,e[p]=S,C+=x*x,E+=S*S,x=_*e[1+m]+y*e[1+p],S=-y*e[1+m]+_*e[1+p],e[1+m]=x,e[1+p]=S,C+=x*x,E+=S*S;u<a;u++)x=_*e[m+u]+y*e[p+u],S=-y*e[m+u]+_*e[p+u],e[m+u]=x,e[p+u]=S,C+=x*x,E+=S*S;if(k[h]=C,k[c]=E,v=1,i)for(f=h*n|0,g=c*n|0,u=2,x=_*i[f]+y*i[g],S=-y*i[f]+_*i[g],i[f]=x,i[g]=S,x=_*i[1+f]+y*i[1+g],S=-y*i[1+f]+_*i[1+g],i[1+f]=x,i[1+g]=S;u<s;u++)x=_*i[f+u]+y*i[g+u],S=-y*i[f+u]+_*i[g+u],i[f+u]=x,i[g+u]=S}}if(0===v)break}for(h=0;h<s;h++){for(u=0,w=0;u<a;u++)b=e[h*t+u],w+=b*b;k[h]=Math.sqrt(w)}for(h=0;h<s-1;h++){for(c=h,u=h+1;u<s;u++)k[c]<k[u]&&(c=u);if(h!==c&&(jp(k,h,c,w),i)){for(u=0;u<a;u++)jp(e,h*t+u,c*t+u,b);for(u=0;u<s;u++)jp(i,h*n+u,c*n+u,b)}}for(h=0;h<s;h++)r[h]=k[h];if(i)for(h=0;h<o;h++){for(w=h<s?k[h]:0;w<=N;){for(R=1/a,u=0;u<a;u++)I=0!=((P=214013*P+2531011)>>16&256)?R:-R,e[h*t+u]=I;for(d=0;d<2;d++)for(c=0;c<h;c++){for(w=0,u=0;u<a;u++)w+=e[h*t+u]*e[c*t+u];for(D=0,u=0;u<a;u++)b=e[h*t+u]-w*e[c*t+u],e[h*t+u]=b,D+=Math.abs(b);for(D=D?1/D:0,u=0;u<a;u++)e[h*t+u]*=D}for(w=0,u=0;u<a;u++)b=e[h*t+u],w+=b*b;w=Math.sqrt(w)}for(y=1/w,u=0;u<a;u++)e[h*t+u]*=y}}function Yp(e,t,r,i){let n=0,a=0;var s=e.rows,o=e.cols;let l=s,h=o;l<h&&(n=1,a=l,l=h,h=a);var c=new y(l,l),u=new y(1,h),d=new y(h,h);if(0===n)zp(c,e);else{for(a=0;a<o*s;a++)c.data[a]=e.data[a];for(;a<h*l;a++)c.data[a]=0}if(Xp(c.data,l,u.data,d.data,h,l,h,l),t){for(a=0;a<h;a++)t.data[a]=u.data[a];for(;a<o;a++)t.data[a]=0}0===n?(r&&zp(r,c),i&&zp(i,d)):(r&&zp(r,d),i&&zp(i,c))}function Kp(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Zp(e,t,r,i,n,a,s,o,l,h,c,u,d,m,p,f,g){e[0]=t,e[4]=r,e[8]=i,e[12]=n,e[1]=a,e[5]=s,e[9]=o,e[13]=l,e[2]=h,e[6]=c,e[10]=u,e[14]=d,e[3]=m,e[7]=p,e[11]=f,e[15]=g}function Qp(e,t,r){var i=t[0],n=t[4],a=t[8],s=t[12],o=t[1],l=t[5],h=t[9],c=t[13],u=t[2],d=t[6],m=t[10],p=t[14],f=t[3],g=t[7],v=t[11],t=t[15],_=r[0],y=r[4],b=r[8],x=r[12],S=r[1],w=r[5],A=r[9],M=r[13],C=r[2],T=r[6],E=r[10],P=r[14],I=r[3],R=r[7],D=r[11],r=r[15];e[0]=i*_+n*S+a*C+s*I,e[4]=i*y+n*w+a*T+s*R,e[8]=i*b+n*A+a*E+s*D,e[12]=i*x+n*M+a*P+s*r,e[1]=o*_+l*S+h*C+c*I,e[5]=o*y+l*w+h*T+c*R,e[9]=o*b+l*A+h*E+c*D,e[13]=o*x+l*M+h*P+c*r,e[2]=u*_+d*S+m*C+p*I,e[6]=u*y+d*w+m*T+p*R,e[10]=u*b+d*A+m*E+p*D,e[14]=u*x+d*M+m*P+p*r,e[3]=f*_+g*S+v*C+t*I,e[7]=f*y+g*w+v*T+t*R,e[11]=f*b+g*A+v*E+t*D,e[15]=f*x+g*M+v*P+t*r}function Jp(e,t,r,i){Zp(e,t,0,0,0,0,r,0,0,0,0,i,0,0,0,0,1)}function ef(e,t,r,i){Zp(e,1,0,0,t,0,1,0,r,0,0,1,i,0,0,0,1)}function tf(e,t){var r=Math.cos(t),t=Math.sin(t);Zp(e,r,0,t,0,0,1,0,0,-t,0,r,0,0,0,0,1)}function rf(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function nf(e,t){var r=Q([t[0],t[1],t[2]]),i=Q([t[4],t[5],t[6]]),t=Q([t[8],t[9],t[10]]),n=Q();fd(n,i,t),e[0]=n[0],e[1]=n[1],e[2]=n[2],fd(n,t,r),e[3]=n[0],e[4]=n[1],e[5]=n[2],fd(n,r,i),e[6]=n[0],e[7]=n[1],e[8]=n[2]}function af(e,t,r,i){r=r||1;var n=e.length/3,a=t.length/3;let s=void 0;(i=i||!0)&&(s=new Float32Array(3*n));var o=new Float32Array(3*n);let l;var h=new Array(20);for(l=0;l<20;++l)h[l]=new Uint32Array(n);for(l=0;l<n;++l)h[0][l]=0;let c,u,d;for(l=0;l<a;++l){var m=3*l,p=3*l+1,f=3*l+2;for(d=!0,c=0,u=h[0][t[m]];c<u;++c)if(t[p]===h[c+1][t[m]]){d=!1;break}for(d&&(h[0][t[m]]++,h[h[0][t[m]]][t[m]]=t[p]),d=!0,c=0,u=h[0][t[m]];c<u;++c)if(t[f]===h[c+1][t[m]]){d=!1;break}for(d&&(h[0][t[m]]++,h[h[0][t[m]]][t[m]]=t[f]),d=!0,c=0,u=h[0][t[p]];c<u;++c)if(t[m]===h[c+1][t[p]]){d=!1;break}for(d&&(h[0][t[p]]++,h[h[0][t[p]]][t[p]]=t[m]),d=!0,c=0,u=h[0][t[p]];c<u;++c)if(t[f]===h[c+1][t[p]]){d=!1;break}for(d&&(h[0][t[p]]++,h[h[0][t[p]]][t[p]]=t[f]),d=!0,c=0;c<h[0][t[f]];++c)if(t[m]===h[c+1][t[f]]){d=!1;break}for(d&&(h[0][t[f]]++,h[h[0][t[f]]][t[f]]=t[m]),d=!0,c=0,u=h[0][t[f]];c<u;++c)if(t[p]===h[c+1][t[f]]){d=!1;break}d&&(h[0][t[f]]++,h[h[0][t[f]]][t[f]]=t[p])}for(var g,v,_,y=0;y<r;++y){for(l=0;l<n;++l)if(x=3*l,(v=h[0][l])<3)o[x]=e[x],o[x+1]=e[x+1],o[x+2]=e[x+2];else if(3===v||4===v){for(o[x]=0,o[x+1]=0,o[x+2]=0,c=0;c<v;++c)g=3*h[c+1][l],o[x]+=e[g],o[x+1]+=e[g+1],o[x+2]+=e[g+2];o[x]+=.5*e[x],o[x+1]+=.5*e[x+1],o[x+2]+=.5*e[x+2],o[x]/=_=.5+v,o[x+1]/=_,o[x+2]/=_}else{for(o[x]=0,o[x+1]=0,o[x+2]=0,c=0;c<v;++c)g=3*h[c+1][l],o[x]+=e[g],o[x+1]+=e[g+1],o[x+2]+=e[g+2];o[x]+=+e[x],o[x+1]+=+e[x+1],o[x+2]+=+e[x+2],o[x]/=_=1+v,o[x+1]/=_,o[x+2]/=_}if(e.set(o),i){sf(e,t,s);for(var b=3*n,x=0;x<b;x+=3)e[x]+=.75/4.5*-1*s[x],e[x+1]+=.75/4.5*-1*s[x+1],e[x+2]+=.75/4.5*-1*s[x+2]}}}function sf(e,t,r){var i,n;if(void 0===r)r=new Float32Array(e.length);else for(i=0,n=r.length;i<n;i++)r[i]=0;var a=new Float32Array(3),s=new Float32Array(3),o=new Float32Array(3),l=new Float32Array(3),h=new Float32Array(3);if(t)for(i=0,n=t.length;i<n;i+=3){var c=3*t[i],u=3*t[i+1],d=3*t[i+2];yd(a,e,c),yd(s,e,u),yd(o,e,d),vd(l,o,s),vd(h,a,s),fd(l,l,h),r[c]+=l[0],r[1+c]+=l[1],r[2+c]+=l[2],r[u]+=l[0],r[1+u]+=l[1],r[2+u]+=l[2],r[d]+=l[0],r[1+d]+=l[1],r[2+d]+=l[2]}else for(i=0,n=e.length;i<n;i+=9)yd(a,e,i),yd(s,e,i+3),yd(o,e,i+6),vd(l,o,s),vd(h,a,s),fd(l,l,h),r[i]=l[0],r[i+1]=l[1],r[i+2]=l[2],r[i+3]=l[0],r[i+4]=l[1],r[i+5]=l[2],r[i+6]=l[0],r[i+7]=l[1],r[i+8]=l[2];return pd(r),r}function of(e){for(var t={},r=0,i=e.length;r<i;++r)t[e[r]]=!0;return t}function lf(e,t,r,i,n){var a=1/i*3,r=(Ad(e,e,n+(a+=r)),Md(t,t,n+a),ue(e,e,i),Cd(e,e),Sd(e,e,i),ue(t,t,i),Td(t,t),Sd(t,t,i),new Float32Array(3)),n=(vd(r,t,e),ue(r,r,i),Td(r,r),Md(r,r,1),256*Math.pow(10,6)),a=r[0]*r[1]*r[2]*3,n=(n<=a&&(ue(e,e,i*=Math.pow(n/a,1/3)),Cd(e,e),Sd(e,e,i),ue(t,t,i),Td(t,t),Sd(t,t,i),vd(r,t,e),ue(r,r,i),Td(r,r),Md(r,r,1)),new Float32Array(e)),a=(Ed(n,n),Kp()),t=Kp(),e=(tf(t,1.5705),Qp(a,a,t),Kp()),t=(Jp(e,-1/i,1/i,1/i),Qp(a,a,e),Kp());return ef(t,-i*n[2],-i*n[1],-i*n[0]),Qp(a,a,t),{dim:r,tran:n,matrix:a,scaleFactor:i}}Jp.__deps=[Zp],ef.__deps=[Zp],tf.__deps=[Zp],nf.__deps=[Q,fd],Object.assign(af,{__deps:[sf]}),Object.assign(sf,{__deps:[vd,fd,yd,pd]}),Object.assign(lf,{__deps:[sh,Ad,Md,Sd,ue,Cd,Td,vd,Ed,Kp,Qp,ef,Jp,tf]});class hf{constructor(e,t,r){this.name=e||"",this.path=t||"",this.info={},this.center=new et,this.boundingBox=new ai,r instanceof Fn||r instanceof Wo?this.fromGeometry(r):r&&(this.set(r.position,r.index,r.normal,r.color,r.atomindex,r.contour),this.boundingBox.setFromArray(r.position),this.boundingBox.getCenter(this.center))}get type(){return"Surface"}set(e,t,r,i,n,a=!1){this.position=e,this.index=t,this.normal=r,this.color=i,this.atomindex=n,this.size=e.length/3,this.contour=a}fromGeometry(e){Je.Debug&&rt.time("GeometrySurface.fromGeometry");let t;(t=e instanceof Fn?e:e[0]).boundingBox||t.computeBoundingBox(),this.boundingBox.copy(t.boundingBox),this.boundingBox.getCenter(this.center);let r,i,n;var a;t instanceof Fn&&((a=!!(e=t.attributes).normal&&e.normal.array)&&(0!==a[0]||0!==a[1]||0!==a[2])||t.computeVertexNormals(),r=e.position.array,i=e.index?e.index.array:null,n=e.normal.array),this.set(r,i,n,void 0,void 0),Je.Debug&&rt.timeEnd("GeometrySurface.setGeometry")}getPosition(){return this.position}getColor(e){var e=e||{},t=(e.surface=this).size,r=new Float32Array(3*t),i=k.getScheme(e);if(i.volumeColor||"random"===e.scheme)for(let e=0;e<t;++e)i.volumeColorToArray(e,r,3*e);else if(i.positionColor){var n=new et,a=this.position;for(let e=0;e<t;++e){var s=3*e;n.set(a[s],a[1+s],a[2+s]),i.positionColorToArray(n,r,s)}}else if(i.atomColor&&this.atomindex){var o=e.structure.getAtomProxy(),l=this.atomindex;for(let e=0;e<t;++e)o.index=l[e],i.atomColorToArray(o,r,3*e)}else{e=new ze(e.value);_(t,e.r,e.g,e.b,r)}return r}getPicking(e){return this.atomindex&&e?new gp(this.atomindex,e):new Pp(Xc(this.size),this)}getNormal(){return this.normal}getSize(e,t){return qc(this.size,e*t)}getIndex(){return this.index}getFilteredIndex(e,t){if(e&&this.atomindex){var e=new qh(e),n=t.getAtomSet(e),a=[],s=this.atomindex,o=this.index,l=o.length,h=this.contour?2:3;let i=0;for(let r=0;r<l;r+=h){let t=!0;for(let e=0;e<h;e++){var c=s[o[r+e]];if(!n.get(c)){t=!1;break}}if(t)for(let e=0;e<h;e++,i++)a[i]=o[r+e]}return Zl(a,this.position.length/3)}return this.index}getAtomindex(){return this.atomindex}dispose(){}}function cf(e,t,r,i,n){var s=new Up(e,t,r,i,n);this.getSurface=function(e,t,r,i,n,a=!1){return e=s.triangulate(e,t,r,n,a),t&&!n&&(af(e.position,e.index,t,!0),e.normal=sf(e.position,e.index)),i&&(dd(i,e.position),e.normal)&&(nf(r=rf(),i),md(r,e.normal)),e}}Object.assign(cf,{__deps:[af,sf,Up,dd,md,rf,nf]}),uc.add("surf",function(e,t){var r,i=e.data.args,e=e.data.params;i&&(self.volsurf=new cf(i[0],i[1],i[2],i[3],i[4])),e&&(r=[(i=self.volsurf.getSurface(e.isolevel,e.smooth,e.box,e.matrix,e.contour,e.wrap)).position.buffer,i.index.buffer],i.normal&&r.push(i.normal.buffer),i.atomindex&&r.push(i.atomindex.buffer),t({sd:i,p:e},r))},[cf]);class uf{constructor(e,t,r,i,n,a,s){this.name=e,this.path=t,this.matrix=new tt,this.normalMatrix=new v,this.inverseMatrix=new tt,this.center=new et,this.boundingBox=new ai,this.setData(r,i,n,a,s)}get type(){return"Volume"}setData(e,t,r,i,n){this.nx=t||1,this.ny=r||1,this.nz=i||1,this.data=e||new Float32Array(1),this.setAtomindex(n),delete this._position,delete this._min,delete this._max,delete this._mean,delete this._rms,this.worker&&this.worker.terminate()}setStats(e,t,r,i){this._min=e,this._max=t,this._mean=r,this._rms=i}setMatrix(e){this.matrix.copy(e);var e=this.boundingBox,t=this.center,r=this.nx-1,i=this.ny-1,n=this.nz-1,r=(e.makeEmpty(),e.expandByPoint(t.set(r,i,n)),e.expandByPoint(t.set(r,i,0)),e.expandByPoint(t.set(r,0,n)),e.expandByPoint(t.set(r,0,0)),e.expandByPoint(t.set(0,i,n)),e.expandByPoint(t.set(0,0,n)),e.expandByPoint(t.set(0,i,0)),e.expandByPoint(t.set(0,0,0)),e.applyMatrix4(this.matrix),e.getCenter(this.center),this.matrix.elements),n=new et(r[0],r[1],r[2]),i=new et(r[4],r[5],r[6]),t=new et(r[8],r[9],r[10]),e=new et,r=this.normalMatrix.elements;e.crossVectors(i,t),r[0]=e.x,r[1]=e.y,r[2]=e.z,e.crossVectors(t,n),r[3]=e.x,r[4]=e.y,r[5]=e.z,e.crossVectors(n,i),r[6]=e.x,r[7]=e.y,r[8]=e.z,this.inverseMatrix.copy(this.matrix).invert()}setAtomindex(e){this.atomindex=e}getBox(e,t,r){return(r=r||new ai).set(e,e),r.expandByScalar(t),r.applyMatrix4(this.inverseMatrix),r.min.round(),r.max.round(),r}_getBox(e,t){if(e&&t)return this.__box||(this.__box=new ai),[(e=this.getBox(e,t,this.__box)).min.toArray(),e.max.toArray()]}_makeSurface(e,t,r){var i=this.name+"@"+t.toPrecision(2),i=new hf(i,"",e);return i.info.isolevel=t,i.info.smooth=r,i.info.volume=this,i}getSurface(e,t,r,i,n,a=!1){e=isNaN(e)?this.getValueForSigma(2):e,t=ce(t,0),void 0===this.volsurf&&(this.volsurf=new cf(this.data,this.nx,this.ny,this.nz,this.atomindex));r=this._getBox(r,i),i=this.volsurf.getSurface(e,t,r,this.matrix.elements,n,a);return this._makeSurface(i,e,t)}getSurfaceWorker(t,r,i,n,a,s,o){var e,l;t=isNaN(t)?this.getValueForSigma(2):t,r=r||0,window.hasOwnProperty("Worker")?(void 0===this.workerPool&&(this.workerPool=new ld("surf",2)),e={},0===(l=this.workerPool.getNextWorker()).postCount&&Object.assign(e,{args:[this.data,this.nx,this.ny,this.nz,this.atomindex]}),Object.assign(e,{params:{isolevel:t,smooth:r,box:this._getBox(i,n),matrix:this.matrix.elements,contour:a,wrap:s}}),l.post(e,void 0,e=>{var t=e.data.sd,e=e.data.p;o(this._makeSurface(t,e.isolevel,e.smooth))},e=>{console.warn("Volume.getSurfaceWorker error - trying without worker",e);e=this.getSurface(t,r,i,n,a,s);o(e)})):(l=this.getSurface(t,r,i,n,a,s),o(l))}getValueForSigma(e){return this.mean+ce(e,2)*this.rms}getSigmaForValue(e){return(ce(e,0)-this.mean)/this.rms}get position(){if(!this._position){var e=this.nz,n=this.ny,a=this.nx,s=new Float32Array(a*n*e*3);let i=0;for(let r=0;r<e;++r)for(let t=0;t<n;++t)for(let e=0;e<a;++e)s[i+0]=e,s[i+1]=t,s[i+2]=r,i+=3;dd(this.matrix.elements,s),this._position=s}return this._position}getDataAtomindex(){return this.atomindex}getDataPosition(){return this.position}getDataColor(e){var e=e||{},t=(e.volume=this,e.scale=e.scale||"Spectral",e.domain=e.domain||[this.min,this.max],k.getScheme(e)),r=this.position.length/3,i=new Float32Array(3*r);for(let e=0;e<r;++e)t.volumeColorToArray(e,i,3*e);return i}getDataPicking(){var e=Xc(this.position.length/3);return new Lp(e,this)}getDataSize(e,t){var r=this.data,i=this.position.length/3;let n;switch(e){case"value":n=new Float32Array(r);break;case"abs-value":n=new Float32Array(r);for(let e=0;e<i;++e)n[e]=Math.abs(n[e]);break;case"value-min":n=new Float32Array(r);var a=this.min;for(let e=0;e<i;++e)n[e]-=a;break;case"deviation":n=new Float32Array(r);break;default:n=qc(i,e)}if(1!==t)for(let e=0;e<i;++e)n[e]*=t;return n}get min(){return void 0===this._min&&(this._min=eu(this.data)),this._min}get max(){return void 0===this._max&&(this._max=Jc(this.data)),this._max}get sum(){return void 0===this._sum&&(this._sum=tu(this.data)),this._sum}get mean(){return void 0===this._mean&&(this._mean=ru(this.data)),this._mean}get rms(){return void 0===this._rms&&(this._rms=(t=>{var r=t.length;let i=0;for(let e=0;e<r;++e){var n=t[e];i+=n*n}return Math.sqrt(i/r)})(this.data)),this._rms}clone(){var e=new uf(this.name,this.path,this.data,this.nx,this.ny,this.nz,this.atomindex);return e.matrix.copy(this.matrix),e.header=Object.assign({},this.header),e}dispose(){this.workerPool&&this.workerPool.terminate()}}function df(e){return"front"===e?Ve:"back"===e?Ge:He}s.add("shader/Mesh.vert","#define STANDARD\r\n\r\nuniform float clipNear;\r\nuniform vec3 clipCenter;\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\n#if defined( PICKING )\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#elif defined( NOLIGHT )\r\nvarying vec3 vColor;\r\n#else\r\n#include color_pars_vertex\r\n#ifndef FLAT_SHADED\r\nvarying vec3 vNormal;\r\n#endif\r\n#endif\r\n\r\n#include common\r\n\r\nvoid main(){\r\n\r\n#if defined( PICKING )\r\nvPickingColor = unpackColor( primitiveId );\r\n#elif defined( NOLIGHT )\r\nvColor = color;\r\n#else\r\n#include color_vertex\r\n#include beginnormal_vertex\r\n#include defaultnormal_vertex\r\n// Normal computed with derivatives when FLAT_SHADED\r\n#ifndef FLAT_SHADED\r\nvNormal = normalize( transformedNormal );\r\n#endif\r\n#endif\r\n\r\n#include begin_vertex\r\n#include project_vertex\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\r\nvViewPosition = -mvPosition.xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n\r\n}"),s.add("shader/Mesh.frag","#define STANDARD\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#elif defined( NOLIGHT )\ngl_FragColor = vec4( vColor, opacity );\n#else\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\n#include interior_fragment\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#include opaque_back_fragment\n#endif\n}");let mf={f:1,v2:2,v3:3,c:3};function pf(e,t){e.matrix.copy(t),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorldNeedsUpdate=!0}let ff={opaqueBack:!1,side:"double",opacity:1,depthWrite:!0,clipNear:0,clipRadius:0,clipCenter:new et,flatShaded:!1,wireframe:!1,roughness:.4,metalness:0,diffuse:16777215,diffuseInterior:!1,useInteriorColor:!1,interiorColor:14540253,interiorDarkening:0,forceTransparent:!1,matrix:new tt,disablePicking:!1,sortParticles:!1,background:!1},gf={opaqueBack:{updateShader:!0},side:{updateShader:!0,property:!0},opacity:{uniform:!0},depthWrite:{property:!0},clipNear:{updateShader:!0,property:!0},clipRadius:{updateShader:!0,uniform:!0},clipCenter:{uniform:!0},flatShaded:{updateShader:!0},background:{updateShader:!0},wireframe:{updateVisibility:!0},roughness:{uniform:!0},metalness:{uniform:!0},diffuse:{uniform:!0},diffuseInterior:{updateShader:!0},useInteriorColor:{updateShader:!0},interiorColor:{uniform:!0},interiorDarkening:{uniform:!0},matrix:{}};class vf{constructor(e,t={}){this.parameterTypes=gf,this.geometry=new Fn,this.indexVersion=0,this.wireframeIndexVersion=-1,this.group=new Wo,this.wireframeGroup=new Wo,this.pickingGroup=new Wo,this.vertexShader="",this.fragmentShader="",this.isImpostor=!1,this.isText=!1,this.isSurface=!1,this.isPoint=!1,this.isLine=!1,this.dynamic=!0,this.visible=!0,this.wireframeIndexCount=0,this.parameters=Vl(t,this.defaultParameters),this.uniforms=oa.merge([R.common,{fogColor:{value:new ze(0)},fogNear:{value:0},fogFar:{value:0},opacity:{value:this.parameters.opacity},clipNear:{value:0},clipRadius:{value:this.parameters.clipRadius},clipCenter:{value:this.parameters.clipCenter}},{emissive:{value:new ze(0)},roughness:{value:this.parameters.roughness},metalness:{value:this.parameters.metalness},interiorColor:{value:new ze(this.parameters.interiorColor)},interiorDarkening:{value:this.parameters.interiorDarkening}},R.lights]),this.uniforms.diffuse.value.set(this.parameters.diffuse),this.pickingUniforms={clipNear:{value:0},objectId:{value:0},opacity:{value:this.parameters.opacity}};var r=e.position||e.position1;this._positionDataSize=r?r.length/3:0,e.primitiveId||(e.primitiveId=Xc(this._positionDataSize)),this.addAttributes({position:{type:"v3",value:e.position},color:{type:"c",value:e.color},primitiveId:{type:"f",value:e.primitiveId}}),t.matrix&&(this.matrix=t.matrix),e.index&&this.initIndex(e.index),this.picking=e.picking,this.makeWireframeGeometry()}get defaultParameters(){return ff}set matrix(e){this.setMatrix(e)}get matrix(){return this.group.matrix.clone()}get transparent(){return this.parameters.opacity<1||this.parameters.forceTransparent}get size(){return this._positionDataSize}get attributeSize(){return this.size}get pickable(){return!!this.picking&&!this.parameters.disablePicking}setMatrix(e){pf(this.group,e),pf(this.wireframeGroup,e),pf(this.pickingGroup,e)}initIndex(e){this.geometry.setIndex(new Cn(e,1));e=this.geometry.getIndex();e?e.setUsage(this.dynamic?_r:vr):rt.error("Index is null")}makeMaterial(){var e=df(this.parameters.side),t=new la({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!0,fog:!0,side:e}),r=(t.vertexColors=!0,t.extensions.derivatives=!0,t.extensions.fragDepth=this.isImpostor,new la({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!1,fog:!0,side:e})),e=(r.vertexColors=!0,new la({uniforms:this.pickingUniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:!1,depthWrite:this.parameters.depthWrite,lights:!1,fog:!1,side:e,blending:ee}));e.vertexColors=!0,e.extensions.fragDepth=this.isImpostor,t.clipNear=this.parameters.clipNear,r.clipNear=this.parameters.clipNear,e.clipNear=this.parameters.clipNear,this.material=t,this.wireframeMaterial=r,this.pickingMaterial=e,this.updateShader()}makeWireframeGeometry(){this.makeWireframeIndex();var e=this.geometry,t=this.wireframeIndex,r=new Fn;r.attributes=e.attributes,t&&(r.setIndex(new Cn(t,1).setUsage(this.dynamic?_r:vr)),r.setDrawRange(0,this.wireframeIndexCount)),this.wireframeGeometry=r}makeWireframeIndex(){let n=[];function a(e,t){t<e&&(r=e,e=t,t=r);var r=n[e];return void 0===r?n[e]=[t]:!r.includes(t)&&(r.push(t),1)}var e=this.geometry,s=e.index;if(this.parameters.wireframe){if(s){var o=s.array;let t=o.length;e.drawRange.count!==1/0&&(t=e.drawRange.count);let r,i=(r=this.wireframeIndex&&this.wireframeIndex.length>2*t?this.wireframeIndex:(s=e.attributes.position.count,Zl(2*t,s)),0);for(let e=n.length=0;e<t;e+=3){var l=o[e+0],h=o[e+1],c=o[e+2];a(l,h)&&(r[i+0]=l,r[i+1]=h,i+=2),a(h,c)&&(r[i+0]=h,r[i+1]=c,i+=2),a(c,l)&&(r[i+0]=c,r[i+1]=l,i+=2)}this.wireframeIndex=r,this.wireframeIndexCount=i}else{var i=e.attributes.position.count;let r;r=this.wireframeIndex&&this.wireframeIndex.length>2*i?this.wireframeIndex:Zl(2*i,i);for(let e=0,t=0;e<i;e+=3)r[t+0]=e,r[t+1]=e+1,r[t+2]=e+1,r[t+3]=e+2,r[t+4]=e+2,r[t+5]=e,t+=6;this.wireframeIndex=r,this.wireframeIndexCount=2*i}this.wireframeIndexVersion=this.indexVersion}else this.wireframeIndex=new Uint16Array(0),this.wireframeIndexCount=0}updateWireframeIndex(){if(this.wireframeGeometry&&this.wireframeIndex){if(this.wireframeGeometry.setDrawRange(0,1/0),this.wireframeIndexVersion<this.indexVersion&&this.makeWireframeIndex(),this.wireframeGeometry.index&&this.wireframeIndex.length>this.wireframeGeometry.index.array.length)this.wireframeGeometry.setIndex(new Cn(this.wireframeIndex,1).setUsage(this.dynamic?_r:vr));else{var e=this.wireframeGeometry.getIndex();if(!e)return void rt.error("Index is null");e.set(this.wireframeIndex),e.needsUpdate=0<this.wireframeIndexCount,e.updateRange.count=this.wireframeIndexCount}this.wireframeGeometry.setDrawRange(0,this.wireframeIndexCount)}}getRenderOrder(){let e=0;return this.isText?e=1:this.transparent&&(e=this.isSurface?3:2),e}_getMesh(e){this.material||this.makeMaterial();var t=this.geometry,e=this[e];let r;return(r=new(this.isLine?dl:this.isPoint?_l:ta)(t,e)).frustumCulled=!1,r.renderOrder=this.getRenderOrder(),r}getMesh(){return this._getMesh("material")}getWireframeMesh(){var e;return this.material||this.makeMaterial(),this.wireframeGeometry||this.makeWireframeGeometry(),(e=new dl(this.wireframeGeometry,this.wireframeMaterial)).frustumCulled=!1,e.renderOrder=this.getRenderOrder(),e}getPickingMesh(){return this._getMesh("pickingMaterial")}getShader(e,t){return Uc(e,this.getDefines(t))}getVertexShader(e){return this.getShader(this.vertexShader,e)}getFragmentShader(e){return this.getShader(this.fragmentShader,e)}getDefines(e){var t={};return this.parameters.clipNear&&(t.NEAR_CLIP=1),this.parameters.clipRadius&&(t.RADIUS_CLIP=1),"picking"===e?t.PICKING=1:("background"!==e&&!this.parameters.background||(t.NOLIGHT=1),this.parameters.flatShaded&&(t.FLAT_SHADED=1),this.parameters.opaqueBack&&(t.OPAQUE_BACK=1),this.parameters.diffuseInterior&&(t.DIFFUSE_INTERIOR=1),this.parameters.useInteriorColor&&(t.USE_INTERIOR_COLOR=1)),t}getParameters(){return this.parameters}addUniforms(e){this.uniforms=oa.merge([this.uniforms,e]),this.pickingUniforms=oa.merge([this.pickingUniforms,e])}addAttributes(t){for(var r in t){let e;var i=t[r],n=this.attributeSize*mf[i.type];e=i.value?(n!==i.value.length&&rt.error("attribute value has wrong length",r),i.value):Kl("float32",n),this.geometry.setAttribute(r,new Cn(e,mf[i.type]).setUsage(this.dynamic?_r:vr))}}updateRenderOrder(){let t=this.getRenderOrder();function e(e){e.renderOrder=t}this.group.children.forEach(e),this.pickingGroup&&this.pickingGroup.children.forEach(e)}updateShader(){var e=this.material,t=this.wireframeMaterial,r=this.pickingMaterial;e.vertexShader=this.getVertexShader(),e.fragmentShader=this.getFragmentShader(),e.needsUpdate=!0,t.vertexShader=this.getShader("Line.vert"),t.fragmentShader=this.getShader("Line.frag"),t.needsUpdate=!0,r.vertexShader=this.getVertexShader("picking"),r.fragmentShader=this.getFragmentShader("picking"),r.needsUpdate=!0}setParameters(e){var t,r=e,i=this.parameterTypes,n=this.parameters,a={},s={};let o=!1,l=!1;for(t in r){var h=r[t];void 0!==h&&(n[t]=h,void 0!==i[t]&&(i[t].property&&(!0!==i[t].property?a[i[t].property]=h:a[t]=h),i[t].uniform&&(!0!==i[t].uniform?s[i[t].uniform]=h:s[t]=h),i[t].updateShader&&(o=!0),i[t].updateVisibility&&(l=!0),this.dynamic&&"wireframe"===t&&!0===h&&this.updateWireframeIndex(),"forceTransparent"===t&&(a.transparent=this.transparent),"matrix"===t))&&(this.matrix=h)}this.setProperties(a),this.setUniforms(s),o&&this.updateShader(),l&&this.setVisibility(this.visible)}setAttributes(e){var t,r,i,n,a=this.geometry,s=a.attributes;for(t in e)"picking"!==t&&(i=(r=e[t]).length,"index"===t?(n=a.getIndex())?(a.setDrawRange(0,1/0),i>n.array.length?a.setIndex(new Cn(r,1).setUsage(this.dynamic?_r:vr)):(n.set(r),n.needsUpdate=0<i,n.updateRange.count=i,a.setDrawRange(0,i)),this.indexVersion++,this.parameters.wireframe&&this.updateWireframeIndex()):rt.error("Index is null"):i>(n=s[t]).array.length?a.setAttribute(t,new Cn(r,n.itemSize).setUsage(this.dynamic?_r:vr)):(s[t].set(r),s[t].needsUpdate=0<i,s[t].updateRange.count=i))}setUniforms(e){if(e){var t,r=this.material.uniforms,i=this.wireframeMaterial.uniforms,n=this.pickingMaterial.uniforms;for(t in e)"opacity"===t&&this.setProperties({transparent:this.transparent}),void 0!==r[t]&&(r[t].value.isVector3?r[t].value.copy(e[t]):r[t].value.set?r[t].value.set(e[t]):r[t].value=e[t]),void 0!==i[t]&&(i[t].value.isVector3?i[t].value.copy(e[t]):i[t].value.set?i[t].value.set(e[t]):i[t].value=e[t]),void 0!==n[t]&&(n[t].value.isVector3?n[t].value.copy(e[t]):n[t].value.set?n[t].value.set(e[t]):n[t].value=e[t])}}setProperties(t){if(t){var r,i=this.material,n=this.wireframeMaterial,a=this.pickingMaterial;for(r in t){var s=r;let e=t[s];"transparent"===s?this.updateRenderOrder():"side"===s&&(e=df(e)),i[s]=e,n[s]=e,a[s]=e}i.needsUpdate=!0,n.needsUpdate=!0,a.needsUpdate=!0}}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.material&&this.material.dispose(),this.wireframeMaterial&&this.wireframeMaterial.dispose(),this.pickingMaterial&&this.pickingMaterial.dispose(),this.geometry.dispose(),this.wireframeGeometry&&this.wireframeGeometry.dispose()}toJSON(){var e,t={};for(e in this)"group"!==e&&"wireframeGroup"!==e&&"pickingGroup"!=e&&"picking"!==e&&(t[e]=this[e]);return t}}class _f extends vf{constructor(e,t={}){super(e,t),this.vertexShader="Mesh.vert",this.fragmentShader="Mesh.frag",this.addAttributes({normal:{type:"v3",value:e.normal}}),void 0===e.normal&&this.geometry.computeVertexNormals()}}class yf extends _f{constructor(){super(...arguments),this.isSurface=!0}}function bf(e){e.visible=!0}function xf(e){e.visible=!1}class Sf{constructor(e){this.group=new Wo,this.wireframeGroup=new Wo,this.pickingGroup=new Wo,this.frontMeshes=[],this.backMeshes=[],this.size=e.size,this.side=e.parameters.side,this.visible=e.visible,this.geometry=e.geometry,this.picking=e.picking,this.group=new Wo,this.wireframeGroup=new Wo,this.pickingGroup=new Wo,this.matrix=e.matrix;var t=e,r=new e.constructor({position:new Float32Array(0)});t.makeMaterial(),r.makeMaterial(),r.picking=e.picking,r.geometry=e.geometry,r.wireframeGeometry=e.wireframeGeometry,r.setParameters(e.getParameters()),r.updateShader(),t.setParameters({side:"front"}),r.setParameters({side:"back",opacity:r.parameters.opacity}),this.buffer=e,this.frontBuffer=t,this.backBuffer=r}set matrix(e){vf.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking&&!this.parameters.disablePicking}get parameters(){return this.buffer.parameters}getParameters(){var e=Object.assign({},this.buffer.parameters);return e.side=this.side,e}getMesh(e){let t,r;return t=e?(r=this.backBuffer.getPickingMesh(),this.frontBuffer.getPickingMesh()):(r=this.backBuffer.getMesh(),this.frontBuffer.getMesh()),this.frontMeshes.push(t),this.backMeshes.push(r),this.setParameters({side:this.side}),(new Wo).add(r,t)}getWireframeMesh(){return this.buffer.getWireframeMesh()}getPickingMesh(){return this.getMesh(!0)}setAttributes(e){this.buffer.setAttributes(e)}setParameters(e){"front"===(e=Object.assign({},e)).side?(this.frontMeshes.forEach(bf),this.backMeshes.forEach(xf)):"back"===e.side?(this.frontMeshes.forEach(xf),this.backMeshes.forEach(bf)):"double"===e.side&&(this.frontMeshes.forEach(bf),this.backMeshes.forEach(bf)),void 0!==e.side&&(this.side=e.side),delete e.side,void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,this.frontBuffer.setParameters(e),void 0!==e.wireframe&&(this.wireframe=e.wireframe,this.setVisibility(this.visible)),delete e.wireframe,this.backBuffer.setParameters(e)}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.frontBuffer.dispose(),this.backBuffer.dispose()}toJSON(){var e,t={};for(e in this)["side","size","visible","matrix","parameters"].includes(e)&&(t[e]=this[e]);return t}}s.add("shader/Line.vert","uniform float clipNear;\r\nuniform vec3 clipCenter;\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\n#include color_pars_vertex\r\n\r\nvoid main(){\r\n\r\n#include color_vertex\r\n#include begin_vertex\r\n#include project_vertex\r\n\r\nvViewPosition = -mvPosition.xyz;\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n\r\n}"),s.add("shader/Line.frag","uniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\ngl_FragColor = vec4( vColor, opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n}");class wf extends vf{constructor(){super(...arguments),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag"}}class Af extends sd{constructor(e,t,r){super(e,t,r),this.type="surface",this.parameters=Object.assign({isolevelType:{type:"select",options:{value:"value",sigma:"sigma"}},isolevel:{type:"number",precision:2,max:1e3,min:-1e3},negateIsolevel:{type:"boolean"},isolevelScroll:{type:"boolean"},smooth:{type:"integer",precision:1,max:10,min:0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},boxSize:{type:"integer",precision:1,max:100,min:0},colorVolume:{type:"hidden"},contour:{type:"boolean",rebuild:!0},useWorker:{type:"boolean",rebuild:!0},wrap:{type:"boolean",rebuild:!0}},this.parameters),e instanceof uf?(this.surface=void 0,this.volume=e):(this.surface=e,this.volume=void 0),this.boxCenter=new et,this.__boxCenter=new et,this.box=new ai,this.__box=new ai,this._position=new et,this.inverseMatrix=new tt,this.setBox=function(){this._position.copy(t.translationGroup.position).negate(),this._position.applyMatrix4(this.inverseMatrix),this._position.equals(this.boxCenter)||this.setParameters({boxCenter:this._position})},this.toBePrepared=!0,this.viewer.signals.ticked.add(this.setBox,this),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"uniform"),e.colorValue=ce(e.colorValue,14540253),this.isolevelType=ce(e.isolevelType,"sigma"),this.isolevel=ce(e.isolevel,2),this.negateIsolevel=ce(e.negateIsolevel,!1),this.isolevelScroll=ce(e.isolevelScroll,!1),this.smooth=ce(e.smooth,0),this.background=ce(e.background,!1),this.opaqueBack=ce(e.opaqueBack,!0),this.boxSize=ce(e.boxSize,0),this.colorVolume=ce(e.colorVolume,void 0),this.contour=ce(e.contour,!1),this.useWorker=ce(e.useWorker,!0),this.wrap=ce(e.wrap,!1),super.init(e),this.inverseMatrix.copy(this.matrix).invert(),this.build()}attach(e){this.bufferList.forEach(e=>{this.viewer.add(e)}),this.setVisibility(this.visible),e()}prepare(t){if(this.volume){let e;var r;e="sigma"===this.isolevelType?this.volume.getValueForSigma(this.isolevel):this.isolevel,this.negateIsolevel&&(e*=-1),!this.surface||this.__isolevel!==e||this.__smooth!==this.smooth||this.__contour!==this.contour||this.__wrap!==this.wrap||this.__boxSize!==this.boxSize||0<this.boxSize&&!this.__boxCenter.equals(this.boxCenter)?(this.__isolevel=e,this.__smooth=this.smooth,this.__contour=this.contour,this.__wrap=this.wrap,this.__boxSize=this.boxSize,this.__boxCenter.copy(this.boxCenter),this.__box.copy(this.box),r=e=>{this.surface=e,t()},this.useWorker?this.volume.getSurfaceWorker(e,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap,r):r(this.volume.getSurface(e,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap))):t()}else t()}create(){var e={position:this.surface.getPosition(),color:this.surface.getColor(this.getColorParams()),index:this.surface.getIndex()};let t;t=this.contour?new wf(e,this.getBufferParams({wireframe:!1})):(Object.assign(e,{normal:this.surface.getNormal(),picking:this.surface.getPicking()}),e=new yf(e,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1})),new Sf(e)),this.bufferList.push(t)}update(e){if(0!==this.bufferList.length){let t={};(e=e||{}).position&&(t.position=this.surface.getPosition()),e.color&&(t.color=this.surface.getColor(this.getColorParams())),e.index&&(t.index=this.surface.getIndex()),e.normal&&(t.normal=this.surface.getNormal()),this.bufferList.forEach(function(e){e.setAttributes(t)})}}setParameters(e,t,r){return e&&void 0!==e.isolevelType&&this.volume&&("value"===this.isolevelType&&"sigma"===e.isolevelType?this.isolevel=this.volume.getSigmaForValue(this.isolevel):"sigma"===this.isolevelType&&"value"===e.isolevelType&&(this.isolevel=this.volume.getValueForSigma(this.isolevel)),this.isolevelType=e.isolevelType),e&&e.boxCenter&&(this.boxCenter.copy(e.boxCenter),delete e.boxCenter),e&&e.wireframe&&(e.contour||void 0===e.contour&&this.contour)&&(e.wireframe=!1),super.setParameters(e,t,r),e.matrix&&this.inverseMatrix.copy(e.matrix).invert(),this.volume&&this.volume.getBox(this.boxCenter,this.boxSize,this.box),e&&void 0!==e.colorVolume&&t&&(t.color=!0),this.surface&&(void 0!==e.isolevel||void 0!==e.negateIsolevel||void 0!==e.smooth||void 0!==e.wrap||void 0!==e.boxSize||0<this.boxSize&&!this.__box.equals(this.box))&&this.build({position:!0,color:!0,index:!0,normal:!this.contour}),this}getColorParams(){var e=super.getColorParams();return e.volume=this.colorVolume,e}dispose(){this.viewer.signals.ticked.remove(this.setBox,this),super.dispose()}}class o{static zoomScroll(e,t){e.trackballControls.zoom(t)}static clipNearScroll(e,t){var r=e.getParameters();e.setParameters({clipNear:r.clipNear+t/10})}static focusScroll(e,t){var r,i=e.getFocus(),n=Math.sign(t)*(t=.2,(n=5)<(r=(100-i)/10)?r:((2*t-n)*(r=r/n)+(2*n-3*t))*r*r+t);e.setFocus(i+n)}static zoomFocusScroll(e,t){e.trackballControls.zoom(t);t=e.viewer.camera.position.z;e.setFocus(100-Math.abs(t/8))}static isolevelScroll(e,t){let i=Math.sign(t)/10;e.eachRepresentation((e,t)=>{var r;e.repr instanceof Af&&(r=e.getParameters()).isolevelScroll&&e.setParameters({isolevel:r.isolevel+i})})}static panDrag(e,t,r){e.trackballControls.pan(t,r)}static rotateDrag(e,t,r){e.trackballControls.rotate(t,r)}static zRotateDrag(e,t,r){e.trackballControls.zRotate(t,r)}static zoomDrag(e,t,r){e.trackballControls.zoom((t+r)/-2)}static zoomFocusDrag(e,t,r){e.trackballControls.zoom((t+r)/-2);t=e.viewer.camera.position.z;e.setFocus(100-Math.abs(t/8))}static panComponentDrag(e,t,r){e.trackballControls.panComponent(t,r)}static panAtomDrag(e,t,r){e.trackballControls.panAtom(t,r)}static rotateComponentDrag(e,t,r){e.trackballControls.rotateComponent(t,r)}static movePick(e,t){t&&e.animationControls.move(t.position.clone())}static tooltipPick(e,t){var r=e.tooltip;e.getParameters().tooltip&&t?(e=t.mouse.position,r.innerText=t.getLabel(),r.style.bottom=window.innerHeight-e.y+3+"px",r.style.left=e.x+3+"px",r.style.display="block"):r.style.display="none"}static measurePick(e,t){var r;t&&(t.atom||t.bond)?(r=t.atom||t.closestBondAtom,t.component.measurePick(r)):e.measureClear()}}let Mf={default:[["scroll",o.zoomScroll],["scroll-shift",o.focusScroll],["scroll-ctrl",o.isolevelScroll],["scroll-shift-ctrl",o.zoomFocusScroll],["drag-left",o.rotateDrag],["drag-right",o.panDrag],["drag-ctrl-left",o.panDrag],["drag-ctrl-right",o.zRotateDrag],["drag-shift-left",o.zoomDrag],["drag-middle",o.zoomFocusDrag],["drag-ctrl-shift-right",o.panComponentDrag],["drag-ctrl-shift-left",o.rotateComponentDrag],["clickPick-right",o.measurePick],["clickPick-ctrl-left",o.measurePick],["clickPick-middle",o.movePick],["clickPick-left",o.movePick],["hoverPick",o.tooltipPick]],pymol:[["drag-left",o.rotateDrag],["drag-middle",o.panDrag],["drag-right",o.zoomDrag],["scroll",o.focusScroll],["drag-shift-right",o.focusScroll],["clickPick-ctrl+shift-middle",o.movePick],["hoverPick",o.tooltipPick]],coot:[["scroll",o.isolevelScroll],["drag-left",o.rotateDrag],["drag-middle",o.panDrag],["drag-ctrl-left",o.panDrag],["drag-right",o.zoomFocusDrag],["drag-ctrl-right",o.focusScroll],["clickPick-middle",o.movePick],["hoverPick",o.tooltipPick]],astexviewer:[["drag-left",o.rotateDrag],["drag-ctrl-left",o.panDrag],["drag-shift-left",o.zoomDrag],["scroll",o.focusScroll],["clickPick-middle",o.movePick],["hoverPick",o.tooltipPick]]};function Cf(e){e=e.split(/[-+]/);let t="",r=(e.includes("scroll")&&(t="scroll"),e.includes("drag")&&(t="drag"),e.includes("click")&&(t="click"),e.includes("doubleClick")&&(t="doubleClick"),e.includes("hover")&&(t="hover"),e.includes("clickPick")&&(t="clickPick"),e.includes("hoverPick")&&(t="hoverPick"),0),i=(e.includes("alt")&&(r+=1),e.includes("ctrl")&&(r+=2),e.includes("meta")&&(r+=4),e.includes("shift")&&(r+=8),0);return e.includes("left")&&(i+=1),e.includes("right")&&(i+=2),e.includes("middle")&&(i+=4),[t,r,i]}class Tf{constructor(e,t={}){this.stage=e,this.actionList=[],this.mouse=e.mouseObserver,this.disabled=t.disabled||!1,this.preset(t.preset||"default")}run(i,...n){if(!this.disabled){let t=this.mouse.key||0,r=this.mouse.buttons||0;this.actionList.forEach(e=>{e.type===i&&e.key===t&&e.button===r&&e.callback(this.stage,...n)})}}add(e,t){var[e,r,i]=Cf(e);this.actionList.push({type:e,key:r,button:i,callback:t})}remove(e,t){let r=e.includes("*"),[i,n,a]=Cf(e);e=this.actionList.filter(function(e){return!((e.type===i||r&&""===i)&&(e.key===n||r&&0===n)&&(e.button===a||r&&0===a)&&(e.callback===t||void 0===t))});this.actionList=e}preset(e){this.clear(),(Mf[e]||[]).forEach(e=>this.add(e[0],e[1]))}clear(){this.actionList.length=0}}class Ef{static autoView(e){e.autoView(1e3)}static toggleAnimations(e){e.animationControls.toggle()}static toggleRock(e){e.toggleRock()}static toggleSpin(e){e.toggleSpin()}static toggleAntialiasing(e){var t=e.getParameters();e.setParameters({sampleLevel:-1===t.sampleLevel?0:-1})}}let Pf={default:[["i",Ef.toggleSpin],["k",Ef.toggleRock],["p",Ef.toggleAnimations],["a",Ef.toggleAntialiasing],["r",Ef.autoView]]};class If{constructor(e,t={}){this.stage=e,this.actionList=[],this.disabled=t.disabled||!1,this.preset(t.preset||"default")}run(t){this.disabled||this.actionList.forEach(e=>{e.key===t&&e.callback(this.stage)})}add(e,t){this.actionList.push({key:e,callback:t})}remove(t,r){var e=this.actionList.filter(function(e){return!(e.key===t&&(e.callback===r||void 0===r))});this.actionList=e}preset(e){this.clear(),(Pf[e]||[]).forEach(e=>this.add(e[0],e[1]))}clear(){this.actionList.length=0}}class Rf{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this)}_onClick(e,t){e=this.stage.pickingControls.pick(e,t);this.stage.signals.clicked.dispatch(e),this.controls.run("clickPick",e)}_onHover(e,t){e=this.stage.pickingControls.pick(e,t);e&&this.mouse.down.equals(this.mouse.position)&&(this.stage.transformComponent=e.component,this.stage.transformAtom=e.atom),this.stage.signals.hovered.dispatch(e),this.controls.run("hoverPick",e)}dispose(){this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class Df{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.moved.add(this._onMove,this),this.mouse.signals.scrolled.add(this._onScroll,this),this.mouse.signals.dragged.add(this._onDrag,this),this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this),this.mouse.signals.doubleClicked.add(this._onDblclick,this)}_onMove(){this.stage.tooltip.style.display="none"}_onScroll(e){this.controls.run("scroll",e)}_onDrag(e,t){this.controls.run("drag",e,t)}_onClick(e,t){this.controls.run("click",e,t)}_onDblclick(e,t){this.controls.run("doubleClick",e,t)}_onHover(e,t){this.controls.run("hover",e,t)}dispose(){this.mouse.signals.moved.remove(this._onMove,this),this.mouse.signals.scrolled.remove(this._onScroll,this),this.mouse.signals.dragged.remove(this._onDrag,this),this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class Lf{constructor(e){this.stage=e,this.viewer=e.viewer,this.animationControls=e.animationControls,this.viewer.signals.ticked.add(this._onTick,this)}_onTick(e){this.animationControls.run(e)}dispose(){this.viewer.signals.ticked.remove(this._onTick,this)}}let Of=!!rc&&{passive:!0};class kf{constructor(e){this.stage=e,this.stage=e,this.controls=e.keyControls,this.domElement=e.viewer.renderer.domElement,this.domElement.setAttribute("tabIndex","-1"),this.domElement.style.outline="none",this._focusDomElement=this._focusDomElement.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onKeypress=this._onKeypress.bind(this),this.domElement.addEventListener("mousedown",this._focusDomElement),this.domElement.addEventListener("touchstart",this._focusDomElement,Of),this.domElement.addEventListener("keydown",this._onKeydown),this.domElement.addEventListener("keyup",this._onKeyup),this.domElement.addEventListener("keypress",this._onKeypress)}_onKeydown(){}_onKeyup(){}_onKeypress(e){let t;t="key"in KeyboardEvent.prototype?e.key:String.fromCharCode(e.which||e.keyCode),this.controls.run(t)}_focusDomElement(){this.domElement.focus()}dispose(){this.domElement.removeEventListener("mousedown",this._focusDomElement),this.domElement.removeEventListener("touchstart",this._focusDomElement,Of),this.domElement.removeEventListener("keydown",this._onKeypress),this.domElement.removeEventListener("keyup",this._onKeypress),this.domElement.removeEventListener("keypress",this._onKeypress)}}class Nf{constructor(e,t,r,i={}){this.component=e,this.position=t,this.offsetX=ce(i.offsetX,0),this.offsetY=ce(i.offsetY,0),this.visible=ce(i.visible,!0),this.stage=e.stage,this.viewer=e.stage.viewer,this._viewerPosition=new et,this._updateViewerPosition(),this._canvasPosition=new Ue,this._cameraPosition=new et,this.element=document.createElement("div"),Object.assign(this.element.style,{display:"block",position:"absolute",pointerEvents:"none",whiteSpace:"nowrap",left:"-10000px"}),this.viewer.wrapper.appendChild(this.element),this.setContent(r),this.updateVisibility(),this.viewer.signals.rendered.add(this._update,this),this.component.signals.matrixChanged.add(this._updateViewerPosition,this)}setContent(e){var t,r=this.element.style.display;"none"===r&&(this.element.style.left="-10000px",this.element.style.display="block"),e instanceof HTMLElement?this.element.appendChild(e):((t=document.createElement("div")).innerText=e,Object.assign(t.style,{backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.element.appendChild(t)),this._clientRect=this.element.getBoundingClientRect(),"none"===r&&(this.element.style.display=r)}setVisibility(e){this.visible=e,this.updateVisibility()}getVisibility(){return this.visible&&this.component.parameters.visible}updateVisibility(){this.element.style.display=this.getVisibility()?"block":"none"}_updateViewerPosition(){this._viewerPosition.copy(this.position).applyMatrix4(this.component.matrix)}_update(){var e,t,r,i,n,a;this.getVisibility()&&(e=this.element.style,t=this._canvasPosition,r=this._viewerPosition,i=this._clientRect,this._cameraPosition.copy(r).add(this.viewer.translationGroup.position).applyMatrix4(this.viewer.rotationGroup.matrix).sub(this.viewer.camera.position),this._cameraPosition.z<0?e.display="none":(e.display="block",n=this._cameraPosition.length(),a=this.viewer.scene.fog,e.opacity=(1-mh(a.near,a.far,n)).toString(),e.zIndex=Math.round(100*(a.far-n)).toString(),this.stage.viewerControls.getPositionOnCanvas(r,t),e.bottom=this.offsetX+t.y+i.height/2+"px",e.left=this.offsetY+t.x-i.width/2+"px"))}dispose(){this.viewer.wrapper.removeChild(this.element),this.viewer.signals.ticked.remove(this._update,this),this.component.signals.matrixChanged.remove(this._updateViewerPosition,this)}}let Ff=new tt,Bf=new et,Uf=new ri;class zf{constructor(e){this.component=e,this.signals={changed:new n.Signal},this.stage=e.stage,this.viewer=e.stage.viewer}get position(){return this.component.position}get rotation(){return this.component.quaternion}changed(){this.component.updateMatrix(),this.viewer.requestRender(),this.signals.changed.dispatch()}spin(e,t){Ff.copy(this.viewer.rotationGroup.matrix).invert(),Bf.copy(eh(e)).applyMatrix4(Ff),Ff.extractRotation(this.component.transform),Ff.premultiply(this.viewer.rotationGroup.matrix),Ff.invert(),Bf.copy(eh(e)),Bf.applyMatrix4(Ff),Ff.makeRotationAxis(Bf,t),Uf.setFromRotationMatrix(Ff),this.component.quaternion.premultiply(Uf),this.changed()}}let Vf={"":"",vdw:"by vdW radius",covalent:"by covalent radius",sstruc:"by secondary structure",bfactor:"by bfactor",size:"size",data:"data",explicit:"explicit"};class Gf{constructor(e={}){this.max=10,this.type=ce(e.type,"size"),this.scale=ce(e.scale,1),this.size=ce(e.size,1),this.data=ce(e.data,{})}atomRadius(e){let t;switch(this.type){case"vdw":t=e.vdw;break;case"covalent":t=e.covalent;break;case"bfactor":t=e.bfactor||1;break;case"sstruc":var r=e.sstruc;t="h"===r||"g"===r||"i"===r||"e"===r||"b"===r?.25:Tm.includes(e.atomname)?.4:.1;break;case"data":t=ce(this.data[e.index],1);break;case"explicit":null===(t=e.radius)&&(t=this.size);break;default:t=this.size}return Math.min(t*this.scale,this.max)}}Gf.types=Vf;let Hf=new et(-1,-1,-1),$f=new tt;class jf{constructor(e){var t=e.rows,r=t/3,t=new y(t,3),i=new y(3,3),n=new y(1,3),a=new y(3,3),s=new y(3,3),o=Hp(e),e=($p(e,o),zp(t,e),Vp(i,t,t),Yp(i,n,a,s),new et(o[0],o[1],o[2])),t=new et(a.data[0],a.data[3],a.data[6]),i=new et(a.data[1],a.data[4],a.data[7]),s=new et(a.data[2],a.data[5],a.data[8]),o=t.clone().multiplyScalar(Math.sqrt(n.data[0]/r)),a=i.clone().multiplyScalar(Math.sqrt(n.data[1]/r)),n=s.clone().multiplyScalar(Math.sqrt(n.data[2]/r));this.begA=e.clone().sub(o),this.endA=e.clone().add(o),this.begB=e.clone().sub(a),this.endB=e.clone().add(a),this.begC=e.clone().sub(n),this.endC=e.clone().add(n),this.center=e,this.vecA=o,this.vecB=a,this.vecC=n,this.normVecA=t,this.normVecB=i,this.normVecC=s}getBasisMatrix(e=new tt){return e.makeBasis(this.normVecB,this.normVecA,this.normVecC),e.determinant()<0&&e.scale(Hf),e}getRotationQuaternion(e=new ri){return e.setFromRotationMatrix(this.getBasisMatrix($f)),e.invert()}getProjectedScaleForAtoms(e){let i=-1/0,n=-1/0,a=-1/0,s=-1/0,o=-1/0,l=-1/0,h=new et,c=new et,u=this.center,d=this.normVecA,m=this.normVecB,p=this.normVecC;return e.eachAtom(function(e){cd(h.copy(e),d,u);var t=c.subVectors(h,u).normalize().dot(d),r=h.distanceTo(u),t=(0<t?r>i&&(i=r):r>n&&(n=r),cd(h.copy(e),m,u),c.subVectors(h,u).normalize().dot(m)),r=h.distanceTo(u),t=(0<t?r>a&&(a=r):r>s&&(s=r),cd(h.copy(e),p,u),c.subVectors(h,u).normalize().dot(p)),r=h.distanceTo(u);0<t?r>o&&(o=r):r>l&&(l=r)}),{d1a:i,d2a:a,d3a:o,d1b:-n,d2b:-s,d3b:-l}}}class Wf{constructor(e,t,r,i){this.volume=e,this.setFilter(t,r,i)}get header(){return this.volume.header}get matrix(){return this.volume.matrix}get normalMatrix(){return this.volume.normalMatrix}get inverseMatrix(){return this.volume.inverseMatrix}get center(){return this.volume.center}get boundingBox(){return this.volume.boundingBox}get min(){return this.volume.min}get max(){return this.volume.max}get mean(){return this.volume.mean}get rms(){return this.volume.rms}_getFilterHash(e,t,r){return JSON.stringify([e,t,r])}setFilter(i,n,a){i=void 0===(i=isNaN(i)&&this.header?this.header.DMEAN+2*this.header.ARMS:i)||isNaN(i)?-1/0:i,n=ce(n,1/0),a=ce(a,!1);var s=this.volume.data,o=this.volume.position,l=this.volume.atomindex,e=this._getFilterHash(i,n,a);if(e!==this._filterHash){if(i===-1/0&&n===1/0)this.data=s,this.position=o,this.atomindex=l;else{var h=s.length,c=(this._dataBuffer||(this._dataBuffer=new ArrayBuffer(4*h),this._positionBuffer=new ArrayBuffer(3*h*4),l&&(this._atomindexBuffer=new ArrayBuffer(4*h))),new Float32Array(this._dataBuffer)),u=new Float32Array(this._positionBuffer);let t,r=(l&&(t=new Uint32Array(this._atomindexBuffer)),0);for(let e=0;e<h;++e){var d,m=3*e,p=s[e];(!a&&i<=p&&p<=n||a&&(p<i||n<p))&&(d=3*r,c[r]=p,u[0+d]=o[0+m],u[1+d]=o[1+m],u[2+d]=o[2+m],l&&t&&(t[r]=l[e]),r+=1)}this.data=new Float32Array(this._dataBuffer,0,r),this.position=new Float32Array(this._positionBuffer,0,3*r),l&&(this.atomindex=new Int32Array(this._atomindexBuffer,0,r))}this._filterHash=e}}}Wf.prototype.getValueForSigma=uf.prototype.getValueForSigma,Wf.prototype.getSigmaForValue=uf.prototype.getSigmaForValue,Wf.prototype.getDataAtomindex=uf.prototype.getDataAtomindex,Wf.prototype.getDataPosition=uf.prototype.getDataPosition,Wf.prototype.getDataColor=uf.prototype.getDataColor,Wf.prototype.getDataPicking=uf.prototype.getDataPicking,Wf.prototype.getDataSize=uf.prototype.getDataSize;class qf{constructor(e,t){e=Zd({nodeArray1:e.atomIndex1,nodeArray2:e.atomIndex2,edgeCount:e.count,nodeCount:t});this.countArray=e.countArray,this.offsetArray=e.offsetArray,this.indexArray=e.indexArray}}class Xf extends qd{get _defaultFields(){return[["atomIndex1",1,"int32"],["atomIndex2",1,"int32"],["bondOrder",1,"int8"]]}addBond(e,t,r){this.growIfFull();var i=this.count,e=e.index,t=t.index;e<t?(this.atomIndex1[i]=e,this.atomIndex2[i]=t):(this.atomIndex2[i]=e,this.atomIndex1[i]=t),r&&(this.bondOrder[i]=r),this.count+=1}addBondIfConnected(e,t,r){return!!e.connectedTo(t)&&(this.addBond(e,t,r),!0)}}class Yf extends qd{get _defaultFields(){return[["residueIndex",1,"uint32"],["atomTypeId",1,"uint16"],["x",1,"float32"],["y",1,"float32"],["z",1,"float32"],["serial",1,"int32"],["bfactor",1,"float32"],["altloc",1,"uint8"],["occupancy",1,"float32"]]}setAltloc(e,t){this.altloc[e]=t.charCodeAt(0)}getAltloc(e){e=this.altloc[e];return e?String.fromCharCode(e):""}}class Kf extends qd{get _defaultFields(){return[["chainIndex",1,"uint32"],["atomOffset",1,"uint32"],["atomCount",1,"uint32"],["residueTypeId",1,"uint16"],["resno",1,"int32"],["sstruc",1,"uint8"],["inscode",1,"uint8"]]}setSstruc(e,t){this.sstruc[e]=t.charCodeAt(0)}getSstruc(e){e=this.sstruc[e];return e?String.fromCharCode(e):""}setInscode(e,t){this.inscode[e]=t.charCodeAt(0)}getInscode(e){e=this.inscode[e];return e?String.fromCharCode(e):""}}class Zf extends qd{get _defaultFields(){return[["entityIndex",1,"uint16"],["modelIndex",1,"uint16"],["residueOffset",1,"uint32"],["residueCount",1,"uint32"],["chainname",4,"uint8"],["chainid",4,"uint8"]]}setChainname(e,t){e*=4;this.chainname[e]=t.charCodeAt(0),this.chainname[1+e]=t.charCodeAt(1),this.chainname[2+e]=t.charCodeAt(2),this.chainname[3+e]=t.charCodeAt(3)}getChainname(t){let r="";for(let e=0;e<4;++e){var i=this.chainname[4*t+e];if(!i)break;r+=String.fromCharCode(i)}return r}setChainid(e,t){e*=4;this.chainid[e]=t.charCodeAt(0),this.chainid[1+e]=t.charCodeAt(1),this.chainid[2+e]=t.charCodeAt(2),this.chainid[3+e]=t.charCodeAt(3)}getChainid(t){let r="";for(let e=0;e<4;++e){var i=this.chainid[4*t+e];if(!i)break;r+=String.fromCharCode(i)}return r}}class Qf extends qd{get _defaultFields(){return[["chainOffset",1,"uint32"],["chainCount",1,"uint32"]]}}class Jf{constructor(e){this.polymer=e,this.size=e.residueCount}getCenterIterator(s=0){let o=this.getPosition().center,l=o.length/3,h=0,t=-1,c=[new et,new et,new et,new et];return{size:l,next:function(){var e=this.get(t);return t+=1,e},get:function(e){e=Math.min(l-1,Math.max(0,e));var t=c[h%4],r=3*e;if(t.fromArray(o,r),s){var i=Math.min(s,e,l-e-1);for(let e=1;e<=i;++e){var n=3*e,a=(i+1-e)/(i+1);t.x+=a*o[r-n+0]+a*o[r+n],t.y+=a*o[r-n+1]+a*o[r+n+1],t.z+=a*o[r-n+2]+a*o[r+n+2]}t.x/=i+1,t.y/=i+1,t.z/=i+1}return h+=1,t},reset:function(){h=0,t=-1}}}getColor(e){var t=this.polymer,r=t.structure,i=t.residueCount,n=t.residueIndexStart,a=new Float32Array(3*i),t=e||{},s=(t.structure=r,k.getScheme(t)),o=r.getResidueProxy(),l=r.getAtomProxy();for(let e=0;e<i;++e)o.index=n+e,l.index=o.traceAtomIndex,s.atomColorToArray(l,a,3*e);return{color:a}}getPicking(){var e=this.polymer,t=e.structure,r=e.residueCount,i=e.residueIndexStart,n=new Float32Array(r),a=t.getResidueProxy();for(let e=0;e<r;++e)a.index=i+e,n[e]=a.traceAtomIndex;return{picking:new gp(n,t)}}getSize(e){var t=this.polymer,r=t.structure,i=t.residueCount,n=t.residueIndexStart,a=new Float32Array(i),s=new Gf(e),o=r.getResidueProxy(),l=r.getAtomProxy();for(let e=0;e<i;++e)o.index=n+e,l.index=o.traceAtomIndex,a[e]=s.atomRadius(l);return{size:a}}getPosition(){var t=this.polymer,e=t.structure,r=t.residueCount,i=r-3,n=new Float32Array(3*r),a=new Float32Array(3*r),N=new Float32Array(r),s=new Float32Array(r),o=new Float32Array(r),l=new Float32Array(r),h=new Float32Array(3*r),c=new et,u=new et,d=new et,m=new et,p=new et,f=new et,g=new et,v=new et,_=new et,y=new et,b=new et,x=new et(0,0,0),S="trace",w=e.getAtomProxy(),A=e.getAtomProxy(t.getAtomIndexByType(0,S)),M=e.getAtomProxy(t.getAtomIndexByType(1,S)),C=e.getAtomProxy(t.getAtomIndexByType(2,S));for(let e=0;e<i;++e){w.index=A.index,A.index=M.index,M.index=C.index,C.index=t.getAtomIndexByType(e+3,S);var T=3*e,E=(c.subVectors(A,w),u.subVectors(M,A),d.subVectors(C,M),m.subVectors(c,u),p.subVectors(u,d),_.crossVectors(m,p).normalize(),_.toArray(a,T),0<e&&(N[e]=_.angleTo(y)),Math.cos(m.angleTo(p))),P=(l[e]=180/Math.PI*Math.acos(E),m.length()),I=p.length();s[e]=Math.sqrt(I*P)/Math.max(2,2*(1-E)),o[e]=Math.abs(u.dot(_)),f.copy(m).multiplyScalar(s[e]/P),g.copy(p).multiplyScalar(s[e]/I),f.subVectors(A,f),g.subVectors(M,g),f.toArray(n,3+T),g.toArray(n,6+T),b.subVectors(w,x),b.toArray(h,T),y.copy(_),x.copy(f)}f.fromArray(n,3),g.fromArray(n,6),_.subVectors(f,g).normalize(),w.index=t.getAtomIndexByType(0,S),x.copy(w),v.copy(w),cd(v,_,f),v.toArray(n,0),b.subVectors(x,f),b.toArray(h,0),f.fromArray(n,3*r-6),g.fromArray(n,3*r-9),_.subVectors(f,g).normalize(),w.index=t.getAtomIndexByType(r-1,S),x.copy(w),v.copy(w),cd(v,_,f),v.toArray(n,3*r-3);for(let e=r-3;e<r;++e)f.fromArray(n,3*e),w.index=t.getAtomIndexByType(e,S),x.copy(w),b.subVectors(x,f),b.toArray(h,3*e);var R=new Float32Array(r),D=new Float32Array(r),L=new Float32Array(r),O=new Float32Array(r);R[1]=s[0],D[1]=l[0],L[1]=s[0];for(let e=2;e<r-2;++e)R[e]=.5*(s[e-2]+s[e-1]),D[e]=.5*(l[e-2]+l[e-1]),L[e]=.5*(o[e-2]+o[e-1]),f.fromArray(a,3*(e-2)),g.fromArray(a,3*(e-1)),O[e]=180/Math.PI*Math.acos(Math.cos(f.angleTo(g)));R[r-2]=s[r-4],D[r-2]=l[r-4],L[r-2]=o[r-4];var k=new Float32Array(3*r);Zc(a,k,0,0,3),Zc(a,k,0,3,3);for(let e=2;e<r-2;++e)f.fromArray(a,3*(e-2)),g.fromArray(a,3*(e-1)),_.addVectors(g,f).multiplyScalar(.5).normalize(),_.toArray(k,3*e);return Zc(a,k,3*r-12,3*r-6,3),Zc(a,k,3*r-12,3*r-3,3),{center:n,axis:k,bending:O,radius:R,rise:L,twist:D,resdir:h}}}class eg{constructor(e){this.polymer=e,this.helixorient=new Jf(e),this.position=this.helixorient.getPosition()}getAxis(t,r,i,e,n){t=t||30,r=r||2.5,i=void 0!==i&&i;var a=this.polymer,s=a.structure,o=a.residueCount,l=a.residueIndexStart,h=this.position,a=e||{},c=(a.structure=s,k.getScheme(a)),u=new Gf(n);let d=0,m=0;var p,f,g,v=[],_=[],y=[],b=[],x=[],S=[],w=[],A=[],M=[],C=(new Float32Array(3*o),new Float32Array(3*o),new et),T=new et,E=s.getResidueProxy(),P=s.getResidueProxy(),I=s.getAtomProxy(),R=new et,D=new et;let L=!1;for(let e=0;e<o;++e)E.index=l+e,R.fromArray(h.center,3*e),L=(L=e===o-1||(P.index=l+e+1,D.fromArray(h.center,3*e+3),i&&E.sstruc!==P.sstruc)||R.distanceTo(D)>r||h.bending[e]>t?!0:L)&&(d=(e-d<4||(I.index=E.traceAtomIndex,f=h.axis.subarray(3*d+3,3*e),p=h.center.subarray(3*d,3*e+3),f=hd(f).normalize(),g=hd(p),C.fromArray(p),cd(C,f,g),T.fromArray(p,p.length-3),cd(T,f,g),f.subVectors(T,C),f.toArray(v,m),g.toArray(_,m),C.toArray(y,m),T.toArray(b,m),c.atomColorToArray(I,x,m),S.push(I.index),w.push(u.atomRadius(I)),A.push(l+d),M.push(l+e+1-d),m+=3),e),!1);e=new Float32Array(S);return{axis:new Float32Array(v),center:new Float32Array(_),begin:new Float32Array(y),end:new Float32Array(b),color:new Float32Array(x),picking:new gp(e,s),size:new Float32Array(w),residueOffset:A,residueCount:M}}}class tg{constructor(e){this.scoreFunction=e,this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.bubbleUp(this.content.length-1)}pop(){var e=this.content[0],t=this.content.pop();return t&&0<this.content.length&&(this.content[0]=t,this.sinkDown(0)),e}peek(){return this.content[0]}remove(t){var r,i=this.content.length;for(let e=0;e<i;e++)if(this.content[e]===t)return void((r=this.content.pop())&&e!==i-1&&(this.content[e]=r,this.scoreFunction(r)<this.scoreFunction(t)?this.bubbleUp(e):this.sinkDown(e)));throw new Error("Node not found.")}size(){return this.content.length}bubbleUp(e){for(var t=this.content[e];0<e;){var r=Math.floor((e+1)/2)-1,i=this.content[r];if(!(this.scoreFunction(t)<this.scoreFunction(i)))break;this.content[r]=t,this.content[e]=i,e=r}}sinkDown(t){var r=this.content.length,i=this.content[t],n=this.scoreFunction(i);let a=0;for(;;){var s,o=2*(t+1),l=o-1;let e=null;if(l<r&&(s=this.content[l],(a=this.scoreFunction(s))<n)&&(e=l),null===(e=o<r&&(s=this.content[o],this.scoreFunction(s)<(null===e?n:a))?o:e))break;this.content[t]=this.content[e],this.content[e]=i,t=e}}}class rg{constructor(e,t){this.points=e,this.metric=t,this.maxDepth=0,this.currentNode=0;var r=e.length/3,i=new Uint32Array(r);for(let e=0;e<r;++e)i[e]=e;this.indices=i,this.nodes=new Int32Array(4*r),this.rootIndex=this.buildTree(0,-1,0,r)}buildTree(o,e,l,h){o>this.maxDepth&&(this.maxDepth=o);var c=h-l;if(0==c)return-1;var u=4*this.currentNode,d=this.nodes;if(this.currentNode+=1,1==c)d[u]=l,d[1+u]=-1,d[2+u]=-1;else{var m=this.indices,p=this.points,f=l+Math.floor(c/2),g=o%3;let e,t,r,i,n,a=l,s=h-1;for(;s>a;){for(i=p[3*m[r=a+s>>1]+g],t=m[r],m[r]=m[s],m[s]=t,n=a,e=a;e<s;++e)p[3*m[e]+g]<i&&(t=m[n],m[n]=m[e],m[e]=t,++n);if(t=m[s],m[s]=m[n],m[n]=t,f===(r=n))break;f<r?s=r-1:a=r+1}d[u]=f,d[1+u]=this.buildTree(o+1,u,l,f),d[2+u]=this.buildTree(o+1,u,f+1,h)}return d[3+u]=e,u}getNodeDepth(e){e=this.nodes[e+3];return-1===e?0:this.getNodeDepth(e)+1}nearest(u,d,m){let p=new tg(e=>-e[1]),f=this.nodes,g=this.points,v=this.indices,_=e=>{let t,r;var i=this.getNodeDepth(e)%3,n=3*v[f[e]],a=[g[0+n],g[1+n],g[2+n]],s=this.metric(u,a);function o(e,t){p.push([e,t]),p.size()>d&&p.pop()}var l=f[e+1],h=f[e+2];if(-1===h&&-1===l)(p.size()<d||s<p.peek()[1])&&s<=m&&o(e,s);else{t=-1===h||-1!==l&&u[i]<=g[n+i]?l:h,_(t),(p.size()<d||s<p.peek()[1])&&s<=m&&o(e,s);var c=[];for(let e=0;e<3;e+=1)e===i?c[e]=u[e]:c[e]=g[n+e];e=this.metric(c,a);(p.size()<d||Math.abs(e)<p.peek()[1])&&Math.abs(e)<=m&&-1!==(r=t===l?h:l)&&_(r)}};_(this.rootIndex);var r=[];for(let e=0,t=Math.min(p.size(),d);e<t;e+=1)r.push(p.content[e]);return r}verify(e,t=0){let r=1;if(-1===(e=void 0===e?this.rootIndex:e))throw new Error("node is null");var i=t%3,n=this.nodes,a=this.points,s=this.indices,o=n[e+1],l=n[e+2];if(-1!==o){if(a[3*s[n[o]]+i]>a[3*s[n[e]]+i])throw new Error("left child is > parent!");r+=this.verify(o,t+1)}if(-1!==l){if(a[3*s[n[l]]+i]<a[3*s[n[e]]+i])throw new Error("right child is < parent!");r+=this.verify(l,t+1)}return r}}class ig{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get bondHash(){return this.structure.bondHash}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainIndex(){return this.residueStore.chainIndex[this.residueIndex]}get residue(){return console.warn("residue - might be expensive"),this.structure.getResidueProxy(this.residueIndex)}get residueIndex(){return this.atomStore.residueIndex[this.index]}set residueIndex(e){this.atomStore.residueIndex[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.residueIndex)}get inscode(){return this.residueStore.getInscode(this.residueIndex)}get resno(){return this.residueStore.resno[this.residueIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.residueIndex])}get atomType(){return this.atomMap.get(this.atomStore.atomTypeId[this.index])}get residueAtomOffset(){return this.residueStore.atomOffset[this.residueIndex]}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get atomname(){return this.atomType.atomname}get number(){return this.atomType.number}get element(){return this.atomType.element}get vdw(){return this.atomType.vdw}get covalent(){return this.atomType.covalent}get x(){return this.atomStore.x[this.index]}set x(e){this.atomStore.x[this.index]=e}get y(){return this.atomStore.y[this.index]}set y(e){this.atomStore.y[this.index]=e}get z(){return this.atomStore.z[this.index]}set z(e){this.atomStore.z[this.index]=e}get serial(){return this.atomStore.serial[this.index]}set serial(e){this.atomStore.serial[this.index]=e}get bfactor(){return this.atomStore.bfactor[this.index]}set bfactor(e){this.atomStore.bfactor[this.index]=e}get occupancy(){return this.atomStore.occupancy[this.index]}set occupancy(e){this.atomStore.occupancy[this.index]=e}get altloc(){return this.atomStore.getAltloc(this.index)}set altloc(e){this.atomStore.setAltloc(this.index,e)}get partialCharge(){return this.atomStore.partialCharge?this.atomStore.partialCharge[this.index]:null}set partialCharge(e){this.atomStore.partialCharge&&(this.atomStore.partialCharge[this.index]=e)}get radius(){return this.atomStore.radius?this.atomStore.radius[this.index]:null}set radius(e){this.atomStore.radius&&(this.atomStore.radius[this.index]=e)}get formalCharge(){return this.atomStore.formalCharge?this.atomStore.formalCharge[this.index]:null}set formalCharge(e){this.atomStore.formalCharge&&(this.atomStore.formalCharge[this.index]=e)}get aromatic(){return this.atomStore.aromatic?this.atomStore.aromatic[this.index]:this.residueType.isAromatic(this)?1:0}set aromatic(e){this.atomStore.aromatic&&(this.atomStore.aromatic[this.index]=e)}get bondCount(){return this.bondHash.countArray[this.index]}eachBond(t,r){r=r||this.structure._bp;var e=this.index,i=this.bondHash,n=i.indexArray,a=i.countArray[e],s=i.offsetArray[e];for(let e=0;e<a;++e)r.index=n[s+e],t(r)}eachBondedAtom(t,e){let r=e||this.structure._ap,i=this.index;this.eachBond(function(e){r.index=i!==e.atomIndex1?e.atomIndex1:e.atomIndex2,t(r)}),this.index=i}hasBondTo(t){let r=!1;return this.eachBondedAtom(function(e){t.index===e.index&&(r=!0)}),r}bondToElementCount(t){let r=0;var e=this.index;return this.eachBondedAtom(function(e){e.number===t&&(r+=1)}),this.index=e,r}hasBondToElement(e){return 0<this.bondToElementCount(e)}isBackbone(){var e=this.residueType.backboneIndexList;return 0<e.length&&e.includes(this.index-this.residueAtomOffset)}isPolymer(){var e;return 0<this.structure.entityList.length?this.entity.isPolymer():3===(e=this.residueType.moleculeType)||4===e||5===e}isSidechain(){return this.isPolymer()&&!this.isBackbone()}isCg(){var e=this.residueType.backboneType;return 4===e||5===e||6===e}isTrace(){return this.index===this.residueType.traceAtomIndex+this.residueAtomOffset}isHetero(){return 1===this.residueType.hetero}isProtein(){return 3===this.residueType.moleculeType}isNucleic(){var e=this.residueType.moleculeType;return 4===e||5===e}isRna(){return 4===this.residueType.moleculeType}isDna(){return 5===this.residueType.moleculeType}isWater(){return 1===this.residueType.moleculeType}isIon(){return 2===this.residueType.moleculeType}isSaccharide(){return 6===this.residueType.moleculeType}isHelix(){return om.includes(this.sstruc)}isSheet(){return lm.includes(this.sstruc)}isTurn(){return hm.includes(this.sstruc)&&this.isProtein()}isBonded(){return 0!==this.bondHash.countArray[this.index]}isRing(){return void 0!==this.residueType.getRings().atomRings[this.index-this.residueAtomOffset]}isAromatic(){return 1===this.aromatic}isPolarHydrogen(){return 1===this.number&&!this.hasBondToElement(6)}isMetal(){return this.atomType.isMetal()}isNonmetal(){return this.atomType.isNonmetal()}isMetalloid(){return this.atomType.isMetalloid()}isHalogen(){return this.atomType.isHalogen()}isDiatomicNonmetal(){return this.atomType.isDiatomicNonmetal()}isPolyatomicNonmetal(){return this.atomType.isPolyatomicNonmetal()}isAlkaliMetal(){return this.atomType.isAlkaliMetal()}isAlkalineEarthMetal(){return this.atomType.isAlkalineEarthMetal()}isNobleGas(){return this.atomType.isNobleGas()}isTransitionMetal(){return this.atomType.isTransitionMetal()}isPostTransitionMetal(){return this.atomType.isPostTransitionMetal()}isLanthanide(){return this.atomType.isLanthanide()}isActinide(){return this.atomType.isActinide()}getDefaultValence(){return this.atomType.getDefaultValence()}getValenceList(){return this.atomType.getValenceList()}getOuterShellElectronCount(){return this.atomType.getOuterShellElectronCount()}distanceTo(e){var t=this.atomStore,r=e.atomStore,i=this.index,e=e.index,n=t.x[i]-r.x[e],a=t.y[i]-r.y[e],t=t.z[i]-r.z[e];return Math.sqrt(n*n+a*a+t*t)}connectedTo(e){var t=this.atomStore,r=e.atomStore,i=this.index,n=e.index;if(t.altloc&&r.altloc){var a=t.altloc[i],s=r.altloc[n];if(0!==a&&0!==s&&32!==a&&32!==s&&a!==s)return!1}var a=t.x[i]-r.x[n],s=t.y[i]-r.y[n],t=t.z[i]-r.z[n],i=a*a+s*s+t*t;return!!(i<48&&this.isCg())||!isNaN(i)&&(n=(r=this.covalent+e.covalent)-.5,i<(a=r+.3)*a)&&n*n<i}positionFromArray(e,t=0){return this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this}positionToArray(e=[],t=0){var r=this.index,i=this.atomStore;return e[t+0]=i.x[r],e[t+1]=i.y[r],e[t+2]=i.z[r],e}positionToVector3(e){return(e=void 0===e?new et:e).x=this.x,e.y=this.y,e.z=this.z,e}positionFromVector3(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}positionAdd(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}positionSub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}getResidueBonds(e=!1){var t=this.residueAtomOffset,r=this.index-this.residueAtomOffset,i=this.residueType.getBonds(),n=i.atomIndices1,a=i.atomIndices2;let s,o,l,h;for(e||(h=[]),s=n.indexOf(r);-1!==s;){if(l=a[s]+t,!h)return l;h.push(l),s=n.indexOf(r,s+1)}for(o=a.indexOf(r);-1!==o;){if(l=n[o]+t,!h)return l;h.push(l),o=a.indexOf(r,o+1)}return h}qualifiedName(e=!1){var t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chainname&&(t+=":"+this.chainname),this.atomname&&(t+="."+this.atomname),this.altloc&&(t+="%"+this.altloc),1<this.structure.modelStore.count&&(t+="/"+this.modelIndex),t}clone(){return new ig(this.structure,this.index)}toObject(){return{index:this.index,residueIndex:this.residueIndex,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,modelIndex:this.modelIndex}}}function ng(e,t){var r=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return r*r+i*i+e*e}function ag(e,t){return Math.sqrt(ng(e,t))}let sg=new Float32Array(3);class og{constructor(e,t=!1){Je.Debug&&rt.time("Kdtree build");t=t?ng:ag;let r=new Float32Array(3*e.atomCount),i=new Uint32Array(e.atomCount),n=0;e.eachAtom(function(e){r[n+0]=e.x,r[n+1]=e.y,r[n+2]=e.z,i[n/3]=e.index,n+=3}),this.atomIndices=i,this.points=r,this.kdtree=new rg(r,t),Je.Debug&&rt.timeEnd("Kdtree build")}nearest(e,t,r){e instanceof et?e.toArray(sg):e instanceof ig&&e.positionToArray(sg);var i=this.kdtree.nearest(sg,t,r),n=this.kdtree.indices,a=this.kdtree.nodes,s=this.atomIndices,o=[];for(let e=0,t=i.length;e<t;++e){var l=i[e],h=l[0];o.push({index:s[n[a[h]]],distance:l[1]})}return o}}let lg={" ":"X","!":"Y","#":"Z",$:"-X","%":"-Y","&":"-Z","'":"Y+1/2","(":"1/2+X",")":"1/2+Y","*":"1/2-X","+":"1/2+Z",",":"1/2-Y","-":"1/2-Z",".":"X+1/2","/":"Z+1/2",0:"-X+1/2",1:"-Y+1/2",2:"-Z+1/2",3:"1/4+X",4:"1/4-Y",5:"1/4+Z",6:"1/4-X",7:"1/4+Y",8:"3/4-Y",9:"3/4+Z",":":"3/4+Y",";":"3/4+X","<":"3/4-X","=":"1/4-Z",">":"3/4-Z","?":"X-Y","@":"Y-X",A:"Z+1/3",B:"Z+2/3",C:"X+2/3",D:"Y+1/3",E:"-Y+2/3",F:"X-Y+1/3",G:"Y-X+2/3",H:"-X+1/3",I:"X+1/3",J:"Y+2/3",K:"-Y+1/3",L:"X-Y+2/3",M:"Y-X+1/3",N:"-X+2/3",O:"2/3+X",P:"1/3+Y",Q:"1/3+Z",R:"2/3-Y",S:"1/3+X-Y",T:"2/3+Y-X",U:"1/3-X",V:"2/3-X",W:"1/3-Y",X:"1/3-Z",Y:"2/3+Y",Z:"1/3+Y-X","[":"2/3+X-Y","]":"1/3+X","^":"2/3+Z",_:"2/3-Z","`":"5/6+Z",a:"1/6+Z",b:"5/6-Z",c:"1/6-Z",d:"Z+5/6",e:"Z+1/6",f:"Z+1/4",g:"+Y"},hg={"P 1":" !#","P -1":" !#$%&","P 1 2 1":" !#$!&","P 1 21 1":" !#$'&","C 1 2 1":" !#$!&()#*)&","P 1 m 1":" !# %#","P 1 c 1":" !# %+","C 1 m 1":" !# %#()#(,#","C 1 c 1":" !# %+()#(,+","P 1 2/m 1":" !# %#$!&$%&","P 1 21/m 1":" !#$)&$%& ,#","C 1 2/m 1":" !# %#$!&$%&()#(,#*)&*,&","P 1 2/c 1":" !#$!-$%& %+","P 1 21/c 1":" !#$%&$)- ,+","C 1 2/c 1":" !#$!-$%& %+()#*)-*,&(,+","P 2 2 2":" !#$%#$!& %&","P 2 2 21":" !#$%+$!- %&","P 21 21 2":" !#$%#*)&(,&","P 21 21 21":" !#*%+$)-(,&","C 2 2 21":" !#$%+$!- %&()#*,+*)-(,&","C 2 2 2":" !#$%#$!& %&()#*,#*)&(,&","F 2 2 2":" !#$%#$!& %& )+$,+$)- ,-(!+*%+*!-(%-()#*,#*)&(,&","I 2 2 2":" !#$%# %&$!&.'/01/.120'2","I 21 21 21":" !#*%+$)-(,&()+$,#*!& %-","P m m 2":" !#$%# %#$!#","P m c 21":" !#$%+ %+$!#","P c c 2":" !#$%# %+$!+","P m a 2":" !#$%#(%#*!#","P c a 21":" !#$%+(%#*!+","P n c 2":" !#$%# ,+$)+","P m n 21":" !#*%+(%+$!#","P b a 2":" !#$%#(,#*)#","P n a 21":" !#$%+(,#*)+","P n n 2":" !#$%#(,+*)+","C m m 2":" !#$%# %#$!#()#*,#(,#*)#","C m c 21":" !#$%+ %+$!#()#*,+(,+*)#","C c c 2":" !#$%# %+$!+()#*,#(,+*)+","A m m 2":" !#$%# %#$!# )+$,+ ,+$)+","A b m 2":" !#$%# ,#$)# )+$,+ %+$!+","A m a 2":" !#$%#(%#*!# )+$,+(,+*)+","A b a 2":" !#$%#(,#*)# )+$,+(%+*!+","F m m 2":" !#$%# %#$!# )+$,+ ,+$)+(!+*%+(%+*!+()#*,#(,#*)#","F d d 2":" !#$%#345675 )+$,+3896:9(!+*%+;49<79()#*,#;85<:5","I m m 2":" !#$%# %#$!#()+*,+(,+*)+","I b a 2":" !#$%#(,#*)#()+*,+ %+$!+","I m a 2":" !#$%#(%#*!#()+*,+ ,+$)+","P 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#","P 2/n 2/n 2/n":" !#$%#$!& %&*,-()-(,+*)+","P 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+","P 2/b 2/a 2/n":" !#$%#$!& %&*,&()&(,#*)#","P 21/m 2/m 2/a":" !#*%#$!&(%&$%&(!& %#*!#","P 2/n 21/n 2/a":" !#*%#*)- ,-$%&(!&(,+$)+","P 2/m 2/n 21/a":" !#*%+*!- %&$%&(!-(%+$!#","P 21/c 2/c 2/a":" !#*%#$!-(%-$%&(!& %+*!+","P 21/b 21/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#","P 21/c 21/c 2/n":" !#*,#$)-(%-$%&()& ,+*!+","P 2/b 21/c 21/m":" !#$%+$)- ,&$%& !- ,+$)#","P 21/n 21/n 2/m":" !#$%#*)-(,-$%& !&(,+*)+","P 21/m 21/m 2/n":" !#$%#*'&.,&*,&.'& %#$!#","P 21/b 2/c 21/n":" !#*,+$!-(,&$%&()- %+*)#","P 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#","P 21/n 21/m 21/a":" !#0%/$'&.12$%&.!2 1#0'/","C 2/m 2/c 21/m":" !#$%+$!- %&$%& !- %+$!#()#*,+*)-(,&*,&()-(,+*)#","C 2/m 2/c 21/a":" !#$,+$)- %&$%& )- ,+$!#()#*%+*!-(,&*,&(!-(%+*)#","C 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()#*,#*)&(,&*,&()&(,#*)#","C 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+()#*,#*)-(,-*,&()&(,+*)+","C 2/m 2/m 2/a":" !#$,#$)& %&$%& )& ,#$!#()#*%#*!&(,&*,&(!&(%#*)#","C 2/c 2/c 2/a":" !#*,#$!&(,&$,-(!- ,+*!+()#$%#*)& %&*%- )-(%+$)+","F 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!# )+$,+$)- ,-$,- )- ,+$)+(!+*%+*!-(%-*%-(!-(%+*!+()#*,#*)&(,&*,&()&(,#*)#","F 2/d 2/d 2/d":" !#$%#$!& %&64=37=345675 )+$,+$)- ,-68>3:>3896:9(!+*%+*!-(%-<4>;7>;49<79()#*,#*)&(,&<8=;:=;85<:5","I 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()+*,+*)-(,-*,-()-(,+*)+","I 2/b 2/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#()+*,+$!- %-*,-()- %+$!+","I 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#()+$,#*!& %-*,- )&(%#$!+","I 21/m 21/m 21/a":" !#$,#$)& %&$%& )& ,#$!#()+*%+*!-(,-*,-(!-(%+*)+","P 4":" !#$%#% #!$#","P 41":" !#$%+% 5!$9","P 42":" !#$%#% +!$+","P 43":" !#$%+% 9!$5","I 4":" !#$%#% #!$#()+*,+,(+)*+","I 41":" !#*,+%(5)$9()+$%#, 9!*5","P -4":" !#$%#!$&% &","I -4":" !#$%#!$&% &()+*,+)*-,(-","P 4/m":" !#$%#% #!$#$%& !&!$&% &","P 42/m":" !#$%#% +!$+$%& !&!$-% -","P 4/n":" !#$%#,(#)*#*,&()&!$&% &","P 42/n":" !#$%#,(+)*+*,-()-!$&% &","I 4/m":" !#$%#% #!$#$%& !&!$&% &()+*,+,(+)*+*,-()-)*-,(-","I 41/a":" !#*,+%(5)$9$,=(!>!$&,(-()+$%#, 9!*5*%> )=)*-% &","P 4 2 2":" !#$%#% #!$#$!& %&! &%$&","P 4 21 2":" !#$%#,(#)*#*)&(,&! &%$&","P 41 2 2":" !#$%+% 5!$9$!& %-! >%$=","P 41 21 2":" !#$%+,(5)*9*)=(,>! &%$-","P 42 2 2":" !#$%#% +!$+$!& %&! -%$-","P 42 21 2":" !#$%#,(+)*+*)-(,-! &%$&","P 43 2 2":" !#$%+% 9!$5$!& %-! =%$>","P 43 21 2":" !#$%+,(9)*5*)>(,=! &%$-","I 4 2 2":" !#$%#% #!$#$!& %&! &%$&()+*,+,(+)*+*)-(,-)(-,*-","I 41 2 2":" !#*,+%(5)$9*!> ,=)(-%$&()+$%#, 9!*5$)=(%>! &,*-","P 4 m m":" !#$%#% #!$# %#$!#%$#! #","P 4 b m":" !#$%#% #!$#(,#*)#,*#)(#","P 42 c m":" !#$%#% +!$+ %+$!+%$#! #","P 42 n m":" !#$%#,(+)*+(,+*)+%$#! #","P 4 c c":" !#$%#% #!$# %+$!+%$+! +","P 4 n c":" !#$%#% #!$#(,+*)+,*+)(+","P 42 m c":" !#$%#% +!$+ %#$!#%$+! +","P 42 b c":" !#$%#% +!$+(,#*)#,*+)(+","I 4 m m":" !#$%#% #!$# %#$!#%$#! #()+*,+,(+)*+(,+*)+,*+)(+","I 4 c m":" !#$%#% #!$# %+$!+%$+! +()+*,+,(+)*+(,#*)#,*#)(#","I 41 m d":" !#*,+%(5)$9 %#*)+%*5) 9()+$%#, 9!*5(,+$!#,$9!(5","I 41 c d":" !#*,+%(5)$9 %+*)#%*9) 5()+$%#, 9!*5(,#$!+,$5!(9","P -4 2 m":" !#$%#% &!$&$!& %&%$#! #","P -4 2 c":" !#$%#% &!$&$!- %-%$+! +","P -4 21 m":" !#$%#% &!$&*)&(,&,*#)(#","P -4 21 c":" !#$%#% &!$&*)-(,-,*+)(+","P -4 m 2":" !#$%#!$&% & %#$!#! &%$&","P -4 c 2":" !#$%#% &!$& %+$!+! -%$-","P -4 b 2":" !#$%#% &!$&(,#*)#)(&,*&","P -4 n 2":" !#$%#% &!$&(,+*)+)(-,*-","I -4 m 2":" !#$%#% &!$& %#$!#! &%$&()+*,+,(-)*-(,+*)+)(-,*-","I -4 c 2":" !#$%#% &!$& %+$!+! -%$-()+*,+,(-)*-(,#*)#)(&,*&","I -4 2 m":" !#$%#% &!$&$!& %&%$#! #()+*,+,(-)*-*)-(,-,*+)(+","I -4 2 d":" !#$%#% &!$&*!>(%>,$9) 9()+*,+,(-)*-$)= ,=%*5!(5","P 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #","P 4/m 2/c 2/c":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +","P 4/n 2/b 2/m":" !#$%#% #!$#$!& %&! &%$&*,&()&)*&,(&(,#*)#,*#)(#","P 4/n 2/n 2/c":" !#$%#% #!$#$!& %&! &%$&*,-()-)*-,(-(,+*)+,*+)(+","P 4/m 21/b 2/m":" !#$%#% #!$#*)&(,&)(&,*&$%& !&!$&% &(,#*)#,*#)(#","P 4/m 21/n 2/c":" !#$%#% #!$#*)-(,-)(-,*-$%& !&!$&% &(,+*)+,*+)(+","P 4/n 21/m 2/m":" !#$%#,(#)*#*)&(,&! &%$&*,&()&!$&% & %#$!#,*#)(#","P 4/n 2/c 2/c":" !#$%#,(#)*#*)-(,-! -%$-*,&()&!$&% & %+$!+,*+)(+","P 42/m 2/m 2/c":" !#$%#% +!$+$!& %&! -%$-$%& !&!$-% - %#$!#%$+! +","P 42/m 2/c 2/m":" !#$%#% +!$+$!- %-! &%$&$%& !&!$-% - %+$!+%$#! #","P 42/n 2/b 2/c":" !#$%#,(+)*+$!- %-)(&,*&*,-()-!$&% &(,#*)#%$+! +","P 42/n 2/n 2/m":" !#$%#,(+)*+$!& %&)(-,*-*,-()-!$&% &(,+*)+%$#! #","P 42/m 21/b 2/c":" !#$%#% +!$+*)&(,&)(-,*-$%& !&!$-% -(,#*)#,*+)(+","P 42/m 21/n 2/m":" !#$%#,./'*/*'-.,-! &%$&$%& !&'*-,.-.,/*'/%$#! #","P 42/n 21/m 2/c":" !#$%#,(+)*+*)-(,-! &%$&*,-()-!$&% & %#$!#,*+)(+","P 42/n 21/c 2/m":" !#$%#,(+)*+*)&(,&! -%$-*,-()-!$&% & %+$!+,*#)(#","I 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #()+*,+,(+)*+*)-(,-)(-,*-*,-()-)*-,(-(,+*)+,*+)(+","I 4/m 2/c 2/m":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +()+*,+,(+)*+*)&(,&)(&,*&*,-()-)*-,(-(,#*)#,*#)(#","I 41/a 2/m 2/d":" !#*,+%(5)$9*!> ,=)(-%$&$,=(!>!$&,(-(,+$!#,$9!(5()+$%#, 9!*5$)=(%>! &,*-*%> )=)*-% & %#*)+%*5) 9","I 41/a 2/c 2/d":" !#*,+%(5)$9*!= ,>)(&%$-$,=(!>!$&,(-(,#$!+,$5!(9()+$%#, 9!*5$)>(%=! -,*&*%> )=)*-% & %+*)#%*9) 5","P 3":" !#%?#@$#","P 31":" !#%?A@$B","P 32":" !#%?B@$A","H 3":" !#%?#@$#CDAEFAGHAIJBKLBMNB","R 3":" !## !!# ","P -3":" !#%?#@$#$%&!@&? &","H -3":" !#%?#@$#$%&!@&? &OPQRSQTUQVWXYZX[]X]Y^W[^ZV^UR_PT_SO_","R -3":" !## !!# $%&&$%%&$","P 3 1 2":" !#%?#@$#%$&@!& ?&","P 3 2 1":" !#%?#@$#! &?%&$@&","P 31 1 2":" !#%?Q@$^%$_@!X ?&","P 31 2 1":" !#%?A@$B! &?%_$@X","P 32 1 2":" !#%?^@$Q%$X@!_ ?&","P 32 2 1":" !#%?B@$A! &?%X$@_","H 3 2":" !#%?#@$#! &?%&$@&OPQRSQTUQY]X[WXVZX]Y^W[^ZV^PO_SR_UT_","R 3 2":" !## !!# %$&$&%&%$","P 3 m 1":" !#%?#@$#%$#@!# ?#","P 3 1 m":" !#%?#@$#! #?%#$@#","P 3 c 1":" !#%?#@$#%$+@!+ ?+","P 3 1 c":" !#%?#@$#! +?%+$@+","H 3 m":" !#%?#@$#%$#@!# ?#OPQRSQTUQRUQTPQOSQ]Y^W[^ZV^WV^ZY^][^","R 3 m":" !## !!# ! # #!#! ","H 3 c":" !#%?#@$#%$+@!+ ?+OPQRSQTUQRU`TP`OS`]Y^W[^ZV^WVaZYa][a","R 3 c":" !## !!# '././'/'.","P -3 1 2/m":" !#%?#@$#%$&@!& ?&$%&!@&? &! #?%#$@#","P -3 1 2/c":" !#%?#@$#%$-@!- ?-$%&!@&? &! +?%+$@+","P -3 2/m 1":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#","P -3 2/c 1":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+","H -3 2/m":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#OPQRSQTUQY]X[WXVZXVWXYZX[]XRUQTPQOSQ]Y^W[^ZV^PO_SR_UT_UR_PT_SO_WV^ZY^][^","R -3 2/m":" !## !!# %$&$&%&%$$%&&$%%&$! # #!#! ","H -3 2/c":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+OPQRSQTUQY]b[WbVZbVWXYZX[]XRU`TP`OS`]Y^W[^ZV^POcSRcUTcUR_PT_SO_WVaZYa][a","R -3 2/c":" !## !!# 102021210$%&&$%%&$'././'/'.","P 6":" !#%?#@$#$%#!@#? #","P 61":" !#%?A@$B$%/!@d? e","P 65":" !#%?B@$A$%/!@e? d","P 62":" !#%?^@$Q$%#!@^? Q","P 64":" !#%?Q@$^$%#!@Q? ^","P 63":" !#%?#@$#$%+!@+? +","P -6":" !#%?#@$# !&%?&@$&","P 6/m":" !#%?#@$#$%#!@#? #$%&!@&? & !&%?&@$&","P 63/m":" !#%?#@$#$%+!@+? +$%&!@&? & !-%?-@$-","P 6 2 2":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&","P 61 2 2":" !#%?Q@$^$%+!@`? a! X?%&$@_%$b@!- ?c","P 65 2 2":" !#%?^@$Q$%+!@a? `! _?%&$@X%$c@!- ?b","P 62 2 2":" !#%?^@$Q$%#!@^? Q! _?%&$@X%$_@!& ?X","P 64 2 2":" !#%?Q@$^$%#!@Q? ^! X?%&$@_%$X@!& ?_","P 63 2 2":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-","P 6 m m":" !#%?#@$#$%#!@#? #%$#@!# ?#! #?%#$@#","P 6 c c":" !#%?#@$#$%#!@#? #%$+@!+ ?+! +?%+$@+","P 63 c m":" !#%?#@$#$%+!@+? +%$+@!+ ?+! #?%#$@#","P 63 m c":" !#%?#@$#$%+!@+? +%$#@!# ?#! +?%+$@+","P -6 m 2":" !#%?#@$# !&%?&@$&%$#@!# ?#%$&@!& ?&","P -6 c 2":" !#%?#@$# !-%?-@$-%$+@!+ ?+%$&@!& ?&","P -6 2 m":" !#%?#@$# !&%?&@$&! &?%&$@&! #?%#$@#","P -6 2 c":" !#%?#@$# !-%?-@$-! &?%&$@&! +?%+$@+","P 6/m 2/m 2/m":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&$%&!@&? & !&@$&%?&%$#@!# ?#! #?%#$@#","P 6/m 2/c 2/c":" !#%?#@$#$%#!@#? #! -?%-$@-%$-@!- ?-$%&!@&? & !&@$&%?&%$+@!+ ?+! +?%+$@+","P 63/m 2/c 2/m":" !#%?#@$#$%+!@+? +! -?%-$@-%$&@!& ?&$%&!@&? & !-@$-%?-%$+@!+ ?+! #?%#$@#","P 63/m 2/m 2/c":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-$%&!@&? & !-@$-%?-%$#@!# ?#! +?%+$@+","P 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ","F 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%&  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ","I 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(","P 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(","I 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- ","P 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$","P 2/n -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& *,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","F 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-($,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- *,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$","F 2/d -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& 64=37=345675=64=375345674=67=3453756 )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(68>3:>3896:9=<8=;:5;85<:4><7>;49;79<(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(<4>;7>;49<79>68>3:93896:8=<:=;85;:5<()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- <8=;:=;8f<:f><4>;79;49<78>6:>3893:96","I 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","P 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*","I 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*()+$,#*g& %-+()#$,&*!- %)+(,#$!&*%- *,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$","P 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$","P 42 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","F 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$","F 41 3 2":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46 )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<(!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86","I 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","P 43 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7;>46=:<5839398<5:6=4;>75:<983>7;=46","P 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<","I 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46","P -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ","F -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&%  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(+%*+!*-%(- +)$+,$-) -,#)(#,*&)*&,((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() +,$+)$-, -(#)*#,*&)(&,+!(+%*-!*-%(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(#,*#)*&,(&(+!*+%*-!(-%+) +,$-)$-, ","I -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","P -4 3 n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","F -4 3 c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() #,$#)$&, &(#!*#%*&!(&%+! +%$-!$-% (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(#%*#!*&%(& +!$+%$-! -%#) #,$&)$&, ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! +%$+!$-% - #)$#,$&) &,#!(#%*&!*&%(","I -4 3 d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7354<9:6>8;=357<946>:;=857394<>:6=8;()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- :;98657<=43>;9:658<=73>49:;586=7<>43","P 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","P 4/n -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/m -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/n -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","F 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#!  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*%*+!(+%(-!*-$-) -, +)$+,&,(&)*#,*#)((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%**%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*,$+) +, -)$-*&)(&,(#)*#,-%(-!*+%*+!(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$*,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$,*#)(#,(&)*&*-!(-%(+!*+%-, -)$+,$+) ","F 4/m -3 2/c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() &,$&)$#, #(#%*#!*&%(&!+!$+% -! -%$$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*,$#) #, &)$&*&!(&%(#!*#%-% -!$+%$+! (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(&%*&!*#%(# +%$+!$-% -!#)$#, &) &,$*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*%*#!(#%(&!*&$-! -% +!$+%&, &)$#,$#) ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! -%$-!$+% + #,$#)$&, &)#!*#%(&!(&%**,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$%$+! +% -!$-$&) &, #)$#,&%(&!*#%*#!(","F 41/d -3 2/m":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=4664=3:>;85<79=64>3:5;89<74=6:>385;79<,$+! #%(-)*&*&)(-% #!$+,-%(&)*+,$#!  )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<68>37=;49<:5=<8>;753496:4><:=;893756,*#!(+% &)$-*-!(&, +)$#%-, &!$+%*#)((!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<<4>;:=389675>68=379;45<:8=<7>;453:96%$#) +,(&!*-$&! -,(#)*+%&% -)$#,*+!(()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86<8=;7>3456:9><4=;:9385678>67=349;:5<%*+)(#, -!$&$-) &%(+!*#,&,(-!*#%$+) ","F 41/d -3 2/c":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46<8>;7=3496:5><8=;793456:8><7=;493:56%*#)(+, &!$-$-! &,(+)*#%&, -!$#%*+)( )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<<4=;:>385679>64=3:9;85<78=67>345;:9<%$+) #,(-!*&$&) -%(#!*+,&%(-)*#,$+! (!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<68=37>;45<:9=<4>;:5389674>6:=389;75<,*+!(#% -)$&*-)(&% +!$#,-,(&!*+%$#) ()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>8664>3:=;89<75=68>375;49<:4=<:>;853796,$#! +%(&)*-*&!(-, #)$+%-% &)$+,*#!(","I 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","I 41/a -3 2/d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<$%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*4<97358;=:6>6>:;=8357<94=8;>:694<573()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46*,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$865:;943>7<=<=73>4;9:658>43=7<5869:;","P 1 1 2":" !#$%#","P 1 1 21":" !#$%+","B 1 1 2":" !#$%#(g+*%+","A 1 2 1":" !#$!& )+$)-","C 1 21 1":" !#$)&()#*!&","I 1 2 1":" !#$!&.'/0'2","I 1 21 1":" !#$)&.'/0!-","P 1 1 m":" !# !&","P 1 1 b":" !# )&","B 1 1 m":" !# !&(!+(!-","B 1 1 b":" !# )&(!+()-","P 1 1 2/m":" !# !&$%#$%&","P 1 1 21/m":" !#$%+$%& !-","B 1 1 2/m":" !# !&$%#$%&(!+(!-*%+*%-","P 1 1 2/b":" !#$,#$%& )&","P 1 1 21/b":" !#$%&$,+ )-","B 1 1 2/b":" !#$,#$%& )&(!+*,+*%-()-","P 21 2 2":" !#$!&(%&*%#","P 2 21 2":" !# ,&$)&$%#","P 21 21 2 (a)":" !#*,#.%&$'&","P 21 2 21":" !#$!&(%-*%+","P 2 21 21":" !# %&$)-$,+","C 2 2 21a)":" !#*%+(,&$)-()#$,+ %&*!-","C 2 2 2a":" !#*,#.%&$'&()#$%# ,&*!&","F 2 2 2a":" !#*,#.%&$'& '/*%/.12$!2.!/$,/ %20'2.'#$%# 1&0!&","I 2 2 2a":" !#*,#.%&$'&()+$%+*!- ,-","P 21/m 21/m 2/n a":" !#*,#$)&(%&$%&.'& ,#*!#","P 42 21 2a":" !#*,#%.+'$+$'&.%&! -,*-","I 2 3a":" !#*,#.%&$'&!# ,- '&$%/$# !-*!/$%&.%()+$%+ ,-*!-)+(%&(!-*,#*+()&$)#*,- ,"},cg=/^[1-9]$/;function ug(e){let t="";return 0<e.length&&(t=":"+Xl(e).join(" OR :")),new qh(t)}class dg{constructor(e=""){this.name=e,this.partList=[]}get type(){return"Assembly"}addPart(e,t){e=new mg(e,t);return this.partList.push(e),e}getAtomCount(r){return this.partList.reduce((e,t)=>e+t.getAtomCount(r),0)}getResidueCount(r){return this.partList.reduce((e,t)=>e+t.getResidueCount(r),0)}getInstanceCount(){let t=0;return this.partList.forEach(function(e){t+=e.matrixList.length}),t}isIdentity(e){if(1!==this.partList.length)return!1;var t=this.partList[0];if(1!==t.matrixList.length)return!1;if(!(new tt).equals(t.matrixList[0]))return!1;let r=[];return e.eachChain(function(e){r.push(e.chainname)}),r=Xl(r),t.chainList.length===r.length}getBoundingBox(t){let r=new ai;return this.partList.forEach(function(e){e=e.getBoundingBox(t);r.expandByPoint(e.min),r.expandByPoint(e.max)}),r}getCenter(e){return this.getBoundingBox(e).getCenter(new et)}getSelection(){let t=[];return this.partList.forEach(function(e){t=t.concat(e.chainList)}),ug(t)}}class mg{constructor(e=[],t=[]){this.matrixList=e,this.chainList=t}get type(){return"AssemblyPart"}_getCount(e,t){let r=0;return e.eachChain(e=>{0!==this.chainList.length&&!this.chainList.includes(e.chainname)||(r+=e[t])}),this.matrixList.length*r}getAtomCount(e){return this._getCount(e,"atomCount")}getResidueCount(e){return this._getCount(e,"residueCount")}getBoundingBox(e){let t=new ai,r=new ai;var i=this.getSelection();let n=e.getBoundingBox(i);return this.matrixList.forEach(function(e){r.copy(n).applyMatrix4(e),t.expandByPoint(r.min),t.expandByPoint(r.max)}),t}getSelection(){return ug(this.chainList)}getView(e){var t=this.getSelection();return t?e.getView(t):e}getInstanceList(){var r=[];for(let e=0,t=this.matrixList.length;e<t;++e)r.push({id:e+1,name:e,matrix:this.matrixList[e]});return r}}class pg{constructor(e){this.structure=e,this.currentModelindex=null,this.currentChainid=null,this.currentResname=null,this.currentResno=null,this.currentInscode=void 0,this.currentHetero=null,this.previousResname="",this.previousHetero=null,this.ai=-1,this.ri=-1,this.ci=-1,this.mi=-1}addResidueType(e){var t=this.structure.atomStore,r=this.structure.residueStore,i=this.structure.residueMap,n=null==(n=this.structure.chemCompMap)?void 0:n.dict[this.previousResname],a=r.atomCount[e],s=r.atomOffset[e],o=new Array(a);for(let e=0;e<a;++e)o[e]=t.atomTypeId[s+e];var l=null==n?void 0:n.chemCompType,n=!n||null==(n=this.structure.chemCompMap)?void 0:n.getBonds(this.previousResname,o);r.residueTypeId[e]=i.add(this.previousResname,o,this.previousHetero,l,n)}addAtom(e,t,r,i,n,a,s,o){var l=this.structure.atomStore,h=this.structure.residueStore,c=this.structure.chainStore,u=this.structure.modelStore;let d=!1,m=!1,p=!1;this.currentModelindex!==e?(d=!0,m=!0,p=!0,this.mi+=1,this.ci+=1,this.ri+=1):this.currentChainid!==r?(m=!0,p=!0,this.ci+=1,this.ri+=1):this.currentResno===n&&this.currentResname===i&&this.currentInscode===o||(p=!0,this.ri+=1),this.ai+=1,d&&(u.growIfFull(),u.chainOffset[this.mi]=this.ci,u.chainCount[this.mi]=0,u.count+=1,c.modelIndex[this.ci]=this.mi),m&&(c.growIfFull(),c.setChainname(this.ci,t),c.setChainid(this.ci,r),c.residueOffset[this.ci]=this.ri,c.residueCount[this.ci]=0,c.count+=1,c.modelIndex[this.ci]=this.mi,u.chainCount[this.mi]+=1,h.chainIndex[this.ri]=this.ci),p&&(this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,0<this.ri&&this.addResidueType(this.ri-1),h.growIfFull(),h.resno[this.ri]=n,void 0!==s&&(h.sstruc[this.ri]=s.charCodeAt(0)),void 0!==o&&(h.inscode[this.ri]=o.charCodeAt(0)),h.atomOffset[this.ri]=this.ai,h.atomCount[this.ri]=0,h.count+=1,h.chainIndex[this.ri]=this.ci,c.residueCount[this.ci]+=1),l.count+=1,l.residueIndex[this.ai]=this.ri,h.atomCount[this.ri]+=1,this.currentModelindex=e,this.currentChainid=r,this.currentResname=i,this.currentResno=n,this.currentInscode=o,this.currentHetero=a}finalize(){this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,-1<this.ri&&this.addResidueType(this.ri)}}function fg(e,r){if(r){Je.Debug&&rt.time("assignSecondaryStructure");let t=[],n=(e.eachModel(function(e){e.eachChain(function(e){t.push(e.chainname)})}),t.slice().sort()),a=[],c=(n.forEach(function(e){a.push(t.indexOf(e))}),r.helices.filter(function(e){return 0<=Wl(n,e[0])})),u=(c.sort(function(e,t){var r=e[0],i=t[0],e=e[1],t=t[1];return r===i?e===t?0:e<t?-1:1:(e=Wl(n,r),t=Wl(n,i),a[e]<a[t]?-1:1)}),e.residueStore),d=(e.eachModel(function(e){let l=0,h=c.length;if(0!==h){let a=c[l],s=!1,o=!1;e.eachChain(function(t){let r=!1;if(t.chainname===a[0]){var e=t.residueCount,i=t.residueOffset,n=i+e;for(let e=i;e<n;++e)if((s=u.resno[e]===a[1]&&u.getInscode(e)===a[2]?!0:s)&&(u.sstruc[e]=a[6],u.resno[e]===a[4])&&u.getInscode(e)===a[5]&&(s=!1,(l+=1)<h?(e=i-1,a=c[l],r=t.chainname!==a[0]):o=!0),r||o)return}})}}),r.sheets.filter(function(e){return 0<=Wl(n,e[0])})),m=(d.sort(function(e,t){var e=e[0],t=t[0];return e===t?0:(e=Wl(n,e),t=Wl(n,t),a[e]<a[t]?-1:1)}),"e".charCodeAt(0));e.eachModel(function(e){let l=0,h=d.length;if(0!==h){let a=d[l],s=!1,o=!1;e.eachChain(function(t){let r=!1;if(t.chainname===a[0]){var e=t.residueCount,i=t.residueOffset,n=i+e;for(let e=i;e<n;++e)if((s=u.resno[e]===a[1]&&u.getInscode(e)===a[2]?!0:s)&&(u.sstruc[e]=m,u.resno[e]===a[4])&&u.getInscode(e)===a[5]&&(s=!1,(l+=1)<h?(e=i-1,a=d[l],r=t.chainname!==a[0]):o=!0),r||o)return}})}}),Je.Debug&&rt.timeEnd("assignSecondaryStructure")}}let gg=(()=>{function c(r){var i,n,a=r.residueStore,s=r.residueIndexStart;for(let t=0,e=r.residueCount;t<e;++t){let e="c";i=r,n=t,o(i,n,[5.45,5.18,6.37],2.1)?e="h":(i=r,n=t,o(i,n,[6.1,10.4,13],1.42)&&(e="e")),a.sstruc[s+t]=e.charCodeAt(0)}}let o=function(r,e,i,n){var t=r.structure,a=r.residueIndexStart,s=t.getResidueProxy(),o=t.getResidueProxy(),l=t.getAtomProxy(),h=t.getAtomProxy();for(let t=Math.max(0,e-2);t<=e;++t)for(let e=2;e<5;++e)if(!(t+e>=r.residueCount)){s.index=a+t,o.index=a+t+e,l.index=s.traceAtomIndex,h.index=o.traceAtomIndex;var c=l.distanceTo(h);if(Math.abs(c-i[e-2])>n)return!1}return!0};return function(e){Je.Debug&&rt.time("calculateSecondaryStructure"),e.eachPolymer(function(e){if(!(e.residueCount<4)){if(e.isCg()){var i=e,n=i.residueStore,a=i.residueIndexStart,s=new eg(i).position,o=new et,l=new et;for(let e=0,t=i.residueCount;e<t;++e){o.fromArray(s.center,3*e),l.fromArray(s.center,3*e+3);var h=o.distanceTo(l);h<2&&1<h&&s.bending[e]<20&&(n.sstruc[a+e]="h".charCodeAt(0),n.sstruc[a+e+1]="h".charCodeAt(0))}}else{if(!e.isProtein())return;c(e)}let t,r=0;e.eachResidue(function(e){e.sstruc===t?r+=1:(1===r&&(--e.index,e.sstruc="c"),r=1,t=e.sstruc)})}}),Je.Debug&&rt.timeEnd("calculateSecondaryStructure")}})(),vg="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function _g(e){var t=vg.length;let r=e,i=0,n=vg[r%t];for(;r>=t;)r=Math.floor(r/t),n+=vg[r%t],i+=1;return 5<=i&&rt.warn("chainname overflow"),n}function yg(e,g=!1){Je.Debug&&rt.time("calculateChainnames");let t=!0;if(e.eachChain(function(e){e.chainname&&(t=!1)}),t){let s=e.modelStore,o=e.chainStore,l=e.residueStore,h=e.getAtomProxy(),c=e.getAtomProxy(),u=0,d=0,m=0,p=0,f=[],t=(1===l.count?f.push({mIndex:0,chainname:"A",rStart:0,rCount:1}):e.eachResidueN(2,function(e,t){let r=!1;var i=e.backboneType,n=t.backboneType,a=tm;p=e.index,e.modelIndex!==t.modelIndex||e.moleculeType!==t.moleculeType?r=!0:i!==a&&i===n&&(h.index=e.backboneEndAtomIndex,c.index=t.backboneStartAtomIndex,r=g?!h.hasBondTo(c):!h.connectedTo(c)),r||t.index!==l.count-1||(r=!0,p=t.index),r&&(f.push({mIndex:d,chainname:_g(u),rStart:m,rCount:p-m+1}),u+=1,e.modelIndex!==t.modelIndex&&(u=0,d+=1),t.index===l.count-1&&p!==t.index&&f.push({mIndex:d,chainname:_g(u),rStart:l.count-1,rCount:1}),m=t.index,p=t.index)}),o.count=0,s.chainCount.fill(0,0,s.count),s.chainOffset.fill(0,0,s.count),f.forEach(function(e){var t=e.mIndex,r=e.chainname,i=e.rStart,n=e.rCount,a=o.count;for(let e=0;e<n;++e)l.chainIndex[i+e]=a;o.growIfFull(),o.modelIndex[a]=t,o.setChainname(a,r),o.setChainid(a,r),o.residueOffset[a]=i,o.residueCount[a]=n,o.count+=1,s.chainCount[t]+=1}),0);e.eachModel(function(e){s.chainOffset[e.index]=t,t+=s.chainCount[e.index]})}Je.Debug&&rt.timeEnd("calculateChainnames")}function bg(e,t="all"){"none"!==t&&(Je.Debug&&rt.time("calculateBonds"),wg(e,!1,t),Ag(e),Je.Debug)&&rt.timeEnd("calculateBonds")}let xg={"HIS|CD2|CG":2,"HIS|CE1|ND1":2,"ARG|CZ|NH2":2,"PHE|CE1|CZ":2,"PHE|CD2|CE2":2,"PHE|CD1|CG":2,"TRP|CD1|CG":2,"TRP|CD2|CE2":2,"TRP|CE3|CZ3":2,"TRP|CH2|CZ2":2,"ASN|CG|OD1":2,"GLN|CD|OE1":2,"TYR|CD1|CG":2,"TYR|CD2|CE2":2,"TYR|CE1|CZ":2,"ASP|CG|OD1":2,"GLU|CD|OE1":2,"G|C8|N7":2,"G|C4|C5":2,"G|C2|N3":2,"G|C6|O6":2,"C|C4|N3":2,"C|C5|C6":2,"C|C2|O2":2,"A|C2|N3":2,"A|C6|N1":2,"A|C4|C5":2,"A|C8|N7":2,"U|C5|C6":2,"U|C2|O2":2,"U|C4|O4":2,"DG|C8|N7":2,"DG|C4|C5":2,"DG|C2|N3":2,"DG|C6|O6":2,"DC|C4|N3":2,"DC|C5|C6":2,"DC|C2|O2":2,"DA|C2|N3":2,"DA|C6|N1":2,"DA|C4|C5":2,"DA|C8|N7":2,"DT|C5|C6":2,"DT|C2|O2":2,"DT|C4|O4":2};function Sg(e,t,r){return[t,r]=t<r?[t,r]:[r,t],_m.includes(e)&&"C"===t&&"O"===r||Sm.includes(e)&&"OP1"===t&&"P"===r?2:xg[e+`|${t}|`+r]||1}function wg(e,m=!1,p="all"){Je.Debug&&rt.time("calculateBondsWithin");let f=e.bondStore,g=e.rungBondStore,v=e.getAtomSet(!1),_=e.getAtomProxy(),y=e.getAtomProxy(),b=e.getBondProxy(),x=m?null:(t=e,Je.Debug&&rt.time("calculateAtomBondMap"),i=[],t.eachBond(function(e){var t=e.atomIndex1,r=e.atomIndex2;void 0===i[t]&&(i[t]=[]),i[t][r]=e.index}),Je.Debug&&rt.timeEnd("calculateAtomBondMap"),i);var t,i;let S;m||"auto"!==p||(S=new Set,x.forEach((e,t)=>{S.add(t),e.forEach(e=>{S.add(e)})})),e.eachResidue(function(t){if(!m&&x){var e=t.atomCount,r=t.atomOffset;if(500<e)return void rt.warn("more than 500 atoms, skip residue for auto-bonding",t.qualifiedName());if("auto"===p&&t.hetero)for(let e=t.atomOffset;e<t.atomEnd;e++)if(S.has(e))return;var e=t.getBonds(),i=e.atomIndices1,n=e.atomIndices2,a=e.bondOrders,s=i.length;for(let e=0;e<s;++e){var o=i[e],l=n[e],h=o+r,c=l+r,u=x[h];void 0!==u&&void 0!==u[c]?(b.index=u[c],a[t.residueType.getBondIndex(o,l)]=b.bondOrder):(_.index=h,y.index=c,f.addBond(_,y,a[e]))}}var e=t.residueType.traceAtomIndex,d=t.residueType.rungEndAtomIndex;-1!==e&&-1!==d&&(_.index=t.traceAtomIndex,y.index=t.rungEndAtomIndex,g.addBond(_,y),v.set(_.index),v.set(y.index))}),e.atomSetDict.rung=v,Je.Debug&&rt.timeEnd("calculateBondsWithin")}function Ag(e,n=!1,a=!1){Je.Debug&&rt.time("calculateBondsBetween");let s=e.bondStore,o=e.backboneBondStore,l=e.getAtomSet(!1),h=e.getAtomProxy(),c=e.getAtomProxy();function t(r,i){var e=r.backboneType,t=i.backboneType;if(e!==tm&&e===t){h.index=r.backboneEndAtomIndex,c.index=i.backboneStartAtomIndex;let e=!1,t=!1;a&&h.hasBondTo(c)?(e=!1,t=!0):h.connectedTo(c)&&(e=!n,t=!0),e&&s.addBond(h,c,1),t&&(h.index=r.traceAtomIndex,c.index=i.traceAtomIndex,o.addBond(h,c),l.set(h.index),l.set(c.index))}}0===o.count&&o.resize(e.residueStore.count),e.eachResidueN(2,t);let r=e.getResidueProxy(),i=e.getResidueProxy();if(e.eachChain(function(e){0!==e.residueCount&&(r.index=e.residueOffset,i.index=e.residueOffset+e.residueCount-1,t(i,r))}),e.atomSetDict.backbone=l,!n){Je.Debug&&rt.time("calculateBondsBetween inter");let r=e.spatialHash;e.eachResidue(function(e){e.backboneType!==tm||e.isWater()||e.eachAtom(function(t){t.isMetal()||r.eachWithin(t.x,t.y,t.z,4,function(e){c.index=e,t.modelIndex!==c.modelIndex||t.residueIndex===c.residueIndex||c.isMetal()||s.addBondIfConnected(t,c,1)})})}),Je.Debug&&rt.timeEnd("calculateBondsBetween inter")}Je.Debug&&rt.timeEnd("calculateBondsBetween")}function Mg(t){if(t.unitcell){Je.Debug&&rt.time("buildUnitcellAssembly");let i=t.unitcell,n=t.center.clone().applyMatrix4(i.cartToFrac),a=n.clone().floor(),s=(e=>{var r=hg[e];let i={};if(void 0===r)console.warn(`spacegroup '${e}' not found in symop library`);else{var n=[];for(let t=0,e=r.length;t<e;t+=3){var a=[];for(let e=0;e<3;++e)a.push(lg[r[t+e]]);n.push(a)}n.forEach(function(e){let o=0;var t=(new tt).set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1);let l=t.elements;i[e.toString()]=t,e.forEach(function(r){let i=!1,n=!1;for(let e=0,t=r.length;e<t;++e){var a,s=r[e];"-"===s?i=!0:"+"===s?i=!1:"/"===s?n=!0:"X"===s?l[0+o]=i?-1:1:"Y"===s?l[4+o]=i?-1:1:"Z"===s?l[8+o]=i?-1:1:cg.test(s)?(a=parseInt(s),n?l[12+o]/=a:l[12+o]=a):rt.warn(`getSymmetryOperations: unknown token '${s}'`)}o+=1})})}return i})(i.spacegroup),o=new et,l=new et;var h=new dg("UNITCELL"),c=r();let e=[];if(t.biomolDict.NCS){e.push(new tt,...t.biomolDict.NCS.partList[0].matrixList);let r=[];c.forEach(t=>{e.forEach(e=>{r.push(t.clone().multiply(e))})}),h.addPart(r)}else h.addPart(c);var c=new et,u=new dg("SUPERCELL"),c=Array.prototype.concat.call(r(c.set(1,0,0)),r(c.set(0,1,0)),r(c.set(0,0,1)),r(c.set(-1,0,0)),r(c.set(0,-1,0)),r(c.set(0,0,-1)),r(c.set(1,1,0)),r(c.set(1,0,1)),r(c.set(0,1,1)),r(c.set(-1,-1,0)),r(c.set(-1,0,-1)),r(c.set(0,-1,-1)),r(c.set(1,-1,-1)),r(c.set(1,1,-1)),r(c.set(1,-1,1)),r(c.set(-1,1,1)),r(c.set(-1,-1,1)),r(c.set(-1,1,-1)),r(c.set(0,1,-1)),r(c.set(0,-1,1)),r(c.set(1,0,-1)),r(c.set(-1,0,1)),r(c.set(1,-1,0)),r(c.set(-1,1,0)),r(),r(c.set(1,1,1)),r(c.set(-1,-1,-1)));if(t.biomolDict.NCS){let r=[];c.forEach(function(t){e.forEach(function(e){r.push(t.clone().multiply(e))})}),u.addPart(r)}else u.addPart(c);function r(t){let r=[];return Object.keys(s).forEach(function(e){e=s[e].clone();o.copy(n).applyMatrix4(e).floor(),l.setFromMatrixPosition(e),l.sub(o),l.add(a),t&&l.add(t),e.setPosition(l),e.multiplyMatrices(i.fracToCart,e),e.multiply(i.cartToFrac),r.push(e)}),r}t.biomolDict.UNITCELL=h,t.biomolDict.SUPERCELL=u,Je.Debug&&rt.timeEnd("buildUnitcellAssembly")}}let Cg=["H","C","O","N","S","P"],Tg=["NA","CL","FE"];function Eg(e){let t=e.toUpperCase(),r=0,i=0;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)<65){if(0<i)break;++r}else i=e+1;e=(t=0<r||i<t.length?t.substring(r,i):t).length;if(0===e)return"";if(1===e)return t;if(2===e){if(-1!==Tg.indexOf(t))return t;if(-1!==Cg.indexOf(t[0]))return t[0];if(t in cm)return t}return 3<=e&&-1!==Cg.indexOf(t[0])?t[0]:""}function Pg(e){var t=e.bondHash;let u=t.countArray,d=t.offsetArray,m=t.indexArray,p=e.getBondProxy();e.eachResidue(function(e){var t=e.residueType;if(void 0===t.bonds){var s=e.atomOffset,o=[],l=[],h=[],c={};let a=s+e.atomCount;e.eachAtom(function(r){var i,r=r.index,n=d[r];for(let e=0,t=u[r];e<t;++e){p.index=m[n+e];let t=p.atomIndex1;if(!(t<s||t>=a)){let e=p.atomIndex2;e<s||e>=a||(t>e&&(i=e,e=t,t=i),i=t+"|"+e,void 0===c[i]&&(c[i]=!0,o.push(t-s),l.push(e-s),h.push(p.bondOrder)))}}}),t.bonds={atomIndices1:o,atomIndices2:l,bondOrders:h}}})}let Ig=[3,11,19,37,55,87],Rg=[4,12,20,38,56,88],Dg=[6,15,16,34],Lg=[1,7,8,9,17,35,53],Og=[2,10,18,36,54,86],kg=[13,30,31,48,49,50,80,81,82,83,84,85,112],Ng=[5,14,32,33,51,52,85],Fg=[9,17,35,53,85];class Bg{constructor(e,t,r){this.structure=e,this.atomname=t,r=r||Eg(t),this.element=r,this.number=cm[r]||0,this.vdw=um[this.number]||2,this.covalent=dm[this.number]||1.6}getDefaultValence(){var e=mm[this.number];return e?e[0]:-1}getValenceList(){return mm[this.number]||[]}getOuterShellElectronCount(){return pm[this.number]||2}isMetal(){return this.isAlkaliMetal()||this.isAlkalineEarthMetal()||this.isLanthanide()||this.isActinide()||this.isTransitionMetal()||this.isPostTransitionMetal()}isNonmetal(){return this.isDiatomicNonmetal()||this.isPolyatomicNonmetal()||this.isNobleGas()}isMetalloid(){return Ng.includes(this.number)}isHalogen(){return Fg.includes(this.number)}isDiatomicNonmetal(){return Lg.includes(this.number)}isPolyatomicNonmetal(){return Dg.includes(this.number)}isAlkaliMetal(){return Ig.includes(this.number)}isAlkalineEarthMetal(){return Rg.includes(this.number)}isNobleGas(){return Og.includes(this.number)}isTransitionMetal(){var e=this.number;return 21<=e&&e<=29||39<=e&&e<=47||72<=e&&e<=79||104<=e&&e<=108}isPostTransitionMetal(){return kg.includes(this.number)}isLanthanide(){return 57<=this.number&&this.number<=71}isActinide(){return 89<=this.number&&this.number<=103}}class Ug{constructor(e){this.structure=e,this.dict={},this.list=[],this.structure=e}add(e,t){var r=(e=e.toUpperCase())+"|"+(t=t?t.toUpperCase():Eg(e));let i=this.dict[r];return void 0===i&&(e=new Bg(this.structure,e,t),i=this.list.length,this.dict[r]=i,this.list.push(e)),i}get(e){return this.list[e]}}class zg{constructor(e,t,r,i,n,a){this.structure=e,this.bondReferenceAtomIndices=[],this.resname=t,this.atomTypeIdList=r,this.hetero=i?1:0,this.chemCompType=n,this.bonds=a,this.atomCount=r.length,this.moleculeType=this.getMoleculeType(),this.backboneType=this.getBackboneType(0),this.backboneEndType=this.getBackboneType(-1),this.backboneStartType=this.getBackboneType(1),this.backboneIndexList=this.getBackboneIndexList();e=Em[this.backboneType],i=Em[this.backboneStartType],n=Em[this.backboneEndType],a=this.getAtomIndexByName(e.trace),this.traceAtomIndex=ce(a,-1),r=this.getAtomIndexByName(e.direction1),this.direction1AtomIndex=ce(r,-1),a=this.getAtomIndexByName(e.direction2),this.direction2AtomIndex=ce(a,-1),r=this.getAtomIndexByName(i.backboneStart),this.backboneStartAtomIndex=ce(r,-1),e=this.getAtomIndexByName(n.backboneEnd);this.backboneEndAtomIndex=ce(e,-1);let s;s=xm.includes(t)?this.getAtomIndexByName("N1"):this.getAtomIndexByName("N3"),this.rungEndAtomIndex=ce(s,-1)}getBackboneIndexList(){var r=[];let i;switch(this.moleculeType){case 3:i=Cm;break;case 4:case 5:i=Tm;break;default:return r}var n=this.structure.atomMap,a=this.atomTypeIdList;for(let e=0,t=this.atomCount;e<t;++e){var s=n.get(a[e]);i.includes(s.atomname)&&r.push(e)}return r}getMoleculeType(){return this.isProtein()?3:this.isRna()?4:this.isDna()?5:this.isWater()?1:this.isIon()?2:this.isSaccharide()?6:0}getBackboneType(e){return this.hasProteinBackbone(e)?1:this.hasRnaBackbone(e)?2:this.hasDnaBackbone(e)?3:this.hasCgProteinBackbone(e)?4:this.hasCgRnaBackbone(e)?5:this.hasCgDnaBackbone(e)?6:tm}isProtein(){return this.chemCompType?rm.includes(this.chemCompType):this.hasAtomWithName("CA","C","N")||_m.includes(this.resname)}isCg(){var e=this.backboneType;return 4===e||5===e||6===e}isNucleic(){return this.isRna()||this.isDna()}isRna(){return this.chemCompType?im.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C4'","C4*"],["O2'","O2*","F2'","F2*"])||ym.includes(this.resname)&&this.hasAtomWithName(["O2'","O2*","F2'","F2*"]))}isDna(){return this.chemCompType?nm.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C3'","C3*"])&&!this.hasAtomWithName(["O2'","O2*","F2'","F2*"])||bm.includes(this.resname))}isHetero(){return 1===this.hetero}isIon(){return Am.includes(this.resname)}isWater(){return wm.includes(this.resname)}isSaccharide(){return this.chemCompType?am.includes(this.chemCompType):Mm.includes(this.resname)}isStandardAminoacid(){return _m.includes(this.resname)}isStandardBase(){return Sm.includes(this.resname)}hasBackboneAtoms(e,t){t=Em[t];return-1===e?this.hasAtomWithName(t.trace,t.backboneEnd,t.direction1,t.direction2):0===e?this.hasAtomWithName(t.trace,t.direction1,t.direction2):1===e?this.hasAtomWithName(t.trace,t.backboneStart,t.direction1,t.direction2):this.hasAtomWithName(t.trace,t.backboneStart,t.backboneEnd,t.direction1,t.direction2)}hasProteinBackbone(e){return this.isProtein()&&this.hasBackboneAtoms(e,1)}hasRnaBackbone(e){return this.isRna()&&this.hasBackboneAtoms(e,2)}hasDnaBackbone(e){return this.isDna()&&this.hasBackboneAtoms(e,3)}hasCgProteinBackbone(e){return this.atomCount<7&&this.isProtein()&&this.hasBackboneAtoms(e,4)}hasCgRnaBackbone(e){return this.atomCount<11&&this.isRna()&&this.hasBackboneAtoms(e,5)}hasCgDnaBackbone(e){return this.atomCount<11&&this.isDna()&&this.hasBackboneAtoms(e,6)}hasBackbone(e){return this.hasProteinBackbone(e)||this.hasRnaBackbone(e)||this.hasDnaBackbone(e)||this.hasCgProteinBackbone(e)||this.hasCgRnaBackbone(e)||this.hasCgDnaBackbone(e)}getAtomIndexByName(t){var r=this.atomCount,i=this.structure.atomMap,n=this.atomTypeIdList;if(Array.isArray(t))for(let e=0;e<r;++e){var a=n[e];if(t.includes(i.get(a).atomname))return e}else for(let e=0;e<r;++e){var s=n[e];if(t===i.get(s).atomname)return e}}hasAtomWithName(...t){var r=t.length;for(let e=0;e<r;++e)if(void 0!==t[e]&&void 0===this.getAtomIndexByName(t[e]))return!1;return!0}getBonds(e){return void 0===this.bonds&&(this.bonds=(e=>{var r=(t=e.structure).getAtomProxy(),i=t.getAtomProxy(),t=e.atomCount,n=e.atomOffset,a=n+t-1,s=[],o=[],l=[];if(500<t)Je.Debug&&rt.warn("more than 500 atoms, skip residue for auto-bonding",e.qualifiedName());else if(50<t){var h=new og(e,!0),c=e.isCg()?1.2:2.3;for(let e=n;e<a;++e){r.index=e;var u=r.covalent+c+.3,d=h.nearest(r,1/0,u*u),m=d.length;for(let e=0;e<m;++e)i.index=d[e].index,r.index<i.index&&r.connectedTo(i)&&(s.push(r.index-n),o.push(i.index-n),l.push(Sg(r.resname,r.atomname,i.atomname)))}}else for(let t=n;t<a;++t)for(let e=(r.index=t)+1;e<=a;++e)i.index=e,r.connectedTo(i)&&(s.push(t-n),o.push(e-n),l.push(Sg(r.resname,r.atomname,i.atomname)));return{atomIndices1:s,atomIndices2:o,bondOrders:l}})(e)),this.bonds}getRings(){return void 0===this.rings&&this.calculateRings(),this.rings}getBondGraph(){return void 0===this.bondGraph&&this.calculateBondGraph(),this.bondGraph}getAromatic(e){return void 0===this.aromaticAtoms&&this.calculateAromatic(this.structure.getResidueProxy(e.residueIndex)),this.aromaticAtoms}getAromaticRings(e){return void 0===this.aromaticRings&&this.calculateAromatic(e),this.aromaticRings}calculateBondGraph(){var t=this.bondGraph={},e=this.getBonds(),r=e.atomIndices1.length,i=e.atomIndices1,n=e.atomIndices2;for(let e=0;e<r;++e){var a=i[e],s=n[e];(t[a]=t[a]||[]).push(s),(t[s]=t[s]||[]).push(a)}}calculateRings(){var i=((e,t)=>{var r={count:t,visited:new Int32Array(t),queue:new Int32Array(t),pred:new Int32Array(t),left:new Int32Array(Hg),right:new Int32Array(Hg),color:new Int32Array(t),currentColor:0,rings:[],atomRings:[],bonds:e};for(let e=0;e<t;e++)r.visited[e]=-1,r.pred[e]=-1;return r})(this.getBondGraph(),this.atomCount);for(let r=0;r<i.count;r++)if(!(0<=i.visited[r])){n=void 0;a=void 0;s=void 0;o=void 0;l=void 0;h=void 0;c=void 0;u=void 0;d=void 0;var n=i;var a=r;var{bonds:s,visited:o,queue:l,pred:h}=n;o[a]=1,l[0]=a;let e=0,t=1;for(;e<t;){var c=l[e++];if(void 0!==s[c]){var u=s[c].length;for(let e=0;e<u;e++){var d=s[c][e];0<o[d]?h[d]!==c&&h[c]!==d&&((s,e,o)=>{if(!(o<e)){var{pred:l,color:h,left:c,right:u}=s,d=++s.currentColor;let r=e;for(let e=0;e<Hg&&(h[r]=d,!((r=l[r])<0));e++);let i=0,n=0,t=!1,a=0;r=o;for(let e=0;e<Hg;e++){if(h[r]===d){a=r,t=!0;break}if(u[n++]=r,(r=l[r])<0)break}if(t){r=e;for(let e=0;e<Hg&&(c[i++]=r,a!==r)&&!((r=l[r])<0);e++);var m=i+n,p=new Array(m);let t=0;for(let e=0;e<i;e++)p[t++]=c[e];for(let e=n-1;0<=e;e--)p[t++]=u[e];var f=s.rings.length;for(let e=0;e<m;++e){var g=p[e];s.atomRings[g]?s.atomRings[g].push(f):s.atomRings[g]=[f]}s.rings.push(p)}}})(n,c,d):(o[d]=1,l[t++]=d,h[d]=c)}}}}this.rings={atomRings:i.atomRings,rings:i.rings}}isAromatic(e){return this.aromaticAtoms=this.getAromatic(e),1===this.aromaticAtoms[e.index-e.residueAtomOffset]}calculateAromatic(n){let r=this.aromaticAtoms=new Uint8Array(this.atomCount);var e=this.getRings().rings;let i=e.map(i=>{{if((i=i.map(e=>this.structure.getAtomProxy(e+n.atomOffset))).some(e=>!Vg.includes(e.number)))return!1;let t=0,e=new y(3,i.length),r=e.data;return i.forEach(e=>{r[t+0]=e.x,r[t+1]=e.y,r[t+2]=e.z,t+=3}),(i=new jf(e)).vecC.length()<Gg}}),a=this.aromaticRings=[];e.forEach((e,t)=>{i[t]&&(a.push(e),e.forEach(e=>r[e]=1))})}assignBondReferenceAtomIndices(){var i=this.getBondGraph(),e=this.getRings(),n=e.atomRings,a=e.rings,e=this.bonds,s=e.atomIndices1,o=e.atomIndices2,t=e.bondOrders,l=this.bondReferenceAtomIndices,h=e.atomIndices1.length;for(let r=l.length=0;r<h;++r)if(!(t[r]<=1)){let t;var c=s[r],u=o[r],d=n[c],m=n[u];if(d&&m)for(let e=0;e<d.length;e++)if(-1!==m.indexOf(d[e])){t=a[d[e]];break}if(1<i[c].length)for(let e=0;e<i[c].length;++e){var p=i[c][e];if(p!==u&&(void 0===t||-1!==t.indexOf(p))){l[r]=p;break}}else if(1<i[u].length)for(let e=0;e<i[u].length;++e){var f=i[u][e];if(f!==c&&(void 0===t||-1!==t.indexOf(f))){l[r]=f;break}}}}getBondIndex(e,t){var r=this.bonds,i=r.atomIndices1,n=r.atomIndices2;let a=i.indexOf(e),s=n.indexOf(t);for(var o=s;-1!==a;){for(;-1!==s;){if(a===s)return a;s=n.indexOf(t,s+1)}a=i.indexOf(e,a+1),s=o}}getBondReferenceAtomIndex(e,t){e=this.getBondIndex(e,t);if(void 0!==e)return 0===this.bondReferenceAtomIndices.length&&this.assignBondReferenceAtomIndices(),this.bondReferenceAtomIndices[e]}}let Vg=[5,6,7,8,14,15,16,32,33,50,51,83],Gg=.05;let Hg=4;class $g{constructor(e){this.structure=e,this.dict={},this.list=[]}add(e,t,r,i="",n){e=e.toUpperCase();[l,o,a,s=""]=[e,t,r,i];var a,s,o,l=l+"|"+o.join(",")+"|"+(a?1:0)+"|"+s;let h=this.dict[l];return void 0===h&&(o=new zg(this.structure,e,t,r,i,n),h=this.list.length,this.dict[l]=h,this.list.push(o)),h}get(e){return this.list[e]}}class jg{constructor(e,t=0){this.structure=e,this.index=t,this.bondStore=e.bondStore,this._v12=new et,this._v13=new et,this._ap1=this.structure.getAtomProxy(),this._ap2=this.structure.getAtomProxy(),this._ap3=this.structure.getAtomProxy()}get atom1(){return this.structure.getAtomProxy(this.atomIndex1)}get atom2(){return this.structure.getAtomProxy(this.atomIndex2)}get atomIndex1(){return this.bondStore.atomIndex1[this.index]}set atomIndex1(e){this.bondStore.atomIndex1[this.index]=e}get atomIndex2(){return this.bondStore.atomIndex2[this.index]}set atomIndex2(e){this.bondStore.atomIndex2[this.index]=e}get bondOrder(){return this.bondStore.bondOrder[this.index]}set bondOrder(e){this.bondStore.bondOrder[this.index]=e}getOtherAtomIndex(e){return e===this.atomIndex1?this.atomIndex2:this.atomIndex1}getOtherAtom(e){return this.structure.getAtomProxy(this.getOtherAtomIndex(e.index))}getReferenceAtomIndex(){var e,t=this._ap1,r=this._ap2;if(t.index=this.atomIndex1,r.index=this.atomIndex2,t.residueIndex===r.residueIndex)return void 0!==(e=t.residueType.getBondReferenceAtomIndex(t.index-t.residueAtomOffset,r.index-r.residueAtomOffset))?e+t.residueAtomOffset:void console.warn("No reference atom found",t.index,r.index)}calculateShiftDir(e=new et){var t=this._ap1,r=this._ap2,i=this._ap3,n=this._v12,a=this._v13,s=(t.index=this.atomIndex1,r.index=this.atomIndex2,this.getReferenceAtomIndex());n.subVectors(t,r).normalize(),void 0!==s?(i.index=s,a.subVectors(t,i)):a.copy(t),a.normalize();let o=n.dot(a);return 1-Math.abs(o)<1e-5&&(a.set(1,0,0),o=n.dot(a),1-Math.abs(o)<1e-5)&&(a.set(0,1,0),o=n.dot(a)),e.copy(a.sub(n.multiplyScalar(o))).normalize()}qualifiedName(){return this.atomIndex1+"="+this.atomIndex2}clone(){return new jg(this.structure,this.index)}toObject(){return{atomIndex1:this.atomIndex1,atomIndex2:this.atomIndex2,bondOrder:this.bondOrder}}}class Wg{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get chain(){return this.structure.getChainProxy(this.chainIndex)}get chainIndex(){return this.residueStore.chainIndex[this.index]}set chainIndex(e){this.residueStore.chainIndex[this.index]=e}get atomOffset(){return this.residueStore.atomOffset[this.index]}set atomOffset(e){this.residueStore.atomOffset[this.index]=e}get atomCount(){return this.residueStore.atomCount[this.index]}set atomCount(e){this.residueStore.atomCount[this.index]=e}get atomEnd(){return this.atomOffset+this.atomCount-1}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get resno(){return this.residueStore.resno[this.index]}set resno(e){this.residueStore.resno[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.index)}set sstruc(e){this.residueStore.setSstruc(this.index,e)}get inscode(){return this.residueStore.getInscode(this.index)}set inscode(e){this.residueStore.setInscode(this.index,e)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.index])}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get moleculeType(){return this.residueType.moleculeType}get backboneType(){return this.residueType.backboneType}get backboneStartType(){return this.residueType.backboneStartType}get backboneEndType(){return this.residueType.backboneEndType}get traceAtomIndex(){return this.residueType.traceAtomIndex+this.atomOffset}get direction1AtomIndex(){return this.residueType.direction1AtomIndex+this.atomOffset}get direction2AtomIndex(){return this.residueType.direction2AtomIndex+this.atomOffset}get backboneStartAtomIndex(){return this.residueType.backboneStartAtomIndex+this.atomOffset}get backboneEndAtomIndex(){return this.residueType.backboneEndAtomIndex+this.atomOffset}get rungEndAtomIndex(){return this.residueType.rungEndAtomIndex+this.atomOffset}get x(){let t=0;for(let e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.x[e];return t/this.atomCount}get y(){let t=0;for(let e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.y[e];return t/this.atomCount}get z(){let t=0;for(let e=this.atomOffset;e<=this.atomEnd;++e)t+=this.atomStore.z[e];return t/this.atomCount}eachAtom(t,e){var r=this.atomCount,i=this.atomOffset,n=this.structure._ap,a=i+r;if(e&&e.atomOnlyTest){var s=e.atomOnlyTest;for(let e=i;e<a;++e)n.index=e,s(n)&&t(n)}else for(let e=i;e<a;++e)n.index=e,t(n)}positionToArray(e=[],t=0){return e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}isProtein(){return 3===this.residueType.moleculeType}isNucleic(){var e=this.residueType.moleculeType;return 4===e||5===e}isRna(){return 4===this.residueType.moleculeType}isDna(){return 5===this.residueType.moleculeType}isCg(){var e=this.residueType.backboneType;return 4===e||5===e||6===e}isPolymer(){var e;return 0<this.structure.entityList.length?this.entity.isPolymer():3===(e=this.residueType.moleculeType)||4===e||5===e}isHetero(){return 1===this.residueType.hetero}isWater(){return 1===this.residueType.moleculeType}isIon(){return 2===this.residueType.moleculeType}isSaccharide(){return 6===this.residueType.moleculeType}isStandardAminoacid(){return this.residueType.isStandardAminoacid()}isStandardBase(){return this.residueType.isStandardBase()}isHelix(){return om.includes(this.sstruc)}isSheet(){return lm.includes(this.sstruc)}isTurn(){return hm.includes(this.sstruc)&&this.isProtein()}getAtomType(e){return this.atomMap.get(this.atomStore.atomTypeId[e])}getResname1(){return vm[this.resname.toUpperCase()]||"X"}getBackboneType(e){switch(e){case-1:return this.residueType.backboneStartType;case 1:return this.residueType.backboneEndType;default:return this.residueType.backboneType}}getAtomIndexByName(e){let t=this.residueType.getAtomIndexByName(e);return void 0!==t&&(t+=this.atomOffset),t}hasAtomWithName(e){return this.residueType.hasAtomWithName(e)}getAtomnameList(){console.warn("getAtomnameList - might be expensive");var t=this.atomCount,r=this.atomOffset,i=new Array(t);for(let e=0;e<t;++e)i[e]=this.getAtomType(r+e).atomname;return i}connectedTo(e){var t=this.structure.getAtomProxy(this.backboneEndAtomIndex),e=this.structure.getAtomProxy(e.backboneStartAtomIndex);return!(!t||!e)&&t.connectedTo(e)}getNextConnectedResidue(){var e=this.chainStore.residueOffset[this.chainIndex],t=this.chainStore.residueCount[this.chainIndex],r=this.index+1;if(r<e+t){var i=this.structure.getResidueProxy(r);if(this.connectedTo(i))return i}else if(r===e+t){i=this.structure.getResidueProxy(e);if(this.connectedTo(i))return i}}getPreviousConnectedResidue(e){var t=this.chainStore.residueOffset[this.chainIndex],r=this.index-1;if(t<=r){var i=ce(e,this.structure.getResidueProxy());if(i.index=r,i.connectedTo(this))return i}else if(r==t-1){i=this.chainStore.residueCount[this.chainIndex],r=ce(e,this.structure.getResidueProxy());if(r.index=t+i-1,r.connectedTo(this))return r}}getBonds(){return this.residueType.getBonds(this)}getRings(){return this.residueType.getRings()}getAromaticRings(){return this.residueType.getAromaticRings(this)}qualifiedName(e=!1){let t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chain&&(t+=":"+this.chainname),t+="/"+this.modelIndex}clone(){return new Wg(this.structure,this.index)}toObject(){return{index:this.index,chainIndex:this.chainIndex,atomOffset:this.atomOffset,atomCount:this.atomCount,resno:this.resno,resname:this.resname,sstruc:this.sstruc}}}class qg{constructor(e,t,r){this.structure=e,this.residueIndexStart=t,this.residueIndexEnd=r,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueCount=r-t+1;e=this.structure.getResidueProxy(this.residueIndexStart),r=this.structure.getResidueProxy(this.residueIndexEnd),this.isPrevConnected=void 0!==e.getPreviousConnectedResidue(),t=r.getNextConnectedResidue();this.isNextConnected=void 0!==t,this.isNextNextConnected=void 0!==t&&void 0!==t.getNextConnectedResidue(),this.isCyclic=r.connectedTo(e),this.__residueProxy=this.structure.getResidueProxy()}get chainIndex(){return this.residueStore.chainIndex[this.residueIndexStart]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}isProtein(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isProtein()}isCg(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isCg()}isNucleic(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isNucleic()}getMoleculeType(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.moleculeType}getBackboneType(e){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.getBackboneType(e)}getAtomIndexByType(e,t){this.isCyclic?-1===e?e=this.residueCount-1:e===this.residueCount&&(e=0):(-1!==e||this.isPrevConnected||(e+=1),e!==this.residueCount||this.isNextNextConnected||--e);var r=this.__residueProxy;r.index=this.residueIndexStart+e;let i;switch(t){case"trace":i=r.traceAtomIndex;break;case"direction1":i=r.direction1AtomIndex;break;case"direction2":i=r.direction2AtomIndex;break;default:i=r.getAtomIndexByName(t)}return i}eachAtom(t,r){this.eachResidue(function(e){e.eachAtom(t,r)})}eachAtomN(t,e,r){var i=this.residueCount,n=new Array(t);for(let e=0;e<t;++e)n[e]=this.structure.getAtomProxy(this.getAtomIndexByType(e,r));e.apply(this,n);for(var a=t;a<i;++a){for(let e=1;e<t;++e)n[e-1].index=n[e].index;n[t-1].index=this.getAtomIndexByType(a,r),e.apply(this,n)}}eachResidue(t){var r=this.structure.getResidueProxy(),i=this.residueCount,n=this.residueIndexStart;for(let e=0;e<i;++e)r.index=n+e,t(r)}qualifiedName(){var e=this.structure.getResidueProxy(this.residueIndexStart),t=this.structure.getResidueProxy(this.residueIndexEnd);return e.qualifiedName()+" - "+t.qualifiedName()}}class Xg{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get entity(){return this.structure.entityList[this.entityIndex]}get model(){return this.structure.getModelProxy(this.modelIndex)}get entityIndex(){return this.chainStore.entityIndex[this.index]}set entityIndex(e){this.chainStore.entityIndex[this.index]=e}get modelIndex(){return this.chainStore.modelIndex[this.index]}set modelIndex(e){this.chainStore.modelIndex[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.index]}set residueOffset(e){this.chainStore.residueOffset[this.index]=e}get residueCount(){return this.chainStore.residueCount[this.index]}set residueCount(e){this.chainStore.residueCount[this.index]=e}get residueEnd(){return this.residueOffset+this.residueCount-1}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get atomCount(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1}get chainname(){return this.chainStore.getChainname(this.index)}set chainname(e){this.chainStore.setChainname(this.index,e)}get chainid(){return this.chainStore.getChainid(this.index)}set chainid(e){this.chainStore.setChainid(this.index,e)}eachAtom(t,r){this.eachResidue(function(e){e.eachAtom(t,r)},r)}eachResidue(t,e){var r=this.residueCount,i=this.residueOffset,n=this.structure._rp,a=i+r;if(e&&e.test){var s=e.residueOnlyTest;if(s)for(let e=i;e<a;++e)n.index=e,s(n)&&t(n);else for(let e=i;e<a;++e)n.index=e,t(n)}else for(let e=i;e<a;++e)n.index=e,t(n)}eachResidueN(t,r){var e=this.residueCount,i=this.residueOffset,n=i+e;if(!(e<t)){var a=new Array(t);for(let e=0;e<t;++e)a[e]=this.structure.getResidueProxy(i+e);r.apply(this,a);for(let e=i+t;e<n;++e){for(let e=0;e<t;++e)a[e].index+=1;r.apply(this,a)}}}eachPolymer(t,e){let r=0,i=0;var n=e?e.residueOnlyTest:void 0,a=this.model.structure,e=this.residueCount,s=this.residueOffset,o=s+e,l=this.structure.getResidueProxy(),h=this.structure.getResidueProxy(s),c=this.structure.getAtomProxy(),u=this.structure.getAtomProxy();let d=!0;for(let e=s+1;e<o;++e){l.index=h.index,h.index=e;var m=d?l.backboneEndType:l.backboneType,p=h.backboneType;d&&(r=l.index,d=!1),i=h.index,m===tm||m!==p?(m!==tm&&1<l.index-r&&t(new qg(a,r,l.index)),r=i):(c.index=l.backboneEndAtomIndex,u.index=h.backboneStartAtomIndex,c&&u&&c.connectedTo(u)&&(!n||n(l)&&n(h))||(1<l.index-r&&t(new qg(a,r,l.index)),r=i))}1<i-r&&this.structure.getResidueProxy(r).backboneEndType&&t(new qg(a,r,i))}qualifiedName(){return":"+this.chainname+"/"+this.modelIndex}clone(){return new Xg(this.structure,this.index)}toObject(){return{index:this.index,residueOffset:this.residueOffset,residueCount:this.residueCount,chainname:this.chainname}}}class Yg{constructor(e,t=0){this.structure=e,this.index=t,this.modelStore=e.modelStore,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get chainOffset(){return this.modelStore.chainOffset[this.index]}set chainOffset(e){this.modelStore.chainOffset[this.index]=e}get chainCount(){return this.modelStore.chainCount[this.index]}set chainCount(e){this.modelStore.chainCount[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.chainOffset]}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get chainEnd(){return this.chainOffset+this.chainCount-1}get residueEnd(){return this.chainStore.residueOffset[this.chainEnd]+this.chainStore.residueCount[this.chainEnd]-1}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get residueCount(){return 0===this.chainCount?0:this.residueEnd-this.residueOffset+1}get atomCount(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1}eachAtom(t,r){this.eachChain(function(e){e.eachAtom(t,r)},r)}eachResidue(t,r){this.eachChain(function(e){e.eachResidue(t,r)},r)}eachPolymer(r,i){if(i&&i.chainOnlyTest){let t=i.chainOnlyTest;this.eachChain(function(e){t(e)&&e.eachPolymer(r,i)})}else this.eachChain(function(e){e.eachPolymer(r,i)})}eachChain(t,e){var r=this.chainCount,i=this.chainOffset,n=this.structure._cp,a=i+r;if(e&&e.test){var s=e.chainOnlyTest;if(s)for(let e=i;e<a;++e)n.index=e,s(n)&&t(n);else for(let e=i;e<a;++e)n.index=e,t(n)}else for(let e=i;e<a;++e)n.index=e,t(n)}qualifiedName(){return"/"+this.index}clone(){return new Yg(this.structure,this.index)}toObject(){return{index:this.index,chainOffset:this.chainOffset,chainCount:this.chainCount}}}class Kg{constructor(e="",t=""){this.signals={refreshed:new n.Signal},this.init(e,t)}init(e,t){this.name=e,this.path=t,this.title="",this.id="",this.data={structure:this,"@spatialLookup":void 0,"@valenceModel":void 0},this.header={},this.extraData={},this.atomSetCache={},this.atomSetDict={},this.biomolDict={},this.entityList=[],this.unitcell=void 0,this.frames=[],this.boxes=[],this.validation=void 0,this.bondStore=new Xf(0),this.backboneBondStore=new Xf(0),this.rungBondStore=new Xf(0),this.atomStore=new Yf(0),this.residueStore=new Kf(0),this.chainStore=new Zf(0),this.modelStore=new Qf(0),this.atomMap=new Ug(this),this.residueMap=new $g(this),this.chemCompMap=void 0,this.bondHash=void 0,this.spatialHash=void 0,this.atomSet=void 0,this.bondSet=void 0,this.center=new et,this.boundingBox=new ai,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy()}get type(){return"Structure"}finalizeAtoms(){this.atomSet=this.getAtomSet(),this.atomCount=this.atomStore.count,this.boundingBox=this.getBoundingBox(void 0,this.boundingBox),this.center=this.boundingBox.getCenter(new et),this.spatialHash=new Wd(this.atomStore,this.boundingBox)}finalizeBonds(){for(var e in this.bondSet=this.getBondSet(),this.bondCount=this.bondStore.count,this.bondHash=new qf(this.bondStore,this.atomStore.count),this.atomSetCache={},this.atomSetDict.rung||(this.atomSetDict.rung=this.getAtomSet(!1)),this.atomSetDict)this.atomSetCache["__"+e]=this.atomSetDict[e].clone()}getBondProxy(e){return new jg(this,e)}getAtomProxy(e){return new ig(this,e)}getResidueProxy(e){return new Wg(this,e)}getChainProxy(e){return new Xg(this,e)}getModelProxy(e){return new Yg(this,e)}getBondSet(){var t=this.bondStore.count,r=new Kd(t),i=this.atomSet;if(i)if(i.isAllSet())r.setAll();else if(i.isAllClear())r.clearAll();else{var n=this.getBondProxy();for(let e=0;e<t;++e)n.index=e,i.isSet(n.atomIndex1,n.atomIndex2)&&r.set(n.index)}else r.setAll();return r}getBackboneBondSet(){var t=this.backboneBondStore.count,r=new Kd(t),i=this.atomSetCache.__backbone;if(i){var n=this.getBondProxy();n.bondStore=this.backboneBondStore;for(let e=0;e<t;++e)n.index=e,i.isSet(n.atomIndex1,n.atomIndex2)&&r.set(n.index)}else r.setAll();return r}getRungBondSet(){var t=this.rungBondStore.count,r=new Kd(t),i=this.atomSetCache.__rung;if(i){var n=this.getBondProxy();n.bondStore=this.rungBondStore;for(let e=0;e<t;++e)n.index=e,i.isSet(n.atomIndex1,n.atomIndex2)&&r.set(n.index)}else r.setAll();return r}getAtomSet(e){var r=this.atomStore.count;if(void 0===e)return new Kd(r,!0);if(e instanceof Kd)return e;if(!0===e)return new Kd(r,!0);if(e&&e.test){var i=e.string;if(i in this.atomSetCache)return this.atomSetCache[i];if(""===i)return new Kd(r,!0);{let t=new Kd(r);return this.eachAtom(function(e){t.set(e.index)},e),this.atomSetCache[i]=t}}return!1===e?new Kd(r):new Kd(r,!0)}getAtomSetWithinSelection(e,t){let r=this.spatialHash,i=this.getAtomSet(!1),n=this.getAtomProxy();return r&&this.getAtomSet(e).forEach(function(e){n.index=e,r.within(n.x,n.y,n.z,t).forEach(function(e){i.set(e)})}),i}getAtomSetWithinPoint(e,t){let r=this.getAtomSet(!1);return this.spatialHash&&this.spatialHash.within(e.x,e.y,e.z,t).forEach(function(e){r.set(e)}),r}getAtomSetWithinVolume(e,t,r,i,n){var e=new Wf(e,r,i,n),a=e.getDataPosition(),s=a.length,o=e.matrix.getMaxScaleOnAxis();let l=this.getAtomSet(!1);if(this.spatialHash)for(let e=0;e<s;e+=3)this.spatialHash.within(a[e],a[e+1],a[e+2],o).forEach(function(e){l.set(e)});return l}getAtomSetWithinGroup(e){let t=this.atomStore.residueIndex,r=this.getAtomSet(!1),i=this.getResidueProxy();return this.getAtomSet(e).forEach(function(e){i.index=t[e];for(let e=i.atomOffset;e<=i.atomEnd;++e)r.set(e)}),r}getSelection(){}getStructure(){return this}eachEntity(t,r){this.entityList.forEach(function(e){void 0!==r&&e.getEntityType()!==r||t(e)})}eachBond(t,e){let r=this.getBondProxy(),i;if(e&&e.test&&(i=this.getBondSet(),this.bondSet)&&i.intersection(this.bondSet),i)i.forEach(function(e){r.index=e,t(r)});else{var n=this.bondStore.count;for(let e=0;e<n;++e)r.index=e,t(r)}}eachAtom(t,r){if(r&&r.test)this.eachModel(function(e){e.eachAtom(t,r)},r);else{var i=this.atomStore.count,n=this.getAtomProxy();for(let e=0;e<i;++e)n.index=e,t(n)}}eachResidue(t,r){if(r&&r.test){var i=this.modelStore.count,n=this.getModelProxy(),a=r.modelOnlyTest;if(a)for(let e=0;e<i;++e)n.index=e,a(n)&&n.eachResidue(t,r);else for(let e=0;e<i;++e)n.index=e,n.eachResidue(t,r)}else{var s=this.residueStore.count,o=this.getResidueProxy();for(let e=0;e<s;++e)o.index=e,t(o)}}eachResidueN(t,r){var i=this.residueStore.count;if(!(i<t)){var n=new Array(t);for(let e=0;e<t;++e)n[e]=this.getResidueProxy(e);r.apply(this,n);for(let e=t;e<i;++e){for(let e=0;e<t;++e)n[e].index+=1;r.apply(this,n)}}}eachPolymer(r,i){if(i&&i.modelOnlyTest){let t=i.modelOnlyTest;this.eachModel(function(e){t(e)&&e.eachPolymer(r,i)})}else this.eachModel(function(e){e.eachPolymer(r,i)})}eachChain(t,r){if(r&&r.test)this.eachModel(function(e){e.eachChain(t,r)});else{var i=this.chainStore.count,n=this.getChainProxy();for(let e=0;e<i;++e)n.index=e,t(n)}}eachModel(t,e){var r=this.modelStore.count,i=this.getModelProxy();if(e&&e.test){var n=e.modelOnlyTest;if(n)for(let e=0;e<r;++e)i.index=e,n(i)&&t(i);else for(let e=0;e<r;++e)i.index=e,t(i)}else for(let e=0;e<r;++e)i.index=e,t(i)}getAtomData(e){var e=Object.assign({},e),t=(e.colorParams&&(e.colorParams.structure=this.getStructure()),e.what),r=ce(e.atomSet,this.atomSet);let i,n;var a={};let s=this.getAtomProxy();var o=r.getSize();t&&!t.position||(a.position=new Float32Array(3*o)),t&&!t.color||!e.colorParams||(a.color=new Float32Array(3*o),n=k.getScheme(e.colorParams)),t&&!t.picking||(a.picking=new gp(new Float32Array(o),this.getStructure())),t&&!t.radius||(a.radius=new Float32Array(o),i=new Gf(e.radiusParams)),t&&!t.index||(a.index=new Uint32Array(o));let{position:l,color:h,picking:c,radius:u,index:d}=a;return r.forEach((e,t)=>{var r=3*t;s.index=e,l&&s.positionToArray(l,r),h&&n.atomColorToArray(s,h,r),c&&(c.array[t]=e),u&&(u[t]=i.atomRadius(s)),d&&(d[t]=e)}),a}getBondData(e){var e=Object.assign({},e),t=(e.colorParams&&(e.colorParams.structure=this.getStructure()),e.what),r=ce(e.bondSet,this.bondSet),i=ce(e.multipleBond,"off");let n="off"!==i,a="offset"===i,s=ce(e.bondScale,.4),o=ce(e.bondSpacing,1),l,h;i={};let c=this.getBondProxy(),u=(e.bondStore&&(c.bondStore=e.bondStore),this.getAtomProxy()),d=this.getAtomProxy(),m;if(n){let t=c.bondStore.bondOrder;m=0,r.forEach(function(e){m+=t[e]})}else m=r.getSize();t&&!t.position||(i.position1=new Float32Array(3*m),i.position2=new Float32Array(3*m)),t&&!t.color||!e.colorParams||(i.color=new Float32Array(3*m),i.color2=new Float32Array(3*m),h=k.getScheme(e.colorParams)),t&&!t.picking||(i.picking=new _p(new Float32Array(m),this.getStructure(),e.bondStore)),(!t||t.radius||n&&t.position)&&(l=new Gf(e.radiusParams)),t&&!t.radius||(i.radius=new Float32Array(m),e.radius2&&(i.radius2=new Float32Array(m)));let{position1:p,position2:f,color:g,color2:v,picking:_,radius:y,radius2:b}=i,x=0,S,w,A,M,C,T,E=new et,P=new et,I=new et;return r.forEach(e=>{var t;if(w=3*x,c.index=e,u.index=c.atomIndex1,d.index=c.atomIndex2,M=c.bondOrder,p&&(n&&1<M?(t=l.atomRadius(u),T=t*s/(.5*M),c.calculateShiftDir(I),a?(C=2*o*t,I.multiplyScalar(C),I.negate(),P.subVectors(d,u).multiplyScalar(Math.max(.1,C/1.88)),u.positionToArray(p,w),d.positionToArray(f,w),2<=M&&(E.addVectors(u,I).add(P).toArray(p,3+w),E.addVectors(d,I).sub(P).toArray(f,3+w),3<=M)&&(E.subVectors(u,I).add(P).toArray(p,6+w),E.subVectors(d,I).sub(P).toArray(f,6+w))):(C=(o-s)*t,I.multiplyScalar(C),2===M?(E.addVectors(u,I).toArray(p,w),E.subVectors(u,I).toArray(p,3+w),E.addVectors(d,I).toArray(f,w),E.subVectors(d,I).toArray(f,3+w)):3===M?(u.positionToArray(p,w),E.addVectors(u,I).toArray(p,3+w),E.subVectors(u,I).toArray(p,6+w),d.positionToArray(f,w),E.addVectors(d,I).toArray(f,3+w),E.subVectors(d,I).toArray(f,6+w)):(u.positionToArray(p,w),d.positionToArray(f,w)))):(u.positionToArray(p,w),d.positionToArray(f,w))),g&&v&&(h.bondColorToArray(c,1,g,w),h.bondColorToArray(c,0,v,w),n)&&1<M)for(S=1;S<M;++S)A=3*S+w,Qc(g,w,A,3),Qc(v,w,A,3);if(_&&_.array&&(_.array[x]=e,n)&&1<M)for(S=1;S<M;++S)_.array[x+S]=e;if(y&&(y[x]=l.atomRadius(u),n)&&1<M)for(T=y[x]*s/(a?1:.5*M),S=a?1:0;S<M;++S)y[x+S]=T;if(b&&(b[x]=l.atomRadius(d),n)&&1<M)for(T=b[x]*s/(a?1:.5*M),S=a?1:0;S<M;++S)b[x+S]=T;x+=n?M:1}),i}getBackboneAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__backbone},e),this.getAtomData(e)}getBackboneBondData(e){return e=Object.assign({bondSet:this.getBackboneBondSet(),bondStore:this.backboneBondStore},e),this.getBondData(e)}getRungAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__rung},e),this.getAtomData(e)}getRungBondData(e){return e=Object.assign({bondSet:this.getRungBondSet(),bondStore:this.rungBondStore},e),this.getBondData(e)}getBoundingBox(e,t){Je.Debug&&rt.time("getBoundingBox"),t=t||new ai;let i=1/0,n=1/0,a=1/0,s=-1/0,o=-1/0,l=-1/0;return this.eachAtom(e=>{var t=e.x,r=e.y,e=e.z;t<i&&(i=t),r<n&&(n=r),e<a&&(a=e),t>s&&(s=t),r>o&&(o=r),e>l&&(l=e)},e),t.min.set(i,n,a),t.max.set(s,o,l),Je.Debug&&rt.timeEnd("getBoundingBox"),t}getPrincipalAxes(e){Je.Debug&&rt.time("getPrincipalAxes");let t=0;var r=new y(3,this.atomCount);let i=r.data;return this.eachAtom(e=>{i[t+0]=e.x,i[t+1]=e.y,i[t+2]=e.z,t+=3},e),Je.Debug&&rt.timeEnd("getPrincipalAxes"),new jf(r)}atomCenter(e){return e?this.getBoundingBox(e).getCenter(new et):this.center.clone()}hasCoords(){var e;return void 0===this._hasCoords&&(e=this.atomStore,this._hasCoords=0!==eu(e.x)||0!==Jc(e.x)||0!==eu(e.y)||0!==Jc(e.y)||0!==eu(e.z)||0!==Jc(e.z)||e.count/this.modelStore.count==1),this._hasCoords}getSequence(e){let t=[],r=this.getResidueProxy();return this.eachAtom(function(e){r.index=e.residueIndex,e.index===r.traceAtomIndex&&t.push(r.getResname1())},e),t}getAtomIndices(e){if(e&&e.string){let t=[];return this.eachAtom(function(e){t.push(e.index)},e),new Uint32Array(t)}return this.getAtomData({what:{index:!0}}).index}getChainnameCount(e){let t=new Set;return this.eachChain(function(e){e.residueCount&&t.add(e.chainname)},e),t.size}updatePosition(t,e=!0){let r=0;this.eachAtom(function(e){e.positionFromArray(t,r),r+=3},void 0),this._hasCoords=void 0,e&&this.refreshPosition()}refreshPosition(){this.getBoundingBox(void 0,this.boundingBox),this.boundingBox.getCenter(this.center),this.spatialHash=new Wd(this.atomStore,this.boundingBox),this.signals.refreshed.dispatch(this)}dispose(){this.frames&&(this.frames.length=0),this.boxes&&(this.boxes.length=0),this.bondStore.dispose(),this.backboneBondStore.dispose(),this.rungBondStore.dispose(),this.atomStore.dispose(),this.residueStore.dispose(),this.chainStore.dispose(),this.modelStore.dispose(),delete this.bondSet,delete this.atomSet}}let Zg=new ai,Qg=[Ud,kd,zd,Bd,Vd,Nd,Od,Fd,Hd,Gd,$d,jd],Jg={aspectRatio:1.5,sphereDetail:2,radialSegments:50,disableImpostor:!1,openEnded:!1,dashedCylinder:!1,labelParams:{},pointSize:2,sizeAttenuation:!1,useTexture:!0,linewidth:2};class e1{constructor(e="shape",t={}){this.boundingBox=new ai,this.bufferList=[],this.meshCount=0,this._primitiveData={},this.name=e,this.parameters=Vl(t,Jg),Qg.forEach(t=>{Object.keys(t.fields).forEach(e=>{this._primitiveData[t.getShapeKey(e)]=[]}),this._primitiveData[t.getShapeKey("name")]=[]})}addBuffer(e){this.bufferList.push(e);e=e.geometry;return e.boundingBox||e.computeBoundingBox(),this.boundingBox.union(e.boundingBox),this}addMesh(e,t,r,i,n){e=ih(e),t=ih(t),Array.isArray(r)&&(r=Zl(r,e.length)),i=i&&ih(i);let a;a=void 0===i||0==i.length?{position:e,color:t,index:r}:{position:e,color:t,index:r,normal:i};t=new Tp(this,Object.assign({serial:this.meshCount,name:n},a)),r=new _f(Object.assign({picking:t},a));return this.bufferList.push(r),Zg.setFromArray(e),this.boundingBox.union(Zg),this.meshCount+=1,this}addSphere(e,t,r,i){return Od.objectToShape(this,{position:e,color:t,radius:r,name:i}),this}addEllipsoid(e,t,r,i,n,a){return Vd.objectToShape(this,{position:e,color:t,radius:r,majorAxis:i,minorAxis:n,name:a}),this}addTorus(e,t,r,i,n,a){return Gd.objectToShape(this,{position:e,color:t,radius:r,majorAxis:i,minorAxis:n,name:a}),this}addCylinder(e,t,r,i,n){return Bd.objectToShape(this,{position1:e,position2:t,color:r,radius:i,name:n}),this}addCone(e,t,r,i,n){return zd.objectToShape(this,{position1:e,position2:t,color:r,radius:i,name:n}),this}addArrow(e,t,r,i,n){return Ud.objectToShape(this,{position1:e,position2:t,color:r,radius:i,name:n}),this}addBox(e,t,r,i,n,a){return kd.objectToShape(this,{position:e,color:t,size:r,heightAxis:i,depthAxis:n,name:a}),this}addOctahedron(e,t,r,i,n,a){return Nd.objectToShape(this,{position:e,color:t,size:r,heightAxis:i,depthAxis:n,name:a}),this}addTetrahedron(e,t,r,i,n,a){return Fd.objectToShape(this,{position:e,color:t,size:r,heightAxis:i,depthAxis:n,name:a}),this}addText(e,t,r,i){return Hd.objectToShape(this,{position:e,color:t,size:r,text:i}),this}addPoint(e,t,r){return $d.objectToShape(this,{position:e,color:t,name:r}),this}addWideline(e,t,r,i,n){return this.parameters.linewidth=i,jd.objectToShape(this,{position1:e,position2:t,color:r,name:n}),this}addLabel(e,t,r,i){return console.warn("Shape.addLabel is deprecated, use .addText instead"),this.addText(e,t,r,i)}getBufferList(){let t=[];return Qg.forEach(e=>{this._primitiveData[e.getShapeKey("color")].length&&t.push(e.bufferFromShape(this,this.parameters))}),this.bufferList.concat(t)}dispose(){this.bufferList.forEach(function(e){e.dispose()}),this.bufferList.length=0,Qg.forEach(t=>{Object.keys(t.fields).forEach(e=>{this._primitiveData[t.getShapeKey(e)].length=0}),this._primitiveData[t.getShapeKey("name")].length=0})}get center(){return this._center||(this._center=this.boundingBox.getCenter(new et)),this._center}get type(){return"Shape"}}class t1 extends sd{constructor(e,t,r){super(e=Array.isArray(e)?e:[e],t,r),this.type="buffer",this.parameters=Object.assign({},this.parameters,{colorScheme:null,colorScale:null,colorValue:null,colorDomain:null,colorMode:null}),this.buffer=e,this.init(r)}init(e){super.init(e),this.build()}create(){this.bufferList.push.apply(this.bufferList,this.buffer)}attach(e){this.bufferList.forEach(e=>{this.viewer.add(e),e.setParameters(this.getBufferParams())}),this.setVisibility(this.visible),e()}}let r1=new tt,i1=new v;class n1 extends _f{constructor(e,t={},r){super(((e,t)=>{var r=t.attributes.position.array,t=t.index?t.index.array:void 0,i=e.position.length/3,r=r.length/3,n=i*r,a=new Float32Array(3*n),s=new Float32Array(3*n);let o;return{position:a,color:new Float32Array(3*n),index:o=t?Zl(i*t.length,n):o,normal:s,primitiveId:e.primitiveId||Yc(i,r),picking:e.picking}})(e,r),t),this.updateNormals=!1;var t=r.attributes.position.array,i=r.attributes.normal.array,r=r.index?r.index.array:void 0,i=(this.geoPosition=t,this.geoNormal=i,this.geoIndex=r,this.positionCount=e.position.length/3,this.geoPositionCount=t.length/3,this.transformedGeoPosition=new Float32Array(3*this.geoPositionCount),this.transformedGeoNormal=new Float32Array(3*this.geoPositionCount),this.geometry.attributes);this.meshPosition=i.position.array,this.meshColor=i.color.array,this.meshNormal=i.normal.array,this.setAttributes(e),r&&((t=this.geometry.getIndex())?(this.meshIndex=t.array,this.makeIndex()):rt.error("Index is null"))}setAttributes(e={},i=!1){var t=this.geometry.attributes;let n,a,s,o,l,h,c,u,d;var m=this.updateNormals,p=(e.position&&(n=e.position,s=this.geoPosition,c=this.meshPosition,l=this.transformedGeoPosition,t.position.needsUpdate=!0,m||i)&&(o=this.geoNormal,d=this.meshNormal,h=this.transformedGeoNormal,t.normal.needsUpdate=!0),e.color&&(a=e.color,u=this.meshColor,t.color.needsUpdate=!0),this.positionCount),f=this.geoPositionCount;for(let r=0;r<p;++r){let e,t;var g=r*f*3,v=3*r;if(n&&l&&c&&d&&s&&o&&(l.set(s),r1.makeTranslation(n[v],n[1+v],n[2+v]),this.applyPositionTransform(r1,r,v),dd(r1.elements,l),c.set(l,g),m&&h?(h.set(o),i1.getNormalMatrix(r1),md(i1.elements,h),d.set(h,g)):i&&d.set(o,g)),a&&u)for(e=0;e<f;++e)t=g+3*e,u[t]=a[v],u[1+t]=a[1+v],u[2+t]=a[2+v]}}makeIndex(){var e=this.geoIndex,r=this.meshIndex;if(e){var i=this.positionCount,n=this.geoPositionCount,a=3*(e.length/3);for(let t=0;t<i;++t){var s=t*a,o=s+a;r.set(e,s);for(let e=s;e<o;++e)r[e]+=t*n}}}}let a1=new et,s1=Object.assign({sphereDetail:1},ff);class o1 extends n1{constructor(e,t={}){super(e,t,new Al(1,ce(t.sphereDetail,1))),this.setAttributes(e,!0)}get defaultParameters(){return s1}applyPositionTransform(e,t){t=this._radius[t];a1.set(t,t,t),e.scale(a1)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),super.setAttributes(e,t)}}s.add("shader/SphereImpostor.vert","uniform mat4 projectionMatrixInverse;\nuniform float clipNear;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\nattribute vec2 mapping;\nattribute float radius;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\n#include matrix_scale\nconst mat4 D = mat4(\n1.0, 0.0, 0.0, 0.0,\n0.0, 1.0, 0.0, 0.0,\n0.0, 0.0, 1.0, 0.0,\n0.0, 0.0, 0.0, -1.0\n);\nmat4 transposeM( in mat4 inMatrix ) {\nvec4 i0 = inMatrix[0];\nvec4 i1 = inMatrix[1];\nvec4 i2 = inMatrix[2];\nvec4 i3 = inMatrix[3];\nmat4 outMatrix = mat4(\nvec4(i0.x, i1.x, i2.x, i3.x),\nvec4(i0.y, i1.y, i2.y, i3.y),\nvec4(i0.z, i1.z, i2.z, i3.z),\nvec4(i0.w, i1.w, i2.w, i3.w)\n);\nreturn outMatrix;\n}\nvoid ComputePointSizeAndPositionInClipCoordSphere(){\nvec2 xbc;\nvec2 ybc;\nmat4 T = mat4(\nradius, 0.0, 0.0, 0.0,\n0.0, radius, 0.0, 0.0,\n0.0, 0.0, radius, 0.0,\nposition.x, position.y, position.z, 1.0\n);\nmat4 R = transposeM( projectionMatrix * modelViewMatrix * T );\nfloat A = dot( R[ 3 ], D * R[ 3 ] );\nfloat B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );\nfloat C = dot( R[ 0 ], D * R[ 0 ] );\nxbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nxbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;\nA = dot( R[ 3 ], D * R[ 3 ] );\nB = -2.0 * dot( R[ 1 ], D * R[ 3 ] );\nC = dot( R[ 1 ], D * R[ 1 ] );\nybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sy = abs( ybc[ 0 ] - ybc[ 1 ] ) * 0.5;\ngl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );\ngl_Position.xy -= mapping * vec2( sx, sy );\ngl_Position.xy *= gl_Position.w;\n}\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\nvRadius = radius * matrixScale( modelViewMatrix );\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nmvPosition.z -= vRadius;\ngl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );\nComputePointSizeAndPositionInClipCoordSphere();\nvRadiusSq = vRadius * vRadius;\nvec4 vPoint4 = projectionMatrixInverse * gl_Position;\nvPoint = vPoint4.xyz / vPoint4.w;\nvPointViewPosition = -mvPosition.xyz / mvPosition.w;\n}"),s.add("shader/SphereImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool flag2 = false;\nbool interior = false;\nvec3 cameraPos;\nvec3 cameraNormal;\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nbool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){\nvec3 cameraSpherePos = -vPointViewPosition;\ncameraSpherePos.z += vRadius;\nvec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );\nvec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );\nvec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );\nfloat B = dot( rayDirection, cameraSphereDir );\nfloat det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );\nif( det < 0.0 ){\ndiscard;\nreturn false;\n}\nfloat sqrtDet = sqrt( det );\nfloat posT = mix( B + sqrtDet, B + sqrtDet, ortho );\nfloat negT = mix( B - sqrtDet, sqrtDet - B, ortho );\ncameraPos = rayDirection * negT + rayOrigin;\n#ifdef NEAR_CLIP\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}else if( calcClip( cameraPos ) > 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nflag2 = true;\n}\n#else\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}\n#endif\ncameraNormal = normalize( cameraPos - cameraSpherePos );\ncameraNormal *= float(!interior) * 2.0 - 1.0;\nreturn !interior;\n}\nvoid main(void){\nbool flag = Impostor( cameraPos, cameraNormal );\n#ifdef NEAR_CLIP\nif( calcClip( cameraPos ) > 0.0 )\ndiscard;\n#endif\ngl_FragDepthEXT = calcDepth( cameraPos );\nif( !flag ){\n#ifdef NEAR_CLIP\nif( flag2 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}else if( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#else\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#endif\n}\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vNormal = cameraNormal;\nvec3 vViewPosition = -cameraPos;\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");class l1 extends vf{constructor(e,t,r={}){super(t,r),this.index=Zl(this.indexSize,this.attributeSize),this.makeIndex(),this.initIndex(this.index),this.addAttributes({mapping:{type:e,value:null}}),this.setAttributes({primitiveId:Xc(this.size)})}get attributeSize(){return this.size*this.mappingSize}get indexSize(){return this.size*this.mappingIndicesSize}addAttributes(e){var t,r={};for(t in e){var i=e[t];r[t]={type:i.type,value:null}}super.addAttributes(r)}getAttributeIndex(e){return 3*e*this.mappingSize}setAttributes(e){e&&!e.position&&e.position1&&e.position2&&(e.position=jc(e.position1,e.position2));var t,r,i,n,a,s,o,l,h=this.size,c=this.mappingSize,u=this.geometry.attributes;for(l in e)if("index"!==l&&"picking"!==l){r=e[l],i=(t=u[l]).itemSize,n=t.array;for(let e=0;e<h;++e){s=(a=e*i)*c;for(let e=0;e<c;++e){o=s+i*e;for(let e=0;e<i;++e)n[o+e]=r[a+e]}}t.needsUpdate=!0}}makeMapping(){var t=this.size,r=this.mapping,i=this.mappingSize,n=this.mappingItemSize,a=this.geometry.attributes.mapping.array;for(let e=0;e<t;e++)a.set(r,e*n*i)}makeIndex(){var t=this.size,r=this.mappingSize,i=this.mappingIndices,n=this.mappingIndicesSize,a=this.index;for(let e=0;e<t;e++){var s=e*n,o=e*r;a.set(i,s);for(let e=0;e<n;++e)a[s+e]+=o}}}let h1=new Float32Array([-1,1,-1,-1,1,1,1,-1]),c1=new Uint16Array([0,1,2,1,3,2]);class u1 extends l1{constructor(e,t={}){super("v2",e,t)}get mapping(){return h1}get mappingIndices(){return c1}get mappingIndicesSize(){return 6}get mappingSize(){return 4}get mappingItemSize(){return 2}}class d1 extends u1{constructor(e,t={}){super(e,t),this.isImpostor=!0,this.vertexShader="SphereImpostor.vert",this.fragmentShader="SphereImpostor.frag",this.addUniforms({projectionMatrixInverse:{value:new tt},ortho:{value:0}}),this.addAttributes({radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}}Object.assign({disableImpostor:!1},s1);let m1=class{constructor(e,t){return new(!oc||t&&t.disableImpostor?o1:d1)(e,t)}};function p1(e){var e=e||{},r=ce(e.width,256),t=ce(e.height,256),i=[r/2,t/2],n=Math.min(r/2,t/2),a=ce(e.delta,1/(n+1))*n;let s=0,o=0;var l,h,c=new Uint8Array(r*t*4);for(let e=0,t=c.length;e<t;e+=4){l=s,u=o,h=i[0],h-=l,l=i[1]-u;var u=1-mh(n-a,n,Math.sqrt(h*h+l*l));c[e]=255*u,c[e+1]=255*u,c[e+2]=255*u,c[e+3]=255*u,++s===r&&(s=0,o++)}e=new rl(c,r,t);return e.needsUpdate=!0,e}gc.add("sphere",m1),s.add("shader/Point.vert","uniform float clipNear;\r\nuniform float clipRadius;\r\nuniform vec3 clipCenter;\r\nuniform float size;\r\nuniform float canvasHeight;\r\nuniform float pixelRatio;\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\n#if defined( PICKING )\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#else\r\n#include color_pars_vertex\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\n#include common\r\n\r\nvoid main(){\r\n\r\n#if defined( PICKING )\r\nvPickingColor = unpackColor( primitiveId );\r\n#else\r\n#include color_vertex\r\n#endif\r\n\r\n#include begin_vertex\r\n#include project_vertex\r\n\r\n#ifdef USE_SIZEATTENUATION\r\ngl_PointSize = size * pixelRatio * ( ( canvasHeight / 2.0 ) / -mvPosition.z );\r\n#else\r\ngl_PointSize = size * pixelRatio;\r\n#endif\r\n\r\n#ifndef PICKING\r\nvViewPosition = -mvPosition.xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n#include radiusclip_vertex\r\n\r\n}"),s.add("shader/Point.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include alphatest_pars_fragment\nvarying vec3 vViewPosition;\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\n#ifdef USE_MAP\nif( texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).a < 0.5 )\ndiscard;\n#endif\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\n#ifdef USE_MAP\ndiffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif\n#include color_fragment\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");let f1=Object.assign({pointSize:1,sizeAttenuation:!0,sortParticles:!1,alphaTest:.5,useTexture:!1,forceTransparent:!1,edgeBleach:0},ff),g1=Object.assign({pointSize:{uniform:"size"},sizeAttenuation:{updateShader:!0},sortParticles:{},alphaTest:{uniform:!0},useTexture:{updateShader:!0},forceTransparent:{},edgeBleach:{uniform:!0}},gf);class v1 extends vf{constructor(e,t={}){super(e,t),this.parameterTypes=g1,this.vertexShader="Point.vert",this.fragmentShader="Point.frag",this.isPoint=!0,this.addUniforms({size:{value:this.parameters.pointSize},canvasHeight:{value:1},pixelRatio:{value:1},map:{value:null},alphaTest:{value:this.parameters.alphaTest}})}get defaultParameters(){return f1}makeMaterial(){super.makeMaterial(),this.makeTexture();var e=this.material,t=this.wireframeMaterial,r=this.pickingMaterial;e.uniforms.map.value=this.tex,e.needsUpdate=!0,t.uniforms.map.value=this.tex,t.needsUpdate=!0,r.uniforms.map.value=this.tex,r.needsUpdate=!0}makeTexture(){this.tex&&this.tex.dispose(),this.tex=p1({delta:this.parameters.edgeBleach})}getDefines(e){e=super.getDefines(e);return this.parameters.sizeAttenuation&&(e.USE_SIZEATTENUATION=1),this.parameters.useTexture&&(e.USE_MAP=1),0<this.parameters.alphaTest&&this.parameters.alphaTest<=1&&(e.USE_ALPHATEST=1),e}setUniforms(e){e&&void 0!==e.edgeBleach&&(this.makeTexture(),e.map=this.tex),super.setUniforms(e)}dispose(){super.dispose(),this.tex&&this.tex.dispose()}}gc.add("point",v1);class _1 extends sd{constructor(e,t,r){super(e,t,r),this.type="dot",this.parameters=Object.assign({thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdOut:{type:"boolean",rebuild:!0},dotType:{type:"select",rebuild:!0,options:{"":"",sphere:"sphere",point:"point"}},radiusType:{type:"select",options:{"":"",value:"value","abs-value":"abs-value","value-min":"value-min",deviation:"deviation",size:"size"}},radius:{type:"number",precision:3,max:10,min:.001,property:"size"},scale:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,disableImpostor:!0,pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{colorScheme:{type:"select",update:"color",options:{"":"",value:"value",uniform:"uniform",random:"random"}}}),e instanceof uf?(this.surface=void 0,this.volume=new Wf(e)):(this.surface=e,this.volume=void 0),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"uniform"),e.colorValue=ce(e.colorValue,14540253),this.thresholdType=ce(e.thresholdType,"sigma"),this.thresholdMin=ce(e.thresholdMin,2),this.thresholdMax=ce(e.thresholdMax,1/0),this.thresholdOut=ce(e.thresholdOut,!1),this.dotType=ce(e.dotType,"point"),this.radius=ce(e.radius,.1),this.scale=ce(e.scale,1),this.pointSize=ce(e.pointSize,1),this.sizeAttenuation=ce(e.sizeAttenuation,!0),this.sortParticles=ce(e.sortParticles,!1),this.useTexture=ce(e.useTexture,!1),this.alphaTest=ce(e.alphaTest,.5),this.forceTransparent=ce(e.forceTransparent,!1),this.edgeBleach=ce(e.edgeBleach,0),super.init(e),this.build()}attach(e){this.bufferList.forEach(e=>{this.viewer.add(e)}),this.setVisibility(this.visible),e()}create(){var e,t,r,i={};this.volume?(e=this.volume,t="sigma"===this.thresholdType?(r=e.getValueForSigma(this.thresholdMin),e.getValueForSigma(this.thresholdMax)):(r=this.thresholdMin,this.thresholdMax),e.setFilter(r,t,this.thresholdOut),Object.assign(i,{position:e.getDataPosition(),color:e.getDataColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(i,{radius:e.getDataSize(this.radius,this.scale),picking:e.getDataPicking()})):(r=this.surface,Object.assign(i,{position:r.getPosition(),color:r.getColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(i,{radius:r.getSize(this.radius,this.scale),picking:r.getPicking()})),"sphere"===this.dotType?this.dotBuffer=new m1(i,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!1})):this.dotBuffer=new v1(i,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach})),this.bufferList.push(this.dotBuffer)}update(e={}){var t;0!==this.bufferList.length&&(t={},e.color&&(this.volume?Object.assign(t,{color:this.volume.getDataColor(this.getColorParams())}):Object.assign(t,{color:this.surface.getColor(this.getColorParams())})),"sphere"===this.dotType&&(e.radius||e.scale)&&(this.volume?Object.assign(t,{radius:this.volume.getDataSize(this.radius,this.scale)}):Object.assign(t,{radius:this.surface.getSize(this.radius,this.scale)})),this.dotBuffer.setAttributes(t))}setParameters(e,t={},r){return e&&void 0!==e.thresholdType&&this.volume instanceof uf&&("value"===this.thresholdType&&"sigma"===e.thresholdType?(this.thresholdMin=this.volume.getSigmaForValue(this.thresholdMin),this.thresholdMax=this.volume.getSigmaForValue(this.thresholdMax)):"sigma"===this.thresholdType&&"value"===e.thresholdType&&(this.thresholdMin=this.volume.getValueForSigma(this.thresholdMin),this.thresholdMax=this.volume.getValueForSigma(this.thresholdMax)),this.thresholdType=e.thresholdType),e&&void 0!==e.radiusType&&("radius"===e.radiusType?this.radius=.1:this.radius=parseFloat(e.radiusType),t.radius=!0,"sphere"!==this.dotType||oc&&!this.disableImpostor||(r=!0)),e&&void 0!==e.radius&&(t.radius=!0,"sphere"!==this.dotType||oc&&!this.disableImpostor||(r=!0)),e&&void 0!==e.scale&&(t.scale=!0,"sphere"!==this.dotType||oc&&!this.disableImpostor||(r=!0)),super.setParameters(e,t,r),this}}s.add("shader/Image.vert","uniform float clipRadius;\r\nuniform vec3 clipCenter;\r\n\r\nvarying vec2 vUv;\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\n\r\nvoid main() {\r\n\r\n#include begin_vertex\r\n#include project_vertex\r\n\r\nvUv = uv;\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\r\nvViewPosition = -mvPosition.xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n}"),s.add("shader/Image.frag","uniform sampler2D map;\nuniform float opacity;\nuniform vec2 mapSize;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform sampler2D pickingMap;\nuniform float objectId;\n#else\n#include fog_pars_fragment\n#endif\n#if defined( CUBIC_INTERPOLATION )\n#if defined( CATMULROM_FILTER ) || defined( MITCHELL_FILTER )\n#if defined( CATMULROM_FILTER )\nconst float B = 0.0;\nconst float C = 0.5;\n#elif defined( MITCHELL_FILTER )\nconst float B = 0.333;\nconst float C = 0.333;\n#endif\nfloat applyFilter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f < 1.0 ){\nreturn ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +\n( -18.0 + 12.0 * B + 6.0 *C ) * ( f * f ) +\n( 6.0 - 2.0 * B ) ) / 6.0;\n}else if( f >= 1.0 && f < 2.0 ){\nreturn ( ( -B - 6.0 * C ) * ( f * f * f )\n+ ( 6.0 * B + 30.0 * C ) * ( f *f ) +\n( - ( 12.0 * B ) - 48.0 * C ) * f +\n8.0 * B + 24.0 * C ) / 6.0;\n}else{\nreturn 0.0;\n}\n}\n#elif defined( BSPLINE_FILTER )\nfloat applyFilter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f >= 0.0 && f <= 1.0 ){\nreturn ( 2.0 / 3.0 ) + ( 0.5 ) * ( f * f * f ) - ( f * f );\n}else if( f > 1.0 && f <= 2.0 ){\nreturn 1.0 / 6.0 * pow( ( 2.0 - f ), 3.0 );\n}\nreturn 1.0;\n}\n#else\nfloat applyFilter( float x ){\nreturn 1.0;\n}\n#endif\nvec4 biCubic( sampler2D tex, vec2 texCoord ){\nvec2 texelSize = 1.0 / mapSize;\ntexCoord -= texelSize / 2.0;\nvec4 nSum = vec4( 0.0 );\nfloat nDenom = 0.0;\nvec2 cell = fract( texCoord * mapSize );\nfor( float m = -1.0; m <= 2.0; ++m ){\nfor( float n = -1.0; n <= 2.0; ++n ){\nvec4 vecData = texture2D(\ntex, texCoord + texelSize * vec2( m, n )\n);\nfloat c = applyFilter( m - cell.x ) * applyFilter( -n + cell.y );\nnSum += vecData * c;\nnDenom += c;\n}\n}\nreturn nSum / nDenom;\n}\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( CUBIC_INTERPOLATION )\ngl_FragColor = biCubic( map, vUv );\n#else\ngl_FragColor = texture2D( map, vUv );\n#endif\n#if defined( PICKING )\nif( gl_FragColor.a < 0.3 )\ndiscard;\ngl_FragColor = vec4( texture2D( pickingMap, vUv ).xyz, objectId );\n#else\nif( gl_FragColor.a < 0.01 )\ndiscard;\ngl_FragColor.a *= opacity;\n#include fog_fragment\n#endif\n}");let y1=new Uint16Array([0,1,2,1,3,2]),b1=new Float32Array([0,1,0,0,1,1,1,0]),x1=Object.assign({filter:"nearest",forceTransparent:!0},ff),S1=Object.assign({filter:{updateShader:!0,uniform:!0}},gf);class w1 extends vf{constructor(e,t){super({position:e.position,index:y1,picking:e.picking},t),this.parameterTypes=S1,this.alwaysTransparent=!0,this.hasWireframe=!1,this.vertexShader="Image.vert",this.fragmentShader="Image.frag";var{imageData:t,width:e,height:r}=e,i=new rl(t,e,r),n=(i.flipY=!0,this.tex=i,t.length),a=new Uint8Array(n);for(let e=0;e<n;e+=4){var s=e/4;a[e]=s>>16&255,a[e+1]=s>>8&255,a[e+2]=255&s}t=new rl(a,e,r);t.flipY=!0,t.minFilter=q,t.magFilter=q,this.pickingTex=t,this.addUniforms({map:{value:i},pickingMap:{value:t},mapSize:{value:new Ue(e,r)}}),this.geometry.setAttribute("uv",new Cn(b1,2))}get defaultParameters(){return x1}getDefines(e){var e=super.getDefines(e),t=this.parameters.filter;return t.startsWith("cubic")&&(e.CUBIC_INTERPOLATION=1,t.endsWith("bspline")?e.BSPLINE_FILTER=1:t.endsWith("catmulrom")?e.CATMULROM_FILTER=1:t.endsWith("mitchell")&&(e.MITCHELL_FILTER=1)),e}updateTexture(){var e=this.tex,t=this.parameters.filter;!t.startsWith("cubic")&&"linear"===t?(e.minFilter=je,e.magFilter=je):(e.minFilter=q,e.magFilter=q),e.needsUpdate=!0,this.pickingTex.needsUpdate=!0}makeMaterial(){super.makeMaterial(),this.updateTexture();var e=this.material,e=(e.uniforms.map.value=this.tex,e.blending=fe,e.needsUpdate=!0,this.wireframeMaterial),e=(e.uniforms.map.value=this.tex,e.blending=fe,e.needsUpdate=!0,this.pickingMaterial);e.uniforms.map.value=this.tex,e.uniforms.pickingMap.value=this.pickingTex,e.blending=fe,e.needsUpdate=!0}setUniforms(e){e&&void 0!==e.filter&&(this.updateTexture(),e.map=this.tex),super.setUniforms(e)}}class A1{constructor(e,t){t=t||{};this.dimension=ce(t.dimension,"x"),this.positionType=ce(t.positionType,"percent"),this.position=ce(t.position,30),this.thresholdType=ce(t.thresholdType,"sigma"),this.thresholdMin=ce(t.thresholdMin,-1/0),this.thresholdMax=ce(t.thresholdMax,1/0),this.normalize=ce(t.normalize,!1),this.volume=e}getPositionFromCoordinate(e){var t=this.dimension,r=this.volume,i=r.matrix,n=(new et).setFromMatrixPosition(i)[t],i=(new et).setFromMatrixScale(i)[t];let a;return a="x"===t?r.nx:"y"===t?r.ny:r.nz,Math.round(((e-n)/(a/100)+1)/i)}getData(e){e=e||{};let n=this.volume;var a=n.data;let s=n.matrix,t;function r(e){return Math.round(e/100*(t-1))}function o(e,t,r,i){return 3*(r*n.ny*n.nx+t*n.nx+e)+i}t="coordinate"===this.positionType?this.getPositionFromCoordinate(this.position):this.position;let l=new Float32Array(12),h=new et,i,c,u,d,m,p=0,f=0,g=0,v=n.nx,_=n.ny,y=n.nz;function b(e,t,r,i){h.set(e,t,r).applyMatrix4(s).toArray(l,i)}"x"===this.dimension?(u=r(n.nx),d=n.ny-1,m=n.nz-1,i=n.nz,c=n.ny,p=u,v=p+1,b(u,0,0,0),b(u,d,0,3),b(u,0,m,6),b(u,d,m,9)):"y"===this.dimension?(u=n.nx-1,d=r(n.ny),m=n.nz-1,i=n.nz,c=n.nx,f=d,_=f+1,b(0,d,0,0),b(u,d,0,3),b(0,d,m,6),b(u,d,m,9)):"z"===this.dimension&&(u=n.nx-1,d=n.ny-1,m=r(n.nz),i=n.nx,c=n.ny,g=m,y=g+1,b(0,0,m,0),b(0,d,m,3),b(u,0,m,6),b(u,d,m,9));let x=0,S=0;var w=new Uint8Array(i*c*4),A=new Float32Array(i*c);let M,C;C="sigma"===this.thresholdType?(M=n.getValueForSigma(this.thresholdMin),n.getValueForSigma(this.thresholdMax)):(M=this.thresholdMin,this.thresholdMax);var e=Object.assign({},e.colorParams,{volume:n}),T=(this.normalize&&(e.domain=[0,1]),k.getScheme(e)),E=new Float32Array(3),P=T.getScale();let I=0,R,D=0;if(this.normalize){I=1/0,R=-1/0;for(let r=f;r<_;++r)for(let t=p;t<v;++t)for(let e=g;e<y;++e){var L=a[o(t,r,e,0)/3];L<I&&(I=L),L>R&&(R=L)}D=R-I}for(let i=f;i<_;++i)for(let r=p;r<v;++r)for(let t=g;t<y;++t){var O=o(r,i,t,0)/3;let e=a[O];this.normalize&&(e=(e-I)/D),T.colorToArray(P(e),E),w[x]=Math.round(255*E[0]),w[x+1]=Math.round(255*E[1]),w[x+2]=Math.round(255*E[2]),w[x+3]=e>M&&e<C?255:0,A[S]=O,++S,x+=4}e=new Op(A,n);return{position:l,imageData:w,width:i,height:c,picking:e}}}class M1 extends sd{constructor(e,t,r){super(e,t,r),this.type="slice",this.parameters=Object.assign({filter:{type:"select",buffer:!0,options:{nearest:"nearest",linear:"linear","cubic-bspline":"cubic-bspline","cubic-catmulrom":"cubic-catmulrom","cubic-mitchell":"cubic-mitchell"}},positionType:{type:"select",rebuild:!0,options:{percent:"percent",coordinate:"coordinate"}},position:{type:"range",step:.1,max:100,min:1,rebuild:!0},dimension:{type:"select",rebuild:!0,options:{x:"x",y:"y",z:"z"}},thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},normalize:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null,linewidth:null,colorScheme:null,roughness:null,metalness:null,diffuse:null}),this.volume=e,this.init(r)}init(e){var t=this.volume,e=e||{};e.colorDomain=ce(e.colorDomain,[t.min,t.max]),e.colorScheme=ce(e.colorScheme,"value"),e.colorScale=ce(e.colorScale,"Spectral"),this.colorScheme="value",this.dimension=ce(e.dimension,"x"),this.filter=ce(e.filter,"cubic-bspline"),this.positionType=ce(e.positionType,"percent"),this.position=ce(e.position,30),this.thresholdType=ce(e.thresholdType,"sigma"),this.thresholdMin=ce(e.thresholdMin,-1/0),this.thresholdMax=ce(e.thresholdMax,1/0),this.normalize=ce(e.normalize,!1),super.init(e),this.build()}attach(e){this.bufferList.forEach(e=>{this.viewer.add(e)}),this.setVisibility(this.visible),e()}create(){var e=new A1(this.volume,{positionType:this.positionType,position:this.position,dimension:this.dimension,thresholdType:this.thresholdType,thresholdMin:this.thresholdMin,thresholdMax:this.thresholdMax,normalize:this.normalize}),e=new w1(e.getData({colorParams:this.getColorParams()}),this.getBufferParams({filter:this.filter}));this.bufferList.push(e)}}function C1(e){rt.error(`makeRepresentation: representation type ${e} unknown`)}let T1={name:"some element",status:""};class E1{constructor(e,t={}){this.stage=e,this.signals={statusChanged:new n.Signal,nameChanged:new n.Signal,disposed:new n.Signal},this.parameters=Vl(t,this.defaultParameters),this.uuid=hh()}get defaultParameters(){return T1}get name(){return this.parameters.name}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}dispose(){this.signals.disposed.dispatch()}}let P1=Object.assign({visible:!0},T1);class I1 extends E1{constructor(e,t,r={},i){super(e,Object.assign({name:t.type},r)),this.parent=i,this.signals=Object.assign({visibilityChanged:new n.Signal,parametersChanged:new n.Signal},this.signals),this.setRepresentation(t)}get defaultParameters(){return P1}get visible(){return this.parameters.visible}get type(){return"representation"}getType(){return this.repr.type}setRepresentation(e){this._disposeRepresentation(),this.repr=e,this.stage.tasks.listen(this.repr.tasks),this.updateVisibility()}_disposeRepresentation(){this.repr&&(this.stage.tasks.unlisten(this.repr.tasks),this.repr.dispose())}dispose(){this.parent&&this.parent.hasRepresentation(this)?this.parent.removeRepresentation(this):(this._disposeRepresentation(),this.signals.disposed.dispatch())}setVisibility(e){return this.parameters.visible=e,this.updateVisibility(),this.signals.visibilityChanged.dispatch(this.parameters.visible),this}getVisibility(){return(!this.parent||this.parent.parameters.visible)&&this.parameters.visible}toggleVisibility(){return this.setVisibility(!this.parameters.visible)}updateVisibility(){this.repr.setVisibility(this.getVisibility())}update(e){return this.repr.update(e),this}build(e){return this.repr.build(e),this}setSelection(e){var t=this.repr;return t.setSelection&&t.setSelection(e),this}setParameters(e){return this.repr.setParameters(e),this.signals.parametersChanged.dispatch(this.repr.getParameters()),this}getParameters(){return this.repr.getParameters()}setColor(e){return this.repr.setColor(e),this}}let R1=new tt,D1=new et,L1={name:"",status:"",visible:!0};class O1{constructor(e,t,r={}){this.stage=e,this.object=t,this.signals={representationAdded:new n.Signal,representationRemoved:new n.Signal,visibilityChanged:new n.Signal,matrixChanged:new n.Signal,statusChanged:new n.Signal,nameChanged:new n.Signal,disposed:new n.Signal},this.reprList=[],this.annotationList=[],this.matrix=new tt,this.position=new et,this.quaternion=new ri,this.scale=new et(1,1,1),this.transform=new tt,this.parameters=Vl(r,this.defaultParameters),this.uuid=hh(),this.viewer=e.viewer,this.controls=new zf(this)}get defaultParameters(){return L1}get name(){return this.parameters.name}get status(){return this.parameters.status}get visible(){return this.parameters.visible}setPosition(e){return Array.isArray(e)?this.position.fromArray(e):this.position.copy(e),this.updateMatrix(),this}setRotation(e){var t;return Array.isArray(e)?3===e.length?(t=(new Vi).fromArray(e),this.quaternion.setFromEuler(t)):this.quaternion.fromArray(e):e instanceof Vi?this.quaternion.setFromEuler(e):this.quaternion.copy(e),this.updateMatrix(),this}setScale(e){return this.scale.set(e,e,e),this.updateMatrix(),this}setTransform(e){return this.transform.copy(e),this.updateMatrix(),this}updateMatrix(){var e=this.getCenterUntransformed(D1),t=(this.matrix.makeTranslation(-e.x,-e.y,-e.z),R1.makeRotationFromQuaternion(this.quaternion),this.matrix.premultiply(R1),R1.makeScale(this.scale.x,this.scale.y,this.scale.z),this.matrix.premultiply(R1),this.position);R1.makeTranslation(t.x+e.x,t.y+e.y,t.z+e.z),this.matrix.premultiply(R1),this.matrix.premultiply(this.transform),this.updateRepresentationMatrices(),this.stage.viewer.updateBoundingBox(),this.signals.matrixChanged.dispatch(this.matrix)}updateRepresentationMatrices(){this.reprList.forEach(e=>{e.setParameters({matrix:this.matrix})})}addAnnotation(e,t,r){e=new Nf(this,e,t,r);return this.annotationList.push(e),e}eachAnnotation(e){this.annotationList.slice().forEach(e)}removeAnnotation(e){var t=this.annotationList.indexOf(e);-1!==t&&(this.annotationList.splice(t,1),e.dispose())}removeAllAnnotations(){this.eachAnnotation(e=>e.dispose()),this.annotationList.length=0}_addRepresentation(e,t,r,i=!1){var r=r||{},n=this.stage.getParameters(),n=(r.matrix=this.matrix.clone(),r.quality=r.quality||n.quality,r.disableImpostor=ce(r.disableImpostor,!n.impostor),r.useWorker=ce(r.useWorker,n.workerDefault),r.visible=ce(r.visible,!0),Object.assign({},r,{visible:this.parameters.visible&&r.visible})),e=((e,t,r,i)=>{if(Je.Debug&&rt.time("makeRepresentation "+e),t instanceof Kg){if(!(n=mc.get(e)))return void C1(e)}else if(t instanceof hf)if("surface"===e)n=Af;else{if("dot"!==e)return void C1(e);n=_1}else if(t instanceof uf)if("surface"===e)n=Af;else if("dot"===e)n=_1;else{if("slice"!==e)return void C1(e);n=M1}else if(t instanceof e1)n=t1,t=t.getBufferList();else{if("buffer"!==e)return void rt.error("makeRepresentation: object "+t+" unknown");n=t1}var n=new n(t,r,i);return Je.Debug&&rt.timeEnd("makeRepresentation "+e),n})(e,t,this.viewer,n),t=new I1(this.stage,e,r,this);return i||(this.reprList.push(t),this.signals.representationAdded.dispatch(t)),t}addBufferRepresentation(e,t){return this._addRepresentation.call(this,"buffer",e,t)}hasRepresentation(e){return-1!==this.reprList.indexOf(e)}eachRepresentation(e){this.reprList.slice().forEach(e)}removeRepresentation(e){var t=this.reprList.indexOf(e);-1!==t&&(this.reprList.splice(t,1),e.dispose(),this.signals.representationRemoved.dispatch(e))}updateRepresentations(t){this.reprList.forEach(e=>e.update(t)),this.stage.viewer.requestRender()}removeAllRepresentations(){this.eachRepresentation(e=>e.dispose())}dispose(){this.removeAllAnnotations(),this.removeAllRepresentations(),this.reprList.length=0,this.signals.disposed.dispatch()}setVisibility(e){return this.parameters.visible=e,this.eachRepresentation(e=>e.updateVisibility()),this.eachAnnotation(e=>e.updateVisibility()),this.signals.visibilityChanged.dispatch(e),this}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}getBox(...e){return this.getBoxUntransformed(...e).clone().applyMatrix4(this.matrix)}getCenter(...e){return this.getCenterUntransformed(...e).clone().applyMatrix4(this.matrix)}getZoom(...e){return this.stage.getZoomForBox(this.getBox(...e))}getBoxUntransformed(){return new ai}getCenterUntransformed(){return this.getBoxUntransformed().getCenter(new et)}autoView(e){this.stage.animationControls.zoomMove(this.getCenter(),this.getZoom(),ce(e,0))}}class k1{constructor(t=[]){var r=(this.list=t).length;for(let e=0;e<r;++e)t[e].signals.disposed.add(this._remove,this)}_remove(e){e=this.list.indexOf(e);-1!==e&&this.list.splice(e,1)}get first(){return 0<this.list.length?this.list[0]:void 0}forEach(e){return this.list.forEach(e),this}dispose(){return this.forEach(e=>e.dispose())}}class N1 extends k1{setParameters(t){return this.forEach(e=>e.setParameters(t))}setVisibility(t){return this.forEach(e=>e.setVisibility(t))}setSelection(t){return this.forEach(e=>e.setSelection(t))}setColor(t){return this.forEach(e=>e.setColor(t))}update(t){return this.forEach(e=>e.update(t))}build(t){return this.forEach(e=>e.build(t))}dispose(e){return this.forEach(e=>e.dispose())}}let F1=Object.assign({defaultStep:1,defaultTimeout:50,defaultInterpolateType:"",defaultInterpolateStep:5,defaultMode:"loop",defaultDirection:"forward",initialFrame:0},T1);class B1 extends E1{constructor(e,t,r={}){super(e,Object.assign({name:t.name},r)),this.trajectory=t,this.signals=Object.assign(this.signals,{frameChanged:new n.Signal,playerChanged:new n.Signal,countChanged:new n.Signal,parametersChanged:new n.Signal}),t.signals.frameChanged.add(e=>{this.signals.frameChanged.dispatch(e)}),t.signals.playerChanged.add(e=>{this.signals.playerChanged.dispatch(e)}),t.signals.countChanged.add(e=>{this.signals.countChanged.dispatch(e)}),void 0!==r.initialFrame&&this.setFrame(r.initialFrame)}get defaultParameters(){return F1}get type(){return"trajectory"}setFrame(e){this.trajectory.setFrame(e)}setParameters(e={}){this.trajectory.setParameters(e),this.signals.parametersChanged.dispatch(e)}dispose(){this.trajectory.dispose(),super.dispose()}}class U1{constructor(e,t){this.name=e,this.path=t,this.coordinates=[],this.boxes=[],this.times=[],this.timeOffset=0,this.deltaTime=1}get type(){return"Frames"}}class z1{constructor(e,t){this.A=new y(3,3),this.W=new y(1,3),this.U=new y(3,3),this.V=new y(3,3),this.VH=new y(3,3),this.R=new y(3,3),this.tmp=new y(3,3),this.c=new y(3,3);let r;if(e instanceof Kg)r=e.atomCount;else{if(!(e instanceof Float32Array))return;r=e.length/3}let i;if(t instanceof Kg)i=t.atomCount;else{if(!(t instanceof Float32Array))return;i=t.length/3}var n=Math.min(r,i),a=new y(3,n),s=new y(3,n);this.coords1t=new y(n,3),this.coords2t=new y(n,3),this.transformationMatrix=new tt,this.c.data.set([1,0,0,0,1,0,0,0,-1]),this.prepCoords(e,a,n,!1),this.prepCoords(t,s,n,!1),this._superpose(a,s)}_superpose(e,t){this.mean1=Hp(e),this.mean2=Hp(t),$p(e,this.mean1),$p(t,this.mean2),zp(this.coords1t,e),zp(this.coords2t,t),Vp(this.A,this.coords2t,this.coords1t),Yp(this.A,this.W,this.U,this.V),e=this.V,t=this.VH,e=e.data,t=t.data,g=e[4],u=e[8],c=e[5],r=e[7],n=(i=e[0])*g,m=i*c,a=(f=e[3])*(l=e[1]),p=f*(h=e[2]),s=(e=e[6])*l,o=1/(n*u-m*r-a*u+p*r+s*c-(d=e*h)*g),t[0]=(g*u-c*r)*o,t[1]=-(l*u-h*r)*o,t[2]=-(-l*c+h*g)*o,t[3]=-(f*u-c*e)*o,t[4]=(i*u-d)*o,t[5]=-(m-p)*o,t[6]=-(-f*r+g*e)*o,t[7]=-(i*r-s)*o,t[8]=(n-a)*o,Gp(this.R,this.U,this.VH),(l=(l=this.R).data)[0]*l[4]*l[8]-l[0]*l[5]*l[7]-l[3]*l[1]*l[8]+l[3]*l[2]*l[7]+l[6]*l[1]*l[5]-l[6]*l[2]*l[4]<0&&(Je.Debug&&rt.log("R not a right handed system"),Gp(this.tmp,this.c,this.VH),Gp(this.R,this.U,this.tmp));var r,i,n,a,s,o,l,h=new y(4,4),c=new y(4,4),u=new y(4,4),d=new y(4,4),m=new y(4,4),p=new y(4,4),f=this.R.data,g=this.mean1,e=this.mean2;d.data.set([1,0,0,-g[0],0,1,0,-g[1],0,0,1,-g[2],0,0,0,1]),m.data.set([f[0],f[1],f[2],0,f[3],f[4],f[5],0,f[6],f[7],f[8],0,0,0,0,1]),p.data.set([1,0,0,e[0],0,1,0,e[1],0,0,1,e[2],0,0,0,1]),zp(c,d),Vp(h,m,c),zp(u,h),Vp(c,p,u),zp(h,c),this.transformationMatrix.elements=h.data}prepCoords(e,t,r,i){let n=0,a=t.data,s=3,o=3*r;if(i&&(o=4*r,s=4),e instanceof Kg)e.eachAtom(function(e){n<o&&(a[n+0]=e.x,a[n+1]=e.y,a[n+2]=e.z,i&&(a[n+3]=1),n+=s)});else if(e instanceof Float32Array)for(;n<o;n+=s)n<o&&(a[n]=e[n],a[n+1]=e[n+1],a[n+2]=e[n+2],i)&&(a[n+3]=1);else rt.warn("prepCoords: input type unknown")}transform(e){let t;if(e instanceof Kg)t=e.atomCount;else{if(!(e instanceof Float32Array))return;t=e.length/3}var h=new y(4,t),c=new y(t,4);this.prepCoords(e,h,t,!0);let r=this.transformationMatrix;var u=r.determinant();if(!u)return u;u=new y(4,4);u.data=r.elements;{var d=c;let e=0,t=0,r=0,i=0,n=0,a=0,s=0,o=0;var m=h.cols,p=h.rows,f=u.cols,g=h.data,v=u.data,_=d.data;let l=0;for(;e<p;i+=m,e++)for(s=0,t=0;t<f;o++,s++,t++){for(a=s,n=i,l=0,r=0;r<m;n++,a+=f,r++)l+=g[n]*v[a];_[o]=l}}let i=0,n=c.data;if(e instanceof Kg){e.eachAtom(function(e){e.x=n[i],e.y=n[i+1],e.z=n[i+2],i+=4});let t=new tt;t.copy(r).invert();var a,s=e.biomolDict;for(a in s)s.hasOwnProperty(a)&&s[a].partList.forEach(function(e){e.matrixList.forEach(function(e){e.premultiply(r),e.multiply(t)})})}else if(e instanceof Float32Array)for(var o=4*t;i<o;i+=4)e[i]=n[i],e[i+1]=n[i+1],e[i+2]=n[i+2];else rt.warn("transform: input type unknown");return this.transformationMatrix}}let V1={step:1,timeout:50,start:0,end:0,interpolateType:"",interpolateStep:5,mode:"loop",direction:"forward"};class G1{constructor(e,t={}){this.signals={startedRunning:new n.Signal,haltedRunning:new n.Signal},this._run=!1,this._previousTime=0,this._currentTime=0,this._currentStep=1,e.signals.playerChanged.add(e=>{e!==this&&this.pause()},this);var r=ce(e.frameCount,1);this.traj=e,this.parameters=Vl(t,V1),this.parameters.end=Math.min(ce(t.end,r-1),r-1),this.parameters.step=ce(t.step,Math.ceil((r+1)/100)),this._currentFrame=this.parameters.start,this._direction="bounce"===this.parameters.direction?"forward":this.parameters.direction,e.signals.countChanged.add(e=>{this.parameters.end=Math.min(ce(this.parameters.end,e-1),e-1)},this),this._animate=this._animate.bind(this)}get isRunning(){return this._run}setParameters(e={}){Gl(this.parameters,e),void 0!==e.direction&&"bounce"!==this.parameters.direction&&(this._direction=this.parameters.direction)}_animate(){var e,t,r,i,n,a;this._run&&(this._currentTime=window.performance.now(),a=this._currentTime-this._previousTime,t=this.parameters.interpolateType?this.parameters.interpolateStep:1,t=this.parameters.timeout/t,(e=this.traj)&&e.frameCount&&!e.inProgress&&t<=a&&(this.parameters.interpolateType?(this._currentStep>this.parameters.interpolateStep&&(this._currentStep=1),1===this._currentStep&&(this._currentFrame=this._nextInterpolated()),e.hasFrame(this._currentFrame)?(this._currentStep+=1,t=this._currentStep/(this.parameters.interpolateStep+1),[a,r,i,n]=this._currentFrame,e.setFrameInterpolated(a,r,i,n,t,this.parameters.interpolateType),this._previousTime=this._currentTime):e.loadFrame(this._currentFrame)):(a=this._next(),e.hasFrame(a)?(e.setFrame(a),this._previousTime=this._currentTime):e.loadFrame(a))),window.requestAnimationFrame(this._animate))}_next(){var e=this.parameters;let t;return((t="forward"===this._direction?this.traj.currentFrame+e.step:this.traj.currentFrame-e.step)>e.end||t<e.start)&&("bounce"===e.direction&&("forward"===this._direction?this._direction="backward":this._direction="forward"),"once"===e.mode?(this.pause(),t="forward"!==e.direction&&("backward"===e.direction||"forward"===this._direction)?e.start:e.end):"forward"===this._direction?(t=e.start,e.interpolateType&&(t=Math.min(e.end,t+e.step))):(t=e.end,e.interpolateType&&(t=Math.max(e.start,t-e.step)))),t}_nextInterpolated(){var e=this.parameters,t=this._next();let r,i,n;return n="forward"===this._direction?(r=Math.max(e.start,t-e.step),i=Math.max(e.start,t-2*e.step),Math.max(e.start,t-3*e.step)):(r=Math.min(e.end,t+e.step),i=Math.min(e.end,t+2*e.step),Math.min(e.end,t+3*e.step)),[t,r,i,n]}toggle(){this._run?this.pause():this.play()}play(){if(!this._run){this.traj.player!==this&&this.traj.setPlayer(this),this._currentStep=1;var t=this.parameters,r=this.traj.currentFrame;let e=Math.ceil(r/t.step)*t.step;"forward"===t.direction&&r>=t.end?e=t.start:"backward"===t.direction&&r<=t.start&&(e=t.end),this.traj.setFrame(e),this._run=!0,this._animate(),this.signals.startedRunning.dispatch()}}pause(){this._run=!1,this.signals.haltedRunning.dispatch()}stop(){this.pause(),this.traj.setFrame(this.parameters.start)}}class H1{constructor(e,t,r={}){this.signals={countChanged:new n.Signal,frameChanged:new n.Signal,playerChanged:new n.Signal},this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this._frameCount=0,this._currentFrame=-1,this._disposed=!1,this.deltaTime=ce(r.deltaTime,0),this.timeOffset=ce(r.timeOffset,0),this.centerPbc=ce(r.centerPbc,!1),this.removePbc=ce(r.removePbc,!1),this.removePeriodicity=ce(r.removePeriodicity,!1),this.superpose=ce(r.superpose,!1),this.name=e.replace(/^.*[\\/]/,""),this.trajPath=e,this.selection=new qh(ce(r.sele,"backbone and not hydrogen")),this.selection.signals.stringChanged.add(()=>{this.selectionIndices=this.structure.getAtomIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)})}get frameCount(){return this._frameCount}get currentFrame(){return this._currentFrame}_init(e){this.setStructure(e),this._loadFrameCount(),this.setPlayer(new G1(this))}_loadFrameCount(){}setStructure(e){this.structure=e,this.atomCount=e.atomCount,this.backboneIndices=this._getIndices(new qh("backbone and not hydrogen")),this._makeAtomIndices(),this._saveStructureCoords(),this.selectionIndices=this._getIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)}_saveInitialCoords(){this.structure.hasCoords()?(this.initialCoords=new Float32Array(this.structureCoords),this._makeSuperposeCoords()):this.frameCache[0]?(this.initialCoords=new Float32Array(this.frameCache[0]),this._makeSuperposeCoords()):this.loadFrame(0,()=>this._saveInitialCoords())}_saveStructureCoords(){this.structureCoords=this.structure.getAtomData({what:{position:!0}}).position}setSelection(e){return this.selection.setString(e),this}_getIndices(e){let t=0,r=e.test,i=[];return r&&this.structure.eachAtom(e=>{r(e)&&i.push(t),t+=1}),i}_makeSuperposeCoords(){var t=3*this.selectionIndices.length,r=(this.coords1=new Float32Array(t),this.coords2=new Float32Array(t),this.initialCoords),i=this.coords2;for(let e=0;e<t;e+=3){var n=3*this.selectionIndices[e/3];i[e+0]=r[0+n],i[e+1]=r[1+n],i[e+2]=r[2+n]}}_makeAtomIndices(){rt.error("Trajectory._makeAtomIndices not implemented")}_resetCache(){this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this.initialCoords=new Float32Array(0)}setParameters(e={}){let t=!1;void 0!==e.centerPbc&&e.centerPbc!==this.centerPbc&&(this.centerPbc=e.centerPbc,t=!0),void 0!==e.removePeriodicity&&e.removePeriodicity!==this.removePeriodicity&&(this.removePeriodicity=e.removePeriodicity,t=!0),void 0!==e.removePbc&&e.removePbc!==this.removePbc&&(this.removePbc=e.removePbc,t=!0),void 0!==e.superpose&&e.superpose!==this.superpose&&(this.superpose=e.superpose,t=!0),this.deltaTime=ce(e.deltaTime,this.deltaTime),this.timeOffset=ce(e.timeOffset,this.timeOffset),t&&(this._resetCache(),this.setFrame(this._currentFrame))}hasFrame(e){return Array.isArray(e)?e.every(e=>!!this.frameCache[e]):!!this.frameCache[e]}setFrame(e,t){return void 0!==e&&(this.inProgress=!0,-1===e||this.frameCache[e]?(this._updateStructure(e),t&&t()):this.loadFrame(e,()=>{this._updateStructure(e),t&&t()})),this}_interpolate(e,t,r,i,n,a){var s=this.frameCache;let o;o="spline"===a?((t,r,i,n,a)=>{var s=t.length,o=new Float32Array(s);for(let e=0;e<s;e+=3){var l=e+1,h=e+2;o[e]=dh(n[e],i[e],r[e],t[e],a,1),o[l]=dh(n[l],i[l],r[l],t[l],a,1),o[h]=dh(n[h],i[h],r[h],t[h],a,1)}return o})(s[e],s[t],s[r],s[i],n):((t,r,i)=>{var n=t.length,a=new Float32Array(n);for(let e=0;e<n;e+=3){var s=e+1,o=e+2;a[e]=uh(r[e],t[e],i),a[s]=uh(r[s],t[s],i),a[o]=uh(r[o],t[o],i)}return a})(s[e],s[t],n),this.structure.updatePosition(o),this._currentFrame=e,this.signals.frameChanged.dispatch(e)}setFrameInterpolated(e,t,r,i,n,a,s){var o,l;return void 0!==e&&(l=[],(o=this.frameCache)[i]||l.push(i),o[r]||l.push(r),o[t]||l.push(t),o[e]||l.push(e),l.length?this.loadFrame(l,()=>{this._interpolate(e,t,r,i,n,a),s&&s()}):(this._interpolate(e,t,r,i,n,a),s&&s())),this}loadFrame(e,t){Array.isArray(e)?e.forEach(e=>{this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,()=>{delete this.loadQueue[e]}))}):this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,()=>{delete this.loadQueue[e],t&&t()}))}_loadFrame(e,t){rt.error("Trajectory._loadFrame not implemented",e,t)}_updateStructure(e){this._disposed?console.error("updateStructure: traj disposed"):(-1===e?this.structureCoords&&this.structure.updatePosition(this.structureCoords):this.structure.updatePosition(this.frameCache[e]),this.structure.trajectory={name:this.trajPath,frame:e},this._currentFrame=e,this.inProgress=!1,this.signals.frameChanged.dispatch(e))}_doSuperpose(t){var r=3*this.selectionIndices.length,i=this.coords1,e=this.coords2;for(let e=0;e<r;e+=3){var n=3*this.selectionIndices[e/3];i[e+0]=t[0+n],i[e+1]=t[1+n],i[e+2]=t[2+n]}new z1(i,e).transform(t)}_process(e,t,r,i){if(this._setFrameCount(i),t){if(0<this.backboneIndices.length&&this.centerPbc){var i=[t[0],t[4],t[8]],n=(o=this.backboneIndices,[$c(n=r,(s=i)[0],3,0,o),$c(n,s[1],3,1,o),$c(n,s[2],3,2,o)]),a=r,s=n,o=i;if(0!==o[0]&&0!==o[8]&&0!==o[4]){var l=a.length,h=o[0],c=o[1],u=o[2],d=-s[0]+h+h/2,m=-s[1]+c+c/2,p=-s[2]+u+u/2;for(let e=0;e<l;e+=3)a[e+0]=(a[e+0]+d)%h,a[e+1]=(a[e+1]+m)%c,a[e+2]=(a[e+2]+p)%u}}if(this.removePeriodicity){var i=[ru(n=r,3,0),ru(n,3,1),ru(n,3,2)],f=r,g=t,v=i;if(0!==g[0]&&0!==g[8]&&0!==g[4]){var _=f.length;for(let t=3;t<_;t+=3)for(let e=0;e<3;++e){var y=(f[t+e]-v[e])/g[3*e+e];.5<Math.abs(y)&&(f[t+e]-=g[3*e+e]*Math.round(y))}}}if(this.removePbc){var b=r,x=t;if(0!==x[0]&&0!==x[8]&&0!==x[4]){var S=b.length;for(let r=3;r<S;r+=3)for(let t=0;t<3;++t){var w=b[r+t]-b[r-3+t];if(Math.abs(w)>.9*x[3*t+t])if(0<w)for(let e=0;e<3;++e)b[r+e]-=x[3*t+e];else for(let e=0;e<3;++e)b[r+e]+=x[3*t+e]}}}}var o,n,s;0<this.selectionIndices.length&&this.coords1&&this.superpose&&this._doSuperpose(r),this.frameCache[e]=r,this.boxCache[e]=t,this.frameCacheSize+=1}_setFrameCount(e){e!==this._frameCount&&(this._frameCount=e,this.signals.countChanged.dispatch(e))}dispose(){this._resetCache(),this._disposed=!0,this.player&&this.player.stop()}setPlayer(e){this.player=e,this.signals.playerChanged.dispatch(e)}getFrameTime(e){return this.timeOffset+e*this.deltaTime}}class $1 extends H1{constructor(e,t,r){r=r||{};r.timeOffset=ce(r.timeOffset,e.timeOffset),r.deltaTime=ce(r.deltaTime,e.deltaTime),super("",t,r),this.name=e.name,this.path=e.path,this.frames=e.coordinates,this.boxes=e.boxes,this._init(t)}get type(){return"frames"}_makeAtomIndices(){"StructureView"===this.structure.type?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,t){let r;var i=this.frames[e];if(this.atomIndices){var n=this.atomIndices,a=n.length;r=new Float32Array(3*a);for(let e=0;e<a;++e){var s=3*e,o=3*n[e];r[0+s]=i[0+o],r[1+s]=i[1+o],r[2+s]=i[2+o]}}else r=new Float32Array(i);var l=this.boxes[e],h=this.frames.length;this._process(e,l,r,h),"function"==typeof t&&t()}_loadFrameCount(){this.frames&&this._setFrameCount(this.frames.length)}}class j1 extends H1{constructor(e,t,r){super("",t,r),this._init(t)}get type(){return"structure"}_makeAtomIndices(){this.structure.atomSet&&this.structure.atomSet.getSize()<this.structure.atomStore.count?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,t){let r;var i=this.structure,n=i.frames[e];if(this.atomIndices){var a=this.atomIndices,s=a.length;r=new Float32Array(3*s);for(let e=0;e<s;++e){var o=3*e,l=3*a[e];r[0+o]=n[0+l],r[1+o]=n[1+l],r[2+o]=n[2+l]}}else r=new Float32Array(n);var h=i.boxes[e],i=i.frames.length;this._process(e,h,r,i),"function"==typeof t&&t()}_loadFrameCount(){this._setFrameCount(this.structure.frames.length)}}class W1 extends H1{constructor(e,t,r){super(e,t,r),this._init(t)}get type(){return"remote"}_makeAtomIndices(){var i=[];if("StructureView"===this.structure.type){var n=this.structure.getAtomIndices(),a=n.length;let t=n[0],r=n[0];for(let e=1;e<a;++e){var s=n[e];r+1<s&&(i.push([t,r+1]),t=s),r=s}i.push([t,r+1])}else i.push([0,this.atomCount]);this.atomIndices=i}_loadFrame(i,n){let a=new XMLHttpRequest,s=Je.TrajectoryDatasource.getFrameUrl(this.trajPath,i);var e=Je.TrajectoryDatasource.getFrameParams(this.trajPath,this.atomIndices);a.open("POST",s,!0),a.responseType="arraybuffer",a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.addEventListener("load",()=>{var e,t,r=a.response;r?(e=new Int32Array(r,0,1)[0],t=new Float32Array(r,8,9),r=new Float32Array(r,44),this._process(i,t,r,e),"function"==typeof n&&n()):rt.error(`empty arrayBuffer for '${s}'`)},!1),a.send(e)}_loadFrameCount(){let e=new XMLHttpRequest;var t=Je.TrajectoryDatasource.getCountUrl(this.trajPath);e.open("GET",t,!0),e.addEventListener("load",()=>{this._setFrameCount(parseInt(e.response))},!1),e.send()}}class q1 extends H1{constructor(e,t,r){super("",t,r),this.requestCallback=e,this._init(t)}get type(){return"callback"}_makeAtomIndices(){var i=[];if("StructureView"===this.structure.type){var n=this.structure.getAtomIndices(),a=n.length;let t=n[0],r=n[0];for(let e=1;e<a;++e){var s=n[e];r+1<s&&(i.push([t,r+1]),t=s),r=s}i.push([t,r+1])}else i.push([0,this.atomCount]);this.atomIndices=i}_loadFrame(e,n){this.requestCallback((e,t,r,i)=>{this._process(e,t,r,i),"function"==typeof n&&n()},e,this.atomIndices)}_loadFrameCount(){this.requestCallback(e=>this._setFrameCount(e))}}Kg.prototype.getView=function(e){return new X1(this,e)};class X1 extends Kg{constructor(e,t){super(),this.structure=e,this.selection=t,this.center=new et,this.boundingBox=new ai,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy(),this.selection&&this.selection.signals.stringChanged.add(this.refresh,this),this.structure.signals.refreshed.add(this.refresh,this),this.refresh()}init(){}get type(){return"StructureView"}get name(){return this.structure.name}get path(){return this.structure.path}get title(){return this.structure.title}get id(){return this.structure.id}get data(){return this.structure.data}get atomSetDict(){return this.structure.atomSetDict}get biomolDict(){return this.structure.biomolDict}get entityList(){return this.structure.entityList}get unitcell(){return this.structure.unitcell}get frames(){return this.structure.frames}get boxes(){return this.structure.boxes}get validation(){return this.structure.validation}get bondStore(){return this.structure.bondStore}get backboneBondStore(){return this.structure.backboneBondStore}get rungBondStore(){return this.structure.rungBondStore}get atomStore(){return this.structure.atomStore}get residueStore(){return this.structure.residueStore}get chainStore(){return this.structure.chainStore}get modelStore(){return this.structure.modelStore}get atomMap(){return this.structure.atomMap}get residueMap(){return this.structure.residueMap}get bondHash(){return this.structure.bondHash}get spatialHash(){return this.structure.spatialHash}get _hasCoords(){return this.structure._hasCoords}set _hasCoords(e){this.structure._hasCoords=e}refresh(){Je.Debug&&rt.time("StructureView.refresh"),this.atomSetCache={};var e=this.structure;if(this.selection.isAllSelection()&&e!==this&&e.atomSet&&e.bondSet){for(var t in this.atomSet=e.atomSet.clone(),this.bondSet=e.bondSet.clone(),this.atomSetDict){var r=this.atomSetDict[t];this.atomSetCache["__"+t]=r.clone()}this.atomCount=e.atomCount,this.bondCount=e.bondCount,this.boundingBox.copy(e.boundingBox),this.center.copy(e.center)}else if(this.selection.isNoneSelection()&&e!==this&&e.atomSet&&e.bondSet){for(var i in this.atomSet=new Kd(e.atomCount),this.bondSet=new Kd(e.bondCount),this.atomSetDict)this.atomSetCache["__"+i]=new Kd(e.atomCount);this.atomCount=0,this.bondCount=0,this.boundingBox.makeEmpty(),this.center.set(0,0,0)}else{for(var n in this.atomSet=this.getAtomSet(this.selection,!0),e.atomSet&&(this.atomSet=this.atomSet.intersection(e.atomSet)),this.bondSet=this.getBondSet(),this.atomSetDict){var a=this.atomSetDict[n];this.atomSetCache["__"+n]=a.makeIntersection(this.atomSet)}this.atomCount=this.atomSet.getSize(),this.bondCount=this.bondSet.getSize(),this.boundingBox=this.getBoundingBox(),this.center=this.boundingBox.getCenter(new et)}Je.Debug&&rt.timeEnd("StructureView.refresh"),this.signals.refreshed.dispatch()}setSelection(e){this.selection=e,this.refresh()}getSelection(e){var t=[],e=(e&&e.string&&t.push(e.string),this.structure.getSelection());e&&e.string&&t.push(e.string),this.selection&&this.selection.string&&t.push(this.selection.string);let r="";return 0<t.length&&(r=`( ${t.join(" ) AND ( ")} )`),new qh(r)}getStructure(){return this.structure.getStructure()}eachBond(e,t){this.structure.eachBond(e,this.getSelection(t))}eachAtom(t,e){let r=this.getAtomProxy();var e=this.getAtomSet(e),i=this.atomStore.count;if(e.getSize()<i)e.forEach(function(e){r.index=e,t(r)});else for(let e=0;e<i;++e)r.index=e,t(r)}eachResidue(e,t){this.structure.eachResidue(e,this.getSelection(t))}eachResidueN(e,t){console.error("StructureView.eachResidueN() not implemented")}eachChain(e,t){this.structure.eachChain(e,this.getSelection(t))}eachModel(e,t){this.structure.eachModel(e,this.getSelection(t))}getAtomSet(e,t=!1){let r=this.structure.getAtomSet(e);return r=!t&&this.atomSet?r.makeIntersection(this.atomSet):r}getAtomIndices(e){return this.structure.getAtomIndices(this.getSelection(e))}refreshPosition(){return this.structure.refreshPosition()}dispose(){this.selection&&this.selection.signals.stringChanged.remove(this.refresh,this),this.structure.signals.refreshed.remove(this.refresh,this),this.structure=new Kg,delete this.atomSet,delete this.bondSet}}let Y1=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]],K1=[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]];function Z1(r,e){let i,n=0,a={};return e.forEach(function(e){i=0;let t={};e.forEach(function(e){t[r[i++]]=e}),a[r[n++]]=t}),a}let Q1={blosum62:Z1("ARNDCQEGHILKMFPSTWYVBZ?",K1),blosum62x:Z1("ACDEFGHIKLMNPQRSTVWY",Y1)};class J1{constructor(e,t,r=-10,i=-1,n="blosum62"){this.seq1=e,this.seq2=t,this.gapPenalty=r,this.gapExtensionPenalty=i,n&&(this.substMatrix=Q1[n])}initMatrices(){this.n=this.seq1.length,this.m=this.seq2.length,this.score=void 0,this.ali="",this.S=[],this.V=[],this.H=[];for(let t=0;t<=this.n;++t){this.S[t]=[],this.V[t]=[],this.H[t]=[];for(let e=0;e<=this.m;++e)this.S[t][e]=0,this.V[t][e]=0,this.H[t][e]=0}for(let e=0;e<=this.n;++e)this.S[e][0]=this.gap(0),this.H[e][0]=-1/0;for(let e=0;e<=this.m;++e)this.S[0][e]=this.gap(0),this.V[0][e]=-1/0;this.S[0][0]=0}gap(e){return this.gapPenalty+e*this.gapExtensionPenalty}makeScoreFn(){let r=this.seq1,i=this.seq2,n=this.substMatrix;return n?function(e,t){e=r[e],t=i[t];try{return n[e][t]}catch(e){return-4}}:(rt.warn("Alignment: no subst matrix"),function(e,t){return r[e]===i[t]?5:-3})}calc(){Je.Debug&&rt.time("Alignment.calc"),this.initMatrices();var r,i,n,a,s,o=this.gap(0),l=this.makeScoreFn(),h=this.gapExtensionPenalty,e=this.V,c=this.H,u=this.S,d=this.n,m=this.m;for(let t=1;t<=d;++t){i=u[t-1],r=e[t-1],n=e[t],a=c[t],s=u[t];for(let e=1;e<=m;++e)n[e]=Math.max(i[e]+o,r[e]+h),a[e]=Math.max(s[e-1]+o,a[e-1]+h),s[e]=Math.max(i[e-1]+l(t-1,e-1),n[e],a[e])}Je.Debug&&rt.timeEnd("Alignment.calc"),Je.Debug&&rt.log(this.S,this.V,this.H)}trace(){Je.Debug&&rt.time("Alignment.trace"),this.ali1="",this.ali2="";var e=this.makeScoreFn();let t=this.n,r=this.m,i;for(this.S[t][r]>=this.V[t][r]?(i="S",this.score=this.S[t][r]):this.V[t][r]>=this.H[t][r]?(i="V",this.score=this.V[t][r]):(i="H",this.score=this.H[t][r]),Je.Debug&&rt.log("Alignment: SCORE",this.score),Je.Debug&&rt.log("Alignment: S, V, H",this.S[t][r],this.V[t][r],this.H[t][r]);0<t&&0<r;)"S"===i?this.S[t][r]===this.S[t-1][r-1]+e(t-1,r-1)?(this.ali1=this.seq1[t-1]+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--t,--r,i="S"):this.S[t][r]===this.V[t][r]?i="V":this.S[t][r]===this.H[t][r]?i="H":(--t,--r):"V"===i?this.V[t][r]===this.V[t-1][r]+this.gapExtensionPenalty?(this.ali1=this.seq1[t-1]+this.ali1,this.ali2="-"+this.ali2,--t,i="V"):this.V[t][r]===this.S[t-1][r]+this.gap(0)?(this.ali1=this.seq1[t-1]+this.ali1,this.ali2="-"+this.ali2,--t,i="S"):--t:"H"===i?this.H[t][r]===this.H[t][r-1]+this.gapExtensionPenalty?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,i="H"):this.H[t][r]===this.S[t][r-1]+this.gap(0)?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,i="S"):--r:rt.error("Alignment: no matrix");for(;0<t;)this.ali1=this.seq1[t-1]+this.ali1,this.ali2="-"+this.ali2,--t;for(;0<r;)this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r;Je.Debug&&rt.timeEnd("Alignment.trace"),Je.Debug&&rt.log([this.ali1,this.ali2])}}function e0(c,u,d=!1,m="",p=""){let f,g;var v;let _,y;if(d){let e=c,t=u;m&&p&&(e=c.getView(new qh(m)),t=u.getView(new qh(p)));var d=e.getSequence(),b=t.getSequence(),x=new J1(d.join(""),b.join(""));x.calc(),x.trace();let r,i,n=(f=0,g=0,v=x.ali1.length,[]),a=[];for(let e=0;e<v;++e){var S=x.ali1[e],w=x.ali2[e];r=0,i=0,"-"===S?a[g]=!1:(a[g]=!0,r=1),"-"===w?n[f]=!1:(n[f]=!0,i=1),f+=r,g+=i}let s=[],o=[],l=e.getAtomProxy(),h=t.getAtomProxy();f=0,e.eachResidue(function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(n[f]&&(l.index=e.getAtomIndexByName("CA"),s.push(l.x,l.y,l.z)),f+=1)}),f=0,t.eachResidue(function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(a[f]&&(h.index=e.getAtomIndexByName("CA"),o.push(h.x,h.y,h.z)),f+=1)}),_=new Float32Array(s),y=new Float32Array(o)}else{d=c.getView(new qh(m+" and .CA")),b=u.getView(new qh(p+" and .CA"));_=d,y=b}m=new z1(_,y).transform(c);return c.refreshPosition(),m}let t0=Object.assign({sele:"",defaultAssembly:""},L1);class r0 extends O1{constructor(e,t,r={}){super(e,t,Object.assign({name:t.name},r)),this.structure=t,this.trajList=[],this.signals=Object.assign(this.signals,{trajectoryAdded:new n.Signal,trajectoryRemoved:new n.Signal,defaultAssemblyChanged:new n.Signal}),this.initSelection(this.parameters.sele),this.pickBuffer=(t=>{let r=0,i=0,n=[];return{has:function(e){return-1!==n.indexOf(e)},get:function(e){return n[e]},push:function(e){n[r]=e,r=(t+r+1)%t,++i},get count(){return i},get data(){return n.slice(0,Math.min(i,t))},clear:function(){i=0,r=0,n.length=0}}})(4),this.pickDict=(()=>{let r={};return{has:function(e){return void 0!==r[JSON.stringify(e)]},add:function(e,t){r[JSON.stringify(e)]=t},del:function(e){delete r[JSON.stringify(e)]},get values(){return Object.keys(r).map(e=>r[e])}}})(),this.spacefillRepresentation=this.addRepresentation("spacefill",{sele:"none",opacity:hc.opacity,color:hc.color,disablePicking:!0,radiusType:"data"},!0),this.distanceRepresentation=this.addRepresentation("distance",hc,!0),this.angleRepresentation=this.addRepresentation("angle",hc,!0),this.dihedralRepresentation=this.addRepresentation("dihedral",hc,!0),this.measureRepresentations=new N1([this.spacefillRepresentation,this.distanceRepresentation,this.angleRepresentation,this.dihedralRepresentation]),this.setDefaultAssembly(this.parameters.defaultAssembly),this.structure.signals.refreshed.add(()=>{this.updateRepresentations({position:!0})})}get defaultParameters(){return t0}get type(){return"structure"}initSelection(e){this.selection=new qh(e),this.structureView=new X1(this.structure,this.selection),this.selection.signals.stringChanged.add(()=>{this.structureView.setSelection(this.selection),this.rebuildRepresentations(),this.rebuildTrajectories()})}setSelection(e){return this.parameters.sele=e,this.selection.setString(e),this}setDefaultAssembly(e){if(void 0===this.structure.biomolDict[e]&&(e=""),this.parameters.defaultAssembly!==e){let t={defaultAssembly:e};this.reprList.forEach(e=>e.setParameters(t)),this.measureRepresentations.setParameters(t),this.parameters.defaultAssembly=e,this.signals.defaultAssemblyChanged.dispatch(e)}return this}rebuildRepresentations(){this.reprList.forEach(e=>{e.build()}),this.measureRepresentations.build()}rebuildTrajectories(){this.trajList.forEach(e=>{e.trajectory.setStructure(this.structureView)})}updateRepresentations(e){super.updateRepresentations(e),this.measureRepresentations.update(e)}updateRepresentationMatrices(){super.updateRepresentationMatrices(),this.measureRepresentations.setParameters({matrix:this.matrix})}addRepresentation(e,t={},r=!1){t.defaultAssembly=this.parameters.defaultAssembly;e=this._addRepresentation(e,this.structureView,t,r);return r||e.signals.parametersChanged.add(()=>this.measureUpdate()),e}addTrajectory(e="",t={}){e=((e,t,r)=>{let i;return i=new(e&&e instanceof U1?$1:!e&&t.frames?j1:e&&"function"==typeof e?q1:W1)(e,t,r)})(e,this.structureView,t),e=new B1(this.stage,e,t);return this.trajList.push(e),this.signals.trajectoryAdded.dispatch(e),e}removeTrajectory(e){var t=this.trajList.indexOf(e);-1!==t&&this.trajList.splice(t,1),e.dispose(),this.signals.trajectoryRemoved.dispatch(e)}dispose(){this.trajList.slice().forEach(e=>e.dispose()),this.trajList.length=0,this.structure.dispose(),this.measureRepresentations.dispose(),super.dispose()}autoView(e,t){"number"==typeof e&&(t=e,e=""),this.stage.animationControls.zoomMove(this.getCenter(e),this.getZoom(e),ce(t,0))}getBoxUntransformed(e){let t;return t=e?this.structureView.getBoundingBox(new qh(e)):this.structureView.boundingBox}getCenterUntransformed(e){return e&&"string"==typeof e?this.structure.atomCenter(new qh(e)):this.structure.center}superpose(e,t,r,i){return e0(this.structureView,e.structureView,t,r,i),this.updateRepresentations({position:!0}),this}getMaxRepresentationRadius(e){let t=0,r=this.structure.getAtomProxy(e);return this.eachRepresentation(e=>{e.getVisibility()&&(e=e.repr,t=Math.max(e.getAtomRadius(r),t))}),t}measurePick(e){var t,r,i=this.pickBuffer.count;this.lastPick===e.index&&1<=i?(1<i&&(t=this.pickBuffer.data,r=this.pickBuffer.data.sort(),this.pickDict.has(r)?this.pickDict.del(r):this.pickDict.add(r,t),2===i?this.distanceRepresentation.setParameters({atomPair:this.pickDict.values.filter(e=>2===e.length)}):3===i?this.angleRepresentation.setParameters({atomTriple:this.pickDict.values.filter(e=>3===e.length)}):4===i&&this.dihedralRepresentation.setParameters({atomQuad:this.pickDict.values.filter(e=>4===e.length)})),this.pickBuffer.clear(),this.lastPick=void 0):(this.pickBuffer.has(e.index)||this.pickBuffer.push(e.index),this.lastPick=e.index),this.measureUpdate()}measureClear(){this.pickBuffer.clear(),this.lastPick=void 0,this.spacefillRepresentation.setSelection("none")}measureBuild(){var e=this.measureData();this.distanceRepresentation.setParameters({atomPair:e.distance}),this.angleRepresentation.setParameters({atomTriple:e.angle}),this.dihedralRepresentation.setParameters({atomQuad:e.dihedral})}measureUpdate(){var e=this.pickBuffer.data;let r={};e.forEach(e=>{var t=Math.max(.1,this.getMaxRepresentationRadius(e));r[e]=t*(2.3-mh(.1,2,t))}),this.spacefillRepresentation.setSelection(e.length?"@"+e.join(","):"none"),e.length&&this.spacefillRepresentation.setParameters({radiusData:r})}measureData(){var e=this.pickDict.values;return{distance:e.filter(e=>2===e.length),angle:e.filter(e=>3===e.length),dihedral:e.filter(e=>4===e.length)}}removeAllMeasurements(e){let r=this.pickDict,i=r.values;function t(t){i.filter(e=>e.length===t).forEach(e=>r.del(e.slice().sort()))}(!e||1&e)&&t(2),(!e||2&e)&&t(3),(!e||4&e)&&t(4),this.measureBuild()}removeMeasurement(e){this.pickDict.del(e.slice().sort()),this.measureBuild()}addMeasurement(e){var t;e.length<2||4<e.length||(t=e.slice().sort(),this.pickDict.has(t)||this.pickDict.add(t,e),this.measureBuild())}}fc.add("structure",r0),fc.add("structureview",r0);class i0 extends O1{constructor(e,t,r={}){super(e,t,Object.assign({name:t.name},r)),this.surface=t}get type(){return"surface"}addRepresentation(e,t={}){return this._addRepresentation(e,this.surface,t)}getBoxUntransformed(){return this.surface.boundingBox}getCenterUntransformed(){return this.surface.center}dispose(){this.surface.dispose(),super.dispose()}}fc.add("surface",i0);class n0 extends O1{constructor(e,t,r={}){super(e,t,Object.assign({name:t.name},r)),this.volume=t}get type(){return"volume"}addRepresentation(e,t={}){return this._addRepresentation(e,this.volume,t)}getBoxUntransformed(){return this.volume.boundingBox}getCenterUntransformed(){return this.volume.center}dispose(){this.volume.dispose(),super.dispose()}}fc.add("volume",n0);class a0 extends k1{addRepresentation(t,r){return this.forEach(e=>e.addRepresentation(t,r))}autoView(t){return this.forEach(e=>e.autoView(t))}}function s0(e,t){return e instanceof RegExp?null!==t.name.match(e):t.name===e}let o0=new et,l0={impostor:!0,quality:"medium",workerDefault:!0,sampleLevel:0,backgroundColor:"black",rotateSpeed:2,zoomSpeed:1.2,panSpeed:1,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",fogNear:50,fogFar:100,cameraFov:40,cameraEyeSep:.3,cameraType:"perspective",lightColor:14540253,lightIntensity:1.2,ambientColor:14540253,ambientIntensity:.3,hoverTimeout:0,tooltip:!0,mousePreset:"default"};class h0{constructor(e,t={}){this.signals={parametersChanged:new n.Signal,fullscreenChanged:new n.Signal,componentAdded:new n.Signal,componentRemoved:new n.Signal,clicked:new n.Signal,hovered:new n.Signal},this.tasks=new kc,this.compList=[],this.defaultFileParams={},this.logList=[],this.viewer=new Su(e),this.viewer.renderer&&(this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{display:"none",position:"fixed",zIndex:"1000000",pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.viewer.container.appendChild(this.tooltip),this.mouseObserver=new Au(this.viewer.renderer.domElement),this.viewerControls=new Xu(this),this.trackballControls=new Nu(this),this.pickingControls=new Uu(this),this.animationControls=new nd(this),this.mouseControls=new Tf(this),this.keyControls=new If(this),this.pickingBehavior=new Rf(this),this.mouseBehavior=new Df(this),this.animationBehavior=new Lf(this),this.keyBehavior=new kf(this),this.spinAnimation=this.animationControls.spin([0,1,0],.005),this.spinAnimation.pause(!0),this.rockAnimation=this.animationControls.rock([0,1,0],.005),this.rockAnimation.pause(!0),this.parameters=Vl(t,l0),this.setParameters(this.parameters),this.viewer.animate())}setParameters(e={}){Gl(this.parameters,e);var t=this.parameters,r=this.viewer,i=this.trackballControls;return void 0!==e.quality&&this.setQuality(t.quality),void 0!==e.impostor&&this.setImpostor(t.impostor),void 0!==e.rotateSpeed&&(i.rotateSpeed=t.rotateSpeed),void 0!==e.zoomSpeed&&(i.zoomSpeed=t.zoomSpeed),void 0!==e.panSpeed&&(i.panSpeed=t.panSpeed),void 0!==e.mousePreset&&this.mouseControls.preset(t.mousePreset),this.mouseObserver.setParameters({hoverTimeout:t.hoverTimeout}),r.setClip(t.clipNear,t.clipFar,t.clipDist,t.clipMode,t.clipScale),r.setFog(void 0,t.fogNear,t.fogFar),r.setCamera(t.cameraType,t.cameraFov,t.cameraEyeSep),r.setSampling(t.sampleLevel),r.setBackground(t.backgroundColor),r.setLight(t.lightColor,t.lightIntensity,t.ambientColor,t.ambientIntensity),this.signals.parametersChanged.dispatch(this.getParameters()),this}log(e){console.log("STAGE LOG",e),this.logList.push(e)}getParameters(){return Object.assign({},this.parameters)}defaultFileRepresentation(o){if(o instanceof r0){o.setSelection("/0");let e,t,r;var l=o.structure;l.biomolDict.BU1?(h=l.biomolDict.BU1,e=h.getAtomCount(l),t=h.getResidueCount(l),r=h.getInstanceCount(),o.setDefaultAssembly("BU1")):(e=l.getModelProxy(0).atomCount,t=l.getModelProxy(0).residueCount,r=1);let i=e;nc&&(i*=4);var h=l.atomStore.count/l.residueStore.count<2;h&&(i*=10);let n="chainname",a="RdYlBu",s=!1;if(1===l.getChainnameCount(new qh("polymer and /0"))&&(n="residueindex",a="Spectral",s=!0),Je.Debug&&console.log(i,e,r,h),t/r<4)o.addRepresentation("ball+stick",{colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"});else if(5<r&&15e3<i||7e5<i){let e=Math.min(2,Math.max(.1,6e3/(i/r)));h&&(e=Math.min(e,.5)),o.addRepresentation("surface",{colorScheme:n,colorScale:a,colorReverse:s,sele:"polymer",surfaceType:"av",probeRadius:1.4,scaleFactor:e,useWorker:!1})}else 25e4<i?o.addRepresentation("backbone",{colorScheme:n,colorScale:a,colorReverse:s,lineOnly:!0}):1e5<i?o.addRepresentation("backbone",{colorScheme:n,colorScale:a,colorReverse:s,quality:"low",disableImpostor:!0,radiusScale:2}):8e4<i?o.addRepresentation("backbone",{colorScheme:n,colorScale:a,colorReverse:s,radiusScale:2}):(o.addRepresentation("cartoon",{colorScheme:n,colorScale:a,colorReverse:s,radiusScale:.7,aspectRatio:5,quality:"auto"}),i<5e4&&o.addRepresentation("base",{colorScheme:n,colorScale:a,colorReverse:s,quality:"auto"}),o.addRepresentation("ball+stick",{sele:"ligand",colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"}));o.structure.frames.length&&o.addTrajectory()}else(o instanceof i0||o instanceof n0)&&o.addRepresentation("surface");this.tasks.onZeroOnce(this.autoView,this)}loadFile(e,t={}){let r=Object.assign({},this.defaultFileParams,t),i=Mc(e).name;this.tasks.increment(),this.log(`loading file '${i}'`);t=ce(r.ext,Mc(e).ext);let n;return(n=a.isTrajectory(t)?Promise.reject(new Error(`loadFile: ext '${t}' is a trajectory and must be loaded into a structure component`)):Tc(e,r)).then(e=>{this.log(`loaded '${i}'`);e=this.addComponentFromObject(e,r);return r.defaultRepresentation&&this.defaultFileRepresentation(e),this.tasks.decrement(),e},e=>{this.tasks.decrement();e=`error loading file: '${e}'`;throw this.log(e),e})}loadScript(e){let t=Mc(e).name;return this.log(`loading script '${t}'`),Tc(e).then(e=>{this.tasks.increment(),this.log(`running script '${t}'`),e.run(this).then(()=>{this.tasks.decrement(),this.log(`finished script '${t}'`)}),this.log(`called script '${t}'`)},e=>{this.tasks.decrement();e=`errored script '${t}' "${e}"`;throw this.log(e),e})}addComponent(e){e?(this.compList.push(e),this.signals.componentAdded.dispatch(e)):rt.warn("Stage.addComponent: no component given")}addComponentFromObject(e,t={}){var r=fc.get(e.type);if(r)return r=new r(this,e,t),this.addComponent(r),r;rt.warn("no component for object type",e.type)}removeComponent(e){var t=this.compList.indexOf(e);-1!==t&&(this.compList.splice(t,1),e.dispose(),this.signals.componentRemoved.dispatch(e))}removeAllComponents(){this.compList.slice().forEach(e=>this.removeComponent(e))}handleResize(){this.viewer.handleResize()}setSize(e,t){var r=this.viewer.container;r!==document.body&&(void 0!==e&&(r.style.width=e),void 0!==t&&(r.style.height=t),this.handleResize())}toggleFullscreen(e){if(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled){let t=this;function r(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function i(){var e;!r()&&t.lastFullscreenElement&&((e=t.lastFullscreenElement).style.width=e.dataset.normalWidth||"",e.style.height=e.dataset.normalHeight||"",document.removeEventListener("fullscreenchange",i),document.removeEventListener("mozfullscreenchange",i),document.removeEventListener("webkitfullscreenchange",i),document.removeEventListener("MSFullscreenChange",i),t.handleResize(),t.signals.fullscreenChanged.dispatch(!1))}e=e||this.viewer.container,this.lastFullscreenElement=e,r()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():(e.dataset.normalWidth=e.style.width||"",e.dataset.normalHeight=e.style.height||"",e.style.width=window.screen.width+"px",e.style.height=window.screen.height+"px",e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",i),document.addEventListener("mozfullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),document.addEventListener("MSFullscreenChange",i),this.handleResize(),this.signals.fullscreenChanged.dispatch(!0),setTimeout(function(){t.handleResize()},100))}else rt.log("fullscreen mode (currently) not possible")}setSpin(e){(e?(this.spinAnimation.resume(!0),this.rockAnimation):this.spinAnimation).pause(!0)}setRock(e){(e?(this.rockAnimation.resume(!0),this.spinAnimation):this.rockAnimation).pause(!0)}toggleSpin(){this.setSpin(this.spinAnimation.paused)}toggleRock(){this.setRock(this.rockAnimation.paused)}getFocus(){var e=this.parameters;if("scene"!==e.clipMode)return 0;let t=e.clipNear;return 2*(t="absolute"===e.clipScale?this.viewer.absoluteToRelative(t):t)}setFocus(n){if("scene"===this.parameters.clipMode){let e,t,r,i;i="relative"===this.parameters.clipScale?(e=ch(n/2,0,49.9),t=100-e,r=50,ch(2*t-50,0,100)):(e=this.viewer.relativeToAbsolute(n/2),t=e,r=0,2*t),this.setParameters({clipNear:e,clipFar:t,fogNear:r,fogFar:i})}}getZoomForBox(e){var e=e.getSize(o0),t=Math.max(e.x,e.y,e.z),e=Math.min(e.x,e.y,e.z),t=t+Math.sqrt(e),e=sh(this.viewer.perspectiveCamera.fov),r=this.viewer.width,i=this.viewer.height,t=Math.abs(.5*t/(i<r?1:r/i)/Math.sin(e/2));return-(t+=this.parameters.clipDist)}getBox(){return this.viewer.boundingBox}getZoom(){return this.getZoomForBox(this.getBox())}getCenter(e){return this.getBox().getCenter(e||new et)}autoView(e){this.animationControls.zoomMove(this.getCenter(),this.getZoom(),ce(e,0))}makeImage(e={}){return new Promise((t,r)=>{this.tasks.onZeroOnce(()=>{this.tasks.increment(),this.viewer.makeImage(e).then(e=>{this.tasks.decrement(),t(e)}).catch(e=>{this.tasks.decrement(),r(e)})})})}setImpostor(r){this.parameters.impostor=r;let i=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(e){var t;i.includes(e.getType())&&((t=e.getParameters()).disableImpostor=!r,e.build(t))})}setQuality(r){this.parameters.quality=r;let i=["tube","cartoon","ribbon","trace","rope"],n=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(e){var t=e.getParameters();if(!i.includes(e.getType())){if(!n.includes(e.getType()))return;if(!t.disableImpostor)return void(e.repr.quality=r)}t.quality=r,e.build(t)})}eachComponent(t,r){this.compList.slice().forEach(e=>{void 0!==r&&r!==e.type||t(e)})}eachRepresentation(r,i){this.eachComponent(t=>{t.reprList.slice().forEach(e=>{void 0!==i&&i!==e.getType()||r(e,t)})})}getComponentsByName(t){let r=[];return this.eachComponent(e=>{void 0!==t&&!s0(t,e)||r.push(e)}),new a0(r)}getComponentsByObject(t){let r=[];return this.eachComponent(e=>{e.object===t&&r.push(e)}),new a0(r)}getRepresentationsByName(r){let i=[];return this.eachRepresentation((e,t)=>{void 0!==r&&!s0(r,e)||i.push(e)}),new N1(i)}measureClear(){this.eachComponent(e=>e.measureClear(),"structure")}measureUpdate(){this.eachComponent(e=>e.measureUpdate(),"structure")}dispose(){this.tasks.dispose(),this.viewer.dispose(),this.mouseObserver.dispose()}}class c0 extends O1{constructor(e,t,r={}){super(e,t,Object.assign({name:t.name},r)),this.shape=t}get type(){return"shape"}addRepresentation(e,t={}){return this._addRepresentation(e,this.shape,t)}getBoxUntransformed(){return this.shape.boundingBox}getCenterUntransformed(){return this.shape.center}dispose(){this.shape.dispose(),super.dispose()}}function l(e,t,r,i){var n,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,r,s):n(t,r))||s);3<a&&s&&Object.defineProperty(t,r,s)}function u0(e,s,o,l){return new(o=o||Promise)(function(r,t){function i(e){try{a(l.next(e))}catch(e){t(e)}}function n(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(i,n)}a((l=l.apply(e,s||[])).next())})}fc.add("shape",c0);class d0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=ce(e.reverse,!0)),this.scalePerModel={},e.structure.eachModel(e=>{this.parameters.domain=[e.atomOffset,e.atomEnd],this.scalePerModel[e.index]=this.getScale()})}atomColor(e){return this.scalePerModel[e.modelIndex](e.index)}}l([r],d0.prototype,"atomColor",null),k.add("atomindex",d0);class m0 extends i{constructor(i){if(super(i),i.scale||(this.parameters.scale="OrRd"),!i.domain){let e,t=1/0,r=-1/0;i.sele&&(e=new qh(i.sele)),i.structure.eachAtom(function(e){e=e.bfactor;t=Math.min(t,e),r=Math.max(r,e)},e),this.parameters.domain=[t,r]}this.bfactorScale=this.getScale()}atomColor(e){return this.bfactorScale(e.bfactor)}}l([r],m0.prototype,"atomColor",null),k.add("bfactor",m0);class p0 extends i{constructor(e){super(e),this.chainidDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(e=>{let t=0,r={};e.eachChain(function(e){void 0===r[e.chainid]&&(r[e.chainid]=t,t+=1)}),this.parameters.domain=[0,t-1],this.chainidDictPerModel[e.index]=r,this.scalePerModel[e.index]=this.getScale()})}atomColor(e){var t=this.chainidDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainid])}}l([r],p0.prototype,"atomColor",null),k.add("chainid",p0);class f0 extends i{constructor(e){super(e),this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(e=>{this.parameters.domain=[e.chainOffset,e.chainEnd],this.scalePerModel[e.index]=this.getScale()})}atomColor(e){return this.scalePerModel[e.modelIndex](e.chainIndex)}}l([r],f0.prototype,"atomColor",null),k.add("chainindex",f0);class g0 extends i{constructor(e){super(e),this.chainnameDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(e=>{let t=0,r={};e.eachChain(function(e){void 0===r[e.chainname]&&(r[e.chainname]=t,t+=1)}),this.parameters.domain=[0,t-1],this.chainnameDictPerModel[e.index]=r,this.scalePerModel[e.index]=this.getScale()})}atomColor(e){var t=this.chainnameDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainname])}}l([r],g0.prototype,"atomColor",null),k.add("chainname",g0);class v0 extends i{constructor(e){super(e),this.rsrzDict={},this.rsccDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rsrzScale=this.getScale({domain:[2,0]}),this.rsccScale=this.getScale({domain:[.678,1]});e=e.structure.validation;e&&(this.rsrzDict=e.rsrzDict,this.rsccDict=e.rsccDict)}atomColor(e){let t=e.resno+"";e.inscode&&(t+="^"+e.inscode),e.chainname&&(t+=":"+e.chainname),t+="/"+e.modelIndex;var e=this.rsrzDict[t];return void 0!==e?this.rsrzScale(e):void 0!==(e=this.rsccDict[t])?this.rsccScale(e):9474192}}l([r],v0.prototype,"atomColor",null),k.add("densityfit",v0);let _0={ARG:{CD:.1,CZ:.5,NE:-.1},ASN:{CG:.55,OD1:-.55},ASP:{CB:-.16,CG:.36,OD1:-.6,OD2:-.6},CYS:{CB:.19,SG:-.19},GLN:{CD:.55,OE1:-.55},GLU:{CD:.36,CG:-.16,OE1:-.6,OE2:-.6},HIS:{CB:.1,CD2:.2,CE1:.45,CG:.15,ND1:.05,NE2:.05},LYS:{CE:.25,NZ:.75},MET:{CE:.06,CG:.06,SD:-.12},PTR:{C:.55,CA:.1,CZ:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SEP:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SER:{CB:.25,OG:-.25},THR:{CB:.25,OG1:-.25},TPO:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,OG1:-1.1,O1P:-.85,O2P:-.85,O3P:-.85,P:1.4},TRP:{CD1:.06,CD2:.1,CE2:-.04,CE3:-.03,CG:-.03,NE1:-.06},TYR:{CZ:.25,OH:-.25},backbone:{C:.55,O:-.55,N:-.35,CA:.1}};class y0 extends i{constructor(e){super(e),this.delta=new et,this.hCharges=[],e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-50,50]),this.scale=this.getScale(),this.charges=new Float32Array(e.structure.atomCount);let r=[];e.structure.eachAtom(e=>{var t;this.charges[e.index]=(null!==(t=e).partialCharge?t.partialCharge:t.isProtein()&&(_0[t.resname]&&_0[t.resname][t.atomname]||_0.backbone[t.atomname])||0)*e.occupancy,"N"!==e.atomname||3<=e.bondCount||e.bondToElementCount(1)||void 0!==(t=((e,t=new et)=>{let r=!1,i=!1,n=!1;return t.set(2*e.x,2*e.y,2*e.z),e.eachBondedAtom(function(e){r||("H"===e.atomname?(t.set(e.x,e.y,e.z),r=!0):i||"CA"!==e.atomname?n||"C"!==e.atomname||(n=!0,t.sub(e)):(t.sub(e),i=!0))}),r?t:i&&n?(t.normalize(),t.multiplyScalar(1.04),t.add(e),t):void 0})(e))&&(r.push(t),this.hCharges.push(.25*e.occupancy))});var t=e.structure.getBoundingBox();t.expandByScalar(1.04),this.hStore=(t=>{var e=t.length,r=new Float32Array(e),i=new Float32Array(e),n=new Float32Array(e);for(let e=0;e<t.length;e++){var a=t[e];r[e]=a.x,i[e]=a.y,n[e]=a.z}return{x:r,y:i,z:n,count:e}})(r),this.hHash=new Wd(this.hStore,t),this.hash=new Wd(e.structure.atomStore,t)}positionColor(e){let r=this.charges,i=this.hCharges,n=0;return this.hash.eachWithin(e.x,e.y,e.z,12,(e,t)=>{e=r[e];0!==e&&(n+=e/t)}),this.hHash.eachWithin(e.x,e.y,e.z,12,(e,t)=>{e=i[e];0!==e&&(n+=e/t)}),this.scale(332*n)}}l([r],y0.prototype,"positionColor",null),k.add("electrostatic",y0);let b0={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120};class x0 extends i{constructor(e){e.value=ce(e.value,b0.C),super(e)}atomColor(e){e=e.element;return"C"===e?this.parameters.value:b0[e]||16777215}}l([r],x0.prototype,"atomColor",null),k.add("element",x0);class S0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="Spectral"),e.domain||(this.parameters.domain=[0,e.structure.entityList.length-1]),this.entityindexScale=this.getScale()}atomColor(e){return this.entityindexScale(e.entityIndex)}}l([r],S0.prototype,"atomColor",null),k.add("entityindex",S0);class w0 extends i{atomColor(e){e=e.entity;switch(e?e.entityType:void 0){case 1:return 8374655;case 2:return 16629894;case 3:return 12496596;case 4:return 3697840;default:return 16777113}}}l([r],w0.prototype,"atomColor",null),k.add("entitytype",w0);class A0 extends i{constructor(e){super(e),this.geoAtomDict={},this.geoDict={};e=e.structure.validation;e&&(this.geoAtomDict=e.geoAtomDict,this.geoDict=e.geoDict)}atomColor(e){let t=e.resno+"";e.inscode&&(t+="^"+e.inscode),e.chainname&&(t+=":"+e.chainname),t+="/"+e.modelIndex;let r;var i=this.geoAtomDict[t];return 0===(r=void 0!==i?(i=i[e.atomname]||0,e=i,16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24):this.geoDict[t]||0)?2188972:1===r?16703627:2===r?16018755:3<=r?10813478:9474192}}l([r],A0.prototype,"atomColor",null),k.add("geoquality",A0);class M0 extends i{constructor(e){super(e),this.resHF={},e.scale||(this.parameters.scale="RdYlGn");for(var t in fm)this.resHF[t]=fm[t][0];if(this.defaultResidueHydrophobicity=gm[0],!e.domain){let e=1/0,t=-1/0;for(var r in this.resHF){r=this.resHF[r];e=Math.min(e,r),t=Math.max(t,r)}this.parameters.domain=[e,0,t]}this.hfScale=this.getScale()}atomColor(e){return this.hfScale(this.resHF[e.resname]||this.defaultResidueHydrophobicity)}}l([r],M0.prototype,"atomColor",null),k.add("hydrophobicity",M0);class C0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow"),e.domain||(this.parameters.domain=[0,e.structure.modelStore.count]),this.modelindexScale=this.getScale()}atomColor(e){return this.modelindexScale(e.modelIndex)}}l([r],C0.prototype,"atomColor",null),k.add("modelindex",C0);class T0 extends i{atomColor(e){switch(e.residueType.moleculeType){case 1:return 3697840;case 2:return 15729279;case 3:return 12496596;case 4:return 16629894;case 5:return 12540695;case 6:return 8374655;default:return 16777113}}}l([r],T0.prototype,"atomColor",null),k.add("moleculetype",T0);class E0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="PuBu"),e.domain||(this.parameters.domain=[0,1]),this.occupancyScale=this.getScale()}atomColor(e){return this.occupancyScale(e.occupancy)}}l([r],E0.prototype,"atomColor",null),k.add("occupancy",E0);class P0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-1,1]),this.partialchargeScale=this.getScale()}atomColor(e){return this.partialchargeScale(e.partialCharge||0)}}function I0(){return 16777215*Math.random()}l([r],P0.prototype,"atomColor",null),k.add("partialcharge",P0);class R0 extends i{atomColor(){return I0()}volumeColor(){return I0()}positionColor(){return I0()}}l([r],R0.prototype,"atomColor",null),l([r],R0.prototype,"volumeColor",null),l([r],R0.prototype,"positionColor",null),k.add("random",R0);class D0 extends i{constructor(e){super(e),this.rciDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rciScale=this.getScale({domain:[.6,0]});e=e.structure.validation;e&&(this.rciDict=e.rciDict)}atomColor(e){let t=`[${e.resname}]`+e.resno;e.chainname&&(t+=":"+e.chainname);e=this.rciDict[t];return void 0!==e?this.rciScale(e):9474192}}l([r],D0.prototype,"atomColor",null),k.add("randomcoilindex",D0);class L0 extends i{constructor(e){super(e),this.scalePerChain={},e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=ce(e.reverse,!0)),e.structure.eachChain(e=>{this.parameters.domain=[e.residueOffset,e.residueEnd],this.scalePerChain[e.index]=this.getScale()})}atomColor(e){return this.scalePerChain[e.chainIndex](e.residueIndex)}}l([r],L0.prototype,"atomColor",null),k.add("residueindex",L0);let O0={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:14423100,G:3329330,I:10145074,X:8190976,C:16766720,T:4286945,U:4251856,D:35723,DA:14423100,DG:3329330,DI:10145074,DX:8190976,DC:16766720,DT:4286945,DU:4251856,DD:35723};class k0 extends i{atomColor(e){return O0[e.resname]||16711935}}l([r],k0.prototype,"atomColor",null),k.add("resname",k0);let N0={alphaHelix:16711808,threeTenHelix:10485888,piHelix:6291584,betaStrand:16762880,betaTurn:6324479,coil:16777215,dna:11403518,rna:16580962,carbohydrate:10921722};class F0 extends i{constructor(e){super(e),this.residueProxy=e.structure.getResidueProxy()}atomColor(e){var t=e.sstruc,r=this.residueProxy;return"h"===t?N0.alphaHelix:"g"===t?N0.threeTenHelix:"i"===t?N0.piHelix:"e"===t||"b"===t?N0.betaStrand:"t"===t?N0.betaTurn:(r.index=e.residueIndex,r.isDna()?N0.dna:r.isRna()?N0.rna:r.isSaccharide()?N0.carbohydrate:r.isProtein()||"s"===t||"l"===t?N0.coil:8421504)}}l([r],F0.prototype,"atomColor",null),k.add("sstruc",F0);class B0 extends i{constructor(e){super(e),e.scale||(this.parameters.scale="rwb"),this.atomData=null==(e=this.parameters.data)?void 0:e.atomData,this.bondData=null==(e=this.parameters.data)?void 0:e.bondData,this.scale=this.getScale(this.parameters)}atomColor(e){var t=null==(t=this.atomData)?void 0:t[e.index];return void 0!==t?this.scale(t):this.parameters.value}bondColor(e,t){var r=null==(r=this.bondData)?void 0:r[e.index];return void 0!==r?this.scale(r):this.atomProxy?(this.atomProxy.index=t?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):this.parameters.value}}l([r],B0.prototype,"atomColor",null),l([r],B0.prototype,"bondColor",null),k.add("structuredata",B0);class U0 extends i{atomColor(){return this.parameters.value}bondColor(){return this.parameters.value}valueColor(){return this.parameters.value}volumeColor(){return this.parameters.value}}l([r],U0.prototype,"atomColor",null),l([r],U0.prototype,"bondColor",null),l([r],U0.prototype,"valueColor",null),l([r],U0.prototype,"volumeColor",null),k.add("uniform",U0);class z0 extends i{constructor(e){super(e),this.valueScale=this.getScale()}volumeColor(e){return this.valueScale(this.parameters.volume.data[e])}}l([r],z0.prototype,"volumeColor",null),k.add("value",z0);class V0 extends i{constructor(e){super(e),this.vec=new et,this.valueScale=this.getScale()}positionColor(e){var t,r,i,n,a,s,o,l,h,c,u,d=this.parameters.volume;return d&&d.inverseMatrix?(a=this.vec,i=d.data,r=(n=d.nx)*(c=d.ny),a.copy(e),a.applyMatrix4(d.inverseMatrix),e=Math.floor(a.x),d=Math.floor(a.y),o=i[c=((s=Math.floor(a.z))*c+d)*n+e],l=i[c+1],u=i[n=c+n],h=i[c=c+r],t=i[n+1],c=i[c+1],r=i[n=n+r],i=i[n+1],n=a.x-e,e=a.y-d,d=a.z-s,a=uh(o,l,n),s=uh(h,c,n),o=uh(u,t,n),l=uh(r,i,n),h=uh(a,o,e),c=uh(s,l,e),u=uh(h,c,d),this.valueScale(u)):this.parameters.value}}l([r],V0.prototype,"positionColor",null),k.add("volume",V0);class G0 extends sd{constructor(e,t,r){r=r||{};if(super(e,t,r),this.type="structure",this.parameters=Object.assign({radiusType:{type:"select",options:Gf.types},radiusData:{type:"hidden"},radiusSize:{type:"number",precision:3,max:10,min:.001},radiusScale:{type:"number",precision:3,max:10,min:.001},assembly:null,defaultAssembly:{type:"hidden"}},this.parameters),this.selection=new qh(r.sele),this.dataList=[],this.structure=e,this.structureView=this.structure.getView(this.selection),e.biomolDict){let t={default:"default","":e.unitcell?"AU":"FULL"};Object.keys(e.biomolDict).forEach(function(e){t[e]=e}),this.parameters.assembly={type:"select",options:t,rebuild:!0}}else this.parameters.assembly=null}get defaultScale(){return{vdw:1,covalent:1,bfactor:.01,sstruc:1}}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"element"),this.setRadius(e.radius,e),this.radiusType=ce(e.radiusType,"vdw"),this.radiusData=ce(e.radiusData,{}),this.radiusSize=ce(e.radiusSize,1),this.radiusScale=ce(e.radiusScale,1),this.assembly=ce(e.assembly,"default"),this.defaultAssembly=ce(e.defaultAssembly,""),"auto"===e.quality&&(e.quality=this.getQuality()),super.init(e),this.selection.signals.stringChanged.add(()=>{this.build()}),this.build()}setRadius(e,t){var r=Object.keys(Vf);return"string"==typeof e&&r.includes(e.toLowerCase())?t.radiusType=e:void 0!==e&&(t.radiusType="size",t.radiusSize=e),this}getAssembly(){var e="default"===this.assembly?this.defaultAssembly:this.assembly;return this.structure.biomolDict[e]}getQuality(){let e;var t=this.structureView,r=this.getAssembly(),r=(e=r?r.getAtomCount(t):t.atomCount,nc&&(e*=4),t.atomStore.count/t.residueStore.count<2);return r&&(e*=10),e<15e3?"high":e<8e4?"medium":"low"}create(){var e;0!==this.structureView.atomCount&&(this.structureView.hasCoords()?(this.needsBuild=!1,(e=this.getAssembly())?e.partList.forEach((e,t)=>{var r=e.getView(this.structureView);0!==r.atomCount&&(t=this.createData(r,t))&&(t.sview=r,t.instanceList=e.getInstanceList(),this.dataList.push(t))}):(e=this.createData(this.structureView,0))&&(e.sview=this.structureView,this.dataList.push(e))):this.needsBuild=!0)}update(t){this.lazy&&!this.visible?Object.assign(this.lazyProps.what,t):this.needsBuild?this.build():this.dataList.forEach(e=>{0<e.bufferList.length&&this.updateData(t,e)},this)}updateData(e,t){this.build()}getColorParams(){return Object.assign(Object.assign({},super.getColorParams()),{structure:this.structure})}getRadiusParams(e){return{type:this.radiusType,scale:this.radiusScale,size:this.radiusSize,data:this.radiusData}}getAtomParams(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)}getBondParams(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)}getAtomRadius(e){return this.structureView.atomSet.isSet(e.index)?new Gf(this.getRadiusParams()).atomRadius(e):0}setSelection(e,t){return this.selection.setString(e,t),this}setParameters(e,t={},r=!1){e=e||{};return this.setRadius(e.radius,e),void 0===e.radiusType&&void 0===e.radiusData&&void 0===e.radiusSize&&void 0===e.radiusScale||(t.radius=!0,oc&&!this.disableImpostor)||(r=!0),void 0!==e.defaultAssembly&&e.defaultAssembly!==this.defaultAssembly&&("default"===this.assembly&&void 0===e.assembly||"default"===e.assembly)&&(r=!0),super.setParameters(e,t,r),this}getParameters(){return Object.assign(super.getParameters(),{sele:this.selection?this.selection.string:void 0,defaultAssembly:this.defaultAssembly})}attach(e){let r=this.viewer,i=this.bufferList;this.dataList.forEach(function(t){t.bufferList.forEach(function(e){i.push(e),r.add(e,t.instanceList)})}),this.setVisibility(this.visible),e()}clear(){this.dataList.length=0,super.clear()}dispose(){this.structureView.dispose(),super.dispose()}}class H0 extends G0{constructor(e,t,r){super(e,t,r),this.n=0,this.parameters=Object.assign({labelVisible:{type:"boolean"},labelSize:{type:"number",precision:3,max:10,min:.001},labelColor:{type:"color"},labelFontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:"fontFamily"},labelFontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:"fontStyle"},labelFontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:"fontWeight"},labelsdf:{type:"boolean",buffer:"sdf"},labelXOffset:{type:"number",precision:1,max:20,min:-20,buffer:"xOffset"},labelYOffset:{type:"number",precision:1,max:20,min:-20,buffer:"yOffset"},labelZOffset:{type:"number",precision:1,max:20,min:-20,buffer:"zOffset"},labelAttachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},labelBorder:{type:"boolean",buffer:"showBorder"},labelBorderColor:{type:"color",buffer:"borderColor"},labelBorderWidth:{type:"number",precision:2,max:.3,min:0,buffer:"borderWidth"},labelBackground:{type:"boolean",rebuild:!0},labelBackgroundColor:{type:"color",buffer:"backgroundColor"},labelBackgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},labelBackgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:"backgroundOpacity"},labelFixedSize:{type:"boolean",buffer:"fixedSize"},lineOpacity:{type:"range",min:0,max:1,step:.01},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters,{flatShaded:null})}init(e){e=e||{};this.labelVisible=ce(e.labelVisible,!0),this.labelSize=ce(e.labelSize,2),this.labelColor=ce(e.labelColor,16777215),this.labelFontFamily=ce(e.labelFontFamily,"sans-serif"),this.labelFontStyle=ce(e.labelFontstyle,"normal"),this.labelFontWeight=ce(e.labelFontWeight,"bold"),this.labelsdf=ce(e.labelsdf,"Chrome"===tc),this.labelXOffset=ce(e.labelXOffset,0),this.labelYOffset=ce(e.labelYOffset,0),this.labelZOffset=ce(e.labelZOffset,.5),this.labelAttachment=ce(e.labelAttachment,"bottom-left"),this.labelBorder=ce(e.labelBorder,!1),this.labelBorderColor=ce(e.labelBorderColor,"lightgrey"),this.labelBorderWidth=ce(e.labelBorderWidth,.15),this.labelBackground=ce(e.labelBackground,!1),this.labelBackgroundColor=ce(e.labelBackgroundColor,"lightgrey"),this.labelBackgroundMargin=ce(e.labelBackgroundMargin,.5),this.labelBackgroundOpacity=ce(e.labelBackgroundOpacity,1),this.labelFixedSize=ce(e.labelFixedSize,!1),this.lineOpacity=ce(e.lineOpacity,1),this.linewidth=ce(e.linewidth,2),super.init(e)}update(e){e.position?this.build():super.update(e)}updateData(e,t){var r={};e&&!e.labelSize||Object.assign(r,{size:qc(this.n,this.labelSize)}),e&&!e.labelColor||(e=new ze(this.labelColor),Object.assign(r,{color:_(this.n,e.r,e.g,e.b)})),this.textBuffer.setAttributes(r)}setParameters(e,t={},r=!1){return e&&e.labelSize&&(t.labelSize=!0),e&&(e.labelColor||0===e.labelColor)&&(r=t.labelColor=!0),super.setParameters(e,t,r),e&&void 0!==e.opacity&&this.textBuffer.setParameters({opacity:1}),e&&void 0!==e.labelVisible&&this.setVisibility(this.visible),this}setVisibility(e,t){return super.setVisibility(e,!0),this.textBuffer&&this.textBuffer.setVisibility(this.labelVisible&&this.visible),t||this.viewer.requestRender(),this}getLabelBufferParams(e={}){return super.getBufferParams(Object.assign({fontFamily:this.labelFontFamily,fontStyle:this.labelFontStyle,fontWeight:this.labelFontWeight,sdf:this.labelsdf,xOffset:this.labelXOffset,yOffset:this.labelYOffset,zOffset:this.labelZOffset,attachment:this.labelAttachment,showBorder:this.labelBorder,borderColor:this.labelBorderColor,borderWidth:this.labelBorderWidth,showBackground:this.labelBackground,backgroundColor:this.labelBackgroundColor,backgroundMargin:this.labelBackgroundMargin,backgroundOpacity:this.labelBackgroundOpacity,fixedSize:this.labelFixedSize,disablePicking:!0,visible:this.labelVisible},e,{opacity:1}))}getAtomRadius(){return 0}}function $0(n,e){let a=n.getAtomProxy(),s=new qh;var t=e.length;if(0===t)return new Float32Array(0);let o=e[0].length,l=n.getAtomSet(),h=new Float32Array(t*o*3),c=0;return e.forEach(function(t){let r=!1;for(let e=0;e<o;e++){var i=t[e];if("number"==typeof i&&Number.isInteger(i)){if(!l.get(i)){r=!0;break}a.index=i}else{s.setString(i);i=n.getAtomIndices(s);if(!i.length){r=!0;break}a.index=i[0]}i=c+3*e;h[i++]=a.x,h[i++]=a.y,h[+i]=a.z}r||(c+=3*o)}),h.subarray(0,c)}function j0(e,t,r,i,n){var a=Math.cos(n),n=Math.sin(n);e[0]=t[0]+r[0]*a+i[0]*n,e[1]=t[1]+r[1]*a+i[1]*n,e[2]=t[2]+r[2]*a+i[2]*n}function W0(r,i,n,a,s,e,o){for(let t=0;t<i;t++){for(let e=0;e<n;e++)a[e]=r[e*i+t];q0(a,s,e,o,n);for(let e=0;e<n;e++)r[e*i+t]=s[e]}for(let t=0;t<n;t++){for(let e=0;e<i;e++)a[e]=r[t*i+e];q0(a,s,e,o,i);for(let e=0;e<i;e++)r[t*i+e]=Math.sqrt(s[e])}}function q0(i,r,n,a,s){a[n[0]=0]=Number.MIN_SAFE_INTEGER,a[1]=Number.MAX_SAFE_INTEGER;for(let t=1,r=0;t<s;t++){let e=(i[t]+t*t-(i[n[r]]+n[r]*n[r]))/(2*t-2*n[r]);for(;e<=a[r];)r--,e=(i[t]+t*t-(i[n[r]]+n[r]*n[r]))/(2*t-2*n[r]);n[++r]=t,a[r]=e,a[r+1]=Number.MAX_SAFE_INTEGER}for(let e=0,t=0;e<s;e++){for(;a[t+1]<e;)t++;r[e]=(e-n[t])*(e-n[t])+i[n[t]]}}s.add("shader/SDFFont.vert","uniform float clipNear;\r\nuniform float clipRadius;\r\nuniform vec3 clipCenter;\r\nuniform float xOffset;\r\nuniform float yOffset;\r\nuniform float zOffset;\r\nuniform bool ortho;\r\nuniform float canvasHeight;\r\nuniform float pixelRatio;\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\nvarying vec2 texCoord;\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\n#if defined( PICKING )\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#else\r\n#include color_pars_vertex\r\n#endif\r\n\r\nattribute vec2 mapping;\r\nattribute vec2 inputTexCoord;\r\nattribute float inputSize;\r\n\r\n#include matrix_scale\r\n#include common\r\n\r\nvoid main(void){\r\n\r\n#if defined( PICKING )\r\nvPickingColor = unpackColor( primitiveId );\r\n#else\r\n#include color_vertex\r\n#endif\r\n\r\ntexCoord = inputTexCoord;\r\n\r\nfloat scale = matrixScale( modelViewMatrix );\r\n\r\nfloat _xOffset = xOffset * scale;\r\nfloat _yOffset = yOffset * scale;\r\nfloat _zOffset = zOffset * scale;\r\nif( texCoord.x == 10.0 ){\r\n_zOffset -= 0.001;\r\n}\r\n\r\nvec4 cameraPos = modelViewMatrix * vec4( position, 1.0 );\r\n\r\n#ifdef FIXED_SIZE\r\nif ( ortho ) {\r\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPosition.z) * 0.1;\r\n} else {\r\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPos.z) * 0.1;\r\n}\r\n#endif\r\n\r\nvec4 cameraCornerPos = vec4( cameraPos.xyz, 1.0 );\r\ncameraCornerPos.xy += mapping * inputSize * 0.01 * scale;\r\ncameraCornerPos.x += _xOffset;\r\ncameraCornerPos.y += _yOffset;\r\nif( ortho ){\r\ncameraCornerPos.xyz += normalize( -cameraPosition ) * _zOffset;\r\n} else {\r\ncameraCornerPos.xyz += normalize( -cameraCornerPos.xyz ) * _zOffset;\r\n}\r\n\r\ngl_Position = projectionMatrix * cameraCornerPos;\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\r\nvViewPosition = -cameraCornerPos.xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n#include radiusclip_vertex\r\n\r\n}"),s.add("shader/SDFFont.frag","uniform sampler2D fontTexture;\nuniform float opacity;\nuniform bool showBorder;\nuniform vec3 borderColor;\nuniform float borderWidth;\nuniform vec3 backgroundColor;\nuniform float backgroundOpacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\nconst vec3 vColor = vec3( 0.0 );\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#endif\nconst float gamma = 2.2 * 1.4142 / 128.0;\nconst float padding = 0.75;\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\nif( texCoord.x > 1.0 ){\ngl_FragColor = vec4( backgroundColor, backgroundOpacity );\n}else{\nfloat sdf = texture2D( fontTexture, texCoord ).a;\nif( showBorder ) sdf += borderWidth;\nfloat a = smoothstep(padding - gamma, padding + gamma, sdf);\nif( a < 0.2 ) discard;\na *= opacity;\nvec3 outgoingLight = vColor;\nif( showBorder && sdf < ( padding + borderWidth ) ){\noutgoingLight = borderColor;\n}\ngl_FragColor = vec4( outgoingLight, a );\n}\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");let X0={};let Y0={font:"sans-serif",size:36,style:"normal",variant:"normal",weight:"normal",outline:3,width:1024,height:1024};class K0{constructor(e={}){this.gamma=1,this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.cutoff=.25,this.parameters=Vl(e,Y0);var e=this.parameters,t=(this.radius=e.size/8,this.padding=e.size/3,this.lineHeight=e.size+2*e.outline+Math.round(e.size/4)),r=this.maxWidth=e.width/4,i=this.canvas=document.createElement("canvas"),i=(i.width=r,i.height=t,this.context=this.canvas.getContext("2d",{willReadFrequently:!0}));i.font=`${e.style} ${e.variant} ${e.weight} ${e.size}px `+e.font,i.fillStyle="black",i.textAlign="left",i.textBaseline="bottom",i.lineJoin="round",this.gridOuter=new Float64Array(t*r),this.gridInner=new Float64Array(t*r),this.f=new Float64Array(Math.max(t,r)),this.d=new Float64Array(Math.max(t,r)),this.z=new Float64Array(Math.max(t,r)+1),this.v=new Int16Array(Math.max(t,r)),this.data=new Uint8Array(e.width*e.height*4),this.canvas2=document.createElement("canvas"),this.canvas2.width=e.width,this.canvas2.height=e.height,this.context2=this.canvas2.getContext("2d"),this.placeholder=this.map(String.fromCharCode(65533));for(let e=32;e<=126;++e)this.map(String.fromCharCode(e));this.map(String.fromCharCode(176)),this.map(String.fromCharCode(8491)),this.texture=new bl(this.canvas2),this.texture.flipY=!1,this.texture.needsUpdate=!0}map(e){var t=this.parameters;return void 0===this.mapped[e]&&(this.draw(e),this.currentX+this.scratchW>t.width&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>t.height&&console.warn("canvas to small"),this.mapped[e]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH},this.context2.drawImage(this.canvas,0,0,this.scratchW,this.scratchH,this.currentX,this.currentY,this.scratchW,this.scratchH),this.currentX+=this.scratchW),this.mapped[e]}get(e){return this.mapped[e]||this.placeholder}draw(e){var t=this.parameters,r=this.lineHeight,i=t.outline,n=this.context,a=this.maxWidth,t=r-t.outline,s=n.measureText(e),a=Math.min(a,Math.ceil(s.width+2*i+1)),o=a*r,l=(n.clearRect(0,0,a,r),n.fillText(e,i,t),n.getImageData(0,0,a,r)),h=l.data;for(let e=0;e<o;e++){var c=l.data[4*e+3]/255;this.gridOuter[e]=1==c?0:0==c?Number.MAX_SAFE_INTEGER:Math.pow(Math.max(0,.5-c),2),this.gridInner[e]=1==c?Number.MAX_SAFE_INTEGER:0==c?0:Math.pow(Math.max(0,c-.5),2)}W0(this.gridOuter,a,r,this.f,this.d,this.v,this.z),W0(this.gridInner,a,r,this.f,this.d,this.v,this.z);for(let e=0;e<o;e++){var u=this.gridOuter[e]-this.gridInner[e];h[4*e+3]=Math.max(0,Math.min(255,Math.round(255-255*(u/this.radius+this.cutoff))))}n.putImageData(l,0,0),this.scratchW=a,this.scratchH=r}}let Z0=Object.assign({fontFamily:"sans-serif",fontStyle:"normal",fontWeight:"bold",fontSize:36,xOffset:0,yOffset:0,zOffset:.5,attachment:"bottom-left",showBorder:!1,borderColor:"lightgrey",borderWidth:.15,showBackground:!1,backgroundColor:"lightgrey",backgroundMargin:.5,backgroundOpacity:1,forceTransparent:!0,fixedSize:!1},ff),Q0=Object.assign({fontFamily:{uniform:!0},fontStyle:{uniform:!0},fontWeight:{uniform:!0},fontSize:{uniform:!0},xOffset:{uniform:!0},yOffset:{uniform:!0},zOffset:{uniform:!0},showBorder:{uniform:!0},borderColor:{uniform:!0},borderWidth:{uniform:!0},backgroundColor:{uniform:!0},backgroundOpacity:{uniform:!0},fixedSize:{updateShader:!0}},gf);function J0(t,e){var r=t.position.length/3;let i=0;for(let e=0;e<r;++e)i+=t.text[e].length;return e.showBackground&&(i+=r),i}class ev extends u1{constructor(e,t={}){super({position:new Float32Array(3*J0(e,t)),color:new Float32Array(3*J0(e,t)),picking:new Cp},t),this.parameterTypes=Q0,this.alwaysTransparent=!0,this.hasWireframe=!1,this.isText=!0,this.vertexShader="SDFFont.vert",this.fragmentShader="SDFFont.frag",this.text=e.text,this.positionCount=e.position.length/3,this.addUniforms({fontTexture:{value:null},xOffset:{value:this.parameters.xOffset},yOffset:{value:this.parameters.yOffset},zOffset:{value:this.parameters.zOffset},ortho:{value:!1},showBorder:{value:this.parameters.showBorder},borderColor:{value:new ze(this.parameters.borderColor)},borderWidth:{value:this.parameters.borderWidth},backgroundColor:{value:new ze(this.parameters.backgroundColor)},backgroundOpacity:{value:this.parameters.backgroundOpacity},canvasHeight:{value:1},pixelRatio:{value:1}}),this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}}),this.setAttributes(e),this.makeTexture(),this.makeMapping()}get defaultParameters(){return Z0}makeMaterial(){super.makeMaterial();var e=this.texture,t=this.material,r=(t.transparent=!0,t.extensions.derivatives=!0,t.lights=!1,t.uniforms.fontTexture.value=e,this.wireframeMaterial),t=(r.transparent=t.needsUpdate=!0,r.extensions.derivatives=!0,r.lights=!1,r.uniforms.fontTexture.value=e,this.pickingMaterial);t.extensions.derivatives=r.needsUpdate=!0,t.lights=!1,t.uniforms.fontTexture.value=e,t.needsUpdate=!0}setAttributes(e={}){let r,i,n,a,s,o;var l,h,c=this.text,t=this.geometry.attributes,u=(e.position&&(r=e.position,a=t.position.array,t.position.needsUpdate=!0),e.size&&(i=e.size,s=t.inputSize.array,t.inputSize.needsUpdate=!0),e.color&&(n=e.color,o=t.color.array,t.color.needsUpdate=!0),this.positionCount);let d=0,m,p,f;for(let t=0;t<u;++t)for(h=3*t,m=c[t],f=m.length,this.parameters.showBackground&&(f+=1),p=0;p<f;++p,++d)for(let e=0;e<4;e++)l=4*d*3+3*e,r&&(a[l]=r[h],a[1+l]=r[1+h],a[2+l]=r[2+h]),i&&(s[4*d+e]=i[t]),n&&(o[l]=n[h],o[1+l]=n[1+h],o[2+l]=n[2+h])}makeTexture(){var e,t;this.textAtlas=(e={font:this.parameters.fontFamily,style:this.parameters.fontStyle,weight:this.parameters.fontWeight,size:this.parameters.fontSize},t=JSON.stringify(e),void 0===X0[t]&&(X0[t]=new K0(e)),X0[t]),this.texture=this.textAtlas.texture}makeMapping(){var t=this.textAtlas,r=this.text,i=this.parameters.attachment,n=t.lineHeight*this.parameters.backgroundMargin*.1-10,e=this.geometry.attributes,a=e.inputTexCoord.array,s=e.mapping.array,o=this.positionCount;let l=0,h,c,u,d,m,p,f,g;for(let e=0;e<o;++e){for(u=r[e],d=0,p=u.length,m=0;m<p;++m)h=t.get(u[m]),d+=h.w-2*t.parameters.outline;for(g=i.startsWith("top")?t.lineHeight/1.25:i.startsWith("middle")?t.lineHeight/2.5:0,f=i.endsWith("right")?d:i.endsWith("center")?d/2:0,f+=t.parameters.outline,g+=t.parameters.outline,this.parameters.showBackground&&(s[(c=2*l*4)+0]=-t.lineHeight/6-f-n,s[c+1]=t.lineHeight-g+n,s[c+2]=-t.lineHeight/6-f-n,s[c+3]=0-g-n,s[c+4]=d+t.lineHeight/6-f+2*t.parameters.outline+n,s[c+5]=t.lineHeight-g+n,s[c+6]=d+t.lineHeight/6-f+2*t.parameters.outline+n,s[c+7]=0-g-n,a[c+0]=10,a[c+2]=10,a[c+4]=10,a[c+6]=10,l+=1),d=0,m=0;m<p;++m,++l){h=t.get(u[m]),s[(c=2*l*4)+0]=d-f,s[c+1]=h.h-g,s[c+2]=d-f,s[c+3]=0-g,s[c+4]=d+h.w-f,s[c+5]=h.h-g,s[c+6]=d+h.w-f,s[c+7]=0-g;var v=t.parameters.width,_=t.parameters.height,v=[h.x/v,h.y/_,h.x/v,(h.y+h.h)/_,(h.x+h.w)/v,h.y/_,(h.x+h.w)/v,(h.y+h.h)/_];a.set(v,c),d+=h.w-2*t.parameters.outline}}e.inputTexCoord.needsUpdate=!0,e.mapping.needsUpdate=!0}getDefines(e){e=super.getDefines(e);return this.parameters.fixedSize&&(e.FIXED_SIZE=1),e}setUniforms(e){!e||void 0===e.fontFamily&&void 0===e.fontStyle&&void 0===e.fontWeight&&void 0===e.fontSize||(this.makeTexture(),this.makeMapping(),this.texture.needsUpdate=!0,e.fontTexture=this.texture),super.setUniforms(e)}}gc.add("text",ev),s.add("shader/WideLine.vert","// heavily based on code by WestLangley from https://github.com/WestLangley/three.js/blob/af28b2fb706ac109771ecad0a7447fad90ab3210/examples/js/lines/LineMaterial.js\r\n\r\nuniform float clipNear;\r\nuniform vec3 clipCenter;\r\nuniform float linewidth;\r\nuniform vec2 resolution;\r\nuniform mat4 projectionMatrixInverse;\r\n\r\nattribute vec2 mapping;\r\nattribute vec3 position1;\r\nattribute vec3 position2;\r\n\r\n#ifdef PICKING\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#else\r\nattribute vec3 color2;\r\nvarying vec3 vColor;\r\nvarying vec3 vColor2;\r\nvarying float flag;\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\r\n// trim end segment so it terminates between the camera plane and the near plane\r\n// conservative estimate of the near plane\r\nfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\r\nfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\r\nfloat nearEstimate = - 0.5 * b / a;\r\nfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\r\nend.xyz = mix( start.xyz, end.xyz, alpha );\r\n}\r\n\r\nvoid main() {\r\n\r\nfloat aspect = resolution.x / resolution.y;\r\n\r\n#ifdef PICKING\r\nvPickingColor = unpackColor( primitiveId );\r\n#else\r\nflag = mapping.y;\r\nvColor = color;\r\nvColor2 = color2;\r\n#endif\r\n\r\n// camera space\r\nvec4 start = modelViewMatrix * vec4( position1, 1.0 );\r\nvec4 end = modelViewMatrix * vec4( position2, 1.0 );\r\n\r\n// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\r\n// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\r\n// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\r\n// perhaps there is a more elegant solution -- WestLangley\r\nbool perspective = ( projectionMatrix[ 2 ][ 3 ] == -1.0 ); // 4th entry in the 3rd column\r\nif ( perspective ) {\r\nif ( start.z < 0.0 && end.z >= 0.0 ) {\r\ntrimSegment( start, end );\r\n} else if ( end.z < 0.0 && start.z >= 0.0 ) {\r\ntrimSegment( end, start );\r\n}\r\n}\r\n\r\n// clip space\r\nvec4 clipStart = projectionMatrix * start;\r\nvec4 clipEnd = projectionMatrix * end;\r\n\r\n// ndc space\r\nvec2 ndcStart = clipStart.xy / clipStart.w;\r\nvec2 ndcEnd = clipEnd.xy / clipEnd.w;\r\n\r\n// direction\r\nvec2 dir = ndcEnd - ndcStart;\r\n\r\n// account for clip-space aspect ratio\r\ndir.x *= aspect;\r\ndir = normalize( dir );\r\n\r\n// perpendicular to dir\r\nvec2 offset = vec2( dir.y, - dir.x );\r\n\r\n// undo aspect ratio adjustment\r\ndir.x /= aspect;\r\noffset.x /= aspect;\r\n\r\n// sign flip\r\nif ( mapping.x < 0.0 ) offset *= - 1.0;\r\n\r\n// not used\r\n// // endcaps\r\n// if ( mapping.y < 0.0 ) {\r\n// offset += -dir;\r\n// } else if ( mapping.y > 0.0 ) {\r\n// offset += dir;\r\n// }\r\n\r\n// adjust for linewidth\r\noffset *= linewidth;\r\n\r\n// adjust for clip-space to screen-space conversion\r\noffset /= resolution.y;\r\n\r\n// select end\r\nvec4 clip = ( mapping.y < 0.5 ) ? clipStart : clipEnd;\r\n\r\n// back to clip space\r\noffset *= clip.w;\r\nclip.xy += offset;\r\ngl_Position = clip;\r\n\r\n#ifndef PICKING\r\nvViewPosition = ( projectionMatrixInverse * clip ).xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n\r\n}"),s.add("shader/WideLine.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\n#endif\nvoid main() {\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\nif ( flag < 0.0 ) {\ndiffuseColor.rgb *= vColor;\n} else {\ndiffuseColor.rgb *= vColor2;\n}\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");let tv=Object.assign({linewidth:2},ff),rv=Object.assign({linewidth:{uniform:!0}},gf);class iv extends u1{constructor(e,t={}){super(e,t),this.parameterTypes=rv,this.vertexShader="WideLine.vert",this.fragmentShader="WideLine.frag",!e.color2&&e.color&&(e.color2=e.color),this.addUniforms({linewidth:{value:this.parameters.linewidth},resolution:{value:new Ue},projectionMatrixInverse:{value:new tt}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return tv}setParameters(e){super.setParameters(e)}}gc.add("wideline",iv);class nv extends H0{constructor(e,t,r){super(e,t,r),this.type="angle",this.parameters=Object.assign({atomTriple:{type:"hidden",rebuild:!0},vectorVisible:{type:"boolean",default:!0},arcVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(r)}init(e){e=e||{};e.side=ce(e.side,"double"),e.opacity=ce(e.opacity,.5),this.atomTriple=ce(e.atomTriple,[]),this.arcVisible=ce(e.arcVisible,!0),this.sectorVisible=ce(e.sectorVisible,!0),this.vectorVisible=ce(e.vectorVisible,!0),super.init(e)}createData(e){var t,r;if(e.atomCount&&this.atomTriple.length)return e=((e,t={})=>{let r=ce(t.angleStep,Math.PI/90),i=e.length/9,s=new Float32Array(i),o=new Float32Array(3*i),l=new Array(i),h=new Float32Array(6*i),c=new Float32Array(6*i),u=new Array(i),d=new Array(i),m=new Array(i),p=0,f=Q(),g=Q(),v=Q(),_=Q(),y=Q(),b=Q(),x=Q(),S=Q(),w=Q();for(var A=0;A<i;A++){var M=9*A,M=(yd(f,e,M),yd(g,e,3+M),yd(v,e,6+M),6*A),M=(J(f,h,M),J(g,c,M),J(g,h,3+M),J(v,c,3+M),vd(_,f,g),vd(y,v,g),wd(_,_),wd(y,y),fd(b,_,y),xd(b)),C=gd(_,y),T=s[A]=Math.atan2(M,C),M=(l[A]=(Hc*T).toFixed(1)+String.fromCharCode(176),0===xd(b)&&(b[0]=1,b[1]=0,b[2]=0),fd(x,b,_),wd(x,x),j0(S,g,_,x,T/2),J(S,o,3*A),Math.ceil(T/r));let i=new Float32Array(9*M),n=(m[A]=i,new Float32Array(3*M)),a=new Float32Array(3*M);u[A]=n,d[A]=a,_d(w,g,_);var E=function(e,t){var r=9*t,t=3*t;J(g,i,r),J(w,i,3+r),J(w,n,t),j0(w,g,_,x,e),J(w,i,6+r),J(w,a,t)};let t=0;for(let e=r;e<T;e+=r)E(e,t),t++;E(T,t),p+=M}let n=3*p,a=9*p,P=new Float32Array(n),I=new Float32Array(n),R=new Float32Array(a),D=0,L=0;for(let e=0;e<i;e++){var O=u[e],k=d[e],k=(Zc(O,P,0,L,O.length),Zc(k,I,0,L,k.length),L+=O.length,m[e]);Zc(k,R,0,D,k.length),D+=k.length}return{labelPosition:o,labelText:l,vectorPosition1:h,vectorPosition2:c,arcPosition1:P,arcPosition2:I,sectorPosition:R}})((i=>{var e=[],t=i.length/9;for(let r=0;r<t;r++){let t=!0;for(let e=r;e<r+3;e+=3)i[e]===i[e+3]&&i[e+1]===i[e+4]&&i[e+2]===i[e+5]&&(t=!1);t&&e.push(r)}let r=new Float32Array(9*e.length),n=0;return e.forEach(function(e){Zc(i,r,9*e,9*n,9),n++}),r})($0(e,this.atomTriple))),t=this.n=e.labelPosition.length/3,r=new ze(this.labelColor),this.textBuffer=new ev({position:e.labelPosition,size:qc(t,this.labelSize),color:_(t,r.r,r.g,r.b),text:e.labelText},this.getLabelBufferParams()),r=new ze(this.colorValue),this.vectorBuffer=new iv(Rd({position1:e.vectorPosition1,position2:e.vectorPosition2,color:_(2*t,r.r,r.g,r.b),color2:_(2*t,r.r,r.g,r.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.vectorVisible,opacity:this.lineOpacity})),this.arcLength=e.arcPosition1.length/3,this.arcBuffer=new iv(Rd({position1:e.arcPosition1,position2:e.arcPosition2,color:_(this.arcLength,r.r,r.g,r.b),color2:_(this.arcLength,r.r,r.g,r.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.arcVisible,opacity:this.lineOpacity})),this.sectorLength=e.sectorPosition.length/3,this.sectorBuffer=new _f({position:e.sectorPosition,color:_(this.sectorLength,r.r,r.g,r.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.vectorBuffer,this.arcBuffer,this.sectorBuffer]}}updateData(e,t){super.updateData(e,t);var t={},r={},i={};e.color&&(e=new ze(this.colorValue),Object.assign(t,{color:_(2*this.n,e.r,e.g,e.b),color2:_(2*this.n,e.r,e.g,e.b)}),Object.assign(r,{color:_(this.arcLength,e.r,e.g,e.b),color2:_(this.arcLength,e.r,e.g,e.b)}),Object.assign(i,{color:_(this.sectorLength,e.r,e.g,e.b)})),this.vectorBuffer.setAttributes(t),this.arcBuffer.setAttributes(r),this.sectorBuffer.setAttributes(i)}setParameters(e){return super.setParameters(e,{},!1),!e||void 0===e.vectorVisible&&void 0===e.arcVisible&&void 0===e.sectorVisible||this.setVisibility(this.visible),e&&e.lineOpacity&&(this.vectorBuffer.setParameters({opacity:e.lineOpacity}),this.arcBuffer.setParameters({opacity:e.lineOpacity})),e&&void 0!==e.opacity&&(this.vectorBuffer.setParameters({opacity:this.lineOpacity}),this.arcBuffer.setParameters({opacity:this.lineOpacity})),e&&e.linewidth&&(this.vectorBuffer.setParameters({linewidth:e.linewidth}),this.arcBuffer.setParameters({linewidth:e.linewidth})),this}setVisibility(e,t){return super.setVisibility(e,!0),this.vectorBuffer&&this.vectorBuffer.setVisibility(this.vectorVisible&&this.visible),this.arcBuffer&&this.arcBuffer.setVisibility(this.arcVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),t||this.viewer.requestRender(),this}}mc.add("angle",nv);let av=new et,sv=new et,ov=new et,lv=new et(0,1,0),hv=Object.assign({radialSegments:1,openEnded:!0},ff);function cv(e={}){var t=ce(e.radialSegments,10),e=ce(e.openEnded,!0),r=(new tt).makeRotationX(Math.PI/2),t=new xl(1,1,1,t,1,e);return t.applyMatrix4(r),t}class uv extends n1{constructor(e,t={}){super(([r,a={}]=[e,t],a=cv(a),i=r.position1.length,a=a.attributes.position.array.length/3,s=i/3,n=new Float32Array(2*s*a),Yc(s,a,0,n),Yc(s,a,s*a,n),{position:s=new Float32Array(2*i),color:new Float32Array(2*i),primitiveId:n,picking:r.picking}),t,cv(t)),this.updateNormals=!0;var r,i,n,a=e.position1.length,s=e.radius.length;this.__center=new Float32Array(a),this._position=new Float32Array(2*a),this._color=new Float32Array(2*a),this._from=new Float32Array(2*a),this._to=new Float32Array(2*a),this._radius=new Float32Array(2*s),this.setAttributes(e,!0)}get defaultParameters(){return hv}applyPositionTransform(e,t,r){sv.fromArray(this._from,r),ov.fromArray(this._to,r),e.lookAt(sv,ov,lv);r=this._radius[t];av.set(r,r,sv.distanceTo(ov)),e.scale(av)}setAttributes(e={},t){var r={};e.position1&&e.position2&&(jc(e.position1,e.position2,this.__center),jc(e.position1,this.__center,this._position),jc(this.__center,e.position2,this._position,e.position1.length),this._from.set(e.position1),this._from.set(this.__center,e.position1.length),this._to.set(this.__center),this._to.set(e.position2,this.__center.length),r.position=this._position),e.color&&e.color2&&(this._color.set(e.color),this._color.set(e.color2,e.color.length),r.color=this._color),e.radius&&(this._radius.set(e.radius),this._radius.set(e.radius,e.radius.length),r.radius=this._radius),super.setAttributes(r,t)}}s.add("shader/CylinderImpostor.vert","\nattribute vec3 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\nattribute float radius;\nvarying vec3 axis;varying vec4 base_radius;varying vec4 end_b;varying vec3 U;varying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform mat4 modelViewMatrixInverse;\nuniform float ortho;\n#include matrix_scale\nvoid main(){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nbase_radius.w = radius * matrixScale( modelViewMatrix );\nvec3 center = position;\nvec3 dir = normalize( position2 - position1 );\nfloat ext = length( position2 - position1 ) / 2.0;\nvec3 cam_dir;\nif( ortho == 0.0 ){\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;\n}else{\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;\n}\ncam_dir = normalize( cam_dir );\nvec3 ldir;\nfloat b = dot( cam_dir, dir );\nend_b.w = b;\nif( b < 0.0 )\nldir = -ext * dir;\nelse\nldir = ext * dir;\nvec3 left = radius * normalize( cross( cam_dir, ldir ) );\nvec3 up = radius * normalize( cross( left, ldir ) );\naxis = normalize( normalMatrix * ldir );\nU = normalize( normalMatrix * up );\nV = normalize( normalMatrix * left );\nvec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );\nbase_radius.xyz = base4.xyz / base4.w;\nvec4 end4 = modelViewMatrix * vec4( center + ldir, 1.0 );\nend_b.xyz = end4.xyz / end4.w;\nw = modelViewMatrix * vec4(\ncenter + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0\n);\ngl_Position = projectionMatrix * w;\ngl_Position.z = 0.99;\n}"),s.add("shader/CylinderImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat distSq3( vec3 v3a, vec3 v3b ){\nreturn (\n( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +\n( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +\n( v3a.z - v3b.z ) * ( v3a.z - v3b.z )\n);\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nvoid main(){\nvec3 ray_target = w.xyz / w.w;\nvec3 base = base_radius.xyz; float vRadius = base_radius.w; vec3 end = end_b.xyz; float b = end_b.w;\nvec3 ray_origin = vec3(0.0); vec3 ortho_ray_direction = vec3(0.0, 0.0, 1.0); vec3 persp_ray_direction = normalize(ray_origin - ray_target);\nvec3 ray_direction = mix(persp_ray_direction, ortho_ray_direction, ortho);\nmat3 basis = mat3( U, V, axis );\nvec3 diff = ray_target - 0.5 * (base + end);\nvec3 P = diff * basis;\nfloat dz = dot( axis, ray_direction );\nfloat radius2 = vRadius*vRadius;\nvec3 D = vec3(dot(U, ray_direction),\ndot(V, ray_direction),\ndz);\nfloat a0 = P.x*P.x + P.y*P.y - radius2;\nfloat a1 = P.x*D.x + P.y*D.y;\nfloat a2 = D.x*D.x + D.y*D.y;\nfloat d = a1*a1 - a0*a2;\nif (d < 0.0) {\ndiscard;\n}\nfloat dist = (-a1 + sqrt(d)) / a2;\nvec3 surface_point = ray_target + dist * ray_direction;\nvec3 base_to_surface = surface_point - base;\nvec3 _normal = normalize( base_to_surface - axis * dot(base_to_surface, axis) );\nfloat base_cap_test = dot( base_to_surface, axis );\nfloat end_cap_test = dot((surface_point - end), axis);\n#ifndef CAP\nvec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\nvec3 tmp_point2 = new_point2 - base;\n#endif\nif (base_cap_test < 0.0) {\nfloat dNV;\nfloat near;\nvec3 front_point;\nif ( ortho == 1.0 ) {\nfront_point = ray_target;\n} else {\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nfront_point = ray_direction * near + ray_origin;\n}\nif (dot(front_point - base, front_point-base) > radius2) {\ndiscard;\n}\n#ifdef CAP\nsurface_point = front_point;\n_normal = axis;\n#else\nsurface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(axis, end) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - end, new_point2-base) < radius2) {\ndiscard;\n}\ninterior = true;\n#endif\n}\nif( end_cap_test > 0.0 )\n{\nfloat dNV;\nfloat near;\nvec3 end_point;\nif ( ortho == 1.0 ) {\nend_point = ray_target;\n} else {\ndNV = dot(axis, ray_direction);\nif (dNV < 0.0) {\ndiscard;\n}\nnear = dot(axis, end) / dNV;\nend_point = ray_direction * near + ray_origin;\n}\nif( dot(end_point - end, end_point-base) > radius2 ) {\ndiscard;\n}\n#ifdef CAP\nsurface_point = end_point;\n_normal = axis;\n#else\nsurface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - base, new_point2-base) < radius2) {\ndiscard;\n}\ninterior = true;\n#endif\n}\ngl_FragDepthEXT = calcDepth( surface_point );\n#ifdef NEAR_CLIP\nif( calcClip( surface_point ) > 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\nif( calcClip( surface_point ) > 0.0 ) {\ndiscard;\n}\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#endif\nif (gl_FragDepthEXT < 0.0) {\ndiscard;\n}\nif (gl_FragDepthEXT > 1.0) {\ndiscard;\n}\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -surface_point;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distSq3( surface_point, end ) < distSq3( surface_point, base ) ){\nif( b < 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}else{\nif( b > 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nvec3 nonPerturbedNormal = normal;\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");let dv=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),mv=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]);class pv extends l1{constructor(e,t={}){super("v3",e,t)}get mapping(){return dv}get mappingIndices(){return mv}get mappingIndicesSize(){return 12}get mappingSize(){return 6}get mappingItemSize(){return 3}}let fv=Object.assign({openEnded:!1},ff),gv=Object.assign({openEnded:{updateShader:!0}},gf);class vv extends pv{constructor(e,t={}){super(e,t),this.parameterTypes=gv,this.isImpostor=!0,this.vertexShader="CylinderImpostor.vert",this.fragmentShader="CylinderImpostor.frag",this.addUniforms({modelViewMatrixInverse:{value:new tt},ortho:{value:0}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return fv}getDefines(e){e=pv.prototype.getDefines.call(this,e);return this.parameters.openEnded||(e.CAP=1),e}}Object.assign({disableImpostor:!1},hv,fv);let _v=class{constructor(e,t={}){return!e.color2&&e.color&&(e.color2=e.color),new(!oc||t&&t.disableImpostor?uv:vv)(e,t)}};gc.add("cylinder",_v);class yv extends G0{constructor(e,t,r){super(e,t,r),this.type="axes",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0,showAxes:{type:"boolean",rebuild:!0},showBox:{type:"boolean",rebuild:!0}},this.parameters,{assembly:null}),this.init(r)}init(e){e=e||{};e.radiusSize=ce(e.radiusSize,.5),e.colorValue=ce(e.colorValue,"lightgreen"),e.useInteriorColor=ce(e.useInteriorColor,!0),this.showAxes=ce(e.showAxes,!0),this.showBox=ce(e.showBox,!1),super.init(e)}getPrincipalAxes(){let e;var t=this.getAssembly();return t&&(e=t.partList[0].getSelection()),this.structureView.getPrincipalAxes(e)}getAxesData(e){let a=this.getPrincipalAxes();var t=new ze(this.colorValue);let r=0,i=0,s=(this.showAxes&&(r+=6,i+=3),this.showBox&&(r+=8,i+=12),new Float32Array(3*r));var n=_(r,t.r,t.g,t.b),o=qc(r,this.radiusSize);let l=new Float32Array(3*i),h=new Float32Array(3*i);var t=_(i,t.r,t.g,t.b),c=qc(i,this.radiusSize);let u=0;if(this.showAxes&&((d=function(e,t){e.toArray(s,2*u),t.toArray(s,2*u+3),e.toArray(l,u),t.toArray(h,u),u+=3})(a.begA,a.endA),d(a.begB,a.endB),d(a.begC,a.endC)),this.showBox){let i=new et;var{d1a:d,d2a:e,d3a:m,d1b:p,d2b:f,d3b:g}=a.getProjectedScaleForAtoms(e);let n=2*u;var v=function(e,t,r){i.copy(a.center).addScaledVector(a.normVecA,e).addScaledVector(a.normVecB,t).addScaledVector(a.normVecC,r),i.toArray(s,n),n+=3};v(d,e,m),v(d,e,g),v(d,f,g),v(d,f,m),v(p,f,g),v(p,f,m),v(p,e,m),v(p,e,g);let r=u;d=function(e,t){i.fromArray(s,2*u+3*e).toArray(l,r),i.fromArray(s,2*u+3*t).toArray(h,r),r+=3};d(0,1),d(0,3),d(0,6),d(1,2),d(1,7),d(2,3),d(2,4),d(3,5),d(4,5),d(4,7),d(5,6),d(6,7)}f=new vp(a);return{vertex:{position:s,color:n,radius:o,picking:f},edge:{position1:l,position2:h,color:t,color2:t,radius:c,picking:f}}}create(){var e=this.getAxesData(this.structureView);this.sphereBuffer=new m1(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new _v(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}createData(e){}updateData(e,t){var t=this.getAxesData(t.sview),r={},i={};e&&!e.position||(Object.assign(r,{position:t.vertex.position}),Object.assign(i,{position1:t.edge.position1,position2:t.edge.position2})),e&&!e.color||(Object.assign(r,{color:t.vertex.color}),Object.assign(i,{color:t.edge.color,color2:t.edge.color})),e&&!e.radius||(Object.assign(r,{radius:t.vertex.radius}),Object.assign(i,{radius:t.edge.radius})),this.sphereBuffer.setAttributes(r),this.cylinderBuffer.setAttributes(i)}}mc.add("axes",yv);class bv extends G0{constructor(e,t,r){super(e,t,r),this.type="ball+stick",this.parameters=Object.assign({sphereDetail:!0,radialSegments:!0,openEnded:!0,disableImpostor:!0,aspectRatio:{type:"number",precision:1,max:10,min:1},lineOnly:{type:"boolean",rebuild:!0},cylinderOnly:{type:"boolean",rebuild:!0},multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondScale:{type:"number",precision:2,max:1,min:.01},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters),this.init(r)}init(e){e=e||{};e.radiusType=ce(e.radiusType,"size"),e.radiusSize=ce(e.radiusSize,.15),e.useInteriorColor=ce(e.useInteriorColor,!0),this.aspectRatio=ce(e.aspectRatio,2),this.lineOnly=ce(e.lineOnly,!1),this.cylinderOnly=ce(e.cylinderOnly,!1),this.multipleBond=ce(e.multipleBond,"off"),this.bondSpacing=ce(e.bondSpacing,1),this.bondScale=ce(e.bondScale,.4),this.linewidth=ce(e.linewidth,2),super.init(e)}getAtomRadius(e){return this.aspectRatio*super.getAtomRadius(e)}getAtomParams(e,t){e=super.getAtomParams(e,t);return e.radiusParams.scale*=this.aspectRatio,e}getAtomData(e,t,r){return e.getAtomData(this.getAtomParams(t,r))}getBondParams(e,t){return t=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,bondScale:this.bondScale},t),super.getBondParams(e,t)}getBondData(e,t,r){return e.getBondData(this.getBondParams(t,r))}createData(e){var t,r=[];return this.lineOnly?(this.lineBuffer=new iv(this.getBondData(e,{position:!0,color:!0,picking:!0}),this.getBufferParams({linewidth:this.linewidth})),r.push(this.lineBuffer)):(t=new _v(this.getBondData(e),this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),r.push(t),this.cylinderOnly||(t=new m1(this.getAtomData(e),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),r.push(t))),{bufferList:r}}updateData(e,t){"off"!==this.multipleBond&&e&&e.radius&&(e.position=!0);var r,i=this.getBondData(t.sview,e);this.lineOnly?(r={},e&&!e.position||Object.assign(r,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(r,{color:i.color,color2:i.color2}),t.bufferList[0].setAttributes(r)):(r={},e&&!e.position||Object.assign(r,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(r,{color:i.color,color2:i.color2}),e&&!e.radius||Object.assign(r,{radius:i.radius}),t.bufferList[0].setAttributes(r),this.cylinderOnly||(i=this.getAtomData(t.sview,e),r={},e&&!e.position||Object.assign(r,{position:i.position}),e&&!e.color||Object.assign(r,{color:i.color}),e&&!e.radius||Object.assign(r,{radius:i.radius}),t.bufferList[1].setAttributes(r)))}setParameters(e={}){let t=!1;var r={};return(e.aspectRatio||e.bondSpacing||e.bondScale)&&(Object.assign(r,{radius:!0}),oc&&!this.disableImpostor||(t=!0)),super.setParameters(e,r,t),this}}mc.add("ball+stick",bv);class xv extends bv{constructor(e,t,r){super(e,t,r),this.type="backbone",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null}),this.init(r)}init(e){e=e||{};e.aspectRatio=ce(e.aspectRatio,1),e.radiusSize=ce(e.radiusSize,.25),super.init(e)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}getAtomData(e,t,r){return e.getBackboneAtomData(this.getAtomParams(t,r))}getBondData(e,t,r){return e.getBackboneBondData(this.getBondParams(t,r))}}mc.add("backbone",xv);class Sv extends bv{constructor(e,t,r){super(e,t,r),this.type="base",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){e=e||{};e.aspectRatio=ce(e.aspectRatio,1),e.radiusSize=ce(e.radiusSize,.3),super.init(e)}getAtomData(e,t,r){return e.getRungAtomData(this.getAtomParams(t,r))}getBondData(e,t,r){t=this.getBondParams(t,r);return Object.assign(t.colorParams,{rung:!0}),e.getRungBondData(t)}}mc.add("base",Sv);class wv{constructor(e,t){this.m=e,this.tension=t,this.dt=1/this.m,this.delta=1e-4,this.vec1=new et,this.vec2=new et,this.vDir=new et,this.vTan=new et,this.vNorm=new et,this.vBin=new et,this.m2=Math.ceil(this.m/2)}interpolateToArr(e,t,r,i,n,a,s){a[s+0]=dh(e.x,t.x,r.x,i.x,n,this.tension),a[s+1]=dh(e.y,t.y,r.y,i.y,n,this.tension),a[s+2]=dh(e.z,t.z,r.z,i.z,n,this.tension)}interpolateToVec(e,t,r,i,n,a){a.x=dh(e.x,t.x,r.x,i.x,n,this.tension),a.y=dh(e.y,t.y,r.y,i.y,n,this.tension),a.z=dh(e.z,t.z,r.z,i.z,n,this.tension)}interpolatePosition(e,t,r,i,n,a){for(var s=0;s<this.m;++s){var o=this.dt*s;this.interpolateToArr(e,t,r,i,o,n,a+3*s)}}interpolateTangent(e,t,r,i,n,a){for(var s=0;s<this.m;++s){var o=this.dt*s,l=o-this.delta,o=o+this.delta,h=a+3*s;l<0&&(l=0),1<o&&(o=1),this.interpolateToVec(e,t,r,i,l,this.vec1),this.interpolateToVec(e,t,r,i,o,this.vec2),this.vec2.sub(this.vec1).normalize(),this.vec2.toArray(n,h)}}vectorSubdivide(t,r,i,e,n){let a,s=r.next(),o=r.next(),l=r.next();var h=r.size,c=h-1;let u=e||0;for(let e=0;e<c;++e)a=s,s=o,o=l,l=r.next(),t.apply(this,[a,s,o,l,i,u]),u+=3*this.m;n&&(a=r.get(h-2),s=r.get(h-1),o=r.get(0),l=r.get(1),t.apply(this,[a,s,o,l,i,u]),u+=3*this.m)}getPosition(e,t,r,i){e.reset(),this.vectorSubdivide(this.interpolatePosition,e,t,r,i);var r=e.size-1,n=r*this.m*3,e=(i&&(n+=3*this.m),e.get(i?0:r));t[n]=e.x,t[n+1]=e.y,t[n+2]=e.z}getTangent(e,t,r,i){e.reset(),this.vectorSubdivide(this.interpolateTangent,e,t,r,i);let n=(e.size-1)*this.m*3;i&&(n+=3*this.m),Zc(t,t,n-3,n,3)}interpolateNormalDir(r,i,n,a,s,o,l,h,c,u,d,m,p){for(let t=0;t<this.m;++t){let e=m+3*t;p&&(e+=3*this.m2);var f=this.dt*t;this.interpolateToVec(r,i,n,a,f,this.vec1),this.interpolateToVec(s,o,l,h,f,this.vec2),this.vDir.subVectors(this.vec2,this.vec1).normalize(),this.vTan.fromArray(c,e),this.vBin.crossVectors(this.vDir,this.vTan).normalize(),this.vBin.toArray(d,e),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(u,e)}}interpolateNormal(e,t,r,i,n){for(var a=0;a<this.m;++a){var s=n+3*a;e.copy(this.vNorm),this.vTan.fromArray(t,s),this.vBin.crossVectors(e,this.vTan).normalize(),this.vBin.toArray(i,s),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(r,s)}}getNormal(e,t,r,i,n,a){this.vNorm.set(0,0,1);var s=e-1;let o=n||0;for(var l=0;l<s;++l)this.interpolateNormal(this.vDir,t,r,i,o),o+=3*this.m;a&&(this.interpolateNormal(this.vDir,t,r,i,o),o+=3*this.m),this.vBin.toArray(i,o),this.vNorm.toArray(r,o)}getNormalDir(e,t,r,i,n,a,s,o){e.reset(),t.reset();var l=new et,h=new et,c=new et,u=new et,d=new et,m=(new et).copy(e.next()),p=(new et).copy(e.next()),f=(new et).copy(e.next()),g=new et,v=(new et).copy(t.next()),_=(new et).copy(t.next()),y=(new et).copy(t.next()),b=(this.vNorm.set(0,0,1),e.size),x=b-1;let S=a||0;for(var w=0;w<x;++w)d.copy(m),m.copy(p),p.copy(f),f.copy(e.next()),g.copy(v),v.copy(_),_.copy(y),y.copy(t.next()),0===w?(l.subVectors(g,d),h.subVectors(v,m),l.dot(h)<0&&(h.multiplyScalar(-1),v.addVectors(m,h)),c.subVectors(_,p),h.dot(c)<0&&(c.multiplyScalar(-1),_.addVectors(p,c))):c.copy(u),u.subVectors(y,f),c.dot(u)<0&&(u.multiplyScalar(-1),y.addVectors(f,u)),this.interpolateNormalDir(d,m,p,f,g,v,_,y,r,i,n,S,o),S+=3*this.m;if(s&&(d.copy(e.get(b-2)),m.copy(e.get(b-1)),p.copy(e.get(0)),f.copy(e.get(1)),g.copy(t.get(b-2)),v.copy(t.get(b-1)),_.copy(t.get(0)),y.copy(t.get(1)),c.copy(u),u.subVectors(y,f),c.dot(u)<0&&(u.multiplyScalar(-1),y.addVectors(f,u)),this.interpolateNormalDir(d,m,p,f,g,v,_,y,r,i,n,S,o),S+=3*this.m),o){this.vBin.fromArray(n,3*this.m2),this.vNorm.fromArray(i,3*this.m2);for(var A=0;A<this.m2;++A)this.vBin.toArray(n,3*A),this.vNorm.toArray(i,3*A)}else this.vBin.toArray(n,S),this.vNorm.toArray(i,S)}interpolateColor(e,t,r,i,n){for(var a=0;a<this.m2;++a)r.apply(this,[e,i,n+3*a]);for(a=this.m2;a<this.m;++a)r.apply(this,[t,i,n+3*a])}getColor(e,t,r,i,n){e.reset(),e.next();let a,s=e.next(),o=e.size,l=o-1;for(var h=i||0,c=0;c<l;++c)a=s,s=e.next(),this.interpolateColor(a,s,t,r,h),h+=3*this.m;n&&(a=e.get(o-1),s=e.get(0),this.interpolateColor(a,s,t,r,h),h+=3*this.m),r[h]=r[h-3],r[h+1]=r[h-2],r[h+2]=r[h-1]}interpolatePicking(e,t,r,i,n){for(var a=0;a<this.m2;++a)i[n+a]=r.apply(this,[e]);for(a=this.m2;a<this.m;++a)i[n+a]=r.apply(this,[t])}getPicking(e,t,r,i,n){e.reset(),e.next();let a,s=e.next();var o=e.size,l=o-1;let h=i||0;for(var c=0;c<l;++c)a=s,s=e.next(),this.interpolatePicking(a,s,t,r,h),h+=this.m;n&&(a=e.get(o-1),s=e.get(0),this.interpolatePicking(a,s,t,r,h),h+=this.m),r[h]=r[h-1]}interpolateSize(e,t,r,i,n){var a=r.apply(this,[e]),s=r.apply(this,[t]);for(let e=0;e<this.m;++e){var o=e/this.m;i[n+e]=(1-o)*a+o*s}}getSize(e,t,r,i,n){e.reset(),e.next();let a,s=e.next();var o=e.size,l=o-1;let h=i||0;for(var c=0;c<l;++c)a=s,s=e.next(),this.interpolateSize(a,s,t,r,h),h+=this.m;n&&(a=e.get(o-1),s=e.get(0),this.interpolateSize(a,s,t,r,h),h+=this.m),r[h]=r[h-1]}}class Av{constructor(e,t){this.polymer=e,this.size=e.residueCount;e=t||{};this.directional=e.directional||!1,this.positionIterator=e.positionIterator||!1,this.subdiv=e.subdiv||1,this.smoothSheet=e.smoothSheet||!1,this.tension=e.tension||(this.polymer.isNucleic()?.5:.9),this.interpolator=new wv(this.subdiv,this.tension)}getAtomIterator(i,n){let a=this.polymer;var e=a.structure;let s=a.residueCount,o=0,t=-1,l=[e.getAtomProxy(),e.getAtomProxy(),e.getAtomProxy(),e.getAtomProxy()],h=[new et,new et,new et,new et];var c=e.getAtomProxy(),u=e.getAtomProxy();function r(e){var t,r=l[o%4];return r.index=a.getAtomIndexByType(e,i),n&&0<e&&e<s&&"e"===r.sstruc?(t=h[o%4],c.index=a.getAtomIndexByType(e+1,i),u.index=a.getAtomIndexByType(e-1,i),t.addVectors(c,u).add(r).add(r).multiplyScalar(.25),o+=1,t):(o+=1,r)}return{size:s,next:function(){var e=r(t);return t+=1,e},get:r,reset:function(){o=0,t=-1}}}getSubdividedColor(e){var t=this.subdiv,r=this.polymer,i=(r.residueCount-1)*t*3+3,t=(r.isCyclic&&(i+=3*t),new Float32Array(i)),i=this.getAtomIterator("trace"),e=e||{},n=(e.structure=r.structure,k.getScheme(e));return this.interpolator.getColor(i,function(e,t,r){n.atomColorToArray(e,t,r)},t,0,r.isCyclic),{color:t}}getSubdividedPicking(){var e=this.subdiv,t=this.polymer,r=(t.residueCount-1)*e+1,e=(t.isCyclic&&(r+=e),t.structure),i=this.getAtomIterator("trace"),r=new Float32Array(r);return this.interpolator.getPicking(i,function(e){return e.index},r,0,t.isCyclic),{picking:new gp(r,e)}}getSubdividedPosition(){return{position:this.getPosition()}}getSubdividedOrientation(){var e=this.getTangent(),t=this.getNormals(e);return{tangent:e,normal:t.normal,binormal:t.binormal}}getSubdividedSize(e){var t=this.subdiv,r=this.polymer,i=(r.residueCount-1)*t+1,t=(r.isCyclic&&(i+=t),new Float32Array(i)),i=this.getAtomIterator("trace"),n=new Gf(e);return this.interpolator.getSize(i,function(e){return n.atomRadius(e)},t,0,r.isCyclic),{size:t}}getPosition(){var e=this.subdiv,t=this.polymer;let r=(t.residueCount-1)*e*3+3;t.isCyclic&&(r+=3*e);var e=new Float32Array(r),i=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getPosition(i,e,0,t.isCyclic),e}getTangent(){var e=this.subdiv,t=this.polymer;let r=(this.size-1)*e*3+3;t.isCyclic&&(r+=3*e);var e=new Float32Array(r),i=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getTangent(i,e,0,t.isCyclic),e}getNormals(e){var t=this.subdiv,r=this.polymer,i=r.isProtein(),n=this.size;let a=(n-1)*t*3+3;r.isCyclic&&(a+=3*t);var s,o,t=new Float32Array(a),l=new Float32Array(a);return this.directional&&!this.polymer.isCg()?(s=this.getAtomIterator("direction1"),o=this.getAtomIterator("direction2"),this.interpolator.getNormalDir(s,o,e,t,l,0,r.isCyclic,i)):this.interpolator.getNormal(n,e,t,l,0,r.isCyclic),{normal:t,binormal:l}}}let Mv=new et,Cv=new et,Tv=Object.assign({radialSegments:4,capped:!1,aspectRatio:1},ff);class Ev extends _f{constructor(e,t={}){var r,i,n,a,s;super(([r,i={}]=[e,t],n=ce(i.radialSegments,4),i=ce(i.capped,!1),a=(s=r.position.length/3)*n*3+2*(i?n:0)*3,s=2*(s-1)*n*3+2*(i?n-2:0)*3,{position:new Float32Array(a),color:new Float32Array(a),index:Zl(s,a/3),normal:new Float32Array(a),picking:r.picking}),t),this.capVertices=this.parameters.capped?this.parameters.radialSegments:0,this.capTriangles=this.parameters.capped?this.parameters.radialSegments-2:0,this.size2=e.position.length/3,e.primitiveId=Xc(this.size2),this.setAttributes(e),this.makeIndex()}get defaultParameters(){return Tv}setAttributes(e={}){var t=this.parameters.aspectRatio,r=this.size2,N=r-1,i=this.parameters.radialSegments,n=this.geometry.attributes;let a,s,o,l,h,F,c,u,d,m,p;e.position&&(a=e.position,s=e.normal,o=e.binormal,l=e.tangent,F=e.size,u=n.position.array,m=n.normal.array,n.position.needsUpdate=!0,n.normal.needsUpdate=!0),e.color&&(h=e.color,d=n.color.array,n.color.needsUpdate=!0),e.primitiveId&&(c=e.primitiveId,p=n.primitiveId.array,n.primitiveId.needsUpdate=!0);let f,g,v=0,_=0,y=0,b=0,x=0,S=0,w=0,B=0,U=0,z=0;var V=[],G=[],H=[],$=[],j=[],W=[];if(a)for(let e=0;e<i;++e){var A=e/i*2*Math.PI;V[e]=t*Math.cos(A),G[e]=Math.sin(A),H[e]=t*Math.cos(A-.01),$[e]=Math.sin(A-.01),j[e]=t*Math.cos(.01+A),W[e]=Math.sin(.01+A)}for(let t=0;t<r;++t){f=3*t,g=f*i,a&&l&&s&&o&&F&&(Mv.set(l[f],l[f+1],l[f+2]),_=s[f],y=s[f+1],b=s[f+2],x=o[f],S=o[f+1],w=o[f+2],B=a[f],U=a[f+1],z=a[f+2],v=F[t]);for(let e=0;e<i;++e){var M,C,T,E,P,I,R=g+3*e;a&&(M=-v*V[e],C=v*G[e],T=-v*H[e],E=v*$[e],P=-v*j[e],I=v*W[e],u[R]=B+M*_+C*x,u[R+1]=U+M*y+C*S,u[R+2]=z+M*b+C*w,Cv.set(P*_+I*x-(T*_+E*x),P*y+I*S-(T*y+E*S),P*b+I*w-(T*b+E*w)).cross(Mv),m[R]=Cv.x,m[R+1]=Cv.y,m[R+2]=Cv.z),h&&(d[R]=h[f],d[R+1]=h[f+1],d[R+2]=h[f+2]),c&&(p[t*i+e]=c[t])}}f=0,g=3*r*i;for(let e=0;e<i;++e){var D=f+3*e,L=g+3*e;a&&l&&(u[L]=u[D],u[L+1]=u[D+1],u[L+2]=u[D+2],m[L]=l[f],m[L+1]=l[f+1],m[L+2]=l[f+2]),h&&(d[L]=d[D],d[L+1]=d[D+1],d[L+2]=d[D+2]),c&&(p[r*i+e]=p[0+e])}f=3*(r-1)*i,g=3*(r+1)*i;for(let e=0;e<i;++e){var O=f+3*e,k=g+3*e;a&&l&&(u[k]=u[O],u[k+1]=u[O+1],u[k+2]=u[O+2],m[k]=l[3*N],m[k+1]=l[3*N+1],m[k+2]=l[3*N+2]),h&&(d[k]=d[O],d[k+1]=d[O+1],d[k+2]=d[O+2]),c&&(p[(r+1)*i+e]=p[(r-1)*i+e])}}makeIndex(){var e=this.geometry.getIndex();if(e){var i=e.array,e=this.size2,n=e-1,a=this.capTriangles,s=this.parameters.radialSegments,o=this.parameters.radialSegments+1;let t,r;for(let e=0;e<n;++e){let t=e*s*3*2;var l=e*s,h=(e+1)*s;for(let e=0;e<s;++e)i[r=t+3*e*2]=l+e,i[r+1]=l+(e+1)%s,i[r+2]=h+e,i[r+3]=h+e,i[r+4]=l+(e+1)%s,i[r+5]=h+(e+1)%s}var c=[0];for(let e=1;e<o/2;++e)c.push(e),s-e!==e&&c.push(s-e);r=n*s*3*2,t=e*s;for(let e=0;e<c.length-2;++e)e%2==0?(i[r+3*e+0]=t+c[e+0],i[r+3*e+1]=t+c[e+1],i[r+3*e+2]=t+c[e+2]):(i[r+3*e+0]=t+c[e+2],i[r+3*e+1]=t+c[e+1],i[r+3*e+2]=t+c[e+0]);r=n*s*3*2+3*a,t=e*s+s;for(let e=0;e<c.length-2;++e)e%2==0?(i[r+3*e+0]=t+c[e+0],i[r+3*e+1]=t+c[e+1],i[r+3*e+2]=t+c[e+2]):(i[r+3*e+0]=t+c[e+2],i[r+3*e+1]=t+c[e+1],i[r+3*e+2]=t+c[e+0])}else rt.error("Index is null")}}class Pv extends G0{constructor(e,t,r){super(e,t,r),this.type="cartoon",this.parameters=Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1,rebuild:!0},subdiv:{type:"integer",max:50,min:1,rebuild:!0},radialSegments:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean",rebuild:!0},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"chainname"),e.colorScale=ce(e.colorScale,"RdYlBu"),e.radiusType=ce(e.radiusType,"sstruc"),e.radiusScale=ce(e.radiusScale,.7),e.useInteriorColor=ce(e.useInteriorColor,!0),this.aspectRatio=ce(e.aspectRatio,5),this.tension=ce(e.tension,NaN),this.capped=ce(e.capped,!0),this.smoothSheet=ce(e.smoothSheet,!1),"low"===e.quality?(this.subdiv=3,this.radialSegments=6):"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=ce(e.subdiv,6),super.init(e)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:1!==this.aspectRatio,smoothSheet:this.smoothSheet},e)}getSpline(e){return new Av(e,this.getSplineParams())}getAspectRatio(e){return e.isCg()?1:this.aspectRatio}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){let s=[],o=[];return this.structure.eachPolymer(e=>{var t,r,i,n,a;e.residueCount<4||(o.push(e),a=this.getSpline(e),e=this.getAspectRatio(e),t=a.getSubdividedPosition(),r=a.getSubdividedOrientation(),i=a.getSubdividedColor(this.getColorParams()),n=a.getSubdividedPicking(),a=a.getSubdividedSize(this.getRadiusParams()),s.push(new Ev(Object.assign({},t,r,i,n,a),this.getBufferParams({radialSegments:this.radialSegments,aspectRatio:e,capped:this.capped}))))},e.getSelection()),{bufferList:s,polymerList:o}}updateData(e,t){Je.Debug&&rt.time(this.type+" repr update"),e=e||{};for(var r=0,i=t.polymerList.length;r<i;++r){var n,a,s={},o=t.polymerList[r],l=this.getSpline(o),o=this.getAspectRatio(o);Object.assign(t.bufferList[r],{aspectRatio:o}),(e.position||e.radius)&&(n=l.getSubdividedPosition(),a=l.getSubdividedOrientation(),o=l.getSubdividedSize(this.getRadiusParams(o)),s.position=n.position,s.normal=a.normal,s.binormal=a.binormal,s.tangent=a.tangent,s.size=o.size),e.color&&(n=l.getSubdividedColor(this.getColorParams()),s.color=n.color),e.picking&&(a=l.getSubdividedPicking(),s.picking=a.picking),t.bufferList[r].setAttributes(s)}Je.Debug&&rt.timeEnd(this.type+" repr update")}setParameters(e){var t={};return e&&e.aspectRatio&&(t.radius=!0),e&&e.tension&&(t.position=!0),super.setParameters(e,t,!1),this}}mc.add("cartoon",Pv);class Iv extends G0{constructor(e,t,r){super(e,t,r),this.type="contact",this.parameters=Object.assign({hydrogenBond:{type:"boolean",rebuild:!0},weakHydrogenBond:{type:"boolean",rebuild:!0},waterHydrogenBond:{type:"boolean",rebuild:!0},backboneHydrogenBond:{type:"boolean",rebuild:!0},hydrophobic:{type:"boolean",rebuild:!0},halogenBond:{type:"boolean",rebuild:!0},ionicInteraction:{type:"boolean",rebuild:!0},metalCoordination:{type:"boolean",rebuild:!0},cationPi:{type:"boolean",rebuild:!0},piStacking:{type:"boolean",rebuild:!0},filterSele:{type:"text",rebuild:!0},labelVisible:{type:"boolean",rebuild:!0},labelFixedSize:{type:"boolean",buffer:"fixedSize"},labelSize:{type:"number",precision:3,max:10,min:.001,rebuild:!0},labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},maxHydrophobicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondSulfurDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondAccAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondDonAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondAccPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxHbondDonPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxPiStackingDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingAngle:{type:"integer",max:180,min:0,rebuild:!0},maxCationPiDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxCationPiOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxIonicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondAngle:{type:"integer",max:180,min:0,rebuild:!0},maxMetalDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},refineSaltBridges:{type:"boolean",rebuild:!0},masterModelIndex:{type:"integer",max:1e3,min:-1,rebuild:!0},lineOfSightDistFactor:{type:"number",precision:1,max:10,min:0,rebuild:!0},radialSegments:!0,disableImpostor:!0},this.parameters),this.init(r)}init(e){e=e||{};e.radiusSize=ce(e.radiusSize,.05),e.useInteriorColor=ce(e.useInteriorColor,!0),this.hydrogenBond=ce(e.hydrogenBond,!0),this.weakHydrogenBond=ce(e.weakHydrogenBond,!1),this.waterHydrogenBond=ce(e.waterHydrogenBond,!1),this.backboneHydrogenBond=ce(e.backboneHydrogenBond,!1),this.hydrophobic=ce(e.hydrophobic,!1),this.halogenBond=ce(e.halogenBond,!0),this.ionicInteraction=ce(e.ionicInteraction,!0),this.metalCoordination=ce(e.metalCoordination,!0),this.cationPi=ce(e.cationPi,!0),this.piStacking=ce(e.piStacking,!0),this.filterSele=ce(e.filterSele,""),this.labelVisible=ce(e.labelVisible,!1),this.labelFixedSize=ce(e.labelFixedSize,!1),this.labelSize=ce(e.labelSize,2),this.labelUnit=ce(e.labelUnit,""),this.maxHydrophobicDist=ce(e.maxHydrophobicDist,4),this.maxHbondDist=ce(e.maxHbondDist,3.5),this.maxHbondSulfurDist=ce(e.maxHbondSulfurDist,4.1),this.maxHbondAccAngle=ce(e.maxHbondAccAngle,45),this.maxHbondDonAngle=ce(e.maxHbondDonAngle,45),this.maxHbondAccPlaneAngle=ce(e.maxHbondAccPlaneAngle,90),this.maxHbondDonPlaneAngle=ce(e.maxHbondDonPlaneAngle,30),this.maxPiStackingDist=ce(e.maxPiStackingDist,5.5),this.maxPiStackingOffset=ce(e.maxPiStackingOffset,2),this.maxPiStackingAngle=ce(e.maxPiStackingAngle,30),this.maxCationPiDist=ce(e.maxCationPiDist,6),this.maxCationPiOffset=ce(e.maxCationPiOffset,2),this.maxIonicDist=ce(e.maxIonicDist,5),this.maxHalogenBondDist=ce(e.maxHalogenBondDist,3.5),this.maxHalogenBondAngle=ce(e.maxHalogenBondAngle,30),this.maxMetalDist=ce(e.maxMetalDist,3),this.refineSaltBridges=ce(e.refineSaltBridges,!0),this.masterModelIndex=ce(e.masterModelIndex,-1),this.lineOfSightDistFactor=ce(e.lineOfSightDistFactor,1),super.init(e)}getAtomRadius(){return 0}getContactData(e){var t={maxHydrophobicDist:this.maxHydrophobicDist,maxHbondDist:this.maxHbondDist,maxHbondSulfurDist:this.maxHbondSulfurDist,maxHbondAccAngle:this.maxHbondAccAngle,maxHbondDonAngle:this.maxHbondDonAngle,maxHbondAccPlaneAngle:this.maxHbondAccPlaneAngle,maxHbondDonPlaneAngle:this.maxHbondDonPlaneAngle,maxPiStackingDist:this.maxPiStackingDist,maxPiStackingOffset:this.maxPiStackingOffset,maxPiStackingAngle:this.maxPiStackingAngle,maxCationPiDist:this.maxCationPiDist,maxCationPiOffset:this.maxCationPiOffset,maxIonicDist:this.maxIonicDist,maxHalogenBondDist:this.maxHalogenBondDist,maxHalogenBondAngle:this.maxHalogenBondAngle,maxMetalDist:this.maxMetalDist,refineSaltBridges:this.refineSaltBridges,masterModelIndex:this.masterModelIndex,lineOfSightDistFactor:this.lineOfSightDistFactor},r={hydrogenBond:this.hydrogenBond,weakHydrogenBond:this.weakHydrogenBond,waterHydrogenBond:this.waterHydrogenBond,backboneHydrogenBond:this.backboneHydrogenBond,hydrophobic:this.hydrophobic,halogenBond:this.halogenBond,ionicInteraction:this.ionicInteraction,metalCoordination:this.metalCoordination,cationPi:this.cationPi,piStacking:this.piStacking,radius:this.radiusSize*this.radiusScale,filterSele:this.filterSele};return up(lp(e,t),e,r)}createData(e){var t,e=this.getContactData(e),r=[new _v(Pd(e),this.getBufferParams({sphereDetail:1,dullInterior:!0,disableImpostor:this.disableImpostor}))];return this.labelVisible&&(t={size:this.labelSize,unit:this.labelUnit},r.push(new ev(((e,t)=>{var r=jc(e.position1,e.position2),i=[],n=Wc(e.position1,e.position2),a=n.length/3;for(let e=0;e<a;e++){var s=3*e,o=Math.sqrt(Math.pow(n[s],2)+Math.pow(n[1+s],2)+Math.pow(n[2+s],2));switch(t.unit){case"angstrom":i[e]=o.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":i[e]=(o/10).toFixed(2)+" nm";break;default:i[e]=o.toFixed(2)}}return{position:r,size:qc(r.length/3,t.size),color:e.color,text:i}})(e,t),this.getBufferParams({fixedSize:this.labelFixedSize})))),{bufferList:r}}}mc.add("contact",Iv);class Rv extends H0{constructor(e,t,r){super(e,t,r),this.type="dihedral",this.parameters=Object.assign({atomQuad:{type:"hidden",rebuild:!0},extendLine:{type:"boolean",rebuild:!0,default:!0},lineVisible:{type:"boolean",default:!0},planeVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(r)}init(e){e=e||{};e.side=ce(e.side,"double"),e.opacity=ce(e.opacity,.5),this.atomQuad=ce(e.atomQuad,[]),this.extendLine=ce(e.extendLine,!0),this.lineVisible=ce(e.lineVisible,!0),this.planeVisible=ce(e.planeVisible,!0),this.sectorVisible=ce(e.sectorVisible,!0),super.init(e)}createData(e){var t,r;if(e.atomCount&&this.atomQuad.length)return e=((e,s)=>{let o=ce(s.angleStep,Math.PI/90),N=e.length,t=e.length/12,F=new Float32Array(t),l=new Float32Array(3*t),h=new Array(t),c=new Array(t),B=new Array(t),U=new Array(t),z=new Array(t),u=0,V=0,G=0,d=Q(),m=Q(),p=Q(),f=Q(),g=Q(),v=Q(),_=Q(),y=Q(),b=Q(),x=Q(),S=Q(),w=Q(),A=Q(),M=Q(),C=Q(),T=0;for(var r=0;r<N;r+=12)if(yd(d,e,r),yd(m,e,r+3),yd(p,e,r+6),yd(f,e,r+9),vd(g,d,m),vd(v,p,m),0!==xd(v)){vd(_,f,p),ue(y,v,.5),_d(b,m,y),wd(g,g),wd(v,v),wd(_,_),vd(y,d,b);var E=0<gd(y,v),P=(vd(y,f,b),gd(y,v)<0);if(ue(y,v,gd(v,g)),vd(x,g,y),ue(y,v,gd(v,_)),vd(S,_,y),0!==xd(x)&&0!==xd(S)){wd(x,x),wd(S,S);var I=F[T]=((e,t)=>{var r=e[0],i=e[1],e=e[2],n=t[0],a=t[1],s=i*(t=t[2])-e*a,o=e*n-r*t,l=r*a-i*n,s=Math.sqrt(s*s+o*o+l*l);return Math.atan2(s,r*n+i*a+e*t)})(x,S),R=(h[T]=(Hc*I).toFixed(1)+String.fromCharCode(176),fd(M,x,v),wd(M,M),gd(M,S)<0&&Ed(M,M),j0(y,b,x,M,I/2),J(y,l,3*T),Math.ceil(I/o)),D=R+(s.extendLine?4:2),H=s.extendLine?36:0;let r=new Float32Array(3*D),i=new Float32Array(3*D),n=new Float32Array(9*R);var L=new Float32Array(H);c[T]=r,B[T]=i,U[T]=n,z[T]=L,s.extendLine&&(E?(vd(y,d,p),wd(y,y),ue(w,y,1/gd(x,y)),_d(w,w,p)):(ue(w,g,1/gd(x,g)),_d(w,w,m)),P?(vd(y,f,m),wd(y,y),ue(A,y,1/gd(S,y)),_d(A,A,m)):(ue(A,_,1/gd(S,_)),_d(A,A,p))),_d(C,b,x);let a=0;s.extendLine?(J(d,r,a),J(w,i,a),a+=3,J(w,r,a),J(C,i,a),a+=3,J(w,L,0),J(C,L,3),J(E?p:m,L,6),J(E?p:m,L,9),J(C,L,12),J(b,L,15)):(J(b,r,a),J(C,i,a),a+=3);var $=function(e,t){t*=9;J(b,n,t),J(C,n,3+t),J(C,r,a),j0(C,b,x,M,e),J(C,n,6+t),J(C,i,a),a+=3};let t=0;for(let e=o;e<I;e+=o)$(e,t++);$(I,t++),s.extendLine?(J(C,r,3*(D-2)),J(A,i,3*(D-2)),J(A,r,3*(D-1)),J(f,i,3*(D-1)),J(A,L,18),J(C,L,21),J(P?m:p,L,24),J(P?m:p,L,27),J(C,L,30),J(b,L,33)):(J(C,r,a),J(b,i,a),a+=3),u+=3*D,V+=9*R,G+=H,T+=1}}let i=T,j=new Float32Array(u),W=new Float32Array(u),q=new Float32Array(V),X=new Float32Array(G),n=0,Y=0,K=0;for(let e=0;e<i;e++){var a=c[e],Z=B[e],O=U[e],k=z[e];Zc(a,j,0,n,a.length),Zc(Z,W,0,n,Z.length),Zc(O,q,0,Y,O.length),Zc(k,X,0,K,k.length),n+=a.length,Y+=O.length,K+=k.length}return{labelPosition:l.subarray(0,3*i),labelText:h.slice(0,i),linePosition1:j,linePosition2:W,planePosition:X,sectorPosition:q}})($0(e,this.atomQuad),{extendLine:this.extendLine}),t=this.n=e.labelText.length,r=new ze(this.labelColor),this.textBuffer=new ev({position:e.labelPosition,size:qc(t,this.labelSize),color:_(t,r.r,r.g,r.b),text:e.labelText},this.getLabelBufferParams()),t=new ze(this.colorValue),this.lineLength=e.linePosition1.length/3,r=_(this.lineLength,t.r,t.g,t.b),this.lineBuffer=new iv(Rd({position1:e.linePosition1,position2:e.linePosition2,color:r,color2:r}),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.planeLength=e.planePosition.length/3,this.planeBuffer=new _f({position:e.planePosition,color:_(this.planeLength,t.r,t.g,t.b)},this.getBufferParams({visible:this.planeVisible})),this.sectorLength=e.sectorPosition.length/3,this.sectorBuffer=new _f({position:e.sectorPosition,color:_(this.sectorLength,t.r,t.g,t.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.lineBuffer,this.planeBuffer,this.sectorBuffer]}}updateData(e,t){super.updateData(e,t);var t={},r={},i={};e.color&&(e=new ze(this.colorValue),Object.assign(t,{color:_(this.lineLength,e.r,e.g,e.b),color2:_(this.lineLength,e.r,e.g,e.b)}),Object.assign(r,{color:_(this.planeLength,e.r,e.g,e.b)}),Object.assign(i,{color:_(this.sectorLength,e.r,e.g,e.b)})),this.lineBuffer.setAttributes(t),this.planeBuffer.setAttributes(r),this.sectorBuffer.setAttributes(i)}setParameters(e){return super.setParameters(e,{},!1),!e||void 0===e.lineVisible&&void 0===e.sectorVisible&&void 0===e.planeVisible||this.setVisibility(this.visible),e&&e.lineOpacity&&this.lineBuffer.setParameters({opacity:e.lineOpacity}),e&&void 0!==e.opacity&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.lineBuffer.setParameters({linewidth:e.linewidth}),this}setVisibility(e,t){return super.setVisibility(e,!0),this.lineBuffer&&this.lineBuffer.setVisibility(this.lineVisible&&this.visible),this.planeBuffer&&this.planeBuffer.setVisibility(this.planeVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),t||this.viewer.requestRender(),this}}mc.add("dihedral",Rv);function Dv(e,t){function r(e,t){return t in e}var i,n=Object.assign({},e);for(i in n)r(n,i)&&r(t,i)&&(n[i]=ce(t[i],n[i]));return n}function Lv(e,t){var e=new ze(e),r=new Float32Array(3*t);return _(t,e.r,e.g,e.b,r),r}class Ov extends G0{constructor(e,t,r){super(e,t,r),this.type="dihedral-histogram",this.parameters=Object.assign({histogramsData:{type:"hidden",rebuild:!0},histogramBinBorderVisible:{type:"boolean",default:!0},scaleBinToSectorArea:{type:"boolean",rebuild:!0,default:!1}},this.parameters),this.init(r)}init(e){e=e||{};let r=Dv({histogramBinBorderColor:"grey",adjacentBondArrowColor:"black",distantBondArrowColor:"magenta",frontHistogramColor:"green",backHistogramColor:"blue",opaqueMiddleDiscColor:"white"},e);Object.assign(this,r);var t=Dv({histogramsData:[],histogramOpacity:1,opaqueMiddleDiscVisible:!0,opaqueMiddleDiscOpacity:1,histogramBinBorderVisible:!0,histogramBinBorderWidth:1,histogramBinBorderOpacity:.5,bondArrowVisible:!0,bondArrowWidth:2,bondArrowOpacity:1,scaleBinToSectorArea:!1},e);Object.assign(this,t),this.histogramsData.forEach(e=>{var t=Dv(r,e);Object.assign(e,t)}),e.side=ce(e.side,"double"),e.opacity=ce(e.opacity,.5),e.radiusType=ce(e.radiusType,"size"),e.radiusSize=ce(e.radiusSize,.15),super.init(e)}getHistogramBinBorderBufferParameters(){return this.getBufferParams({linewidth:this.histogramBinBorderWidth,visible:this.histogramBinBorderVisible,opacity:this.histogramBinBorderOpacity})}getBondArrowsBufferParameters(){return this.getBufferParams({linewidth:this.bondArrowWidth,visible:this.bondArrowVisible,opacity:this.bondArrowOpacity})}getOpaqueMiddleDiscBufferParameters(){return this.getBufferParams({visible:this.opaqueMiddleDiscVisible,opacity:this.opaqueMiddleDiscOpacity})}getHistogramBufferParameters(){return this.getBufferParams({visible:!0,opacity:this.histogramOpacity,side:"double"})}createData(r){if(r.atomCount&&this.histogramsData.length){this.histogramsData.forEach(e=>e.atomPositions=$0(r,[e.atomQuad]));let t=this.scaleBinToSectorArea?function(e){return Math.sqrt(e)}:function(e){return e};this.histogramsData.forEach(e=>e.histogram360Scaled=e.histogram360.map(t));var i=[];for(let t=0;t<this.histogramsData.length;t++){let e=void 0;var n=this.histogramsData[t],a=n.histogram360;void 0!==(e=3<=a.length?(e=>{let t=e.atomPositions,f=e.histogram360Scaled,r=f.length<=180?360:2*f.length,i={triangles:new Float32Array(3*r*3),triangleColors:Lv(e.opaqueMiddleDiscColor,3*r)},n={triangles:new Float32Array(3*f.length*3),triangleColors:Lv(e.frontHistogramColor,3*f.length)},a={triangles:new Float32Array(3*f.length*3),triangleColors:Lv(e.backHistogramColor,3*f.length)},s={startPoints:new Float32Array(3*f.length),endPoints:new Float32Array(3*f.length),startColors:Lv(e.histogramBinBorderColor,f.length),endColors:Lv(e.histogramBinBorderColor,f.length)},o={startPoints:new Float32Array(3*f.length),endPoints:new Float32Array(3*f.length),startColors:Lv(e.histogramBinBorderColor,f.length),endColors:Lv(e.histogramBinBorderColor,f.length)},g={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:Lv(e.adjacentBondArrowColor,f.length),endColors:Lv(e.adjacentBondArrowColor,f.length)},v={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:Lv(e.distantBondArrowColor,f.length),endColors:Lv(e.distantBondArrowColor,f.length)},l=Q(),h=Q(),c=Q(),u=Q(),d=Q(),_=Q(),y=Q(),m=Q(),b=Q(),x=Q(),S=Q(),w=Q(),A=Q(),M=Q(),C=Q(),T=Q(),p=[l,h,c,u];for(let e=0;e<p.length;e++)yd(p[e],t,3*e);if(vd(d,l,h),vd(_,c,h),vd(m,u,c),0!==xd(_)&&(ue(C,_,.5),_d(b,h,C),wd(d,d),wd(_,_),wd(m,m),Ed(y,_),ue(C,y,gd(y,d)),vd(x,d,C),ue(C,_,gd(_,m)),vd(S,m,C),0!==xd(x))&&0!==xd(S)){wd(x,x),wd(S,S);e=Math.acos(gd(x,S));fd(w,y,x),fd(A,_,S),wd(w,w),wd(A,A);let d=e,m=(gd(w,S)<0&&(d=-e),_d(M,b,x),Math.max.apply(null,f)),p=2*Math.PI/f.length;var E=2*Math.PI/r;for(let e=0;e<r;e++){var P=3*e*3;J(b,i.triangles,P),j0(M,b,x,w,e*E),J(M,i.triangles,3+P),j0(M,b,x,w,(e+1)*E),J(M,i.triangles,6+P)}return ue(C,_,-.01),_d(b,b,C),I(n,s,0,x,w),ue(C,_,.02),_d(b,b,C),I(a,o,1,S,A),{opaqueMiddleDisc:i,frontHistogram:n,backHistogram:a,frontHistogramBinBorders:s,backHistogramBinBorders:o,adjacentBondArrows:g,distantBondArrows:v};function I(t,r,e,i,n){Zc(b,g.startPoints,0,3*e,b.length),j0(C,b,i,n,0+0*p),Zc(C,g.endPoints,0,3*e,b.length),Zc(b,v.startPoints,0,3*e,b.length),j0(C,b,i,n,d),Zc(C,v.endPoints,0,3*e,b.length);for(let e=0;e<f.length;e++)Zc(b,r.startPoints,0,3*e,b.length),j0(C,b,i,n,0+p*e),Zc(C,r.endPoints,0,3*e,C.length);for(let e=0;e<f.length;e++)a=t.triangles,s=e,o=i,l=n,h=p,u=c=void 0,c=3*s*3,J(b,a,c),u=Number(f[s])/m,ue(C,o,u),ue(T,l,u),j0(M,b,C,T,s*h),J(M,a,3+c),j0(M,b,C,T,(s+1)*h),J(M,a,6+c);var a,s,o,l,h,c,u}}})(n):e)&&i.push(e)}return this.frontHistogramBinBordersBuffer=e(i.map(e=>e.frontHistogramBinBorders),this.getHistogramBinBorderBufferParameters()),this.backHistogramBinBordersBuffer=e(i.map(e=>e.backHistogramBinBorders),this.getHistogramBinBorderBufferParameters()),this.adjacentBondArrowsBuffer=e(i.map(e=>e.adjacentBondArrows),this.getBondArrowsBufferParameters()),this.distantBondArrowsBuffer=e(i.map(e=>e.distantBondArrows),this.getBondArrowsBufferParameters()),this.opaqueMiddleDiscBuffer=o(i.map(e=>e.opaqueMiddleDisc),this.getOpaqueMiddleDiscBufferParameters()),this.frontHistogramBuffer=o(i.map(e=>e.frontHistogram),this.getHistogramBufferParameters()),this.backHistogramBuffer=o(i.map(e=>e.backHistogram),this.getHistogramBufferParameters()),{bufferList:[].concat(this.frontHistogramBinBordersBuffer,this.backHistogramBinBordersBuffer,this.adjacentBondArrowsBuffer,this.distantBondArrowsBuffer,this.opaqueMiddleDiscBuffer,this.frontHistogramBuffer,this.backHistogramBuffer)};function s(t){var e=t.map(e=>e.length),r=new Float32Array(tu(e));let i=0;for(let e=0;e<t.length;e++)r.set(t[e],i),i+=t[e].length;return r}function e(e,t){return new iv({position1:s(e.map(e=>e.startPoints)),position2:s(e.map(e=>e.endPoints)),color:s(e.map(e=>e.startColors)),color2:s(e.map(e=>e.endColors))},t)}function o(e,t){return new _f({position:s(e.map(e=>e.triangles)),color:s(e.map(e=>e.triangleColors))},t)}}}setParameters(e){return super.setParameters(e,{},!1),e&&void 0!==e.histogramBinBorderVisible&&this.setVisibility(this.visible),this}setVisibility(e,t){return super.setVisibility(e,!0),this.frontHistogramBinBordersBuffer&&this.frontHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),this.backHistogramBinBordersBuffer&&this.backHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),t||this.viewer.requestRender(),this}}mc.add("dihedral-histogram",Ov);class kv extends H0{constructor(e,t,r){super(e,t,r),this.type="distance",this.parameters=Object.assign({radialSegments:!0,openEnded:!0,disableImpostor:!0,labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},useCylinder:{type:"boolean",rebuild:!0},atomPair:{type:"hidden",rebuild:!0}},this.parameters),this.init(r)}init(e){e=e||{};e.linewidth=ce(e.linewidth,5),e.radiusType=ce(e.radiusType,"size"),e.radiusSize=ce(e.radiusSize,.2),this.labelUnit=ce(e.labelUnit,""),this.useCylinder=ce(e.useCylinder,!1),this.atomPair=ce(e.atomPair,[]),super.init(e)}getDistanceData(n,e){var t=e.length;let a=new Array(t),s=new Float32Array(3*t),o=new qh,l=new qh,h=new Xf,c=n.getAtomProxy(),u=n.getAtomProxy(),d=0,m=n.getAtomSet();e.forEach((e,t)=>{var r=e[0],e=e[1];if("number"==typeof r&&Number.isInteger(r)&&"number"==typeof e&&Number.isInteger(e)){if(!m.get(r)||!m.get(e))return void(d+=1);c.index=r,u.index=e}else{o.setString(r),l.setString(e);r=n.getAtomIndices(o),e=n.getAtomIndices(l);if(!r.length||!e.length)return void(d+=1);c.index=r[0],u.index=e[0]}h.addBond(c,u,1),t-=d;var i=c.distanceTo(u);switch(this.labelUnit){case"angstrom":a[t]=i.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":a[t]=(i/10).toFixed(2)+" nm";break;default:a[t]=i.toFixed(2)}r=3*t;s[0+r]=(c.x+u.x)/2,s[1+r]=(c.y+u.y)/2,s[2+r]=(c.z+u.z)/2}),0<d&&(t-=d,s=s.subarray(0,3*t));e=new Kd(h.count,!0);return{text:a,position:s,bondSet:e,bondStore:h}}getBondData(e,t,r){e=e.getBondData(this.getBondParams(t,r));return e.picking&&(e.picking=new Sp(e.picking.array,e.picking.structure,r.bondStore)),e}createData(e){var t,r,i;if(e.atomCount&&this.atomPair.length)return r=this.atomPair.length,i=new ze(this.labelColor),t=this.getDistanceData(e,this.atomPair),this.textBuffer=new ev({position:t.position,size:qc(r,this.labelSize),color:_(r,i.r,i.g,i.b),text:t.text},this.getLabelBufferParams()),r={bondSet:t.bondSet,bondStore:t.bondStore},i=this.getBondData(e,{position:!0,color:!0,picking:!0,radius:this.useCylinder},r),this.useCylinder?this.distanceBuffer=new _v(i,this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})):this.distanceBuffer=new iv(Id(i),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),{bondSet:t.bondSet,bondStore:t.bondStore,position:t.position,bufferList:[this.textBuffer,this.distanceBuffer]}}updateData(e,t){super.updateData(e,t);var r={bondSet:t.bondSet,bondStore:t.bondStore},t=this.getBondData(t.sview,e,r),r={};e&&!e.color||Object.assign(r,{color:t.color,color2:t.color2}),e&&!e.radius||Object.assign(r,{radius:t.radius}),this.distanceBuffer.setAttributes(r)}setParameters(e){return super.setParameters(e,{},!1),this.useCylinder||(e&&e.lineOpacity&&this.distanceBuffer.setParameters({opacity:e.lineOpacity}),e&&void 0!==e.opacity&&this.distanceBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.distanceBuffer.setParameters({linewidth:e.linewidth})),this}}function Nv(e){return 2*(e.position.length/3)*3}mc.add("distance",kv);let Fv=Object.assign({scale:1,color:"grey"},ff);class Bv extends vf{constructor(e,t={}){super({position:new Float32Array(Nv(e)),color:new Float32Array(Nv(e))},t),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag";var t=new ze(this.parameters.color),r=this.geometry.attributes;_(Nv(e)/3,t.r,t.g,t.b,r.color.array),this.setAttributes(e)}get defaultParameters(){return Fv}setAttributes(e={}){var t=this.geometry.attributes;let r,i,n;e.position&&e.vector&&(r=e.position,i=e.vector,n=t.position.array,t.position.needsUpdate=!0);var a=this.size/2,s=this.parameters.scale;if(r&&i)for(let e=0;e<a;e++){var o=2*e*3,l=3*e;n[0+o]=r[0+l],n[1+o]=r[1+l],n[2+o]=r[2+l],n[3+o]=r[0+l]+i[0+l]*s,n[4+o]=r[1+l]+i[1+l]*s,n[5+o]=r[2+l]+i[2+l]*s}}}class Uv extends G0{constructor(e,t,r){super(e,t,r),this.type="helixorient",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"sstruc"),e.radiusType=ce(e.radiusType,"size"),e.radiusSize=ce(e.radiusSize,.15),e.radiusScale=ce(e.radiusScale,1),e.useInteriorColor=ce(e.useInteriorColor,!0),super.init(e)}createData(e){let n=[],a=[];return this.structure.eachPolymer(e=>{var t,r,i;e.residueCount<4||(a.push(e),t=(e=new Jf(e)).getPosition(),r=e.getColor(this.getColorParams()),i=e.getSize(this.getRadiusParams()),e=e.getPicking(),n.push(new m1({position:t.center,color:r.color,radius:i.size,picking:e.picking},this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),new Bv({position:t.center,vector:t.axis},this.getBufferParams({color:"skyblue",scale:1})),new Bv({position:t.center,vector:t.resdir},this.getBufferParams({color:"lightgreen",scale:1}))))},e.getSelection()),{bufferList:n,polymerList:a}}updateData(r,i){Je.Debug&&rt.time(this.type+" repr update"),r=r||{};for(let e=0,t=i.polymerList.length;e<t;++e){var n=3*e,a={},s=i.polymerList[e],s=new Jf(s);r.position&&(s=s.getPosition(),Object.assign(a,{position:s.center}),i.bufferList[1+n].setAttributes({position:s.center,vector:s.axis}),i.bufferList[2+n].setAttributes({position:s.center,vector:s.resdir})),i.bufferList[n].setAttributes(a)}Je.Debug&&rt.timeEnd(this.type+" repr update")}}mc.add("helixorient",Uv);class zv extends bv{constructor(e,t,r){super(e,t,r),this.type="licorice",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){e=e||{};e.aspectRatio=1,super.init(e)}}mc.add("licorice",zv),s.add("shader/HyperballStickImpostor.vert","// Copyright (C) 2010-2011 by\r\n// Laboratoire de Biochimie Theorique (CNRS),\r\n// Laboratoire d'Informatique Fondamentale d'Orleans (Universite d'Orleans), (INRIA) and\r\n// Departement des Sciences de la Simulation et de l'Information (CEA).\r\n//\r\n// License: CeCILL-C license (http://www.cecill.info/)\r\n//\r\n// Contact: Marc Baaden\r\n// E-mail: baaden@smplinux.de\r\n// Webpage: http://hyperballs.sourceforge.net\r\n\r\n// Contributions by Alexander Rose\r\n// - ported to WebGL\r\n// - dual color\r\n// - picking color\r\n\r\nattribute vec3 mapping;\r\nattribute float radius;\r\nattribute float radius2;\r\nattribute vec3 position1;\r\nattribute vec3 position2;\r\n\r\nvarying mat4 matrix_near;\r\nvarying vec4 prime1;\r\nvarying vec4 prime2;\r\nvarying float vRadius;\r\nvarying float vRadius2;\r\n\r\n#ifdef PICKING\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#else\r\n// attribute vec3 color;\r\nattribute vec3 color2;\r\nvarying vec3 vColor1;\r\nvarying vec3 vColor2;\r\n#endif\r\n\r\nuniform float shrink;\r\nuniform mat4 modelViewProjectionMatrix;\r\nuniform mat4 modelViewProjectionMatrixInverse;\r\n\r\nvoid main(){\r\n\r\nvRadius = radius;\r\nvRadius2 = radius2;\r\n\r\nvec4 spaceposition;\r\nvec3 position_atom1;\r\nvec3 position_atom2;\r\nvec4 vertex_position;\r\n\r\n#ifdef PICKING\r\nvPickingColor = unpackColor( primitiveId );\r\n#else\r\nvColor1 = color;\r\nvColor2 = color2;\r\n#endif\r\n\r\nfloat radius1 = radius;\r\n\r\nposition_atom1 = position1;\r\nposition_atom2 = position2;\r\n\r\nfloat distance = distance( position_atom1, position_atom2 );\r\n\r\nspaceposition.z = mapping.z * distance;\r\n\r\nif (radius1 > radius2) {\r\nspaceposition.y = mapping.y * 1.5 * radius1;\r\nspaceposition.x = mapping.x * 1.5 * radius1;\r\n} else {\r\nspaceposition.y = mapping.y * 1.5 * radius2;\r\nspaceposition.x = mapping.x * 1.5 * radius2;\r\n}\r\nspaceposition.w = 1.0;\r\n\r\nvec4 e3 = vec4( 1.0 );\r\nvec3 e1, e1_temp, e2, e2_temp;\r\n\r\n// Calculation of bond direction: e3\r\ne3.xyz = normalize(position_atom1-position_atom2);\r\n\r\n// little hack to avoid some problems of precision due to graphic card limitation using float: To improve soon\r\nif (e3.z == 0.0) { e3.z = 0.0000000000001;}\r\nif ( (position_atom1.x - position_atom2.x) == 0.0) { position_atom1.x += 0.001;}\r\nif ( (position_atom1.y - position_atom2.y) == 0.0) { position_atom1.y += 0.001;}\r\nif ( (position_atom1.z - position_atom2.z) == 0.0) { position_atom1.z += 0.001;}\r\n\r\n// Focus calculation\r\nvec4 focus = vec4( 1.0 );\r\nfocus.x = ( position_atom1.x*position_atom1.x - position_atom2.x*position_atom2.x +\r\n( radius2*radius2 - radius1*radius1 )*e3.x*e3.x/shrink )/(2.0*(position_atom1.x - position_atom2.x));\r\nfocus.y = ( position_atom1.y*position_atom1.y - position_atom2.y*position_atom2.y +\r\n( radius2*radius2 - radius1*radius1 )*e3.y*e3.y/shrink )/(2.0*(position_atom1.y - position_atom2.y));\r\nfocus.z = ( position_atom1.z*position_atom1.z - position_atom2.z*position_atom2.z +\r\n( radius2*radius2 - radius1*radius1 )*e3.z*e3.z/shrink )/(2.0*(position_atom1.z - position_atom2.z));\r\n\r\n// e1 calculation\r\ne1.x = 1.0;\r\ne1.y = 1.0;\r\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\r\ne1_temp = e1 - focus.xyz;\r\ne1 = normalize(e1_temp);\r\n\r\n// e2 calculation\r\ne2_temp = e1.yzx * e3.zxy - e1.zxy * e3.yzx;\r\ne2 = normalize(e2_temp);\r\n\r\n//ROTATION:\r\n// final form of change of basis matrix:\r\nmat3 R= mat3( e1.xyz, e2.xyz, e3.xyz );\r\n// Apply rotation and translation to the bond primitive\r\nvertex_position.xyz = R * spaceposition.xyz;\r\nvertex_position.w = 1.0;\r\n\r\n// TRANSLATION:\r\nvertex_position.x += (position_atom1.x+position_atom2.x) / 2.0;\r\nvertex_position.y += (position_atom1.y+position_atom2.y) / 2.0;\r\nvertex_position.z += (position_atom1.z+position_atom2.z) / 2.0;\r\n\r\n// New position\r\ngl_Position = modelViewProjectionMatrix * vertex_position;\r\n\r\nvec4 i_near, i_far;\r\n\r\n// Calculate near from position\r\nvec4 near = gl_Position;\r\nnear.z = 0.0 ;\r\nnear = modelViewProjectionMatrixInverse * near;\r\ni_near = near;\r\n\r\n// Calculate far from position\r\nvec4 far = gl_Position;\r\nfar.z = far.w ;\r\ni_far = modelViewProjectionMatrixInverse * far;\r\n\r\nprime1 = vec4( position_atom1 - (position_atom1 - focus.xyz)*shrink, 1.0 );\r\nprime2 = vec4( position_atom2 - (position_atom2 - focus.xyz)*shrink, 1.0 );\r\n\r\nfloat Rsquare = (radius1*radius1/shrink) - (\r\n(position_atom1.x - focus.x)*(position_atom1.x - focus.x) +\r\n(position_atom1.y - focus.y)*(position_atom1.y - focus.y) +\r\n(position_atom1.z - focus.z)*(position_atom1.z - focus.z)\r\n);\r\n\r\nfocus.w = Rsquare;\r\n\r\nmatrix_near = mat4( i_near, i_far, focus, e3 );\r\n\r\n// avoid clipping\r\ngl_Position.z = 1.0;\r\n\r\n}"),s.add("shader/HyperballStickImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float shrink;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrixInverseTranspose;\nuniform mat4 projectionMatrix;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat calcClip( vec4 cameraPos ){\nreturn dot( cameraPos, vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nfloat calcClip( vec3 cameraPos ){\nreturn calcClip( vec4( cameraPos, 1.0 ) );\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nstruct Ray {\nvec3 origin ;\nvec3 direction ;\n};\nbool cutoff_plane (vec3 M, vec3 cutoff, vec3 x3){\nfloat a = x3.x;\nfloat b = x3.y;\nfloat c = x3.z;\nfloat d = -x3.x*cutoff.x-x3.y*cutoff.y-x3.z*cutoff.z;\nfloat l = a*M.x+b*M.y+c*M.z+d;\nif (l<0.0) {return true;}\nelse{return false;}\n}\nvec3 isect_surf(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t1 =(-b-sqrt(delta))/a;\nreturn r.origin+t1*r.direction;\n}\nvec3 isect_surf2(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t2 =(-b+sqrt(delta))/a;\nreturn r.origin+t2*r.direction;\n}\nRay primary_ray(vec4 near1, vec4 far1){\nvec3 near=near1.xyz/near1.w;\nvec3 far=far1.xyz/far1.w;\nreturn Ray(near,far-near);\n}\nfloat update_z_buffer(vec3 M, mat4 ModelViewP){\nfloat depth1;\nvec4 Ms=(ModelViewP*vec4(M,1.0));\nreturn depth1=(1.0+Ms.z/Ms.w)/2.0;\n}\nvoid main(){\nfloat radius = max( vRadius, vRadius2 );\nvec4 i_near, i_far, focus;\nvec3 e3, e1, e1_temp, e2;\ni_near = vec4(matrix_near[0][0],matrix_near[0][1],matrix_near[0][2],matrix_near[0][3]);\ni_far = vec4(matrix_near[1][0],matrix_near[1][1],matrix_near[1][2],matrix_near[1][3]);\nfocus = vec4(matrix_near[2][0],matrix_near[2][1],matrix_near[2][2],matrix_near[2][3]);\ne3 = vec3(matrix_near[3][0],matrix_near[3][1],matrix_near[3][2]);\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2 = normalize(cross(e1,e3));\nvec4 equation = focus;\nfloat shrinkfactor = shrink;\nfloat t1 = -1.0/(1.0-shrinkfactor);\nfloat t2 = 1.0/(shrinkfactor);\nvec4 colonne1, colonne2, colonne3, colonne4;\nmat4 mat;\nvec3 equation1 = vec3(t2,t2,t1);\nfloat A1 = - e1.x*equation.x - e1.y*equation.y - e1.z*equation.z;\nfloat A2 = - e2.x*equation.x - e2.y*equation.y - e2.z*equation.z;\nfloat A3 = - e3.x*equation.x - e3.y*equation.y - e3.z*equation.z;\nfloat A11 = equation1.x*e1.x*e1.x + equation1.y*e2.x*e2.x + equation1.z*e3.x*e3.x;\nfloat A21 = equation1.x*e1.x*e1.y + equation1.y*e2.x*e2.y + equation1.z*e3.x*e3.y;\nfloat A31 = equation1.x*e1.x*e1.z + equation1.y*e2.x*e2.z + equation1.z*e3.x*e3.z;\nfloat A41 = equation1.x*e1.x*A1 + equation1.y*e2.x*A2 + equation1.z*e3.x*A3;\nfloat A22 = equation1.x*e1.y*e1.y + equation1.y*e2.y*e2.y + equation1.z*e3.y*e3.y;\nfloat A32 = equation1.x*e1.y*e1.z + equation1.y*e2.y*e2.z + equation1.z*e3.y*e3.z;\nfloat A42 = equation1.x*e1.y*A1 + equation1.y*e2.y*A2 + equation1.z*e3.y*A3;\nfloat A33 = equation1.x*e1.z*e1.z + equation1.y*e2.z*e2.z + equation1.z*e3.z*e3.z;\nfloat A43 = equation1.x*e1.z*A1 + equation1.y*e2.z*A2 + equation1.z*e3.z*A3;\nfloat A44 = equation1.x*A1*A1 + equation1.y*A2*A2 + equation1.z*A3*A3 - equation.w;\ncolonne1 = vec4(A11,A21,A31,A41);\ncolonne2 = vec4(A21,A22,A32,A42);\ncolonne3 = vec4(A31,A32,A33,A43);\ncolonne4 = vec4(A41,A42,A43,A44);\nmat = mat4(colonne1,colonne2,colonne3,colonne4);\nRay ray = primary_ray(i_near,i_far) ;\nvec3 M;\nM = isect_surf(ray, mat);\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nvec4 M1 = vec4(M,1.0);\nvec4 M2 = mat*M1;\nvec3 _normal = ( modelViewMatrixInverseTranspose * M2 ).xyz;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\n#ifdef NEAR_CLIP\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 ){\nM = isect_surf2(ray, mat);\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / radius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix);\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#endif\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\nfloat distance_ratio = ((M.x-prime2.x)*e3.x + (M.y-prime2.y)*e3.y +(M.z-prime2.z)*e3.z) /\ndistance(prime2.xyz,prime1.xyz);\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -( modelViewMatrix * vec4( M, 1.0 ) ).xyz;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distance_ratio>0.5 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nvec3 nonPerturbedNormal = normal;\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include colorspace_fragment\n#include fog_fragment\n#endif\n}");let Vv=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]),Gv=new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]);class Hv extends l1{constructor(e,t={}){super("v3",e,t)}get mapping(){return Vv}get mappingIndices(){return Gv}get mappingIndicesSize(){return 36}get mappingSize(){return 8}get mappingItemSize(){return 3}}let $v=Object.assign({shrink:.14},ff),jv=Object.assign({shrink:{uniform:!0}},gf);class Wv extends Hv{constructor(e,t={}){super(e,t),this.parameterTypes=jv,this.isImpostor=!0,this.vertexShader="HyperballStickImpostor.vert",this.fragmentShader="HyperballStickImpostor.frag",this.addUniforms({modelViewProjectionMatrix:{value:new tt},modelViewProjectionMatrixInverse:{value:new tt},modelViewMatrixInverseTranspose:{value:new tt},shrink:{value:this.parameters.shrink}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return $v}}Object.assign({disableImpostor:!1},hv,$v);class qv{constructor(e,t={}){return new(!oc||t&&t.disableImpostor?(e.radius=((t,r)=>{var i=t.length,n=new Float32Array(i);for(let e=0;e<i;e++)n[e]=Math.min(t[e],r[e]);return n})(e.radius,e.radius2),uv):Wv)(e,t)}}let Xv=qv;class Yv extends zv{constructor(e,t,r){super(e,t,r),this.type="hyperball",this.parameters=Object.assign({shrink:{type:"number",precision:3,max:1,min:.001,buffer:!0}},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){e=e||{};e.radiusScale=ce(e.radiusScale,.2),e.radiusType=ce(e.radiusType,"vdw"),e.useInteriorColor=ce(e.useInteriorColor,!0),this.shrink=ce(e.shrink,.12),super.init(e)}getBondParams(e,t){return e&&!e.radius||(t=Object.assign({radius2:!0},t)),super.getBondParams(e,t)}createData(e){var t=new m1(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));return this.__center=new Float32Array(3*e.bondCount),{bufferList:[t,new Xv(e.getBondData(this.getBondParams()),this.getBufferParams({shrink:this.shrink,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))]}}updateData(e,t){var r,i,n=t.sview.getAtomData(this.getAtomParams()),a=t.sview.getBondData(this.getBondParams()),s={},o={};e&&!e.position||(Object.assign(s,{position:n.position}),r=a.position1,i=a.position2,Object.assign(o,{position:jc(r,i,this.__center),position1:r,position2:i})),e&&!e.color||(Object.assign(s,{color:n.color}),Object.assign(o,{color:a.color,color2:a.color2})),e&&!e.radius||(Object.assign(s,{radius:n.radius}),Object.assign(o,{radius:a.radius,radius2:a.radius2})),t.bufferList[0].setAttributes(s),t.bufferList[1].setAttributes(o)}}mc.add("hyperball",Yv);var Kv,Zv,Qv,Jv,e_,t_,r_,i_,n_;class a_{constructor(e,t={},r=""){this.type=e,this.text=t,this.format=r,this.errorLogged=!1}atomLabel(e){let t;switch(this.type){case"atomname":t=e.atomname;break;case"atomindex":t=""+e.index;break;case"occupancy":t=e.occupancy.toFixed(2);break;case"bfactor":t=e.bfactor.toFixed(2);break;case"serial":t=""+e.serial;break;case"element":t=e.element;break;case"atom":t=e.atomname+"|"+e.index;break;case"resname":t=e.resname;break;case"resno":t=""+e.resno;break;case"res":t=""+(vm[e.resname.toUpperCase()]||e.resname)+e.resno;break;case"residue":var r=vm[e.resname.toUpperCase()];t=r&&!e.inscode?""+r+e.resno:`[${e.resname}]`+e.resno+e.inscode;break;case"text":t=this.text[e.index];break;case"format":try{t=Ec.sprintf(this.format,e)}catch(e){this.errorLogged||(this.errorLogged=!0,console.log(e.message))}break;default:t=e.qualifiedName()}return void 0===t?"":t}}a_.types={"":"",atomname:"atom name",atomindex:"atom index",occupancy:"occupancy",bfactor:"b-factor",serial:"serial",element:"element",atom:"atom name + index",resname:"residue name",resno:"residue no",res:"one letter code + no",residue:"[residue name] + no + inscode",text:"text",format:"format",qualified:"qualified name"};class s_ extends G0{constructor(e,t,r){super(e,t,r),this.type="label",this.parameters=Object.assign({labelType:{type:"select",options:a_.types,rebuild:!0},labelText:{type:"hidden",rebuild:!0},labelFormat:{type:"text",rebuild:!0},labelGrouping:{type:"select",options:{atom:"atom",residue:"residue"},rebuild:!0},fontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:!0},fontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:!0},fontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:!0},xOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},yOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},zOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},attachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},showBorder:{type:"boolean",buffer:!0},borderColor:{type:"color",buffer:!0},borderWidth:{type:"number",precision:2,max:.3,min:0,buffer:!0},showBackground:{type:"boolean",rebuild:!0},backgroundColor:{type:"color",buffer:!0},backgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},backgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:!0},fixedSize:{type:"boolean",buffer:!0}},this.parameters,{side:null,flatShaded:null,wireframe:null,linewidth:null,roughness:null,metalness:null,diffuse:null}),this.init(r)}init(e){e=e||{};this.labelType=ce(e.labelType,"res"),this.labelText=ce(e.labelText,{}),this.labelFormat=ce(e.labelFormat,""),this.labelGrouping=ce(e.labelGrouping,"atom"),this.fontFamily=ce(e.fontFamily,"sans-serif"),this.fontStyle=ce(e.fontStyle,"normal"),this.fontWeight=ce(e.fontWeight,"bold"),this.xOffset=ce(e.xOffset,0),this.yOffset=ce(e.yOffset,0),this.zOffset=ce(e.zOffset,.5),this.attachment=ce(e.attachment,"bottom-left"),this.showBorder=ce(e.showBorder,!1),this.borderColor=ce(e.borderColor,"lightgrey"),this.borderWidth=ce(e.borderWidth,.15),this.showBackground=ce(e.showBackground,!1),this.backgroundColor=ce(e.backgroundColor,"lightgrey"),this.backgroundMargin=ce(e.backgroundMargin,.5),this.backgroundOpacity=ce(e.backgroundOpacity,1),this.fixedSize=ce(e.fixedSize,!1),super.init(e)}getTextData(e,s){var t=this.getAtomParams(s);let o=new a_(this.labelType,this.labelText,this.labelFormat),l,h,c,u,d,m,p;if("atom"===this.labelGrouping){var r=e.getAtomData(t);l=r.position,h=r.radius,c=r.color,s&&!s.text||(u=[],e.eachAtom(e=>u.push(o.atomLabel(e))))}else if("residue"===this.labelGrouping){s&&!s.position||(d=[]),s&&!s.color||(p=[]),s&&!s.radius||(m=[]),s&&!s.text||(u=[]),t.colorParams&&(t.colorParams.structure=e.getStructure());let r=k.getScheme(t.colorParams),i=new Gf(t.radiusParams),n=e.getAtomProxy(),a=0;e.eachResidue(e=>{var t=3*a;e.isProtein()||e.isNucleic()?(n.index=e.traceAtomIndex,s&&!s.position||n.positionToArray(d,t)):(n.index=e.atomOffset,s&&!s.position||e.positionToArray(d,t)),s&&!s.color||r.atomColorToArray(n,p,t),s&&!s.radius||(m[a]=i.atomRadius(n)),s&&!s.text||u.push(o.atomLabel(n)),++a}),s&&!s.position||(l=new Float32Array(d)),s&&!s.color||(c=new Float32Array(p)),s&&!s.radius||(h=new Float32Array(m))}return{position:l,size:h,color:c,text:u}}createData(e){return{bufferList:[new ev(this.getTextData(e,{position:!0,color:!0,radius:!0,text:!0}),this.getBufferParams({fontFamily:this.fontFamily,fontStyle:this.fontStyle,fontWeight:this.fontWeight,xOffset:this.xOffset,yOffset:this.yOffset,zOffset:this.zOffset,attachment:this.attachment,showBorder:this.showBorder,borderColor:this.borderColor,borderWidth:this.borderWidth,showBackground:this.showBackground,backgroundColor:this.backgroundColor,backgroundMargin:this.backgroundMargin,backgroundOpacity:this.backgroundOpacity,fixedSize:this.fixedSize}))]}}updateData(e,t){t.bufferList[0].setAttributes(this.getTextData(t.sview,e))}getAtomRadius(){return 0}}mc.add("label",s_);class o_ extends G0{constructor(e,t,r){super(e,t,r),this.type="line",this.parameters=Object.assign({multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0},lines:{type:"boolean",rebuild:!0},crosses:{type:"select",rebuild:!0,options:{off:"off",lone:"lone",all:"all"}},crossSize:{type:"number",precision:2,max:2,min:.1}},this.parameters,{flatShaded:null,side:null,wireframe:null,roughness:null,metalness:null}),this.init(r)}init(e){e=e||{};this.multipleBond=ce(e.multipleBond,"off"),this.bondSpacing=ce(e.bondSpacing,1),this.linewidth=ce(e.linewidth,2),this.lines=ce(e.lines,!0),this.crosses=ce(e.crosses,"lone"),this.crossSize=ce(e.crossSize,.4),super.init(e)}getAtomRadius(e){return.1}getBondParams(e,t){return t=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,radiusParams:{type:"size",size:.1,scale:1}},t),super.getBondParams(e,t)}_crossData(o,e){if(!o||o.position||o.color){var l={},e=("lone"===this.crosses&&Object.assign(l,{atomSet:(e=>{let t=e.getAtomSet();var r=e.getBondSet();let i=e.getBondProxy();return r.forEach(function(e){i.index=e,t.clear(i.atomIndex1),t.clear(i.atomIndex2)}),t})(e)}),e.getAtomData(this.getAtomParams(o,l))),l={},h=e.position,c=e.color,u=e.picking,d=(h||c).length,m=3*d;let t=new Float32Array(0),r=new Float32Array(0),i=new Float32Array(0),n=new Float32Array(0),a=0,s=new Float32Array(0);o&&!o.position||(t=l.position1=new Float32Array(m),r=l.position2=new Float32Array(m),a=this.crossSize/2),o&&!o.color||(i=l.color=new Float32Array(m),n=l.color2=new Float32Array(m)),o&&!o.picking||(s=new Float32Array(3*e.picking.array.length));for(let e=0;e<d;e++){var p,f,g,v=3*e,_=3*v;if(o&&!o.position||(p=h[v],f=h[1+v],g=h[2+v],t[_]=p-a,t[1+_]=f,t[2+_]=g,r[_]=p+a,r[1+_]=f,r[2+_]=g,t[3+_]=p,t[4+_]=f-a,t[5+_]=g,r[3+_]=p,r[4+_]=f+a,r[5+_]=g,t[6+_]=p,t[7+_]=f,t[8+_]=g-a,r[6+_]=p,r[7+_]=f,r[8+_]=g+a),!o||o.color){var y=9+_;for(let e=_;e<y;e+=3)i[e]=n[e]=c[v],i[e+1]=n[e+1]=c[1+v],i[e+2]=n[e+2]=c[2+v]}o&&!o.picking||(s[v]=s[1+v]=s[2+v]=u.array[e])}return o&&!o.picking||(l.picking=new gp(s,u.structure)),l}}createData(e){var t,r={position:!0,color:!0,picking:!0},i=[];return this.lines&&(t=e.getBondData(this.getBondParams(r)),t=new iv(t,this.getBufferParams({linewidth:this.linewidth})),i.push(t)),"off"!==this.crosses&&(t=new iv(this._crossData(r,e),this.getBufferParams({linewidth:this.linewidth})),i.push(t)),{bufferList:i}}updateData(e,t){let r=0;var i,n;this.lines&&(i=t.sview.getBondData(this.getBondParams(e)),n={},e&&!e.position||Object.assign(n,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(n,{color:i.color,color2:i.color2}),t.bufferList[r++].setAttributes(n)),"off"!==this.crosses&&(i=this._crossData(e,t.sview),n={},e&&!e.position||Object.assign(n,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(n,{color:i.color,color2:i.color2}),t.bufferList[r++].setAttributes(n))}setParameters(e){var t={};return e&&(e.bondSpacing||e.crossSize)&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}function l_(e,i,n,t,s){let o=new(t=t||Int32Array)(e*i*n*(s=s||1));function l(e,t,r){return((e*i+t)*n+r)*s}return{data:o,index:l,set:function(e,t,r,...i){var n=l(e,t,r);for(let e=0;e<s;++e)o[n+e]=i[e]},toArray:function(e,t,r,i=[],n=0){var a=l(e,t,r);for(let e=0;e<s;++e)i[n+e]=o[a+e]},fromArray:function(e,t,r,i,n=0){var a=l(e,t,r);for(let e=0;e<s;++e)o[a+e]=i[n+e]},copy:function(e){o.set(e.data)}}}function h_(Ne,Fe,Be){var Ue,ze,Ve,Ge,He,$e,je,We,qe,Xe,Ye,Ke,Ze,Qe,Je,et=of(Fe),e=ud(Ne),tt=(0===Ne.length&&(e[0].set([0,0,0]),e[1].set([0,0,0])),e[0]),rt=e[1];var it=1,nt=2,at=4,st=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];function ot(e){var t,r,i,n,a,s,o,l,h;for(h in et)if(a=parseFloat(h),!qe[h]){for(n=(a=e?(a+Ue)*ze+.5:a*ze+.5)*a,s=Math.floor(a)+1,o=new Int32Array(s*s),t=l=0;t<s;++t)for(r=0;r<s;++r)n<(i=t*t+r*r)?o[l]=-1:(i=Math.sqrt(n-i),o[l]=Math.floor(i)),++l;Xe[h]=s,qe[h]=o}}this.getVolume=function(e,t,r,N,F){console.time("EDTSurface.getVolume");var i,n,a,B,U="vws"!==e,z=U;Ue=t||1.4,ze=r||2,Ke=F||!0;var V,G=0;for(V in et)G=Math.max(G,V);t=lf(tt,rt,G,ze,z?Ue:0),Ge=t.dim[0],He=t.dim[1],$e=t.dim[2],je=t.matrix,We=t.tran,ze=t.scaleFactor,qe={},Xe={},ot(z),Ye=Ue*ze,Ve=N||Ue/ze,Ze=new Uint8Array(Ge*He*$e),z&&(Qe=new Float64Array(Ge*He*$e)),Ke&&(Je=new Int32Array(Ge*He*$e));var H=U;for(console.time("EDTSurface fillvoxels"),i=0,n=Ze.length;i<n;++i)Ze[i]=0,H&&(Qe[i]=-1),Ke&&(Je[i]=-1);for(i=0,n=Ne.length/3;i<n;++i){s=void 0;y=void 0;Y=void 0;$=void 0;j=void 0;W=void 0;q=void 0;o=void 0;l=void 0;h=void 0;c=void 0;u=void 0;d=void 0;v=void 0;_=void 0;m=void 0;p=void 0;f=void 0;g=void 0;K=void 0;Z=void 0;Q=void 0;J=void 0;X=void 0;var s=i;var $,j,W,q,o,l,h,c,u,d,m,p,f,g,X,v,_,y=3*s,Y=s,Y=($=Math.floor(.5+ze*(Ne[y]+We[0])),j=Math.floor(.5+ze*(Ne[1+y]+We[1])),W=Math.floor(.5+ze*(Ne[2+y]+We[2])),Fe[Y]),K=qe[Y],Z=0,Q=He*$e,J=Xe[Y];for(c=0;c<J;++c)for(u=0;u<J;++u){if(-1!==(X=K[Z]))for(p=-1;p<2;++p)for(f=-1;f<2;++f)for(g=-1;g<2;++g)if(0!==p&&0!==f&&0!==g)for(o=p*c,h=g*u,d=0;d<=X;++d)_=j+(l=d*f),m=W+h,(v=$+o)<0||_<0||m<0||Ge<=v||He<=_||$e<=m||(v=v*Q+_*$e+m,Ke?Ze[v]&it?Ze[v]&it&&(_=Je[v])!==y&&(m=$+o-Math.floor(.5+ze*(Ne[_]+We[0])),q=j+l-Math.floor(.5+ze*(Ne[_+1]+We[1])),_=W+h-Math.floor(.5+ze*(Ne[_+2]+We[2])),o*o+l*l+h*h<m*m+q*q+_*_)&&(Je[v]=s):(Ze[v]|=it,Je[v]=s):Ze[v]|=it);Z++}}for(i=0,n=Ze.length;i<n;++i)Ze[i]&it&&(Ze[i]|=nt);console.timeEnd("EDTSurface fillvoxels");var b,x,ee,te=He*$e;for(b=0;b<Ge;++b)for(x=0;x<$e;++x)for(ee=0;ee<He;++ee){var re=b*te+ee*$e+x;if(Ze[re]&it)for(var ie=0;ie<26;){var ne=b+st[ie][0],ae=x+st[ie][2],se=ee+st[ie][1];if(-1<ne&&ne<Ge&&-1<se&&se<He&&-1<ae&&ae<$e&&!(Ze[ne*te+se*$e+ae]&it)){Ze[re]|=at;break}ie++}}if("ms"===e||"ses"===e){console.time("EDTSurface fastdistancemap");var S,w,A,oe,M,le=l_(Ge,He,$e,Uint16Array,3),he=He*$e,ce=Ye*Ye,ue=0;for(S=0;S<Ge;++S)for(w=0;w<He;++w)for(A=0;A<$e;++A)Ze[M=S*he+w*$e+A]&=~nt,Ze[M]&it&&Ze[M]&at&&(le.set(S,w,A,S,w,A),Qe[M]=0,Ze[M]|=nt,ue+=1);var C=new Int32Array(3*ue),T=0,E=new Int32Array(3*ue),de=0;for(S=0;S<Ge;++S)for(w=0;w<He;++w)for(A=0;A<$e;++A)Ze[M=S*he+w*$e+A]&at&&(C[T]=S,C[T+1]=w,C[T+2]=A,T+=3,Ze[M]&=~at);do{for(de=((e,t,r,i)=>{var n,a,s,o,l,h,c,u,d,m,p,f,g=new Uint16Array(3),v=0;if(0!==r){var _=-1,y=-1,b=-1,x=He*$e;for(c=0,d=r;c<d;c+=3)for(n=e[c],a=e[c+1],s=e[c+2],t.toArray(n,a,s,g),u=0;u<6;++u)f=st[u],_=n+f[0],y=a+f[1],b=s+f[2],_<Ge&&-1<_&&y<He&&-1<y&&b<$e&&-1<b&&(Ze[p=_*x+$e*y+b]&it&&!(Ze[p]&nt)?(t.fromArray(_,y,b,g),o=_-g[0],l=y-g[1],h=b-g[2],m=o*o+l*l+h*h,Qe[p]=m,Ze[p]|=nt,Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3):Ze[p]&it&&Ze[p]&nt&&(o=_-g[0],l=y-g[1],h=b-g[2],(m=o*o+l*l+h*h)<Qe[p])&&(t.fromArray(_,y,b,g),Qe[p]=m,Ze[p]&at||(Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3)));for(c=0,d=r;c<d;c+=3)for(n=e[c],a=e[c+1],s=e[c+2],t.toArray(n,a,s,g),u=6;u<18;u++)f=st[u],_=n+f[0],y=a+f[1],b=s+f[2],_<Ge&&-1<_&&y<He&&-1<y&&b<$e&&-1<b&&(Ze[p=_*x+$e*y+b]&it&&!(Ze[p]&nt)?(t.fromArray(_,y,b,g),o=_-g[0],l=y-g[1],h=b-g[2],m=o*o+l*l+h*h,Qe[p]=m,Ze[p]|=nt,Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3):Ze[p]&it&&Ze[p]&nt&&(o=_-g[0],l=y-g[1],h=b-g[2],(m=o*o+l*l+h*h)<Qe[p])&&(t.fromArray(_,y,b,g),Qe[p]=m,Ze[p]&at||(Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3)));for(c=0,d=r;c<d;c+=3)for(n=e[c],a=e[c+1],s=e[c+2],t.toArray(n,a,s,g),u=18;u<26;u++)f=st[u],_=n+f[0],y=a+f[1],b=s+f[2],_<Ge&&-1<_&&y<He&&-1<y&&b<$e&&-1<b&&(Ze[p=_*x+$e*y+b]&it&&!(Ze[p]&nt)?(t.fromArray(_,y,b,g),o=_-g[0],l=y-g[1],h=b-g[2],m=o*o+l*l+h*h,Qe[p]=m,Ze[p]|=nt,Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3):Ze[p]&it&&Ze[p]&nt&&(o=_-g[0],l=y-g[1],h=b-g[2],(m=o*o+l*l+h*h)<Qe[p])&&(t.fromArray(_,y,b,g),Qe[p]=m,Ze[p]&at||(Ze[p]|=at,i[v]=_,i[v+1]=y,i[v+2]=b,v+=3)))}return v})(C,le,T,E),S=T=0,oe=de;S<oe;S+=3)M=he*E[S]+$e*E[S+1]+E[S+2],Ze[M]&=~at,Qe[M]<=1.0404*ce&&(C[T]=E[S],C[T+1]=E[S+1],C[T+2]=E[S+2],T+=3)}while(0<T);var me,pe=Ve*Ve,fe=new Uint16Array(3);for(S=0;S<Ge;++S)for(w=0;w<He;++w)for(A=0;A<$e;++A)Ze[M=S*he+w*$e+A]&=~at,Ze[M]&it&&(Ze[M]&nt&&!(Ze[M]&nt&&Qe[M]>=pe)||(Ze[M]|=at,Ke&&Ze[M]&nt&&(le.toArray(S,w,A,fe),me=fe[0]*he+fe[1]*$e+fe[2],Je[M]=Je[me])));console.timeEnd("EDTSurface fastdistancemap")}if("ses"===e){for(ot(!1),a=0,B=Ze.length;a<B;++a)Ze[a]&=~nt;for(a=0,B=Ne.length/3;a<B;++a){ge=void 0;Ee=void 0;Pe=void 0;ve=void 0;_e=void 0;ye=void 0;be=void 0;Ie=void 0;xe=void 0;Se=void 0;we=void 0;L=void 0;O=void 0;P=void 0;Ae=void 0;Me=void 0;Ce=void 0;I=void 0;R=void 0;D=void 0;Te=void 0;Re=void 0;De=void 0;var ge=a;var ve,_e,ye,be,xe,Se,we,P,Ae,Me,Ce,I,R,D,Te,L,O,Ee=3*ge,Pe=ge,Ie=0,Re=(ve=Math.floor(.5+ze*(Ne[Ee]+We[0])),_e=Math.floor(.5+ze*(Ne[1+Ee]+We[1])),ye=Math.floor(.5+ze*(Ne[2+Ee]+We[2])),Fe[Pe]),De=He*$e;for(Ae=0,Te=Xe[Re];Ae<Te;++Ae)for(Me=0;Me<Te;++Me){if(-1!==qe[Re][Ie])for(I=-1;I<2;++I)for(R=-1;R<2;++R)for(D=-1;D<2;++D)if(0!==I&&0!==R&&0!==D)for(xe=I*Ae,we=D*Me,Ce=0;Ce<=qe[Re][Ie];++Ce)O=_e+(Se=Ce*R),P=ye+we,(L=ve+xe)<0||O<0||P<0||Ge<=L||He<=O||$e<=P||(Ze[L=L*De+O*$e+P]&nt?Ke&&(O=Je[L],P=Math.floor(.5+ze*(Ne[O]+We[0])),be=Math.floor(.5+ze*(Ne[O+1]+We[1])),O=Math.floor(.5+ze*(Ne[O+2]+We[2])),xe*xe+Se*Se+we*we<P*P+be*be+O*O)&&(Je[L]=ge):(Ze[L]|=nt,Ke&&(Je[L]=ge)));Ie++}}}var k,r=e,Le=Ze.length;if("vws"===r)for(k=0;k<Le;++k)Ze[k]&=~at,Ze[k]=Ze[k]&nt?1:0;else if("ms"===r)for(k=0;k<Le;++k)Ze[k]&=~nt,Ze[k]&at&&(Ze[k]|=nt),Ze[k]&=~at,Ze[k]=Ze[k]&nt?1:0;else if("ses"===r)for(k=0;k<Le;++k)Ze[k]&at&&Ze[k]&nt?Ze[k]&=~at:Ze[k]&at&&!(Ze[k]&nt)&&(Ze[k]|=nt),Ze[k]=Ze[k]&nt?1:0;else if("sas"===r)for(k=0;k<Le;++k)Ze[k]&=~at,Ze[k]=Ze[k]&nt?1:0;for(var Oe=0,ke=Je.length;Oe<ke;++Oe)Je[Oe]=Be[Je[Oe]];return console.timeEnd("EDTSurface.getVolume"),{data:Ze,nx:$e,ny:He,nz:Ge,atomindex:Je}},this.getSurface=function(e,t,r,i,n,a,s){e=this.getVolume(e,t,r,i,n);return new cf(e.data,e.nx,e.ny,e.nz,e.atomindex).getSurface(1,a,void 0,je,s)}}function c_(E,P,I,R,e,t,r){r=Math.max(.1,r);var i=E.length,D=e[0],L=e[1],O=e[2],e=t[0],n=t[1],t=t[2];function k(e,t){return Math.floor((e-t)/r)}for(var a,s,N=k(e,D)+1,F=k(n,L)+1,B=k(t,O)+1,o=N*F*B,U=F*B,l=[],h=0;h<i;h++){c=E[h],a=P[h],s=I[h];var c=(k(c,D)*F+k(a,L))*B+k(s,O);void 0===l[c]?l[c]=[h]:l[c].push(h)}for(var z=new Uint32Array(o),V=new Uint16Array(o),G=new Uint32Array(i),u=0,d=0,h=0;h<o;h++){var m=z[h]=u,p=l[h];if(void 0!==p)for(var f=0;f<p.length;f++)G[u]=p[f],u++;m=u-m;d<(V[h]=m)&&(d=m)}return{neighbourListLength:27*d+1,withinRadii:function(e,t,r,i,n){for(var a=0,s=k(e,D),o=k(t,L),l=k(r,O),h=Math.max(0,s-1),c=Math.max(0,o-1),u=Math.max(0,l-1),d=Math.min(N,s+2),m=Math.min(F,o+2),p=Math.min(B,l+2),f=h;f<d;++f)for(var g=f*U,v=c;v<m;++v)for(var _=v*B,y=u;y<p;++y)for(var b=g+_+y,x=z[b],S=x+V[b],w=x;w<S;w++){var A=G[w],M=E[A]-e,C=P[A]-t,T=I[A]-r,A=R[A]+i;M*M+C*C+T*T<=A*A&&(n[a++]=G[w])}n[a]=-1}}}function u_(a,l,oe){let k=l.length,N=new Float32Array(k),F=new Float32Array(k),B=new Float32Array(k);for(let e=0;e<k;e++){var t=3*e;N[e]=a[t],F[e]=a[1+t],B[e]=a[2+t]}var e=ud(a);0===a.length&&(e[0].set([0,0,0]),e[1].set([0,0,0]));let U=e[0],h=e[1],z,V,c,u,G,H,O,$=-1,j,d,W,q,X,Y,K,Z,Q,J,ee,te=new Float32Array([0,0,0]),re=new Float32Array([0,0,0]),ie=new Float32Array([0,0,0]),ne=new Float32Array([0,0,0]),ae;function le(e,t,r,i){u=ce(e,1.4),G=ce(t,2),H=ce(r,!0),O=ce(i,30),z=new Float32Array(k),V=new Float32Array(k);for(let e=0;e<z.length;++e){var n=l[e]+u;z[e]=n,V[e]=n*n}for(let e=c=0;e<z.length;++e)z[e]>c&&(c=z[e]);e=lf(U,h,c,G,0),G=e.scaleFactor,j=e.dim,d=e.matrix,ae=Math.max(5,2+Math.floor(u*G)),W=qc(j[0]*j[1]*j[2],-1001),q=new Int32Array(W.length),X=new Float32Array(j[0]),Y=new Float32Array(j[1]),K=new Float32Array(j[2]),m(X,U[0],1/G),m(Y,U[1],1/G),m(K,U[2],1/G);var a=0,s=2*Math.PI/O;Q=new Float32Array(O),Z=new Float32Array(O);for(var o=0;o<O;o++)Q[o]=Math.cos(a),Z[o]=Math.sin(a),a+=s;J=c_(N,F,B,z,U,h,2.01*c),ee=new Int32Array(J.neighbourListLength),$=-1}function m(t,r,i){for(let e=0;e<t.length;e++)t[e]=r+i*e}function se(e,t,r,i,n){let a;if(-1!==$){if((a=$)!==i&&a!==n&&o(a,e,t,r))return a;$=-1}var s=0;for(a=ee[s];0<=a;){if(a!==i&&a!==n&&o(a,e,t,r))return $=a;a=ee[++s]}return $=-1}function o(e,t,r,i){var n=3*e,e=V[e],t=a[n]-t,r=a[1+n]-r,n=a[2+n]-i;return t*t+r*r+n*n<e}function he(){for(var e=0;e<k;e++){J.withinRadii(N[e],F[e],B[e],z[e],ee);for(var t=0,r=ee[t];0<=r;){if(e<r){L=D=R=I=P=E=T=C=M=A=w=S=x=b=y=_=v=g=f=p=m=d=u=c=h=l=o=s=a=n=i=void 0;for(var i=e,n=r,a=z[i],s=z[n],o=te[0]=N[n]-N[i],l=te[1]=F[n]-F[i],h=te[2]=B[n]-B[i],c=o*o+l*l+h*h,u=Math.sqrt(c),s=a*((a*a+u*u-s*s)/(2*a*u)),u=(wd(te,te),((e,t)=>(e[0]=e[1]=e[2]=1,0!==t[0]?e[0]=(t[1]+t[2])/-t[0]:0!==t[1]?e[1]=(t[0]+t[2])/-t[1]:0!==t[2]&&(e[2]=(t[0]+t[1])/-t[2])))(ie,te),wd(ie,ie),fd(ne,te,ie),wd(ne,ne),Math.sqrt(a*a-s*s)),d=(ue(ie,ie,u),ue(ne,ne,u),ue(te,te,s),re[0]=te[0]+N[i],re[1]=te[1]+F[i],re[2]=te[2]+B[i],$=-1,ae),m=0;m<O;m++){var p=Q[m],f=Z[m],g=re[0]+p*ie[0]+f*ne[0],v=re[1]+p*ie[1]+f*ne[1],_=re[2]+p*ie[2]+f*ne[2];if(-1===se(g,v,_,i,n))for(var p=Math.floor(G*(g-U[0])),f=Math.floor(G*(v-U[1])),y=Math.floor(G*(_-U[2])),b=Math.max(0,p-d),x=Math.max(0,f-d),S=Math.max(0,y-d),w=Math.min(j[0],p+d+2),A=Math.min(j[1],f+d+2),M=Math.min(j[2],y+d+2),C=b;C<w;C++){o=g-X[C];for(var T=j[1]*j[2]*C,E=x;E<A;E++){l=v-Y[E];for(var P=o*o+l*l,I=T+j[2]*E,R=S;R<M;R++){h=_-K[R],c=P+h*h;var D=R+I,L=W[D];0<L&&c<L*L&&(W[D]=Math.sqrt(c),H)&&(L=o*te[0]+l*te[1]+h*te[2],q[D]=L<0?n:i)}}}}}r=ee[++t]}}}function p(e,t,r){console.time("AVSurface.getVolume"),console.time("AVSurface.init"),le(e,t,r),console.timeEnd("AVSurface.init"),console.time("AVSurface.projectPoints");for(var i=0;i<k;i++)for(var n=N[i],a=F[i],s=B[i],o=z[i],l=V[i],h=(J.withinRadii(n,a,s,o,ee),Math.ceil(o*G)),c=Math.floor(G*(n-U[0])),u=Math.floor(G*(a-U[1])),d=Math.floor(G*(s-U[2])),m=Math.max(0,c-h),p=Math.max(0,u-h),f=Math.max(0,d-h),g=Math.min(j[0],c+h+2),v=Math.min(j[1],u+h+2),_=Math.min(j[2],d+h+2),y=m;y<g;y++)for(var b=X[y]-n,x=j[1]*j[2]*y,S=p;S<v;S++)for(var w=Y[S]-a,A=b*b+w*w,M=x+j[2]*S,C=f;C<_;C++){var T,E,P,I,R=K[C]-s,D=A+R*R;D<l&&(T=C+M,W[T]<0&&(W[T]=-W[T]),E=b*(I=o/(D=Math.sqrt(D))),P=w*I,R=R*I,-1===se(E+=n,P+=a,R+=s,i,-1))&&(I=o-D)<W[T]&&(W[T]=I,H)&&(q[T]=i)}console.timeEnd("AVSurface.projectPoints"),console.time("AVSurface.projectTorii"),he(),console.timeEnd("AVSurface.projectTorii");for(var L=0;L<W.length;L++)W[L]<0&&(W[L]=0);for(var O=0;O<q.length;O++)q[O]=oe[q[O]];console.timeEnd("AVSurface.getVolume")}this.getSurface=function(e,t,r,i,n,a,s){return p(t,r,n),new cf(W,j[2],j[1],j[0],q).getSurface(t,!1,void 0,d,s)}}mc.add("line",o_),Object.assign(h_,{__deps:[lf,of,cf,ud,l_]}),Object.assign(u_,{__deps:[lf,cf,qc,ud,ue,fd,wd,c_,ce]}),uc.add("molsurf",function(e,t){var r,i=e.data.args,e=e.data.params;i&&e&&(r=[(i=new("av"===e.type?u_:h_)(i.coordList,i.radiusList,i.indexList).getSurface(e.type,e.probeRadius,e.scaleFactor,e.cutoff,!0,e.smooth,e.contour)).position.buffer,i.index.buffer],i.normal&&r.push(i.normal.buffer),i.atomindex&&r.push(i.atomindex.buffer),t({sd:i,p:e},r))},[h_,u_]);class d_{constructor(e){this.structure=e}_getAtomData(e){return this.structure.getAtomData({what:{position:!0,radius:!0,index:!0},radiusParams:ce(e.radiusParams,{type:"vdw",scale:1})})}_makeSurface(e,t){e=new hf(t.name,"",e);return e.info.type=t.type,e.info.probeRadius=t.probeRadius,e.info.scaleFactor=t.scaleFactor,e.info.smooth=t.smooth,e.info.cutoff=t.cutoff,e}getSurface(e){var t=e||{},e=this._getAtomData(e),r=e.position,r=new("av"===t.type?u_:h_)(r,e.radius,e.index).getSurface(t.type,t.probeRadius,t.scaleFactor,t.cutoff,!0,t.smooth,t.contour);return this._makeSurface(r,t)}getSurfaceWorker(e,t){let r=Object.assign({},e);var i,n,a;window.hasOwnProperty("Worker")?(void 0===this.worker&&(this.worker=new od("molsurf")),i={args:{coordList:n=(e=this._getAtomData(e)).position,radiusList:a=e.radius,indexList:e=e.index},params:r},n=[n.buffer,a.buffer,e.buffer],this.worker.post(i,n,e=>{t(this._makeSurface(e.data.sd,r))},e=>{console.warn("MolecularSurface.getSurfaceWorker error - trying without worker",e),this.worker.terminate(),this.worker=void 0;e=this.getSurface(r);t(e)})):(a=this.getSurface(r),t(a))}dispose(){this.worker&&this.worker.terminate()}}class m_ extends G0{constructor(e,t,r){super(e,t,r),this.type="surface",this.parameters=Object.assign({surfaceType:{type:"select",rebuild:!0,options:{vws:"vws",sas:"sas",ms:"ms",ses:"ses",av:"av"}},probeRadius:{type:"number",precision:1,max:20,min:0,rebuild:!0},smooth:{type:"integer",precision:1,max:10,min:0,rebuild:!0},scaleFactor:{type:"number",precision:1,max:5,min:0,rebuild:!0},cutoff:{type:"number",precision:2,max:50,min:0,rebuild:!0},contour:{type:"boolean",rebuild:!0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},filterSele:{type:"text",rebuild:!0},colorVolume:{type:"hidden"},useWorker:{type:"boolean",rebuild:!0}},this.parameters,{radius:null,scale:null}),this.__infoList=[],this.structure.signals.refreshed.add(()=>{this.__forceNewMolsurf=!0}),this.toBePrepared=!0,this.init(r)}init(e){var t=e||{};t.colorScheme=ce(t.colorScheme,"uniform"),t.colorValue=ce(t.colorValue,14540253),t.disablePicking=ce(t.disablePicking,!0),this.surfaceType=ce(t.surfaceType,"ms"),this.probeRadius=ce(t.probeRadius,1.4),this.smooth=ce(t.smooth,2),this.scaleFactor=ce(t.scaleFactor,2),this.cutoff=ce(t.cutoff,0),this.contour=ce(t.contour,!1),this.background=ce(t.background,!1),this.opaqueBack=ce(t.opaqueBack,!0),this.filterSele=ce(t.filterSele,""),this.colorVolume=ce(t.colorVolume,void 0),this.useWorker=ce(t.useWorker,!0),super.init(e)}prepareData(e,t,r){let i=this.__infoList[t];if(i||(i={},this.__infoList[t]=i),i.molsurf&&i.sele===e.selection.string)r(t);else{if(this.filterSele){var n=e.structure.getView(new qh(this.filterSele)),a=n.boundingBox.getSize(new et),a=Math.max(a.x,a.y,a.z),n=e.getAtomSetWithinPoint(n.center,a/2+6);if(0===(e=e.getView(new qh(e.getAtomSetWithinSelection(n,3).toSeleString()))).atomCount)return void r(t)}i.sele=e.selection.string,i.molsurf=new d_(e);a=this.getSurfaceParams(),n=e=>{i.surface=e,r(t)};this.useWorker?i.molsurf.getSurfaceWorker(a,n):n(i.molsurf.getSurface(a))}}prepare(e){if(!this.__forceNewMolsurf&&this.__sele===this.selection.string&&this.__surfaceParams===JSON.stringify(this.getSurfaceParams())||(this.__infoList.forEach(e=>{e&&e.molsurf&&e.molsurf.dispose()}),this.__infoList.length=0),0===this.structureView.atomCount)e();else{let r=()=>{this.__sele=this.selection.string,this.__surfaceParams=JSON.stringify(this.getSurfaceParams()),this.__forceNewMolsurf=!1,e()};var t="default"===this.assembly?this.defaultAssembly:this.assembly;let i=this.structure.biomolDict[t];i?i.partList.forEach((e,t)=>{e=e.getView(this.structureView);this.prepareData(e,t,e=>{e===i.partList.length-1&&r()})}):this.prepareData(this.structureView,0,r)}}createData(e,t){var r,i,n,t=this.__infoList[t],a=t.surface;if(a)return r={position:a.getPosition(),color:a.getColor(this.getColorParams()),index:a.getFilteredIndex(this.filterSele,e)},i=[],a.contour?(n=new wf(r,this.getBufferParams({wireframe:!1})),i.push(n)):(Object.assign(r,{normal:a.getNormal(),picking:a.getPicking(e.getStructure())}),n=new yf(r,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1})),"double"==this.getBufferParams().side?(a=new Sf(n),i.push(a)):i.push(n)),{bufferList:i,info:t}}updateData(e,t){var r={};e.position||e.radius?(this.__forceNewMolsurf=!0,this.build()):(e.color&&(r.color=t.info.surface.getColor(this.getColorParams())),e.index&&(r.index=t.info.surface.getFilteredIndex(this.filterSele,t.sview)),t.bufferList[0].setAttributes(r))}setParameters(e,t={},r){return e&&e.filterSele&&(t.index=!0),e&&void 0!==e.colorVolume&&(t.color=!0),e&&e.wireframe&&(e.contour||void 0===e.contour&&this.contour)&&(e.wireframe=!1),super.setParameters(e,t,r),this}getSurfaceParams(e={}){return Object.assign({type:this.surfaceType,probeRadius:this.probeRadius,scaleFactor:this.scaleFactor,smooth:this.smooth&&!this.contour,cutoff:this.cutoff,contour:this.contour,useWorker:this.useWorker,radiusParams:this.getRadiusParams()},e)}getColorParams(){var e=super.getColorParams();return e.volume=this.colorVolume,e}getAtomRadius(){return 0}clear(){super.clear()}dispose(){this.__infoList.forEach(e=>{e&&e.molsurf&&e.molsurf.dispose()}),this.__infoList.length=0,super.dispose()}}mc.add("surface",m_);class p_ extends G0{constructor(e,t,r){super(e,t,r),this.type="point",this.parameters=Object.assign({pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{flatShaded:null,wireframe:null,linewidth:null,side:null,roughness:null,metalness:null}),this.init(r)}init(e){e=e||{};this.pointSize=ce(e.pointSize,1),this.sizeAttenuation=ce(e.sizeAttenuation,!0),this.sortParticles=ce(e.sortParticles,!1),this.useTexture=ce(e.useTexture,!1),this.alphaTest=ce(e.alphaTest,.5),this.forceTransparent=ce(e.forceTransparent,!1),this.edgeBleach=ce(e.edgeBleach,0),super.init(e)}createData(e){e=e.getAtomData(this.getAtomParams({position:!0,color:!0,picking:!0}));return{bufferList:[new v1(e,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach}))]}}updateData(e,t){var r=t.sview.getAtomData(this.getAtomParams(e)),i={};e&&!e.position||Object.assign(i,{position:r.position}),e&&!e.color||Object.assign(i,{color:r.color}),t.bufferList[0].setAttributes(i)}getAtomRadius(){return.1}}mc.add("point",p_),s.add("shader/Ribbon.vert","#define STANDARD\r\n\r\nuniform float clipNear;\r\nuniform vec3 clipCenter;\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\r\nvarying vec3 vViewPosition;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvarying vec3 vClipCenter;\r\n#endif\r\n\r\nattribute vec3 dir;\r\nattribute float size;\r\n\r\n#ifdef PICKING\r\n#include unpack_color\r\nattribute float primitiveId;\r\nvarying vec3 vPickingColor;\r\n#else\r\n#include color_pars_vertex\r\n#ifndef FLAT_SHADED\r\nvarying vec3 vNormal;\r\n#endif\r\n#endif\r\n\r\n#include common\r\n\r\nvoid main(void){\r\n\r\n#ifdef PICKING\r\nvPickingColor = unpackColor( primitiveId );\r\n#else\r\n#include color_vertex\r\n#include beginnormal_vertex\r\n#include defaultnormal_vertex\r\n// Normal computed with derivatives when FLAT_SHADED\r\n#ifndef FLAT_SHADED\r\nvNormal = normalize( transformedNormal );\r\n#endif\r\n#endif\r\n\r\n#include begin_vertex\r\n\r\ntransformed += normalize( dir ) * size;\r\n\r\n#include project_vertex\r\n\r\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\r\nvViewPosition = -mvPosition.xyz;\r\n#endif\r\n\r\n#if defined( RADIUS_CLIP )\r\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\r\n#endif\r\n\r\n#include nearclip_vertex\r\n\r\n}");let f_=new Uint16Array([0,1,2,1,3,2]);function g_(e){return 3*(4*(e.position.length/3-1))}class v_ extends _f{constructor(e,t={}){super({position:new Float32Array(g_(e)),color:new Float32Array(g_(e)),index:Zl(g_(e),g_(e)/3),normal:new Float32Array(g_(e)),picking:e.picking},t),this.vertexShader="Ribbon.vert";var t=e.position.length/3-1,r=4*t;this.addAttributes({dir:{type:"v3",value:new Float32Array(3*r)}}),this.addAttributes({size:{type:"f",value:new Float32Array(r)}}),e.primitiveId=Xc(t),this.setAttributes(e),this.makeIndex()}setAttributes(e={}){var t,r=this.size/4,i=this.geometry.attributes;let n,a,s,o,l,h,c,u,d,m,p,f;e.position&&(n=e.position,c=i.position.array,i.position.needsUpdate=!0),e.normal&&(a=e.normal,u=i.normal.array,i.normal.needsUpdate=!0),e.size&&(s=e.size,d=i.size.array,i.size.needsUpdate=!0),e.dir&&(o=e.dir,m=i.dir.array,i.dir.needsUpdate=!0),e.color&&(l=e.color,p=i.color.array,i.color.needsUpdate=!0),e.primitiveId&&(h=e.primitiveId,f=i.primitiveId.array,i.primitiveId.needsUpdate=!0);let g,v,_,y,b,x,S=s?s[0]:null;for(g=0;g<r;++g){for(x=3*g,_=3*g*4,b=4*g,n&&(c[_]=c[3+_]=n[x],c[1+_]=c[4+_]=n[1+x],c[2+_]=c[5+_]=n[2+x],c[6+_]=c[9+_]=n[3+x],c[7+_]=c[10+_]=n[4+x],c[8+_]=c[11+_]=n[5+x]),a&&(u[_]=u[3+_]=-a[x],u[1+_]=u[4+_]=-a[1+x],u[2+_]=u[5+_]=-a[2+x],u[6+_]=u[9+_]=-a[3+x],u[7+_]=u[10+_]=-a[4+x],u[8+_]=u[11+_]=-a[5+x]),v=0;v<4;++v)y=_+3*v,l&&(p[y]=l[x],p[1+y]=l[1+x],p[2+y]=l[2+x]),h&&(f[b+v]=h[g]);s&&(t=s[g],S!==s[g]?(d[b]=S,d[1+b]=S):(d[b]=t,d[1+b]=t),d[2+b]=t,d[3+b]=t,S=t),o&&(m[_]=o[x],m[1+_]=o[1+x],m[2+_]=o[2+x],m[3+_]=-o[x],m[4+_]=-o[1+x],m[5+_]=-o[2+x],m[6+_]=o[3+x],m[7+_]=o[4+x],m[8+_]=o[5+x],m[9+_]=-o[3+x],m[10+_]=-o[4+x],m[11+_]=-o[5+x])}}makeIndex(){var e=this.geometry.getIndex();if(e){var t=e.array,r=t.length/4/3;for(let e=0;e<r;++e){var i=6*e,n=4*e;t.set(f_,i);for(let e=0;e<6;++e)t[i+e]+=n}}else rt.error("Index is null")}}class __ extends G0{constructor(e,t,r){super(e,t,r),this.type="ribbon",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{side:null,wireframe:null,linewidth:null}),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"chainname"),e.colorScale=ce(e.colorScale,"RdYlBu"),e.radiusType=ce(e.radiusType,"sstruc"),e.radiusScale=ce(e.radiusScale,4),"low"===e.quality?this.subdiv=3:"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=ce(e.subdiv,6),this.tension=ce(e.tension,NaN),this.smoothSheet=ce(e.smoothSheet,!1),super.init(e)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!0,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){var a=[],s=[];return this.structure.eachPolymer(e=>{var t,r,i,n;e.residueCount<4||(s.push(e),t=(e=new Av(e,this.getSplineParams())).getSubdividedPosition(),r=e.getSubdividedOrientation(),i=e.getSubdividedColor(this.getColorParams()),n=e.getSubdividedPicking(),e=e.getSubdividedSize(this.getRadiusParams()),a.push(new v_({position:t.position,normal:r.binormal,dir:r.normal,color:i.color,size:e.size,picking:n.picking},this.getBufferParams())))},e.getSelection()),{bufferList:a,polymerList:s}}updateData(e,t){e=e||{};for(var r=0,i=t.polymerList.length,r=0;r<i;++r){var n,a,s={},o=new Av(t.polymerList[r],this.getSplineParams());e.position&&(n=o.getSubdividedPosition(),a=o.getSubdividedOrientation(),Object.assign(s,{position:n.position,normal:a.binormal,dir:a.normal})),(e.radius||e.scale)&&(n=o.getSubdividedSize(this.getRadiusParams()),Object.assign(s,{size:n.size})),e.color&&(a=o.getSubdividedColor(this.getColorParams()),Object.assign(s,{color:a.color})),t.bufferList[r].setAttributes(s)}}setParameters(e){var t={};return e&&e.tension&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}mc.add("ribbon",__);class y_ extends G0{constructor(e,t,r){super(e,t,r),this.type="rocket",this.parameters=Object.assign({localAngle:{type:"integer",max:180,min:0,rebuild:!0},centerDist:{type:"number",precision:1,max:10,min:0,rebuild:!0},ssBorder:{type:"boolean",rebuild:!0},radialSegments:!0,openEnded:!0,disableImpostor:!0},this.parameters),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"sstruc"),e.radiusSize=ce(e.radiusSize,1.5),e.radiusScale=ce(e.radiusScale,1),e.openEnded=ce(e.openEnded,!1),e.useInteriorColor=ce(e.useInteriorColor,!0),this.localAngle=ce(e.localAngle,30),this.centerDist=ce(e.centerDist,2.5),this.ssBorder=ce(e.ssBorder,!1),super.init(e)}createData(e){let r=0,i=[],n=[],t=(this.structure.eachPolymer(e=>{var t;e.residueCount<4||e.isNucleic()||(t=(e=new eg(e)).getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams()),r+=t.size.length,i.push(t),n.push(e))},e.getSelection()),{begin:new Float32Array(3*r),end:new Float32Array(3*r),size:new Float32Array(r),color:new Float32Array(3*r),picking:{}}),a=new Float32Array(r),s=0;return i.forEach(function(e){t.begin.set(e.begin,3*s),t.end.set(e.end,3*s),t.size.set(e.size,s),t.color.set(e.color,3*s),a.set(e.picking.array,s),s+=e.size.length}),r&&(t.picking=new gp(a,e.getStructure())),{bufferList:[new _v({position1:t.begin,position2:t.end,color:t.color,color2:t.color,radius:t.size,picking:t.picking},this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))],axisList:i,helixbundleList:n,axisData:t}}updateData(t,r){var e,i;(t=t||{}).position?this.build():(e={},(t.color||t.radius)&&(i=0,r.helixbundleList.forEach(e=>{e=e.getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams());t.color&&r.axisData.color.set(e.color,3*i),(t.radius||t.scale)&&r.axisData.size.set(e.size,i),i+=e.size.length}),t.color&&Object.assign(e,{color:r.axisData.color,color2:r.axisData.color}),t.radius||t.scale)&&Object.assign(e,{radius:r.axisData.size}),r.bufferList[0].setAttributes(e))}}mc.add("rocket",y_);class b_ extends Pv{constructor(e,t,r){super(e,t,r),this.type="rope",this.parameters=Object.assign({smooth:{type:"integer",max:15,min:0,rebuild:!0}},this.parameters,{aspectRatio:null,smoothSheet:null})}init(e){e=e||{};e.aspectRatio=1,e.tension=ce(e.tension,.5),e.radiusScale=ce(e.radiusScale,5),e.smoothSheet=!1,this.smooth=ce(e.smooth,2),super.init(e)}getSpline(e){var t=new Jf(e);return new Av(e,this.getSplineParams({directional:!1,positionIterator:t.getCenterIterator(this.smooth)}))}}mc.add("rope",b_);class x_ extends G0{constructor(e,t,r){super(e,t,r),this.type="spacefill",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(r)}init(e){e=e||{};e.useInteriorColor=ce(e.useInteriorColor,!0),super.init(e)}createData(e){return{bufferList:[new m1(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,dullInterior:!0,disableImpostor:this.disableImpostor}))]}}updateData(e,t){var r=t.sview.getAtomData(this.getAtomParams(e)),i={};e&&!e.position||Object.assign(i,{position:r.position}),e&&!e.color||Object.assign(i,{color:r.color}),e&&!e.radius||Object.assign(i,{radius:r.radius}),t.bufferList[0].setAttributes(i)}}function S_(e){return 3*(e.position.length/3-1)*2}mc.add("spacefill",x_);class w_ extends vf{constructor(e,t={}){super({position:new Float32Array(S_(e)),color:new Float32Array(S_(e))},t),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag",this.setAttributes(e)}setAttributes(e){let t,r,i,n;var a=this.geometry.attributes;if(e.position&&(t=e.position,i=a.position.array,a.position.needsUpdate=!0),e.color&&(r=e.color,n=a.color.array,a.color.needsUpdate=!0),t||r){var s,o,l=this.size-1;for(let e=0;e<l;++e)s=3*e,o=3*e*2,t&&(i[o]=t[s],i[1+o]=t[1+s],i[2+o]=t[2+s],i[3+o]=t[3+s],i[4+o]=t[4+s],i[5+o]=t[5+s]),r&&(n[o]=r[s],n[1+o]=r[1+s],n[2+o]=r[2+s],n[3+o]=r[3+s],n[4+o]=r[4+s],n[5+o]=r[5+s])}else rt.warn("TraceBuffer.prototype.setAttributes no data")}}class A_ extends G0{constructor(e,t,r){super(e,t,r),this.type="trace",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null}),this.init(r)}init(e){e=e||{};e.colorScheme=ce(e.colorScheme,"chainname"),e.colorScale=ce(e.colorScale,"RdYlBu"),"low"===e.quality?this.subdiv=3:"medium"===e.quality?this.subdiv=6:"high"===e.quality?this.subdiv=12:this.subdiv=ce(e.subdiv,6),this.tension=ce(e.tension,NaN),this.smoothSheet=ce(e.smoothSheet,!1),super.init(e)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!1,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?.1:0}createData(e){var r=[],i=[];return this.structure.eachPolymer(e=>{var t;e.residueCount<4||(i.push(e),t=(e=new Av(e,this.getSplineParams())).getSubdividedPosition(),e=e.getSubdividedColor(this.getColorParams()),r.push(new w_(Object.assign({},t,e),this.getBufferParams())))},e.getSelection()),{bufferList:r,polymerList:i}}updateData(e,t){e=e||{};for(var r=0,i=t.polymerList.length,r=0;r<i;++r){var n,a={},s=new Av(t.polymerList[r],this.getSplineParams());e.position&&(n=s.getSubdividedPosition(),Object.assign(a,{position:n.position})),e.color&&(n=s.getSubdividedColor(this.getColorParams()),Object.assign(a,{color:n.color})),t.bufferList[r].setAttributes(a)}}setParameters(e){var t={};return e&&e.tension&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}mc.add("trace",A_);class M_ extends Pv{constructor(e,t,r){super(e,t,r),this.type="tube",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){e=e||{};e.aspectRatio=1,e.radiusScale=ce(e.radiusScale,2),"low"===e.quality&&(this.radialSegments=5),super.init(e)}getSplineParams(){return super.getSplineParams({directional:!1})}}mc.add("tube",M_);class C_ extends G0{constructor(e,t,r){super(e,t,r),this.type="unitcell",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0},this.parameters,{assembly:null}),this.init(r)}init(e){e=e||{};let t=.5;this.structure.unitcell&&(t=Math.cbrt(this.structure.unitcell.volume)/200),e.radiusSize=ce(e.radiusSize,t),e.colorValue=ce(e.colorValue,"orange"),e.useInteriorColor=ce(e.useInteriorColor,!0),super.init(e)}getUnitcellData(e){return e.unitcell.getData(e)}create(){var e=this.structureView.getStructure();e.unitcell&&(e=this.getUnitcellData(e),this.sphereBuffer=new m1(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new _v(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]}))}createData(e){}updateData(e,t){var r,i,t=t.sview.getStructure();t.unitcell&&(t=this.getUnitcellData(t),r={},i={},e&&!e.position||(Object.assign(r,{position:t.vertex.position}),Object.assign(i,{position1:t.edge.position1,position2:t.edge.position2})),e&&!e.color||(Object.assign(r,{color:t.vertex.color}),Object.assign(i,{color:t.edge.color,color2:t.edge.color2})),e&&!e.radius||(Object.assign(r,{radius:t.vertex.radius}),Object.assign(i,{radius:t.edge.radius})),this.sphereBuffer.setAttributes(r),this.cylinderBuffer.setAttributes(i))}}mc.add("unitcell",C_);class T_ extends G0{constructor(e,t,r){super(e,t,r),this.type="validation",this.parameters=Object.assign({},this.parameters,{radiusType:null,radiusSize:null,radiusScale:null}),this.init(r)}init(e){e=e||{};e.colorValue=ce(e.colorValue,"#f0027f"),e.useInteriorColor=ce(e.useInteriorColor,!0),super.init(e)}createData(e){if(e.validation)return e=e.validation.getClashData({structure:e,color:this.colorValue}),{bufferList:[new _v(e,this.getBufferParams({openEnded:!1}))]}}}mc.add("validation",T_);let E_=new et,P_=new et,I_=new et,R_=new et(0,1,0);let D_=Object.assign({radialSegments:60,openEnded:!1},ff);class L_ extends n1{constructor(e,t={}){super({position:new Float32Array(e.position1.length),color:e.color,picking:e.picking},t,([t={}]=[t],(t=new Sl(1,1,ce(t.radialSegments,60),1,ce(t.openEnded,!1))).applyMatrix4((new tt).makeRotationX(-Math.PI/2)),t)),this.updateNormals=!0,this._position=new Float32Array(e.position1.length),this.setAttributes(e,!0)}get defaultParameters(){return D_}applyPositionTransform(e,t,r){P_.fromArray(this._position1,r),I_.fromArray(this._position2,r),e.lookAt(P_,I_,R_);r=this._radius[t];E_.set(r,r,P_.distanceTo(I_)),e.scale(E_)}setAttributes(e={},t){e.position1&&e.position2&&(jc(e.position1,e.position2,this._position),this._position1=e.position1,this._position2=e.position2,e.position=this._position),e.radius&&(this._radius=e.radius),super.setAttributes(e,t)}}gc.add("cone",L_);class O_{constructor(e=[]){this.geometryList=e}computeBoundingBox(){this.boundingBox?this.boundingBox.empty():this.boundingBox=new ai,this.geometryList.forEach(e=>{e.boundingBox||e.computeBoundingBox(),this.boundingBox.union(e.boundingBox)})}}let k_=Object.assign({aspectRatio:1.5,radialSegments:50,openEnded:!1,disableImpostor:!1},ff);class N_{constructor(e,t={}){this.group=new Wo,this.wireframeGroup=new Wo,this.pickingGroup=new Wo,this.visible=!0,this.parameters=Vl(t,this.defaultParameters),this.splitPosition=new Float32Array(e.position1.length),this.cylinderRadius=new Float32Array(e.radius.length);var r=this.makeAttributes(e),i={radialSegments:this.parameters.radialSegments,openEnded:this.parameters.openEnded,disableImpostor:this.parameters.disableImpostor};this.cylinderBuffer=new _v(r.cylinder,i),this.coneBuffer=new L_(r.cone,i),this.geometry=new O_([this.cylinderBuffer.geometry,this.coneBuffer.geometry]),this.matrix=ce(t.matrix,new tt),this.picking=e.picking}get defaultParameters(){return k_}set matrix(e){vf.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking}makeAttributes(e={}){var t=this.splitPosition,r=this.cylinderRadius,i=this.parameters.aspectRatio;let n,a;var s={},o={};if(e.radius){for(n=0,a=r.length;n<a;++n)r[n]=e.radius[n]/i;s.radius=r,o.radius=e.radius}if(e.position1&&e.position2){var l=new et,h=new et,c=new et,u=new et;for(n=0,a=t.length;n<a;n+=3){l.fromArray(e.position1,n),h.fromArray(e.position2,n),c.subVectors(l,h);var d=c.length(),m=r[n/3]*i*2,d=Math.min(d,m);c.setLength(d),u.copy(h).add(c),u.toArray(t,n)}s.position1=e.position1,o.position1=s.position2=t,o.position2=e.position2}return e.color&&(s.color=e.color,s.color2=e.color,o.color=e.color),{cylinder:s,cone:o}}getMesh(){return(new Wo).add(this.cylinderBuffer.getMesh(),this.coneBuffer.getMesh())}getWireframeMesh(){return(new Wo).add(this.cylinderBuffer.getWireframeMesh(),this.coneBuffer.getWireframeMesh())}getPickingMesh(){return(new Wo).add(this.cylinderBuffer.getPickingMesh(),this.coneBuffer.getPickingMesh())}setAttributes(e={}){e=this.makeAttributes(e);this.cylinderBuffer.setAttributes(e.cylinder),this.coneBuffer.setAttributes(e.cone)}setParameters(e={}){(e=Object.assign({},e))&&void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,e&&void 0!==e.wireframe&&(this.parameters.wireframe=e.wireframe,this.setVisibility(this.visible)),this.cylinderBuffer.setParameters(e),this.coneBuffer.setParameters(e)}setVisibility(e){vf.prototype.setVisibility.call(this,e)}dispose(){this.cylinderBuffer.dispose(),this.coneBuffer.dispose()}}gc.add("arrow",N_);let F_=new et,B_=new et,U_=new et,z_=new et(0,0,0);class V_ extends n1{constructor(e,t={}){super(e,t,new ia(1,1,1)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,r){B_.fromArray(this._heightAxis,r),U_.fromArray(this._depthAxis,r),e.lookAt(z_,B_,U_),F_.set(this._size[t],U_.length(),B_.length()),e.scale(F_)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}gc.add("box",V_);let G_=new et,H_=new et,$_=new et,j_=new et(0,0,0),W_=Object.assign({sphereDetail:2},ff);class q_ extends n1{constructor(e,t={}){super(e,t,new Al(1,ce(t.sphereDetail,2))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return W_}applyPositionTransform(e,t,r){H_.fromArray(this._majorAxis,r),$_.fromArray(this._minorAxis,r),e.lookAt(j_,H_,$_),G_.set(this._radius[t],$_.length(),H_.length()),e.scale(G_)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,t)}}gc.add("ellipsoid",q_);let X_=new et,Y_=new et,K_=new et,Z_=new et(0,0,0);class Q_ extends n1{constructor(e,t={}){super(e,t,new Ml(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,r){Y_.fromArray(this._heightAxis,r),K_.fromArray(this._depthAxis,r),e.lookAt(Z_,Y_,K_),X_.set(this._size[t],K_.length(),Y_.length()),e.scale(X_)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}gc.add("octahedron",Q_);let J_=new et,ey=new et,ty=new et,ry=new et(0,0,0);class iy extends n1{constructor(e,t={}){super(e,t,new Cl(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,r){ey.fromArray(this._heightAxis,r),ty.fromArray(this._depthAxis,r),e.lookAt(ry,ey,ty),J_.set(this._size[t],ty.length(),ey.length()),e.scale(J_)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}gc.add("tetrahedron",iy);let ny=new et,ay=new et,sy=new et,oy=new et(0,0,0),ly=Object.assign({radiusRatio:.2,radialSegments:16,tubularSegments:32},ff);class hy extends n1{constructor(e,t={}){super(e,t,new Tl(1,ce(t.radiusRatio,.2),ce(t.radialSegments,16),ce(t.tubularSegments,32))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return ly}applyPositionTransform(e,t,r){ay.fromArray(this._majorAxis,r),sy.fromArray(this._minorAxis,r),e.lookAt(oy,ay,sy);r=this._radius[t];ny.set(r,r,r),e.scale(ny)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,t)}}function cy(e,t){return{start:t&&void 0!==t.start?Math.max(Math.min(t.start,e-1),0):0,end:t&&void 0!==t.end?Math.min(t.end,e):e}}function uy(e,t){var r=t&&void 0!==t.array?t.array:Array,{start:e,end:t}=cy(e,t);return{array:new r(t-e),start:e,end:t}}function dy(e,t,r){var{array:e,start:r}=uy(e,r),i=t,n=e,a=r;for(let e=0,t=n.length;e<t;e++)n[e]=i(a+e);return n}function my(e){return!!e.buffer&&"number"==typeof e.byteLength&&"number"==typeof e.BYTES_PER_ELEMENT}function py(e,t){var{constructor:r,buffer:i,length:n,byteOffset:a,BYTES_PER_ELEMENT:s}=e,{start:t,end:o}=cy(n,t);return 0===t&&o===n?e:new r(i,a+s*t,Math.min(n,o-t))}gc.add("torus",hy);let fy=1e-6;function gy(e,t,r){return Math.abs(e-t)<=r}function vy(e,t,r){return Math.max(t,Math.min(r,e))}function _y(e,t,r,i,n,a){e=(r-e)*a,i=(i-t)*a,a=n*n;return(2*t-2*r+e+i)*(n*a)+(-3*t+3*r-2*e-i)*a+e*n+t}function yy(e,t,r,i){var n=1-i;return n*n*e+2*n*i*t+i*i*r}let by=isFinite;function b(){return b.zero()}{var x=b=b||{};function xy(){var e=[0,0,0];return e}function Sy(e,t,r){var i=xy();return i[0]=e,i[1]=t,i[2]=r,i}function wy(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Ay(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function My(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function Cy(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function Ty(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e}function Ey(e){var t=e[0],r=e[1],e=e[2];return t*t+r*r+e*e}function Py(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function Iy(e,t){var r=t[0],i=t[1],n=t[2],r=r*r+i*i+n*n;return 0<r&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r),e}function Ry(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Dy(e,t,r){var i=t[0],n=t[1],t=t[2],a=r[0],s=r[1],r=r[2];return e[0]=n*r-t*s,e[1]=t*a-i*r,e[2]=i*s-n*a,e}x.zero=xy,x.clone=function(e){var t=xy();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},x.isFinite=function(e){return by(e[0])&&by(e[1])&&by(e[2])},x.hasNaN=function(e){return isNaN(e[0])||isNaN(e[1])||isNaN(e[2])},x.setNaN=function(e){return e[0]=NaN,e[1]=NaN,e[2]=NaN,e},x.fromObj=function(e){return Sy(e.x,e.y,e.z)},x.toObj=function(e){return{x:e[0],y:e[1],z:e[2]}},x.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e},x.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2],t},x.create=Sy,x.ofArray=function(e){var t=xy();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},x.set=function(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e},x.copy=wy,x.add=Ay,x.sub=My,x.mul=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e},x.div=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},x.scale=Cy,x.scaleAndAdd=Ty,x.scaleAndSub=function(e,t,r,i){return e[0]=t[0]-r[0]*i,e[1]=t[1]-r[1]*i,e[2]=t[2]-r[2]*i,e},x.addScalar=function(e,t,r){return e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r,e},x.subScalar=function(e,t,r){return e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r,e},x.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},x.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},x.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},x.trunc=function(e,t){return e[0]=Math.trunc(t[0]),e[1]=Math.trunc(t[1]),e[2]=Math.trunc(t[2]),e},x.abs=function(e,t){return e[0]=Math.abs(t[0]),e[1]=Math.abs(t[1]),e[2]=Math.abs(t[2]),e},x.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},x.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},x.clamp=function(e,t,r,i){return e[0]=Math.max(r[0],Math.min(i[0],t[0])),e[1]=Math.max(r[1],Math.min(i[1],t[1])),e[2]=Math.max(r[2],Math.min(i[2],t[2])),e},x.distance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],t=t[2]-e[2];return Math.sqrt(r*r+i*i+t*t)},x.squaredDistance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i+(t=t[2]-e[2])*t},x.magnitude=function(e){var t=e[0],r=e[1],e=e[2];return Math.sqrt(t*t+r*r+e*e)},x.squaredMagnitude=Ey,x.setMagnitude=function(e,t,r){return Cy(e,Iy(e,t),r)},x.negate=Py,x.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},x.normalize=Iy,x.dot=Ry,x.cross=Dy,x.lerp=function(e,t,r,i){var n=t[0],a=t[1],t=t[2];return e[0]=n+i*(r[0]-n),e[1]=a+i*(r[1]-a),e[2]=t+i*(r[2]-t),e};let a=xy();function Ly(e,t){var r=Math.sqrt(Ey(e)*Ey(t));return 0===r?Math.PI/2:(e=Ry(e,t)/r,Math.acos(vy(e,-1,1)))}x.slerp=function(e,t,r,i){var n=vy(Ry(t,r),-1,1),i=Math.acos(n)*i;return Ty(a,r,t,-n),Iy(a,a),Ay(e,Cy(e,t,Math.cos(i)),Cy(a,a,Math.sin(i)))},x.hermite=function(e,t,r,i,n,a){var s=(h=a*a)*(2*a-3)+1,o=h*(a-2)+a,l=h*(a-1),h=h*(3-2*a);return e[0]=t[0]*s+r[0]*o+i[0]*l+n[0]*h,e[1]=t[1]*s+r[1]*o+i[1]*l+n[1]*h,e[2]=t[2]*s+r[2]*o+i[2]*l+n[2]*h,e},x.bezier=function(e,t,r,i,n,a){var s=(o=(l=1-a)*l)*l,o=3*a*o,l=3*(h=a*a)*l,h=h*a;return e[0]=t[0]*s+r[0]*o+i[0]*l+n[0]*h,e[1]=t[1]*s+r[1]*o+i[1]*l+n[1]*h,e[2]=t[2]*s+r[2]*o+i[2]*l+n[2]*h,e},x.quadraticBezier=function(e,t,r,i,n){return e[0]=yy(t[0],r[0],i[0],n),e[1]=yy(t[1],r[1],i[1],n),e[2]=yy(t[2],r[2],i[2],n),e},x.spline=function(e,t,r,i,n,a,s){return e[0]=_y(t[0],r[0],i[0],n[0],a,s),e[1]=_y(t[1],r[1],i[1],n[1],a,s),e[2]=_y(t[2],r[2],i[2],n[2],a,s),e},x.random=function(e,t){var r=2*Math.random()*Math.PI,i=2*Math.random()-1,n=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=i*t,e},x.transformMat4=function(e,t,r){var i=t[0],n=t[1],t=t[2],a=1/(r[3]*i+r[7]*n+r[11]*t+r[15]||1);return e[0]=(r[0]*i+r[4]*n+r[8]*t+r[12])*a,e[1]=(r[1]*i+r[5]*n+r[9]*t+r[13])*a,e[2]=(r[2]*i+r[6]*n+r[10]*t+r[14])*a,e},x.transformDirection=function(e,t,r){var i=t[0],n=t[1],t=t[2];return e[0]=r[0]*i+r[4]*n+r[8]*t,e[1]=r[1]*i+r[5]*n+r[9]*t,e[2]=r[2]*i+r[6]*n+r[10]*t,Iy(e,e)},x.transformMat4Offset=function(e,t,r,i,n,a){var s=t[0+n],o=t[1+n],t=t[2+n],n=1/(r[3+a]*s+r[7+a]*o+r[11+a]*t+r[15+a]||1);return e[0+i]=(r[0+a]*s+r[4+a]*o+r[8+a]*t+r[12+a])*n,e[1+i]=(r[1+a]*s+r[5+a]*o+r[9+a]*t+r[13+a])*n,e[2+i]=(r[2+a]*s+r[6+a]*o+r[10+a]*t+r[14+a])*n,e},x.transformDirectionOffset=function(e,t,r,i,n,a){var s=t[0+n],o=t[1+n],t=t[2+n];return e[0+i]=r[0+a]*s+r[4+a]*o+r[8+a]*t,e[1+i]=r[1+a]*s+r[5+a]*o+r[9+a]*t,e[2+i]=r[2+a]*s+r[6+a]*o+r[10+a]*t,0<(n=Math.hypot(e[0+i],e[1+i],e[2+i]))&&(e[0+i]/=n,e[1+i]/=n,e[2+i]/=n),e},x.transformMat3=function(e,t,r){var i=t[0],n=t[1],t=t[2];return e[0]=i*r[0]+n*r[3]+t*r[6],e[1]=i*r[1]+n*r[4]+t*r[7],e[2]=i*r[2]+n*r[5]+t*r[8],e},x.transformQuat=function(e,t,r){var i=t[0],n=t[1],t=t[2],a=r[0],s=r[1],o=r[2],l=(r=r[3])*i+s*t-o*n,h=r*n+o*i-a*t,c=r*t+a*n-s*i,i=-a*i-s*n-o*t;return e[0]=l*r+i*-a+h*-o-c*-s,e[1]=h*r+i*-s+c*-a-l*-o,e[2]=c*r+i*-o+l*-s-h*-a,e},x.angle=Ly;let n=xy(),s=xy(),o=xy(),l=xy(),h=xy(),c=xy(),u=xy(),d=(x.dihedralAngle=function(e,t,r,i){return My(n,e,t),My(s,r,t),My(o,t,r),My(l,i,r),Dy(h,n,s),Dy(c,o,l),e=Ly(h,c),Dy(u,h,c),0<Ry(s,u)?e:-e},x.directionFromSpherical=function(e,t,r,i){return x.set(e,i*Math.cos(r)*Math.sin(t),i*Math.sin(r)*Math.sin(t),i*Math.cos(t))},x.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},x.equals=function(e,t){var r=e[0],i=e[1],e=e[2],n=t[0],a=t[1],t=t[2];return Math.abs(r-n)<=fy*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-a)<=fy*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(e-t)<=fy*Math.max(1,Math.abs(e),Math.abs(t))},xy()),m=(x.makeRotation=function(e,t,r){var i=Ly(t,r);return Math.abs(i)<1e-4?Ny.setIdentity(e):Math.abs(i-Math.PI)<fy?Ny.fromScaling(e,x.negUnit):(t=Dy(d,t,r),Ny.fromRotation(e,i,t))},x.isZero=function(e){return 0===e[0]&&0===e[1]&&0===e[2]},x.projectPointOnVector=function(e,t,r,i){return My(e,t,i),Ay(e,Cy(e,r,Ry(r,e)/Ey(r)),i)},xy());function Oy(e,t,r){return Cy(e,r,Ry(r,t)/Ey(r))}x.projectPointOnPlane=function(e,t,r,i){return Iy(m,r),My(e,t,i),My(e,t,Cy(m,m,Ry(e,m)))},x.projectOnVector=Oy;let i=xy(),p=(x.projectOnPlane=function(e,t,r){return Oy(i,t,r),My(e,t,i)},x.orthogonalize=function(e,t,r){return Iy(e,Dy(e,Dy(e,t,r),t))},x.matchDirection=function(e,t,r){return 0<Ry(t,r)?wy(e,t):Py(e,wy(e,t)),e},xy()),f=xy();x.triangleNormal=function(e,t,r,i){return My(p,r,t),My(f,i,t),Iy(e,Dy(e,p,f))},x.toString=function(e,t){return`[${e[0].toPrecision(t)} ${e[1].toPrecision(t)} ${e[2].toPrecision(t)}]`},x.origin=Sy(0,0,0),x.unit=Sy(1,1,1),x.negUnit=Sy(-1,-1,-1),x.unitX=Sy(1,0,0),x.unitY=Sy(0,1,0),x.unitZ=Sy(0,0,1),x.negUnitX=Sy(-1,0,0),x.negUnitY=Sy(0,-1,0),x.negUnitZ=Sy(0,0,-1)}let ky=Math.PI/180;function Ny(){return Ny.zero()}{var e;function Fy(){var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];return e}function By(){var e=Fy();return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Uy(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zy(t){for(let e=0;e<16;e++)t[e]=0;return t}(e=Ny=Ny||{}).zero=Fy,e.identity=By,e.setIdentity=Uy,e.setZero=zy,e.ofRows=function(e){var r=Fy();for(let t=0;t<4;t++){var i=e[t];for(let e=0;e<4;e++)r[4*e+t]=i[e]}return r};let r=By();function Vy(t,r,i){for(let e=0;e<16;e++)if(Math.abs(t[e]-r[e])>i)return!1;return!0}function Gy(e,t,r,i){e[4*r+t]=i}function Hy(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function $y(e,t){var r=t[0]+t[5]+t[10];let i=0;return 0<r?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function jy(e,t){var r=t[0],i=t[1],n=t[2],a=t[3],s=t[4],o=t[5],l=t[6],h=t[7],c=t[8],u=t[9],d=t[10],m=t[11],p=t[12],f=t[13],g=t[14],t=t[15],v=r*o-i*s,_=r*l-n*s,y=r*h-a*s,b=i*l-n*o,x=i*h-a*o,S=n*h-a*l,w=c*f-u*p,A=c*g-d*p,M=c*t-m*p,C=u*g-d*f,T=u*t-m*f,E=d*t-m*g,P=v*E-_*T+y*C+b*M-x*A+S*w;return!!P&&(e[0]=(o*E-l*T+h*C)*(P=1/P),e[1]=(n*T-i*E-a*C)*P,e[2]=(f*S-g*x+t*b)*P,e[3]=(d*x-u*S-m*b)*P,e[4]=(l*M-s*E-h*A)*P,e[5]=(r*E-n*M+a*A)*P,e[6]=(g*y-p*S-t*_)*P,e[7]=(c*S-d*y+m*_)*P,e[8]=(s*T-o*M+h*w)*P,e[9]=(i*M-r*T-a*w)*P,e[10]=(p*x-f*y+t*v)*P,e[11]=(u*y-c*x-m*v)*P,e[12]=(o*A-s*C-l*w)*P,e[13]=(r*C-i*A+n*w)*P,e[14]=(f*_-p*b-g*v)*P,e[15]=(c*b-u*_+d*v)*P,!0)}function Wy(e,t,r){var i=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],m=t[10],p=t[11],f=t[12],g=t[13],v=t[14],t=t[15],_=r[0],y=r[1],b=r[2],x=r[3];return e[0]=_*i+y*o+b*u+x*f,e[1]=_*n+y*l+b*d+x*g,e[2]=_*a+y*h+b*m+x*v,e[3]=_*s+y*c+b*p+x*t,e[4]=(_=r[4])*i+(y=r[5])*o+(b=r[6])*u+(x=r[7])*f,e[5]=_*n+y*l+b*d+x*g,e[6]=_*a+y*h+b*m+x*v,e[7]=_*s+y*c+b*p+x*t,e[8]=(_=r[8])*i+(y=r[9])*o+(b=r[10])*u+(x=r[11])*f,e[9]=_*n+y*l+b*d+x*g,e[10]=_*a+y*h+b*m+x*v,e[11]=_*s+y*c+b*p+x*t,e[12]=(_=r[12])*i+(y=r[13])*o+(b=r[14])*u+(x=r[15])*f,e[13]=_*n+y*l+b*d+x*g,e[14]=_*a+y*h+b*m+x*v,e[15]=_*s+y*c+b*p+x*t,e}function qy(e,t,r){var i=r[0],n=r[1],r=r[2],a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<fy)return Uy(e);i*=a=1/a,n*=a,r*=a;var a=Math.sin(t),t=Math.cos(t),s=1-t;return e[0]=i*i*s+t,e[1]=n*i*s+r*a,e[2]=r*i*s-n*a,e[3]=0,e[4]=i*n*s-r*a,e[5]=n*n*s+t,e[6]=r*n*s+i*a,e[7]=0,e[8]=i*r*s+n*a,e[9]=n*r*s-i*a,e[10]=r*r*s+t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}e.isIdentity=function(e,t){return Vy(e,r,void 0===t?fy:t)},e.hasNaN=function(t){for(let e=0;e<16;e++)if(isNaN(t[e]))return!0;return!1},e.areEqual=Vy,e.setValue=Gy,e.getValue=function(e,t,r){return e[4*r+t]},e.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3],t[r+4]=e[4],t[r+5]=e[5],t[r+6]=e[6],t[r+7]=e[7],t[r+8]=e[8],t[r+9]=e[9],t[r+10]=e[10],t[r+11]=e[11],t[r+12]=e[12],t[r+13]=e[13],t[r+14]=e[14],t[r+15]=e[15],t},e.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],e[4]=t[r+4],e[5]=t[r+5],e[6]=t[r+6],e[7]=t[r+7],e[8]=t[r+8],e[9]=t[r+9],e[10]=t[r+10],e[11]=t[r+11],e[12]=t[r+12],e[13]=t[r+13],e[14]=t[r+14],e[15]=t[r+15],e},e.fromBasis=function(e,t,r,i){return zy(e),Gy(e,0,0,t[0]),Gy(e,1,0,t[1]),Gy(e,2,0,t[2]),Gy(e,0,1,r[0]),Gy(e,1,1,r[1]),Gy(e,2,1,r[2]),Gy(e,0,2,i[0]),Gy(e,1,2,i[1]),Gy(e,2,2,i[2]),Gy(e,3,3,1),e},e.copy=Hy,e.clone=function(e){return Hy(Fy(),e)},e.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},e.getScaling=function(e,t){var r=t[0],i=t[1],n=t[2],a=t[4],s=t[5],o=t[6],l=t[8],h=t[9],t=t[10];return e[0]=Math.sqrt(r*r+i*i+n*n),e[1]=Math.sqrt(a*a+s*s+o*o),e[2]=Math.sqrt(l*l+h*h+t*t),e},e.getRotation=$y,e.extractRotation=function(e,t){var r=1/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=1/Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]),n=1/Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]);return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=0,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=0,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.transpose=function(e,t){var r,i,n,a,s,o;return e===t?(r=t[1],i=t[2],n=t[3],a=t[6],s=t[7],o=t[11],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=a,e[11]=t[14],e[12]=n,e[13]=s,e[14]=o):(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]),e},e.tryInvert=jy,e.invert=function(e,t){return jy(e,t)||console.warn("non-invertible matrix.",t),e},e.mul=Wy,e.mulOffset=function(e,t,r,i,n,a){var s=t[0+n],o=t[1+n],l=t[2+n],h=t[3+n],c=t[4+n],u=t[5+n],d=t[6+n],m=t[7+n],p=t[8+n],f=t[9+n],g=t[10+n],v=t[11+n],_=t[12+n],y=t[13+n],b=t[14+n],t=t[15+n],n=r[0+a],x=r[1+a],S=r[2+a],w=r[3+a];return e[0+i]=n*s+x*c+S*p+w*_,e[1+i]=n*o+x*u+S*f+w*y,e[2+i]=n*l+x*d+S*g+w*b,e[3+i]=n*h+x*m+S*v+w*t,e[4+i]=(n=r[4+a])*s+(x=r[5+a])*c+(S=r[6+a])*p+(w=r[7+a])*_,e[5+i]=n*o+x*u+S*f+w*y,e[6+i]=n*l+x*d+S*g+w*b,e[7+i]=n*h+x*m+S*v+w*t,e[8+i]=(n=r[8+a])*s+(x=r[9+a])*c+(S=r[10+a])*p+(w=r[11+a])*_,e[9+i]=n*o+x*u+S*f+w*y,e[10+i]=n*l+x*d+S*g+w*b,e[11+i]=n*h+x*m+S*v+w*t,e[12+i]=(n=r[12+a])*s+(x=r[13+a])*c+(S=r[14+a])*p+(w=r[15+a])*_,e[13+i]=n*o+x*u+S*f+w*y,e[14+i]=n*l+x*d+S*g+w*b,e[15+i]=n*h+x*m+S*v+w*t,e},e.mul3=function(e,t,r,i){return Wy(e,Wy(e,t,r),i)},e.translate=function(e,t,r){var i,n,a,s,o,l,h,c,u,d,m,p,f=r[0],g=r[1],r=r[2];return t===e?(e[12]=t[0]*f+t[4]*g+t[8]*r+t[12],e[13]=t[1]*f+t[5]*g+t[9]*r+t[13],e[14]=t[2]*f+t[6]*g+t[10]*r+t[14],e[15]=t[3]*f+t[7]*g+t[11]*r+t[15]):(i=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],m=t[10],p=t[11],e[0]=i,e[1]=n,e[2]=a,e[3]=s,e[4]=o,e[5]=l,e[6]=h,e[7]=c,e[8]=u,e[9]=d,e[10]=m,e[11]=p,e[12]=i*f+o*g+u*r+t[12],e[13]=n*f+l*g+d*r+t[13],e[14]=a*f+h*g+m*r+t[14],e[15]=s*f+c*g+p*r+t[15]),e},e.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},e.setTranslation=function(e,t){return e[12]=t[0],e[13]=t[1],e[14]=t[2],e},e.setAxes=function(e,t,r,i){return e[0]=r[0],e[4]=r[1],e[8]=r[2],e[1]=i[0],e[5]=i[1],e[9]=i[2],e[2]=t[0],e[6]=t[1],e[10]=t[2],e},e.rotate=function(e,t,r,i){var n=i[0],a=i[1],i=i[2],s=Math.sqrt(n*n+a*a+i*i);if(Math.abs(s)<fy)return By();n*=s=1/s,a*=s,i*=s;var s=Math.sin(r),o=1-(r=Math.cos(r)),l=t[0],h=t[1],c=t[2],u=t[3],d=t[4],m=t[5],p=t[6],f=t[7],g=t[8],v=t[9],_=t[10],y=t[11],b=n*n*o+r,x=a*n*o+i*s,S=i*n*o-a*s,w=n*a*o-i*s,A=a*a*o+r,M=i*a*o+n*s,C=n*i*o+a*s,a=a*i*o-n*s,n=i*i*o+r;return e[0]=l*b+d*x+g*S,e[1]=h*b+m*x+v*S,e[2]=c*b+p*x+_*S,e[3]=u*b+f*x+y*S,e[4]=l*w+d*A+g*M,e[5]=h*w+m*A+v*M,e[6]=c*w+p*A+_*M,e[7]=u*w+f*A+y*M,e[8]=l*C+d*a+g*n,e[9]=h*C+m*a+v*n,e[10]=c*C+p*a+_*n,e[11]=u*C+f*a+y*n,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},e.fromRotation=qy,e.scale=function(e,t,r){var i=r[0],n=r[1],r=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},e.scaleUniformly=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},e.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.fromUniformScaling=function(e,t){return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.fromMat3=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[4]=t[3],e[5]=t[4],e[6]=t[5],e[8]=t[6],e[9]=t[7],e[10]=t[8],e},e.compose=function(e,t,r,i){var[r,n,a,s]=r,o=r*(c=r+r),l=r*(u=n+n),r=r*(d=a+a),h=n*u,n=n*d,a=a*d,c=s*c,u=s*u,s=s*d,[d,i,m]=i;return e[0]=(1-(h+a))*d,e[1]=(l+s)*d,e[2]=(r-u)*d,e[3]=0,e[4]=(l-s)*i,e[5]=(1-(o+a))*i,e[6]=(n+c)*i,e[7]=0,e[8]=(r+u)*m,e[9]=(n-c)*m,e[10]=(1-(o+h))*m,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e};let h=[0,0,0],c=Fy();function Xy(e){var t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],m=e[12],p=e[13],f=e[14],e=e[15];return(t*s-r*a)*(u*e-d*f)-(t*o-i*a)*(c*e-d*p)+(t*l-n*a)*(c*f-u*p)+(r*o-i*s)*(h*e-d*m)-(r*l-n*s)*(h*f-u*m)+(i*l-n*o)*(h*p-c*m)}e.decompose=function(e,t,r,i){let n=b.magnitude(b.set(h,e[0],e[1],e[2]));var a=b.magnitude(b.set(h,e[4],e[5],e[6])),s=b.magnitude(b.set(h,e[8],e[9],e[10])),t=(Xy(e)<0&&(n=-n),t[0]=e[12],t[1]=e[13],t[2]=e[14],Hy(c,e),1/n),o=1/a,l=1/s;return c[0]*=t,c[1]*=t,c[2]*=t,c[4]*=o,c[5]*=o,c[6]*=o,c[8]*=l,c[9]*=l,c[10]*=l,$y(r,c),i[0]=n,i[1]=a,i[2]=s,e},e.makeTable=function(r){let i="";for(let t=0;t<4;t++){for(let e=0;e<4;e++)i+=r[4*e+t].toString(),e<3&&(i+=" ");t<3&&(i+="\n")}return i},e.determinant=Xy,e.isRotationAndTranslation=function(e,t){var t=void 0!==t?t:fy,r=e[0],i=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],m=e[11];return!!(gy(e=e[15],1,t)&&gy(a,0,t)&&gy(h,0,t)&&gy(m,0,t))&&!!gy(e=Math.abs(r*(o*d-l*u)-i*(s*d-l*c)+n*(s*u-o*c)),1,t)},e.isTranslationAndUniformScaling=function(e,t){return e=e,t=void 0!==t?t:fy,r=e[0],gy(e[1],0,t)&&gy(e[2],0,t)&&gy(e[3],0,t)&&gy(e[4],0,t)&&gy(e[5],r,t)&&gy(e[6],0,t)&&gy(e[7],0,t)&&gy(e[8],0,t)&&gy(e[9],0,t)&&gy(e[10],r,t)&&gy(e[11],0,t)&&gy(e[15],1,t);var r},e.fromQuat=function(e,t){var r=t[0],i=t[1],n=(l=t[2])+l,r=r*(h=r+r),a=i*h,i=i*(c=i+i),s=l*h,o=l*c,l=l*n,h=(t=t[3])*h,c=t*c,t=t*n;return e[0]=1-i-l,e[1]=a+t,e[2]=s-c,e[3]=0,e[4]=a-t,e[5]=1-r-l,e[6]=o+h,e[7]=0,e[8]=s+c,e[9]=o-h,e[10]=1-r-i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.fromEuler=function(e,t,r){var i,n,a,s,o=t[0],l=t[1],t=t[2],h=Math.cos(o),o=Math.sin(o),c=Math.cos(l),l=Math.sin(l),u=Math.cos(t),t=Math.sin(t);return"XYZ"===r?(n=h*u,a=h*t,s=o*u,i=o*t,e[0]=c*u,e[4]=-c*t,e[8]=l,e[1]=a+s*l,e[5]=n-i*l,e[9]=-o*c,e[2]=i-n*l,e[6]=s+a*l,e[10]=h*c):"YXZ"===r?(i=c*t,n=l*u,e[0]=(s=c*u)+(a=l*t)*o,e[4]=n*o-i,e[8]=h*l,e[1]=h*t,e[5]=h*u,e[9]=-o,e[2]=i*o-n,e[6]=a+s*o,e[10]=h*c):"ZXY"===r?(i=c*t,n=l*u,e[0]=(a=c*u)-(s=l*t)*o,e[4]=-h*t,e[8]=n+i*o,e[1]=i+n*o,e[5]=h*u,e[9]=s-a*o,e[2]=-h*l,e[6]=o,e[10]=h*c):"ZYX"===r?(i=h*u,n=h*t,s=o*u,a=o*t,e[0]=c*u,e[4]=s*l-n,e[8]=i*l+a,e[1]=c*t,e[5]=a*l+i,e[9]=n*l-s,e[2]=-l,e[6]=o*c,e[10]=h*c):"YZX"===r?(a=h*c,i=h*l,n=o*c,s=o*l,e[0]=c*u,e[4]=s-a*t,e[8]=n*t+i,e[1]=t,e[5]=h*u,e[9]=-o*u,e[2]=-l*u,e[6]=i*t+n,e[10]=a-s*t):"XZY"===r&&(i=h*c,n=h*l,a=o*c,s=o*l,e[0]=c*u,e[4]=-t,e[8]=l*u,e[1]=i*t+s,e[5]=h*u,e[9]=n*t-a,e[2]=a*t-n,e[6]=o*u,e[10]=s*t+i),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},e.perspective=function(e,t,r,i,n,a,s){var o=2*a/(i-n),l=(r+t)/(r-t),i=(i+n)/(i-n),n=-(s+a)/(s-a),s=-2*s*a/(s-a);return e[0]=2*a/(r-t),e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=l,e[9]=i,e[10]=n,e[11]=-1,e[12]=0,e[13]=0,e[14]=s,e[15]=0,e},e.ortho=function(e,t,r,i,n,a,s){var o=1/(r-t),l=1/(i-n),h=1/(s-a),r=(r+t)*o,t=(i+n)*l,i=(s+a)*h;return e[0]=2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-2*h,e[11]=0,e[12]=-r,e[13]=-t,e[14]=-i,e[15]=1,e},e.lookAt=function(e,t,r,i){let n,a,s,o,l,h,c,u,d,m;var p=t[0],f=t[1],t=t[2],g=i[0],v=i[1],i=i[2],_=r[0],y=r[1],r=r[2];return Math.abs(p-_)<fy&&Math.abs(f-y)<fy&&Math.abs(t-r)<fy?Uy(e):(c=p-_,u=f-y,d=t-r,c*=m=1/Math.sqrt(c*c+u*u+d*d),u*=m,d*=m,n=v*d-i*u,a=i*c-g*d,s=g*u-v*c,(m=Math.sqrt(n*n+a*a+s*s))?(m=1/m,n*=m,a*=m,s*=m):(n=0,a=0,s=0),o=u*s-d*a,l=d*n-c*s,h=c*a-u*n,(m=Math.sqrt(o*o+l*l+h*h))?(m=1/m,o*=m,l*=m,h*=m):(o=0,l=0,h=0),e[0]=n,e[1]=o,e[2]=c,e[3]=0,e[4]=a,e[5]=l,e[6]=u,e[7]=0,e[8]=s,e[9]=h,e[10]=d,e[11]=0,e[12]=-(n*p+a*f+s*t),e[13]=-(o*p+l*f+h*t),e[14]=-(c*p+u*f+d*t),e[15]=1,e)},e.targetTo=function(e,t,r,i){var n=t[0],a=t[1],t=t[2],s=i[0],o=i[1],i=i[2];let l=n-r[0],h=a-r[1],c=t-r[2],u=l*l+h*h+c*c,d=(0<u&&(u=1/Math.sqrt(u),l*=u,h*=u,c*=u),o*c-i*h),m=i*l-s*c,p=s*h-o*l;return 0<(u=d*d+m*m+p*p)&&(u=1/Math.sqrt(u),d*=u,m*=u,p*=u),e[0]=d,e[1]=m,e[2]=p,e[3]=0,e[4]=h*p-c*m,e[5]=c*d-l*p,e[6]=l*m-h*d,e[7]=0,e[8]=l,e[9]=h,e[10]=c,e[11]=0,e[12]=n,e[13]=a,e[14]=t,e[15]=1,e},e.fromPermutation=function(t,r){zy(t);for(let e=0;e<4;e++){var i=r[e];Gy(t,e,i,1)}return t},e.getMaxScaleOnAxis=function(e){var t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return Math.sqrt(Math.max(t,e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))};var ic,t=[0,1,0],u=[0,0,1];e.rotX90=qy(Fy(),90*ky,ic=[1,0,0]),e.rotX180=qy(Fy(),180*ky,ic),e.rotY90=qy(Fy(),90*ky,t),e.rotY180=qy(Fy(),180*ky,t),e.rotY270=qy(Fy(),270*ky,t),e.rotZ90=qy(Fy(),90*ky,u),e.rotZ180=qy(Fy(),180*ky,u),e.rotXY90=Wy(Fy(),e.rotX90,e.rotY90),e.rotZY90=Wy(Fy(),e.rotZ90,e.rotY90),e.rotZYZ90=Wy(Fy(),e.rotZY90,e.rotZ90),e.rotZ90X180=Wy(Fy(),e.rotZ90,e.rotX180),e.rotY90Z180=Wy(Fy(),e.rotY90,e.rotZ180),e.id=By()}function Yy(){return Yy.zero()}{var p=Yy=Yy||{};function Ky(){var e=[0,0,0,0,0,0,0,0,0];return e}function Zy(){var e=Ky();return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Qy(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}p.zero=Ky,p.identity=Zy,p.setIdentity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},p.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3],t[r+4]=e[4],t[r+5]=e[5],t[r+6]=e[6],t[r+7]=e[7],t[r+8]=e[8],t},p.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],e[4]=t[r+4],e[5]=t[r+5],e[6]=t[r+6],e[7]=t[r+7],e[8]=t[r+8],e},p.fromColumns=function(e,t,r,i){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=i[0],e[7]=i[1],e[8]=i[2],e},p.fromMat4=Qy;let i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r=(p.fromEuler=function(e,t,r){return Ny.fromEuler(i,t,r),Qy(e,i)},p.create=function(e,t,r,i,n,a,s,o,l){var h=Ky();return h[0]=e,h[1]=t,h[2]=r,h[3]=i,h[4]=n,h[5]=a,h[6]=s,h[7]=o,h[8]=l,h},Zy());function Jy(t,r,i){for(let e=0;e<9;e++)if(Math.abs(t[e]-r[e])>i)return!1;return!0}function eb(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function tb(e,t){var r,i,n;return e===t?(r=t[1],i=t[2],n=t[5],e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=n):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e}function rb(e,t){var r=t[0],i=t[1],n=t[2],a=t[3],s=t[4],o=t[5],l=t[6],h=t[7],c=t[8],u=c*s-o*h,d=-c*a+o*l,m=h*a-s*l,p=r*u+i*d+n*m;return p?(e[0]=u*(p=1/p),e[1]=(-c*i+n*h)*p,e[2]=(o*i-n*s)*p,e[3]=d*p,e[4]=(c*r-n*l)*p,e[5]=(-o*r+n*a)*p,e[6]=m*p,e[7]=(-h*r+i*l)*p,e[8]=(s*r-i*a)*p):console.warn("non-invertible matrix.",t),e}function ib(e){var t=e[0],r=e[3],i=e[4],n=e[5],a=e[6],s=e[7],o=e[8];return t*(o*i-n*s)+e[1]*(-o*r+n*a)+e[2]*(s*r-i*a)}function nb(e){return e[0]+e[4]+e[8]}function ab(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function sb(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}p.isIdentity=function(e,t){return Jy(e,r,void 0===t?fy:t)},p.hasNaN=function(t){for(let e=0;e<9;e++)if(isNaN(t[e]))return!0;return!1},p.clone=function(e){return eb(Ky(),e)},p.areEqual=Jy,p.setValue=function(e,t,r,i){e[3*r+t]=i},p.getValue=function(e,t,r){return e[3*r+t]},p.copy=eb,p.transpose=tb,p.invert=rb,p.symmtricFromUpper=function(e,t){return e===t?(e[3]=t[1],e[6]=t[2],e[7]=t[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[1],e[4]=t[4],e[5]=t[5],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e},p.symmtricFromLower=function(e,t){return e===t?(e[1]=t[3],e[2]=t[6],e[5]=t[7]):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[3],e[4]=t[4],e[5]=t[7],e[6]=t[6],e[7]=t[7],e[8]=t[8]),e},p.determinant=ib,p.trace=nb,p.sub=ab,p.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e},p.mul=function(e,t,r){var i=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],h=t[6],c=t[7],t=t[8],u=r[0],d=r[1],m=r[2],p=r[3],f=r[4],g=r[5],v=r[6],_=r[7],r=r[8];return e[0]=u*i+d*s+m*h,e[1]=u*n+d*o+m*c,e[2]=u*a+d*l+m*t,e[3]=p*i+f*s+g*h,e[4]=p*n+f*o+g*c,e[5]=p*a+f*l+g*t,e[6]=v*i+_*s+r*h,e[7]=v*n+_*o+r*c,e[8]=v*a+_*l+r*t,e},p.subScalar=function(e,t,r){return e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r,e[3]=t[3]-r,e[4]=t[4]-r,e[5]=t[5]-r,e[6]=t[6]-r,e[7]=t[7]-r,e[8]=t[8]-r,e},p.addScalar=function(e,t,r){return e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r,e[3]=t[3]+r,e[4]=t[4]+r,e[5]=t[5]+r,e[6]=t[6]+r,e[7]=t[7]+r,e[8]=t[8]+r,e},p.mulScalar=sb;let o=Math.PI/3,l=Ky(),s=(p.symmetricEigenvalues=function(e,t){var r,i,n,a,s=t[1]*t[1]+t[2]*t[2]+t[5]*t[5];return 0==s?(e[0]=t[0],e[1]=t[4],e[2]=t[8]):(r=nb(t)/3,i=t[0]-r,n=t[4]-r,a=t[8]-r,i=Math.sqrt((i*i+n*n+a*a+2*s)/6),sb(l,p.Identity,r),ab(l,t,l),sb(l,l,1/i),a=(n=ib(l)/2)<=-1?o:1<=n?0:Math.acos(n)/3,e[0]=r+2*i*Math.cos(a),e[2]=r+2*i*Math.cos(a+2*o),e[1]=3*r-e[0]-e[2]),e},[.1,0,0]),h=[.1,0,0],c=[.1,0,0],u=[.1,0,0],d=[.1,0,0],m=[.1,0,0];p.eigenvector=function(e,t,r){b.set(s,t[0]-r,t[1],t[2]),b.set(h,t[1],t[4]-r,t[5]),b.set(c,t[2],t[5],t[8]-r),b.cross(u,s,h),b.cross(d,s,c),b.cross(m,h,c);var t=b.dot(u,u),r=b.dot(d,d),i=b.dot(m,m);let n=t,a=0;return r>n&&(n=r,a=1),0===(a=i>n?2:a)?b.scale(e,u,1/Math.sqrt(t)):1===a?b.scale(e,d,1/Math.sqrt(r)):b.scale(e,m,1/Math.sqrt(i)),e},p.directionTransform=function(e,t){return Qy(e,t),rb(e,e),tb(e,e),e},p.Identity=Zy(),p.innerProduct=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]+e[4]*t[4]+e[5]*t[5]+e[6]*t[6]+e[7]*t[7]+e[8]*t[8]}}function ob(){return ob.zero()}function lb(){var e=[0,0];return e}function hb(){return hb.zero()}function cb(){var e=[0,0,0,0];return e}function ub(e,t){return e[0]=t.center[0],e[1]=t.center[1],e[2]=t.center[2],e[3]=t.radius,e}function db(){throw new Error("unreachable")}function mb(){return mb.zero()}(t=ob=ob||{}).zero=lb,t.clone=function(e){var t=lb();return t[0]=e[0],t[1]=e[1],t},t.create=function(e,t){var r=lb();return r[0]=e,r[1]=t,r},t.hasNaN=function(e){return isNaN(e[0])||isNaN(e[1])},t.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t},t.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},t.set=function(e,t,r){return e[0]=t,e[1]=r,e},t.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},t.sub=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e},t.mul=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e},t.div=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e},t.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},t.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},t.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},t.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},t.distance=function(e,t){var r=t[0]-e[0],t=t[1]-e[1];return Math.sqrt(r*r+t*t)},t.squaredDistance=function(e,t){var r=t[0]-e[0];return r*r+(t=t[1]-e[1])*t},t.magnitude=function(e){var t=e[0],e=e[1];return Math.sqrt(t*t+e*e)},t.squaredMagnitude=function(e){var t=e[0];return t*t+(e=e[1])*e},t.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},t.areEqual=function(e,t){return e[0]===t[0]&&e[1]===t[1]},t.toString=function(e,t){return`[${e[0].toPrecision(t)} ${e[1].toPrecision(t)}}]`},(u=hb=hb||{}).zero=cb,u.clone=function(e){var t=cb();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},u.create=function(e,t,r,i){var n=cb();return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n},u.fromSphere=ub,u.ofSphere=function(e){return ub(cb(),e)},u.hasNaN=function(e){return isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(e[3])},u.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3],t},u.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],e},u.toVec3Array=function(e,t,r){t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2]},u.fromVec3Array=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=0,e},u.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},u.set=function(e,t,r,i,n){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e},u.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},u.distance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2],t=t[3]-e[3];return Math.sqrt(r*r+i*i+n*n+t*t)},u.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[4]=t[4]*r,e},u.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},u.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},u.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},u.squaredDistance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return r*r+i*i+n*n+(t=t[3]-e[3])*t},u.norm=function(e){var t=e[0],r=e[1],i=e[2],e=e[3];return Math.sqrt(t*t+r*r+i*i+e*e)},u.squaredNorm=function(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i+(e=e[3])*e},u.transformMat4=function(e,t,r){var i=t[0],n=t[1],a=t[2],t=t[3];return e[0]=r[0]*i+r[4]*n+r[8]*a+r[12]*t,e[1]=r[1]*i+r[5]*n+r[9]*a+r[13]*t,e[2]=r[2]*i+r[6]*n+r[10]*a+r[14]*t,e[3]=r[3]*i+r[7]*n+r[11]*a+r[15]*t,e},u.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},u.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},u.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},u.equals=function(e,t){var r=e[0],i=e[1],n=e[2],e=e[3],a=t[0],s=t[1],o=t[2],t=t[3];return Math.abs(r-a)<=fy*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-s)<=fy*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=fy*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(e-t)<=fy*Math.max(1,Math.abs(e),Math.abs(t))},u.toString=function(e,t){return`[${e[0].toPrecision(t)} ${e[1].toPrecision(t)} ${e[2].toPrecision(t)}  ${e[3].toPrecision(t)}]`};{var e;function pb(){var e=[0,0,0,0];return e}function fb(){var e=pb();return e[3]=1,e}function gb(e,t,r){r*=.5;var i=Math.sin(r);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(r),e}function vb(e,t,r,i){var n=t[0],a=t[1],s=t[2],t=t[3];let o=r[0],l=r[1],h=r[2],c=r[3],u,d,m,p,f;return(d=n*o+a*l+s*h+t*c)<0&&(d=-d,o=-o,l=-l,h=-h,c=-c),f=1e-6<1-d?(u=Math.acos(d),m=Math.sin(u),p=Math.sin((1-i)*u)/m,Math.sin(i*u)/m):(p=1-i,i),e[0]=p*n+f*o,e[1]=p*a+f*l,e[2]=p*s+f*h,e[3]=p*t+f*c,e}function _b(t,r){var i=r[0]+r[4]+r[8];let n;if(0<i)n=Math.sqrt(i+1),t[3]=.5*n,n=.5/n,t[0]=(r[5]-r[7])*n,t[1]=(r[6]-r[2])*n,t[2]=(r[1]-r[3])*n;else{let e=0;r[4]>r[0]&&(e=1);var i=((e=r[8]>r[3*e+e]?2:e)+1)%3,a=(e+2)%3;n=Math.sqrt(r[3*e+e]-r[3*i+i]-r[3*a+a]+1),t[e]=.5*n,n=.5/n,t[3]=(r[3*i+a]-r[3*a+i])*n,t[i]=(r[3*i+e]+r[3*e+i])*n,t[a]=(r[3*a+e]+r[3*e+a])*n}return t}(e=mb=mb||{}).zero=pb,e.identity=fb,e.setIdentity=function(e){e[0]=0,e[1]=0,e[2]=0,e[3]=1},e.hasNaN=function(e){return isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(e[3])},e.create=function(e,t,r,i){var n=fb();return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n},e.setAxisAngle=gb,e.getAxisAngle=function(e,t){var r=2*Math.acos(t[3]),i=Math.sin(r/2);return 0!==i?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),r},e.multiply=function(e,t,r){var i=t[0],n=t[1],a=t[2],t=t[3],s=r[0],o=r[1],l=r[2],r=r[3];return e[0]=i*r+t*s+n*l-a*o,e[1]=n*r+t*o+a*s-i*l,e[2]=a*r+t*l+i*o-n*s,e[3]=t*r-i*s-n*o-a*l,e},e.rotateX=function(e,t,r){r*=.5;var i=t[0],n=t[1],a=t[2],t=t[3],s=Math.sin(r),r=Math.cos(r);return e[0]=i*r+t*s,e[1]=n*r+a*s,e[2]=a*r-n*s,e[3]=t*r-i*s,e},e.rotateY=function(e,t,r){r*=.5;var i=t[0],n=t[1],a=t[2],t=t[3],s=Math.sin(r),r=Math.cos(r);return e[0]=i*r-a*s,e[1]=n*r+t*s,e[2]=a*r+i*s,e[3]=t*r-n*s,e},e.rotateZ=function(e,t,r){r*=.5;var i=t[0],n=t[1],a=t[2],t=t[3],s=Math.sin(r),r=Math.cos(r);return e[0]=i*r+n*s,e[1]=n*r-i*s,e[2]=a*r+t*s,e[3]=t*r-a*s,e},e.calculateW=function(e,t){var r=t[0],i=t[1],t=t[2];return e[0]=r,e[1]=i,e[2]=t,e[3]=Math.sqrt(Math.abs(1-r*r-i*i-t*t)),e},e.slerp=vb,e.invert=function(e,t){var r=t[0],i=t[1],n=t[2],a=(a=r*r+i*i+n*n+(t=t[3])*t)?1/a:0;return e[0]=-r*a,e[1]=-i*a,e[2]=-n*a,e[3]=t*a,e},e.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},e.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},e.fromMat3=_b,e.fromEuler=function(e,t,r){var[t,i,n]=t,a=Math.cos(t/2),s=Math.cos(i/2),o=Math.cos(n/2),l=Math.sin(t/2),h=Math.sin(i/2),c=Math.sin(n/2);switch(r){case"XYZ":e[0]=l*s*o+a*h*c,e[1]=a*h*o-l*s*c,e[2]=a*s*c+l*h*o,e[3]=a*s*o-l*h*c;break;case"YXZ":e[0]=l*s*o+a*h*c,e[1]=a*h*o-l*s*c,e[2]=a*s*c-l*h*o,e[3]=a*s*o+l*h*c;break;case"ZXY":e[0]=l*s*o-a*h*c,e[1]=a*h*o+l*s*c,e[2]=a*s*c+l*h*o,e[3]=a*s*o-l*h*c;break;case"ZYX":e[0]=l*s*o-a*h*c,e[1]=a*h*o+l*s*c,e[2]=a*s*c-l*h*o,e[3]=a*s*o+l*h*c;break;case"YZX":e[0]=l*s*o+a*h*c,e[1]=a*h*o+l*s*c,e[2]=a*s*c-l*h*o,e[3]=a*s*o-l*h*c;break;case"XZY":e[0]=l*s*o-a*h*c,e[1]=a*h*o-l*s*c,e[2]=a*s*c+l*h*o,e[3]=a*s*o+l*h*c;break;default:db()}return e};let n=[0,0,0];function yb(e,t){var r=t[0],i=t[1],n=t[2],t=t[3],a=r*r+i*i+n*n+t*t;return 0<a&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=n*a,e[3]=t*a),e}e.fromUnitVec3=function(e,t,r){let i=b.dot(t,r)+1;return i<fy?(i=0,Math.abs(t[0])>Math.abs(t[2])?b.set(n,-t[1],t[0],0):b.set(n,0,-t[2],t[1])):b.cross(n,t,r),e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=i,yb(e,e),e},e.clone=function(e){var t=pb();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},e.toArray=function(e,t,r){return t[r+0]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3],t},e.fromArray=function(e,t,r){return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],e},e.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},e.set=function(e,t,r,i,n){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e},e.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},e.equals=function(e,t){var r=e[0],i=e[1],n=e[2],e=e[3],a=t[0],s=t[1],o=t[2],t=t[3];return Math.abs(r-a)<=fy*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-s)<=fy*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=fy*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(e-t)<=fy*Math.max(1,Math.abs(e),Math.abs(t))},e.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},e.normalize=yb;let a=[0,0,0],s=[1,0,0],o=[0,1,0],l=(e.rotationTo=function(e,t,r){var i=b.dot(t,r);return i<-.999999?(b.cross(a,s,t),b.magnitude(a)<1e-6&&b.cross(a,o,t),b.normalize(a,a),gb(e,a,Math.PI),e):.999999<i?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(b.cross(a,t,r),e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=1+i,yb(e,e))},pb()),h=pb(),c=(e.sqlerp=function(e,t,r,i,n,a){return vb(l,t,n,a),vb(h,r,i,a),vb(e,l,h,2*a*(1-a)),e},[0,0,0,0,0,0,0,0,0]);e.setAxes=function(e,t,r,i){return c[0]=r[0],c[3]=r[1],c[6]=r[2],c[1]=i[0],c[4]=i[1],c[7]=i[2],c[2]=-t[0],c[5]=-t[1],c[8]=-t[2],yb(e,_b(e,c))},e.toString=function(e,t){return`[${e[0].toPrecision(t)} ${e[1].toPrecision(t)} ${e[2].toPrecision(t)}  ${e[3].toPrecision(t)}]`},e.Identity=fb()}function bb(e,t,r){var r=((t,r,e)=>{var i=[];for(let e=0;e<r.length;e++)i[e]=r[r.length-e-1];var n=[1];for(let e=1;e<t.length;e++)n[e]=t[i[e-1]];return{dimensions:t,axisOrderFastToSlow:i,axisOrderSlowToFast:r,accessDimensions:n,defaultCtor:e||Float64Array}})(e,t,r),{get:i,set:n,add:a,dataOffset:s,getCoords:o}=(l=>{var{dimensions:e,axisOrderFastToSlow:t}=l;switch(e.length){case 1:return{get:(e,t)=>e[t],set:(e,t,r)=>e[t]=r,add:(e,t,r)=>e[t]+=r,dataOffset:e=>e,getCoords:(e,t)=>(t[0]=e,t)};case 2:if(0===t[0]&&1===t[1]){let n=e[0];return{get:(e,t,r)=>e[r*n+t],set:(e,t,r,i)=>e[r*n+t]=i,add:(e,t,r,i)=>e[r*n+t]+=i,dataOffset:(e,t)=>t*n+e,getCoords:(e,t)=>(t[0]=e%n,t[1]=Math.floor(e/n),t)}}if(1!==t[0]||0!==t[1])throw new Error("bad axis order");{let n=e[1];return{get:(e,t,r)=>e[t*n+r],set:(e,t,r,i)=>e[t*n+r]=i,add:(e,t,r,i)=>e[t*n+r]+=i,dataOffset:(e,t)=>e*n+t,getCoords:(e,t)=>(t[0]=Math.floor(e/n),t[1]=e%n,t)}}case 3:if(0===t[0]&&1===t[1]&&2===t[2]){let a=e[0],i=e[1],s=a*i;return{get:(e,t,r,i)=>e[t+r*a+i*s],set:(e,t,r,i,n)=>e[t+r*a+i*s]=n,add:(e,t,r,i,n)=>e[t+r*a+i*s]+=n,dataOffset:(e,t,r)=>e+t*a+r*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=e%a,t[1]=r%i,t[2]=Math.floor(r/i),t}}}if(0===t[0]&&2===t[1]&&1===t[2]){let a=e[0],i=e[2],s=a*i;return{get:(e,t,r,i)=>e[t+i*a+r*s],set:(e,t,r,i,n)=>e[t+i*a+r*s]=n,add:(e,t,r,i,n)=>e[t+i*a+r*s]+=n,dataOffset:(e,t,r)=>e+r*a+t*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=e%a,t[1]=Math.floor(r/i),t[2]=r%i,t}}}if(1===t[0]&&0===t[1]&&2===t[2]){let a=e[1],i=e[0],s=a*i;return{get:(e,t,r,i)=>e[r+t*a+i*s],set:(e,t,r,i,n)=>e[r+t*a+i*s]=n,add:(e,t,r,i,n)=>e[r+t*a+i*s]+=n,dataOffset:(e,t,r)=>t+e*a+r*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=r%i,t[1]=e%a,t[2]=Math.floor(r/i),t}}}if(1===t[0]&&2===t[1]&&0===t[2]){let a=e[1],i=e[2],s=a*i;return{get:(e,t,r,i)=>e[r+i*a+t*s],set:(e,t,r,i,n)=>e[r+i*a+t*s]=n,add:(e,t,r,i,n)=>e[r+i*a+t*s]+=n,dataOffset:(e,t,r)=>t+r*a+e*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=Math.floor(r/i),t[1]=e%a,t[2]=r%i,t}}}if(2===t[0]&&0===t[1]&&1===t[2]){let a=e[2],i=e[0],s=a*i;return{get:(e,t,r,i)=>e[i+t*a+r*s],set:(e,t,r,i,n)=>e[i+t*a+r*s]=n,add:(e,t,r,i,n)=>e[i+t*a+r*s]+=n,dataOffset:(e,t,r)=>r+e*a+t*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=r%i,t[1]=Math.floor(r/i),t[2]=e%a,t}}}if(2!==t[0]||1!==t[1]||0!==t[2])throw new Error("bad axis order");{let a=e[2],i=e[1],s=a*i;return{get:(e,t,r,i)=>e[i+r*a+t*s],set:(e,t,r,i,n)=>e[i+r*a+t*s]=n,add:(e,t,r,i,n)=>e[i+r*a+t*s]+=n,dataOffset:(e,t,r)=>r+t*a+e*s,getCoords:(e,t)=>{var r=Math.floor(e/a);return t[0]=Math.floor(r/i),t[1]=r%i,t[2]=e%a,t}}}default:return{get:(e,...t)=>e[xb(l,t)],set:(e,...t)=>e[xb(l,t)]=t[t.length-1],add:(e,...t)=>e[xb(l,t)]+=t[t.length-1],dataOffset:(...e)=>xb(l,e),getCoords:(t,a)=>{{var s,o=a;let{dimensions:r,axisOrderFastToSlow:i}=l,e=r.length,n=t;for(let t=0;t<e;t++){let e=r[i[t]];o[i[t]]=n%e,n=Math.floor(n/e)}return o[i[e+1]]=n,o}}}}})(r);return{rank:e.length,dimensions:e,axisOrderSlowToFast:t,create:(t=>{let r=t.dimensions,i=1;for(let e=0,t=r.length;e<t;e++)i*=r[e];return e=>new(e||t.defaultCtor)(i)})(r),get:i,set:n,add:a,dataOffset:s,getCoords:o}}function xb(t,r){var{accessDimensions:i,axisOrderFastToSlow:n}=t,t=i.length-1;let a=i[t]*r[n[t]];for(let e=t-1;0<=e;e--)a=(a+r[n[e]])*i[e];return a}function Sb(t,r){var i=[];for(let e=0;e<t.length;e++)i[e]=t[r[e]];return i}function wb(e,t,r){let i=t,n=0,a=1;for(45===e.charCodeAt(i)?(a=-1,++i):43===e.charCodeAt(i)&&++i;i<r;i++){var s=e.charCodeAt(i)-48;if(9<s||s<0)return a*n|0;n=10*n+s|0}return a*n}function Ab(e,t,r,i){return 43===t.charCodeAt(r)&&r++,e*Math.pow(10,wb(t,r,i))}function Mb(t,e,r){let i=e,n=1,a=0,s=0,o=1;for(45===t.charCodeAt(i)?(n=-1,++i):43===t.charCodeAt(i)&&++i;i<r;){let e=t.charCodeAt(i)-48;if(!(0<=e&&e<10)){if(-2===e){for(++i;i<r;){if(!(0<=(e=t.charCodeAt(i)-48)&&e<10))return 53===e||21===e?Ab(n*(a+s/o),t,i+1,r):n*(a+s/o);s=10*s+e,o*=10,++i}return n*(a+s/o)}if(53===e||21===e)return Ab(n*a,t,i+1,r);break}a=10*a+e,++i}return n*a}(t=Kv=Kv||{}).create=function(e,t){return{space:e,data:t}},t.Space=bb,t.Data1=function(e){return e},t.Vector=function(e,t){return bb([e],[0],t)},t.ColumnMajorMatrix=function(e,t,r){return bb([e,t],[1,0],r)},t.RowMajorMatrix=function(e,t,r){return bb([e,t],[0,1],r)},t.toMat4=function(r,i,n){if(2!==i.rank)throw new Error("Invalid tensor rank");var e=Math.min(4,i.dimensions[0]),a=Math.min(4,i.dimensions[1]);for(let t=0;t<e;t++)for(let e=0;e<a;e++)Ny.setValue(r,t,e,i.get(n,t,e));return r},t.toMat3=function(r,i,n){if(2!==i.rank)throw new Error("Invalid tensor rank");var e=Math.min(3,i.dimensions[0]),a=Math.min(3,i.dimensions[1]);for(let t=0;t<e;t++)for(let e=0;e<a;e++)Yy.setValue(r,t,e,i.get(n,t,e));return r},t.toVec3=function(t,e,r){if(1!==e.rank)throw new Error("Invalid tensor rank");var i=Math.min(3,e.dimensions[0]);for(let e=0;e<i;e++)t[e]=r[e];return t},t.toVec4=function(t,e,r){if(1!==e.rank)throw new Error("Invalid tensor rank");var i=Math.min(4,e.dimensions[0]);for(let e=0;e<i;e++)t[e]=r[e];return t},t.areEqualExact=function(t,r){var i=t.length;if(i!==r.length)return!1;for(let e=0;e<i;e++)if(t[e]!==r[e])return!1;return!0},t.invertAxisOrder=function(t){var r=[];for(let e=0;e<t.length;e++)r[e]=t[t.length-e-1];return r},t.convertToCanonicalAxisIndicesFastToSlow=function(t){let r=new Int32Array(t.length);for(let e=0;e<t.length;e++)r[t[e]]=e;return e=>Sb(e,r)},t.convertToCanonicalAxisIndicesSlowToFast=function(t){let r=new Int32Array(t.length);for(let e=0;e<t.length;e++)r[t[t.length-e-1]]=e;return e=>Sb(e,r)};{var u=Zv=Zv||{};let n;function Cb(e,t=Qv.float){return{"@type":"tensor",T:e.create(),space:e,valueType:"tensor",baseType:t}}function Tb(e,t){return Pb(t.T,e,t,1)}function Eb(e){return Ib(e)}(Qv=n=u.Schema||(u.Schema={})).str={"@type":"str",T:"",valueType:"str"},Qv.ustr={"@type":"str",T:"",valueType:"str",transform:"uppercase"},Qv.lstr={"@type":"str",T:"",valueType:"str",transform:"lowercase"},Qv.int={"@type":"int",T:0,valueType:"int"},Qv.coord={"@type":"coord",T:0,valueType:"float"},Qv.float={"@type":"float",T:0,valueType:"float"},Qv.Str=function(e){var t;return{"@type":"str",T:null!=(t=null==e?void 0:e.defaultValue)?t:"",transform:null==e?void 0:e.transform,valueType:"str"}},Qv.Int=function(e=0){return{"@type":"int",T:e,valueType:"int"}},Qv.Float=function(e=0){return{"@type":"float",T:e,valueType:"float"}},Qv.Tensor=Cb,Qv.Vector=function(e,t=Qv.float){return Cb(Kv.Vector(e,"int"===t["@type"]?Int32Array:Float64Array),t)},Qv.Matrix=function(e,t,r=Qv.float){return Cb(Kv.ColumnMajorMatrix(e,t,"int"===r["@type"]?Int32Array:Float64Array),r)},Qv.Aliased=function(e){return e},Qv.List=function(e,t,r=[]){return{"@type":"list",T:r,separator:e,itemParse:t,valueType:"list"}},u.is=function(e){return!!e&&!!e.schema&&!!e.value},u.ValueKind={Present:0,NotPresent:1,Unknown:2},u.Undefined=Tb,u.ofConst=function(e,t,r){return Pb(e,t,r,0)},u.ofLambda=Eb,u.range=function(t,e){return Eb({value:e=>e+t,rowCount:Math.max(e-t+1,0),schema:n.int})},u.ofArray=Rb,u.ofIntArray=function(e){return Rb({array:e,schema:n.int})},u.ofFloatArray=function(e){return Rb({array:e,schema:n.float})},u.ofStringArray=function(e){return Rb({array:e,schema:n.str})},u.ofStringAliasArray=function(e){return Rb({array:e,schema:n.Aliased(n.str)})},u.ofStringListArray=function(e,t=","){return Rb({array:e,schema:n.List(t,e=>e)})},u.ofIntTokens=function(e){let{count:t,data:r,indices:i}=e;return Ib({value:e=>wb(r,i[2*e],i[2*e+1])||0,rowCount:t,schema:n.int})},u.ofFloatTokens=function(e){let{count:t,data:r,indices:i}=e;return Ib({value:e=>Mb(r,i[2*e],i[2*e+1])||0,rowCount:t,schema:n.float})},u.ofStringTokens=function(e){let{count:t,data:r,indices:i}=e;return Ib({value:e=>{e=r.substring(i[2*e],i[2*e+1]);return"."===e||"?"===e?"":e},rowCount:t,schema:n.str})},u.window=function(e,t,r){return t=t,r=r,(e=e).isDefined?0===t&&r===e.rowCount?e:(e.__array&&my(e.__array)?(e,t,r)=>{let i=py(e.__array,{start:t,end:r}),n=e.valueKind;return Rb({array:i,schema:e.schema,valueKind:e=>n(t+e)})}:(e,i,t)=>{let n=e.value,r=e.valueKind,a=e.areValuesEqual,s=0===i?n:e=>n(e+i),o=t-i;return{schema:e.schema,__array:void 0,isDefined:e.isDefined,rowCount:o,value:s,valueKind:0===i?r:e=>r(e+i),toArray:e=>{var r=uy(o,e).array;for(let e=0,t=r.length;e<t;e++)r[e]=n(e+i);return r},areValuesEqual:0===i?a:(e,t)=>a(e+i,t+i)}})(e,t,r):Zv.Undefined(r-t,e.schema)},u.view=function(e,a,s=!0){if(0===e.rowCount)return e;if(s&&((r,e)=>{if(r.length===e){for(let e=0,t=r.length;e<t;e++)if(r[e]!==e)return;return 1}})(a,e.rowCount))return e;if(e.__array&&typeof e.value(0)==typeof e.__array[0]){var s=e,r=a,i=s.__array,n=new i.constructor(r.length);for(let e=0,t=r.length;e<t;e++)n[e]=i[r[e]];let t=s.valueKind;return Rb({array:n,schema:s.schema,valueKind:e=>t(r[e])})}{var s=e,o=a;let i=s.value,t=s.valueKind,r=s.areValuesEqual,n=o.length;return{schema:s.schema,__array:void 0,isDefined:s.isDefined,rowCount:n,value:e=>i(o[e]),valueKind:e=>t(o[e]),toArray:e=>{var r=uy(n,e).array;for(let e=0,t=r.length;e<t;e++)r[e]=i(o[e]);return r},areValuesEqual:(e,t)=>r(o[e],o[t])}}},u.createFirstIndexMap=function(e){var r=e,i=new Map;for(let e=0,t=r.rowCount;e<t;e++){var n=r.value(e);i.has(n)||i.set(r.value(e),e)}return i},u.createIndexer=function(e){{var i=e;let r=new Map;for(let e=0,t=i.rowCount;e<t;e++){var n=i.value(e);r.has(n)||r.set(i.value(e),e)}return e=>r.has(e)?r.get(e):-1}},u.mapToArray=function(e,t,r){var i=e,n=t,a=new(r||Array)(i.rowCount);for(let e=0,t=i.rowCount;e<t;e++)a[e]=n(i.value(e));return a},u.areEqual=function(e,t){if(e!==t){if(e.rowCount!==t.rowCount||e.isDefined!==t.isDefined||e.schema.valueType!==t.schema.valueType)return!1;if(e.__array&&t.__array){var r=e,i=t,n=r.__array,a=i.__array;for(let e=0,t=r.rowCount;e<t;e++)if(n[e]!==a[e])return!1}else{var i=e,r=t,s=i.value,o=r.value;for(let e=0,t=i.rowCount;e<t;e++)if(s(e)!==o(e))return!1}}return!0},u.indicesOf=function(r,e){var i=e,n=[],a=r.value;for(let e=0,t=r.rowCount;e<t;e++)i(a(e))&&(n[n.length]=e);return n},u.asArrayColumn=function(e,t){return e.__array?e:e.isDefined?Rb({array:e.toArray({array:t}),schema:e.schema,valueKind:e.valueKind}):Tb(e.rowCount,e.schema)},u.copyToArray=function(r,i,n=0){if(r.isDefined){var a=r.__array;if(a)for(let e=0,t=a.length;e<t;e++)i[n+e]=a[e];else for(let e=0,t=r.rowCount;e<t;e++)i[n+e]=r.value(e)}},u.isIdentity=function(r){for(let e=0,t=r.rowCount;e<t;e++)if(e!==r.value(e))return!1;return!0}}function Pb(i,t,e,r){return{schema:e,__array:void 0,isDefined:0===r,rowCount:t,value:e=>i,valueKind:e=>r,toArray:e=>{var r=uy(t,e).array;for(let e=0,t=r.length;e<t;e++)r[e]=i;return r},areValuesEqual:(e,t)=>!0}}function Ib({value:n,valueKind:e,areValuesEqual:t,rowCount:a,schema:r}){return{schema:r,__array:void 0,isDefined:!0,rowCount:a,value:n,valueKind:e||(e=>0),toArray:e=>{var{array:r,start:i}=uy(a,e);for(let e=0,t=r.length;e<t;e++)r[e]=n(e+i);return r},areValuesEqual:t||((e,t)=>n(e)===n(t))}}function Rb({array:s,schema:e,valueKind:t}){let o=s.length,l=e.T;var r="str"===e.valueType?"lowercase"===e.transform?e=>{e=s[e];return("string"==typeof e?e:""+(null!=e?e:l)).toLowerCase()}:"uppercase"===e.transform?e=>{e=s[e];return("string"==typeof e?e:""+(null!=e?e:l)).toUpperCase()}:e=>{e=s[e];return"string"==typeof e?e:""+(null!=e?e:l)}:e=>s[e],i=my(s);return{schema:e,__array:s,isDefined:!0,rowCount:o,value:r,valueKind:t||(e=>0),toArray:"str"===e.valueType?"lowercase"===e.transform?e=>{var{start:r,end:i}=cy(o,e),n=new(e&&void 0!==e.array?e.array:s.constructor)(i-r);for(let e=0,t=i-r;e<t;e++){var a=s[r+e];n[e]=("string"==typeof a?a:""+(null!=a?a:l)).toLowerCase()}return n}:"uppercase"===e.transform?e=>{var{start:r,end:i}=cy(o,e),n=new(e&&void 0!==e.array?e.array:s.constructor)(i-r);for(let e=0,t=i-r;e<t;e++){var a=s[r+e];n[e]=("string"==typeof a?a:""+(null!=a?a:l)).toUpperCase()}return n}:e=>{var{start:r,end:i}=cy(o,e),n=new(e&&void 0!==e.array?e.array:s.constructor)(i-r);for(let e=0,t=i-r;e<t;e++){var a=s[r+e];n[e]="string"==typeof a?a:""+(null!=a?a:l)}return n}:i?e=>py(s,e):e=>{var{start:r,end:i}=cy(o,e);if(0===r&&i===s.length)return s;var n=new(e&&void 0!==e.array?e.array:s.constructor)(i-r);for(let e=0,t=i-r;e<t;e++)n[e]=s[r+e];return n},areValuesEqual:(e,t)=>s[e]===s[t]}}function Db(e,t,r){return e[t]-e[r]}function Lb(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function Ob(e,t,r,i){var n=r+i>>1;return 0<t(e,r,i)?0<t(e,r,n)?0<t(e,n,i)?n:i:r:0<t(e,i,n)?0<t(e,n,r)?n:r:i}function kb(e,i,n){for(var t=e.parts;i<n;){if(n-i<16){l=o=s=a=r=void 0;var[{data:r,cmp:a,swap:s},o,l]=[e,i,n];for(let t=o+1;t<=l;t++){let e=t-1;for(;e>=o&&0<a(r,e,e+1);)s(r,e,e+1),e-=1}return}{h=void 0;c=void 0;u=void 0;d=void 0;m=void 0;p=void 0;f=void 0;var h=e;var c=i;var u=n;var{cmp:d,swap:m,data:p,parts:h}=h;let t=c+1,r=u;for(m(p,c,Ob(p,d,c,u));0<d(p,r,c);)--r;for(let e=c+1;e<=r;e++){var f=d(p,e,c);if(0<f){for(m(p,e,r),--r;0<d(p,r,c);)--r;e--}else 0===f&&(m(p,e,t),t++)}for(let e=c;e<t;e++)m(p,e,c+r-e);h[0]=r-t+c+1,h[1]=r}u=t[0],h=t[1];u-i<n-h?(kb(e,i,u-1),i=h+1):(kb(e,h+1,n),n=u-1)}}function Nb(e,i,n,a){for(;n<a;){if(a-n<16){l=o=s=r=void 0;var r=e,s=n,o=a;for(let t=s+1;t<=o;t++){var l=r[t];let e=t-1;for(;e>=s&&r[e]>l;)r[e+1]=r[e],e-=1;r[e+1]=l}return}{h=void 0;c=void 0;u=void 0;d=void 0;m=void 0;p=void 0;var h=e;var c=i;var u=n;var d=a;let t=u+1,r=d;Lb(h,u,Ob(h,Db,u,d));for(var m=h[u];h[r]>m;)--r;for(let e=u+1;e<=r;e++){var p=h[e];if(m<p){for(Lb(h,e,r),--r;h[r]>m;)--r;e--}else p===m&&(Lb(h,e,t),++t)}for(let e=u;e<t;e++)Lb(h,e,u+r-e);c[0]=r-t+u+1,c[1]=r}d=i[0],c=i[1];d-n<a-c?(Nb(e,i,n,d-1),n=c+1):(Nb(e,i,c+1,a),a=d-1)}}function Fb(e,t=Db){var r,i;[e,t,r,i=Db]=[e,0,e.length,t],i===Db?Nb(e,[0,0],t,r-1):kb({data:e,cmp:i,swap:Lb,parts:[0,0]},t,r-1)}{var e;(e=Jv=Jv||{}).create=function(e=512){return{current:[],offset:0,capacity:e,chunks:[]}},e.getString=function(e){return(e.chunks.length?(0<e.offset&&(e.chunks[e.chunks.length]=(e.current.length===e.offset?e.current:e.current.slice(0,e.offset)).join("")),e.chunks):e.current.length===e.offset?e.current:e.current.splice(0,e.offset)).join("")},e.getSize=function(t){let r=0;for(var e of t.chunks)r+=e.length;for(let e=0;e<t.offset;e++)r+=t.current[e].length;return r},e.getChunks=function(e){return 0<e.offset&&(e.current.length===e.offset?e.chunks[e.chunks.length]=e.current.join(""):e.chunks[e.chunks.length]=e.current.slice(0,e.offset).join(""),e.offset=0),e.chunks};let r=[];{let t="";for(let e=0;e<512;e++)r[e]=t,t+=" "}function Bb(e,t){0<t&&Ub(e,r[t])}function Ub(e,t){e.offset===e.capacity&&(e.chunks[e.chunks.length]=e.current.join(""),e.offset=0),e.current[e.offset++]=t}e.newline=function(e){Ub(e,"\n")},e.whitespace=Bb,e.whitespace1=function(e){Ub(e," ")},e.write=function(e,t){t&&(e.offset===e.capacity&&(e.chunks[e.chunks.length]=e.current.join(""),e.offset=0),e.current[e.offset++]=t)},e.writeSafe=Ub,e.writePadLeft=function(e,t,r){t?(Bb(e,r-t.length),Ub(e,t)):Bb(e,r)},e.writePadRight=function(e,t,r){var i;t?(i=r-t.length,Ub(e,t),Bb(e,i)):Bb(e,r)},e.writeInteger=function(e,t){Ub(e,""+t)},e.writeIntegerAndSpace=function(e,t){Ub(e,t+" ")},e.writeIntegerPadLeft=function(e,t,r){Bb(e,r-(t=""+t).length),Ub(e,t)},e.writeIntegerPadRight=function(e,t,r){r-=(t=""+t).length,Ub(e,t),Bb(e,r)},e.writeFloat=function(e,t,r){Ub(e,""+Math.round(r*t)/r)},e.writeFloatPadLeft=function(e,t,r,i){t=""+Math.round(r*t)/r,Bb(e,i-t.length),Ub(e,t)},e.writeFloatPadRight=function(e,t,r,i){t=""+Math.round(r*t)/r,r=i-t.length,Ub(e,t),Bb(e,r)}}let zb=(()=>{if("undefined"!=typeof window&&window.performance){let e=window.performance;return()=>e.now()}return"undefined"!=typeof process&&"undefined"!==process.hrtime&&"function"==typeof process.hrtime?()=>{var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:Date.now?()=>Date.now():()=>+new Date})();{var t={};let e="undefined"!=typeof btoa?btoa:e=>Buffer.from(e).toString("base64"),r=[];t.create22=function(){let t=+new Date+zb();for(let e=0;e<16;e++)r[e]=String.fromCharCode((t+255*Math.random())%255|0),t=Math.floor(t/255);return e(r.join("")).replace(/\+/g,"-").replace(/\//g,"_").substr(0,22)},t.createv4=function(){let r=+new Date+zb();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)})},t.is=function(e){return"string"==typeof e}}function Vb(e,t){return e-t}{var u;class UA{has(e){return!1}forEach(e,t){return t}constructor(){this.size=0}}class zA{has(e){return e===this.idx}forEach(e,t){return e(this.idx,t),t}constructor(e){this.idx=e,this.size=1}}class VA{has(e){return e<this.length&&!!this.mask[e]}_forEach(t,r){for(let e=0;e<this.length;e++)this.mask[e]&&t(e,r)}forEach(e,t){return this._forEach(e,t),t}constructor(e,t){this.mask=e,this.size=t,this.length=e.length}}class GA{has(e){return!0}_forEach(t,r){for(let e=0;e<this.size;e++)t(e,r)}forEach(e,t){return this._forEach(e,t),t}constructor(e){this.size=e}}class HA{has(e){return this.set.has(e)}_forEach(e,t){for(var r of this.flatten())e(r,t)}flatten(){if(!this._flat){let t=new Int32Array(this.size),r=0;var e;this.set.forEach(e=>t[r++]=e),e=t,Array.prototype.sort.call(e,Vb),this._flat=t}return this._flat}forEach(e,t){return this._forEach(e,t),t}constructor(e){this.set=e,this._flat=void 0,this.size=e.size}}function Gb(e){return new HA(e)}function Hb(e,t){return new VA(e,t)}(u={always:function(e){return new GA(e)}}).never=new UA,u.ofSet=Gb,u.singleton=function(e){return new zA(e)},u.ofUniqueIndices=function(e){var t,r=e.length;if(0===r)return new UA;if(1===r)return new zA(e[0]);let i=0;for(t of e)t>i&&(i=t);if(r===i)return new GA(r);if(r/i<1/12){var n,a=new Set;for(n of e)a.add(n);return new HA(a)}var s,o=new Int8Array(i+1);for(s of e)o[s]=1;return new VA(o,e.length)},u.ofMask=Hb,u.hasAny=function(e,t){for(var r of t)if(e.has(r))return!0;return!1},u.complement=function(r,e){let i=0,n=0;if(e.forEach(e=>{r.has(e)||(i++,e>n&&(n=e))}),i/n<1/12){let t=new Set;return e.forEach(e=>{r.has(e)||t.add(e)}),Gb(t)}{let t=new Uint8Array(n+1);return e.forEach(e=>{r.has(e)||(t[e]=1)}),Hb(t,i)}}}function $b(e=0,t=Number.MAX_SAFE_INTEGER){let r=e;return()=>{var e=r;return r=(r+1)%t,e}}(e=e_=e_||{}).create=function(e){return{ref:e}},e.set=function(e,t){return e.ref=t,e};let jb=$b(0,2147483647),Wb;function qb(e,t){return e_.set(e,t_.withValue(e.ref,t))}function Xb(e,t,r){var i,n=Object.create(null),a=Object.keys(t);n._rowCount=r.length,n._columns=a,n._schema=t;for(i of a)n[i]=Zv.view(e[i],r);return n}function Yb(t,r){var i=Object.create(null),n=t._columns;for(let e=0;e<n.length;e++){var a=n[e];i[a]=t[a].value(r)}return i}function Kb(e,t){return{name:t,blocks:e}}function Zb(e,r,t,i=[]){return{categoryNames:e,header:t,categories:r,saveFrames:i,getField(e){var[e,t]=e.split(".");return r[e].getField(t||"")}}}function Qb(e,t,r,i){return{rowCount:t,name:e,fieldNames:[...r],getField(e){return i[e]}}}function Jb(e,t){var r=Object.keys(t);return{rowCount:0<r.length?t[r[0]].rowCount:0,name:e,fieldNames:r,getField(e){return t[e]}}}function ex(r){let t=r.length,i=e=>{e=r[e];return e&&"."!==e&&"?"!==e?e:""},n=e=>{e=r[e];return wb(e,0,e.length)||0},a=e=>{e=r[e];return Mb(e,0,e.length)||0};return{__array:void 0,binaryEncoding:void 0,isDefined:!0,rowCount:t,str:i,int:n,float:a,valueKind:e=>{var e=r[e],t=e.length;return 1<t?0:0===t||46===(t=e.charCodeAt(0))?1:63===t?2:0},areValuesEqual:(e,t)=>r[e]===r[t],toStringArray:e=>e?dy(t,i,e):r,toIntArray:e=>dy(t,n,e),toFloatArray:e=>dy(t,a,e)}}function tx(r){let{rowCount:t,valueKind:e,areValuesEqual:i,isDefined:n}=r,a,s,o;switch(r.schema.valueType){case"float":case"int":a=e=>""+r.value(e),s=r.value,o=r.value;break;case"str":a=r.value,s=e=>{e=r.value(e);return wb(e,0,e.length)||0},o=e=>{e=r.value(e);return Mb(e,0,e.length)||0};break;case"list":let t=r.schema.separator;a=e=>r.value(e).join(t),s=e=>NaN,o=e=>NaN;break;default:throw new Error(`unsupported valueType '${r.schema.valueType}'`)}return{__array:void 0,binaryEncoding:void 0,isDefined:n,rowCount:t,str:a,int:s,float:o,valueKind:e,areValuesEqual:i,toStringArray:e=>dy(t,a,e),toIntArray:e=>dy(t,s,e),toFloatArray:e=>dy(t,o,e)}}function rx(){e="undefined"!=typeof window&&window,t="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,i="undefined"!=typeof global&&global;let r=e||i||t;var e,t,i;let n={},a="undefined"!=typeof document?document:void 0,s=1,o;function l(e){delete n[e]}function h(e){var t=n[e],e=(l(e),t),r=e.callback,i=e.args;switch(i.length){case 0:r();break;case 1:r(i[0]);break;case 2:r(i[0],i[1]);break;case 3:r(i[0],i[1],i[2]);break;default:r.apply(void 0,i)}}function c(){let t="setImmediate$"+Math.random()+"$";function e(e){e.source===r&&"string"==typeof e.data&&0===e.data.indexOf(t)&&h(+e.data.slice(t.length))}window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e),o=function(e){window.postMessage(t+e,"*")}}if("undefined"!=typeof process&&"[object process]"==={}.toString.call(process))o=function(e){process.nextTick(function(){h(e)})};else if((()=>{if(r&&r.postMessage&&!r.importScripts){let e=!0;var t=r.onmessage;return r.onmessage=function(){e=!1},r.postMessage("","*"),r.onmessage=t,e}})())c();else if("undefined"!=typeof MessageChannel){let t=new MessageChannel;t.port1.onmessage=function(e){h(e.data)},o=function(e){t.port2.postMessage(e)}}else if(a&&"onreadystatechange"in a.createElement("script")){let r=a.documentElement;o=function(e){let t=a.createElement("script");t.onreadystatechange=function(){h(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}}else o=function(e){setTimeout(h,0,e)};return{setImmediate:function(e,...t){return e={callback:e="function"!=typeof e?new Function(""+e):e,args:t},n[s]=e,o(s),s++},clearImmediate:l}}(t=t_=t_||{}).create=function(e,t){return{id:jb(),version:0,value:e,metadata:t}},t.withValue=function(e,t){return{id:e.id,version:e.version+1,value:t,metadata:e.metadata}},(u=Wb={create:function(e,t){return e_.create(t_.create(e,t))}}).update=qb,u.set=function(e,t){return e_.set(e,t)},u.updateIfChanged=function(e,t){return e.ref.value!==t?qb(e,t):e},(e=r_=r_||{}).is=function(e){return e&&"number"==typeof e._rowCount&&!!e._columns&&!!e._schema},e.pickColumns=function(e,t,r={}){var i,n=Object.create(null),a=Object.keys(e);n._rowCount=t._rowCount,n._columns=a,n._schema=e;for(i of a)if(t[i])n[i]=t[i];else{if(!r[i])throw Error(`Cannot find column '${i}'.`);n[i]=r[i]}return n},e.ofColumns=function(e,t){var r=Object.keys(t);return{_rowCount:t[r[0]].rowCount,_columns:r,_schema:e,...t}},e.ofPartialColumns=function(e,t,r){var i,n=Object.create(null),a=Object.keys(e);n._rowCount=r,n._columns=a,n._schema=e;for(i of a)i in t?n[i]=t[i]:n[i]=Zv.Undefined(r,e[i]);return n},e.ofUndefinedColumns=function(e,t){var r,i=Object.create(null),n=Object.keys(e);i._rowCount=t,i._columns=n,i._schema=e;for(r of n)i[r]=Zv.Undefined(t,e[r]);return i},e.ofRows=function(e,r){var i=Object.create(null),n=r.length,a=Object.keys(e);i._rowCount=n,i._columns=a,i._schema=e;for(let t of a)i[t]=Zv.ofLambda({rowCount:n,schema:e[t],value:e=>r[e][t],valueKind:e=>void 0===r[e][t]?1:0});return i},e.ofArrays=function(e,t){var r,i,n=Object.create(null),a=Object.keys(e);n._rowCount=0,n._columns=a,n._schema=e;for(i of a)void 0!==t[i]?(n[i]=Zv.ofArray({array:t[i],schema:e[i]}),n._rowCount=null==(r=t[i])?void 0:r.length):n[i]=Zv.Undefined(n._rowCount,e[i]);return n},e.view=Xb,e.pick=function(r,e,i){var n=[];for(let e=0,t=r._rowCount;e<t;++e)i(e)&&n.push(e);return Xb(r,e,n)},e.window=function(e,t,r,i){if(0===r&&i===e._rowCount)return e;var n,a=Object.create(null),s=Object.keys(t);a._rowCount=i-r,a._columns=s,a._schema=t;for(n of s)a[n]=Zv.window(e[n],r,i);return a},e.concat=function(e,t){var r,i=Object.create(null),n=Object.keys(t);i._rowCount=0;for(r of e)i._rowCount+=r._rowCount;var a,s,o,l={};for(a of n)l[a]=new Array(i._rowCount);i._columns=n,i._schema=t;let h=0;for(s of e){for(var c of n)Zv.copyToArray(s[c],l[c],h);h+=s._rowCount}for(o of n)i[o]=Zv.ofArray({array:l[o],schema:t[o]});return i},e.columnToArray=function(e,t,r){e[t]=Zv.asArrayColumn(e[t],r)},e.sort=function(e,i){var r=new Int32Array(e._rowCount);for(let e=0,t=r.length;e<t;e++)r[e]=e;Fb(r,(e,t,r)=>i(t,r));let n=!0;for(let e=0,t=r.length;e<t;e++)if(r[e]!==e){n=!1;break}if(n)return e;var t,a=Object.create(null);a._rowCount=e._rowCount,a._columns=e._columns,a._schema=e._schema;for(t of e._columns)a[t]=Zv.view(e[t],r,!1);return a},e.areEqual=function(e,t){if(e._rowCount!==t._rowCount)return!1;if(e._columns.length!==t._columns.length)return!1;for(var r of e._columns)if(!t[r])return!1;for(var i of e._columns)if(!Zv.areEqual(e[i],t[i]))return!1;return!0},e.getRow=Yb,e.pickRow=function(r,i){for(let e=0,t=r._rowCount;e<t;++e)if(i(e))return Yb(r,e)},e.getRows=function(t){var r=[],i=t._rowCount;for(let e=0;e<i;e++)r[e]=Yb(t,e);return r},e.toArrays=function(t){var r={},i=t._columns;for(let e=0;e<i.length;e++){var n=i[e];r[n]=t[n].toArray()}return r},e.formatToString=function(r){var i=Jv.create(),{_columns:n,_rowCount:e}=r;let t=1;Jv.write(i,"|");for(let e=0;e<n.length;e++)Jv.write(i,n[e]),Jv.write(i,"|"),t+=n[e].length+1;Jv.newline(i),Jv.write(i,new Array(t+1).join("-")),Jv.newline(i);for(let t=0;t<e;t++){Jv.write(i,"|");for(let e=0;e<n.length;e++){var a=r[n[e]];0===a.valueKind(t)?(Jv.write(i,a.value(t)),Jv.write(i,"|")):Jv.write(i,".|")}Jv.newline(i)}return Jv.getString(i)},(t=i_=i_||{}).ofTables=function(e,t,r){var i,n=Object.keys(r),a=Object.create(null),s=[];a._name=e,a._tableNames=s,a._schema=t;for(i of n)r_.is(r[i])&&(a[i]=r[i],s[s.length]=i);return a},t.getTablesAsRows=function(e){var t,r={};for(t of e._tableNames)r[t]=r_.getRows(e[t]);return r},(u=Qb=Qb||{}).empty=function(e){return{rowCount:0,name:e,fieldNames:[],getField(e){}}},u.ofFields=Jb,u.ofTable=function(e,t){var r={};for(let e of t._columns)r[e]=n_.ofColumn(t[e]);return Jb(e,r)},(e=n_=n_||{}).ofString=function(e){return ex([e])},e.ofStrings=ex,e.ofNumbers=function(r){let t=r.length,i=e=>""+r[e],n=e=>r[e];var e=e=>!e||e.array&&r instanceof e.array?r:dy(t,n,e);return{__array:void 0,binaryEncoding:void 0,isDefined:!0,rowCount:t,str:i,int:n,float:n,valueKind:e=>0,areValuesEqual:(e,t)=>r[e]===r[t],toStringArray:e=>dy(t,i,e),toIntArray:e,toFloatArray:e}},e.ofTokens=function(e){let{data:r,indices:i,count:t}=e,n=e=>{e=r.substring(i[2*e],i[2*e+1]);return"."===e||"?"===e?"":e},a=e=>wb(r,i[2*e],i[2*e+1])||0,s=e=>Mb(r,i[2*e],i[2*e+1])||0;return{__array:void 0,binaryEncoding:void 0,isDefined:!0,rowCount:t,str:n,int:a,float:s,valueKind:e=>{var t=i[2*e],e=i[2*e+1]-t;return 1<e?0:0==e||46===(e=r.charCodeAt(t))?1:63===e?2:0},areValuesEqual:(e=>{let{data:a,indices:s}=e;return function(e,t){var r=s[2*e],i=s[2*t],n=s[2*e+1]-r;if(n!=s[2*t+1]-i)return!1;for(let e=0;e<n;e++)if(a.charCodeAt(e+r)!==a.charCodeAt(e+i))return!1;return!0}})(e),toStringArray:e=>dy(t,n,e),toIntArray:e=>dy(t,a,e),toFloatArray:e=>dy(t,s,e)}},e.ofColumn=tx,e.ofUndefined=function(e,t){return tx(Zv.Undefined(e,t))};let ix="undefined"!=typeof setImmediate?"undefined"!=typeof window?{setImmediate:(e,...t)=>window.setImmediate(e,...t),clearImmediate:e=>window.clearImmediate(e)}:{setImmediate:setImmediate,clearImmediate:clearImmediate}:rx();function nx(e){ix.setImmediate(e)}let ax={setImmediate:ix.setImmediate,clearImmediate:ix.clearImmediate,immediatePromise(){return new Promise(nx)},delay(t,r=void 0){return new Promise(e=>setTimeout(e,t,r))}};try{process.env.NODE_ENV}catch(e){}try{process.env.DEBUG}catch(e){}var sx,ox,lx,hx,cx,f,ux,dx,mx,px,fx;let gx="undefined"!=typeof performance&&!!performance.mark&&performance.measure&&!1;function vx(e){return"startTask"+e.id}function _x(e){return"endTask"+e.id}function yx(e,t,r=250){i=e,t=t,n={abortRequested:!1,treeAborted:!1,reason:""};var i,n,r={updateRateMs:r,lastNotified:zb(),observer:t,abortToken:n,taskId:i.id,root:{progress:bx(i),children:[]},tryAbort:(t=>e=>{t.abortRequested=!0,t.reason=e||t.reason})(n)};return wx(e,new Cx(r,r.root))}function bx(e){return{taskId:e.id,taskName:e.name,message:"",startedTime:0,canAbort:!0,isIndeterminate:!0,current:0,max:0}}function xx(e){return{progress:{...e.progress},children:e.children.map(xx)}}function Sx(e){return e.progress.canAbort&&e.children.every(Sx)}async function wx(t,r){sx.markStart(t),r.node.progress.startedTime=zb();try{var e=await t.f(r);return sx.markEnd(t),sx.measure(t),r.info.abortToken.abortRequested&&Ax(r.info),e}catch(e){throw ox.isAbort(e)&&(r.isAborted=!0,0<r.node.children.length&&await new Promise(e=>{r.onChildrenFinished=e}),t.onAbort)&&t.onAbort(),e}}function Ax(e){throw e.abortToken.treeAborted||(e.abortToken.treeAborted=!0,function e(t){let r=t.progress;r.isIndeterminate=!0;r.canAbort=!1;r.message="Aborting...";for(var i of t.children)e(i)}(e.root),Mx(e,zb())),ox.Aborted(e.abortToken.reason)}function Mx(e,t){e.lastNotified=t;t={root:xx((t=e).root),canAbort:Sx(t.root),requestAbort:t.tryAbort};e.observer(t)}(t=sx=sx||{}).markStart=function(e){gx&&performance.mark(vx(e))},t.markEnd=function(e){gx&&performance.mark(_x(e))},t.measure=function(e){gx&&performance.measure(" "+e.name,vx(e),_x(e))};class Cx{checkAborted(){this.info.abortToken.abortRequested&&(this.isAborted=!0,Ax(this.info))}get shouldUpdate(){return this.checkAborted(),zb()-this.lastUpdatedTime>this.info.updateRateMs}updateProgress(e){var t;this.checkAborted(),e&&(t=this.node.progress,"string"==typeof e?(t.message=e,t.isIndeterminate=!0):(void 0!==e.canAbort&&(t.canAbort=e.canAbort),void 0!==e.message&&(t.message=e.message),void 0!==e.current&&(t.current=e.current),void 0!==e.max&&(t.max=e.max),t.isIndeterminate=void 0===t.current||void 0===t.max,void 0!==e.isIndeterminate&&(t.isIndeterminate=e.isIndeterminate)))}update(e,t){if(this.lastUpdatedTime=zb(),this.updateProgress(e),!t)return Mx(this.info,this.lastUpdatedTime),this.checkAborted(),ax.immediatePromise()}async runChild(r,e){this.updateProgress(e);var e={progress:bx(r),children:[]},i=this.node.children,t=(i.push(e),new Cx(this.info,e));try{return await wx(r,t)}catch(e){if(!ox.isAbort(e)||!this.isAborted)throw e}finally{r=i.indexOf(e);if(0<=r){for(let e=r,t=i.length-1;e<t;e++)i[e]=i[e+1];i.pop()}0===i.length&&this.onChildrenFinished&&this.onChildrenFinished()}}constructor(e,t){this.isSynchronous=!1,this.isExecuting=!0,this.lastUpdatedTime=0,this.onChildrenFinished=void 0,this.node=t,this.info=e}}let Tx=new class{constructor(){this.shouldUpdate=!1,this.isSynchronous=!0}update(e,t){}};{class $A{run(e,t=250){return e?yx(this,e,t):this.f(Tx)}runAsChild(e,t){return e.isSynchronous?this.f(Tx):(r=this,e.runChild(r,t));var r}runInContext(e){return e.isSynchronous?this.f(Tx):wx(this,e)}constructor(e,t,r){this.name=e,this.f=t,this.onAbort=r,this.id=i()}}function Ex(e){return!!e&&"number"==typeof e.id&&"string"==typeof e.name&&!!e.run}function Px(e,t,r){return new $A(e,t,r)}(u=ox=ox||{}).is=Ex,u.isAbort=function(e){return!!e&&!!e.isAborted},u.Aborted=function(e){return{isAborted:!0,reason:e,toString(){return"Aborted"+(e?": "+e:"")}}},u.create=Px,u.constant=function(e,t){return Px(e,async e=>t)},u.empty=function(){return Px("",async e=>{})},u.fail=function(e,t){return Px(e,async e=>{throw new Error(t)})},u.resolveInContext=function(e,t){return Ex(e)?t?e.runInContext(t):e.run():e};let i=$b(0,1073741823)}async function Ix(i,e,n,a,s){let o=Math.max(e,0),l=0,h=0;if(i.isSynchronous)a(Number.MAX_SAFE_INTEGER,n);else{let e=zb(),t,r=0;for(;0<(t=a(o,n));){l+=t;var c=zb()-e;r+=c,h+=c,i.shouldUpdate&&(await s(i,n,l),o=Math.round(r*l/h)+1,e=zb(),r=0)}i.shouldUpdate&&await s(i,n,l)}return n}function Rx(e){return{data:e,position:0,length:e.length,lineNumber:1,tokenStart:0,tokenEnd:0}}function Dx(e){return e.data.substring(e.tokenStart,e.tokenEnd)}function Lx(e){for(var t=e.data;e.position<e.length;)switch(t.charCodeAt(e.position)){case 10:return e.tokenEnd=e.position,++e.position,++e.lineNumber,!0;case 13:return e.tokenEnd=e.position,++e.position,++e.lineNumber,10===t.charCodeAt(e.position)&&++e.position,!0;default:++e.position}return e.tokenEnd=e.position,e.tokenStart!==e.tokenEnd}function Ox(e){return e.tokenStart=e.position,Lx(e)}function kx(t,r,i){let n=0;for(let e=0;e<r;e++){if(!Ox(t))return n;hx.addUnchecked(i,t.tokenStart,t.tokenEnd),n++}n}function Nx(e,t,r){var i=e.data;let n=t,a=r-1,s=i.charCodeAt(n);for(;(9===s||32===s)&&n<=a;)s=i.charCodeAt(++n);for(s=i.charCodeAt(a);(9===s||32===s)&&a>=n;)s=i.charCodeAt(--a);return e.tokenStart=n,e.tokenEnd=a+1,e.position=r,e}function Fx(e,t,r){var i,n,a=e;a.offset>a.indicesLenMinus2&&(i=a,(n=new Uint32Array(1.61*i.indices.length|0)).set(i.indices),i.indices=n,i.indicesLenMinus2=n.length-2|0),a.indices[a.offset++]=t,a.indices[a.offset++]=r,e.count++}Tx,(h||{}).format=function(e){return function t(e,r=""){var i=e.progress;if(!e.children.length)return i.isIndeterminate?""+r+i.taskName+": "+i.message:""+r+i.taskName+`: [${i.current}/${i.max}] `+i.message;let n=r+"  |_ ";e=e.children.map(e=>t(e,n));return i.isIndeterminate?""+r+i.taskName+`: ${i.message}
`+e.join("\n"):""+r+i.taskName+`: [${i.current}/${i.max}] ${i.message}
`+e.join("\n")}(e.root)},(lx=Rx=Rx||{}).getTokenString=Dx,lx.reset=function(e){e.position=0,e.lineNumber=1,e.tokenStart=0,e.tokenEnd=0},lx.eatLine=Lx,lx.markStart=function(e){e.tokenStart=e.position},lx.markLine=Ox,lx.readLine=function(e){return Ox(e),Dx(e)},lx.readLineTrim=function(e){Ox(e);var t=e.position;return Nx(e,e.tokenStart,e.tokenEnd),e.position=t,Dx(e)},lx.markLines=function(e,t){var r=hx.create(e.data,2*t);return kx(e,t,r),r},lx.readLines=function(t,r){var i=[];for(let e=0;e<r;e++)i.push(lx.readLine(t));return i},lx.readLinesAsync=async function(e,r,t,i=1e5){let n=hx.create(e.data,2*r),a=0;return await Ix(t,i,e,(e,t)=>{e=Math.min(r-a,e);return kx(t,e,n),a+=e,e},(e,t)=>e.update({message:"Parsing...",current:t.position,max:t.length})),n},lx.readAllLines=function(e){for(var t=lx(e),r=hx.create(t.data,Math.max(e.length/80,2));Ox(t);)hx.add(r,t.tokenStart,t.tokenEnd);return r},lx.readAllLinesAsync=async function(e,t,r=1e5){var i=lx(e);let n=hx.create(i.data,Math.max(e.length/80,2));return await Ix(t,r,i,(e,t)=>(((t,r,i)=>{let n=0;for(let e=0;e<r;e++){if(!Ox(t))return n;hx.add(i,t.tokenStart,t.tokenEnd),n++}n})(t,e,n),t.position<t.length?e:0),(e,t)=>e.update({message:"Parsing...",current:t.position,max:t.length})),n},lx.eatValue=function(e){for(;e.position<e.length;)switch(e.data.charCodeAt(e.position)){case 9:case 10:case 13:case 32:return void(e.tokenEnd=e.position);default:++e.position}e.tokenEnd=e.position},lx.skipWhitespace=function(e){let t=-1;for(;e.position<e.length;){var r=e.data.charCodeAt(e.position);switch(r){case 9:case 32:t=r,++e.position;break;case 10:13!==t&&++e.lineNumber,t=r,++e.position;break;case 13:t=r,++e.position,++e.lineNumber;break;default:return t}}return t},lx.trim=Nx,(e=hx=hx||{}).add=Fx,e.addToken=function(e,t){Fx(e,t.tokenStart,t.tokenEnd)},e.addUnchecked=function(e,t,r){e.indices[e.offset++]=t,e.indices[e.offset++]=r,e.count++},e.create=function(e,t){return{data:e,indicesLenMinus2:(t=Math.max(10,t))-2|0,count:0,offset:0,indices:new Uint32Array(t)}};{(t=cx=cx||{}).error=function(e,t=-1){return new jA(e,t)},t.success=function(e,t=[]){return new WA(e,t)};class jA{toString(){return 0<=this.line?`[Line ${this.line}] `+this.message:this.message}constructor(e,t){this.message=e,this.line=t,this.isError=!0}}t.Error=jA;class WA{constructor(e,t){this.result=e,this.warnings=t,this.isError=!1}}t.Success=WA}function Bx(e){for(;e.position<e.length;)switch(e.data.charCodeAt(e.position)){case 9:case 10:case 13:case 32:return void(e.tokenEnd=e.position);default:++e.position}e.tokenEnd=e.position}function Ux(e){return!(e.length-e.position<2)&&39===e.data.charCodeAt(e.position+1)&&39===e.data.charCodeAt(e.position+2)}function zx(e){let t;for(t=e.tokenStart;t<e.tokenEnd;++t)if(46===e.data.charCodeAt(t))return t;return t}function Vx(e,t){return e.data.substring(e.tokenStart,t)}function Gx(e){return e.data.substring(e.tokenStart,e.tokenEnd)}function Hx(e){var t=(e=>{let t=10;for(;e.position<e.length;){var r=e.data.charCodeAt(e.position);switch(r){case 9:case 32:t=r,++e.position;break;case 10:13!==t&&++e.lineNumber,t=r,++e.position;break;case 13:t=r,++e.position,++e.lineNumber;break;default:return t}}return t})(e);if(e.position>=e.length)e.tokenType=6;else{e.tokenStart=e.position,e.tokenEnd=e.position,e.isEscaped=!1;var r,i,n,a=e.data.charCodeAt(e.position);switch(a){case 35:(e=>{for(;e.position<e.length;){var t=e.data.charCodeAt(e.position);if(10===t||13===t)return;++e.position}})(e),e.tokenType=5;break;case 39:if(Ux(e)){(e=>{for(e.position+=3;e.position<e.length;){if(39===e.data.charCodeAt(e.position)&&Ux(e))return e.tokenStart+=3,e.tokenEnd=e.position,e.isEscaped=!0,e.position+=3;++e.position}e.tokenEnd=e.position})(e),e.tokenType=3;break}case 34:((e,t)=>{var r,i;for(++e.position;e.position<e.length;)if((i=e.data.charCodeAt(e.position))===t)switch(r=e.data.charCodeAt(e.position+1)){case 9:case 10:case 13:case 32:return e.tokenStart++,e.tokenEnd=e.position,e.isEscaped=!0,++e.position;default:if(void 0===r)return e.tokenStart++,e.tokenEnd=e.position,e.isEscaped=!0,++e.position;++e.position}else{if(10===i||13===i)return e.tokenEnd=e.position;++e.position}e.tokenEnd=e.position})(e,a),e.tokenType=3;break;case 59:(10===t||13===t?e=>{let t=59,r=e.position+1,i;for(;r<e.length;){if(59===(i=e.data.charCodeAt(r))&&(10===t||13===t)){for(e.position=r+1,e.tokenStart++,r--,i=e.data.charCodeAt(r);10===i||13===i;)r--,i=e.data.charCodeAt(r);return e.tokenEnd=r+1,e.isEscaped=!0}(13===i||10===i&&13!==t)&&e.lineNumber++,t=i,++r}e.position=r,t}:Bx)(e),e.tokenType=3;break;default:(e.isImportGet?e=>{for(;e.position<e.length;){if(93===e.data.charCodeAt(e.position))return++e.position,e.tokenEnd=e.position,e.isImportGet=!1;++e.position}}:Bx)(e),e.isEscaped?e.tokenType=3:95===e.data.charCodeAt(e.tokenStart)?(e.inSaveFrame&&(n=e).tokenEnd-n.tokenStart==11&&105===n.data.charCodeAt(n.tokenStart+1)&&109===n.data.charCodeAt(n.tokenStart+2)&&112===n.data.charCodeAt(n.tokenStart+3)&&111===n.data.charCodeAt(n.tokenStart+4)&&114===n.data.charCodeAt(n.tokenStart+5)&&116===n.data.charCodeAt(n.tokenStart+6)&&46===n.data.charCodeAt(n.tokenStart+7)&&103===n.data.charCodeAt(n.tokenStart+8)&&101===n.data.charCodeAt(n.tokenStart+9)&&116===n.data.charCodeAt(n.tokenStart+10)&&(e.isImportGet=!0),e.tokenType=4):5<=e.tokenEnd-e.tokenStart&&95===e.data.charCodeAt(e.tokenStart+4)?68!==(i=(n=e).data.charCodeAt(n.tokenStart))&&100!==i||65!==(i=n.data.charCodeAt(n.tokenStart+1))&&97!==i||84!==(i=n.data.charCodeAt(n.tokenStart+2))&&116!==i||65!==(i=n.data.charCodeAt(n.tokenStart+3))&&97!==i?83!==(r=(i=e).data.charCodeAt(i.tokenStart))&&115!==r||65!==(r=i.data.charCodeAt(i.tokenStart+1))&&97!==r||86!==(r=i.data.charCodeAt(i.tokenStart+2))&&118!==r||69!==(r=i.data.charCodeAt(i.tokenStart+3))&&101!==r?(i=e).tokenEnd-i.tokenStart!=5||76!==(r=i.data.charCodeAt(i.tokenStart))&&108!==r||79!==(r=i.data.charCodeAt(i.tokenStart+1))&&111!==r||79!==(r=i.data.charCodeAt(i.tokenStart+2))&&111!==r||80!==(r=i.data.charCodeAt(i.tokenStart+3))&&112!==r?e.tokenType=3:e.tokenType=2:e.tokenType=1:e.tokenType=0:e.tokenType=3}}}function $x(e){for(Hx(e);5===e.tokenType;)Hx(e)}function jx(){return{categoryNames:[],categoryData:Object.create(null)}}function Wx(e,t){var r,i=Object.create(null);for(r of e){var n=t[r];i[r]=Qb(n.name,n.rowCount,n.fieldNames,n.fields)}return i}function qx(e,t,r){return Zb(e.categoryNames,Wx(e.categoryNames,e.categoryData),t,r)}function Xx(e,t,r,i,n){var a;t in e.categoryData?((a=e.categoryData[t]).fieldNames.push(...i),Object.assign(a.fields,n)):(e.categoryData[t]={name:t,rowCount:r,fieldNames:i,fields:n},e.categoryNames.push(t))}function Yx(e,t){var r=e.tokenStart,i=zx(e),n=Vx(e,i),a=Object.create(null),s=[];let o=!0;for(;o;){if(4!==e.tokenType||!((e,t,r)=>{let i;var n=r-t,a=e.tokenStart-t,s=e.tokenEnd-e.tokenStart;if(!(s<n)){for(i=t;i<r;++i)if(e.data.charCodeAt(i)!==e.data.charCodeAt(i+a))return;return n==s||46===e.data.charCodeAt(i+a)}})(e,r,i)){o=!1;break}var l=Gx(e).substring(n.length+1);if($x(e),3!==e.tokenType)return{hasError:!0,errorLine:e.lineNumber,errorMessage:"Expected value."};a[l]=n_.ofTokens({data:e.data,indices:[e.tokenStart,e.tokenEnd],count:1}),s[s.length]=l,$x(e)}return Xx(t,n.substr(1),1,s,a),{hasError:!1,errorLine:0,errorMessage:""}}function Kx(e,t){var{tokenizer:r,tokens:i,fieldCount:n}=t;let a=t.tokenCount,s=0;for(;3===r.tokenType&&s<e;)hx.add(i[a++%n],r.tokenStart,r.tokenEnd),$x(r),s++;return t.tokenCount=a,s}function Zx(e,t){return e.update({message:"Parsing...",current:t.tokenizer.position,max:t.tokenizer.data.length})}async function Qx(t,r){for(var e=t.lineNumber,i=($x(t),Vx(t,zx(t))),n=(e=>{let t;for(t=e.tokenStart;t<e.tokenEnd;++t)if(46===e.data.charCodeAt(t))return!1;return!0})(t),a=[];4===t.tokenType;)a[a.length]=n?Gx(t):Gx(t).substring(i.length+1),$x(t);var s="_atom_site"===i?t.data.length/100|0:32,o=[],l=a.length;for(let e=0;e<l;e++)o[e]=hx.create(t.data,s);var h={fieldCount:l,tokenCount:0,tokenizer:t,tokens:o};if(await Ix(t.runtimeCtx,1e6,h,Kx,Zx),h.tokenCount%l!=0)return{hasError:!0,errorLine:t.lineNumber,errorMessage:`The number of values for loop starting at line ${e} is not a multiple of the number of columns.`};var c=h.tokenCount/l|0;if(n)for(let e=0;e<l;e++){var u={"":n_.ofTokens(o[e])};Xx(r,a[e].substr(1),c,[""],u)}else{var d=Object.create(null);for(let e=0;e<l;e++)d[a[e]]=n_.ofTokens(o[e]);Xx(r,i.substr(1),c,a,d)}return{hasError:!1,errorLine:0,errorMessage:""}}function Jx(e,t){return cx.error(t,e)}async function e2(e,t){var r=[],i={data:e,length:e.length,position:0,tokenStart:0,tokenEnd:0,tokenType:6,lineNumber:1,isEscaped:!1,isImportGet:!1,inSaveFrame:!1,runtimeCtx:t};let n="",a=jx(),s=[],o=jx();h=o.categoryNames,l=Wx(o.categoryNames,o.categoryData);var l,h={categoryNames:h,header:"",categories:l};let c="";for(t.update({message:"Parsing...",current:0,max:e.length}),$x(i);6!==i.tokenType;){var u=i.tokenType;if(0===u){if(i.inSaveFrame)return Jx(i.lineNumber,"Unexpected data block inside a save frame.");0<a.categoryNames.length&&r.push(qx(a,n,s)),n=e.substring(i.tokenStart+5,i.tokenEnd),a=jx(),s=[],$x(i)}else if(1===u){if(i.tokenEnd-i.tokenStart==5)0<o.categoryNames.length&&(s[s.length]=(d=o,m=c,Zb(d.categoryNames,Wx(d.categoryNames,d.categoryData),m))),i.inSaveFrame=!1;else{if(i.inSaveFrame)return Jx(i.lineNumber,"Save frames cannot be nested.");i.inSaveFrame=!0,c=e.substring(i.tokenStart+5,i.tokenEnd),o=jx()}$x(i)}else if(2===u){var d=await Qx(i,i.inSaveFrame?o:a);if(d.hasError)return Jx(d.errorLine,d.errorMessage)}else{if(4!==u)return console.log(i.tokenType,Rx.getTokenString(i)),Jx(i.lineNumber,"Unexpected token. Expected data_, loop_, or data name.");var m=Yx(i,i.inSaveFrame?o:a);if(m.hasError)return Jx(m.errorLine,m.errorMessage)}}return i.inSaveFrame?Jx(i.lineNumber,`Unfinished save frame (${h.header}).`):((0<a.categoryNames.length||0<s.length)&&r.push(qx(a,n,s)),l=Kb(r),cx.success(l))}function t2(t){return ox.create("Parse CIF",async e=>e2(t,e))}ux=f=f||{},(u=ux.IntDataType||(ux.IntDataType={}))[u.Int8=1]="Int8",u[u.Int16=2]="Int16",u[u.Int32=3]="Int32",u[u.Uint8=4]="Uint8",u[u.Uint16=5]="Uint16",u[u.Uint32=6]="Uint32",(u=ux.FloatDataType||(ux.FloatDataType={}))[u.Float32=32]="Float32",u[u.Float64=33]="Float64",ux.getDataType=function(e){let t;return t=e instanceof Int8Array?ux.IntDataType.Int8:e instanceof Int16Array?ux.IntDataType.Int16:e instanceof Int32Array?ux.IntDataType.Int32:e instanceof Uint8Array?ux.IntDataType.Uint8:e instanceof Uint16Array?ux.IntDataType.Uint16:e instanceof Uint32Array?ux.IntDataType.Uint32:e instanceof Float32Array?ux.FloatDataType.Float32:e instanceof Float64Array?ux.FloatDataType.Float64:ux.IntDataType.Int32},ux.isSignedIntegerDataType=function(r){if(!(r instanceof Int8Array||r instanceof Int16Array||r instanceof Int32Array))for(let e=0,t=r.length;e<t;e++)if(e<0)return!1;return!0};let r2=13330===new Uint16Array(new Uint8Array([18,52]).buffer)[0];function i2(t){let r=t.data;for(let e=t.encoding.length-1;0<=e;e--)r=((e,t)=>{switch(t.kind){case"ByteArray":switch(t.type){case f.IntDataType.Uint8:return e;case f.IntDataType.Int8:return(e=>new Int8Array(e.buffer,e.byteOffset))(e);case f.IntDataType.Int16:return(e=>s2(e,2,Int16Array))(e);case f.IntDataType.Uint16:return(e=>s2(e,2,Uint16Array))(e);case f.IntDataType.Int32:return(e=>s2(e,4,Int32Array))(e);case f.IntDataType.Uint32:return(e=>s2(e,4,Uint32Array))(e);case f.FloatDataType.Float32:return(e=>s2(e,4,Float32Array))(e);case f.FloatDataType.Float64:return(e=>s2(e,8,Float64Array))(e);default:db(t.type)}case"FixedPoint":return((t,e)=>{var r=t.length,i=a2(e.srcType,r),n=1/e.factor;for(let e=0;e<r;e++)i[e]=n*t[e];return i})(e,t);case"IntervalQuantization":return((t,e)=>{var r=t.length,i=a2(e.srcType,r),n=(e.max-e.min)/(e.numSteps-1),a=e.min;for(let e=0;e<r;e++)i[e]=a+n*t[e];return i})(e,t);case"RunLength":return((r,e)=>{let i=n2(e.srcType,e.srcSize),n=0;for(let e=0,t=r.length;e<t;e+=2){var a=r[e],s=r[e+1];for(let e=0;e<s;++e)i[n++]=a}return i})(e,t);case"Delta":return((t,e)=>{var r=t.length,i=n2(e.srcType,r);if(!r)return t;i[0]=t[0]+(0|e.origin);for(let e=1;e<r;++e)i[e]=t[e]+i[e-1];return i})(e,t);case"IntegerPacking":return((e,t)=>e.length===t.srcSize?e:(t.isUnsigned?(r,e)=>{let i=1===e.byteCount?255:65535,t=r.length,n=new Int32Array(e.srcSize),a=0,s=0;for(;a<t;){let e=0,t=r[a];for(;t===i;)e+=t,a++,t=r[a];e+=t,n[s]=e,a++,s++}return n}:(r,e)=>{let i=1===e.byteCount?127:32767,n=-i-1,t=r.length,a=new Int32Array(e.srcSize),s=0,o=0;for(;s<t;){let e=0,t=r[s];for(;t===i||t===n;)e+=t,s++,t=r[s];e+=t,a[o]=e,s++,o++}return a})(e,t))(e,t);case"StringArray":return((e,t)=>{var r=i2({encoding:t.offsetEncoding,data:t.offsets}),i=i2({encoding:t.dataEncoding,data:e}),n=t.stringData,a=new Array(r.length);a[0]="";for(let e=1,t=r.length;e<t;e++)a[e]=n.substring(r[e-1],r[e]);let s=0,o=new Array(i.length);for(let e=0,t=i.length;e<t;e++)o[s++]=a[i[e]+1];return o})(e,t)}})(r,t.encoding[e]);return r}function n2(e,t){switch(e){case f.IntDataType.Int8:return new Int8Array(t);case f.IntDataType.Int16:return new Int16Array(t);case f.IntDataType.Int32:return new Int32Array(t);case f.IntDataType.Uint8:return new Uint8Array(t);case f.IntDataType.Uint16:return new Uint16Array(t);case f.IntDataType.Uint32:return new Uint32Array(t);default:return new Int32Array(t)}}function a2(e,t){return new(e===f.FloatDataType.Float32?Float32Array:(f.FloatDataType.Float64,Float64Array))(t)}function s2(e,t,r){return r2?new r(e.buffer):new r(((r,i)=>{var e=new ArrayBuffer(r.length),n=new Uint8Array(e);for(let t=0,e=r.length;t<e;t+=i)for(let e=0;e<i;e++)n[t+i-e-1]=r[t+e];return e})(e,t))}function o2(e){var t=e.growBy*e.elementSize;e.currentSize=t,e.currentIndex=0,e.currentChunk=new e.ctor(t),e.allocatedSize+=t,e.chunks[e.chunks.length]=e.currentChunk}function l2(e,t){var{ctor:r,chunks:i,currentIndex:n}=e;if(!i.length)return new r(0);if(1===i.length&&(t||n===e.allocatedSize))return i[0];let a=0;for(let e=0,t=i.length-1;e<t;e++)a+=i[e].length;var s=new r(a+=e.currentIndex);let o=0;if(s.buffer)for(let e=0,t=i.length-1;e<t;e++)s.set(i[e],o),o+=i[e].length;else for(let e=0,t=i.length-1;e<t;e++){var l=i[e];for(let e=0,t=l.length;e<t;e++)s[o+e]=l[e];o+=l.length}var h=i[i.length-1];if(s.buffer&&n>=e.currentSize)s.set(h,o);else for(let e=0,t=h.length;e<t;e++)s[o+e]=h[e];return s}function h2(r,i,n){let a=1,s=0;for(let e=0,t=r.length;e<t;e++){0<=a&&((l=((e,t,r)=>{let i=1,n;for(n=0;n<t;n++){var a=i*e;if(Math.abs(Math.round(a)-a)<=r)return n;i*=10}return-1})(r[e],i,n))<0?a=-1:l>a&&(a=l));var o,l=Math.abs(r[e]);n<l&&(o=Math.floor(Math.log10(Math.abs(l)))+1)>s&&(s=o)}return{mantissaDigits:a,integerDigits:s}}function c2(e){return mx.classify(e)}function u2(e,t){return 0<=e?Math.ceil((e+1)/t):Math.ceil((e+1)/(-t-1))}function d2(){return{pack8:0,pack16:0,count:0}}function m2({limit8:e,limit16:t},r,i){r.pack8+=u2(i,e),r.pack16+=u2(i,t),r.count+=1}function p2(e,t){e.pack8+=u2(t,127),e.pack16+=u2(t,32767),e.count+=1}function f2(e){return 4*e.count<2*e.pack16?{length:4*e.count,elem:4}:2*e.pack16<e.pack8?{length:2*e.pack16,elem:2}:{length:e.pack8,elem:1}}function g2(e){var t=(r=>{let i=!1;for(let e=0,t=r.length;e<t;e++)if(r[e]<0){i=!0;break}return i?{signed:i,limit8:127,limit16:32767}:{signed:i,limit8:255,limit16:65535}})(e),t=[((r,i)=>{var n=d2();for(let e=0,t=r.length;e<t;e++)m2(i,n,r[e]);return{...f2(n),kind:"pack"}})(e,t),((r,i)=>{var n=d2();let a=1;for(let e=1,t=r.length;e<t;e++)r[e-1]!==r[e]?(m2(i,n,r[e-1]),m2(i,n,a),a=1):a++;return m2(i,n,r[r.length-1]),m2(i,n,a),{...f2(n),kind:"rle"}})(e,t),(r=>{var i=d2();let n=r[0];for(let e=1,t=r.length;e<t;e++)p2(i,r[e]-n),n=r[e];return{...f2(i),kind:"delta"}})(e),(r=>{var i=d2();let n=1,a=0,s=0;for(let e=1,t=r.length;e<t;e++){var o=r[e]-a;s!==o?(p2(i,s),p2(i,n),n=1):n++,s=o,a=r[e]}return p2(i,s),p2(i,n),{...f2(i),kind:"delta-rle"}})(e)];return t.sort((e,t)=>e.length-t.length),t}(h=dx=dx||{}).is=function(e){return e.creator&&e.chunkSize},h.add4=function(e,t,r,i,n){e.currentIndex>=e.currentSize&&o2(e);var a=e.currentChunk,s=e.currentIndex;return a[s]=t,a[s+1]=r,a[s+2]=i,a[s+3]=n,e.currentIndex+=4,e.elementCount++},h.add3=function(e,t,r,i){e.currentIndex>=e.currentSize&&o2(e);var n=e.currentChunk,a=e.currentIndex;return n[a]=t,n[a+1]=r,n[a+2]=i,e.currentIndex+=3,e.elementCount++},h.add2=function(e,t,r){e.currentIndex>=e.currentSize&&o2(e);var i=e.currentChunk,n=e.currentIndex;return i[n]=t,i[n+1]=r,e.currentIndex+=2,e.elementCount++},h.add=function(e,t){return e.currentIndex>=e.currentSize&&o2(e),e.currentChunk[e.currentIndex]=t,e.currentIndex+=1,e.elementCount++},h.addRepeat=function(t,r,i){for(let e=0;e<r;e++)t.currentIndex>=t.currentSize&&o2(t),t.currentChunk[t.currentIndex++]=i,t.elementCount++;return t.elementCount},h.addMany=function(r,i){var n=r.elementSize;for(let t=0,e=i.length;t<e;t+=n){r.currentIndex>=r.currentSize&&o2(r);var a=r.currentChunk;for(let e=0;e<n;e++)a[r.currentIndex++]=i[t+e];r.elementCount++}return r.elementCount},h.compact=function(e,t=!1){return l2(e,t)},h._compact=l2,h.create=function(e,t,r,i){if(r={ctor:e,elementSize:t,growBy:Math.max(1,Math.ceil(r)),allocatedSize:0,elementCount:0,currentSize:0,currentChunk:void 0,currentIndex:0,chunks:[]},void 0!==i)if("number"==typeof i)r.currentChunk=new e(i*t),r.allocatedSize=i*t,r.currentSize=r.currentChunk.length,r.chunks[0]=r.currentChunk;else{e=i;if(e.length%t!=0)throw new Error("initialChunk length must be a multiple of the element size.");r.currentChunk=e,r.allocatedSize=e.length,r.currentSize=e.length,r.chunks[0]=e}return r},(e=mx=mx||{}).getSize=g2,e.classify=function(e){if(e.length<2)return px.by(px.byteArray);switch(g2(e)[0].kind){case"pack":return px.by(px.integerPacking);case"rle":return px.by(px.runLength).and(px.integerPacking);case"delta":return px.by(px.delta).and(px.integerPacking);case"delta-rle":return px.by(px.delta).and(px.runLength).and(px.integerPacking);default:db()}};class v2{and(e){return new v2(this.providers.concat([e]))}encode(e){var t,r=[];for(t of this.providers){var i,n=t(e);if(!n.encodings.length)throw new Error("Encodings must be non-empty.");e=n.data;for(i of n.encodings)r.push(i)}if(e instanceof Uint8Array)return{encoding:r,data:e};throw new Error("The encoding must result in a Uint8Array. Fix your encoding chain.")}constructor(e){this.providers=e}}function _2(e){return new v2([e])}function y2(e){switch(e.kind){case"ByteArray":return px.byteArray;case"FixedPoint":return px.fixedPoint(e.factor);case"IntervalQuantization":return px.intervalQuantizaiton(e.min,e.max,e.numSteps);case"RunLength":return px.runLength;case"Delta":return px.delta;case"IntegerPacking":return px.integerPacking;case"StringArray":return px.stringArray}}(t={}).by=_2,t.fromEncoding=function(t){let r=_2(y2(t[0]));for(let e=1;e<t.length&&"IntegerPacking"!==t[e-1].kind;e++)r=r.and(y2(t[e]));return r};{(u=px=px||{}).by=function(e){return new v2([e])};let a={[f.IntDataType.Int16]:function(e,t,r){e.setInt16(2*t,r,!0)},[f.IntDataType.Uint16]:function(e,t,r){e.setUint16(2*t,r,!0)},[f.IntDataType.Int32]:function(e,t,r){e.setInt32(4*t,r,!0)},[f.IntDataType.Uint32]:function(e,t,r){e.setUint32(4*t,r,!0)},[f.FloatDataType.Float32]:function(e,t,r){e.setFloat32(4*t,r,!0)},[f.FloatDataType.Float64]:function(e,t,r){e.setFloat64(8*t,r,!0)}},s={[f.IntDataType.Int16]:2,[f.IntDataType.Uint16]:2,[f.IntDataType.Int32]:4,[f.IntDataType.Uint32]:4,[f.FloatDataType.Float32]:4,[f.FloatDataType.Float64]:8};function b2(r){var e=f.getDataType(r);if(e===f.IntDataType.Int8)return{encodings:[{kind:"ByteArray",type:f.IntDataType.Int8}],data:new Uint8Array(r.buffer,r.byteOffset)};if(e===f.IntDataType.Uint8)return{encodings:[{kind:"ByteArray",type:f.IntDataType.Uint8}],data:r};var t=new Uint8Array(r.length*s[e]),i=a[e],n=new DataView(t.buffer);for(let e=0,t=r.length;e<t;e++)i(n,e,r[e]);return{encodings:[{kind:"ByteArray",type:e}],data:t}}function x2(r,i){let n=0;for(let e=0,t=r.length;e<t;e++)n+=r[e]/i|0;return n+=r.length}function S2(r,i){var n=-i-1;let a=0;for(let e=0,t=r.length;e<t;e++){var s=r[e];a+=0<=s?s/i|0:s/n|0}return a+=r.length}function w2(e){var t=(r=>{for(let e=0,t=r.length;e<t;e++)if(r[e]<0)return!0;return!1})(e),r=t?S2(e,127):x2(e,255),i=t?S2(e,32767):x2(e,65535);return 4*e.length<2*i?{isSigned:t,size:e.length,bytesPerElement:4}:2*i<r?{isSigned:t,size:i,bytesPerElement:2}:{isSigned:t,size:r,bytesPerElement:1}}u.byteArray=b2,u.fixedPoint=function(t){return e=>{var r=e,i=t,e=f.getDataType(r),n=new Int32Array(r.length);for(let e=0,t=r.length;e<t;e++)n[e]=Math.round(r[e]*i);return{encodings:[{kind:"FixedPoint",factor:i,srcType:e}],data:n}}},u.intervalQuantizaiton=function(c,u,d,m=Int32Array){return e=>{var t,r=e,i=c,n=u,a=d,e=m,s=f.getDataType(r);if(!r.length)return{encodings:[{kind:"IntervalQuantization",min:i,max:n,numSteps:a,srcType:s}],data:new Int32Array(0)};n<i&&(t=i,i=n,n=t);var o=(n-i)/(a-1),l=new e(r.length);for(let e=0,t=r.length;e<t;e++){var h=r[e];l[e]=h<=i?0:n<=h?a-1:0|Math.round((h-i)/o)}return{encodings:[{kind:"IntervalQuantization",min:i,max:n,numSteps:a,srcType:s}],data:l}}},u.runLength=function(r){let e=f.getDataType(r);if(void 0===e&&(r=new Int32Array(r),e=f.IntDataType.Int32),!r.length)return{encodings:[{kind:"RunLength",srcType:e,srcSize:0}],data:new Int32Array(0)};let i=2;for(let e=1,t=r.length;e<t;e++)r[e-1]!==r[e]&&(i+=2);var n=new Int32Array(i);let a=0,s=1;for(let e=1,t=r.length;e<t;e++)r[e-1]!==r[e]?(n[a]=r[e-1],n[a+1]=s,s=1,a+=2):++s;return n[a]=r[r.length-1],n[a+1]=s,{encodings:[{kind:"RunLength",srcType:e,srcSize:r.length}],data:n}},u.delta=function(r){if(!f.isSignedIntegerDataType(r))throw new Error("Only signed integer types can be encoded using delta encoding.");let e=f.getDataType(r);if(void 0===e&&(r=new Int32Array(r),e=f.IntDataType.Int32),!r.length)return{encodings:[{kind:"Delta",origin:0,srcType:e}],data:new r.constructor(0)};var i=new r.constructor(r.length),t=r[0];i[0]=r[0];for(let e=1,t=r.length;e<t;e++)i[e]=r[e]-r[e-1];return i[0]=0,{encodings:[{kind:"Delta",origin:t,srcType:e}],data:i}},u.integerPacking=function(e){var t=w2(e);if(4===t.bytesPerElement)return b2(e);{var i=e;e=t;var n=e.isSigned?1===e.bytesPerElement?127:32767:1===e.bytesPerElement?255:65535,a=-n-1,s=i.length,o=new(e.isSigned?1===e.bytesPerElement?Int8Array:Int16Array:1===e.bytesPerElement?Uint8Array:Uint16Array)(e.size);let r=0;for(let t=0;t<s;t++){let e=i[t];if(0<=e)for(;e>=n;)o[r]=n,++r,e-=n;else for(;e<=a;)o[r]=a,++r,e-=a;o[r]=e,++r}t=b2(o);return{encodings:[{kind:"IntegerPacking",byteCount:e.bytesPerElement,isUnsigned:!e.isSigned,srcSize:s},t.encodings[0]],data:t.data};return}},u.stringArray=function(e){var t,r=Object.create(null),i=[],n=new Int32Array(e.length),a=dx.create(Int32Array,1,Math.min(1024,e.length<32?e.length+1:Math.round(e.length/8)+1));dx.add(a,0);let s=0,o=0;for(t of e)if(null==t)n[o++]=-1;else{let e=r[t];void 0===e&&(s+=t.length,r[i[e=i.length]=t]=e,dx.add(a,s)),n[o++]=e}var e=c2(e=dx.compact(a)).encode(e),l=c2(n).encode(n);return{encodings:[{kind:"StringArray",dataEncoding:l.encoding,stringData:i.join(""),offsetEncoding:e.encoding,offsets:e.data}],data:l.data}}}let A2=(()=>{var t=[];for(let e=0;e<1024;e++)t[e]=String.fromCharCode(e);return t})();function M2(r,i,n){var a=A2;let s=void 0,o=0;var l=[];for(let e=i,t=i+n;e<t;e++){var h=r[e];if(0==(128&h))l[o++]=a[h];else if(192==(224&h))l[o++]=a[(15&h)<<6|63&r[++e]];else if(224==(240&h))l[o++]=String.fromCharCode((15&h)<<12|(63&r[++e])<<6|(63&r[++e])<<0);else if(240==(248&h))l[o++]=String.fromCharCode((7&h)<<18|(63&r[++e])<<12|(63&r[++e])<<6|(63&r[++e])<<0);else{c=void 0;var c="Invalid byte "+h.toString(16);throw new Error(c)}512===o&&((s=s||[])[s.length]=l.join(""),o=0)}return(s?(0<o&&(s[s.length]=l.slice(0,o).join("")),s):l.slice(0,o)).join("")}let C2="undefined"!=typeof TextDecoder?new TextDecoder:void 0;function T2(t,r){var i={};for(let e=0;e<r;e++)i[R2(t)]=R2(t);return i}function E2(t,r){var i=new Uint8Array(r),n=t.offset;for(let e=0;e<r;e++)i[e]=t.buffer[e+n];return t.offset+=r,i}function P2(e,t){r=e.buffer,i=e.offset,n=t;var r,i,n,a=C2?(a=i||n!==r.length?r.subarray(i,i+n):r,C2.decode(a)):M2(r,i,n);return e.offset+=t,a}function I2(t,r){var i=new Array(r);for(let e=0;e<r;e++)i[e]=R2(t);return i}function R2(e){var t=e.buffer[e.offset];let r,i;if(0==(128&t))return e.offset++,t;if(128==(240&t))return i=15&t,e.offset++,T2(e,i);if(144==(240&t))return i=15&t,e.offset++,I2(e,i);if(160==(224&t))return i=31&t,e.offset++,P2(e,i);if(224==(224&t))return r=e.dataView.getInt8(e.offset),e.offset++,r;switch(t){case 192:return e.offset++,null;case 194:return e.offset++,!1;case 195:return e.offset++,!0;case 196:return i=e.dataView.getUint8(e.offset+1),e.offset+=2,E2(e,i);case 197:return i=e.dataView.getUint16(e.offset+1),e.offset+=3,E2(e,i);case 198:return i=e.dataView.getUint32(e.offset+1),e.offset+=5,E2(e,i);case 202:return r=e.dataView.getFloat32(e.offset+1),e.offset+=5,r;case 203:return r=e.dataView.getFloat64(e.offset+1),e.offset+=9,r;case 204:return r=e.buffer[e.offset+1],e.offset+=2,r;case 205:return r=e.dataView.getUint16(e.offset+1),e.offset+=3,r;case 206:return r=e.dataView.getUint32(e.offset+1),e.offset+=5,r;case 208:return r=e.dataView.getInt8(e.offset+1),e.offset+=2,r;case 209:return r=e.dataView.getInt16(e.offset+1),e.offset+=3,r;case 210:return r=e.dataView.getInt32(e.offset+1),e.offset+=5,r;case 217:return i=e.dataView.getUint8(e.offset+1),e.offset+=2,P2(e,i);case 218:return i=e.dataView.getUint16(e.offset+1),e.offset+=3,P2(e,i);case 219:return i=e.dataView.getUint32(e.offset+1),e.offset+=5,P2(e,i);case 220:return i=e.dataView.getUint16(e.offset+1),e.offset+=3,I2(e,i);case 221:return i=e.dataView.getUint32(e.offset+1),e.offset+=5,I2(e,i);case 222:return i=e.dataView.getUint16(e.offset+1),e.offset+=3,T2(e,i);case 223:return i=e.dataView.getUint32(e.offset+1),e.offset+=5,T2(e,i)}throw new Error("Unknown type 0x"+t.toString(16))}function D2(e){let r=Object.create(null),i=Object.create(null);for(var t of e.columns)r[t.name]=t;return{rowCount:e.rowCount,name:e.name.substr(1),fieldNames:e.columns.map(e=>e.name),getField(e){var t=r[e];if(t)return i[e]||(i[e]=(e=>{let t=e.mask?i2(e.mask):void 0,r=i2(e.data);var i=my(r);let n=i?t?e=>0===t[e]?""+r[e]:"":e=>""+r[e]:t?e=>0===t[e]?r[e]:"":e=>r[e],a=i?e=>r[e]:e=>{e=r[e];return wb(e,0,e.length)},s=i?e=>r[e]:e=>{e=r[e];return Mb(e,0,e.length)};var o=t?e=>t[e]:e=>0;let l=r.length;return{__array:r,binaryEncoding:e.data.encoding,isDefined:!0,rowCount:l,str:n,int:a,float:s,valueKind:o,areValuesEqual:(e,t)=>r[e]===r[t],toStringArray:e=>dy(l,n,e),toIntArray:i?e=>py(r,e):e=>dy(l,a,e),toFloatArray:i?e=>py(r,e):e=>dy(l,s,e)}})(t)),i[e]}}}function L2(n){return ox.create("Parse BinaryCIF",async e=>{var t=[0,3];try{var r,i=R2({buffer:n,offset:0,dataView:new DataView(n.buffer)});return((t,r)=>{for(let e=0;e<2;e++)if(t[e]>r[e])return;return 1})(t,i.version.match(/(\d)\.(\d)\.\d/).slice(1).map(e=>+e))?(r=Kb(i.dataBlocks.map(e=>{var t,r=Object.create(null);for(t of e.categories)r[t.name.substr(1)]=D2(t);return Zb(e.categories.map(e=>e.name.substr(1)),r,e.header)})),cx.success(r)):cx.error(`Unsupported format version. Current ${i.version}, required ${t.join(".")}.`)}catch(e){return cx.error(""+e)}})}function O2(e){return e.replace(".","_").replace(/\[/,"_").replace(/(\[|\])/g,"")}function k2(e,t,r){var i,n=e,a=t,s=r,o=Object.create(null);for(i of Object.keys(n))o[i]=((r,i,n,a)=>{let s=n.categories[r];if(a){var o=(e=>{var t,r=Object.create(null);for(t of Object.keys(e.categories))for(var i of e.categories[t].fieldNames){var n=fx.create(t,i,!0);r[n]=e.categories[t].getField(i)}return r})(n);let t=Object.create(null);var l,h=[];let e=0;for(l of Object.keys(i)){var c=((e,t,r,i)=>{if(t=fx.create(t,e),(e=fx.canonical(t))in r)return r[e];if(i&&t in i)for(var n of i[t]){n=fx.canonical(n);if(n in r)return r[n]}})(l,r,o,a);c&&(t[l]=c,h.push(l),e=c.rowCount)}s={rowCount:e,name:r,fieldNames:[...h],getField(e){return t[e]}}}return new z2(s||Qb.empty(r),i,!!s)})(i,n[i],a,s);return i_.ofTables(a.header,n,o)}function N2(s){switch(s.valueType){case"str":return(e,t,r)=>{return i=s,n=e.str,a=e.toStringArray,{schema:i,__array:e.__array,isDefined:e.isDefined,rowCount:e.rowCount,value:"lowercase"===i.transform?e=>n(e).toLowerCase():"uppercase"===i.transform?e=>n(e).toUpperCase():n,valueKind:e.valueKind,areValuesEqual:e.areValuesEqual,toArray:"lowercase"===i.transform?e=>Array.from(a(e)).map(e=>e.toLowerCase()):"uppercase"===i.transform?e=>Array.from(a(e)).map(e=>e.toUpperCase()):a};var i,n,a};case"int":return(e,t,r)=>F2(s,e,e.int,e.toIntArray);case"float":return(e,t,r)=>F2(s,e,e.float,e.toFloatArray);case"list":throw new Error("Use createListColumn instead.");case"tensor":throw new Error("Use createTensorColumn instead.")}}function F2(e,t,r,i){return{schema:e,__array:t.__array,isDefined:t.isDefined,rowCount:t.rowCount,value:r,valueKind:t.valueKind,areValuesEqual:t.areValuesEqual,toArray:i}}function B2(e,t,r){let i=e.separator,n=e.itemParse,a=t.getField(r),s=a?e=>a.str(e).split(i).map(e=>n(e.trim())).filter(e=>!!e):e=>[];return{schema:e,__array:void 0,isDefined:!!a,rowCount:t.rowCount,value:s,valueKind:a?a.valueKind:()=>1,areValuesEqual:(e,t)=>{var r=s(e),i=s(t),n=r.length;if(n!==i.length)return!1;for(let e=0;e<n;e++)if(r[e]!==i[e])return!1;return!0},toArray:e=>dy(t.rowCount,s,e)}}function U2(e,f,t){let g=e.space;var r=f.fieldNames.includes(t+"[0]")||f.fieldNames.includes(t+"[0][0]")||f.fieldNames.includes(t+"[0][0][0]"),i=r?0:1,n=f.fieldNames.includes(t+"_1")||f.fieldNames.includes(t+"_11")||f.fieldNames.includes(t+"_111")?"underscore":"brackets";let v=((i,e,t,r)=>{let n=t?0:1;switch(e){case 1:return"brackets"===r?e=>`${i}[${e+n}]`:e=>i+"_"+(e+n);case 2:return"brackets"===r?(e,t)=>`${i}[${e+n}][${t+n}]`:(e,t)=>i+"_"+(e+n)+(t+n);case 3:return"brackets"===r?(e,t,r)=>`${i}[${e+n}][${t+n}][${r+n}]`:(e,t,r)=>i+"_"+(e+n)+(t+n)+(r+n);default:throw new Error("Tensors with rank > 3 or rank 0 are currently not supported.")}})(t,g.rank,r,n);t=f.getField(v(i,i,i))||Zv.Undefined(f.rowCount,e);let a=e=>{var i=f,n=g,a=e,s=v,o=n.create();if(1===n.rank){var t=n.dimensions[0];for(let e=0;e<t;e++){var r=i.getField(s(e));n.set(o,e,r?r.float(a):0)}}else if(2===n.rank){var l=n.dimensions[0],h=n.dimensions[1];for(let t=0;t<l;t++)for(let e=0;e<h;e++){var c=i.getField(s(t,e));n.set(o,t,e,c?c.float(a):0)}}else{if(3!==n.rank)throw new Error("Tensors with rank > 3 or rank 0 are currently not supported.");var u=n.dimensions[0],d=n.dimensions[1],m=n.dimensions[2];for(let r=0;r<u;r++)for(let t=0;t<d;t++)for(let e=0;e<m;e++){var p=i.getField(s(r,t,e));n.set(o,r,t,e,p?p.float(a):0)}}return o};return{schema:e,__array:void 0,isDefined:t.isDefined,rowCount:f.rowCount,value:a,valueKind:t.valueKind,areValuesEqual:(e,t)=>Kv.areEqualExact(a(e),a(t)),toArray:e=>dy(f.rowCount,a,e)}}(h=fx=fx||{}).canonical=O2,h.equal=function(e,t){return O2(e)===O2(t)},h.create=function(e,t,r=!1){return e+=t?"."+t:"",r?O2(e):e};class z2{constructor(n,a,e){this._isDefined=e;e=Object.keys(a);this._rowCount=n.rowCount,this._columns=e,this._schema=a;let s=Object.create(null);for(let i of e)Object.defineProperty(this,i,{get:function(){var e,t,r;return s[i]||("list"===(e=a[i]).valueType?s[i]=B2(e,n,i):"tensor"===e.valueType?s[i]=U2(e,n,i):(t=N2(e),r=n.getField(i),s[i]=r?t(r,n,i):Zv.Undefined(n.rowCount,e))),s[i]},enumerable:!0,configurable:!1})}}var e=Zv.Schema,t=e.str,u=e.int,h=e.float,c=e.coord,d=e.Aliased,V2=e.Matrix,G2=e.Vector,m=e.lstr,e=e.List;let H2={atom_site:{auth_asym_id:t,auth_atom_id:t,auth_comp_id:t,auth_seq_id:u,B_iso_or_equiv:h,Cartn_x:c,Cartn_y:c,Cartn_z:c,group_PDB:d(t),id:u,label_alt_id:t,label_asym_id:t,label_atom_id:t,label_comp_id:t,label_entity_id:t,label_seq_id:u,occupancy:h,type_symbol:t,pdbx_PDB_ins_code:t,pdbx_PDB_model_num:u,pdbx_formal_charge:u,pdbx_label_index:u,pdbx_sifts_xref_db_name:t,pdbx_sifts_xref_db_acc:t,pdbx_sifts_xref_db_num:t,pdbx_sifts_xref_db_res:t,ihm_model_id:u},atom_site_anisotrop:{id:u,type_symbol:t,U:V2(3,3),U_esd:V2(3,3),pdbx_auth_seq_id:t,pdbx_auth_asym_id:t,pdbx_auth_atom_id:t,pdbx_auth_comp_id:t,pdbx_label_seq_id:u,pdbx_label_alt_id:t,pdbx_label_asym_id:t,pdbx_label_atom_id:t,pdbx_label_comp_id:t,pdbx_PDB_ins_code:t},atom_sites:{entry_id:t,fract_transf_matrix:V2(3,3),fract_transf_vector:G2(3)},audit_author:{name:t,pdbx_ordinal:u,identifier_ORCID:t},audit_conform:{dict_location:t,dict_name:t,dict_version:t},cell:{angle_alpha:h,angle_beta:h,angle_gamma:h,entry_id:t,length_a:h,length_b:h,length_c:h,Z_PDB:u,pdbx_unique_axis:t},chem_comp:{formula:t,formula_weight:h,id:t,mon_nstd_flag:d(m),name:t,type:d(m),pdbx_synonyms:e(";",e=>e)},chem_comp_bond:{atom_id_1:t,atom_id_2:t,comp_id:t,value_order:d(m),pdbx_ordinal:u,pdbx_stereo_config:d(m),pdbx_aromatic_flag:d(m)},citation:{book_publisher:t,country:t,id:t,journal_abbrev:t,journal_id_ASTM:t,journal_id_CSD:t,journal_id_ISSN:t,journal_volume:t,page_first:t,page_last:t,title:t,year:u,pdbx_database_id_DOI:t,pdbx_database_id_PubMed:u},citation_author:{citation_id:t,name:t,ordinal:u},database_2:{database_id:d(m),database_code:t},entity:{details:t,formula_weight:h,id:t,src_method:d(m),type:d(m),pdbx_description:e(",",e=>e),pdbx_number_of_molecules:u,pdbx_mutation:t,pdbx_fragment:t,pdbx_ec:e(",",e=>e)},entity_poly:{entity_id:t,nstd_linkage:d(m),nstd_monomer:d(m),type:d(t),pdbx_strand_id:e(",",e=>e),pdbx_seq_one_letter_code:t,pdbx_seq_one_letter_code_can:t,pdbx_target_identifier:t},entity_poly_seq:{entity_id:t,hetero:d(m),mon_id:t,num:u},entry:{id:t},exptl:{entry_id:t,method:d(t)},software:{classification:t,date:t,description:t,name:t,type:d(m),version:t,pdbx_ordinal:u},struct:{entry_id:t,title:t,pdbx_descriptor:t},struct_asym:{details:t,entity_id:t,id:t,pdbx_modified:t,pdbx_blank_PDB_chainid_flag:d(t)},struct_conf:{beg_label_asym_id:t,beg_label_comp_id:t,beg_label_seq_id:u,beg_auth_asym_id:t,beg_auth_comp_id:t,beg_auth_seq_id:u,conf_type_id:d(m),details:t,end_label_asym_id:t,end_label_comp_id:t,end_label_seq_id:u,end_auth_asym_id:t,end_auth_comp_id:t,end_auth_seq_id:u,id:t,pdbx_beg_PDB_ins_code:t,pdbx_end_PDB_ins_code:t,pdbx_PDB_helix_class:t,pdbx_PDB_helix_length:u,pdbx_PDB_helix_id:t},struct_conn:{conn_type_id:d(m),details:t,id:t,ptnr1_label_asym_id:t,ptnr1_label_atom_id:t,ptnr1_label_comp_id:t,ptnr1_label_seq_id:u,ptnr1_auth_asym_id:t,ptnr1_auth_comp_id:t,ptnr1_auth_seq_id:u,ptnr1_symmetry:t,ptnr2_label_asym_id:t,ptnr2_label_atom_id:t,ptnr2_label_comp_id:t,ptnr2_label_seq_id:u,ptnr2_auth_asym_id:t,ptnr2_auth_comp_id:t,ptnr2_auth_seq_id:u,ptnr2_symmetry:t,pdbx_ptnr1_PDB_ins_code:t,pdbx_ptnr1_label_alt_id:t,pdbx_ptnr1_standard_comp_id:t,pdbx_ptnr2_PDB_ins_code:t,pdbx_ptnr2_label_alt_id:t,pdbx_ptnr3_PDB_ins_code:t,pdbx_ptnr3_label_alt_id:t,pdbx_ptnr3_label_asym_id:t,pdbx_ptnr3_label_atom_id:t,pdbx_ptnr3_label_comp_id:t,pdbx_ptnr3_label_seq_id:u,pdbx_PDB_id:t,pdbx_dist_value:h,pdbx_value_order:d(m)},struct_conn_type:{criteria:t,id:d(m),reference:t},struct_keywords:{entry_id:t,text:e(",",e=>e),pdbx_keywords:t},struct_ncs_oper:{code:d(t),details:t,id:u,matrix:V2(3,3),vector:G2(3)},struct_sheet_range:{beg_label_asym_id:t,beg_label_comp_id:t,beg_label_seq_id:u,end_label_asym_id:t,end_label_comp_id:t,end_label_seq_id:u,beg_auth_asym_id:t,beg_auth_comp_id:t,beg_auth_seq_id:u,end_auth_asym_id:t,end_auth_comp_id:t,end_auth_seq_id:u,id:t,sheet_id:t,pdbx_beg_PDB_ins_code:t,pdbx_end_PDB_ins_code:t},struct_site:{details:t,id:t,pdbx_num_residues:u,pdbx_evidence_code:t,pdbx_auth_asym_id:t,pdbx_auth_comp_id:t,pdbx_auth_seq_id:t,pdbx_auth_ins_code:t},struct_site_gen:{details:t,id:t,label_alt_id:t,label_asym_id:t,label_atom_id:t,label_comp_id:t,label_seq_id:u,auth_asym_id:t,auth_comp_id:t,auth_seq_id:t,site_id:t,symmetry:t,pdbx_auth_ins_code:t,pdbx_num_res:u},symmetry:{entry_id:t,cell_setting:d(m),Int_Tables_number:u,space_group_name_Hall:t,"space_group_name_H-M":t},pdbx_database_status:{status_code:d(t),status_code_sf:d(t),status_code_mr:d(t),entry_id:t,recvd_initial_deposition_date:t,SG_entry:d(m),deposit_site:d(t),process_site:d(t),status_code_cs:d(t),methods_development_category:d(t),pdb_format_compatible:d(m)},pdbx_nonpoly_scheme:{asym_id:t,entity_id:t,mon_id:t,pdb_strand_id:t,ndb_seq_num:t,pdb_seq_num:t,auth_seq_num:t,pdb_mon_id:t,auth_mon_id:t,pdb_ins_code:t},pdbx_database_related:{db_name:t,details:t,db_id:t,content_type:d(t)},pdbx_entity_nonpoly:{entity_id:t,comp_id:t,name:t},pdbx_chem_comp_synonyms:{name:t,comp_id:t,provenance:d(t)},pdbx_chem_comp_identifier:{comp_id:t,identifier:t,type:d(t),program:t,program_version:t},pdbx_unobs_or_zero_occ_residues:{id:u,polymer_flag:d(m),occupancy_flag:d(u),PDB_model_num:u,auth_asym_id:t,auth_comp_id:t,auth_seq_id:t,PDB_ins_code:t,label_asym_id:t,label_comp_id:t,label_seq_id:u},pdbx_struct_mod_residue:{id:u,auth_asym_id:t,auth_comp_id:t,auth_seq_id:u,PDB_ins_code:t,label_asym_id:t,label_comp_id:t,label_seq_id:u,parent_comp_id:t,details:t},pdbx_struct_oper_list:{id:t,type:d(t),name:t,symmetry_operation:t,matrix:V2(3,3),vector:G2(3)},pdbx_struct_assembly:{method_details:t,oligomeric_details:t,oligomeric_count:u,details:t,id:t},pdbx_struct_assembly_gen:{asym_id_list:e(",",e=>e),assembly_id:t,oper_expression:t},pdbx_reference_entity_list:{prd_id:t,ref_entity_id:t,type:d(m),details:t,component_id:u},pdbx_reference_entity_link:{link_id:u,prd_id:t,details:t,ref_entity_id_1:t,ref_entity_id_2:t,entity_seq_num_1:u,entity_seq_num_2:u,comp_id_1:t,comp_id_2:t,atom_id_1:t,atom_id_2:t,value_order:d(m),component_1:u,component_2:u,link_class:d(t)},pdbx_reference_entity_poly_link:{link_id:u,prd_id:t,ref_entity_id:t,component_id:u,entity_seq_num_1:u,entity_seq_num_2:u,comp_id_1:t,comp_id_2:t,atom_id_1:t,atom_id_2:t,value_order:d(m)},pdbx_molecule:{prd_id:t,instance_id:u,asym_id:t},pdbx_molecule_features:{prd_id:t,class:d(m),type:d(m),name:t,details:t},entity_src_nat:{entity_id:t,pdbx_organism_scientific:t,pdbx_plasmid_name:t,pdbx_src_id:u,pdbx_beg_seq_num:u,pdbx_end_seq_num:u},entity_src_gen:{entity_id:t,pdbx_gene_src_gene:e(",",e=>e),pdbx_gene_src_scientific_name:t,plasmid_name:t,pdbx_src_id:u,pdbx_beg_seq_num:u,pdbx_end_seq_num:u},pdbx_entity_src_syn:{organism_scientific:t,entity_id:t,pdbx_src_id:u,pdbx_beg_seq_num:u,pdbx_end_seq_num:u},pdbx_entity_branch_descriptor:{entity_id:t,descriptor:t,type:d(m),program:t,program_version:t,ordinal:u},pdbx_entity_instance_feature:{details:t,feature_type:d(t),auth_asym_id:t,asym_id:t,auth_seq_num:t,seq_num:u,comp_id:t,auth_comp_id:t,ordinal:u},pdbx_entity_branch_list:{entity_id:t,hetero:d(m),comp_id:t,num:u},pdbx_entity_branch_link:{link_id:u,details:t,entity_id:t,entity_branch_list_num_1:u,entity_branch_list_num_2:u,comp_id_1:t,comp_id_2:t,atom_id_1:t,leaving_atom_id_1:t,atom_stereo_config_1:d(m),atom_id_2:t,leaving_atom_id_2:t,atom_stereo_config_2:d(m),value_order:d(m)},pdbx_entity_branch:{entity_id:t,type:d(t)},pdbx_branch_scheme:{entity_id:t,hetero:d(m),asym_id:t,mon_id:t,num:u,pdb_asym_id:t,pdb_seq_num:t,pdb_mon_id:t,auth_asym_id:t,auth_seq_num:t,auth_mon_id:t},pdbx_chem_comp_related:{comp_id:t,related_comp_id:t,relationship_type:d(t),details:t},ihm_starting_model_details:{starting_model_id:t,entity_id:t,entity_description:t,asym_id:t,entity_poly_segment_id:u,starting_model_source:d(t),starting_model_auth_asym_id:t,starting_model_sequence_offset:u,dataset_list_id:u},ihm_starting_comparative_models:{id:u,starting_model_id:t,starting_model_auth_asym_id:t,starting_model_seq_id_begin:u,starting_model_seq_id_end:u,template_auth_asym_id:t,template_seq_id_begin:u,template_seq_id_end:u,template_sequence_identity:h,template_sequence_identity_denominator:d(u),template_dataset_list_id:u,alignment_file_id:u},ihm_starting_model_seq_dif:{id:u,entity_id:t,asym_id:t,seq_id:u,comp_id:t,starting_model_id:t,db_asym_id:t,db_seq_id:u,db_comp_id:t,details:t},ihm_model_representation:{id:u,name:t,details:t},ihm_model_representation_details:{id:u,representation_id:u,entity_poly_segment_id:u,entity_id:t,entity_description:t,entity_asym_id:t,model_object_primitive:d(t),starting_model_id:t,model_mode:d(t),model_granularity:d(t),model_object_count:u},ihm_struct_assembly_details:{id:u,assembly_id:u,parent_assembly_id:u,entity_description:t,entity_id:t,asym_id:t,entity_poly_segment_id:u},ihm_struct_assembly:{id:u,name:t,description:t},ihm_modeling_protocol:{id:u,num_steps:u,protocol_name:t},ihm_modeling_protocol_details:{id:u,protocol_id:u,step_id:u,struct_assembly_id:u,dataset_group_id:u,struct_assembly_description:t,step_name:t,step_method:t,num_models_begin:u,num_models_end:u,multi_scale_flag:d(m),multi_state_flag:d(m),ordered_flag:d(m),script_file_id:u,software_id:u},ihm_multi_state_modeling:{state_id:u,state_group_id:u,population_fraction:h,population_fraction_sd:h,state_type:t,state_name:t,experiment_type:d(t),details:t},ihm_modeling_post_process:{id:u,protocol_id:u,analysis_id:u,step_id:u,type:d(t),feature:d(t),num_models_begin:u,num_models_end:u},ihm_ensemble_info:{ensemble_id:u,ensemble_name:t,post_process_id:u,model_group_id:u,ensemble_clustering_method:d(t),ensemble_clustering_feature:d(t),num_ensemble_models:u,num_ensemble_models_deposited:u,ensemble_precision_value:h,ensemble_file_id:u},ihm_model_list:{model_id:u,model_name:t,assembly_id:u,protocol_id:u,representation_id:u},ihm_model_group:{id:u,name:t,details:t},ihm_model_group_link:{model_id:u,group_id:u},ihm_model_representative:{id:u,model_group_id:u,model_id:u,selection_criteria:d(t)},ihm_dataset_list:{id:u,data_type:d(t),database_hosted:d(m)},ihm_dataset_group:{id:u,name:t,application:d(t),details:t},ihm_dataset_group_link:{dataset_list_id:u,group_id:u},ihm_related_datasets:{dataset_list_id_derived:u,dataset_list_id_primary:u},ihm_dataset_related_db_reference:{id:u,dataset_list_id:u,db_name:d(t),accession_code:t,version:t,details:t},ihm_external_reference_info:{reference_id:u,reference_provider:t,reference_type:d(t),reference:t,refers_to:d(t),associated_url:t},ihm_external_files:{id:u,reference_id:u,file_path:t,content_type:d(t),file_size_bytes:h,details:t},ihm_dataset_external_reference:{id:u,dataset_list_id:u,file_id:u},ihm_localization_density_files:{id:u,file_id:u,ensemble_id:u,entity_id:t,entity_poly_segment_id:u,asym_id:t},ihm_predicted_contact_restraint:{id:u,group_id:u,entity_id_1:t,entity_id_2:t,asym_id_1:t,asym_id_2:t,comp_id_1:t,comp_id_2:t,seq_id_1:u,seq_id_2:u,rep_atom_1:d(t),rep_atom_2:d(t),distance_lower_limit:h,distance_upper_limit:h,probability:h,restraint_type:d(t),model_granularity:d(t),dataset_list_id:u,software_id:u},ihm_cross_link_list:{id:u,group_id:u,entity_description_1:t,entity_description_2:t,entity_id_1:t,entity_id_2:t,comp_id_1:t,comp_id_2:t,seq_id_1:u,seq_id_2:u,linker_type:d(t),dataset_list_id:u},ihm_cross_link_restraint:{id:u,group_id:u,entity_id_1:t,entity_id_2:t,asym_id_1:t,asym_id_2:t,comp_id_1:t,comp_id_2:t,seq_id_1:u,seq_id_2:u,atom_id_1:t,atom_id_2:t,restraint_type:d(t),conditional_crosslink_flag:d(t),model_granularity:d(t),distance_threshold:h,psi:h,sigma_1:h,sigma_2:h},ihm_cross_link_result_parameters:{id:u,restraint_id:u,model_id:u,psi:h,sigma_1:h,sigma_2:h},ihm_2dem_class_average_restraint:{id:u,dataset_list_id:u,number_raw_micrographs:u,pixel_size_width:h,pixel_size_height:h,image_resolution:h,image_segment_flag:d(m),number_of_projections:u,struct_assembly_id:u,details:t},ihm_2dem_class_average_fitting:{id:u,restraint_id:u,model_id:u,cross_correlation_coefficient:h,rot_matrix:V2(3,3),tr_vector:G2(3)},ihm_3dem_restraint:{id:u,dataset_list_id:u,model_id:u,struct_assembly_id:u,fitting_method:t,number_of_gaussians:u,cross_correlation_coefficient:h},ihm_sas_restraint:{id:u,dataset_list_id:u,model_id:u,struct_assembly_id:u,profile_segment_flag:d(m),fitting_atom_type:t,fitting_method:t,fitting_state:d(t),radius_of_gyration:h,chi_value:h,details:t},ihm_starting_model_coord:{ordinal_id:u,starting_model_id:t,group_PDB:d(t),id:u,type_symbol:t,entity_id:t,atom_id:t,comp_id:t,seq_id:u,asym_id:t,Cartn_x:h,Cartn_y:h,Cartn_z:h,B_iso_or_equiv:h},ihm_sphere_obj_site:{id:u,entity_id:t,seq_id_begin:u,seq_id_end:u,asym_id:t,Cartn_x:h,Cartn_y:h,Cartn_z:h,object_radius:h,rmsf:h,model_id:u},ihm_gaussian_obj_site:{id:u,entity_id:t,seq_id_begin:u,seq_id_end:u,asym_id:t,mean_Cartn_x:h,mean_Cartn_y:h,mean_Cartn_z:h,weight:h,covariance_matrix:V2(3,3),model_id:u},ihm_gaussian_obj_ensemble:{id:u,entity_id:t,seq_id_begin:u,seq_id_end:u,asym_id:t,mean_Cartn_x:h,mean_Cartn_y:h,mean_Cartn_z:h,weight:h,covariance_matrix:V2(3,3),ensemble_id:u},ihm_feature_list:{feature_id:u,feature_type:d(t),entity_type:d(t)},ihm_poly_residue_feature:{ordinal_id:u,feature_id:u,entity_id:t,asym_id:t,comp_id_begin:t,comp_id_end:t,seq_id_begin:u,seq_id_end:u},ihm_derived_distance_restraint:{id:u,group_id:u,feature_id_1:u,feature_id_2:u,group_conditionality:d(t),random_exclusion_fraction:h,distance_upper_limit:h,restraint_type:d(t),dataset_list_id:u},ma_model_list:{ordinal_id:u,model_id:u,model_group_id:u,model_name:t,model_group_name:t,model_type:d(t),data_id:u},ma_target_entity:{entity_id:t,data_id:u,origin:d(t)},ma_target_entity_instance:{asym_id:t,entity_id:t,details:t},ma_target_ref_db_details:{target_entity_id:t,db_name:d(t),db_code:t,db_accession:t,seq_db_isoform:t,seq_db_align_begin:t,seq_db_align_end:t,ncbi_taxonomy_id:t,organism_scientific:t},ma_data:{id:u,content_type:d(t),content_type_other_details:t,name:t},ma_software_group:{ordinal_id:u,group_id:u,software_id:u},ma_qa_metric:{id:u,name:t,type:d(t),mode:d(t),software_group_id:u},ma_qa_metric_global:{ordinal_id:u,model_id:u,metric_id:u,metric_value:h},ma_qa_metric_local:{ordinal_id:u,model_id:u,label_asym_id:t,label_seq_id:u,label_comp_id:t,metric_id:u,metric_value:h}},$2=Zv.Schema;c=$2.str,e=$2.List,G2=$2.lstr,m=$2.Aliased,V2=$2.int,d=$2.coord;let j2={chem_comp:{formula:c,formula_weight:$2.float,id:c,mon_nstd_parent_comp_id:e(",",e=>e),name:c,one_letter_code:c,three_letter_code:c,type:m(G2),pdbx_synonyms:e(";",e=>e),pdbx_type:c,pdbx_ambiguous_flag:c,pdbx_replaced_by:c,pdbx_replaces:c,pdbx_formal_charge:V2,pdbx_model_coordinates_details:c,pdbx_model_coordinates_db_code:c,pdbx_ideal_coordinates_details:c,pdbx_ideal_coordinates_missing_flag:m(G2),pdbx_model_coordinates_missing_flag:m(G2),pdbx_initial_date:c,pdbx_modified_date:c,pdbx_release_status:m(c),pdbx_processing_site:m(c)},chem_comp_atom:{alt_atom_id:c,atom_id:c,charge:V2,model_Cartn_x:d,model_Cartn_y:d,model_Cartn_z:d,comp_id:c,type_symbol:c,pdbx_align:V2,pdbx_ordinal:V2,pdbx_model_Cartn_x_ideal:d,pdbx_model_Cartn_y_ideal:d,pdbx_model_Cartn_z_ideal:d,pdbx_stereo_config:m(G2),pdbx_aromatic_flag:m(G2),pdbx_leaving_atom_flag:m(G2)},chem_comp_bond:{atom_id_1:c,atom_id_2:c,comp_id:c,value_order:m(G2),pdbx_ordinal:V2,pdbx_stereo_config:m(G2),pdbx_aromatic_flag:m(G2)},pdbx_chem_comp_descriptor:{comp_id:c,descriptor:c,type:m(G2),program:c,program_version:c},pdbx_chem_comp_identifier:{comp_id:c,identifier:c,type:m(c),program:c,program_version:c}},W2=Zv.Schema;t=W2.str,u=W2.lstr,h=W2.Aliased,e=W2.int;let q2={pdbx_reference_molecule:{prd_id:t,formula_weight:W2.float,formula:t,type:h(u),type_evidence_code:t,class:h(u),class_evidence_code:t,name:t,represent_as:h(u),chem_comp_id:t,compound_details:t,description:t,representative_PDB_id_code:t,release_status:h(u),replaces:t,replaced_by:t},pdbx_reference_entity_list:{prd_id:t,ref_entity_id:t,type:h(u),details:t,component_id:e},pdbx_reference_entity_nonpoly:{prd_id:t,ref_entity_id:t,name:t,chem_comp_id:t},pdbx_reference_entity_link:{link_id:e,prd_id:t,details:t,ref_entity_id_1:t,ref_entity_id_2:t,entity_seq_num_1:e,entity_seq_num_2:e,comp_id_1:t,comp_id_2:t,atom_id_1:t,atom_id_2:t,value_order:h(u),component_1:e,component_2:e,link_class:h(t)},pdbx_reference_entity_poly_link:{link_id:e,prd_id:t,ref_entity_id:t,component_id:e,entity_seq_num_1:e,entity_seq_num_2:e,comp_id_1:t,comp_id_2:t,atom_id_1:t,atom_id_2:t,value_order:h(u)},pdbx_reference_entity_poly:{prd_id:t,ref_entity_id:t,type:h(t),db_code:t,db_name:t},pdbx_reference_entity_poly_seq:{prd_id:t,ref_entity_id:t,mon_id:t,parent_mon_id:t,num:e,observed:h(u),hetero:h(u)},pdbx_reference_entity_sequence:{prd_id:t,ref_entity_id:t,type:h(t),NRP_flag:h(t),one_letter_codes:t},pdbx_reference_entity_src_nat:{prd_id:t,ref_entity_id:t,ordinal:e,organism_scientific:t,taxid:t,db_code:t,db_name:t},pdbx_prd_audit:{prd_id:t,date:t,processing_site:h(t),action_type:h(t)}},X2=Zv.Schema;d=X2.str;let Y2={datablock:{id:d,description:d},dictionary:{title:d,datablock_id:d,version:d},dictionary_history:{version:d,update:d,revision:d},sub_category:{id:d,description:d},category_group_list:{id:d,parent_id:d,description:d},item_type_list:{code:d,primitive_code:d,construct:d,detail:d},item_units_list:{code:d,detail:d},item_units_conversion:{from_code:d,to_code:d,operator:d,factor:X2.float}},K2=Zv.Schema;V2=K2.str,G2=K2.int,m=K2.float,c=K2.Aliased,u=K2.Vector;c(V2),c(V2),c(V2),c(V2),u(3),u(3);let Z2={volume_data_3d_info:{name:V2,axis_order:u(3,G2),origin:u(3),dimensions:u(3),sample_rate:G2,sample_count:u(3,G2),spacegroup_number:G2,spacegroup_cell_size:u(3),spacegroup_cell_angles:u(3),mean_source:m,mean_sampled:m,sigma_source:m,sigma_sampled:m,min_source:m,min_sampled:m,max_source:m,max_sampled:m},volume_data_3d:{values:m}},Q2=Zv.Schema;e=Q2.float,h=Q2.int,t=Q2.str;let J2={cell:{angle_alpha:e,angle_beta:e,angle_gamma:e,formula_units_z:h,length_a:e,length_b:e,length_c:e,volume:e},chemical:{melting_point:e,name_common:t,name_systematic:t},chemical_formula:{moiety:t,sum:t,weight:e},space_group:{crystal_system:t,it_number:h,"name_h-m_full":t},space_group_symop:{operation_xyz:t},geom_bond:{atom_site_label_1:t,atom_site_label_2:t,distance:e,publ_flag:t,site_symmetry_1:t,site_symmetry_2:t,valence:e},audit:{block_doi:t},database_code:{cod:t,csd:t,depnum_ccdc_archive:t,depnum_ccdc_fiz:t,icsd:t,mdf:t,nbs:t},atom_site:{adp_type:t,calc_flag:t,disorder_assembly:t,disorder_group:t,fract_x:e,fract_y:e,fract_z:e,label:t,occupancy:e,refinement_flags:t,site_symmetry_multiplicity:h,type_symbol:t,u_iso_or_equiv:e},atom_site_aniso:{label:t,u_11:e,u:(0,Q2.Matrix)(3,3),u_12:e,u_13:e,u_22:e,u_23:e,u_33:e},atom_type:{description:t,symbol:t},atom_type_scat:{dispersion_imag:e,dispersion_real:e,source:t}},eS={"cell.formula_units_z":["cell_formula_units_Z"],"space_group.it_number":["space_group_IT_number","symmetry_Int_Tables_number"],"space_group.name_h-m_full":["symmetry_space_group_name_H-M"],"space_group_symop.operation_xyz":["symmetry_equiv_pos_as_xyz"],"geom_bond.atom_site_label_1":["geom_bond_atom_site_id_1"],"geom_bond.atom_site_label_2":["geom_bond_atom_site_id_2"],"geom_bond.distance":["geom_bond_dist"],"audit.block_doi":["audit_block_DOI"],"database_code.cod":["database_code_COD"],"database_code.csd":["database_code_CSD"],"database_code.depnum_ccdc_archive":["database_code_depnum_CCDC_archive"],"database_code.depnum_ccdc_fiz":["database_code_depnum_CCDC_fiz"],"database_code.icsd":["database_code_ICSD"],"database_code.mdf":["database_code_MDF"],"database_code.nbs":["database_code_NBS"],"atom_site.adp_type":["atom_site_ADP_type","atom_site_thermal_displace_type"],"atom_site.label":["atom_site_id"],"atom_site.site_symmetry_multiplicity":["atom_site_symmetry_multiplicity"],"atom_site.u_iso_or_equiv":["atom_site_U_iso_or_equiv"],"atom_site_aniso.label":["atom_site_anisotrop_id"],"atom_site_aniso.u_11":["atom_site_aniso_U_11","atom_site_anisotrop_U_11"],"atom_site_aniso.u_12":["atom_site_aniso_U_12","atom_site_anisotrop_U_12"],"atom_site_aniso.u_13":["atom_site_aniso_U_13","atom_site_anisotrop_U_13"],"atom_site_aniso.u_22":["atom_site_aniso_U_22","atom_site_anisotrop_U_22"],"atom_site_aniso.u_23":["atom_site_aniso_U_23","atom_site_anisotrop_U_23"],"atom_site_aniso.u_33":["atom_site_aniso_U_33","atom_site_anisotrop_U_33"]},tS=Zv.Schema;d=tS.int;let rS={volume_data_3d_info:Z2.volume_data_3d_info,segmentation_data_table:{set_id:d,segment_id:d},segmentation_data_3d:{values:d}},iS={parse:e=>("string"==typeof e?t2:L2)(e),parseText:t2,parseBinary:L2,toDatabaseCollection:function(e,t,r){var i,n={};for(i of t.blocks)n[i.header]=k2(e,i,r);return n},toDatabase:k2,schema:{mmCIF:e=>k2(H2,e),CCD:e=>k2(j2,e),BIRD:e=>k2(q2,e),dic:e=>k2(Y2,e),cifCore:e=>k2(J2,e,eS),densityServer:e=>k2(Z2,e),segmentation:e=>k2(rS,e)}};class nS{constructor(e,t){t=t||{};this.streamer=e,this.name=ce(t.name,""),this.path=ce(t.path,"")}get type(){return""}get __objName(){return""}get isBinary(){return!1}get isJson(){return!1}get isXml(){return!1}parse(){return this.streamer.read().then(()=>u0(this,void 0,void 0,function*(){return yield this._beforeParse(),yield this._parse(),yield this._afterParse(),this[this.__objName]}))}_parse(){}_beforeParse(){}_afterParse(){Je.Debug&&rt.log(this[this.__objName])}}class aS extends nS{constructor(e,t){t=t||{};super(e,t),this.firstModelOnly=ce(t.firstModelOnly,!1),this.asTrajectory=ce(t.asTrajectory,!1),this.cAlphaOnly=ce(t.cAlphaOnly,!1),this.structure=new Kg(this.name,this.path),this.structureBuilder=new pg(this.structure)}get type(){return"structure"}get __objName(){return"structure"}}class sS{constructor(t,r,e="",i,n=[]){this.structure=t,this.index=r,this.description=e,this.entityType=(e=>{switch(e=e.toLowerCase()){case"polymer":return 1;case"non-polymer":return 2;case"macrolide":return 3;case"water":return 4;default:return 0}})(i||""),(this.chainIndexList=n).forEach(function(e){t.chainStore.entityIndex[e]=r})}get type(){switch(this.entityType){case 1:return"polymer";case 2:return"non-polymer";case 3:return"macrolide";case 4:return"water";default:return}}getEntityType(){return this.entityType}isPolymer(){return 1===this.entityType}isNonPolymer(){return 2===this.entityType}isMacrolide(){return 3===this.entityType}isWater(){return 4===this.entityType}eachChain(t){let r=this.structure.getChainProxy();this.chainIndexList.forEach(function(e){r.index=e,t(r)})}}let oS={a:1,b:1,c:1,alpha:90,beta:90,gamma:90,spacegroup:"P 1"};class lS{constructor(e=oS){this.cartToFrac=new tt,this.fracToCart=new tt,this.a=e.a,this.b=e.b,this.c=e.c,this.alpha=e.alpha,this.beta=e.beta,this.gamma=e.gamma,this.spacegroup=e.spacegroup;var t,r=sh(this.alpha),i=sh(this.beta),n=sh(this.gamma),r=Math.cos(r),a=Math.cos(i),s=Math.cos(n),i=Math.sin(i),n=Math.sin(n);this.volume=this.a*this.b*this.c*Math.sqrt(1-r*r-a*a-s*s+2*r*a*s),(void 0===e.cartToFrac?(t=this.a*this.b*n/this.volume,this.fracToCart.set(this.a,0,0,0,this.b*s,this.b*n,0,0,this.c*a,-this.c*i*((a*s-r)/(i*n)),1/t,0,0,0,0,1).transpose(),this.cartToFrac.copy(this.fracToCart)):(this.cartToFrac.copy(e.cartToFrac),this.fracToCart.copy(this.cartToFrac))).invert()}getPosition(e){let o=new Float32Array(24);if(e.unitcell){let i=e.unitcell,n=e.center.clone().applyMatrix4(i.cartToFrac).floor(),a=new et,s=0;e=function(e,t,r){a.set(e,t,r).add(n).applyMatrix4(i.fracToCart).toArray(o,s),s+=3};e(0,0,0),e(1,0,0),e(0,1,0),e(0,0,1),e(1,1,0),e(1,0,1),e(0,1,1),e(1,1,1)}return o}getCenter(e){var[t,r=new et]=[this.getPosition(e)],i=t.length;for(let e=0;e<i;e+=3)r.x+=t[e],r.y+=t[e+1],r.z+=t[e+2];return r.divideScalar(i/3),r}getData(e,t={}){var r=ce(t.colorValue,"orange"),t=ce(t.radius,Math.cbrt(this.volume)/200),r=new ze(r);let i=new et,n=this.getPosition(e);var a=_(8,r.r,r.g,r.b),s=qc(8,t);let o=new Float32Array(36),l=new Float32Array(36);r=_(12,r.r,r.g,r.b),t=qc(12,t);let h=0;function c(e,t){i.fromArray(n,3*e).toArray(o,h),i.fromArray(n,3*t).toArray(l,h),h+=3}c(0,1),c(0,2),c(0,3),c(1,4),c(1,5),c(2,6),c(3,5),c(4,7),c(5,7),c(2,4),c(7,6),c(3,6);e=new Dp(this,e);return{vertex:{position:n,color:a,radius:s,picking:e},edge:{position1:o,position2:l,color:r,color2:r,radius:t,picking:e}}}}let hS={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h",0:"h"},cS=["DAL","DAR","DSG","DAS","DCY","DGL","DGN","DHI","DIL","DLE","DLY","MED","DPN","DPR","DSN","DTH","DTR","DTY","DVA","DNE"],uS=["MOL_ID","MOLECULE","CHAIN","FRAGMENT","SYNONYM","EC","ENGINEERED","MUTATION","OTHER_DETAILS"],dS=/\s+/;function mS(e,t,r){let i=""+e;return t&&(i+=":"+t),r&&(i+="^"+r),i}class pS extends aS{constructor(e,t){t=t||{};super(e,t),this.hex=ce(t.hex,!1),this.inferBonds=ce(t.inferBonds,"all")}get type(){return"pdb"}_parse(){Je.Debug&&rt.time("PdbParser._parse "+this.name);let he=!1;var e=this.streamer.peekLines(1)[0],t=e.substr(62,4),e=e.substr(72,4);t===e&&e.trim()&&(he=!0);let P="pqr"===this.type,ce="pdbqt"===this.type,I=this.structure,ue=this.structureBuilder,de=this.hex,me=10,pe=10,fe=this.firstModelOnly,ge=this.asTrajectory,ve=this.cAlphaOnly,_e=I.frames,ye=I.boxes,R=!1,D,be,xe=I.biomolDict,L,O,k,N,F,B,U,z,V,G,H,$,j,Se,we,Ae,W,q,X,Y,K,Z,Q={},J={},Me={},ee=[],te,re,Ce={},Te={},Ee={},ie,ne,ae,Pe,Ie,Re,De,Le={},Oe;t={helices:[],sheets:[]};let ke=t.helices,Ne=t.sheets,Fe=I.atomMap,se=I.atomStore,Be=(se.resize(Math.round(this.streamer.data.length/80)),(P||ce)&&se.addField("partialCharge",1,"float32"),P&&se.addField("radius",1,"float32"),I.getAtomProxy()),Ue=I.getAtomProxy(),oe=0,ze=0,le=!0;function r(t,r,i){for(let e=t;e<r;++e)if(N=i[e],"ATOM  "===(F=N.substr(0,6))||"HETATM"===F){if(le&&(ge?(R?(D=new Float32Array(3*se.count),_e.push(D)):D=[],be=0):fe||(Q={}),ie=1,ne=ie.toString(),ae=!0,le=!1),!(fe&&0<ze)){let e,t,r,i,n=0;if(P){if(i=N.split(dS),n=10===i.length?1:0,$=i[2],ve&&"CA"!==$)continue;e=parseFloat(i[6-n]),t=parseFloat(i[7-n]),r=parseFloat(i[8-n])}else{if($=N.substr(12,4).trim(),ve&&"CA"!==$)continue;e=parseFloat(N.substr(30,8)),t=parseFloat(N.substr(38,8)),r=parseFloat(N.substr(46,8))}if(ge){var s=3*be;if(D[0+s]=e,D[1+s]=t,D[2+s]=r,be+=1,R)continue}let a;P?(B=parseInt(i[1]),a="",j="H"===N[0],U=n?"":i[4],z=parseInt(i[5-n]),H="",V=i[3],we="",G=1):(B=parseInt(N.substr(6,5),me),de&&99999===B&&(me=16),j="H"===N[0],U=N[21].trim(),z=parseInt(N.substr(22,4),pe),de&&9999===z&&(pe=16),H=N[26].trim(),V=N.substr(17,4).trim()||"MOL",Se=parseFloat(N.substr(60,6)),we=N[16].trim(),G=parseFloat(N.substr(54,6)),he||(ce?(a=N.substr(76,3).trim())in Pm&&(a=Pm[a]):(a=N.substr(76,2).trim(),U=U||N.substr(72,4).trim()),Ae=parseInt((N.substr(79,1)+N.substr(78,1)).trim()))),se.growIfFull(),se.atomTypeId[oe]=Fe.add($,a),se.x[oe]=e,se.y[oe]=t,se.z[oe]=r,se.serial[oe]=B,se.altloc[oe]=we.charCodeAt(0),se.occupancy[oe]=isNaN(G)?0:G,P?(se.partialCharge[oe]=parseFloat(i[9-n]),se.radius[oe]=parseFloat(i[10-n])):(se.bfactor[oe]=isNaN(Se)?0:Se,ce&&(se.partialCharge[oe]=parseFloat(N.substr(70,6))),isFinite(Ae)&&(se.formalCharge||se.addField("formalCharge",1,"int8"),se.formalCharge[oe]=Ae));s=mS(z,U,H);!j||Te[s]||cS.includes(V)?ae||Pe===U||(ie+=1,ne=ie.toString()):Pe===U&&Re===V&&(wm.includes(V)||Ie===z&&De===H)||(ie+=1,ne=ie.toString(),Ie=z,Re=V,De=H),ue.addAtom(ze,U,ne,V,z,j,void 0,H),Q[B]=oe,oe+=1,ae=!1,Pe=U}}else if("CONECT"===F){var n=Q[parseInt(N.substr(6,5))],a=[11,16,21,26],o={};if(void 0!==n)for(let e=0;e<4;++e){var l,h=parseInt(N.substr(a[e],5));Number.isNaN(h)||void 0!==(h=Q[h])&&(n<h?(Be.index=n,Ue.index=h):(Be.index=h,Ue.index=n),void 0!==o[h]?I.bondStore.bondOrder[o[h]]+=1:(l=Be.index+"|"+Ue.index,void 0===Me[l]&&(Me[l]=!0,o[h]=I.bondStore.count,I.bondStore.addBond(Be,Ue,1))))}}else if("HELIX "===F){W=N[19].trim(),q=parseInt(N.substr(21,4)),X=N[25].trim(),Y=N[31].trim(),K=parseInt(N.substr(33,4)),Z=N[37].trim();var c=parseInt(N.substr(39,1)),c=(hS[c]||hS[0]).charCodeAt(0);ke.push([W,q,X,Y,K,Z,c])}else if("SHEET "===F)W=N[21].trim(),q=parseInt(N.substr(22,4)),X=N[26].trim(),Y=N[32].trim(),K=parseInt(N.substr(33,4)),Z=N[37].trim(),Ne.push([W,q,X,Y,K,Z]);else if("HETNAM"===F)Ce[N.substr(11,3)]=N.substr(15).trim();else if("SEQRES"===F){c=N[11].trim();c!==Oe&&(Le[c]=[],Oe=c),Le[c].push(...N.substr(19).trim().split(dS))}else if("MODRES"===F){let e=N.substr(12,3).trim(),t=N[16].trim(),r=N[22].trim(),i=parseInt(N.substr(18,4).trim());var u=mS(i,t,r);Te[u]={resname:e,chainname:t,inscode:r,resno:i}}else if("COMPND"===F){var u=N.substr(10,70).trim(),d=u.indexOf(":"),m=u.substring(0,d);let e;e=(e=uS.includes(m)?(re=m,u.substring(d+2)):u).replace(/;$/,""),"MOL_ID"===re?(te={chainList:[],name:""},ee.push(te)):"MOLECULE"===re?(te.name&&(te.name+=" "),te.name+=e):"CHAIN"===re&&Array.prototype.push.apply(te.chainList,e.split(/\s*,\s*/))}else if(N.startsWith("TER")){m=I.getChainProxy(I.chainStore.count-1);Ee[m.chainname]=m.index,ie+=1,ne=ie.toString(),ae=!0}else if("REMARK"===F&&"350"===N.substr(7,3)){if("BIOMOLECULE:"===N.substr(11,12)){let e=N.substr(23).trim();/^(0|[1-9][0-9]*)$/.test(e)&&(e="BU"+e),L=new dg(e),xe[e]=L}else if("BIOMT"===N.substr(13,5)){var d=N.split(/\s+/),p=parseInt(N[18])-1,f=(0==p&&(k=new tt,O.matrixList.push(k)),k.elements);f[p]=parseFloat(d[4]),f[4+p]=parseFloat(d[5]),f[8+p]=parseFloat(d[6]),f[12+p]=parseFloat(d[7])}else if("APPLY THE FOLLOWING TO CHAINS:"===N.substr(11,30)||"                   AND CHAINS:"===N.substr(11,30)){"APPLY"===N.substr(11,5)&&(O=L.addPart());var g=N.substr(41,30).split(",");for(let e=0,t=g.length;e<t;++e){var v=g[e].trim();v&&O.chainList.push(v)}}}else{var _,y,b,x,S,w,A,M,C,T,E;"HEADER"===F?I.id=N.substr(62,4):"TITLE "===F?I.title+=(I.title?" ":"")+N.substr(10,70).trim():"MODEL "===F?le=!0:"ENDMDL"===F||"END"===N.trim()?le||(ge&&!R&&(_e.push(new Float32Array(D)),R=!0),ze+=1,le=!0):"MTRIX"===N.substr(0,5)?"1"!==N[59]&&(L&&"NCS"===L.name||(L=new dg("NCS"),xe.NCS=L,O=L.addPart()),f=N.split(/\s+/),0==(p=parseInt(N[5])-1)&&(k=new tt,O.matrixList.push(k)),(_=k.elements)[p]=parseFloat(f[2]),_[4+p]=parseFloat(f[3]),_[8+p]=parseFloat(f[4]),_[12+p]=parseFloat(f[5])):"ORIGX"===N.substr(0,5)?(J.origx||(J.origx=new tt),_=N.split(/\s+/),b=parseInt(N[5])-1,(y=J.origx.elements)[b]=parseFloat(_[1]),y[4+b]=parseFloat(_[2]),y[8+b]=parseFloat(_[3]),y[12+b]=parseFloat(_[4])):"SCALE"===N.substr(0,5)?(J.scale||(J.scale=new tt),y=N.split(/\s+/),b=parseInt(N[5])-1,(x=J.scale.elements)[b]=parseFloat(y[1]),x[4+b]=parseFloat(y[2]),x[8+b]=parseFloat(y[3]),x[12+b]=parseFloat(y[4])):"CRYST1"===F&&(x=parseFloat(N.substr(6,9)),S=parseFloat(N.substr(15,9)),w=parseFloat(N.substr(24,9)),A=parseFloat(N.substr(33,7)),M=parseFloat(N.substr(40,7)),C=parseFloat(N.substr(47,7)),T=N.substr(55,11).trim(),(E=new Float32Array(9))[0]=x,E[4]=S,E[8]=w,ye.push(E),0===ze)&&(J.a=x,J.b=S,J.c=w,J.alpha=A,J.beta=M,J.gamma=C,J.spacegroup=T)}}this.streamer.eachChunkOfLines(function(e){r(0,e.length,e)}),ue.finalize();let i=ee.length;if(i){I.eachChain(function(e){e.entityIndex=i}),ee.forEach(function(e,t){var r=e.chainList.map(function(e){return Ee[e]});I.entityList.push(new sS(I,t,e.name,"polymer",r))});let n=ee.length,t=I.getResidueProxy(),a={};I.eachChain(function(e){e.entityIndex===i&&(t.index=e.residueOffset,a[t.resname]||(a[t.resname]=[]),a[t.resname].push(e.index))}),Object.keys(a).forEach(function(e){var t=a[e];let r="non-polymer",i=Ce[e]||e;wm.includes(e)&&(i="water",r="water"),I.entityList.push(new sS(I,n,i,r,t)),n+=1})}void 0!==J.a?I.unitcell=new lS(J):I.unitcell=void 0,(ke.length||Ne.length)&&fg(I,t),I.finalizeAtoms(),he||yg(I),bg(I,this.inferBonds),I.finalizeBonds(),ke.length||Ne.length||gg(I),Mg(I),Je.Debug&&rt.timeEnd("PdbParser._parse "+this.name)}}a.add("pdb",pS),a.add("pdb1",pS),a.add("ent",pS);class fS{constructor(e){this.structure=e,this.dict={},this.structure=e}add(e,t,r){this.dict[e]={chemCompType:t},r&&(this.dict[e].bonds=r)}addBond(e,t,r,i){var e=this.dict[e];e&&(e.bonds||(e.bonds={atom1:[],atom2:[],bondOrders:[]}),(e=e.bonds).atom1.push(t),e.atom2.push(r),e.bondOrders.push(i))}getBonds(e,i){var n=null==(e=this.dict[e])?void 0:e.bonds;if(n){let r=this.structure.atomMap;var a,s=new Map(i.map((e,t)=>[null==(e=r.get(e))?void 0:e.atomname,t])),o=[],l=[],h=[];let t;for(let e=0;e<n.atom1.length;e++)void 0!==(a=s.get(n.atom1[e]))&&void 0!==(t=s.get(n.atom2[e]))&&(o.push(a),l.push(t),h.push(n.bondOrders[e]));return{atomIndices1:o,atomIndices2:l,bondOrders:h}}}}let gS=/^\D{1,2}/,vS={HELX_RH_AL_P:"h",STRN:"e",HELX_RH_3T_P:"g",HELX_RH_PI_P:"i",HELX_LH_PP_P:"e",TURN_TY1_P:"t",BEND:"s",OTHER:" "},_S={AROM:1,DELO:2,DIRECTED:0,DOUB:2,PI:0,POLY:0,QUAD:4,SING:1,TRIP:3};function yS(e){switch(e.toLowerCase()){case"?":case"sing":return 1;case"doub":return 2;case"trip":return 3;case"quad":return 4}return 0}class bS extends aS{get type(){return"cif"}get isBinary(){return!1}_parse(){var Ze,Qe;return u0(this,void 0,void 0,function*(){rt.time("CifParser._parse "+this.name);var a=this.structure,s=this.structureBuilder,e=this.firstModelOnly,o=this.asTrajectory,F=a.frames;let l;var h=yield(this.isBinary?iS.parseBinary(this.streamer.data):iS.parseText(this.streamer.compressed?Yl(this.streamer.data):this.streamer.data)).run();if(h.isError)throw h;h=h.result.blocks[0];if("chem_comp"in h.categories&&"chem_comp_atom"in h.categories&&!("struct"in h.categories)){{var r=h.categories;var i=a;var B=s;let v=i.atomStore,_=i.atomMap,e,y;var n=r.chem_comp;let b=r.chem_comp_atom;r=r.chem_comp_bond;let t,x=(n&&((t=n.getField("name"))&&(i.title=t.str(0)),t=n.getField("id"))&&(i.id=t.str(0)),{});if(b){let h,c,u,d,m=(y=b.rowCount,v.resize(2*y),b.getField("atom_id")),p=b.getField("type_symbol"),f=b.getField("pdbx_component_comp_id"),g=b.getField("pdbx_residue_numbering");[["model_Cartn_x","model_Cartn_y","model_Cartn_z"],["pdbx_model_Cartn_x_ideal","pdbx_model_Cartn_y_ideal","pdbx_model_Cartn_z_ideal"]].forEach(([e,t,r],i)=>{var n=b.getField(e),a=b.getField(t),s=b.getField(r),o=i*y;for(let e=0;e<y;++e){var l=e+o;v.growIfFull(),h=null==m?void 0:m.str(e),c=null==p?void 0:p.str(e),x[h]=e,v.atomTypeId[l]=_.add(h,c),v.x[l]=n.float(e),v.y[l]=a.float(e),v.z[l]=s.float(e),v.serial[l]=e,u=f.str(e),d=null!=(l=null==g?void 0:g.int(e))?l:1,B.addAtom(i,"","",u,d,!0)}})}if(b&&r){y=r.rowCount;var U,z,c,V=b.rowCount,u=i.getAtomProxy(),d=i.getAtomProxy(),G=r.getField("atom_id_1"),H=r.getField("atom_id_2"),$=r.getField("value_order");for(e=0;e<y;++e)U=G.str(e),z=H.str(e),c=yS($.str(e)),u.index=x[U],d.index=x[z],i.bondStore.growIfFull(),i.bondStore.addBond(u,d,c),u.index+=V,d.index+=V,i.bondStore.growIfFull(),i.bondStore.addBond(u,d,c)}}s.finalize(),a.finalizeAtoms(),a.finalizeBonds(),Pg(a)}else if("atom_site_type_symbol"in h.categories&&"atom_site_label"in h.categories&&"atom_site_fract_x"in h.categories){{n=h;var m=a;var j=s;var p=m.atomStore,W=m.atomMap;n.header&&(m.id=n.header,m.name=n.header),m.unitcell=new lS({a:n.getField("cell_length_a").float(0),b:n.getField("cell_length_b").float(0),c:n.getField("cell_length_c").float(0),alpha:n.getField("cell_angle_alpha").float(0),beta:n.getField("cell_angle_beta").float(0),gamma:n.getField("cell_angle_gamma").float(0),spacegroup:n.getField("symmetry_space_group_name_H-M").str(0)});let u=new et;var f=new et,g=n.getField("atom_site_type_symbol");if(g){let s=null!=(r=g.rowCount)?r:0;var q=n.getField("atom_site_type_symbol"),X=n.getField("atom_site_fract_x"),Y=n.getField("atom_site_fract_y"),K=n.getField("atom_site_fract_z"),Z=n.getField("atom_site_occupancy"),Q={};for(let t=0;t<s;++t){p.growIfFull();var v,J=q.str(t),_=g.str(t);let e=Q[_];e||(v=_.match(gS),Q[_]=e=null!=(v=null==v?void 0:v[0])?v:_),p.atomTypeId[t]=W.add(J,e),u.set(X.float(t),Y.float(t),K.float(t)),u.applyMatrix4(m.unitcell.fracToCart),f.add(u),p.x[t]=u.x,p.y[t]=u.y,p.z[t]=u.z,Z&&(p.occupancy[t]=Z.float(t)),p.serial[t]=t,j.addAtom(0,"","","HET",1,!0)}f.divideScalar(s),m.center=f,Mg(m);let o=new et,l=new et;var t=m.biomolDict.SUPERCELL.partList[0].matrixList;let h=s,c=new tt;for(let a=0;a<s;++a){let n=ee(a);u.set(p.x[a],p.y[a],p.z[a]),t.forEach(function(e){if(!c.equals(e)){o.copy(u),o.applyMatrix4(e);for(let e=0;e<s;++e){l.set(p.x[e],p.y[e],p.z[e]);var t=o.distanceToSquared(l),r=ee(e)+n,i=r+.3,r=r-.5;if(t<i*i&&r*r<t)return p.growIfFull(),p.atomTypeId[h]=p.atomTypeId[a],p.x[h]=o.x,p.y[h]=o.y,p.z[h]=o.z,p.occupancy[h]=p.occupancy[a],p.serial[h]=h,p.altloc[h]="A".charCodeAt(0),j.addAtom(0,"","","HET",1,!0),void(h+=1)}}})}function ee(e){return W.get(p.atomTypeId[e]).covalent}}}s.finalize(),a.finalizeAtoms(),bg(a),a.finalizeBonds()}else{var y={},b={},te=a.atomMap,x=a.atomStore,S=h.categories.atom_site;let t=S.rowCount;var w=S.getField("pdbx_PDB_model_num");if(!(null==(Qe=null==w?void 0:w.areValuesEqual(0,t-1))||Qe)&&(o||e)){var re=w.int(0);for(let e=0;e<t;e++)if(w.int(e)>re){t=e;break}}a.chemCompMap=new fS(a);var A=h.categories.chem_comp;let r=A.getField("id");var ie=A.getField("type");for(let e=0;e<A.rowCount;e++)a.chemCompMap.add(r.str(e),ie.str(e).toUpperCase());if(h.categoryNames.includes("chem_comp_bond")){var M=h.categories.chem_comp_bond,ne=(r=M.getField("comp_id"),M.getField("atom_id_1")),ae=M.getField("atom_id_2"),se=M.getField("value_order");for(let e=0;e<M.rowCount;e++){var oe=_S[se.str(e)];oe&&a.chemCompMap.addBond(r.str(e),ne.str(e),ae.str(e),oe)}}var e=(e,t,r)=>{e=e.getField(t);return e?e.toFloatArray({array:Float32Array,start:0,end:r}):new Float32Array(r)},e=(x.resize(t),x.x=e(S,"Cartn_x",t),x.y=e(S,"Cartn_y",t),x.z=e(S,"Cartn_z",t),x.serial=S.getField("id").toIntArray({start:0,end:t}),x.bfactor=e(S,"B_iso_or_equiv",t),x.occupancy=e(S,"occupancy",t),S.getField("label_alt_id")),le=(null!=e&&e.isDefined&&(x.altloc=Uint8Array.from(e.toStringArray(),e=>e.charCodeAt(0))),S.getField("label_atom_id")),he=S.getField("type_symbol"),ce=(r=S.getField("label_comp_id"),null!=(Qe=S.getField("auth_seq_id"))?Qe:S.getField("label_seq_id")),ue=S.getField("pdbx_PDB_ins_code"),de=S.getField("auth_asym_id"),me=S.getField("label_asym_id"),pe=S.getField("group_PDB"),fe=S.getField("label_entity_id");for(let e=0;e<t;e++){var ge=null!=(Ze=null==w?void 0:w.int(e))?Ze:1,ve=null!=(Ze=null==de?void 0:de.str(e))?Ze:"",_e=null!=(Ze=null==me?void 0:me.str(e))?Ze:"",ye=null!=(Ze=null==r?void 0:r.str(e))?Ze:"",be=null!=(Ze=null==ce?void 0:ce.int(e))?Ze:0,xe="H"===(null==pe?void 0:pe.str(e)[0]),Se=null!=(Ze=null==ue?void 0:ue.str(e))?Ze:"",C=null!=(Ze=null==fe?void 0:fe.int(e))?Ze:1;x.atomTypeId[e]=te.add((null==le?void 0:le.str(e))||"",null==he?void 0:he.str(e)),s.addAtom(ge-1,ve,_e,ye,be,xe,void 0,Se),y[_e]=ve,b[C]||(b[C]=new Set),b[C].add(a.chainStore.count-1)}if(o){var we=S.rowCount/t|0,Ae=S.getField("Cartn_x"),Me=S.getField("Cartn_y"),Ce=S.getField("Cartn_z");for(let e=0;e<we;e++){var T=new Float32Array(3*t),Te=e*t,Ee=Te+t;l=0;for(let e=Te;e<Ee;e++)T[l+0]=Ae.float(e),T[l+1]=Me.float(e),T[l+2]=Ce.float(e),l+=3;F.push(T)}}var e=((e,t)=>{var r,i,n,a=[],s=[];let o,l,h,c;var u=e.struct_conf;if(null!=u&&u.fieldNames.includes("pdbx_PDB_helix_class")){var d=u.getField("pdbx_beg_PDB_ins_code"),m=u.getField("pdbx_end_PDB_ins_code"),p=u.getField("pdbx_PDB_helix_class"),f=u.getField("beg_label_asym_id"),g=u.getField("end_label_asym_id"),v=u.getField("beg_auth_seq_id"),_=u.getField("end_auth_seq_id");for(o=0,l=u.rowCount;o<l;++o){var y=null==p?void 0:p.int(o);Number.isFinite(y)&&(h=null!=(r=null==d?void 0:d.str(o))?r:"",c=null!=(r=null==m?void 0:m.str(o))?r:"",a.push([t[f.str(o)],v.int(o),h,t[g.str(o)],_.int(o),c,(hS[y]||hS[0]).charCodeAt(0)]))}}else if(null!=u&&u.fieldNames.includes("conf_type_id")){var b=u.getField("conf_type_id"),x=u.getField("pdbx_beg_PDB_ins_code"),S=u.getField("pdbx_end_PDB_ins_code"),w=u.getField("beg_label_asym_id"),A=u.getField("end_label_asym_id"),M=u.getField("beg_auth_seq_id"),C=u.getField("end_auth_seq_id");for(o=0,l=u.rowCount;o<l;++o){var T=b.str(o);(T=vS[T])&&(h=null!=(i=null==x?void 0:x.str(o))?i:"",c=null!=(i=null==S?void 0:S.str(o))?i:"","h"===T||"g"===T||"i"===T?a.push([t[w.str(o)],M.int(o),h,t[A.str(o)],C.int(o),c,T.charCodeAt(0)]):"e"===T&&s.push([t[w.str(o)],M.int(o),h,t[A.str(o)],C.int(o),c]))}}if((e=e.struct_sheet_range)&&0===s.length){var E=e.getField("pdbx_beg_PDB_ins_code"),P=e.getField("pdbx_end_PDB_ins_code"),I=e.getField("beg_label_asym_id"),R=e.getField("end_label_asym_id"),D=e.getField("beg_auth_seq_id"),L=e.getField("end_auth_seq_id");for(o=0,l=e.rowCount;o<l;++o)h=null!=(n=null==E?void 0:E.str(o))?n:"",c=null!=(n=null==P?void 0:P.str(o))?n:"",s.push([t[I.str(o)],D.int(o),h,t[R.str(o)],L.int(o),c])}return!(!u&&!e)&&{helices:a,sheets:s}})(h.categories,y),o=(((e,t,r)=>{let a={};var i=t.biomolDict;if(e.pdbx_struct_oper_list){var n=e.pdbx_struct_oper_list,s=n.getField("id"),o=n.getField("matrix[1][1]"),l=n.getField("matrix[1][2]"),N=n.getField("matrix[1][3]"),F=n.getField("matrix[2][1]"),B=n.getField("matrix[2][2]"),U=n.getField("matrix[2][3]"),z=n.getField("matrix[3][1]"),V=n.getField("matrix[3][2]"),G=n.getField("matrix[3][3]"),H=n.getField("vector[1]"),$=n.getField("vector[2]"),j=n.getField("vector[3]");for(let e=0;e<n.rowCount;e++){var h=new tt,c=h.elements;c[0]=o.float(e),c[1]=l.float(e),c[2]=N.float(e),c[4]=F.float(e),c[5]=B.float(e),c[6]=U.float(e),c[8]=z.float(e),c[9]=V.float(e),c[10]=G.float(e),c[3]=H.float(e),c[7]=$.float(e),c[11]=j.float(e),h.transpose(),a[s.str(e)]=h}}if(e.pdbx_struct_assembly_gen){var u=e.pdbx_struct_assembly_gen,d=function(e){let n={};return e.replace(/[()']/g,"").split(",").forEach(function(e){if(e.includes("-"))for(var t=e.split("-"),r=parseInt(t[0]),i=parseInt(t[1]);r<=i;++r)n[r]=a[r];else n[e]=a[e]}),n},W=u.getField("assembly_id"),q=u.getField("oper_expression"),X=u.getField("asym_id_list");for(let t=0;t<u.rowCount;t++){var Y=W.int(t);let a={};var m=q.str(t).replace(/['"]\(|['"]/g,"");if(m.includes(")(")||0<m.indexOf("(")){var[p,K]=m.split("(").filter(e=>!!e);let i=d(p),n=d(K);Object.keys(i).forEach(function(r){Object.keys(n).forEach(function(e){var t=new tt;t.multiplyMatrices(i[r],n[e]),a[r+"x"+e]=t})})}else a=d(m);var f,g=[];for(f in a)g.push(a[f]);let e=""+Y;/^(0|[1-9][0-9]*)$/.test(e)&&(e="BU"+e);p=X.str(t).split(",").map(e=>r[e]);void 0===i[e]&&(i[e]=new dg(e)),i[e].addPart(g,p)}}if(e.struct_ncs_oper){var v=e.struct_ncs_oper,_=(i.NCS=new dg("NCS"),i.NCS.addPart()),Z=v.getField("code"),Q=v.getField("matrix[1][1]"),J=v.getField("matrix[1][2]"),ee=v.getField("matrix[1][3]"),te=v.getField("matrix[2][1]"),re=v.getField("matrix[2][2]"),ie=v.getField("matrix[2][3]"),ne=v.getField("matrix[3][1]"),ae=v.getField("matrix[3][2]"),se=v.getField("matrix[3][3]"),oe=v.getField("vector[1]"),le=v.getField("vector[2]"),he=v.getField("vector[3]");for(let e=0;e<v.rowCount;e++){if("given"===Z.str(e))return;var y=new tt,b=y.elements;b[0]=Q.float(e),b[1]=J.float(e),b[2]=ee.float(e),b[4]=te.float(e),b[5]=re.float(e),b[6]=ie.float(e),b[8]=ne.float(e),b[9]=ae.float(e),b[10]=se.float(e),b[3]=oe.float(e),b[7]=le.float(e),b[11]=he.float(e),y.transpose(),_.matrixList.push(y)}0===_.matrixList.length&&delete i.NCS}var x,S,w,A,M,C,T,E,P,I,R,D,L={},O=(e.cell&&(D=(x=e.cell).getField("length_a").float(0),R=x.getField("length_b").float(0),k=x.getField("length_c").float(0),(O=new Float32Array(9))[0]=D,O[4]=R,O[8]=k,t.boxes.push(O),L.a=D,L.b=R,L.c=k,L.alpha=x.getField("angle_alpha").float(0),L.beta=x.getField("angle_beta").float(0),L.gamma=x.getField("angle_gamma").float(0)),e.symmetry&&(L.spacegroup=e.symmetry.getField("space_group_name_H-M").str(0)),new tt),k=(e.database_PDB_matrix&&(D=e.database_PDB_matrix,R=O.elements,k=D.getField("origx[1][1]"),x=D.getField("origx[1][2]"),S=D.getField("origx[1][3]"),w=D.getField("origx[2][1]"),A=D.getField("origx[2][2]"),M=D.getField("origx[2][3]"),C=D.getField("origx[3][1]"),T=D.getField("origx[3][2]"),E=D.getField("origx[3][3]"),P=D.getField("origx_vector[1]"),I=D.getField("origx_vector[2]"),D=D.getField("origx_vector[3]"),R[0]=k.float(0),R[1]=x.float(0),R[2]=S.float(0),R[4]=w.float(0),R[5]=A.float(0),R[6]=M.float(0),R[8]=C.float(0),R[9]=T.float(0),R[10]=E.float(0),R[3]=P.float(0),R[7]=I.float(0),R[11]=D.float(0),O.transpose(),L.origx=O),new tt);e.atom_sites&&(x=e.atom_sites,S=k.elements,w=x.getField("fract_transf_matrix[1][1]"),A=x.getField("fract_transf_matrix[1][2]"),M=x.getField("fract_transf_matrix[1][3]"),C=x.getField("fract_transf_matrix[2][1]"),T=x.getField("fract_transf_matrix[2][2]"),E=x.getField("fract_transf_matrix[2][3]"),P=x.getField("fract_transf_matrix[3][1]"),I=x.getField("fract_transf_matrix[3][2]"),R=x.getField("fract_transf_matrix[3][3]"),D=x.getField("fract_transf_vector[1]"),O=x.getField("fract_transf_vector[2]"),e=x.getField("fract_transf_vector[3]"),S[0]=w.float(0),S[1]=A.float(0),S[2]=M.float(0),S[4]=C.float(0),S[5]=T.float(0),S[6]=E.float(0),S[8]=P.float(0),S[9]=I.float(0),S[10]=R.float(0),S[3]=D.float(0),S[7]=O.float(0),S[11]=e.float(0),k.transpose(),L.scale=k),t.unitcell=void 0!==L.a?new lS(L):void 0})(h.categories,a,y),h.categories),E=a,Pe=y;if(o=o.struct_conn){var P=E.getAtomProxy(),I=E.getAtomProxy(),R={},Ie=o.getField("conn_type_id"),Re=o.getField("ptnr1_symmetry"),De=o.getField("pdbx_ptnr1_PDB_ins_code"),Le=o.getField("pdbx_ptnr1_label_alt_id"),Oe=o.getField("ptnr1_auth_seq_id"),ke=o.getField("ptnr1_label_asym_id"),Ne=o.getField("ptnr1_label_atom_id"),Fe=o.getField("ptnr2_symmetry"),Be=o.getField("pdbx_ptnr2_PDB_ins_code"),Ue=o.getField("pdbx_ptnr2_label_alt_id"),ze=o.getField("ptnr2_auth_seq_id"),Ve=o.getField("ptnr2_label_asym_id"),Ge=o.getField("ptnr2_label_atom_id"),He=o.getField("pdbx_value_order");for(let i=0,e=o.rowCount;i<e;++i){var D=Ie.str(i);if("hydrog"!==D&&"mismat"!==D&&"saltbr"!==D&&("1_555"===Re.str(i)&&"1_555"===Fe.str(i))){var D=De.str(i),L=Le.str(i),D=Oe.str(i)+(D?"^"+D:"")+":"+Pe[ke.str(i)]+"."+Ne.str(i)+(L?"%"+L:"");let t=R[D];if(!t){L=new qh(D);if(L.selection.error){Je.Debug&&rt.warn("invalid selection for connection",D);continue}t=E.getAtomIndices(L),R[D]=t}var L=Be.str(i),O=Ue.str(i),L=ze.str(i)+(L?"^"+L:"")+":"+Pe[Ve.str(i)]+"."+Ge.str(i)+(O?"%"+O:"");let r=R[L];if(!r){O=new qh(L);if(O.selection.error){Je.Debug&&rt.warn("invalid selection for connection",L);continue}r=E.getAtomIndices(O),R[L]=r}var k=t.length,N=r.length;if(N<k&&([k,N]=[N,k],[t,r]=[r,t]),0===k||0===N)Je.Debug&&rt.warn("no atoms found for",D,L);else for(let e=0;e<N;++e)P.index=t[e%k],I.index=r[e],P&&I?E.bondStore.addBond(P,I,yS(He.str(i))):rt.log("atoms for connection not found")}}}var S=h.categories,$e=a,je=b;if(S.entity){var S=S.entity,We=S.getField("id"),qe=S.getField("pdbx_description"),Xe=S.getField("type"),Ye=S.rowCount;for(let e=0;e<Ye;++e){var Ke=Array.from(null!=(Ke=je[We.int(e)])?Ke:[]);$e.entityList[e]=new sS($e,e,null==qe?void 0:qe.str(e),Xe.str(e),Ke)}}let i,n;if((i=null==(Qe=h.categories.struct)?void 0:Qe.getField("title"))&&(n=i.str(0))&&(a.title=n),(i=null==(Qe=h.categories.entry)?void 0:Qe.getField("id"))&&(n=i.str(0))&&(a.id=n),h.categories.pdbx_audit_revision_history){if(i=null==(Qe=h.categories.pdbx_audit_revision_history)?void 0:Qe.getField("revision_date"))for(let e=0;e<i.rowCount;e++)if(n=i.str(e)){a.header.releaseDate=n;break}if(i=null==(Qe=h.categories.pdbx_database_status)?void 0:Qe.getField("recvd_initial_deposition_date"))for(let e=0;e<i.rowCount;e++)if(n=i.str(e)){a.header.depositionDate=n;break}}else if(h.categories.database_PDB_rev){if(i=null==(Qe=h.categories.database_PDB_rev)?void 0:Qe.getField("date"))for(let e=0;e<i.rowCount;e++)if(n=i.str(e)){a.header.releaseDate=n;break}if(i=null==(Qe=h.categories.database_PDB_rev)?void 0:Qe.getField("date_original"))for(let e=0;e<i.rowCount;e++)if(n=i.str(e)){a.header.depositionDate=n;break}}(i=null!=(Qe=null==(Qe=h.categories.reflns)?void 0:Qe.getField("d_resolution_high"))?Qe:null==(Qe=h.categories.refine)?void 0:Qe.getField("ls_d_res_high"))&&0===i.valueKind(0)&&(a.header.resolution=i.float(0)),(i=null==(Qe=h.categories.refine)?void 0:Qe.getField("ls_R_factor_R_free"))&&0===i.valueKind(0)&&(a.header.rFree=i.float(0)),(i=null==(Qe=h.categories.refine)?void 0:Qe.getField("ls_R_factor_R_work"))&&0===i.valueKind(0)&&(a.header.rFree=i.float(0)),(i=null==(Qe=h.categories.exptl)?void 0:Qe.getField("method"))&&(a.header.experimentalMethods=i.toStringArray().slice()),s.finalize(),a.finalizeAtoms(),bg(a),a.finalizeBonds(),e?fg(a,e):gg(a),Mg(a),a.extraData.cif=h}Je.Debug&&rt.timeEnd("CifParser._parse "+this.name)})}}class xS extends bS{get type(){return"bcif"}get isBinary(){return!0}}a.add("bcif",xS),a.add("cif",bS),a.add("mcif",bS),a.add("mmcif",bS);class SS extends aS{get type(){return"gro"}_parse(){Je.Debug&&rt.time("GroParser._parse "+this.name);var u,d,e=this.structure,m=this.structureBuilder,p=this.firstModelOnly,f=this.asTrajectory,g=this.cAlphaOnly,v=e.frames,_=e.boxes,t=this.streamer.peekLines(3);e.title=t[0].trim();var y,b,x,S,w=5+(t[2].length-t[2].lastIndexOf(".")-1),A=20,M=20+w,C=20+2*w,T=parseInt(t[1]),E=T+3,P=e.atomMap,I=e.atomStore,R=(I.resize(T),0),D=0,L=0;this.streamer.eachChunkOfLines(function(e){for(var t=0,r=e.length,i=e,n=t;n<r;++n){var a=++L-1,s=i[n];if(s)if(a%E==0)f&&(u=new Float32Array(3*T),v.push(u),d=0);else if(a%E!=1)if(a%E==E-1){var o=s.trim().split(/\s+/),l=new Float32Array(9);if(l[0]=10*parseFloat(o[0]),l[4]=10*parseFloat(o[1]),l[8]=10*parseFloat(o[2]),_.push(l),p)return;D+=1}else if(y=s.substr(10,5).trim(),!g||"CA"===y){var o=10*parseFloat(s.substr(A,w)),l=10*parseFloat(s.substr(M,w)),h=10*parseFloat(s.substr(C,w));if(f){var c=3*d;if(u[0+c]=o,u[1+c]=l,u[2+c]=h,d+=1,E<a)continue}b=s.substr(5,5).trim(),x=parseInt(s.substr(0,5)),S=parseInt(s.substr(15,5)),I.growIfFull(),I.atomTypeId[R]=P.add(y),I.x[R]=o,I.y[R]=l,I.z[R]=h,I.serial[R]=S,m.addAtom(D,"","",b,x,!1,"l"),R+=1}}}),m.finalize(),e.finalizeAtoms(),yg(e),bg(e),e.finalizeBonds(),gg(e),Je.Debug&&rt.timeEnd("GroParser._parse "+this.name)}}a.add("gro",SS);var wS=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"].concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]);function AS(e,t,r){return t?new e(t.buffer,t.byteOffset,t.byteLength/(r||1)):void 0}function MS(e){return AS(DataView,e)}function CS(e){return AS(Int8Array,e)}function TS(e){return AS(Int32Array,e,4)}function ES(e,t){var r=e.length/2;t=t||new Int16Array(r);for(var i=0,n=0;i<r;++i,n+=2)t[i]=e[n]<<8^e[n+1]<<0;return t}function PS(e,t){var r=e.length/4;t=t||new Int32Array(r);for(var i=0,n=0;i<r;++i,n+=4)t[i]=e[n]<<24^e[n+1]<<16^e[n+2]<<8^e[n+3]<<0;return t}function IS(e,t,r){var i=e.length,n=1/t;r=r||new Float32Array(i);for(var a=0;a<i;++a)r[a]=e[a]*n;return r}function RS(e,t){if(!t){for(var r=0,i=0,n=e.length;i<n;i+=2)r+=e[i+1];t=new e.constructor(r)}var a=0;for(i=0,n=e.length;i<n;i+=2)for(var s=e[i],o=e[i+1],l=0;l<o;++l)t[a]=s,++a;return t}function DS(e,t){var r=e.length;t=t||new e.constructor(r),r&&(t[0]=e[0]);for(var i=1;i<r;++i)t[i]=e[i]+t[i-1];return t}function LS(e,t){var r,i=e instanceof Int8Array?127:32767,n=-i-1,a=e.length;if(!t){for(var s=0,o=0;o<a;++o)e[o]<i&&e[o]>n&&++s;t=new Int32Array(s)}for(r=o=0;o<a;){for(var l=0;e[o]===i||e[o]===n;)l+=e[o],++o;l+=e[o],++o,t[r]=l,++r}return t}function OS(e,t,r){return IS(LS(e,TS(r)),t,r)}function kS(e,t,r){var e=LS(e,TS(r));return r=e,t=t,e=AS(Float32Array,e,4),IS(DS(r,TS(e)),t,e)}function NS(n){var a=0,i=new DataView(n.buffer);function s(e){for(var t={},r=0;r<e;r++)t[c()]=c();return t}function o(e){var t=n.subarray(a,a+e);return a+=e,t}function l(e){var t=n.subarray(a,a+e);a+=e;if(65535<e){for(var r=[],i=0;i<t.length;i+=65535)r.push(String.fromCharCode.apply(null,t.subarray(i,i+65535)));return r.join("")}return String.fromCharCode.apply(null,t)}function h(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=c();return t}function c(){var e,t,r=n[a];if(0==(128&r))return a++,r;if(128==(240&r))return a++,s(t=15&r);if(144==(240&r))return a++,h(t=15&r);if(160==(224&r))return a++,l(t=31&r);if(224==(224&r))return e=i.getInt8(a),a++,e;switch(r){case 192:return a++,null;case 194:return a++,!1;case 195:return a++,!0;case 196:return t=i.getUint8(a+1),a+=2,o(t);case 197:return t=i.getUint16(a+1),a+=3,o(t);case 198:return t=i.getUint32(a+1),a+=5,o(t);case 202:return e=i.getFloat32(a+1),a+=5,e;case 203:return e=i.getFloat64(a+1),a+=9,e;case 204:return e=n[a+1],a+=2,e;case 205:return e=i.getUint16(a+1),a+=3,e;case 206:return e=i.getUint32(a+1),a+=5,e;case 208:return e=i.getInt8(a+1),a+=2,e;case 209:return e=i.getInt16(a+1),a+=3,e;case 210:return e=i.getInt32(a+1),a+=5,e;case 217:return t=i.getUint8(a+1),a+=2,l(t);case 218:return t=i.getUint16(a+1),a+=3,l(t);case 219:return t=i.getUint32(a+1),a+=5,l(t);case 220:return t=i.getUint16(a+1),a+=3,h(t);case 221:return t=i.getUint32(a+1),a+=5,h(t);case 222:return t=i.getUint16(a+1),a+=3,s(t);case 223:return t=i.getUint32(a+1),a+=5,s(t)}throw new Error("Unknown type 0x"+r.toString(16))}return c()}function FS(e,t,r,i){switch(e){case 1:for(var n=t,a=void 0,s=n.length,o=MS(a=a||new Float32Array(s/4)),l=MS(n),h=0,c=0,u=s/4;h<u;++h,c+=4)o.setFloat32(c,l.getFloat32(c),!0);return a;case 2:return CS(t);case 3:return ES(t);case 4:return PS(t);case 5:return AS(Uint8Array,t);case 6:return RS(PS(t),new Uint8Array(r));case 7:return RS(PS(t));case 8:return DS(RS(PS(t)),m);case 9:return n=PS(t),s=PS(i)[0],IS(RS(n,TS(d)),s,d);case 10:return kS(ES(t),PS(i)[0]);case 11:return IS(ES(t),PS(i)[0]);case 12:return OS(ES(t),PS(i)[0]);case 13:return OS(CS(t),PS(i)[0]);case 14:return LS(ES(t));case 15:return LS(CS(t))}var d,m}function BS(s,e){var o=(e=e||{}).ignoreFields,l={};return wS.forEach(function(e){var t,r,i,n=!!o&&-1!==o.indexOf(e),a=s[e];n||void 0===a||(a instanceof Uint8Array?l[e]=FS.apply(null,(t=(r=MS(n=a)).getInt32(0),r=r.getInt32(4),i=n.subarray(8,12),[t,n=n.subarray(12),r,i])):l[e]=a)}),l}let US={0:"i".charCodeAt(0),1:"s".charCodeAt(0),2:"h".charCodeAt(0),3:"e".charCodeAt(0),4:"g".charCodeAt(0),5:"b".charCodeAt(0),6:"t".charCodeAt(0),7:"l".charCodeAt(0),"-1":"".charCodeAt(0)};class zS extends aS{get type(){return"mmtf"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("MmtfParser._parse "+this.name);let e,t,r,i,n,a=this.structure,s=BS(NS(this.streamer.data));["depositionDate","releaseDate","resolution","rFree","rWork","experimentalMethods"].forEach(function(e){void 0!==s[e]&&(a.header[e]=s[e])});let o,l,h,c,u,d;if(a.id=s.structureId,a.title=s.title,a.atomStore.addField("formalCharge",1,"int8"),this.firstModelOnly||this.asTrajectory){for(u=1,c=s.chainsPerModel[0],h=0,e=0,t=c;e<t;++e)h+=s.groupsPerChain[e];for(l=0,e=0,t=h;e<t;++e)n=s.groupList[s.groupTypeList[e]],l+=n.atomNameList.length;o=s.numBonds,d=[c]}else o=s.numBonds,l=s.numAtoms,h=s.numGroups,c=s.numChains,u=s.numModels,d=s.chainsPerModel;if(o+=h,this.asTrajectory)for(e=0,t=s.numModels;e<t;++e){var m=new Float32Array(3*l),N=l*e;for(r=0;r<l;++r){var p=3*r,f=r+N;m[p]=s.xCoordList[f],m[1+p]=s.yCoordList[f],m[2+p]=s.zCoordList[f]}a.frames.push(m)}var g=new Uint32Array(o),v=new Uint32Array(o),_=new Uint8Array(o),y=new Uint32Array(l),b=new Int8Array(l),x=new Uint32Array(h),S=new Uint32Array(h),w=new Uint32Array(h),A=new Uint16Array(c),F=new Uint32Array(c),B=new Uint32Array(c),U=new Uint32Array(u),z=new Uint32Array(u);let M=0;for(e=0,t=u;e<t;++e){var C=d[e];for(U[e]=M,z[e]=C,r=0;r<C;++r)A[r+M]=e;M+=C}var V=s.groupsPerChain;let T=0;for(e=0,t=c;e<t;++e){var E=V[e];for(F[e]=T,B[e]=E,r=0;r<E;++r)x[r+T]=e;T+=E}let P=0,I=0;for(e=0,t=h;e<t;++e){var G=(n=s.groupList[s.groupTypeList[e]]).atomNameList.length,H=n.formalChargeList,$=n.bondAtomList,j=n.bondOrderList;for(r=0,i=j.length;r<i;++r)g[I]=P+$[2*r],v[I]=P+$[2*r+1],_[I]=j[r],I+=1;for(S[e]=P,w[e]=G,r=0;r<G;++r)y[P]=e,b[P]=H[r],P+=1}var R=s.bondAtomList;if(R)for(s.bondOrderList&&_.set(s.bondOrderList,I),e=0,t=R.length;e<t;e+=2){var W=R[e],q=R[e+1];W<l&&q<l&&(g[I]=W,v[I]=q,I+=1)}a.bondStore.length=_.length,a.bondStore.count=I,a.bondStore.atomIndex1=g,a.bondStore.atomIndex2=v,a.bondStore.bondOrder=_,a.atomStore.length=l,a.atomStore.count=l,a.atomStore.residueIndex=y,a.atomStore.atomTypeId=new Uint16Array(l),a.atomStore.x=s.xCoordList.subarray(0,l),a.atomStore.y=s.yCoordList.subarray(0,l),a.atomStore.z=s.zCoordList.subarray(0,l),a.atomStore.serial=s.atomIdList.subarray(0,l),a.atomStore.bfactor=s.bFactorList.subarray(0,l),a.atomStore.altloc=s.altLocList.subarray(0,l),a.atomStore.occupancy=s.occupancyList.subarray(0,l),a.atomStore.formalCharge=b,a.residueStore.length=h,a.residueStore.count=h,a.residueStore.chainIndex=x,a.residueStore.residueTypeId=s.groupTypeList,a.residueStore.atomOffset=S,a.residueStore.atomCount=w,a.residueStore.resno=s.groupIdList.subarray(0,h),a.residueStore.sstruc=s.secStructList.subarray(0,h),a.residueStore.inscode=s.insCodeList.subarray(0,h),a.chainStore.length=c,a.chainStore.count=c,a.chainStore.entityIndex=new Uint16Array(c),a.chainStore.modelIndex=A,a.chainStore.residueOffset=F,a.chainStore.residueCount=B,a.chainStore.chainname=s.chainNameList.subarray(0,4*c),a.chainStore.chainid=s.chainIdList.subarray(0,4*c),a.modelStore.length=u,a.modelStore.count=u,a.modelStore.chainOffset=U,a.modelStore.chainCount=z;var X={};for(e=0,t=s.groupList.length;e<t;++e){var D=s.groupList[e],Y=[];for(r=0,i=D.atomNameList.length;r<i;++r){var K=D.elementList[r].toUpperCase(),Z=D.atomNameList[r];Y.push(a.atomMap.add(Z,K))}var Q=D.chemCompType.toUpperCase(),J=sm.includes(Q),L=D.bondOrderList.length,ee=new Array(L),te=new Array(L);for(r=0;r<L;++r)ee[r]=D.bondAtomList[2*r],te[r]=D.bondAtomList[2*r+1];var re={atomIndices1:ee,atomIndices2:te,bondOrders:D.bondOrderList};X[e]=a.residueMap.add(D.groupName,Y,J,Q,re)}for(e=0,t=h;e<t;++e)a.residueStore.residueTypeId[e]=X[a.residueStore.residueTypeId[e]];for(e=0,t=a.atomStore.count;e<t;++e){var O=a.atomStore.residueIndex[e],ie=a.residueMap.list[a.residueStore.residueTypeId[O]],O=a.residueStore.atomOffset[O];a.atomStore.atomTypeId[e]=ie.atomTypeIdList[e-O]}if(s.secStructList){var ne=s.secStructList.length;for(e=0,t=a.residueStore.count;e<t;++e){var ae=US[a.residueStore.sstruc[e%ne]];void 0!==ae&&(a.residueStore.sstruc[e]=ae)}}if(s.entityList&&s.entityList.forEach(function(e,t){a.entityList[t]=new sS(a,t,e.description,e.type,e.chainIndexList)}),s.bioAssemblyList&&s.bioAssemblyList.forEach(function(e,t){t+=1;let i=new dg(""+t),n=(a.biomolDict["BU"+t]=i,{});e.transformList.forEach(function(e){var t=(new tt).fromArray(e.matrix).transpose(),e=e.chainIndexList.map(function(t){let r="";for(let e=0;e<4;++e){var i=s.chainNameList[4*t+e];if(!i)break;r+=String.fromCharCode(i)}return r}),r=n[e.toString()];r?r.matrixList.push(t):n[e.toString()]=i.addPart([t],e)})}),s.ncsOperatorList){var k=new dg("NCS");let t=k.addPart();s.ncsOperatorList.forEach(function(e){e=(new tt).fromArray(e).transpose();t.matrixList.push(e)}),0<t.matrixList.length&&(a.biomolDict.NCS=k)}k=s.unitCell;k&&Array.isArray(k)&&k[0]?a.unitcell=new lS({a:k[0],b:k[1],c:k[2],alpha:k[3],beta:k[4],gamma:k[5],spacegroup:s.spaceGroup}):a.unitcell=void 0,Ag(a,!0),wg(a,!0),a.finalizeAtoms(),a.finalizeBonds(),Mg(a),Je.Debug&&rt.timeEnd("MmtfParser._parse "+this.name)}}a.add("mmtf",zS);let VS=/\s+/,GS={1:1,2:2,3:3,am:1,ar:1,du:1,un:1,nc:0};class HS extends aS{get type(){return"mol2"}_parse(){Je.Debug&&rt.time("Mol2Parser._parse "+this.name);let f=this.structure,g=this.structureBuilder,v=this.firstModelOnly,_=this.asTrajectory,y=f.frames,b=!1,x,S,w=f.atomMap,A=f.atomStore,M=(A.resize(Math.round(this.streamer.data.length/60)),A.addField("partialCharge",1,"float32"),0),C=0,T=0,E=-1,P=0,I=0,R=1,D=2,L=3,O=f.getAtomProxy(),k=f.getAtomProxy();this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n=i[e].trim();if(""!==n&&"#"!==n[0])if("@"===n[0])"@<TRIPOS>MOLECULE"===n?(I=R,C=0,++E):"@<TRIPOS>ATOM"===n?(I=D,T=A.count,_&&(S=0,x=new Float32Array(3*P),y.push(x),0<E)&&(b=!0)):I="@<TRIPOS>BOND"===n?L:0;else if(I===R)0===C?(f.title=n,f.id=n):1===C&&(a=n.split(VS),P=parseInt(a[0])),++C;else if(I===D){var a=n.split(VS);if(!(v&&0<E)){var s=parseFloat(a[2]),o=parseFloat(a[3]),l=parseFloat(a[4]);if(_){var h=3*S;if(x[0+h]=s,x[1+h]=o,x[2+h]=l,S+=1,b)continue}var h=a[0],c=a[1],u=a[5].split(".")[0],d=a[6]?parseInt(a[6]):1,m=a[7]||"",p=a[8]?parseFloat(a[8]):0;A.growIfFull(),A.atomTypeId[M]=w.add(c,u),A.x[M]=s,A.y[M]=o,A.z[M]=l,A.serial[M]=+h,A.partialCharge[M]=p,g.addAtom(E,"","",m,d,!0),M+=1}}else I!==L||v&&0<E||_&&0<E||(c=n.split(VS),O.index=parseInt(c[1])-1+T,k.index=parseInt(c[2])-1+T,u=GS[c[3]],f.bondStore.addBond(O,k,u))}}),g.finalize(),f.finalizeAtoms(),yg(f),wg(f,!0),Ag(f,!0),f.finalizeBonds(),Pg(f),gg(f),Je.Debug&&rt.timeEnd("Mol2Parser._parse "+this.name)}}a.add("mol2",HS);class $S extends pS{get type(){return"pdbqt"}}a.add("pdbqt",$S);class jS extends pS{get type(){return"pqr"}}a.add("pqr",jS);let WS=/> +<(.+)>/;class qS extends aS{get type(){return"sdf"}_parse(){Je.Debug&&rt.time("SdfParser._parse "+this.name);let h=this.structure,c=this.structureBuilder,u=this.firstModelOnly,d=this.asTrajectory;var e=this.streamer.peekLines(2);h.id=e[0].trim(),h.title=e[1].trim();let m=h.frames,p=!1,f,g,$=h.atomMap,v=h.atomStore,_=(v.resize(Math.round(this.streamer.data.length/50)),v.addField("formalCharge",1,"int8"),h.getAtomProxy()),y=h.getAtomProxy(),b=0,x=0,S=0,w=0,A=[],M=!1,C={},T;h.extraData.sdf=A;let E,j,P,I,R,W,D,L,O,k,N,F,q,B=!1,U=!1,z=!1,V=[],G=[],H=new Map;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n=i[e];if(B&&n&&(V=n.substring(7).split(" "),G.length&&(V=[...G,...V],G=[]),"-"===V[V.length-1]))V.pop(),G=V;else{if("$$$$"===n.substr(0,4))x=-1,++S,w=v.count,A.push(C),C={},M=!1,B=!1;else if(3===x)(B=-1<n.indexOf(" V3000"))?H.clear():(E=parseInt(n.substr(0,3)),j=parseInt(n.substr(3,3)),P=4,I=P+E,R=I,W=R+j,d&&(g=0,f=new Float32Array(3*E),m.push(f),0<S)&&(p=!0));else if(B&&"COUNTS"===V[0])E=parseInt(V[1]),d&&(g=0,f=new Float32Array(3*E),m.push(f),0<S)&&(p=!0);else if(B&&2==V.length)"ATOM"===V[1]?"BEGIN"===V[0]?U=!0:"END"===V[0]&&(U=!1):"BOND"===V[1]&&("BEGIN"===V[0]?z=!0:"END"===V[0]&&(z=!1));else if(U||!B&&x>=P&&x<I){if(u&&0<S)continue;let e=0;if(B?(D=parseFloat(V[2]),L=parseFloat(V[3]),O=parseFloat(V[4]),N=V[1],F=parseInt(V[0]),H.set(F,b),k=N+F,6<V.length&&(a=V.slice(6).find(e=>0===e.indexOf("CHG=")))&&(e=parseInt(a.substring(4)))):(D=parseFloat(n.substr(0,10)),L=parseFloat(n.substr(10,10)),O=parseFloat(n.substr(20,10)),N=n.substr(31,3).trim(),k=N+(b-w+1)),d){var a=3*g;if(f[0+a]=D,f[1+a]=L,f[2+a]=O,g+=1,p)continue}v.growIfFull(),v.atomTypeId[b]=$.add(k,N),v.x[b]=D,v.y[b]=L,v.z[b]=O,v.serial[b]=B?F:b,v.formalCharge[b]=e,c.addAtom(S,"","","HET",1,!0),b+=1}else if(z||!B&&x>=R&&x<W){if(u&&0<S)continue;if(d&&0<S)continue;q=B?(_.index=H.get(parseInt(V[2])),y.index=H.get(parseInt(V[3])),parseInt(V[1])):(_.index=parseInt(n.substr(0,3))-1+w,y.index=parseInt(n.substr(3,3))-1+w,parseInt(n.substr(6,3))),h.bondStore.addBond(_,y,q)}else if("M  CHG"===n.substr(0,6)){var s=parseInt(n.substr(6,3));for(let e=0,t=10;e<s;++e,t+=8){var o=parseInt(n.substr(t,3))-1+w,l=parseInt(n.substr(t+4,3));v.formalCharge[o]=l}}else">"===n.charAt(0)&&(T=n.match(WS))?(M=T[1],C[M]=[]):!1!==M&&n&&C[M].push(n);++x}}}),c.finalize(),h.finalizeAtoms(),h.finalizeBonds(),Pg(h),Je.Debug&&rt.timeEnd("SdfParser._parse "+this.name)}_postProcess(){Pg(this.structure)}}a.add("sdf",qS),a.add("sd",qS),a.add("mol",qS);function XS(e,t,r){return parseInt(e.substr(t,r).trim())}class YS extends aS{get type(){return"prmtop"}_parse(){Je.Debug&&rt.time("PrmtopParser._parse "+this.name);var e=this.structure,t=this.structureBuilder,r=e.atomMap;let v=e.atomStore,_=(v.addField("partialCharge",1,"float32"),v.addField("radius",1,"float32"),[]),y={},b=["NATOM","NTYPES","NBONH","MBONA","NTHETH","MTHETA","NPHIH","MPHIA","NHPARM","NPARM","NNB","NRES","NBONA","NTHETA","NPHIA","NUMBND","NUMANG","NPTRA","NATYP","NPHB","IFPERT","NBPER","NGPER","NDPER","MBPER","MGPER","MDPER","IFBOX","NMXRS","IFCAP","NUMEXTRA","NCOPY"];b.forEach(e=>{y[e]=0});let x,S,w,A,M,C=new Uint8Array(0),T,E,P,I,R;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n=i[e],a=n.trim();if(a&&!n.startsWith("%FORMAT"))if(n.startsWith("%FLAG")){var s=n.substr(5).trim();I=0,P="TITLE"===s?0:"POINTERS"===s?1:"ATOM_NAME"===s?2:"CHARGE"===s?3:"MASS"===s?4:"RESIDUE_LABEL"===s?5:"RESIDUE_POINTER"===s?6:"BONDS_INC_HYDROGEN"===s?(R=0,7):"BONDS_WITHOUT_HYDROGEN"===s?(R=y.NBONH,8):"RADII"===s?9:void 0}else if(0===P)_.push(a);else if(1===P){var o=Math.min(I+10,32);for(let e=0;I<o;++e,++I)y[b[I]]=parseInt(n.substr(8*e,8).trim());x=new Array(y.NATOM),S=new Float32Array(y.NATOM),w=new Float32Array(y.NATOM),v.resize(y.NATOM);s=y.NBONH+y.MBONA;A=new Uint32Array(s),M=new Uint32Array(s),C=new Uint8Array(s),T=new Array(y.NRES),E=new Uint32Array(y.NRES)}else if(2===P){var l=Math.min(I+20,y.NATOM);for(let e=0;I<l;++e,++I)x[I]=n.substr(4*e,4).trim()}else if(3===P){var h=Math.min(I+5,y.NATOM);for(let e=0;I<h;++e,++I)S[I]=parseFloat(n.substr(16*e,16))/18.2223}else if(4!==P)if(5===P){var c=Math.min(I+20,y.NRES);for(let e=0;I<c;++e,++I)T[I]=n.substr(4*e,4).trim()}else if(6===P){var u=Math.min(I+10,y.NRES);for(let e=0;I<u;++e,++I)E[I]=XS(n,8*e,8)}else if(7===P){var d=Math.min(I+10,3*y.NBONH);for(let e=0;I<d;++e,++I){var m=I%3;0==m&&(A[R]=XS(n,8*e,8)/3),1==m&&(M[R]=XS(n,8*e,8)/3,C[R]=1,++R)}}else if(8===P){var p=Math.min(I+10,3*y.MBONA);for(let e=0;I<p;++e,++I){var f=I%3;0==f&&(A[R]=XS(n,8*e,8)/3),1==f&&(M[R]=XS(n,8*e,8)/3,C[R]=1,++R)}}else if(9===P){var g=Math.min(I+5,y.NATOM);for(let e=0;I<g;++e,++I)w[I]=parseFloat(n.substr(16*e,16))}}}),e.title=_.join(" ");var i=y.NATOM;let n=0,a=T[0],s=1;for(let e=0;e<i;++e)e+1===E[n+1]&&(++n,a=T[n],s=n+1),v.atomTypeId[e]=r.add(x[e]),v.serial[e]=e+1,t.addAtom(0,"","",a,s,!1);v.partialCharge.set(S),v.radius.set(w),e.bondStore.length=C.length,e.bondStore.count=C.length,e.bondStore.atomIndex1=A,e.bondStore.atomIndex2=M,e.bondStore.bondOrder=C,t.finalize(),e.finalizeAtoms(),e.finalizeBonds(),wg(e,!0),Ag(e,!0,!0),yg(e,!0),Pg(e),Je.Debug&&rt.timeEnd("PrmtopParser._parse "+this.name)}}a.add("prmtop",YS),a.add("parm7",YS);let KS=/\s+/,ZS=/(^\*|REMARK)*/;class QS extends aS{get type(){return"psf"}_parse(){Je.Debug&&rt.time("PsfParser._parse "+this.name);var e=this.structure;let d=this.structureBuilder,m=e.atomMap,p=e.atomStore,f=(p.addField("partialCharge",1,"float32"),[]),g,v,_,y=0,b=0,x=0,S,w,A;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n=i[e].trim();if(n)if(2===g){var a=n.split(KS),s=parseInt(a[0]),o=a[1],l=parseInt(a[2]),h=a[3],c=a[4],a=parseFloat(a[6]);o!==_&&(v=_g(b),++b),p.growIfFull(),p.atomTypeId[y]=m.add(c),p.serial[y]=s,p.partialCharge[y]=a,d.addAtom(0,v,v,h,l,!1),y+=1,_=o}else if(3===g){var u=n.split(KS);for(let e=0,t=u.length;e<t;e+=2)S[x]=parseInt(u[e])-1,w[x]=parseInt(u[e+1])-1,A[x]=1,x+=1}else 1===g?f.push(n.replace(ZS,"").trim()):4!==g&&5!==g&&6!==g&&(n.includes("!NATOM")?(g=2,c=parseInt(n.split(KS)[0]),p.resize(c)):n.includes("!NBOND")?(g=3,s=parseInt(n.split(KS)[0]),S=new Uint32Array(s),w=new Uint32Array(s),A=new Uint8Array(s)):n.includes("!NTITLE")?g=1:n.includes("!NTHETA")?g=4:n.includes("!NPHI")?g=5:n.includes("!NIMPHI")&&(g=6));else g=void 0}}),e.title=f.join(" "),e.bondStore.length=A.length,e.bondStore.count=x,e.bondStore.atomIndex1=S,e.bondStore.atomIndex2=w,e.bondStore.bondOrder=A,d.finalize(),e.finalizeAtoms(),e.finalizeBonds(),wg(e,!0),Ag(e,!0,!0),Pg(e),Je.Debug&&rt.timeEnd("PsfParser._parse "+this.name)}}a.add("psf",QS);let JS=/\[ (.+) \]/,e3=/\s+/;class t3 extends aS{get type(){return"top"}_parse(){Je.Debug&&rt.time("TopParser._parse "+this.name);let s=this.structure,o=this.structureBuilder,l=s.atomMap,h=s.bondStore,c=s.atomStore,u=(c.addField("partialCharge",1,"float32"),[]),d={},m,p;this.streamer.eachChunkOfLines(function(e){var r=0,i=e.length,n=e;for(let t=r;t<i;++t){var a=n[t];let e=a.trim();if(e&&"*"!==e[0]&&";"!==e[0]){if(e.startsWith("#include"))throw new Error("TopParser: #include statements not allowed");var a=a.match(JS);null!==a?"moleculetype"===(a=a[1])?(p=2,m={atoms:[],bonds:[]}):p="atoms"===a?3:"bonds"===a?4:"system"===a?0:"molecules"===a?1:void 0:(-1!==(a=e.indexOf(";"))&&(e=e.substring(0,a).trim()),2===p?(a=e.split(e3)[0],d[a]=m):3===p?(a=e.split(e3),m.atoms.push([parseInt(a[2]),a[3],a[4],parseFloat(a[6])])):4===p?(a=e.split(e3),m.bonds.push([parseInt(a[0]),parseInt(a[1])])):0===p?s.title=e:1===p&&(a=e.split(e3),u.push([a[0],parseInt(a[1])])))}}});let r=0,i=0,f=(u.forEach(function(e){var[e,t]=e,e=d[e];r+=t*e.atoms.length,i+=t*e.bonds.length}),c.resize(r),h.resize(i),0),g=0,v=0,n=0,_=0,y=0,b;u.forEach(function(e){var[t,r]=e,i=d[t];let a=_g(n);for(let e=0;e<r;++e){b=-1;let n=wm.includes(t)?a:_g(v);i.atoms.forEach(function(e){var[e,t,r,i]=e;e!==b&&++g,c.atomTypeId[f]=l.add(r),c.serial[f]=f+1,c.partialCharge[f]=i,o.addAtom(0,a,n,t,g+1,!1),++f,b=e}),i.bonds.forEach(function(e){h.atomIndex1[_]=y+e[0]-1,h.atomIndex2[_]=y+e[1]-1,++_}),++v,y+=i.atoms.length}++n}),h.count=i,o.finalize(),s.finalizeAtoms(),s.finalizeBonds(),wg(s,!0),Ag(s,!0,!0),Pg(s),Je.Debug&&rt.timeEnd("TopParser._parse "+this.name)}}a.add("top",t3);class r3 extends nS{constructor(e,t){super(e,t),this.frames=new U1(this.name,this.path)}get type(){return"trajectory"}get __objName(){return"frames"}}class i3 extends r3{get type(){return"dcd"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("DcdParser._parse "+this.name);var r=Ql(this.streamer.data),i=new DataView(r),e=this.frames,n=e.coordinates,a=e.boxes,s={};let o=0;var t=new Int32Array(r,0,23),l=t[0]!==i.getInt32(0);if(84!==t[0]){var h=r.byteLength;for(let e=0;e<h;e+=4)i.setFloat32(e,i.getFloat32(e),!0)}84!==t[0]&&rt.error("dcd bad format, header block start"),"CORD"!==String.fromCharCode(i.getUint8(4),i.getUint8(5),i.getUint8(6),i.getUint8(7))&&rt.error("dcd bad format, format string");let c=!1,u=!1,d=!1;0!==t[22]&&(c=!0,0!==t[12]&&(u=!0),1===t[13])&&(d=!0),s.NSET=t[2],s.ISTART=t[3],s.NSAVC=t[4],s.NAMNF=t[10],c?s.DELTA=i.getFloat32(44,l):s.DELTA=i.getFloat64(44,l),84!==t[22]&&rt.error("dcd bad format, header block end"),o=o+84+8;var t=i.getInt32(o,l),m=o+1;if((t-4)%80!=0&&rt.error("dcd bad format, title block start"),s.TITLE=Yl(new Uint8Array(r,m,t)),i.getInt32(m+t+4-1,l)!==t&&rt.error("dcd bad format, title block end"),o=o+t+8,4!==i.getInt32(o,l)&&rt.error("dcd bad format, natom block start"),s.NATOM=i.getInt32(o+4,l),4!==i.getInt32(o+8,l)&&rt.error("dcd bad format, natom block end"),o=o+4+8,0<s.NAMNF)rt.error("dcd format with fixed atoms unsupported, aborting");else{var p=s.NATOM,f=4*p;for(let e=0,t=s.NSET;e<t;++e){u&&(o+=4,(g=new Float32Array(9))[0]=i.getFloat64(o,l),g[4]=i.getFloat64(o+16,l),g[8]=i.getFloat64(o+40,l),a.push(g),o=o+48+4);var g,v=new Float32Array(3*p);for(let t=0;t<3;++t){i.getInt32(o,l)!==f&&rt.error("dcd bad format, coord block start",e,t),o+=4;var _=new Float32Array(r,o,p);for(let e=0;e<p;++e)v[3*e+t]=_[e];o+=f,i.getInt32(o,l)!==f&&rt.error("dcd bad format, coord block end",e,t),o+=4}n.push(v),d&&(g=i.getInt32(o,l),o+=4+g+4)}s.DELTA&&(e.deltaTime=20.45482949774598*s.DELTA),1<=s.ISTART&&(e.timeOffset=(s.ISTART-1)*e.deltaTime),Je.Debug&&rt.timeEnd("DcdParser._parse "+this.name)}}}function n3(e,t){if(e)throw new TypeError("Not a valid NetCDF v3.x file: "+t)}function a3(e){e.offset%4!=0&&e.skip(4-e.offset%4)}function s3(e){var t=e.readUint32(),t=e.readChars(t);return a3(e),t}a.add("dcd",i3);let o3={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function l3(e){switch(Number(e)){case o3.BYTE:return"byte";case o3.CHAR:return"char";case o3.SHORT:return"short";case o3.INT:return"int";case o3.FLOAT:return"float";case o3.DOUBLE:return"double";default:return"undefined"}}function h3(e){switch(Number(e)){case o3.BYTE:case o3.CHAR:return 1;case o3.SHORT:return 2;case o3.INT:case o3.FLOAT:return 4;case o3.DOUBLE:return 8;default:return-1}}function c3(e){switch(String(e)){case"byte":return o3.BYTE;case"char":return o3.CHAR;case"short":return o3.SHORT;case"int":return o3.INT;case"float":return o3.FLOAT;case"double":return o3.DOUBLE;default:return-1}}function u3(t,r){if(1===t)return r();var i=new Array(t);for(let e=0;e<t;e++)i[e]=r();return i}function d3(e,t,r){switch(t){case o3.BYTE:return e.readBytes(r);case o3.CHAR:return 0!==(i=e.readChars(r)).charCodeAt(i.length-1)?i:i.substring(0,i.length-1);case o3.SHORT:return u3(r,e.readInt16.bind(e));case o3.INT:return u3(r,e.readInt32.bind(e));case o3.FLOAT:return u3(r,e.readFloat32.bind(e));case o3.DOUBLE:return u3(r,e.readFloat64.bind(e));default:return void n3(!0,"non valid type "+t)}var i}let m3=0,p3=10,f3=11,g3=12;function v3(e,t){var r={recordDimension:{length:e.readUint32()}},i=(r.version=t,(t=>{let r,i,n,e=t.readUint32();if(e===m3)return n3(t.readUint32()!==m3,"wrong empty tag for list of dimensions"),[];n3(e!==p3,"wrong tag for list of dimensions");var a=t.readUint32();r=new Array(a);for(let e=0;e<a;e++){var s=s3(t),o=t.readUint32();0===o&&(i=e,n=s),r[e]={name:s,size:o}}return{dimensions:r,recordId:i,recordName:n}})(e)),e=(r.recordDimension.id=i.recordId,r.recordDimension.name=i.recordName,r.dimensions=i.dimensions,r.globalAttributes=_3(e),((r,i,n)=>{let e=r.readUint32(),a=0,s;if(e===m3)return n3(r.readUint32()!==m3,"wrong empty tag for list of variables"),[];n3(e!==f3,"wrong tag for list of variables");var o=r.readUint32();s=new Array(o);for(let t=0;t<o;t++){var l=s3(r),h=r.readUint32(),c=new Array(h);for(let e=0;e<h;e++)c[e]=r.readUint32();var u=_3(r),d=r.readUint32(),m=(n3(d<1&&6<d,"non valid type "+d),r.readUint32());let e=r.readUint32();2===n&&(n3(0<e,"offsets larger than 4GB not supported"),e=r.readUint32()),c[0]===i&&(a+=m),s[t]={name:l,dimensions:c,attributes:u,type:l3(d),size:m,offset:e,record:c[0]===i}}return{variables:s,recordStep:a}})(e,i.recordId,t));return r.variables=e.variables,r.recordDimension.recordStep=e.recordStep,r}function _3(t){let r;var e=t.readUint32();if(e===m3)return n3(t.readUint32()!==m3,"wrong empty tag for list of attributes"),[];n3(e!==g3,"wrong tag for list of attributes");var i=t.readUint32();r=new Array(i);for(let e=0;e<i;e++){var n=s3(t),a=t.readUint32(),s=(n3(a<1||6<a,"non valid type "+a),t.readUint32()),s=d3(t,a,s);a3(t),r[e]={name:n,type:l3(a),value:s}}return r}class y3{constructor(e){var e=new Lc(e),t=(e.setBigEndian(),n3("CDF"!==e.readChars(3),"should start with CDF"),e.readByte());n3(2<t,"unknown version"),this.header=v3(e,t),this.buffer=e}get version(){return 1===this.header.version?"classic format":"64-bit offset format"}get recordDimension(){return this.header.recordDimension}get dimensions(){return this.header.dimensions}get globalAttributes(){return this.header.globalAttributes}get variables(){return this.header.variables}hasDataVariable(t){return-1!==this.header.variables.findIndex(function(e){return e.name===t})}getDataVariable(t){let e;if(n3(void 0===(e="string"==typeof t?this.header.variables.find(function(e){return e.name===t}):t),"variable not found"),this.buffer.seek(e.offset),e.record){var r=this.buffer,i=e,n=this.header.recordDimension,a=c3(i.type),s=i.size?i.size/h3(a):1,o=n.length,l=new Array(o),h=n.recordStep;for(let e=0;e<o;e++){var c=r.offset;l[e]=d3(r,a,s),r.seek(c+h)}return l}var u=this.buffer,i=e,d=c3(i.type),m=i.size/h3(d),p=new Array(m);for(let e=0;e<m;e++)p[e]=d3(u,d,1);return p}}class b3 extends r3{get type(){return"nctraj"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("NctrajParser._parse "+this.name);var e=new y3(this.streamer.data),t=this.frames;let r=t.coordinates,i=t.boxes,n=t.times;e.getDataVariable("coordinates").forEach(function(e){r.push(new Float32Array(e))}),e.hasDataVariable("cell_lengths")&&e.getDataVariable("cell_lengths").forEach(function(e){i.push(new Float32Array(e))}),e.hasDataVariable("time")&&e.getDataVariable("time").forEach(function(e){n.push(e)}),1<=n.length&&(t.timeOffset=n[0]),2<=n.length&&(t.deltaTime=n[1]-n[0]),Je.Debug&&rt.timeEnd("NctrajParser._parse "+this.name)}}a.add("nctraj",b3),a.add("ncdf",b3),a.add("nc",b3);class x3 extends r3{get type(){return"trr"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("TrrParser._parse "+this.name);var e=Ql(this.streamer.data),r=new DataView(e),t=this.frames,i=t.coordinates,n=t.boxes,a=t.times;let s=0;for(;;){s+=8;var o=r.getInt32(s),o=(s=s+4+o,r.getInt32(s+8)),l=r.getInt32(s+12),h=r.getInt32(s+16),c=r.getInt32(s+28),u=r.getInt32(s+32),d=r.getInt32(s+36),m=r.getInt32(s+40),p=(s+=52,o/9),f=3*m;if(8==p?a.push(r.getFloat64(s)):a.push(r.getFloat32(s)),s+=2*p,o){var g=new Float32Array(9);if(8==p)for(let e=0;e<9;++e)g[e]=10*r.getFloat64(s),s+=8;else for(let e=0;e<9;++e)g[e]=10*r.getFloat32(s),s+=4;n.push(g)}if(s=s+l+h,c){let t;if(8==p){t=new Float32Array(f);for(let e=0;e<f;++e)t[e]=10*r.getFloat64(s),s+=8}else{var v=new Uint32Array(e,s,f);for(let e=0;e<f;++e){var _=v[e];v[e]=(255&_)<<24|(65280&_)<<8|_>>8&65280|_>>24&255}t=new Float32Array(e,s,f);for(let e=0;e<f;++e)t[e]*=10,s+=4}i.push(t)}if((s=s+u+d)>=e.byteLength)break}1<=a.length&&(t.timeOffset=a[0]),2<=a.length&&(t.deltaTime=a[1]-a[0]),Je.Debug&&rt.timeEnd("TrrParser._parse "+this.name)}}a.add("trr",x3);let S3=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]);function w3(e){let t=1,r=0;for(;e>=t&&r<32;)r++,t<<=1;return r}let A3=new Uint8Array(32);function M3(e,t,r,i){var n=(1<<r)-1;let a=i[1],s=i[2],o=e[0],l=0;for(;8<=r;)s=s<<8|t[o++],l|=s>>a<<r-8,r-=8;return 0<r&&(a<r&&(a+=8,s=s<<8|t[o++]),a-=r,l|=s>>a&(1<<r)-1),l&=n,e[0]=o,e[1]=a,e[2]=s,l}let C3=new Int32Array(32);function T3(e,t,i,r,n,a,s){let o=0;for(C3[1]=0,C3[2]=0,C3[3]=0;8<r;)C3[o++]=M3(e,t,8,s),r-=8;0<r&&(C3[o++]=M3(e,t,r,s));for(let r=i-1;0<r;r--){let t=0;for(let e=o-1;0<=e;e--){var l=(t=t<<8|C3[e])/n[r]|0;C3[e]=l,t-=l*n[r]}a[r]=t}a[0]=C3[0]|C3[1]<<8|C3[2]<<16|C3[3]<<24}class E3 extends r3{get type(){return"xtc"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("XtcParser._parse "+this.name);var e=Ql(this.streamer.data),h=new DataView(e),t=this.frames,r=t.coordinates,i=t.boxes,n=t.times,c=new Int32Array(6),u=new Int32Array(3),d=new Int32Array(3),m=new Uint32Array(3),p=new Float32Array(3),f=new Float32Array(3);let g=0;for(var v=new Int32Array(3),_=new Uint32Array(v.buffer);;){let l;var a=h.getInt32(g+4),y=(g+=12,3*a),s=(n.push(h.getFloat32(g)),g+=4,new Float32Array(9));for(let e=0;e<9;++e)s[e]=10*h.getFloat32(g),g+=4;if(i.push(s),a<=9){l=new Float32Array(a);for(let e=0;e<a;++e)l[e]=h.getFloat32(g),g+=4}else{f[p[d[m[u[v[0]=v[1]=v[2]=0]=u[1]=u[2]=0]=m[1]=m[2]=0]=d[1]=d[2]=0]=p[1]=p[2]=0]=f[1]=f[2]=0,l=new Float32Array(y);let t=0;var b=h.getInt32(g),x=(g+=4,h.getFloat32(g));g+=4,c[0]=h.getInt32(g),c[1]=h.getInt32(g+4),c[2]=h.getInt32(g+8),c[3]=h.getInt32(g+12),c[4]=h.getInt32(g+16),c[5]=h.getInt32(g+20),u[0]=c[3]-c[0]+1,u[1]=c[4]-c[1]+1,u[2]=c[5]-c[2]+1,g+=24;let r,i=(r=16777215<(u[0]|u[1]|u[2])?(d[0]=w3(u[0]),d[1]=w3(u[1]),d[2]=w3(u[2]),0):((e,i)=>{let n=1,t=0;A3[0]=1;for(let r=0;r<e;r++){let e,t=0;for(e=0;e<n;e++)t+=A3[e]*i[r],A3[e]=255&t,t>>=8;for(;0!==t;)A3[e++]=255&t,t>>=8;n=e}let r=1;for(n--;A3[n]>=r;)t++,r*=2;return t+8*n})(3,u),h.getInt32(g));g+=4;var S=(S=i-1)<9?9:S;let n=S3[S]/2|0,a=S3[i]/2|0;m[0]=m[1]=m[2]=S3[i];var S=4*Math.ceil(h.getInt32(g)/4),w=(g+=4,1/x);let s=0,o=0;var A,M=new Uint8Array(e,g);for(p[0]=p[1]=p[2]=0;o<b;){0===r?(p[0]=M3(v,M,d[0],_),p[1]=M3(v,M,d[1],_),p[2]=M3(v,M,d[2],_)):T3(v,M,3,r,u,p,_),o++,p[0]+=c[0],p[1]+=c[1],p[2]+=c[2],f[0]=p[0],f[1]=p[1],f[2]=p[2];let e=0;if(1===M3(v,M,1,_)&&(s=M3(v,M,5,_),e=s%3,s-=e,e--),0<s)for(let e=p[0]=p[1]=p[2]=0;e<s;e+=3)T3(v,M,3,i,m,p,_),o++,p[0]+=f[0]-a,p[1]+=f[1]-a,p[2]+=f[2]-a,0===e?(A=p[0],p[0]=f[0],f[0]=A,A=p[1],p[1]=f[1],f[1]=A,A=p[2],p[2]=f[2],f[2]=A,l[t++]=f[0]*w,l[t++]=f[1]*w,l[t++]=f[2]*w):(f[0]=p[0],f[1]=p[1],f[2]=p[2]),l[t++]=p[0]*w,l[t++]=p[1]*w,l[t++]=p[2]*w;else l[t++]=p[0]*w,l[t++]=p[1]*w,l[t++]=p[2]*w;if(i+=e,e<0?(a=n,n=9<i?S3[i-1]/2|0:0):0<e&&(n=a,a=S3[i]/2|0),m[0]=m[1]=m[2]=S3[i],0===m[0]||0===m[1]||0===m[2])return void console.error("(xdrfile error) Undefined error.")}g+=S}for(let e=0;e<y;e++)l[e]*=10;if(r.push(l),g>=e.byteLength)break}1<=n.length&&(t.timeOffset=n[0]),2<=n.length&&(t.deltaTime=n[1]-n[0]),Je.Debug&&rt.timeEnd("XtcParser._parse "+this.name)}}a.add("xtc",E3);class P3 extends nS{constructor(e,t){t=t||{};super(e,t),this.volume=new uf(this.name,this.path),this.voxelSize=ce(t.voxelSize,1)}get type(){return"volume"}get __objName(){return"volume"}_afterParse(){this.volume.setMatrix(this.getMatrix()),super._afterParse()}getMatrix(){return new tt}}let I3=/\s+/,R3=/-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?/g,D3=.529177210859;class L3 extends P3{get type(){return"cube"}_parse(){Je.Debug&&rt.time("CubeParser._parse "+this.name);var e=this.volume;let r=this.streamer.peekLines(6),s={};var t=D3*this.voxelSize;function i(e,t){e=r[e].trim().split(I3)[t];return parseFloat(e)}s.atomCount=Math.abs(i(2,0)),s.originX=i(2,1)*D3,s.originY=i(2,2)*D3,s.originZ=i(2,3)*D3,s.NVX=i(3,0),s.NVY=i(4,0),s.NVZ=i(5,0),s.basisX=new et(i(3,1),i(3,2),i(3,3)).multiplyScalar(t),s.basisY=new et(i(4,1),i(4,2),i(4,3)).multiplyScalar(t),s.basisZ=new et(i(5,1),i(5,2),i(5,3)).multiplyScalar(t);let o=new Float32Array(s.NVX*s.NVY*s.NVZ),l=0,h=0,c=0<i(2,0)?0:1;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n=i[e].trim();if(""!==n&&h>=s.atomCount+6+c){var a=n.match(R3);for(let e=0,t=a.length;e<t;++e)o[l]=parseFloat(a[e]),++l}++h}}),e.header=s,e.setData(o,s.NVZ,s.NVY,s.NVX),Je.Debug&&rt.timeEnd("CubeParser._parse "+this.name)}getMatrix(){var e=this.volume.header,t=new tt;return t.multiply((new tt).makeTranslation(e.originX,e.originY,e.originZ)),t.multiply((new tt).makeBasis(e.basisZ,e.basisY,e.basisX)),t}}a.add("cub",L3),a.add("cube",L3);class O3 extends P3{get type(){return"dsn6"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("Dsn6Parser._parse "+this.name);var e=this.volume,t={};let r,i;var n=Ql(this.streamer.data),a=new Int16Array(n),s=new Uint8Array(n),n=String.fromCharCode.apply(null,s.subarray(0,512));if(n.startsWith(":-)"))t.xStart=parseInt(n.substr(10,5)),t.yStart=parseInt(n.substr(15,5)),t.zStart=parseInt(n.substr(20,5)),t.xExtent=parseInt(n.substr(32,5)),t.yExtent=parseInt(n.substr(38,5)),t.zExtent=parseInt(n.substr(42,5)),t.xRate=parseInt(n.substr(52,5)),t.yRate=parseInt(n.substr(58,5)),t.zRate=parseInt(n.substr(62,5)),t.xlen=parseFloat(n.substr(73,10))*this.voxelSize,t.ylen=parseFloat(n.substr(83,10))*this.voxelSize,t.zlen=parseFloat(n.substr(93,10))*this.voxelSize,t.alpha=parseFloat(n.substr(103,10)),t.beta=parseFloat(n.substr(113,10)),t.gamma=parseFloat(n.substr(123,10)),r=parseFloat(n.substr(138,12))/100,i=parseInt(n.substr(155,8)),t.sigma=100*parseFloat(n.substr(170,12));else{if(100!==a[18])for(let e=0,t=a.length;e<t;++e){var o=a[e];a[e]=(255&o)<<8|o>>8&255}t.xStart=a[0],t.yStart=a[1],t.zStart=a[2],t.xExtent=a[3],t.yExtent=a[4],t.zExtent=a[5],t.xRate=a[6],t.yRate=a[7],t.zRate=a[8];var n=1/a[17],l=n*this.voxelSize;t.xlen=a[9]*l,t.ylen=a[10]*l,t.zlen=a[11]*l,t.alpha=a[12]*n,t.beta=a[13]*n,t.gamma=a[14]*n,r=a[15]/100,i=a[16],t.gamma=a[14]*n}e.header=t,Je.Debug&&rt.log(t,r,i);var h=new Float32Array(t.xExtent*t.yExtent*t.zExtent);let c=512;for(var u=Math.ceil(t.xExtent/8),d=Math.ceil(t.yExtent/8),m=Math.ceil(t.zExtent/8),p=0;p<m;++p)for(var f=0;f<d;++f)for(var g=0;g<u;++g)for(var v=0;v<8;++v)for(var _=8*p+v,y=0;y<8;++y)for(var b=8*f+y,x=0;x<8;++x){var S=8*g+x;if(!(S<t.xExtent&&b<t.yExtent&&_<t.zExtent)){c+=8-x;break}h[(S*t.yExtent+b)*t.zExtent+_]=(s[c]-i)/r,++c}e.setData(h,t.zExtent,t.yExtent,t.xExtent),t.sigma&&e.setStats(void 0,void 0,void 0,t.sigma),Je.Debug&&rt.timeEnd("Dsn6Parser._parse "+this.name)}getMatrix(){var e=this.volume.header,t=[e.xlen,0,0],r=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],i=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0],t=(i[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-i[1]*i[1]),[[],t,r,i]),r=[0,e.xRate,e.yRate,e.zRate],i=[0,1,2,3],n=new tt;return n.set(t[i[1]][0]/r[i[1]],t[i[2]][0]/r[i[2]],t[i[3]][0]/r[i[3]],0,t[i[1]][1]/r[i[1]],t[i[2]][1]/r[i[2]],t[i[3]][1]/r[i[3]],0,t[i[1]][2]/r[i[1]],t[i[2]][2]/r[i[2]],t[i[3]][2]/r[i[3]],0,0,0,0,1),n.multiply((new tt).makeRotationY(1.5705)),n.multiply((new tt).makeTranslation(-e.zStart,e.yStart,e.xStart)),n.multiply((new tt).makeScale(-1,1,1)),n}}a.add("dsn6",O3),a.add("brix",O3);let k3=/\s+/;class N3 extends P3{get type(){return"dx"}_parse(){Je.Debug&&rt.time("DxParser._parse "+this.name);var e=this.volume,t=this.streamer.peekLines(30),t=this.parseHeaderLines(t),r=this.volume.header;let s=t.dataLineStart,o=r.nx*r.ny*r.nz,l=new Float32Array(o),h=0,c=0;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){if(h<o&&c>s){var n=i[e].trim();if(""!==n){var a=n.split(k3);for(let e=0,t=a.length;e<t;++e)l[h]=parseFloat(a[e]),++h}}++c}}),e.setData(l,r.nz,r.ny,r.nx),Je.Debug&&rt.timeEnd("DxParser._parse "+this.name)}parseHeaderLines(r){var i={},e=r.length;let n=0,a=0,s=0;for(let t=0;t<e;++t){let e;var o=r[t];if(o.startsWith("object 1"))e=o.split(k3),i.nx=parseInt(e[5]),i.ny=parseInt(e[6]),i.nz=parseInt(e[7]);else if(o.startsWith("origin"))e=o.split(k3),i.xmin=parseFloat(e[1]),i.ymin=parseFloat(e[2]),i.zmin=parseFloat(e[3]);else if(o.startsWith("delta"))e=o.split(k3),0===s?i.hx=parseFloat(e[1])*this.voxelSize:1===s?i.hy=parseFloat(e[2])*this.voxelSize:2===s&&(i.hz=parseFloat(e[3])*this.voxelSize),s+=1;else if(o.startsWith("object 3")){n=t,a+=o.length+1;break}a+=o.length+1}return this.volume.header=i,{dataLineStart:n,headerByteCount:a}}getMatrix(){var e=this.volume.header,t=new tt;return t.multiply((new tt).makeRotationY(1.5705)),t.multiply((new tt).makeTranslation(-e.zmin,e.ymin,e.xmin)),t.multiply((new tt).makeScale(-e.hz,e.hy,e.hx)),t}}a.add("dx",N3);class F3 extends N3{get type(){return"dxbin"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("DxbinParser._parse "+this.name);var e=Ql(this.streamer.data),t=((t,r=10485760,i="\n")=>{let n="",a=[];for(let e=0;e<t.length;e+=r){var s,o=Yl(t.subarray(e,e+r)),l=o.lastIndexOf(i);-1===l?n+=o:(s=n+o.substr(0,l),a=a.concat(s.split(i)),n=l===o.length-i.length?"":o.substr(l+i.length))}return""!==n&&a.push(n),a})(new Uint8Array(e,0,1e3)),t=this.parseHeaderLines(t),r=this.volume.header,i=t.headerByteCount,n=r.nx*r.ny*r.nz,a=new DataView(e),s=new Float32Array(n);for(let e=0;e<n;++e)s[e]=a.getFloat64(8*e+i,!0);this.volume.setData(s,r.nz,r.ny,r.nx),Je.Debug&&rt.timeEnd("DxbinParser._parse "+this.name)}}a.add("dxbin",F3);class B3 extends P3{get type(){return"mrc"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("MrcParser._parse "+this.name);var e=this.volume,t={},r=Ql(this.streamer.data),i=new Int32Array(r,0,56),n=new Float32Array(r,0,56),a=new DataView(r);if(t.MAP=String.fromCharCode(a.getUint8(208),a.getUint8(209),a.getUint8(210),a.getUint8(211)),t.MACHST=[a.getUint8(212),a.getUint8(213)],17===t.MACHST[0]&&17===t.MACHST[1]){var s=r.byteLength;for(let e=0;e<s;e+=4)a.setFloat32(e,a.getFloat32(e),!0)}t.NX=i[0],t.NY=i[1],t.NZ=i[2],t.MODE=i[3],t.NXSTART=i[4],t.NYSTART=i[5],t.NZSTART=i[6],t.MX=i[7],t.MY=i[8],t.MZ=i[9],t.xlen=n[10]*this.voxelSize,t.ylen=n[11]*this.voxelSize,t.zlen=n[12]*this.voxelSize,t.alpha=n[13],t.beta=n[14],t.gamma=n[15],t.MAPC=i[16],t.MAPR=i[17],t.MAPS=i[18],t.DMIN=n[19],t.DMAX=n[20],t.DMEAN=n[21],t.ISPG=i[22],t.NSYMBT=i[23],t.LSKFLG=i[24],t.originX=n[49],t.originY=n[50],t.originZ=n[51],t.ARMS=n[54];let o;if(2===(e.header=t).MODE)o=new Float32Array(r,1024+t.NSYMBT,t.NX*t.NY*t.NZ);else if(0===t.MODE){if(o=new Float32Array(new Int8Array(r,1024+t.NSYMBT,t.NX*t.NY*t.NZ)),-128===i[39]&&127===i[40]){var l=(t.DMAX-t.DMIN)/255,h=.5*(t.DMIN+t.DMAX+l);for(let e=0,t=o.length;e<t;++e)o[e]=l*o[e]+h}}else rt.error("MrcParser unknown mode",t.MODE);e.setData(o,t.NX,t.NY,t.NZ),0!==t.ARMS&&e.setStats(t.DMIN,t.DMAX,t.DMEAN,t.ARMS),Je.Debug&&rt.timeEnd("MrcParser._parse "+this.name)}getMatrix(){var e=this.volume.header,t=[e.xlen,0,0],r=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],i=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0],t=(i[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-i[1]*i[1]),[[],t,r,i]),r=[0,e.MX,e.MY,e.MZ],i=[0,e.MAPC,e.MAPR,e.MAPS],n=new tt;return n.set(t[i[1]][0]/r[i[1]],t[i[2]][0]/r[i[2]],t[i[3]][0]/r[i[3]],0,t[i[1]][1]/r[i[1]],t[i[2]][1]/r[i[2]],t[i[3]][1]/r[i[3]],0,t[i[1]][2]/r[i[1]],t[i[2]][2]/r[i[2]],t[i[3]][2]/r[i[3]],0,0,0,0,1),n.setPosition(new et(e.originX,e.originY,e.originZ)),n.multiply((new tt).makeTranslation(e.NXSTART,e.NYSTART,e.NZSTART)),n}}a.add("mrc",B3),a.add("ccp4",B3),a.add("map",B3);let U3=/\s+/;function z3(e){return e.trim().split(U3).map(parseFloat)}class V3 extends P3{get type(){return"xplor"}_parse(){Je.Debug&&rt.time("XplorParser._parse "+this.name);var e=this.volume,t=this.streamer.peekLines(8);let o={},r,l=(r=t[2].startsWith("REMARKS")?parseInt(t[1].substring(0,8))+2:5)+3;var i=z3(t[r]),i=(o.NA=i[0],o.AMIN=i[1],o.AMAX=i[2],o.NB=i[3],o.BMIN=i[4],o.BMAX=i[5],o.NC=i[6],o.CMIN=i[7],o.CMAX=i[8],z3(t[r+1])),t=(o.a=i[0]*this.voxelSize,o.b=i[1]*this.voxelSize,o.c=i[2]*this.voxelSize,o.alpha=i[3],o.beta=i[4],o.gamma=i[5],o.AMAX-o.AMIN+1),i=o.BMAX-o.BMIN+1,n=o.CMAX-o.CMIN+1;let h=t*i*n,c=new Float32Array(h),u=Math.ceil(1+t*i/6),d=0,m=0;this.streamer.eachChunkOfLines(function(e){var t=0,r=e.length,i=e;for(let e=t;e<r;++e){var n,a=i[e];if(m>=l&&(m-l)%u!=0&&d<h)for(let e=0;e<6;++e){var s=parseFloat(a.substr(12*e,12));if(isNaN(s))break;c[d++]=s}else d===h&&(n=a.trim())&&"-9999"!==n&&(n=z3(a),o.RAVE=n[0],o.RSIGMA=n[1]);++m}}),e.header=o,e.setData(c,t,i,n),0!==o.RAVE&&1!==o.RSIGMA&&e.setStats(void 0,void 0,o.RAVE,o.RSIGMA),Je.Debug&&rt.timeEnd("XplorParser._parse "+this.name)}getMatrix(){var e=this.volume.header,t=[e.a,0,0],r=[e.b*Math.cos(Math.PI/180*e.gamma),e.b*Math.sin(Math.PI/180*e.gamma),0],i=[e.c*Math.cos(Math.PI/180*e.beta),e.c*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0],t=(i[2]=Math.sqrt(e.c*e.c*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-i[1]*i[1]),[[],t,r,i]),r=[0,e.NA,e.NB,e.NC],i=[0,1,2,3],n=new tt;return n.set(t[i[1]][0]/r[i[1]],t[i[2]][0]/r[i[2]],t[i[3]][0]/r[i[3]],0,t[i[1]][1]/r[i[1]],t[i[2]][1]/r[i[2]],t[i[3]][1]/r[i[3]],0,t[i[1]][2]/r[i[1]],t[i[2]][2]/r[i[2]],t[i[3]][2]/r[i[3]],0,0,0,0,1),n.multiply((new tt).makeTranslation(e.AMIN,e.BMIN,e.CMIN)),n}}function G3(e,t,r){e/=360,t/=100,r/=100;let i,n,a;var s=Math.floor(6*e),e=6*e-s,o=r*(1-t),l=r*(1-e*t),h=r*(1-(1-e)*t);switch(s%6){case 0:i=r,n=h,a=o;break;case 1:i=l,n=r,a=o;break;case 2:i=o,n=r,a=h;break;case 3:i=o,n=l,a=r;break;case 4:i=h,n=o,a=r;break;case 5:i=r,n=o,a=l}return[i,n,a]}a.add("xplor",V3),a.add("cns",V3);let H3={red:G3(0,100,100),orange:G3(20,100,100),gold:G3(40,100,100),yellow:G3(60,100,100),lime:G3(80,100,100),green:G3(120,80,100),sea:G3(150,100,100),cyan:G3(180,100,85),sky:G3(210,75,95),blue:G3(240,70,100),purple:G3(275,75,100),magenta:G3(300,95,100),hotpink:G3(335,100,100),pink:G3(350,55,100),peach:G3(25,75,100),lilac:G3(275,55,100),pinktint:G3(340,30,100),peachtint:G3(25,50,100),yellowtint:G3(60,50,100),greentint:G3(135,40,100),bluetint:G3(220,40,100),lilactint:G3(275,35,100),white:G3(0,0,100),gray:G3(0,0,50),brown:G3(20,45,75),deadwhite:[1,1,1],deadblack:[0,0,0],invisible:[0,0,0]},$3=/[\s,]+/,j3=/[^{}\s]*{[^{}]+}|[^{}\s]+/g,W3=/^{+|}+$/g,q3=/^['"]+|['"]+$/g,X3=/\s*=\s*/g;function Y3(e){let t,r;var i=[];let n;var a=(e=e.replace(X3,"=")).match(j3);for(let e=1;e<a.length;++e){var s=a[e];"{"===s[0]?t=s.substring(1,s.length-1):2===(s=s.split("=")).length&&("color"===s[0]?r=H3[s[1]]:"width"===s[0]?n=parseInt(s[1]):"master"===s[0]&&i.push(s[1].replace(W3,"")))}return{listName:t,listColor:r,listMasters:i,listWidth:n}}function K3(e){var t=(e=e.trim()).indexOf("{"),r=e.indexOf("}"),i=e.substr(r+1).split($3),e=e.substr(t+1,r-1),t=[parseFloat(i[i.length-3]),parseFloat(i[i.length-2]),parseFloat(i[i.length-1])];let n,a,s,o=!1,l=!1;for(let e=4;e<=i.length;e++){var h=i[i.length-e];h in H3&&(n=H3[i[i.length-e]]),h.startsWith("width")&&(a=parseInt(h.substring(5))),h.startsWith("r=")&&(s=parseFloat(h.split("=")[1])),h.startsWith("P")&&(o=!0),h.startsWith("X")&&(l=!0)}return{label:e,position:t,color:n,radius:s,width:a,isLineBreak:o,isTriangleBreak:l}}function Z3(e){var t=e.indexOf("{"),r=e.indexOf("}");return e.substring(-1!==t?t+1:0,-1!==r?r:void 0).trim()}function Q3(e){let t="";var r=[],i={},n=(e=e.replace(X3,"=")).match(j3);for(let e=1;e<n.length;++e){var a=n[e];"{"===a[0]?t=a.substring(1,a.length-1):2===(a=a.split("=")).length?"master"===a[0]?r.push(a[1].replace(W3,"")):i[a[0]]=a[1].replace(W3,""):i[a[0]]=!0}return{groupName:t,groupFlags:i,groupMasters:r}}class J3 extends nS{get type(){return"kin"}get __objName(){return"kinemage"}_parse(){Je.Debug&&rt.time("KinParser._parse "+this.name);let v={kinemage:void 0,onewidth:void 0,"1viewid":void 0,pdbfile:void 0,texts:[],text:"",captions:[],caption:"",groupDict:{},subgroupDict:{},masterDict:{},pointmasterDict:{},dotLists:[],vectorLists:[],ballLists:[],ribbonLists:[]};this.kinemage=v;let _,y,b=!1,x="",S,w,A,M,C=!1,T="",E=null,P=null,I,R,D,L,O,k,N,F,B=!1,U="",z,V,G,H,$,j=!1,W="",J,q,X,Y,K,Z=!1,Q=!1;if(this.streamer.eachChunkOfLines(function(e){var t,r,i=0,n=e.length,a=e;for(let e=i;e<n;++e){var s,o=a[e];if("@"===o[0]&&(b=!1,C=!1,B=!1,j=!1,Z=!1,Q=!1),o)if(o.startsWith("@dotlist")){let{listColor:e,listName:t,listMasters:r}=Y3(o);b=!0,x="",w=[],A=[],M=[],S=e,_&&(r=r.concat(_)),y&&(r=r.concat(y)),v.dotLists.push({name:t,masterArray:r,labelArray:w,positionArray:A,colorArray:M})}else if(o.startsWith("@vectorlist")){let{listMasters:e,listName:t,listWidth:r,listColor:i}=Y3(o);e&&e.forEach(function(e){v.masterDict[e]||(v.masterDict[e]={indent:!1,visible:!1})}),C=!0,T="",E=null,P=null,D=[],L=[],O=[],k=[],N=[],F=[],I=i,R=[],r&&R.push(r),_&&(e=e.concat(_)),y&&(e=e.concat(y)),v.vectorLists.push({name:t,masterArray:e,label1Array:D,label2Array:L,position1Array:O,position2Array:k,color1Array:N,color2Array:F,width:R})}else if(o.startsWith("@balllist")){let{listName:e,listColor:t,listMasters:r}=Y3(o);r&&r.forEach(function(e){v.masterDict[e]||(v.masterDict[e]={indent:!1,visible:!1})}),B=!0,U="",G=[],z=[],H=[],$=[],V=t,_&&(r=r.concat(_)),y&&(r=r.concat(y)),v.ballLists.push({name:e,masterArray:r,labelArray:G,radiusArray:z,positionArray:H,colorArray:$})}else if(o.startsWith("@ribbonlist")||o.startsWith("@trianglelist")){let{listMasters:e,listName:t,listColor:r}=Y3(o);e&&e.forEach(function(e){v.masterDict[e]||(v.masterDict[e]={indent:!1,visible:!1})}),j=!0,W="",q=[],X=[],Y=[],K=[],J=r,_&&(e=e.concat(_)),y&&(e=e.concat(y)),v.ribbonLists.push({name:t,masterArray:e,labelArray:q,positionArray:X,breakArray:Y,colorArray:K})}else if(o.startsWith("@text"))Z=!0,v.texts.push(o.substr(5));else if(o.startsWith("@caption"))Q=!0,v.captions.push(o.substr(8));else if(b){let{label:e,color:t,position:r}=K3(o);'"'===e?e=x:x=e,void 0===t&&(t=S),w.push(e),A.push(...r),M.push(...t)}else if(C)for(var l=o.replace(/(?!^){/g,"\n{").split(/\n/),h=0;h<l.length;h++){let{label:e,color:t,width:r,position:i,isLineBreak:n}=K3(l[h]);'"'===e?e=T:T=e,void 0===t&&(t=I),n||null!==E&&(r&&R.push(r),D.push(T),O.push(...E),N.push(...P),L.push(e),k.push(...i),F.push(...t)),T=e,E=i,P=t}else if(B){let{label:e,radius:t,color:r,position:i}=K3(o);'"'===e?e=U:U=e,void 0===t&&(t=1),void 0===r&&(r=V),G.push(e),z.push(t),H.push(...i),$.push(...r)}else if(j){let{label:e,color:t,position:r,isTriangleBreak:i}=K3(o);'"'===e?e=W:W=e,void 0===t&&(t=J),q.push(e),X.push(...r),Y.push(i),K.push(...t)}else if(Z)v.texts.push(o);else if(Q)v.captions.push(o);else if(o.startsWith("@kinemage"))v.kinemage=parseInt(o.substr(9).trim());else if(o.startsWith("@onewidth"))v.onewidth=!0;else if(o.startsWith("@1viewid"))v["1viewid"]=Z3(o);else if(o.startsWith("@pdbfile"))v.pdbfile=Z3(o);else if(o.startsWith("@group")){var c,{groupName:u,groupFlags:d,groupMasters:m}=Q3(o);for(c in v.groupDict[u]||(v.groupDict[u]={dominant:!1,animate:!1},_=m),_&&_.forEach(function(e){v.masterDict[e]||(v.masterDict[e]={indent:!1,visible:!1})}),d)v.groupDict[u][c]=d[c]}else if(o.startsWith("@subgroup")){var p,{groupName:f,groupFlags:g,groupMasters:m}=Q3(o);for(p in v.subgroupDict[f]||(v.subgroupDict[f]={dominant:!1,animate:!1},y=m),y&&y.forEach(function(e){v.masterDict[e]||(v.masterDict[e]={indent:!1,visible:!1})}),g)v.subgroupDict[f][p]=g[p]}else o.startsWith("@master")?(s=Z3(o),r=void 0,t=-1===(r=(t=o).indexOf("}"))?void 0:t.substr(r+1).trim(),v.masterDict[s]||(v.masterDict[s]={indent:!1,visible:!1}),"on"===t?v.masterDict[s].visible=!0:"off"===t?v.masterDict[s].visible=!1:"indent"===t&&(v.masterDict[s].indent=!0)):o.startsWith("@pointmaster")?({groupName:r,groupFlags:t}=Q3(o),v.pointmasterDict[r]={id:Object.keys(t)[0].replace(q3,"")}):console.log(o);else b=!1,C=!1,B=!1,j=!1}}),v.text=v.texts.join("\n").trim(),v.caption=v.captions.join("\n").trim(),v.ribbonLists){let t=[];v.ribbonLists.forEach(function(e){t.push((e=>{var{labelArray:t,positionArray:r,colorArray:i,breakArray:n}=e,a=[],s=[],o=[],l=[];for(let e=0;e<n.length/3;e++){var h=3*e,c=9*e;n[1+h]||n[2+h]||(a.push(t[h]),a.push(t[1+h]),a.push(t[2+h]),l.push(n[h]),l.push(n[1+h]),l.push(n[2+h]),s.push(r[c]),s.push(r[1+c]),s.push(r[2+c]),s.push(r[3+c]),s.push(r[4+c]),s.push(r[5+c]),s.push(r[6+c]),s.push(r[7+c]),s.push(r[8+c]),o.push(i[c]),o.push(i[1+c]),o.push(i[2+c]),o.push(i[3+c]),o.push(i[4+c]),o.push(i[5+c]),o.push(i[6+c]),o.push(i[7+c]),o.push(i[8+c]))}return{name:e.name,masterArray:e.masterArray,labelArray:a,positionArray:s,breakArray:l,colorArray:o}})((e=>{var{labelArray:t,positionArray:r,colorArray:i,breakArray:n}=e,a=[];for(let e=0;e<3*(t.length-2);++e)a[e]=t[e-2*Math.floor(e/3)];var s=[];for(let e=0;e<3*(n.length-2);++e)s[e]=n[e-2*Math.floor(e/3)];var o=[];for(let e=0;e<9*(r.length/3-2);++e)o[e]=r[e-6*Math.floor(e/9)];var l=[];for(let e=0;e<9*(i.length/3-2);++e)l[e]=i[e-6*Math.floor(e/9)];var h=[];for(let e=0;e<o.length/3;++e)h.push(new et(o[3*e],o[3*e]+1,o[3*e]+2));return{name:e.name,masterArray:e.masterArray,labelArray:a,positionArray:o,breakArray:s,colorArray:l}})(e)))}),v.ribbonLists=t}Je.Debug&&rt.timeEnd("KinParser._parse "+this.name)}}a.add("kin",J3);class ew extends nS{constructor(e,t){super(e,t),this.loader=this.getLoader(),this.surface=new hf(this.name,this.path)}get type(){return"surface"}get __objName(){return"surface"}_parse(){var e=this.loader.parse(this.streamer.asText());this.surface.fromGeometry(e)}}function tw(){this.regexp={vertex_pattern:/^v\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,normal_pattern:/^vn\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,uv_pattern:/^vt\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}}tw.prototype={constructor:tw,setPath:function(e){this.path=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],startObject:function(e,t){this.object&&!1===this.object.fromDeclaration?(this.object.name=e,this.object.fromDeclaration=!1!==t):(this.object={name:e||"",geometry:{vertices:[],normals:[]},fromDeclaration:!1!==t},this.objects.push(this.object))},parseVertexIndex:function(e,t){e=parseInt(e,10);return 3*(0<=e?e-1:e+t/3)},parseNormalIndex:function(e,t){e=parseInt(e,10);return 3*(0<=e?e-1:e+t/3)},addVertex:function(e,t,r){var i=this.vertices,n=this.object.geometry.vertices;n.push(i[e+0]),n.push(i[e+1]),n.push(i[e+2]),n.push(i[t+0]),n.push(i[t+1]),n.push(i[t+2]),n.push(i[r+0]),n.push(i[r+1]),n.push(i[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var i=this.normals,n=this.object.geometry.normals;n.push(i[e+0]),n.push(i[e+1]),n.push(i[e+2]),n.push(i[t+0]),n.push(i[t+1]),n.push(i[t+2]),n.push(i[r+0]),n.push(i[r+1]),n.push(i[r+2])},addFace:function(e,t,r,i,n,a,s,o){var l,h=this.vertices.length,e=this.parseVertexIndex(e,h),t=this.parseVertexIndex(t,h),r=this.parseVertexIndex(r,h);void 0===i?this.addVertex(e,t,r):(l=this.parseVertexIndex(i,h),this.addVertex(e,t,l),this.addVertex(t,r,l)),void 0!==n&&(h=this.normals.length,e=this.parseNormalIndex(n,h),t=n===a?e:this.parseNormalIndex(a,h),r=n===s?e:this.parseNormalIndex(s,h),void 0===i?this.addNormal(e,t,r):(l=this.parseNormalIndex(o,h),this.addNormal(e,t,l),this.addNormal(t,r,l)))},addLineGeometry:function(e){this.object.geometry.type="Line";for(var t=this.vertices.length,r=0,i=e.length;r<i;r++)this.addVertexLine(this.parseVertexIndex(e[r],t))}};return e.startObject("",!1),e},parse:function(e){for(var t,r=this._createParserState(),i=(e=-1!==(e=-1!==e.indexOf("\r\n")?e.replace(/\r\n/g,"\n"):e).indexOf("\\\n")?e.replace(/\\\n/g,""):e).split("\n"),n="",a=[],s="function"==typeof"".trimLeft,o=0,l=i.length;o<l;o++)if(n=i[o],0!==(n=s?n.trimLeft():n.trim()).length&&"#"!==(t=n.charAt(0)))if("v"===t){if(" "===(f=n.charAt(1))&&null!==(a=this.regexp.vertex_pattern.exec(n)))r.vertices.push(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));else if("n"===f&&null!==(a=this.regexp.normal_pattern.exec(n)))r.normals.push(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));else if("t"!==f||null===this.regexp.uv_pattern.exec(n))throw new Error("Unexpected vertex/normal/uv line: '"+n+"'")}else if("f"===t){if(null!==(a=this.regexp.face_vertex_uv_normal.exec(n)))r.addFace(a[1],a[4],a[7],a[10],a[3],a[6],a[9],a[12]);else if(null===this.regexp.face_vertex_uv.exec(n))if(null!==(a=this.regexp.face_vertex_normal.exec(n)))r.addFace(a[1],a[3],a[5],a[7],a[2],a[4],a[6],a[8]);else{if(null===(a=this.regexp.face_vertex.exec(n)))throw new Error("Unexpected face line: '"+n+"'");r.addFace(a[1],a[2],a[3],a[4])}}else if("l"===t){var h=n.substring(1).trim().split(" "),c=[],u=[];if(-1===n.indexOf("/"))c=h;else for(var d=0,m=h.length;d<m;d++){var p=h[d].split("/");""!==p[0]&&c.push(p[0]),""!==p[1]&&u.push(p[1])}r.addLineGeometry(c,u)}else if(null!==(a=this.regexp.object_pattern.exec(n))){var f=a[0].substr(1).trim();r.startObject(f)}else if(!this.regexp.material_use_pattern.test(n)&&!this.regexp.material_library_pattern.test(n)&&null===this.regexp.smoothing_pattern.exec(n)&&"\0"!==n)throw new Error("Unexpected line: '"+n+"'");var g=[];for(o=0,l=r.objects.length;o<l;o++){var v,_=r.objects[o].geometry;0!==_.vertices.length&&((v=new Fn).setAttribute("position",new Cn(new Float32Array(_.vertices),3)),0<_.normals.length?v.setAttribute("normal",new Cn(new Float32Array(_.normals),3)):v.computeVertexNormals(),g.push(v))}return g}};class rw extends ew{get type(){return"obj"}getLoader(){return new tw}}a.add("obj",rw);let iw=["int8","char","uint8","uchar","int16","short","uint16","ushort","int32","int","uint32","uint","float32","float","float64","double"];function nw(e){if(t=e,iw.includes(t))return e;var t;throw new Error("Unsupported data type: "+e)}function aw(t,e,r){switch(e){case"int8":case"char":return{read:e=>t.getInt8(e),size:1};case"uint8":case"uchar":return{read:e=>t.getUint8(e),size:1};case"int16":case"short":return{read:e=>t.getInt16(e,r),size:2};case"uint16":case"ushort":return{read:e=>t.getUint16(e,r),size:2};case"int32":case"int":return{read:e=>t.getInt32(e,r),size:4};case"uint32":case"uint":return{read:e=>t.getUint32(e,r),size:4};case"float32":case"float":return{read:e=>t.getFloat32(e,r),size:4};case"float64":case"double":return{read:e=>t.getFloat64(e,r),size:8};default:throw new Error("Unsupported data type: "+e)}}class sw{constructor(){this._color=new ze,this.propertyNameMapping={},this.customPropertyMapping={}}setPropertyNameMapping(e){this.propertyNameMapping=e}createBuffer(){var e,t={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[],faceVertexColors:[]};for(e of Object.keys(this.customPropertyMapping))t[e]=[];return t}extractHeaderText(e){let t=0,r=!0,i="";var n=[],a=(new TextDecoder).decode(e.subarray(0,5)),a=/^ply\r\n/.test(a);do{var s=String.fromCharCode(e[t++]);"\n"!==s&&"\r"!==s?i+=s:("end_header"===i&&(r=!1),""!==i&&(n.push(i),i=""))}while(r&&t<e.length);return!0===a&&t++,{headerText:n.join("\r")+"\r",headerLength:t}}handleElement(e,t,r,i){if("vertex"===t){e.vertices.push(r[i.attrX],r[i.attrY],r[i.attrZ]),null!==i.attrNX&&null!==i.attrNY&&null!==i.attrNZ&&e.normals.push(r[i.attrNX],r[i.attrNY],r[i.attrNZ]),null!==i.attrS&&null!==i.attrT&&e.uvs.push(r[i.attrS],r[i.attrT]),null!==i.attrR&&null!==i.attrG&&null!==i.attrB&&(this._color.setRGB(r[i.attrR]/255,r[i.attrG]/255,r[i.attrB]/255).convertSRGBToLinear(),e.colors.push(this._color.r,this._color.g,this._color.b));for(var n of Object.keys(this.customPropertyMapping))for(var a of this.customPropertyMapping[n])e[n].push(r[a])}else{var s;"face"===t&&(t=r.vertex_indices||r.vertex_index,s=r.texcoord,3===t.length?(e.indices.push(t[0],t[1],t[2]),s&&6===s.length&&(e.faceVertexUvs.push(s[0],s[1]),e.faceVertexUvs.push(s[2],s[3]),e.faceVertexUvs.push(s[4],s[5]))):4===t.length&&(e.indices.push(t[0],t[1],t[3]),e.indices.push(t[1],t[2],t[3])),null!==i.attrR)&&null!==i.attrG&&null!==i.attrB&&(this._color.setRGB(r[i.attrR]/255,r[i.attrG]/255,r[i.attrB]/255).convertSRGBToLinear(),e.faceVertexColors.push(this._color.r,this._color.g,this._color.b),e.faceVertexColors.push(this._color.r,this._color.g,this._color.b),e.faceVertexColors.push(this._color.r,this._color.g,this._color.b))}}parse(e){let t;var r,i,n;return t=e instanceof ArrayBuffer?(r=new Uint8Array(e),{headerText:i,headerLength:n}=this.extractHeaderText(r),"ascii"===(i=this.parseHeader(i,n)).format?(n=(new TextDecoder).decode(r),this.parseASCII(n,i)):this.parseBinary(r,i)):this.parseASCII(e,this.parseHeader(e))}parseHeader(e,t=0){let r="";var e=/^ply([\s\S]*)end_header(\r\n|\r|\n)/.exec(e),i={comments:[],elements:[],headerLength:t,objInfo:"",format:"",version:""},n=(r=null!==e?e[1]:r).split(/\r\n|\r|\n/);let a;for(let t=0;t<n.length;t++){let e=n[t];if(""!==(e=e.trim())){var s=e.split(/\s+/),o=s.shift();switch(e=s.join(" "),o){case"format":i.format=s[0],i.version=s[1];break;case"comment":i.comments.push(e);break;case"element":if(void 0!==a){l=void 0;var l=a;if("object"!=typeof l||null===l)throw new Error("Expected element to be an object");if("string"!=typeof l.name)throw new Error("Expected element.name to be a string");if("number"!=typeof l.count)throw new Error("Expected element.count to be a number");if(!Array.isArray(l.properties))throw new Error("Expected element.properties to be an array");i.elements.push(a)}a={name:s[0],count:parseInt(s[1]),properties:[]};break;case"property":void 0===a?console.warn("property without element"):a.properties.push(((e,t)=>{let r=e[0],i;return(i="list"===r?{isList:!0,name:e[3],type:nw(e[2]),countType:nw(e[1])}:{isList:!1,name:e[1],type:nw(r)}).name in t&&(i.name=t[i.name]),i})(s,this.propertyNameMapping));break;case"obj_info":i.objInfo=e;break;default:console.log("unhandled",o,s)}}}return void 0!==a&&i.elements.push(a),i}parseASCII(e,t){var r=this.createBuffer();let i,n;i=null!==(n=/end_header\s+(\S[\s\S]*\S|\S)\s*$/.exec(e))?n[1].split(/\s+/):[];var a=new cw(i);e:for(let e=0;e<t.elements.length;e++){var s=t.elements[e],o=lw(s.properties);for(let e=0;e<s.count;e++){var l=((t,r)=>{var i={name:"",type:""};for(let e=0;e<t.length;e++){if(r.empty())return null;var n=t[e];if(n.isList){var a=[],s=ow(r.next(),n.countType);for(let e=0;e<s;e++){if(r.empty())return null;a.push(ow(r.next(),n.type))}i[n.name]=a}else i[t[e].name]=ow(r.next(),t[e].type)}return i})(s.properties,a);if(!l)break e;this.handleElement(r,s.name,l,o)}}return this.postProcess(r)}parseBinary(e,t){var r=this.createBuffer(),i="binary_little_endian"===t.format,n=new DataView(e,t.headerLength);let a,s=0;for(let e=0;e<t.elements.length;e++){var o=t.elements[e],l=o.properties,h=lw(l),c=this.makeBinaryProperties(l,n,i);for(let e=0;e<o.count;e++)a=((t,r)=>{var i={};let n=0;for(let e=0;e<r.length;e++){var a=r[e],s=a.valueReader;if(a.isList){var o=[],l=a.countReader.read(t+n);n+=a.countReader.size;for(let e=0;e<l;e++)o.push(s.read(t+n)),n+=s.size;i[a.name]=o}else i[a.name]=s.read(t+n),n+=s.size}return[i,n]})(s,c),s+=a[1],this.handleElement(r,o.name,a[0],h)}return this.postProcess(r)}postProcess(e){let t=new Fn;0<e.indices.length&&t.setIndex(e.indices),t.setAttribute("position",new Pn(e.vertices,3)),0<e.normals.length&&t.setAttribute("normal",new Pn(e.normals,3)),0<e.uvs.length&&t.setAttribute("uv",new Pn(e.uvs,2)),0<e.colors.length&&t.setAttribute("color",new Pn(e.colors,3)),(0<e.faceVertexUvs.length||0<e.faceVertexColors.length)&&(t=t.toNonIndexed(),0<e.faceVertexUvs.length&&t.setAttribute("uv",new Pn(e.faceVertexUvs,2)),0<e.faceVertexColors.length)&&t.setAttribute("color",new Pn(e.faceVertexColors,3));for(var r of Object.keys(this.customPropertyMapping))0<e[r].length&&t.setAttribute(r,new Pn(e[r],this.customPropertyMapping[r].length));return t.computeBoundingSphere(),t}makeBinaryProperties(r,i,n){var a=[];for(let e=0,t=r.length;e<t;e++){var s=r[e];s.isList?a.push(Object.assign(Object.assign({},s),{countReader:aw(i,s.countType,n),valueReader:aw(i,s.type,n)})):a.push(Object.assign(Object.assign({},s),{valueReader:aw(i,s.type,n)}))}return a}}function ow(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}return 0}function lw(e){let n=e.map(e=>e.name);function t(r){for(let e=0,t=r.length;e<t;e++){var i=r[e];if(n.includes(i))return i}return null}return{attrX:t(["x","px","posx"])||"x",attrY:t(["y","py","posy"])||"y",attrZ:t(["z","pz","posz"])||"z",attrNX:t(["nx","normalx"]),attrNY:t(["ny","normaly"]),attrNZ:t(["nz","normalz"]),attrS:t(["s","u","texture_u","tx"]),attrT:t(["t","v","texture_v","ty"]),attrR:t(["red","diffuse_red","r","diffuse_r"]),attrG:t(["green","diffuse_green","g","diffuse_g"]),attrB:t(["blue","diffuse_blue","b","diffuse_b"])}}class hw extends ew{get type(){return"ply"}getLoader(){return new sw}}class cw{constructor(e){this.arr=e,this.i=0}empty(){return this.i>=this.arr.length}next(){return this.arr[this.i++]}}a.add("ply",hw);class uw extends nS{constructor(e,t){t=t||{};super(e,t),this.delimiter=ce(t.delimiter,","),this.comment=ce(t.comment,"#"),this.columnNames=ce(t.columnNames,!1),this.table={name:this.name,path:this.path,columnNames:[],data:[]}}get type(){return"csv"}get __objName(){return"table"}_parse(){let a=this.table.data,s=new RegExp("\\s*"+this.delimiter+"\\s*"),o=0;this.streamer.eachChunkOfLines(t=>{var r=t.length;for(let e=0;e<r;++e){var i,n=t[e].trim();n.startsWith(this.comment)||(i=n.split(s),0===o?this.table.columnNames=i:n&&a.push(i),++o)}})}}a.add("csv",uw);class dw extends nS{constructor(e,t){t=t||{};super(e,t),this.string=ce(t.string,!1),this.json={name:this.name,path:this.path,data:{}}}get type(){return"json"}get __objName(){return"json"}get isJson(){return!0}_parse(){this.streamer.isBinary()||this.string?this.json.data=JSON.parse(this.streamer.asText()):this.json.data=this.streamer.data}}a.add("json",dw);class mw extends nS{constructor(e,t){super(e,t||{}),this.msgpack={name:this.name,path:this.path,data:void 0}}get type(){return"msgpack"}get __objName(){return"msgpack"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("MsgpackParser._parse "+this.name),this.msgpack.data=NS(this.streamer.data),Je.Debug&&rt.timeEnd("MsgpackParser._parse "+this.name)}}a.add("msgpack",mw);class pw extends nS{constructor(e,t){super(e,t||{}),this.netcdf={name:this.name,path:this.path,data:void 0}}get type(){return"netcdf"}get __objName(){return"netcdf"}get isBinary(){return!0}_parse(){Je.Debug&&rt.time("NetcdfParser._parse "+this.name),this.netcdf.data=new y3(this.streamer.data),Je.Debug&&rt.timeEnd("NetcdfParser._parse "+this.name)}}a.add("netcdf",pw);class fw extends nS{constructor(e,t){super(e,t),this.text={name:this.name,path:this.path,data:""}}get type(){return"text"}get __objName(){return"text"}_parse(){this.text.data=this.streamer.asText()}}a.add("txt",fw),a.add("text",fw);let gw=/^['"]|['"]$/g,vw=/^<([\w-:.]+)\s*/,_w=/^([^<]*)/,yw=/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/;function bw(t){return t=t.trim().replace(/<!--[\s\S]*?-->/g,""),{declaration:(()=>{if(s(/^<\?xml\s*/)){for(var e={attributes:{}};!o()&&!l("?>");){var t=a();if(!t)return e;e.attributes[t.name]=t.value}return s(/\?>\s*/),e}})(),root:function e(){let t=s(vw);if(!t)return;let r={name:t[1],attributes:{},children:[]};for(;!(o()||l(">")||l("?>")||l("/>"));){let e=a();if(!e)return r;r.attributes[e.name]=e.value}if(s(/^\s*\/>\s*/))return r;s(/\??>\s*/);r.content=n();let i;for(;i=e();)r.children.push(i);s(/^<\/[\w-:.]+>\s*/);return r}()};function n(){var e=s(_w);return e?e[1]:""}function a(){var e=s(yw);if(e)return{name:e[1],value:e[2].replace(gw,"")}}function s(e){e=t.match(e);if(e)return t=t.slice(e[0].length),e}function o(){return 0===t.length}function l(e){return 0===t.indexOf(e)}}class xw extends nS{constructor(e,t){t=t||{};super(e,t),this.useDomParser=ce(t.useDomParser,!1),this.xml={name:this.name,path:this.path,data:{}}}get type(){return"xml"}get __objName(){return"xml"}get isXml(){return!0}__xmlParser(e){return bw(e)}__domParser(e){return(new window.DOMParser).parseFromString(e,"text/xml")}_parse(){Je.Debug&&rt.time("XmlParser._parse "+this.name),this.useDomParser?this.streamer.data instanceof Document?this.xml.data=this.streamer.data:this.xml.data=this.__domParser(this.streamer.asText()):this.xml.data=this.__xmlParser(this.streamer.asText()),Je.Debug&&rt.timeEnd("XmlParser._parse "+this.name)}}function Sw(e,t){e=e.getNamedItem(t);return null!==e?e.value:""}function ww(e,t,r=!1){var i=Sw(e,"icode").trim(),n=Sw(e,"chain").trim(),a=Sw(e,"altcode");let s=Sw(e,"resnum");return i&&(s+="^"+i),n&&(s+=":"+n),t&&(s+="."+t),r&&a.trim()&&(s+="%"+a),s+="/"+(parseInt(Sw(e,"model"))-1)}function Aw(e,t,r){void 0===e[t]?e[t]=r:e[t]|=r}function Mw(e,t){return null!==e&&e.value===t}a.add("xml",xw);class Cw{constructor(e,t){this.name=e,this.path=t,this.rsrzDict={},this.rsccDict={},this.rciDict={},this.clashDict={},this.clashArray=[],this.geoDict={},this.geoAtomDict={},this.atomDict={},this.clashSele="NONE"}get type(){return"validation"}fromXml(r){Je.Debug&&rt.time("Validation.fromXml");var i=this.rsrzDict,n=this.rsccDict,a=this.rciDict,s=this.clashDict,o=this.clashArray,l=this.geoDict,h=this.geoAtomDict;let c=this.atomDict;var e=r.getElementsByTagName("Entry");if(1===e.length){e=e[0].getElementsByTagName("chemical_shift_list");if(1===e.length){var u=e[0].getElementsByTagName("random_coil_index");for(let e=0,t=u.length;e<t;++e){var d=u[e].attributes;a[(e=>{var t=Sw(e,"chain").trim();let r=`[${Sw(e,"rescode")}]`+Sw(e,"resnum");return t&&(r+=":"+t),r})(d)]=parseFloat(Sw(d,"value"))}}}var m=r.getElementsByTagName("ModelledSubgroup"),p={},f=[];Je.Debug&&rt.time("Validation.fromXml#clashDict");for(let e=0,t=m.length;e<t;++e){var g=m[e],v=g.attributes,_=ww(v),y=(null!==v.getNamedItem("rsrz")&&(i[_]=parseFloat(Sw(v,"rsrz"))),null!==v.getNamedItem("rscc")&&(n[_]=parseFloat(Sw(v,"rscc"))),r.createAttribute("sele")),b=(y.value=_,v.setNamedItem(y),g.getElementsByTagName("clash"));for(let e=0,t=b.length;e<t;++e){var x,S=b[e].attributes,w=Sw(S,"atom");"H"!==Eg(w)&&(S=Sw(S,"cid"),w=ww(v,w,!0),c[w]=!0,void 0===p[S]?p[S]={sele1:w,res1:_}:(x=p[S]).res1!==_&&(x.sele2=w,x.res2=_,f.push(x.res1,_),s[S]=x,o.push(x)))}}Je.Debug&&rt.timeEnd("Validation.fromXml#clashDict");for(let e=0,t=m.length;e<t;++e){var A=m[e],M=A.attributes,C=Sw(M,"sele");if("."!==Sw(M,"seq")){M=((r,e,t)=>{let i=0;var n=e.getElementsByTagName("clash");for(let e=0,t=n.length;e<t;++e)if(r[Sw(n[e].attributes,"cid")]){i+=1;break}return 0<e.getElementsByTagName("angle-outlier").length&&(i+=1),0<e.getElementsByTagName("bond-outlier").length&&(i+=1),0<e.getElementsByTagName("plane-outlier").length&&(i+=1),Mw(t.getNamedItem("rota"),"OUTLIER")&&(i+=1),Mw(t.getNamedItem("rama"),"OUTLIER")&&(i+=1),Mw(t.getNamedItem("RNApucker"),"outlier")&&(i+=1),i})(s,A,M);0<M&&(l[C]=M)}else{var T=A.getElementsByTagName("clash"),E=A.getElementsByTagName("mog-bond-outlier"),P=A.getElementsByTagName("mog-angle-outlier");if(0<E.length||0<P.length||0<T.length){let r={};h[C]=r;for(let e=0,t=T.length;e<t;++e){var I=T[e].attributes;s[Sw(I,"cid")]&&Aw(r,Sw(I,"atom"),1)}for(let e=0,t=E.length;e<t;++e)Sw(E[e].attributes,"atoms").split(",").forEach(function(e){Aw(r,e,2)});for(let e=0,t=P.length;e<t;++e)Sw(P[e].attributes,"atoms").split(",").forEach(function(e){Aw(r,e,4)})}}}this.clashSele=f.length?f.join(" OR "):"NONE",Je.Debug&&rt.timeEnd("Validation.fromXml")}getClashData(e){Je.Debug&&rt.time("Validation.getClashData");var e=e||{},t=e.structure;let i=t.atomSet;e=new ze(ce(e.color,"#f0027f"));let n=t.getAtomProxy(),a=t.getAtomProxy(),s=new et,o=new et,l=new et;var r=this.clashArray,h=r.length;let c=new Float32Array(3*h),u=new Float32Array(3*h);e=_(h,e.r,e.g,e.b);let d=new Float32Array(h),m=new Float32Array(h),p=(Je.Debug&&rt.time("Validation.getClashData#atomDict"),this.atomDict),f=(t.eachAtom(function(e){var t=(e=>{var t=e.inscode,r=e.chainname,i=e.atomname,n=e.altloc;let a=e.resno+"";return t&&(a+="^"+t),r&&(a+=":"+r),i&&(a+="."+i),n&&(a+="%"+n),a+="/"+e.modelIndex})(e);!0===p[t]&&(p[t]=e.index)}),Je.Debug&&rt.timeEnd("Validation.getClashData#atomDict"),0);return r.forEach(function(e,t){var r;n.index=p[e.sele1],a.index=p[e.sele2],void 0!==n.index&&void 0!==a.index&&i.isSet(n.index,a.index)&&(s.subVectors(a,n).setLength(n.vdw),o.copy(n).add(s),s.subVectors(n,a).setLength(a.vdw),l.copy(a).add(s),e=n.distanceTo(a)/2,r=Math.sqrt(n.vdw*n.vdw-e*e),e=Math.sqrt(a.vdw*a.vdw-e*e),o.toArray(c,3*f),l.toArray(u,3*f),d[f]=(r+e)/2,m[f]=t,++f)}),Je.Debug&&rt.timeEnd("Validation.getClashData"),{position1:c.subarray(0,3*f),position2:u.subarray(0,3*f),color:e.subarray(0,3*f),color2:e.subarray(0,3*f),radius:d.subarray(0,f),picking:new xp(m.subarray(0,f),this,t)}}}class Tw extends xw{constructor(e,t){super(e,t||{}),this.useDomParser=!0,this.validation=new Cw(this.name,this.path)}get __objName(){return"validation"}get isXml(){return!0}_parse(){super._parse(),Je.Debug&&rt.time("ValidationParser._parse "+this.name),this.validation.fromXml(this.xml.data),Je.Debug&&rt.timeEnd("ValidationParser._parse "+this.name)}}function Ew(e,t){if(e.length!==t){if(e.subarray)return e.subarray(0,t);e.length=t}return e}function Pw(e,t,r,i,n){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+i),n);else for(var a=0;a<i;a++)e[n+a]=t[r+a]}function Iw(e,t,r,i){for(var n=65535&e|0,a=e>>>16&65535|0,s=0;0!==r;){for(r-=s=2e3<r?2e3:r;a=a+(n=n+t[i++]|0)|0,--s;);n%=65521,a%=65521}return n|a<<16|0}a.add("validation",Tw);var Rw=(()=>{for(var e=[],t=0;t<256;t++){for(var r=t,i=0;i<8;i++)r=1&r?3988292384^r>>>1:r>>>1;e[t]=r}return e})();function Dw(e,t,r,i){var n=Rw,a=i+r;e^=-1;for(var s=i;s<a;s++)e=e>>>8^n[255&(e^t[s])];return-1^e}var Lw=30,Ow=12;var kw=15,Nw=852,Fw=592,Bw=0,Uw=1,zw=2,Vw=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Gw=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Hw=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],$w=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function jw(e,t,r,i,n,a,s,o){for(var l,h,c,u,d,m,p,f,g,v=o.bits,_=0,y=0,b=0,x=0,S=0,w=0,A=0,M=0,C=0,T=0,E=null,P=0,I=new Uint16Array(kw+1),R=new Uint16Array(kw+1),D=null,L=0,_=0;_<=kw;_++)I[_]=0;for(y=0;y<i;y++)I[t[r+y]]++;for(S=v,x=kw;1<=x&&0===I[x];x--);if(x<S&&(S=x),0===x)n[a++]=20971520,n[a++]=20971520,o.bits=1;else{for(b=1;b<x&&0===I[b];b++);for(S<b&&(S=b),_=M=1;_<=kw;_++)if((M=(M<<=1)-I[_])<0)return-1;if(0<M&&(e===Bw||1!==x))return-1;for(R[1]=0,_=1;_<kw;_++)R[_+1]=R[_]+I[_];for(y=0;y<i;y++)0!==t[r+y]&&(s[R[t[r+y]]++]=y);if(m=e===Bw?(E=D=s,19):e===Uw?(E=Vw,P-=257,D=Gw,L-=257,256):(E=Hw,D=$w,-1),_=b,d=a,A=y=T=0,c=-1,u=(C=1<<(w=S))-1,e===Uw&&Nw<C||e===zw&&Fw<C)return 1;for(;;){for(g=s[y]<m?(f=0,s[y]):s[y]>m?(f=D[L+s[y]],E[P+s[y]]):(f=96,0),l=1<<(p=_-A),b=h=1<<w;n[d+(T>>A)+(h-=l)]=p<<24|f<<16|g|0,0!==h;);for(l=1<<_-1;T&l;)l>>=1;if(T=0!==l?(T&l-1)+l:0,y++,0==--I[_]){if(_===x)break;_=t[r+s[y]]}if(S<_&&(T&u)!==c){for(d+=b,M=1<<(w=_-(A=0===A?S:A));w+A<x&&!((M-=I[w+A])<=0);)w++,M<<=1;if(C+=1<<w,e===Uw&&Nw<C||e===zw&&Fw<C)return 1;n[c=T&u]=S<<24|w<<16|d-a|0}}0!==T&&(n[d+T]=_-A<<24|64<<16|0),o.bits=S}return 0}var Ww=1,qw=2,Xw=0,Yw=-2,Kw=1,Zw=852,Qw=592;function Jw(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function eA(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function tA(e){var t;return e&&e.state&&((t=e.state).wsize=0,t.whave=0,t.wnext=0,t=e)&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=Kw,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(Zw),e.distcode=e.distdyn=new Int32Array(Qw),e.sane=1,e.back=-1,Xw):Yw}function rA(e,t){var r,i,n;return e?(r=new eA,(e.state=r).window=null,r=t,(n=!(t=e)||!t.state||(n=t.state,r<0?(i=0,r=-r):(i=1+(r>>4),r<48&&(r&=15)),r&&(r<8||15<r))?Yw:(null!==n.window&&n.wbits!==r&&(n.window=null),n.wrap=i,n.wbits=r,tA(t)))!==Xw&&(e.state=null),n):Yw}var iA,nA,aA=!0;function sA(e,t,r,i){var n,e=e.state;return null===e.window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new Uint8Array(e.wsize)),e.wsize<=i?(Pw(e.window,t,r-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):(i<(n=e.wsize-e.wnext)&&(n=i),Pw(e.window,t,r-i,n,e.wnext),(i-=n)?(Pw(e.window,t,r-i,i,0),e.wnext=i,e.whave=e.wsize):(e.wnext+=n,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=n))),0}function oA(e,N){var t,r,F,i,n,a,s,o,l,B,h,c,U,z,u,d,m,p,V,G,f,g,v,_,y=0,b=new Uint8Array(4),H=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Yw;12===(t=e.state).mode&&(t.mode=13),n=e.next_out,F=e.output,i=e.next_in,r=e.input,o=t.hold,l=t.bits,B=a=e.avail_in,h=s=e.avail_out,g=Xw;e:for(;;)switch(t.mode){case Kw:if(0===t.wrap)t.mode=13;else{for(;l<16;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(2&t.wrap&&35615===o)b[t.check=0]=255&o,b[1]=o>>>8&255,t.check=Dw(t.check,b,2,0),l=o=0,t.mode=2;else if(t.flags=0,t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&o)<<8)+(o>>8))%31)e.msg="incorrect header check",t.mode=30;else if(8!=(15&o))e.msg="unknown compression method",t.mode=30;else{if(l-=4,f=8+(15&(o>>>=4)),0===t.wbits)t.wbits=f;else if(f>t.wbits){e.msg="invalid window size",t.mode=30;break}t.dmax=1<<f,e.adler=t.check=1,t.mode=512&o?10:12,l=o=0}}break;case 2:for(;l<16;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(t.flags=o,8!=(255&t.flags)){e.msg="unknown compression method",t.mode=30;break}if(57344&t.flags){e.msg="unknown header flags set",t.mode=30;break}t.head&&(t.head.text=o>>8&1),512&t.flags&&(b[0]=255&o,b[1]=o>>>8&255,t.check=Dw(t.check,b,2,0)),l=o=0,t.mode=3;case 3:for(;l<32;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.head&&(t.head.time=o),512&t.flags&&(b[0]=255&o,b[1]=o>>>8&255,b[2]=o>>>16&255,b[3]=o>>>24&255,t.check=Dw(t.check,b,4,0)),l=o=0,t.mode=4;case 4:for(;l<16;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.head&&(t.head.xflags=255&o,t.head.os=o>>8),512&t.flags&&(b[0]=255&o,b[1]=o>>>8&255,t.check=Dw(t.check,b,2,0)),l=o=0,t.mode=5;case 5:if(1024&t.flags){for(;l<16;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.length=o,t.head&&(t.head.extra_len=o),512&t.flags&&(b[0]=255&o,b[1]=o>>>8&255,t.check=Dw(t.check,b,2,0)),l=o=0}else t.head&&(t.head.extra=null);t.mode=6;case 6:if(1024&t.flags&&((c=a<(c=t.length)?a:c)&&(t.head&&(f=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Array(t.head.extra_len)),Pw(t.head.extra,r,i,c,f)),512&t.flags&&(t.check=Dw(t.check,r,c,i)),a-=c,i+=c,t.length-=c),t.length))break e;t.length=0,t.mode=7;case 7:if(2048&t.flags){if(0===a)break e;for(c=0;f=r[i+c++],t.head&&f&&t.length<65536&&(t.head.name+=String.fromCharCode(f)),f&&c<a;);if(512&t.flags&&(t.check=Dw(t.check,r,c,i)),a-=c,i+=c,f)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=8;case 8:if(4096&t.flags){if(0===a)break e;for(c=0;f=r[i+c++],t.head&&f&&t.length<65536&&(t.head.comment+=String.fromCharCode(f)),f&&c<a;);if(512&t.flags&&(t.check=Dw(t.check,r,c,i)),a-=c,i+=c,f)break e}else t.head&&(t.head.comment=null);t.mode=9;case 9:if(512&t.flags){for(;l<16;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(o!==(65535&t.check)){e.msg="header crc mismatch",t.mode=30;break}l=o=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=12;break;case 10:for(;l<32;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}e.adler=t.check=Jw(o),l=o=0,t.mode=11;case 11:if(0===t.havedict)return e.next_out=n,e.avail_out=s,e.next_in=i,e.avail_in=a,t.hold=o,t.bits=l,2;e.adler=t.check=1,t.mode=12;case 12:if(5===N||6===N)break e;case 13:if(t.last)o>>>=7&l,l-=7&l,t.mode=27;else{for(;l<3;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}switch(t.last=1&o,--l,3&(o>>>=1)){case 0:t.mode=14;break;case 1:x=S=void 0;var x,S=t;if(aA){for(iA=new Int32Array(512),nA=new Int32Array(32),x=0;x<144;)S.lens[x++]=8;for(;x<256;)S.lens[x++]=9;for(;x<280;)S.lens[x++]=7;for(;x<288;)S.lens[x++]=8;for(jw(Ww,S.lens,0,288,iA,0,S.work,{bits:9}),x=0;x<32;)S.lens[x++]=5;jw(qw,S.lens,0,32,nA,0,S.work,{bits:5}),aA=!1}if(S.lencode=iA,S.lenbits=9,S.distcode=nA,S.distbits=5,t.mode=20,6!==N)break;o>>>=2,l-=2;break e;case 2:t.mode=17;break;case 3:e.msg="invalid block type",t.mode=30}o>>>=2,l-=2}break;case 14:for(o>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if((65535&o)!=(o>>>16^65535)){e.msg="invalid stored block lengths",t.mode=30;break}if(t.length=65535&o,l=o=0,t.mode=15,6===N)break e;case 15:t.mode=16;case 16:if(c=t.length){if(0===(c=s<(c=a<c?a:c)?s:c))break e;Pw(F,r,i,c,n),a-=c,i+=c,s-=c,n+=c,t.length-=c}else t.mode=12;break;case 17:for(;l<14;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(t.nlen=257+(31&o),o>>>=5,l-=5,t.ndist=1+(31&o),o>>>=5,l-=5,t.ncode=4+(15&o),o>>>=4,l-=4,286<t.nlen||30<t.ndist){e.msg="too many length or distance symbols",t.mode=30;break}t.have=0,t.mode=18;case 18:for(;t.have<t.ncode;){for(;l<3;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.lens[H[t.have++]]=7&o,o>>>=3,l-=3}for(;t.have<19;)t.lens[H[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,v={bits:t.lenbits},g=jw(0,t.lens,0,19,t.lencode,0,t.work,v),t.lenbits=v.bits,g){e.msg="invalid code lengths set",t.mode=30;break}t.have=0,t.mode=19;case 19:for(;t.have<t.nlen+t.ndist;){for(;d=(y=t.lencode[o&(1<<t.lenbits)-1])>>>16&255,m=65535&y,!((u=y>>>24)<=l);){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(m<16)o>>>=u,l-=u,t.lens[t.have++]=m;else{if(16===m){for(_=u+2;l<_;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(o>>>=u,l-=u,0===t.have){e.msg="invalid bit length repeat",t.mode=30;break}f=t.lens[t.have-1],c=3+(3&o),o>>>=2,l-=2}else if(17===m){for(_=u+3;l<_;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}f=0,c=3+(7&(o>>>=u)),o>>>=3,l=l-u-3}else{for(_=u+7;l<_;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}f=0,c=11+(127&(o>>>=u)),o>>>=7,l=l-u-7}if(t.have+c>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=30;break}for(;c--;)t.lens[t.have++]=f}}if(30===t.mode)break;if(0===t.lens[256]){e.msg="invalid code -- missing end-of-block",t.mode=30;break}if(t.lenbits=9,v={bits:t.lenbits},g=jw(Ww,t.lens,0,t.nlen,t.lencode,0,t.work,v),t.lenbits=v.bits,g){e.msg="invalid literal/lengths set",t.mode=30;break}if(t.distbits=6,t.distcode=t.distdyn,v={bits:t.distbits},g=jw(qw,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,v),t.distbits=v.bits,g){e.msg="invalid distances set",t.mode=30;break}if(t.mode=20,6===N)break e;case 20:t.mode=21;case 21:if(6<=a&&258<=s){e.next_out=n,e.avail_out=s,e.next_in=i,e.avail_in=a,t.hold=o,t.bits=l,L=j=E=T=C=M=A=w=ie=re=te=ee=k=O=J=Q=Z=K=Y=X=q=D=W=R=I=$=P=void 0;var w,A,M,C,T,E,P=e,$=h,I=P.state,R=P.next_in,j=P.input,W=R+(P.avail_in-5),D=P.next_out,L=P.output,q=D-($-P.avail_out),X=D+(P.avail_out-257),Y=I.dmax,K=I.wsize,Z=I.whave,Q=I.wnext,J=I.window,O=I.hold,k=I.bits,ee=I.lencode,te=I.distcode,re=(1<<I.lenbits)-1,ie=(1<<I.distbits)-1;t:do{for(k<15&&(O+=j[R++]<<k,k+=8,O+=j[R++]<<k,k+=8),w=ee[O&re];;){if(O>>>=A=w>>>24,k-=A,0===(A=w>>>16&255))L[D++]=65535&w;else{if(!(16&A)){if(0==(64&A)){w=ee[(65535&w)+(O&(1<<A)-1)];continue}if(32&A){I.mode=Ow;break t}P.msg="invalid literal/length code",I.mode=Lw;break t}for(M=65535&w,(A&=15)&&(k<A&&(O+=j[R++]<<k,k+=8),M+=O&(1<<A)-1,O>>>=A,k-=A),k<15&&(O+=j[R++]<<k,k+=8,O+=j[R++]<<k,k+=8),w=te[O&ie];;){if(O>>>=A=w>>>24,k-=A,!(16&(A=w>>>16&255))){if(0==(64&A)){w=te[(65535&w)+(O&(1<<A)-1)];continue}P.msg="invalid distance code",I.mode=Lw;break t}if(C=65535&w,k<(A&=15)&&(O+=j[R++]<<k,(k+=8)<A)&&(O+=j[R++]<<k,k+=8),Y<(C+=O&(1<<A)-1)){P.msg="invalid distance too far back",I.mode=Lw;break t}if(O>>>=A,k-=A,(A=D-q)<C){if(Z<(A=C-A)&&I.sane){P.msg="invalid distance too far back",I.mode=Lw;break t}if(E=J,(T=0)===Q){if(T+=K-A,A<M){for(M-=A;L[D++]=J[T++],--A;);T=D-C,E=L}}else if(Q<A){if(T+=K+Q-A,(A-=Q)<M){for(M-=A;L[D++]=J[T++],--A;);if(T=0,Q<M){for(M-=A=Q;L[D++]=J[T++],--A;);T=D-C,E=L}}}else if(T+=Q-A,A<M){for(M-=A;L[D++]=J[T++],--A;);T=D-C,E=L}for(;2<M;)L[D++]=E[T++],L[D++]=E[T++],L[D++]=E[T++],M-=3;M&&(L[D++]=E[T++],1<M)&&(L[D++]=E[T++])}else{for(T=D-C;L[D++]=L[T++],L[D++]=L[T++],L[D++]=L[T++],2<(M-=3););M&&(L[D++]=L[T++],1<M)&&(L[D++]=L[T++])}break}}break}}while(R<W&&D<X);O&=(1<<(k-=(M=k>>3)<<3))-1,P.next_in=R-=M,P.next_out=D,P.avail_in=R<W?W-R+5:5-(R-W),P.avail_out=D<X?X-D+257:257-(D-X),I.hold=O,I.bits=k,n=e.next_out,F=e.output,s=e.avail_out,i=e.next_in,r=e.input,a=e.avail_in,o=t.hold,l=t.bits,12===t.mode&&(t.back=-1);break}for(t.back=0;d=(y=t.lencode[o&(1<<t.lenbits)-1])>>>16&255,m=65535&y,!((u=y>>>24)<=l);){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(d&&0==(240&d)){for(p=u,V=d,G=m;d=(y=t.lencode[G+((o&(1<<p+V)-1)>>p)])>>>16&255,m=65535&y,!(p+(u=y>>>24)<=l);){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}o>>>=p,l-=p,t.back+=p}if(o>>>=u,l-=u,t.back+=u,t.length=m,0===d){t.mode=26;break}if(32&d){t.back=-1,t.mode=12;break}if(64&d){e.msg="invalid literal/length code",t.mode=30;break}t.extra=15&d,t.mode=22;case 22:if(t.extra){for(_=t.extra;l<_;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.length+=o&(1<<t.extra)-1,o>>>=t.extra,l-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=23;case 23:for(;d=(y=t.distcode[o&(1<<t.distbits)-1])>>>16&255,m=65535&y,!((u=y>>>24)<=l);){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(0==(240&d)){for(p=u,V=d,G=m;d=(y=t.distcode[G+((o&(1<<p+V)-1)>>p)])>>>16&255,m=65535&y,!(p+(u=y>>>24)<=l);){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}o>>>=p,l-=p,t.back+=p}if(o>>>=u,l-=u,t.back+=u,64&d){e.msg="invalid distance code",t.mode=30;break}t.offset=m,t.extra=15&d,t.mode=24;case 24:if(t.extra){for(_=t.extra;l<_;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}t.offset+=o&(1<<t.extra)-1,o>>>=t.extra,l-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=30;break}t.mode=25;case 25:if(0===s)break e;if(t.offset>(c=h-s)){if((c=t.offset-c)>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=30;break}U=c>t.wnext?(c-=t.wnext,t.wsize-c):t.wnext-c,c>t.length&&(c=t.length),z=t.window}else z=F,U=n-t.offset,c=t.length;for(s-=c=s<c?s:c,t.length-=c;F[n++]=z[U++],--c;);0===t.length&&(t.mode=21);break;case 26:if(0===s)break e;F[n++]=t.length,s--,t.mode=21;break;case 27:if(t.wrap){for(;l<32;){if(0===a)break e;a--,o|=r[i++]<<l,l+=8}if(h-=s,e.total_out+=h,t.total+=h,h&&(e.adler=t.check=(t.flags?Dw:Iw)(t.check,F,h,n-h)),h=s,(t.flags?o:Jw(o))!==t.check){e.msg="incorrect data check",t.mode=30;break}l=o=0}t.mode=28;case 28:if(t.wrap&&t.flags){for(;l<32;){if(0===a)break e;a--,o+=r[i++]<<l,l+=8}if(o!==(4294967295&t.total)){e.msg="incorrect length check",t.mode=30;break}l=o=0}t.mode=29;case 29:g=1;break e;case 30:g=-3;break e;case 31:return-4;default:return Yw}return e.next_out=n,e.avail_out=s,e.next_in=i,e.avail_in=a,t.hold=o,t.bits=l,(t.wsize||h!==e.avail_out&&t.mode<30&&(t.mode<27||4!==N))&&sA(e,e.output,e.next_out,h-e.avail_out),h-=e.avail_out,e.total_in+=B-=e.avail_in,e.total_out+=h,t.total+=h,t.wrap&&h&&(e.adler=t.check=(t.flags?Dw:Iw)(t.check,F,h,e.next_out-h)),e.data_type=t.bits+(t.last?64:0)+(12===t.mode?128:0)+(20===t.mode||15===t.mode?256:0),g=(0==B&&0===h||4===N)&&g===Xw?-5:g}var lA=!0,hA=!0;try{String.fromCharCode.apply(null,[0])}catch(e){lA=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){hA=!1}for(var cA=new Uint8Array(256),uA=0;uA<256;uA++)cA[uA]=252<=uA?6:248<=uA?5:240<=uA?4:224<=uA?3:192<=uA?2:1;function dA(e,t){for(var r,i,n=t||e.length,a=new Array(2*n),s=0,o=0;o<n;)if((r=e[o++])<128)a[s++]=r;else if(4<(i=cA[r]))a[s++]=65533,o+=i-1;else{for(r&=2===i?31:3===i?15:7;1<i&&o<n;)r=r<<6|63&e[o++],i--;1<i?a[s++]=65533:r<65536?a[s++]=r:(r-=65536,a[s++]=55296|r>>10&1023,a[s++]=56320|1023&r)}var l=a,h=s;if(h<65537&&(l.subarray&&hA||!l.subarray&&lA))return String.fromCharCode.apply(null,Ew(l,h));for(var c="",u=0;u<h;u++)c+=String.fromCharCode(l[u]);return c}cA[254]=cA[254]=1;var mA=0,pA={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function fA(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function gA(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var vA=Object.prototype.toString;function _A(e){if(!(this instanceof _A))return new _A(e);this.options=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var i in r)r.hasOwnProperty(i)&&(e[i]=r[i])}}return e}({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options,e=(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits)&&(t.windowBits=-15),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new fA,this.strm.avail_out=0,rA(this.strm,t.windowBits));if(e!==mA)throw new Error(pA[e]);this.header=new gA,t=this.strm,e=this.header,t&&t.state&&0!=(2&(t=t.state).wrap)&&((t.head=e).done=!1)}_A.prototype.push=function(e,t){var r,i,n,a,s,o,l=this.strm,h=this.options.chunkSize,c=this.options.dictionary,u=!1;if(this.ended)return!1;i=t===~~t?t:!0===t?4:0,"string"==typeof e?l.input=(e=>{for(var t=new Uint8Array(e.length),r=0,i=t.length;r<i;r++)t[r]=e.charCodeAt(r);return t})(e):"[object ArrayBuffer]"===vA.call(e)?l.input=new Uint8Array(e):l.input=e,l.next_in=0,l.avail_in=l.input.length;do{if(0===l.avail_out&&(l.output=new Uint8Array(h),l.next_out=0,l.avail_out=h),2===(r=oA(l,0))&&c&&(a="string"==typeof c?(e=>{for(var t,r,i,n,a=e.length,s=0,o=0;o<a;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),s+=r<128?1:r<2048?2:r<65536?3:4;for(t=new Uint8Array(s),o=n=0;n<s;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),r<128?t[n++]=r:(r<2048?t[n++]=192|r>>>6:(r<65536?t[n++]=224|r>>>12:(t[n++]=240|r>>>18,t[n++]=128|r>>>12&63),t[n++]=128|r>>>6&63),t[n++]=128|63&r);return t})(c):"[object ArrayBuffer]"===vA.call(c)?new Uint8Array(c):c,n=this.strm,o=s=void 0,o=(a=a).length,r=!n||!n.state||0!==(s=n.state).wrap&&11!==s.mode?Yw:11===s.mode&&Iw(1,a,o,0)!==s.check?-3:sA(n,a,o,o)?(s.mode=31,-4):(s.havedict=1,Xw)),-5===r&&!0===u&&(r=mA,u=!1),1!==r&&r!==mA)return this.onEnd(r),!(this.ended=!0);!l.next_out||0!==l.avail_out&&1!==r&&(0!==l.avail_in||4!==i&&2!==i)||("string"===this.options.to?(n=((e,t)=>{for(var r=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=r&&128==(192&e[r]);)r--;return!(r<0)&&0!==r&&r+cA[e[r]]>t?r:t})(l.output,l.next_out),a=l.next_out-n,o=dA(l.output,n),l.next_out=a,l.avail_out=h-a,a&&Pw(l.output,l.output,n,a,0),this.onData(o)):this.onData(Ew(l.output,l.next_out))),0===l.avail_in&&0===l.avail_out&&(u=!0)}while((0<l.avail_in||0===l.avail_out)&&1!==r);return 4===(i=1===r?4:i)?(r=(t=this.strm)&&t.state?((e=t.state).window&&(e.window=null),t.state=null,Xw):Yw,this.onEnd(r),this.ended=!0,r===mA):2!==i||(this.onEnd(mA),!(l.avail_out=0))},_A.prototype.onData=function(e){this.chunks.push(e)},_A.prototype.onEnd=function(e){e===mA&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=(e=>{for(var t,r,i,n=0,a=0,s=e.length;a<s;a++)n+=e[a].length;for(i=new Uint8Array(n),a=t=0,s=e.length;a<s;a++)r=e[a],i.set(r,t),t+=r.length;return i})(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},pc.add("gz",function(t){let r;t instanceof ArrayBuffer&&(t=new Uint8Array(t));try{r=((e,t)=>{if((t=new _A(t)).push(e,!0),t.err)throw t.msg;return t.result})(t)}catch(e){r=t}return r});class yA{}class bA extends yA{getUrl(e){var e=Mc(e),t=-1<e.name.indexOf("_")?e.name:e.name.substring(0,4);return!["pdb","cif"].includes(e.ext)||!1!==e.compressed&&"gz"!==e.compressed?("mmtf"===e.ext&&(rt.warn("MMTF files distribution has been discontinued by RCSB PDB as of July 2024.\n Defaulting to bcif format instead. See https://www.rcsb.org/news/65a1af31c76ca3abcc925d0c for the deprecation notice"),e.base.endsWith(".bb")&&rt.warn("Backbone only files are not available from RCSB PDB anymore."),e.ext=""),e.ext?rt.warn("unsupported ext",e.ext):rt.warn('mmCif files available from RCSB PDB lack connectivity information.\n Consider using PDBe as the data provider for using "Updated mmCif files" that contain residues connectivity records.'),"https://models.rcsb.org/"+t+".bcif.gz"):"https://files.rcsb.org/download/"+e.path}getExt(e){e=Mc(e).ext;return e||"bcif"}}dc.add("rcsb",new bA);let xA="//www.ebi.ac.uk/pdbe/entry-files/download/";class SA extends yA{getUrl(e){var t=Mc(e);let r=-1<t.name.indexOf("_")?t.name:t.name.substring(0,4),i;switch(t.ext){case"cif":i=xA+r+"_updated.cif";break;case"pdb":case"ent":r.startsWith("pdb")||(r="pdb"+r),i=xA+r+".ent";break;case"bcif":i=xA+t.path;break;case"":i=xA+r+".bcif";break;default:rt.warn("unsupported ext",t.ext),i=xA+r+".bcif"}return"https://"+i}getExt(e){e=Mc(e).ext;return e||"bcif"}}dc.add("pdbe",new SA);let wA="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",AA="/SDF?record_type=3d";class MA extends yA{getUrl(e){var e=Mc(e),t=e.name;let r;return r=(e.ext&&"sdf"!==e.ext&&rt.warn("unsupported ext",e.ext),wA+t+AA),(null===(e=window.location.protocol).match(/http(s)?:/gi)?"http:":e)+r}getExt(e){e=Mc(e).ext;return e||"sdf"}}dc.add("pubchem",new MA);class CA extends yA{getUrl(e){return e}getExt(e){return Mc(e).ext}}dc.add("ftp",new CA),dc.add("http",new CA),dc.add("https",new CA);let TA="//alphafold.ebi.ac.uk/files/AF-",EA="-F1-model_v4.pdb";class PA extends yA{getUrl(e){var e=Mc(e),t=e.name;let r;return"https://"+(r=(e.ext&&"pdb"!==e.ext&&rt.warn("unsupported AF ext",e.ext),TA+t+EA))}getExt(e){e=Mc(e).ext;return e||"pdb"}}dc.add("alphafold",new PA);let IA=/^((http|https|ftp):)*\/\//;class RA extends yA{constructor(e=""){super(),this.baseUrl=e}getUrl(e){var t,r,e=Mc(e);let i=this.baseUrl+e.path;return i=IA.test(this.baseUrl)?i:(e=i,t=window.location,r=(r=t.pathname).substring(0,r.lastIndexOf("/")+1),t.origin+r+e)}getExt(e){return Mc(e).ext}}class DA extends yA{constructor(e=""){super(),this.baseUrl=e}getListing(t=""){let e=this.baseUrl+"dir/"+t;return"/"!==e[e.length-1]&&(e+="/"),Tc(e,{ext:"json"}).then(e=>({path:t,data:e.data}))}getUrl(e){e=Mc(e);return this.baseUrl+"file/"+e.path+e.query}getCountUrl(e){e=Mc(e);return this.baseUrl+"traj/numframes/"+e.path+e.query}getFrameUrl(e,t){e=Mc(e);return this.baseUrl+`traj/frame/${t}/`+e.path+e.query}getFrameParams(e,t){return"atomIndices="+t.join(";")}getPathUrl(e,t){e=Mc(e);return this.baseUrl+`traj/path/${t}/`+e.path+e.query}getExt(e){return Mc(e).ext}}function LA(){return{type:"boolean"}}function OA(){return{type:"color"}}function kA(e,t){return{type:"integer",max:e,min:t}}function NA(e,t,r){return{type:"number",precision:e,max:t,min:r}}function FA(e,t,r){return{type:"range",step:e,max:t,min:r}}function BA(...e){return{type:"select",options:e.reduce((e,t)=>Object.assign(Object.assign({},e),{[t]:t}),{})}}c={backgroundColor:OA(),quality:BA("auto","low","medium","high"),sampleLevel:FA(1,5,-1),impostor:LA(),workerDefault:LA(),rotateSpeed:NA(1,10,0),zoomSpeed:NA(1,10,0),panSpeed:NA(1,10,0),clipNear:FA(1,100,0),clipFar:FA(1,100,0),clipDist:kA(200,0),clipMode:BA("scene","camera"),clipScale:BA("relative","absolute"),fogNear:FA(1,100,0),fogFar:FA(1,100,0),cameraType:BA("perspective","orthographic","stereo"),cameraEyeSep:NA(3,1,.01),cameraFov:FA(1,120,15),lightColor:OA(),lightIntensity:NA(2,10,0),ambientColor:OA(),ambientIntensity:NA(2,10,0),hoverTimeout:kA(1e4,-1),tooltip:LA(),mousePreset:BA(...Object.keys(Mf))};Je.AngleRepresentation=nv,Je.ArrowBuffer=N_,Je.Assembly=dg,Je.AxesRepresentation=yv,Je.BackboneRepresentation=xv,Je.BallAndStickRepresentation=bv,Je.BaseRepresentation=Sv,Je.Box3=ai,Je.BoxBuffer=V_,Je.BufferRepresentation=t1,Je.CartoonRepresentation=Pv,Je.Collection=k1,Je.Color=ze,Je.Colormaker=i,Je.ColormakerRegistry=k,Je.Component=O1,Je.ComponentCollection=a0,Je.ConeBuffer=L_,Je.ContactRepresentation=Iv,Je.Counter=kc,Je.CylinderBuffer=_v,Je.DatasourceRegistry=dc,Je.DecompressorRegistry=pc,Je.DihedralHistogramRepresentation=Ov,Je.DihedralRepresentation=Rv,Je.DistanceRepresentation=kv,Je.EllipsoidBuffer=q_,Je.Euler=Vi,Je.Frames=U1,Je.HelixorientRepresentation=Uv,Je.HyperballRepresentation=Yv,Je.Kdtree=og,Je.KeyActions=Ef,Je.LabelRepresentation=s_,Je.LeftMouseButton=1,Je.LicoriceRepresentation=zv,Je.LineRepresentation=o_,Je.Matrix3=v,Je.Matrix4=tt,Je.MdsrvDatasource=DA,Je.MeasurementDefaultParams=hc,Je.MeshBuffer=_f,Je.MiddleMouseButton=2,Je.MolecularSurface=d_,Je.MolecularSurfaceRepresentation=m_,Je.MouseActions=o,Je.OctahedronBuffer=Q_,Je.ParserRegistry=a,Je.PdbWriter=Ic,Je.PickingProxy=Bu,Je.Plane=va,Je.PointBuffer=v1,Je.PointRepresentation=p_,Je.Quaternion=ri,Je.Queue=ad,Je.RepresentationCollection=N1,Je.RepresentationElement=I1,Je.RepresentationRegistry=mc,Je.RibbonRepresentation=__,Je.RightMouseButton=3,Je.RocketRepresentation=y_,Je.RopeRepresentation=b_,Je.ScriptExtensions=cc,Je.SdfWriter=Rc,Je.Selection=qh,Je.Shape=e1,Je.ShapeComponent=c0,Je.Signal=n.Signal,Je.SpacefillRepresentation=x_,Je.SpatialHash=Wd,Je.SphereBuffer=m1,Je.Stage=h0,Je.StaticDatasource=RA,Je.StlWriter=Oc,Je.Structure=Kg,Je.StructureComponent=r0,Je.StructureComponentDefaultParameters=t0,Je.StructureRepresentation=G0,Je.Superposition=z1,Je.SurfaceComponent=i0,Je.TetrahedronBuffer=iy,Je.TextBuffer=ev,Je.TorusBuffer=hy,Je.TraceRepresentation=A_,Je.TrajectoryPlayer=G1,Je.TubeRepresentation=M_,Je.UIStageParameters=c,Je.UnitcellRepresentation=C_,Je.ValidationRepresentation=T_,Je.Vector2=Ue,Je.Vector3=et,Je.Version="2.4.0",Je.Viewer=Su,Je.Volume=uf,Je.VolumeComponent=n0,Je.WidelineBuffer=iv,Je.autoLoad=Tc,Je.concatStructures=function(e,...t){Je.Debug&&rt.time("concatStructures"),e=new Kg(e,"");let r=new pg(e),i=e.atomStore,n=e.atomMap,a=(i.addField("formalCharge",1,"int8"),i.addField("partialCharge",1,"float32"),{}),s=0,o=0,l=0,h=(t.forEach(e=>{e.eachAtom(e=>{i.growIfFull(),i.atomTypeId[s]=n.add(e.atomname,e.element),i.x[s]=e.x,i.y[s]=e.y,i.z[s]=e.z,i.serial[s]=e.serial,i.formalCharge[s]=e.formalCharge,i.partialCharge[s]=e.partialCharge,i.altloc[s]=e.altloc,i.occupancy[s]=e.occupancy,i.bfactor[s]=e.bfactor,r.addAtom(e.modelIndex+l,e.chainname,e.chainid,e.resname,e.resno,1===e.hetero,e.sstruc,e.inscode),a[e.index+o]=s,s+=1}),o+=e.atomStore.count,l+=e.modelStore.count}),e.bondStore),c=e.getAtomProxy(),u=e.getAtomProxy();return o=0,t.forEach(e=>{e.eachBond(e=>{c.index=a[e.atomIndex1+o],u.index=a[e.atomIndex2+o],h.addBond(c,u,e.bondOrder)}),o+=e.atomStore.count}),r.finalize(),Ag(e,!0),wg(e,!0),e.finalizeAtoms(),e.finalizeBonds(),Pg(e),Je.Debug&&rt.timeEnd("concatStructures"),e},Je.download=jl,Je.flatten=function t(r,i){i=ce(i,[]);for(let e=0;e<r.length;e++)Array.isArray(r[e])?t(r[e],i):i.push(r[e]);return i},Je.getDataInfo=Cc,Je.getFileInfo=Mc,Je.getQuery=zl,Je.guessElement=Eg,Je.setDebug=function(e){Je.Debug=e},Je.setListingDatasource=function(e){Je.ListingDatasource=e},Je.setMeasurementDefaultParams=function(e={}){Object.assign(hc,e)},Je.setTrajectoryDatasource=function(e){Je.TrajectoryDatasource=e},Je.superpose=e0,Je.throttle=function(r,i,n){let a,s,o,l=null,h=0;function c(){h=!1===n.leading?0:Date.now(),l=null,o=r.apply(a,s),l||(a=s=null)}return n=n||{},function(){var e=Date.now(),t=(h||!1!==n.leading||(h=e),i-(e-h));return a=this,s=arguments,t<=0||i<t?(l&&(clearTimeout(l),l=null),h=e,o=r.apply(a,s),l||(a=s=null)):l||!1===n.trailing||(l=setTimeout(c,t)),o}},Je.uniqueArray=Xl,Object.defineProperty(Je,"__esModule",{value:!0})});